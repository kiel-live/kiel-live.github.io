var Gg=Object.defineProperty;var Hg=(g,n,u)=>n in g?Gg(g,n,{enumerable:!0,configurable:!0,writable:!0,value:u}):g[n]=u;var U=(g,n,u)=>Hg(g,typeof n!="symbol"?n+"":n,u);import{d as qs,r as Gi,t as Uo,c as _i,_ as Cd,w as Ef,v as Af,o as Le,a as mt,b as Qe,e as zi,f as lm,n as Ih,g as Zg,m as Ti,h as Wg,i as io,j as Xg,u as Go,k as Vi,l as tr,p as st,q as Jg,s as hi,x as Ft,y as Na,z as cm,A as hm,B as lc,C as Kg,D as Yg,E as Qg,F as Pf,G as Cf,H as um,I as dm,J as $s,K as Vo,L as pm,M as fm,N as Ah,O as ey,P as ty,Q as iy}from"./index-KiWmxDDy.js";import{_ as ry}from"./logo-DBgTG2k7.js";import{u as sy}from"./useTrack-DmYPFwPy.js";import{u as ny}from"./useFeatureFlags-A7w9DXu8.js";const oy=qs({name:"DetailsPopup",props:{isOpen:{type:Boolean,required:!0},size:{type:String,default:"3/4"},disableResize:{type:Boolean}},emits:{close:()=>!0},setup(g,{emit:n}){const u=Gi(!1),_=Gi(),x=Uo(g,"isOpen"),k=Uo(g,"size"),S=Uo(g,"disableResize"),h=_i(()=>{if(S.value&&k.value==="1")return"full";if(!x.value)return"closed";if(u.value){if(_.value===void 0)return"closed";const J=_.value/window.innerHeight;return k.value==="1/2"&&J>.6||k.value==="3/4"&&J>.85?"maximizing":k.value==="1/2"&&J<.4||k.value==="3/4"&&J<.65?"closing":"defaulting"}return _.value===0?"closed":_.value===window.innerHeight?"full":"default"});function N(J){S.value||(u.value=!0,_.value=window.innerHeight-J.touches[0].clientY)}function q(J){u.value&&(_.value=window.innerHeight-J.touches[0].clientY)}function ne(){u.value&&(h.value==="maximizing"?_.value=window.innerHeight:h.value==="closing"?(_.value=void 0,n("close")):h.value==="defaulting"&&(_.value=void 0),u.value=!1)}return{drag:N,move:q,drop:ne,actualSize:h,height:_,dragging:u}}}),ay={class:"flex-shrink-0 bg-gray-500 w-12 h-1.5 rounded-full mx-auto"};function ly(g,n,u,_,x,k){return Ef((Le(),mt("div",{class:Ih(["absolute bottom-0 left-0 right-0 flex flex-col w-full z-10 bg-white shadow-top md:shadow-right md:rounded-none md:w-80 md:top-0 md:h-auto transition dark:bg-dark-400 dark:text-gray-300 dark:border-dark-800",{"overflow-hidden max-h-0":g.actualSize==="closed","h-full md:mx-auto md:w-200 md:shadow-none":g.actualSize==="full","h-1/2":g.size==="1/2"&&g.actualSize==="default","h-3/4":g.size==="3/4"&&g.actualSize==="default","p-4 pb-0 pt-2":g.actualSize!=="closed"&&g.actualSize!=="full","rounded-t-2xl":g.actualSize!=="full","rounded-none p-4 pt-16":g.actualSize==="full","opacity-80":g.actualSize==="closing",fade:!g.dragging}]),style:Zg({height:g.isOpen?g.height===void 0?void 0:`${g.height}px`:0}),onTouchmove:n[1]||(n[1]=(...S)=>g.move&&g.move(...S)),onTouchend:n[2]||(n[2]=(...S)=>g.drop&&g.drop(...S))},[g.disableResize?zi("",!0):(Le(),mt("div",{key:0,class:"w-full -mt-4 pt-4 pb-4 md:hidden",onTouchstart:n[0]||(n[0]=(...S)=>g.drag&&g.drag(...S))},[Ef(Qe("div",ay,null,512),[[Af,g.actualSize!=="full"]])],32)),lm(g.$slots,"default",{},void 0,!0)],38)),[[Af,g.isOpen]])}const id=Cd(oy,[["render",ly],["__scopeId","data-v-7a2783e8"]]),cy={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function hy(g,n){return Le(),mt("svg",cy,n[0]||(n[0]=[Qe("g",{fill:"currentColor"},[Qe("path",{d:"M12.5 6c-2.294 0-3.71 1.655-4.106 2.447A1 1 0 0 1 7.5 9c-.757 0-1.914.235-2.853.912C3.758 10.552 3 11.626 3 13.5c0 1.458.459 2.415 1.05 3.06c.607.663 1.418 1.062 2.204 1.269a1 1 0 0 1-.508 1.934c-1.049-.276-2.238-.833-3.171-1.852C1.624 16.873 1 15.423 1 13.5c0-2.526 1.075-4.201 2.478-5.212c1.124-.809 2.413-1.163 3.435-1.26C7.751 5.773 9.626 4 12.5 4c2.13 0 3.65 1.08 4.607 2.33a7.133 7.133 0 0 1 1.285 2.745c.785.127 1.695.43 2.505 1.014C22.092 10.948 23 12.373 23 14.5c0 1.516-.462 2.697-1.196 3.571c-.72.86-1.65 1.362-2.498 1.634a1 1 0 1 1-.612-1.904c.586-.188 1.157-.513 1.578-1.015c.408-.486.728-1.202.728-2.286c0-1.474-.592-2.299-1.272-2.789c-.73-.526-1.638-.711-2.228-.711a1 1 0 0 1-1-1c0-.502-.284-1.543-.982-2.455C14.85 6.67 13.87 6 12.5 6zm-.5 4a1 1 0 0 1 1 1v5.586l1.293-1.293a1 1 0 0 1 1.414 1.414l-3 3a1 1 0 0 1-1.414 0l-3-3a1 1 0 1 1 1.414-1.414L11 16.586V11a1 1 0 0 1 1-1z"})],-1)]))}const uy=Ti({name:"majesticons-cloud-download-line",render:hy}),dy={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function py(g,n){return Le(),mt("svg",dy,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M19.35 10.04A7.49 7.49 0 0 0 12 4c-1.48 0-2.85.43-4.01 1.17l1.46 1.46a5.497 5.497 0 0 1 8.05 4.87v.5H19c1.66 0 3 1.34 3 3c0 1.13-.64 2.11-1.56 2.62l1.45 1.45C23.16 18.16 24 16.68 24 15c0-2.64-2.05-4.78-4.65-4.96M3 5.27l2.75 2.74C2.56 8.15 0 10.77 0 14c0 3.31 2.69 6 6 6h11.73l2 2L21 20.73L4.27 4zM7.73 10l8 8H6c-2.21 0-4-1.79-4-4s1.79-4 4-4z"},null,-1)]))}const fy=Ti({name:"ic-baseline-cloud-off",render:py});function my(g={}){const{immediate:n=!1,onNeedRefresh:u,onOfflineReady:_,onRegistered:x,onRegisteredSW:k,onRegisterError:S}=g;let h,N,q;const ne=async(G=!0)=>{await N,q==null||q()};async function J(){if("serviceWorker"in navigator){if(h=await Wg(async()=>{const{Workbox:G}=await import("./workbox-window.prod.es5-B9K5rw8f.js");return{Workbox:G}},[]).then(({Workbox:G})=>new G("/sw.js",{scope:"/",type:"classic"})).catch(G=>{S==null||S(G)}),!h)return;q=()=>{h==null||h.messageSkipWaiting()};{let G=!1;const ve=()=>{G=!0,h==null||h.addEventListener("controlling",Ee=>{Ee.isUpdate&&window.location.reload()}),u==null||u()};h.addEventListener("installed",Ee=>{typeof Ee.isUpdate>"u"?typeof Ee.isExternal<"u"&&Ee.isExternal?ve():!G&&(_==null||_()):Ee.isUpdate||_==null||_()}),h.addEventListener("waiting",ve)}h.register({immediate:n}).then(G=>{k?k("/sw.js",G):x==null||x(G)}).catch(G=>{S==null||S(G)})}}return N=J(),ne}function _y(g={}){const{immediate:n=!0,onNeedRefresh:u,onOfflineReady:_,onRegistered:x,onRegisteredSW:k,onRegisterError:S}=g,h=Gi(!1),N=Gi(!1);return{updateServiceWorker:my({immediate:n,onNeedRefresh(){h.value=!0,u==null||u()},onOfflineReady(){N.value=!0,_==null||_()},onRegistered:x,onRegisteredSW:k,onRegisterError:S}),offlineReady:N,needRefresh:h}}const bs=new Uint8Array(0),Ho=new TextEncoder,xs=new TextDecoder;function gy(...g){let n=0;for(let x=0;x<g.length;x++)n+=g[x].length;const u=new Uint8Array(n);let _=0;for(let x=0;x<g.length;x++)u.set(g[x],_),_+=g[x].length;return u}function Ql(...g){const n=[];for(let u=0;u<g.length;u++)n.push(Ho.encode(g[u]));return n.length===0?bs:n.length===1?n[0]:gy(...n)}function Mf(g){return!g||g.length===0?"":xs.decode(g)}const zf="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",Df=36,yy=0xcfd41b9100000,Lf=33,xy=333,Rf=22;function vy(g){for(let n=0;n<g.length;n++)g[n]=Math.floor(Math.random()*255)}function by(g){var n;(n=globalThis==null?void 0:globalThis.crypto)!=null&&n.getRandomValues?globalThis.crypto.getRandomValues(g):vy(g)}class wy{constructor(){U(this,"buf");U(this,"seq");U(this,"inc");U(this,"inited");this.buf=new Uint8Array(Rf),this.inited=!1}init(){this.inited=!0,this.setPre(),this.initSeqAndInc(),this.fillSeq()}initSeqAndInc(){this.seq=Math.floor(Math.random()*yy),this.inc=Math.floor(Math.random()*(xy-Lf)+Lf)}setPre(){const n=new Uint8Array(12);by(n);for(let u=0;u<12;u++){const _=n[u]%36;this.buf[u]=zf.charCodeAt(_)}}fillSeq(){let n=this.seq;for(let u=Rf-1;u>=12;u--)this.buf[u]=zf.charCodeAt(n%Df),n=Math.floor(n/Df)}next(){return this.inited||this.init(),this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),String.fromCharCode.apply(String,this.buf)}reset(){this.init()}}const Zo=new wy;var Ns;(function(g){g.Disconnect="disconnect",g.Reconnect="reconnect",g.Update="update",g.LDM="ldm",g.Error="error"})(Ns||(Ns={}));var $a;(function(g){g.Reconnecting="reconnecting",g.PingTimer="pingTimer",g.StaleConnection="staleConnection",g.ClientInitiatedReconnect="client initiated reconnect"})($a||($a={}));var He;(function(g){g.ApiError="BAD API",g.BadAuthentication="BAD_AUTHENTICATION",g.BadCreds="BAD_CREDS",g.BadHeader="BAD_HEADER",g.BadJson="BAD_JSON",g.BadPayload="BAD_PAYLOAD",g.BadSubject="BAD_SUBJECT",g.Cancelled="CANCELLED",g.ConnectionClosed="CONNECTION_CLOSED",g.ConnectionDraining="CONNECTION_DRAINING",g.ConnectionRefused="CONNECTION_REFUSED",g.ConnectionTimeout="CONNECTION_TIMEOUT",g.Disconnect="DISCONNECT",g.InvalidOption="INVALID_OPTION",g.InvalidPayload="INVALID_PAYLOAD",g.MaxPayloadExceeded="MAX_PAYLOAD_EXCEEDED",g.NoResponders="503",g.NotFunction="NOT_FUNC",g.RequestError="REQUEST_ERROR",g.ServerOptionNotAvailable="SERVER_OPT_NA",g.SubClosed="SUB_CLOSED",g.SubDraining="SUB_DRAINING",g.Timeout="TIMEOUT",g.Tls="TLS",g.Unknown="UNKNOWN_ERROR",g.WssRequired="WSS_REQUIRED",g.JetStreamInvalidAck="JESTREAM_INVALID_ACK",g.JetStream404NoMessages="404",g.JetStream408RequestTimeout="408",g.JetStream409MaxAckPendingExceeded="409",g.JetStream409="409",g.JetStreamNotEnabled="503",g.JetStreamIdleHeartBeat="IDLE_HEARTBEAT",g.AuthorizationViolation="AUTHORIZATION_VIOLATION",g.AuthenticationExpired="AUTHENTICATION_EXPIRED",g.ProtocolError="NATS_PROTOCOL_ERR",g.PermissionsViolation="PERMISSIONS_VIOLATION",g.AuthenticationTimeout="AUTHENTICATION_TIMEOUT",g.AccountExpired="ACCOUNT_EXPIRED"})(He||(He={}));function Sy(g){return typeof g.code=="string"}class mm{constructor(){U(this,"messages");this.messages=new Map,this.messages.set(He.InvalidPayload,"Invalid payload type - payloads can be 'binary', 'string', or 'json'"),this.messages.set(He.BadJson,"Bad JSON"),this.messages.set(He.WssRequired,"TLS is required, therefore a secure websocket connection is also required")}static getMessage(n){return Iy.getMessage(n)}getMessage(n){return this.messages.get(n)||n}}const Iy=new mm;class ht extends Error{constructor(u,_,x){super(u);U(this,"name");U(this,"message");U(this,"code");U(this,"permissionContext");U(this,"chainedError");U(this,"api_error");this.name="NatsError",this.message=u,this.code=_,this.chainedError=x}static errorForCode(u,_){const x=mm.getMessage(u);return new ht(x,u,_)}isAuthError(){return this.code===He.AuthenticationExpired||this.code===He.AuthorizationViolation||this.code===He.AccountExpired}isAuthTimeout(){return this.code===He.AuthenticationTimeout}isPermissionError(){return this.code===He.PermissionsViolation}isProtocolError(){return this.code===He.ProtocolError}isJetStreamError(){return this.api_error!==void 0}jsError(){return this.api_error?this.api_error:null}}var _s;(function(g){g[g.Exact=0]="Exact",g[g.CanonicalMIME=1]="CanonicalMIME",g[g.IgnoreCase=2]="IgnoreCase"})(_s||(_s={}));var Us;(function(g){g.Timer="timer",g.Count="count",g.JitterTimer="jitterTimer",g.SentinelMsg="sentinelMsg"})(Us||(Us={}));var ec;(function(g){g.STATS="io.nats.micro.v1.stats_response",g.INFO="io.nats.micro.v1.info_response",g.PING="io.nats.micro.v1.ping_response"})(ec||(ec={}));const Ph="Nats-Service-Error",Ch="Nats-Service-Error-Code";class Mh extends Error{constructor(u,_){super(_);U(this,"code");this.code=u}static isServiceError(u){return Mh.toServiceError(u)!==null}static toServiceError(u){var x,k;const _=((x=u==null?void 0:u.headers)==null?void 0:x.get(Ch))||"";if(_!==""){const S=parseInt(_)||400,h=((k=u==null?void 0:u.headers)==null?void 0:k.get(Ph))||"";return new Mh(S,h.length?h:_)}return null}}function nn(g=""){if(g=g||"_INBOX",typeof g!="string")throw new Error("prefix must be a string");return g.split(".").forEach(n=>{if(n==="*"||n===">")throw new Error(`inbox prefixes cannot have wildcards '${g}'`)}),`${g}.${Zo.next()}`}const dd="127.0.0.1";var ro;(function(g){g.PING="PING",g.STATS="STATS",g.INFO="INFO"})(ro||(ro={}));function Bh(g,...n){for(let u=0;u<n.length;u++){const _=n[u];Object.keys(_).forEach(function(x){g[x]=_[x]})}return g}function yh(g){return xs.decode(g).replace(/\n/g,"␊").replace(/\r/g,"␍")}function Ga(g,n=!0){const u=n?ht.errorForCode(He.Timeout):null;let _,x;const k=new Promise((S,h)=>{_={cancel:()=>{x&&clearTimeout(x)}},x=setTimeout(()=>{h(u===null?ht.errorForCode(He.Timeout):u)},g)});return Object.assign(k,_)}function Wa(g=0){let n;const u=new Promise(_=>{const x=setTimeout(()=>{_()},g);n={cancel:()=>{x&&clearTimeout(x)}}});return Object.assign(u,n)}function Di(){let g={};const n=new Promise((u,_)=>{g={resolve:u,reject:_}});return Object.assign(n,g)}function _m(g){for(let n=g.length-1;n>0;n--){const u=Math.floor(Math.random()*(n+1));[g[n],g[u]]=[g[u],g[n]]}return g}function Ty(g){return g===0?0:Math.floor(g/2+Math.random()*g)}function Md(g=[0,250,250,500,500,3e3,5e3]){Array.isArray(g)||(g=[0,250,250,500,500,3e3,5e3]);const n=g.length-1;return{backoff(u){return Ty(u>n?g[n]:g[u])}}}function Bi(g){return g*1e6}function zd(g){return Math.floor(g/1e6)}function Of(g){let _=!0;const x=new Array(g.length);for(let k=0;k<g.length;k++){let S=g.charCodeAt(k);if(S===58||S<33||S>126)throw new ht(`'${g[k]}' is not a valid character for a header key`,He.BadHeader);_&&97<=S&&S<=122?S-=32:!_&&65<=S&&S<=90&&(S+=32),x[k]=S,_=S==45}return String.fromCharCode(...x)}function Dn(g=0,n=""){if(g===0&&n!==""||g>0&&n==="")throw new Error("setting status requires both code and description");return new so(g,n)}const rd="NATS/1.0";class so{constructor(n=0,u=""){U(this,"_code");U(this,"headers");U(this,"_description");this._code=n,this._description=u,this.headers=new Map}[Symbol.iterator](){return this.headers.entries()}size(){return this.headers.size}equals(n){if(n&&this.headers.size===n.headers.size&&this._code===n._code){for(const[u,_]of this.headers){const x=n.values(u);if(_.length!==x.length)return!1;const k=[..._].sort(),S=[...x].sort();for(let h=0;h<k.length;h++)if(k[h]!==S[h])return!1}return!0}return!1}static decode(n){const u=new so,x=xs.decode(n).split(`\r
`),k=x[0];if(k!==rd){let S=k.replace(rd,"").trim();if(S.length>0){u._code=parseInt(S,10),isNaN(u._code)&&(u._code=0);const h=u._code.toString();S=S.replace(h,""),u._description=S.trim()}}return x.length>=1&&x.slice(1).map(S=>{if(S){const h=S.indexOf(":");if(h>-1){const N=S.slice(0,h),q=S.slice(h+1).trim();u.append(N,q)}}}),u}toString(){if(this.headers.size===0&&this._code===0)return"";let n=rd;this._code>0&&this._description!==""&&(n+=` ${this._code} ${this._description}`);for(const[u,_]of this.headers)for(let x=0;x<_.length;x++)n=`${n}\r
${u}: ${_[x]}`;return`${n}\r
\r
`}encode(){return Ho.encode(this.toString())}static validHeaderValue(n){if(/[\r\n]/.test(n))throw new ht("invalid header value - \\r and \\n are not allowed.",He.BadHeader);return n.trim()}keys(){const n=[];for(const u of this.headers.keys())n.push(u);return n}findKeys(n,u=_s.Exact){const _=this.keys();switch(u){case _s.Exact:return _.filter(x=>x===n);case _s.CanonicalMIME:return n=Of(n),_.filter(x=>x===n);default:{const x=n.toLowerCase();return _.filter(k=>x===k.toLowerCase())}}}get(n,u=_s.Exact){const _=this.findKeys(n,u);if(_.length){const x=this.headers.get(_[0]);if(x)return Array.isArray(x)?x[0]:x}return""}last(n,u=_s.Exact){const _=this.findKeys(n,u);if(_.length){const x=this.headers.get(_[0]);if(x)return Array.isArray(x)?x[x.length-1]:x}return""}has(n,u=_s.Exact){return this.findKeys(n,u).length>0}set(n,u,_=_s.Exact){this.delete(n,_),this.append(n,u,_)}append(n,u,_=_s.Exact){const x=Of(n);_===_s.CanonicalMIME&&(n=x);const k=this.findKeys(n,_);n=k.length>0?k[0]:n;const S=so.validHeaderValue(u);let h=this.headers.get(n);h||(h=[],this.headers.set(n,h)),h.push(S)}values(n,u=_s.Exact){const _=[];return this.findKeys(n,u).forEach(k=>{const S=this.headers.get(k);S&&_.push(...S)}),_}delete(n,u=_s.Exact){this.findKeys(n,u).forEach(x=>{this.headers.delete(x)})}get hasError(){return this._code>=300}get status(){return`${this._code} ${this._description}`.trim()}toRecord(){const n={};return this.keys().forEach(u=>{n[u]=this.values(u)}),n}get code(){return this._code}get description(){return this._description}static fromRecord(n){const u=new so;for(const _ in n)u.headers.set(_,n[_]);return u}}function pd(){return{encode(g){return Ho.encode(g)},decode(g){return xs.decode(g)}}}function Vs(g){return{encode(n){try{return n===void 0&&(n=null),Ho.encode(JSON.stringify(n))}catch(u){throw ht.errorForCode(He.BadJson,u)}},decode(n){try{return JSON.parse(xs.decode(n),g)}catch(u){throw ht.errorForCode(He.BadJson,u)}}}}function gm(g){var n;return g&&g.data.length===0&&((n=g.headers)==null?void 0:n.code)===503?ht.errorForCode(He.NoResponders):null}class Dd{constructor(n,u,_){U(this,"_headers");U(this,"_msg");U(this,"_rdata");U(this,"_reply");U(this,"_subject");U(this,"publisher");this._msg=n,this._rdata=u,this.publisher=_}get subject(){return this._subject?this._subject:(this._subject=xs.decode(this._msg.subject),this._subject)}get reply(){return this._reply?this._reply:(this._reply=xs.decode(this._msg.reply),this._reply)}get sid(){return this._msg.sid}get headers(){if(this._msg.hdr>-1&&!this._headers){const n=this._rdata.subarray(0,this._msg.hdr);this._headers=so.decode(n)}return this._headers}get data(){return this._rdata?this._msg.hdr>-1?this._rdata.subarray(this._msg.hdr):this._rdata:new Uint8Array(0)}respond(n=bs,u){return this.reply?(this.publisher.publish(this.reply,n,u),!0):!1}size(){var x;const n=this._msg.subject.length,u=((x=this._msg.reply)==null?void 0:x.length)||0,_=this._msg.size===-1?0:this._msg.size;return n+u+_}json(n){return Vs(n).decode(this.data)}string(){return xs.decode(this.data)}requestInfo(){var u;const n=(u=this.headers)==null?void 0:u.get("Nats-Request-Info");return n?JSON.parse(n,function(_,x){return(_==="start"||_==="stop")&&x!==""?new Date(Date.parse(x)):x}):null}}U(Dd,"jc");function Ua(g){return jh("durable",g)}function Vr(g){return jh("stream",g)}function jh(g,n=""){if(n==="")throw Error(`${g} name required`);return[".","*",">","/","\\"," ","	",`
`,"\r"].forEach(_=>{if(n.indexOf(_)!==-1){switch(_){case`
`:_="\\n";break;case"\r":_="\\r";break;case"	":_="\\t";break}throw Error(`invalid ${g} name - ${g} name cannot contain '${_}'`)}}),""}function Kl(g,n=""){if(n==="")throw Error(`${g} name required`);const u=ky(n);if(u.length)throw new Error(`invalid ${g} name - ${g} name ${u}`)}function ky(g=""){if(g==="")throw Error("name required");const n=/^[-\w]+$/g;if(g.match(n)===null){for(const _ of g.split(""))if(_.match(n)===null)return`cannot contain '${_}'`}return""}function fd(g){if(g.data.length>0)return!1;const n=g.headers;return n?n.code>=100&&n.code<200:!1}function md(g){var n;return fd(g)&&((n=g.headers)==null?void 0:n.description)==="Idle Heartbeat"}function Ey(g,n,u){const _=Dn(g,n),x={hdr:1,sid:0,size:0},k=new Dd(x,bs,{});return k._headers=_,k._subject=u,k}function Va(g){if(g.data.length!==0)return null;const n=g.headers;return n?ym(n.code,n.description):null}var Ms;(function(g){g.MaxBatchExceeded="exceeded maxrequestbatch of",g.MaxExpiresExceeded="exceeded maxrequestexpires of",g.MaxBytesExceeded="exceeded maxrequestmaxbytes of",g.MaxMessageSizeExceeded="message size exceeds maxbytes",g.PushConsumer="consumer is push based",g.MaxWaitingExceeded="exceeded maxwaiting",g.IdleHeartbeatMissed="idle heartbeats missed",g.ConsumerDeleted="consumer deleted"})(Ms||(Ms={}));function Ay(g){return g.code!==He.JetStream409?!1:[Ms.MaxBatchExceeded,Ms.MaxExpiresExceeded,Ms.MaxBytesExceeded,Ms.MaxMessageSizeExceeded,Ms.PushConsumer,Ms.IdleHeartbeatMissed,Ms.ConsumerDeleted].find(u=>g.message.indexOf(u)!==-1)!==void 0}function ym(g,n=""){if(g<300)return null;switch(n=n.toLowerCase(),g){case 404:return new ht(n,He.JetStream404NoMessages);case 408:return new ht(n,He.JetStream408RequestTimeout);case 409:{const u=n.startsWith(Ms.IdleHeartbeatMissed)?He.JetStreamIdleHeartBeat:He.JetStream409;return new ht(n,u)}case 503:return ht.errorForCode(He.JetStreamNotEnabled,new Error(n));default:return n===""&&(n=He.Unknown),new ht(n,`${g}`)}}class hr{constructor(){U(this,"inflight");U(this,"processed");U(this,"received");U(this,"noIterator");U(this,"iterClosed");U(this,"done");U(this,"signal");U(this,"yields");U(this,"filtered");U(this,"pendingFiltered");U(this,"ingestionFilterFn");U(this,"protocolFilterFn");U(this,"dispatchedFn");U(this,"ctx");U(this,"_data");U(this,"err");U(this,"time");U(this,"yielding");this.inflight=0,this.filtered=0,this.pendingFiltered=0,this.processed=0,this.received=0,this.noIterator=!1,this.done=!1,this.signal=Di(),this.yields=[],this.iterClosed=Di(),this.time=0,this.yielding=!1}[Symbol.asyncIterator](){return this.iterate()}push(n){if(this.done)return;if(typeof n=="function"){this.yields.push(n),this.signal.resolve();return}const{ingest:u,protocol:_}=this.ingestionFilterFn?this.ingestionFilterFn(n,this.ctx||this):{ingest:!0,protocol:!1};u&&(_&&(this.filtered++,this.pendingFiltered++),this.yields.push(n),this.signal.resolve())}async*iterate(){if(this.noIterator)throw new ht("unsupported iterator",He.ApiError);if(this.yielding)throw new ht("already yielding",He.ApiError);this.yielding=!0;try{for(;;){if(this.yields.length===0&&await this.signal,this.err)throw this.err;const n=this.yields;this.inflight=n.length,this.yields=[];for(let u=0;u<n.length;u++){if(typeof n[u]=="function"){const x=n[u];try{x()}catch(k){throw k}if(this.err)throw this.err;continue}if(this.protocolFilterFn?this.protocolFilterFn(n[u]):!0){this.processed++;const x=Date.now();yield n[u],this.time=Date.now()-x,this.dispatchedFn&&n[u]&&this.dispatchedFn(n[u])}else this.pendingFiltered--;this.inflight--}if(this.done)break;this.yields.length===0&&(n.length=0,this.yields=n,this.signal=Di())}}finally{this.stop()}}stop(n){this.done||(this.err=n,this.done=!0,this.signal.resolve(),this.iterClosed.resolve(n))}getProcessed(){return this.noIterator?this.received:this.processed}getPending(){return this.yields.length+this.inflight-this.pendingFiltered}getReceived(){return this.received-this.filtered}}class Ld{constructor(n,u,_={maxOut:2}){U(this,"interval");U(this,"maxOut");U(this,"cancelAfter");U(this,"timer");U(this,"autoCancelTimer");U(this,"last");U(this,"missed");U(this,"count");U(this,"callback");this.interval=n,this.maxOut=(_==null?void 0:_.maxOut)||2,this.cancelAfter=(_==null?void 0:_.cancelAfter)||0,this.last=Date.now(),this.missed=0,this.count=0,this.callback=u,this._schedule()}cancel(){this.autoCancelTimer&&clearTimeout(this.autoCancelTimer),this.timer&&clearInterval(this.timer),this.timer=0,this.autoCancelTimer=0,this.missed=0}work(){this.last=Date.now(),this.missed=0}_change(n,u=0,_=2){this.interval=n,this.maxOut=_,this.cancelAfter=u,this.restart()}restart(){this.cancel(),this._schedule()}_schedule(){this.cancelAfter>0&&(this.autoCancelTimer=setTimeout(()=>{this.cancel()},this.cancelAfter)),this.timer=setInterval(()=>{if(this.count++,Date.now()-this.last>this.interval&&this.missed++,this.missed>=this.maxOut)try{this.callback(this.missed)===!0&&this.cancel()}catch(n){console.log(n)}},this.interval)}}var _d;(function(g){g.Limits="limits",g.Interest="interest",g.Workqueue="workqueue"})(_d||(_d={}));var sc;(function(g){g.Old="old",g.New="new"})(sc||(sc={}));var gd;(function(g){g.File="file",g.Memory="memory"})(gd||(gd={}));var Hi;(function(g){g.All="all",g.Last="last",g.New="new",g.StartSequence="by_start_sequence",g.StartTime="by_start_time",g.LastPerSubject="last_per_subject"})(Hi||(Hi={}));var cr;(function(g){g.None="none",g.All="all",g.Explicit="explicit",g.NotSet=""})(cr||(cr={}));var Ha;(function(g){g.Instant="instant",g.Original="original"})(Ha||(Ha={}));var oo;(function(g){g.None="none",g.S2="s2"})(oo||(oo={}));var zh;(function(g){g.CreateOrUpdate="",g.Update="update",g.Create="create"})(zh||(zh={}));function Py(g,n={}){return Object.assign({name:g,deliver_policy:Hi.All,ack_policy:cr.Explicit,ack_wait:Bi(30*1e3),replay_policy:Ha.Instant},n)}var Ff;(function(g){g.API="api_audit",g.StreamAction="stream_action",g.ConsumerAction="consumer_action",g.SnapshotCreate="snapshot_create",g.SnapshotComplete="snapshot_complete",g.RestoreCreate="restore_create",g.RestoreComplete="restore_complete",g.MaxDeliver="max_deliver",g.Terminated="terminated",g.Ack="consumer_ack",g.StreamLeaderElected="stream_leader_elected",g.StreamQuorumLost="stream_quorum_lost",g.ConsumerLeaderElected="consumer_leader_elected",g.ConsumerQuorumLost="consumer_quorum_lost"})(Ff||(Ff={}));var Gr;(function(g){g.StreamSourceHdr="Nats-Stream-Source",g.LastConsumerSeqHdr="Nats-Last-Consumer",g.LastStreamSeqHdr="Nats-Last-Stream",g.ConsumerStalledHdr="Nats-Consumer-Stalled",g.MessageSizeHdr="Nats-Msg-Size",g.RollupHdr="Nats-Rollup",g.RollupValueSubject="sub",g.RollupValueAll="all",g.PendingMessagesHdr="Nats-Pending-Messages",g.PendingBytesHdr="Nats-Pending-Bytes"})(Gr||(Gr={}));var js;(function(g){g.LastValue="",g.AllHistory="history",g.UpdatesOnly="updates"})(js||(js={}));var ja;(function(g){g.Stream="Nats-Stream",g.Sequence="Nats-Sequence",g.TimeStamp="Nats-Time-Stamp",g.Subject="Nats-Subject"})(ja||(ja={}));var Bf;(function(g){g.Stream="Nats-Stream",g.Subject="Nats-Subject",g.Sequence="Nats-Sequence",g.LastSequence="Nats-Last-Sequence",g.Size="Nats-Msg-Size"})(Bf||(Bf={}));const gs="KV_";class Cy{constructor(n){U(this,"config");U(this,"ordered");U(this,"mack");U(this,"stream");U(this,"callbackFn");U(this,"max");U(this,"qname");U(this,"isBind");U(this,"filters");this.stream="",this.mack=!1,this.ordered=!1,this.config=Py("",n||{})}getOpts(){var u;const n={};if(n.config=Object.assign({},this.config),n.config.filter_subject&&(this.filterSubject(n.config.filter_subject),n.config.filter_subject=void 0),n.config.filter_subjects&&((u=n.config.filter_subjects)==null||u.forEach(_=>{this.filterSubject(_)}),n.config.filter_subjects=void 0),n.mack=this.mack,n.stream=this.stream,n.callbackFn=this.callbackFn,n.max=this.max,n.queue=this.qname,n.ordered=this.ordered,n.config.ack_policy=n.ordered?cr.None:n.config.ack_policy,n.isBind=n.isBind||!1,this.filters)switch(this.filters.length){case 0:break;case 1:n.config.filter_subject=this.filters[0];break;default:n.config.filter_subjects=this.filters}return n}description(n){return this.config.description=n,this}deliverTo(n){return this.config.deliver_subject=n,this}durable(n){return Ua(n),this.config.durable_name=n,this}startSequence(n){if(n<=0)throw new Error("sequence must be greater than 0");return this.config.deliver_policy=Hi.StartSequence,this.config.opt_start_seq=n,this}startTime(n){return this.config.deliver_policy=Hi.StartTime,this.config.opt_start_time=n.toISOString(),this}deliverAll(){return this.config.deliver_policy=Hi.All,this}deliverLastPerSubject(){return this.config.deliver_policy=Hi.LastPerSubject,this}deliverLast(){return this.config.deliver_policy=Hi.Last,this}deliverNew(){return this.config.deliver_policy=Hi.New,this}startAtTimeDelta(n){return this.startTime(new Date(Date.now()-n)),this}headersOnly(){return this.config.headers_only=!0,this}ackNone(){return this.config.ack_policy=cr.None,this}ackAll(){return this.config.ack_policy=cr.All,this}ackExplicit(){return this.config.ack_policy=cr.Explicit,this}ackWait(n){return this.config.ack_wait=Bi(n),this}maxDeliver(n){return this.config.max_deliver=n,this}filterSubject(n){return this.filters=this.filters||[],this.filters.push(n),this}replayInstantly(){return this.config.replay_policy=Ha.Instant,this}replayOriginal(){return this.config.replay_policy=Ha.Original,this}sample(n){if(n=Math.trunc(n),n<0||n>100)throw new Error("value must be between 0-100");return this.config.sample_freq=`${n}%`,this}limit(n){return this.config.rate_limit_bps=n,this}maxWaiting(n){return this.config.max_waiting=n,this}maxAckPending(n){return this.config.max_ack_pending=n,this}idleHeartbeat(n){return this.config.idle_heartbeat=Bi(n),this}flowControl(){return this.config.flow_control=!0,this}deliverGroup(n){return this.queue(n),this}manualAck(){return this.mack=!0,this}maxMessages(n){return this.max=n,this}callback(n){return this.callbackFn=n,this}queue(n){return this.qname=n,this.config.deliver_group=n,this}orderedConsumer(){return this.ordered=!0,this}bind(n,u){return this.stream=n,this.config.durable_name=u,this.isBind=!0,this}bindStream(n){return this.stream=n,this}inactiveEphemeralThreshold(n){return this.config.inactive_threshold=Bi(n),this}maxPullBatch(n){return this.config.max_batch=n,this}maxPullRequestExpires(n){return this.config.max_expires=Bi(n),this}memory(){return this.config.mem_storage=!0,this}numReplicas(n){return this.config.num_replicas=n,this}consumerName(n){return this.config.name=n,this}}function zn(g){return new Cy(g)}function jf(g){return typeof g.getOpts=="function"}class My{static encode(n){if(typeof n=="string")return btoa(n);const u=Array.from(n);return btoa(String.fromCharCode(...u))}static decode(n,u=!1){const _=atob(n);return u?Uint8Array.from(_,x=>x.charCodeAt(0)):_}}class tc{static encode(n){return tc.toB64URLEncoding(My.encode(n))}static decode(n,u=!1){return tc.decode(tc.fromB64URLEncoding(n),u)}static toB64URLEncoding(n){return n.replace(/\+/g,"-").replace(/\//g,"_")}static fromB64URLEncoding(n){return n.replace(/_/g,"/").replace(/-/g,"+")}}class Za{constructor(){U(this,"buffers");U(this,"byteLength");this.buffers=[],this.byteLength=0}static concat(...n){let u=0;for(let k=0;k<n.length;k++)u+=n[k].length;const _=new Uint8Array(u);let x=0;for(let k=0;k<n.length;k++)_.set(n[k],x),x+=n[k].length;return _}static fromAscii(n){return n||(n=""),Ho.encode(n)}static toAscii(n){return xs.decode(n)}reset(){this.buffers.length=0,this.byteLength=0}pack(){if(this.buffers.length>1){const n=new Uint8Array(this.byteLength);let u=0;for(let _=0;_<this.buffers.length;_++)n.set(this.buffers[_],u),u+=this.buffers[_].length;this.buffers.length=0,this.buffers.push(n)}}shift(){if(this.buffers.length){const n=this.buffers.shift();if(n)return this.byteLength-=n.length,n}return new Uint8Array(0)}drain(n){if(this.buffers.length){this.pack();const u=this.buffers.pop();if(u){const _=this.byteLength;(n===void 0||n>_)&&(n=_);const x=u.subarray(0,n);return _>n&&this.buffers.push(u.subarray(n)),this.byteLength=_-n,x}}return new Uint8Array(0)}fill(n,...u){n&&(this.buffers.push(n),this.byteLength+=n.length);for(let _=0;_<u.length;_++)u[_]&&u[_].length&&(this.buffers.push(u[_]),this.byteLength+=u[_].length)}peek(){return this.buffers.length?(this.pack(),this.buffers[0]):new Uint8Array(0)}size(){return this.byteLength}length(){return this.buffers.length}}function Nf(g){const n=g.length;let u=g.indexOf("=");u===-1&&(u=n);const _=u===n?0:4-u%4;return[u,_]}function zy(g,n,u=!1){function _(S,h){return Math.floor((S+h)*3/4-h)}function x(S){return g[S>>18&63]+g[S>>12&63]+g[S>>6&63]+g[S&63]}function k(S,h,N){const q=new Array((N-h)/3);for(let ne=h,J=0;ne<N;ne+=3)q[J++]=x((S[ne]<<16)+(S[ne+1]<<8)+S[ne+2]);return q.join("")}return{byteLength(S){return _.apply(null,Nf(S))},toUint8Array(S){const[h,N]=Nf(S),q=new Uint8Array(_(h,N)),ne=N?h-4:h;let J,G=0,ve;for(ve=0;ve<ne;ve+=4)J=n[S.charCodeAt(ve)]<<18|n[S.charCodeAt(ve+1)]<<12|n[S.charCodeAt(ve+2)]<<6|n[S.charCodeAt(ve+3)],q[G++]=J>>16&255,q[G++]=J>>8&255,q[G++]=J&255;return N===2?(J=n[S.charCodeAt(ve)]<<2|n[S.charCodeAt(ve+1)]>>4,q[G++]=J&255):N===1&&(J=n[S.charCodeAt(ve)]<<10|n[S.charCodeAt(ve+1)]<<4|n[S.charCodeAt(ve+2)]>>2,q[G++]=J>>8&255,q[G++]=J&255),q},fromUint8Array(S){const N=S.length,q=N%3,ne=N-q,J=new Array(Math.ceil(ne/16383)+(q?1:0));let G=0,ve;for(let $e=0;$e<ne;$e+=16383)ve=$e+16383,J[G++]=k(S,$e,ve>ne?ne:ve);let Ee;return q===1?(Ee=S[ne],J[G]=g[Ee>>2]+g[Ee<<4&63],u||(J[G]+="==")):q===2&&(Ee=S[ne]<<8|S[ne+1]&255,J[G]=g[Ee>>10]+g[Ee>>4&63]+g[Ee<<2&63],u||(J[G]+="=")),J.join("")}}}const xm=[],vm=[],sd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";for(let g=0,n=sd.length;g<n;++g)xm[g]=sd[g],vm[sd.charCodeAt(g)]=g;const{byteLength:zb,toUint8Array:Dy,fromUint8Array:Ly}=zy(xm,vm,!0),Ry=new TextDecoder,Oy=new TextEncoder;function Fy(g){return g.reduce((n,u)=>`${n}${u<16?"0":""}${u.toString(16)}`,"")}function By(g){const n=g.length;if(n%2||!/^[0-9a-fA-F]+$/.test(g))throw new TypeError("Invalid hex string.");g=g.toLowerCase();const u=new Uint8Array(Math.floor(n/2)),_=n/2;for(let x=0;x<_;++x)u[x]=parseInt(g.substr(x*2,2),16);return u}function jy(g,n="utf8"){if(/^utf-?8$/i.test(n))return Ry.decode(g);if(/^base64$/i.test(n))return Ly(g);if(/^hex(?:adecimal)?$/i.test(n))return Fy(g);throw new TypeError("Unsupported string encoding.")}function Ny(g,n="utf8"){if(/^utf-?8$/i.test(n))return Oy.encode(g);if(/^base64$/i.test(n))return Dy(g);if(/^hex(?:adecimal)?$/i.test(n))return By(g);throw new TypeError("Unsupported string encoding.")}class $f{constructor(){U(this,"hashSize",32);U(this,"_buf");U(this,"_bufIdx");U(this,"_count");U(this,"_K");U(this,"_H");U(this,"_finalized");this._buf=new Uint8Array(64),this._K=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),this.init()}init(){return this._H=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),this._bufIdx=0,this._count=new Uint32Array(2),this._buf.fill(0),this._finalized=!1,this}update(n,u){if(n===null)throw new TypeError("msg must be a string or Uint8Array.");typeof n=="string"&&(n=Ny(n,u));for(let x=0,k=n.length;x<k;x++)this._buf[this._bufIdx++]=n[x],this._bufIdx===64&&(this._transform(),this._bufIdx=0);const _=this._count;return(_[0]+=n.length<<3)<n.length<<3&&_[1]++,_[1]+=n.length>>>29,this}digest(n){if(this._finalized)throw new Error("digest has already been called.");this._finalized=!0;const u=this._buf;let _=this._bufIdx;for(u[_++]=128;_!==56;)_===64&&(this._transform(),_=0),u[_++]=0;const x=this._count;u[56]=x[1]>>>24&255,u[57]=x[1]>>>16&255,u[58]=x[1]>>>8&255,u[59]=x[1]>>>0&255,u[60]=x[0]>>>24&255,u[61]=x[0]>>>16&255,u[62]=x[0]>>>8&255,u[63]=x[0]>>>0&255,this._transform();const k=new Uint8Array(32);for(let S=0;S<8;S++)k[(S<<2)+0]=this._H[S]>>>24&255,k[(S<<2)+1]=this._H[S]>>>16&255,k[(S<<2)+2]=this._H[S]>>>8&255,k[(S<<2)+3]=this._H[S]>>>0&255;return this.init(),n?jy(k,n):k}_transform(){const n=this._H;let u=n[0],_=n[1],x=n[2],k=n[3],S=n[4],h=n[5],N=n[6],q=n[7];const ne=new Uint32Array(16);let J;for(J=0;J<16;J++)ne[J]=this._buf[(J<<2)+3]|this._buf[(J<<2)+2]<<8|this._buf[(J<<2)+1]<<16|this._buf[J<<2]<<24;for(J=0;J<64;J++){let G;if(J<16)G=ne[J];else{let ve=ne[J+1&15],Ee=ne[J+14&15];G=ne[J&15]=(ve>>>7^ve>>>18^ve>>>3^ve<<25^ve<<14)+(Ee>>>17^Ee>>>19^Ee>>>10^Ee<<15^Ee<<13)+ne[J&15]+ne[J+9&15]|0}G=G+q+(S>>>6^S>>>11^S>>>25^S<<26^S<<21^S<<7)+(N^S&(h^N))+this._K[J]|0,q=N,N=h,h=S,S=k+G,k=x,x=_,_=u,u=G+(_&x^k&(_^x))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0}n[0]=n[0]+u|0,n[1]=n[1]+_|0,n[2]=n[2]+x|0,n[3]=n[3]+k|0,n[4]=n[4]+S|0,n[5]=n[5]+h|0,n[6]=n[6]+N|0,n[7]=n[7]+q|0}}class bm{constructor(n,u,_=!0){U(this,"token");U(this,"received");U(this,"ctx");U(this,"requestSubject");U(this,"mux");this.mux=n,this.requestSubject=u,this.received=0,this.token=Zo.next(),_&&(this.ctx=new Error)}}class $y extends bm{constructor(u,_,x={maxWait:1e3}){super(u,_);U(this,"callback");U(this,"done");U(this,"timer");U(this,"max");U(this,"opts");if(this.opts=x,typeof this.opts.callback!="function")throw new Error("callback is required");this.callback=this.opts.callback,this.max=typeof x.maxMessages=="number"&&x.maxMessages>0?x.maxMessages:-1,this.done=Di(),this.done.then(()=>{this.callback(null,null)}),this.timer=setTimeout(()=>{this.cancel()},x.maxWait)}cancel(u){u&&this.callback(u,null),clearTimeout(this.timer),this.mux.cancel(this),this.done.resolve()}resolver(u,_){u?(this.ctx&&(u.stack+=`

${this.ctx.stack}`),this.cancel(u)):(this.callback(null,_),this.opts.strategy===Us.Count&&(this.max--,this.max===0&&this.cancel()),this.opts.strategy===Us.JitterTimer&&(clearTimeout(this.timer),this.timer=setTimeout(()=>{this.cancel()},this.opts.jitter||300)),this.opts.strategy===Us.SentinelMsg&&_&&_.data.length===0&&this.cancel())}}class wm extends bm{constructor(u,_,x={timeout:1e3},k=!0){super(u,_,k);U(this,"deferred");U(this,"timer");this.deferred=Di(),this.timer=Ga(x.timeout,k)}resolver(u,_){this.timer&&this.timer.cancel(),u?(this.ctx&&(u.stack+=`

${this.ctx.stack}`),this.deferred.reject(u)):this.deferred.resolve(_),this.cancel()}cancel(u){this.timer&&this.timer.cancel(),this.mux.cancel(this),this.deferred.reject(u||ht.errorForCode(He.Cancelled))}}const Uy="$JS.API";function Vy(g){return g=g||{},g.domain&&(g.apiPrefix=`$JS.${g.domain}.API`,delete g.domain),Bh({apiPrefix:Uy,timeout:5e3},g)}class cc{constructor(n,u){U(this,"nc");U(this,"opts");U(this,"prefix");U(this,"timeout");U(this,"jc");this.nc=n,this.opts=Vy(u),this._parseOpts(),this.prefix=this.opts.apiPrefix,this.timeout=this.opts.timeout,this.jc=Vs()}getOptions(){return Object.assign({},this.opts)}_parseOpts(){let n=this.opts.apiPrefix;if(!n||n.length===0)throw new Error("invalid empty prefix");n[n.length-1]==="."&&(n=n.substr(0,n.length-1)),this.opts.apiPrefix=n}async _request(n,u=null,_){_=_||{},_.timeout=this.timeout;let x=bs;u&&(x=this.jc.encode(u));let{retries:k}=_;k=k||1,k=k===-1?Number.MAX_SAFE_INTEGER:k;const S=Md();for(let h=0;h<k;h++)try{const N=await this.nc.request(n,x,_);return this.parseJsResponse(N)}catch(N){const q=N;if((q.code==="503"||q.code===He.Timeout)&&h+1<k)await Wa(S.backoff(h));else throw N}}async findStream(n){const u={subject:n},x=await this._request(`${this.prefix}.STREAM.NAMES`,u);if(!x.streams||x.streams.length!==1)throw new Error("no stream matches subject");return x.streams[0]}getConnection(){return this.nc}parseJsResponse(n){const u=this.jc.decode(n.data),_=u;if(_.error){const x=ym(_.error.code,_.error.description);if(x!==null)throw x.api_error=_.error,x}return u}}class Yl{constructor(n,u,_,x){U(this,"err");U(this,"offset");U(this,"pageInfo");U(this,"subject");U(this,"jsm");U(this,"filter");U(this,"payload");if(!n)throw new Error("subject is required");this.subject=n,this.jsm=_,this.offset=0,this.pageInfo={},this.filter=u,this.payload=x||{}}async next(){if(this.err)return[];if(this.pageInfo&&this.offset>=this.pageInfo.total)return[];const n={offset:this.offset};this.payload&&Object.assign(n,this.payload);try{const u=await this.jsm._request(this.subject,n,{timeout:this.jsm.timeout});this.pageInfo=u;const _=this.countResponse(u);return _===0?[]:(this.offset+=_,this.filter(u))}catch(u){throw this.err=u,u}}countResponse(n){var u,_,x;switch(n==null?void 0:n.type){case"io.nats.jetstream.api.v1.stream_names_response":case"io.nats.jetstream.api.v1.stream_list_response":return((u=n.streams)==null?void 0:u.length)||0;case"io.nats.jetstream.api.v1.consumer_list_response":return((_=n.consumers)==null?void 0:_.length)||0;default:return console.error(`jslister.ts: unknown API response for paged output: ${n==null?void 0:n.type}`),((x=n.streams)==null?void 0:x.length)||0}return 0}async*[Symbol.asyncIterator](){let n=await this.next();for(;n.length>0;){for(const u of n)yield u;n=await this.next()}}}function qo(g=""){const n=g.match(/(\d+).(\d+).(\d+)/);if(n)return{major:parseInt(n[1]),minor:parseInt(n[2]),micro:parseInt(n[3])};throw new Error(`'${g}' is not a semver value`)}function yd(g,n){return g.major<n.major?-1:g.major>n.major?1:g.minor<n.minor?-1:g.minor>n.minor?1:g.micro<n.micro?-1:g.micro>n.micro?1:0}var ii;(function(g){g.JS_KV="js_kv",g.JS_OBJECTSTORE="js_objectstore",g.JS_PULL_MAX_BYTES="js_pull_max_bytes",g.JS_NEW_CONSUMER_CREATE_API="js_new_consumer_create",g.JS_ALLOW_DIRECT="js_allow_direct",g.JS_MULTIPLE_CONSUMER_FILTER="js_multiple_consumer_filter",g.JS_SIMPLIFICATION="js_simplification",g.JS_STREAM_CONSUMER_METADATA="js_stream_consumer_metadata",g.JS_CONSUMER_FILTER_SUBJECTS="js_consumer_filter_subjects",g.JS_STREAM_FIRST_SEQ="js_stream_first_seq",g.JS_STREAM_SUBJECT_TRANSFORM="js_stream_subject_transform",g.JS_STREAM_SOURCE_SUBJECT_TRANSFORM="js_stream_source_subject_transform",g.JS_STREAM_COMPRESSION="js_stream_compression",g.JS_DEFAULT_CONSUMER_LIMITS="js_default_consumer_limits",g.JS_BATCH_DIRECT_GET="js_batch_direct_get"})(ii||(ii={}));class qy{constructor(n){U(this,"server");U(this,"features");U(this,"disabled");this.features=new Map,this.disabled=[],this.update(n)}resetDisabled(){this.disabled.length=0,this.update(this.server)}disable(n){this.disabled.push(n),this.update(this.server)}isDisabled(n){return this.disabled.indexOf(n)!==-1}update(n){typeof n=="string"&&(n=qo(n)),this.server=n,this.set(ii.JS_KV,"2.6.2"),this.set(ii.JS_OBJECTSTORE,"2.6.3"),this.set(ii.JS_PULL_MAX_BYTES,"2.8.3"),this.set(ii.JS_NEW_CONSUMER_CREATE_API,"2.9.0"),this.set(ii.JS_ALLOW_DIRECT,"2.9.0"),this.set(ii.JS_MULTIPLE_CONSUMER_FILTER,"2.10.0"),this.set(ii.JS_SIMPLIFICATION,"2.9.4"),this.set(ii.JS_STREAM_CONSUMER_METADATA,"2.10.0"),this.set(ii.JS_CONSUMER_FILTER_SUBJECTS,"2.10.0"),this.set(ii.JS_STREAM_FIRST_SEQ,"2.10.0"),this.set(ii.JS_STREAM_SUBJECT_TRANSFORM,"2.10.0"),this.set(ii.JS_STREAM_SOURCE_SUBJECT_TRANSFORM,"2.10.0"),this.set(ii.JS_STREAM_COMPRESSION,"2.10.0"),this.set(ii.JS_DEFAULT_CONSUMER_LIMITS,"2.10.0"),this.set(ii.JS_BATCH_DIRECT_GET,"2.11.0"),this.disabled.forEach(u=>{this.features.delete(u)})}set(n,u){this.features.set(n,{min:u,ok:yd(this.server,qo(u))>=0})}get(n){return this.features.get(n)||{min:"unknown",ok:!1}}supports(n){var u;return((u=this.get(n))==null?void 0:u.ok)||!1}require(n){return typeof n=="string"&&(n=qo(n)),yd(this.server,n)>=0}}class Rd extends cc{constructor(n,u){super(n,u)}async add(n,u,_=zh.Create){if(Vr(n),u.deliver_group&&u.flow_control)throw new Error("jetstream flow control is not supported with queue groups");if(u.deliver_group&&u.idle_heartbeat)throw new Error("jetstream idle heartbeat is not supported with queue groups");const x={};x.config=u,x.stream_name=n,x.action=_,x.config.durable_name&&Ua(x.config.durable_name);const k=this.nc;let{min:S,ok:h}=k.features.get(ii.JS_NEW_CONSUMER_CREATE_API);const N=u.name===""?void 0:u.name;if(N&&!h)throw new Error(`consumer 'name' requires server ${S}`);if(N)try{jh("name",N)}catch(G){const ve=G.message,Ee=ve.indexOf("cannot contain");throw Ee!==-1?new Error(`consumer 'name' ${ve.substring(Ee)}`):G}let q,ne="";if(Array.isArray(u.filter_subjects)){const{min:G,ok:ve}=k.features.get(ii.JS_MULTIPLE_CONSUMER_FILTER);if(!ve)throw new Error(`consumer 'filter_subjects' requires server ${G}`);h=!1}if(u.metadata){const{min:G,ok:ve}=k.features.get(ii.JS_STREAM_CONSUMER_METADATA);if(!ve)throw new Error(`consumer 'metadata' requires server ${G}`)}if(h&&(ne=u.name??u.durable_name??""),ne!==""){let G=u.filter_subject??void 0;G===">"&&(G=void 0),q=G!==void 0?`${this.prefix}.CONSUMER.CREATE.${n}.${ne}.${G}`:`${this.prefix}.CONSUMER.CREATE.${n}.${ne}`}else q=u.durable_name?`${this.prefix}.CONSUMER.DURABLE.CREATE.${n}.${u.durable_name}`:`${this.prefix}.CONSUMER.CREATE.${n}`;return await this._request(q,x)}async update(n,u,_){const x=await this.info(n,u),k=_;return this.add(n,Object.assign(x.config,k),zh.Update)}async info(n,u){return Vr(n),Ua(u),await this._request(`${this.prefix}.CONSUMER.INFO.${n}.${u}`)}async delete(n,u){return Vr(n),Ua(u),(await this._request(`${this.prefix}.CONSUMER.DELETE.${n}.${u}`)).success}list(n){Vr(n);const u=x=>x.consumers,_=`${this.prefix}.CONSUMER.LIST.${n}`;return new Yl(_,u,this)}pause(n,u,_){const x=`${this.prefix}.CONSUMER.PAUSE.${n}.${u}`,k={pause_until:_.toISOString()};return this._request(x,k)}resume(n,u){return this.pause(n,u,new Date(0))}}function Ba(g,n,u=!1){if(u===!0&&!g)throw ht.errorForCode(He.ApiError,new Error(`${n} is not a function`));if(g&&typeof g!="function")throw ht.errorForCode(He.ApiError,new Error(`${n} is not a function`))}class Gy extends hr{constructor(u,_,x){super();U(this,"sub");U(this,"adapter");U(this,"subIterDone");Ba(x.adapter,"adapter",!0),this.adapter=x.adapter,x.callback&&Ba(x.callback,"callback"),this.noIterator=typeof x.callback=="function",x.ingestionFilterFn&&(Ba(x.ingestionFilterFn,"ingestionFilterFn"),this.ingestionFilterFn=x.ingestionFilterFn),x.protocolFilterFn&&(Ba(x.protocolFilterFn,"protocolFilterFn"),this.protocolFilterFn=x.protocolFilterFn),x.dispatchedFn&&(Ba(x.dispatchedFn,"dispatchedFn"),this.dispatchedFn=x.dispatchedFn),x.cleanupFn&&Ba(x.cleanupFn,"cleanupFn");let k=(ne,J)=>{this.callback(ne,J)};if(x.callback){const ne=x.callback;k=(J,G)=>{const[ve,Ee]=this.adapter(J,G);if(ve){ne(ve,null);return}const{ingest:$e}=this.ingestionFilterFn?this.ingestionFilterFn(Ee,this):{ingest:!0};$e&&(!this.protocolFilterFn||this.protocolFilterFn(Ee))&&(ne(ve,Ee),this.dispatchedFn&&Ee&&this.dispatchedFn(Ee))}}const{max:S,queue:h,timeout:N}=x,q={queue:h,timeout:N,callback:k};S&&S>0&&(q.max=S),this.sub=u.subscribe(_,q),x.cleanupFn&&(this.sub.cleanupFn=x.cleanupFn),this.noIterator||this.iterClosed.then(()=>{this.unsubscribe()}),this.subIterDone=Di(),Promise.all([this.sub.closed,this.iterClosed]).then(()=>{this.subIterDone.resolve()}).catch(()=>{this.subIterDone.resolve()}),(async ne=>{await ne.closed,this.stop()})(this.sub).then().catch()}unsubscribe(u){this.sub.unsubscribe(u)}drain(){return this.sub.drain()}isDraining(){return this.sub.isDraining()}isClosed(){return this.sub.isClosed()}callback(u,_){this.sub.cancelTimeout();const[x,k]=this.adapter(u,_);x&&this.stop(x),k&&this.push(k)}getSubject(){return this.sub.getSubject()}getReceived(){return this.sub.getReceived()}getProcessed(){return this.sub.getProcessed()}getPending(){return this.sub.getPending()}getID(){return this.sub.getID()}getMax(){return this.sub.getMax()}get closed(){return this.sub.closed}}let vs;function Hy(g){vs=g}function Sm(){return vs!==void 0&&vs.defaultPort!==void 0?vs.defaultPort:4222}function nd(){return vs!==void 0&&vs.urlParseFn?vs.urlParseFn:void 0}function Zy(){if(!vs||typeof vs.factory!="function")throw new Error("transport fn is not set");return vs.factory()}function xd(){return vs!==void 0&&vs.dnsResolveFn?vs.dnsResolveFn:void 0}const Th=`\r
`,Dh=Za.fromAscii(Th),Wy=new Uint8Array(Dh)[0],Xy=new Uint8Array(Dh)[1];function Jy(g){for(let n=0;n<g.length;n++){const u=n+1;if(g.byteLength>u&&g[n]===Wy&&g[u]===Xy)return u+1}return 0}function Ky(g){const n=Jy(g);if(n>0){const _=new Uint8Array(g).slice(0,n);return xs.decode(_)}return""}const Yy=4,Im=48,Qy=65,e0=97;function t0(g,n,u,_){const x=new Uint8Array(16);return[0,0,0,0,0,0,0,0,0,0,255,255].forEach((S,h)=>{x[h]=S}),x[12]=g,x[13]=n,x[14]=u,x[15]=_,x}function vd(g){return i0(g)!==void 0}function i0(g){for(let n=0;n<g.length;n++)switch(g[n]){case".":return Tm(g);case":":return r0(g)}}function Tm(g){const n=new Uint8Array(4);for(let u=0;u<4;u++){if(g.length===0)return;if(u>0){if(g[0]!==".")return;g=g.substring(1)}const{n:_,c:x,ok:k}=s0(g);if(!k||_>255)return;g=g.substring(x),n[u]=_}return t0(n[0],n[1],n[2],n[3])}function r0(g){const n=new Uint8Array(16);let u=-1;if(g.length>=2&&g[0]===":"&&g[1]===":"&&(u=0,g=g.substring(2),g.length===0))return n;let _=0;for(;_<16;){const{n:x,c:k,ok:S}=n0(g);if(!S||x>65535)return;if(k<g.length&&g[k]==="."){if(u<0&&_!=12||_+4>16)return;const h=Tm(g);if(h===void 0)return;n[_]=h[12],n[_+1]=h[13],n[_+2]=h[14],n[_+3]=h[15],g="",_+=Yy;break}if(n[_]=x>>8,n[_+1]=x,_+=2,g=g.substring(k),g.length===0)break;if(g[0]!==":"||g.length==1)return;if(g=g.substring(1),g[0]===":"){if(u>=0)return;if(u=_,g=g.substring(1),g.length===0)break}}if(g.length===0){if(_<16){if(u<0)return;const x=16-_;for(let k=_-1;k>=u;k--)n[k+x]=n[k];for(let k=u+x-1;k>=u;k--)n[k]=0}else if(u>=0)return;return n}}function s0(g){let n=0,u=0;for(n=0;n<g.length&&48<=g.charCodeAt(n)&&g.charCodeAt(n)<=57;n++)if(u=u*10+(g.charCodeAt(n)-Im),u>=16777215)return{n:16777215,c:n,ok:!1};return n===0?{n:0,c:0,ok:!1}:{n:u,c:n,ok:!0}}function n0(g){let n=0,u=0;for(u=0;u<g.length;u++){if(48<=g.charCodeAt(u)&&g.charCodeAt(u)<=57)n*=16,n+=g.charCodeAt(u)-Im;else if(97<=g.charCodeAt(u)&&g.charCodeAt(u)<=102)n*=16,n+=g.charCodeAt(u)-e0+10;else if(65<=g.charCodeAt(u)&&g.charCodeAt(u)<=70)n*=16,n+=g.charCodeAt(u)-Qy+10;else break;if(n>=16777215)return{n:0,c:u,ok:!1}}return u===0?{n:0,c:u,ok:!1}:{n,c:u,ok:!0}}function o0(g){return g.indexOf("[")!==-1||g.indexOf("::")!==-1?!1:g.indexOf(".")!==-1||g.split(":").length<=2}function bd(g){return!o0(g)}function a0(g){const n="::FFFF:",u=g.toUpperCase().indexOf(n);if(u!==-1&&g.indexOf(".")!==-1){let _=g.substring(u+n.length);return _=_.replace("[",""),_.replace("]","")}return g}function l0(g){g=g.trim(),g.match(/^(.*:\/\/)(.*)/m)&&(g=g.replace(/^(.*:\/\/)(.*)/gm,"$2")),g=a0(g),bd(g)&&g.indexOf("[")===-1&&(g=`[${g}]`);const n=bd(g)?g.match(/(]:)(\d+)/):g.match(/(:)(\d+)/),u=n&&n.length===3&&n[1]&&n[2]?parseInt(n[2]):4222,_=u===80?"https":"http",x=new URL(`${_}://${g}`);x.port=`${u}`;let k=x.hostname;return k.charAt(0)==="["&&(k=k.substring(1,k.length-1)),{listen:x.host,hostname:k,port:u}}class ic{constructor(n,u=!1){U(this,"src");U(this,"listen");U(this,"hostname");U(this,"port");U(this,"didConnect");U(this,"reconnects");U(this,"lastConnect");U(this,"gossiped");U(this,"tlsName");U(this,"resolves");this.src=n,this.tlsName="";const _=l0(n);this.listen=_.listen,this.hostname=_.hostname,this.port=_.port,this.didConnect=!1,this.reconnects=0,this.lastConnect=0,this.gossiped=u}toString(){return this.listen}async resolve(n){if(!n.fn||n.resolve===!1)return[this];const u=[];if(vd(this.hostname))return[this];{const _=await n.fn(this.hostname);n.debug&&console.log(`resolve ${this.hostname} = ${_.join(",")}`);for(const x of _){const k=this.port===80?"https":"http",S=new URL(`${k}://${bd(x)?"["+x+"]":x}`);S.port=`${this.port}`;const h=new ic(S.host,!1);h.tlsName=this.hostname,u.push(h)}}return n.randomize&&_m(u),this.resolves=u,u}}class c0{constructor(n=[],u={}){U(this,"firstSelect");U(this,"servers");U(this,"currentServer");U(this,"tlsName");U(this,"randomize");this.firstSelect=!0,this.servers=[],this.tlsName="",this.randomize=u.randomize||!1;const _=nd();n&&(n.forEach(x=>{x=_?_(x):x,this.servers.push(new ic(x))}),this.randomize&&(this.servers=_m(this.servers))),this.servers.length===0&&this.addServer(`${dd}:${Sm()}`,!1),this.currentServer=this.servers[0]}clear(){this.servers.length=0}updateTLSName(){const n=this.getCurrentServer();vd(n.hostname)||(this.tlsName=n.hostname,this.servers.forEach(u=>{u.gossiped&&(u.tlsName=this.tlsName)}))}getCurrentServer(){return this.currentServer}addServer(n,u=!1){const _=nd();n=_?_(n):n;const x=new ic(n,u);vd(x.hostname)&&(x.tlsName=this.tlsName),this.servers.push(x)}selectServer(){if(this.firstSelect)return this.firstSelect=!1,this.currentServer;const n=this.servers.shift();return n&&(this.servers.push(n),this.currentServer=n),n}removeCurrentServer(){this.removeServer(this.currentServer)}removeServer(n){if(n){const u=this.servers.indexOf(n);this.servers.splice(u,1)}}length(){return this.servers.length}next(){return this.servers.length?this.servers[0]:void 0}getServers(){return this.servers}update(n,u){const _=[];let x=[];const k=nd(),S=new Map;n.connect_urls&&n.connect_urls.length>0&&n.connect_urls.forEach(N=>{N=k?k(N,u):N;const q=new ic(N,!0);S.set(N,q)});const h=[];return this.servers.forEach((N,q)=>{const ne=N.listen;N.gossiped&&this.currentServer.listen!==ne&&S.get(ne)===void 0&&h.push(q),S.delete(ne)}),h.reverse(),h.forEach(N=>{const q=this.servers.splice(N,1);x=x.concat(q[0].listen)}),S.forEach((N,q)=>{this.servers.push(N),_.push(q)}),{added:_,deleted:x}}}class h0{constructor(){U(this,"baseInbox");U(this,"reqs");this.reqs=new Map}size(){return this.reqs.size}init(n){return this.baseInbox=`${nn(n)}.`,this.baseInbox}add(n){isNaN(n.received)||(n.received=0),this.reqs.set(n.token,n)}get(n){return this.reqs.get(n)}cancel(n){this.reqs.delete(n.token)}getToken(n){const u=n.subject||"";return u.indexOf(this.baseInbox)===0?u.substring(this.baseInbox.length):null}all(){return Array.from(this.reqs.values())}handleError(n,u){if(u&&u.permissionContext){if(n)return this.all().forEach(x=>{x.resolver(u,{})}),!0;const _=u.permissionContext;if(_.operation==="publish"){const x=this.all().find(k=>k.requestSubject===_.subject);if(x)return x.resolver(u,{}),!0}}return!1}dispatcher(){return(n,u)=>{const _=this.getToken(u);if(_){const x=this.get(_);x&&(n===null&&u.headers&&(n=gm(u)),x.resolver(n,u))}}}close(){const n=ht.errorForCode(He.Timeout);this.reqs.forEach(u=>{u.resolver(n,{})})}}class u0{constructor(n,u,_){U(this,"ph");U(this,"interval");U(this,"maxOut");U(this,"timer");U(this,"pendings");this.ph=n,this.interval=u,this.maxOut=_,this.pendings=[]}start(){this.cancel(),this._schedule()}cancel(n){this.timer&&(clearTimeout(this.timer),this.timer=void 0),this._reset(),n&&this.ph.disconnect()}_schedule(){this.timer=setTimeout(()=>{if(this.ph.dispatchStatus({type:$a.PingTimer,data:`${this.pendings.length+1}`}),this.pendings.length===this.maxOut){this.cancel(!0);return}const n=Di();this.ph.flush(n).then(()=>{this._reset()}).catch(()=>{this.cancel()}),this.pendings.push(n),this._schedule()},this.interval)}_reset(){this.pendings=this.pendings.filter(n=>(n.resolve(),!1))}}class d0 extends Error{constructor(n){super(n),this.name="AssertionError"}}function p0(g,n="Assertion failed."){if(!g)throw new d0(n)}const Uf=32*1024,od=2**32-2;function xh(g,n,u=0){const _=n.byteLength-u;return g.byteLength>_&&(g=g.subarray(0,_)),n.set(g,u),g.byteLength}class ad{constructor(n){U(this,"_buf");U(this,"_off");if(this._off=0,n==null){this._buf=new Uint8Array(0);return}this._buf=new Uint8Array(n)}bytes(n={copy:!0}){return n.copy===!1?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(n){if(n===0){this.reset();return}if(n<0||n>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+n)}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(n){const u=this._buf.byteLength;return n<=this.capacity-u?(this._reslice(u+n),u):-1}_reslice(n){p0(n<=this._buf.buffer.byteLength),this._buf=new Uint8Array(this._buf.buffer,0,n)}readByte(){const n=new Uint8Array(1);return this.read(n)?n[0]:null}read(n){if(this.empty())return this.reset(),n.byteLength===0?0:null;const u=xh(this._buf.subarray(this._off),n);return this._off+=u,u}writeByte(n){return this.write(Uint8Array.of(n))}writeString(n){return this.write(Ho.encode(n))}write(n){const u=this._grow(n.byteLength);return xh(n,this._buf,u)}_grow(n){const u=this.length;u===0&&this._off!==0&&this.reset();const _=this._tryGrowByReslice(n);if(_>=0)return _;const x=this.capacity;if(n<=Math.floor(x/2)-u)xh(this._buf.subarray(this._off),this._buf);else{if(x+n>od)throw new Error("The buffer cannot be grown beyond the maximum size.");{const k=new Uint8Array(Math.min(2*x+n,od));xh(this._buf.subarray(this._off),k),this._buf=k}}return this._off=0,this._reslice(Math.min(u+n,od)),u}grow(n){if(n<0)throw Error("Buffer._grow: negative count");const u=this._grow(n);this._reslice(u)}readFrom(n){let u=0;const _=new Uint8Array(Uf);for(;;){const x=this.capacity-this.length<Uf,k=x?_:new Uint8Array(this._buf.buffer,this.length),S=n.read(k);if(S===null)return u;x?this.write(k.subarray(0,S)):this._reslice(this.length+S),u+=S}}}var qr;(function(g){g[g.OK=0]="OK",g[g.ERR=1]="ERR",g[g.MSG=2]="MSG",g[g.INFO=3]="INFO",g[g.PING=4]="PING",g[g.PONG=5]="PONG"})(qr||(qr={}));function Vf(){const g={};return g.sid=-1,g.hdr=-1,g.size=-1,g}const f0=48;class qf{constructor(n){U(this,"dispatcher");U(this,"state");U(this,"as");U(this,"drop");U(this,"hdr");U(this,"ma");U(this,"argBuf");U(this,"msgBuf");this.dispatcher=n,this.state=et.OP_START,this.as=0,this.drop=0,this.hdr=0}parse(n){let u;for(u=0;u<n.length;u++){const _=n[u];switch(this.state){case et.OP_START:switch(_){case tt.M:case tt.m:this.state=et.OP_M,this.hdr=-1,this.ma=Vf();break;case tt.H:case tt.h:this.state=et.OP_H,this.hdr=0,this.ma=Vf();break;case tt.P:case tt.p:this.state=et.OP_P;break;case tt.PLUS:this.state=et.OP_PLUS;break;case tt.MINUS:this.state=et.OP_MINUS;break;case tt.I:case tt.i:this.state=et.OP_I;break;default:throw this.fail(n.subarray(u))}break;case et.OP_H:switch(_){case tt.M:case tt.m:this.state=et.OP_M;break;default:throw this.fail(n.subarray(u))}break;case et.OP_M:switch(_){case tt.S:case tt.s:this.state=et.OP_MS;break;default:throw this.fail(n.subarray(u))}break;case et.OP_MS:switch(_){case tt.G:case tt.g:this.state=et.OP_MSG;break;default:throw this.fail(n.subarray(u))}break;case et.OP_MSG:switch(_){case tt.SPACE:case tt.TAB:this.state=et.OP_MSG_SPC;break;default:throw this.fail(n.subarray(u))}break;case et.OP_MSG_SPC:switch(_){case tt.SPACE:case tt.TAB:continue;default:this.state=et.MSG_ARG,this.as=u}break;case et.MSG_ARG:switch(_){case tt.CR:this.drop=1;break;case tt.NL:{const x=this.argBuf?this.argBuf.bytes():n.subarray(this.as,u-this.drop);this.processMsgArgs(x),this.drop=0,this.as=u+1,this.state=et.MSG_PAYLOAD,u=this.as+this.ma.size-1;break}default:this.argBuf&&this.argBuf.writeByte(_)}break;case et.MSG_PAYLOAD:if(this.msgBuf)if(this.msgBuf.length>=this.ma.size){const x=this.msgBuf.bytes({copy:!1});this.dispatcher.push({kind:qr.MSG,msg:this.ma,data:x}),this.argBuf=void 0,this.msgBuf=void 0,this.state=et.MSG_END}else{let x=this.ma.size-this.msgBuf.length;const k=n.length-u;k<x&&(x=k),x>0?(this.msgBuf.write(n.subarray(u,u+x)),u=u+x-1):this.msgBuf.writeByte(_)}else u-this.as>=this.ma.size&&(this.dispatcher.push({kind:qr.MSG,msg:this.ma,data:n.subarray(this.as,u)}),this.argBuf=void 0,this.msgBuf=void 0,this.state=et.MSG_END);break;case et.MSG_END:switch(_){case tt.NL:this.drop=0,this.as=u+1,this.state=et.OP_START;break;default:continue}break;case et.OP_PLUS:switch(_){case tt.O:case tt.o:this.state=et.OP_PLUS_O;break;default:throw this.fail(n.subarray(u))}break;case et.OP_PLUS_O:switch(_){case tt.K:case tt.k:this.state=et.OP_PLUS_OK;break;default:throw this.fail(n.subarray(u))}break;case et.OP_PLUS_OK:switch(_){case tt.NL:this.dispatcher.push({kind:qr.OK}),this.drop=0,this.state=et.OP_START;break}break;case et.OP_MINUS:switch(_){case tt.E:case tt.e:this.state=et.OP_MINUS_E;break;default:throw this.fail(n.subarray(u))}break;case et.OP_MINUS_E:switch(_){case tt.R:case tt.r:this.state=et.OP_MINUS_ER;break;default:throw this.fail(n.subarray(u))}break;case et.OP_MINUS_ER:switch(_){case tt.R:case tt.r:this.state=et.OP_MINUS_ERR;break;default:throw this.fail(n.subarray(u))}break;case et.OP_MINUS_ERR:switch(_){case tt.SPACE:case tt.TAB:this.state=et.OP_MINUS_ERR_SPC;break;default:throw this.fail(n.subarray(u))}break;case et.OP_MINUS_ERR_SPC:switch(_){case tt.SPACE:case tt.TAB:continue;default:this.state=et.MINUS_ERR_ARG,this.as=u}break;case et.MINUS_ERR_ARG:switch(_){case tt.CR:this.drop=1;break;case tt.NL:{let x;this.argBuf?(x=this.argBuf.bytes(),this.argBuf=void 0):x=n.subarray(this.as,u-this.drop),this.dispatcher.push({kind:qr.ERR,data:x}),this.drop=0,this.as=u+1,this.state=et.OP_START;break}default:this.argBuf&&this.argBuf.write(Uint8Array.of(_))}break;case et.OP_P:switch(_){case tt.I:case tt.i:this.state=et.OP_PI;break;case tt.O:case tt.o:this.state=et.OP_PO;break;default:throw this.fail(n.subarray(u))}break;case et.OP_PO:switch(_){case tt.N:case tt.n:this.state=et.OP_PON;break;default:throw this.fail(n.subarray(u))}break;case et.OP_PON:switch(_){case tt.G:case tt.g:this.state=et.OP_PONG;break;default:throw this.fail(n.subarray(u))}break;case et.OP_PONG:switch(_){case tt.NL:this.dispatcher.push({kind:qr.PONG}),this.drop=0,this.state=et.OP_START;break}break;case et.OP_PI:switch(_){case tt.N:case tt.n:this.state=et.OP_PIN;break;default:throw this.fail(n.subarray(u))}break;case et.OP_PIN:switch(_){case tt.G:case tt.g:this.state=et.OP_PING;break;default:throw this.fail(n.subarray(u))}break;case et.OP_PING:switch(_){case tt.NL:this.dispatcher.push({kind:qr.PING}),this.drop=0,this.state=et.OP_START;break}break;case et.OP_I:switch(_){case tt.N:case tt.n:this.state=et.OP_IN;break;default:throw this.fail(n.subarray(u))}break;case et.OP_IN:switch(_){case tt.F:case tt.f:this.state=et.OP_INF;break;default:throw this.fail(n.subarray(u))}break;case et.OP_INF:switch(_){case tt.O:case tt.o:this.state=et.OP_INFO;break;default:throw this.fail(n.subarray(u))}break;case et.OP_INFO:switch(_){case tt.SPACE:case tt.TAB:this.state=et.OP_INFO_SPC;break;default:throw this.fail(n.subarray(u))}break;case et.OP_INFO_SPC:switch(_){case tt.SPACE:case tt.TAB:continue;default:this.state=et.INFO_ARG,this.as=u}break;case et.INFO_ARG:switch(_){case tt.CR:this.drop=1;break;case tt.NL:{let x;this.argBuf?(x=this.argBuf.bytes(),this.argBuf=void 0):x=n.subarray(this.as,u-this.drop),this.dispatcher.push({kind:qr.INFO,data:x}),this.drop=0,this.as=u+1,this.state=et.OP_START;break}default:this.argBuf&&this.argBuf.writeByte(_)}break;default:throw this.fail(n.subarray(u))}}(this.state===et.MSG_ARG||this.state===et.MINUS_ERR_ARG||this.state===et.INFO_ARG)&&!this.argBuf&&(this.argBuf=new ad(n.subarray(this.as,u-this.drop))),this.state===et.MSG_PAYLOAD&&!this.msgBuf&&(this.argBuf||this.cloneMsgArg(),this.msgBuf=new ad(n.subarray(this.as)))}cloneMsgArg(){const n=this.ma.subject.length,u=this.ma.reply?this.ma.reply.length:0,_=new Uint8Array(n+u);_.set(this.ma.subject),this.ma.reply&&_.set(this.ma.reply,n),this.argBuf=new ad(_),this.ma.subject=_.subarray(0,n),this.ma.reply&&(this.ma.reply=_.subarray(n))}processMsgArgs(n){if(this.hdr>=0)return this.processHeaderMsgArgs(n);const u=[];let _=-1;for(let x=0;x<n.length;x++)switch(n[x]){case tt.SPACE:case tt.TAB:case tt.CR:case tt.NL:_>=0&&(u.push(n.subarray(_,x)),_=-1);break;default:_<0&&(_=x)}switch(_>=0&&u.push(n.subarray(_)),u.length){case 3:this.ma.subject=u[0],this.ma.sid=this.protoParseInt(u[1]),this.ma.reply=void 0,this.ma.size=this.protoParseInt(u[2]);break;case 4:this.ma.subject=u[0],this.ma.sid=this.protoParseInt(u[1]),this.ma.reply=u[2],this.ma.size=this.protoParseInt(u[3]);break;default:throw this.fail(n,"processMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(n,"processMsgArgs Bad or Missing Sid Error");if(this.ma.size<0)throw this.fail(n,"processMsgArgs Bad or Missing Size Error")}fail(n,u=""){return u?u=`${u} [${this.state}]`:u=`parse error [${this.state}]`,new Error(`${u}: ${xs.decode(n)}`)}processHeaderMsgArgs(n){const u=[];let _=-1;for(let x=0;x<n.length;x++)switch(n[x]){case tt.SPACE:case tt.TAB:case tt.CR:case tt.NL:_>=0&&(u.push(n.subarray(_,x)),_=-1);break;default:_<0&&(_=x)}switch(_>=0&&u.push(n.subarray(_)),u.length){case 4:this.ma.subject=u[0],this.ma.sid=this.protoParseInt(u[1]),this.ma.reply=void 0,this.ma.hdr=this.protoParseInt(u[2]),this.ma.size=this.protoParseInt(u[3]);break;case 5:this.ma.subject=u[0],this.ma.sid=this.protoParseInt(u[1]),this.ma.reply=u[2],this.ma.hdr=this.protoParseInt(u[3]),this.ma.size=this.protoParseInt(u[4]);break;default:throw this.fail(n,"processHeaderMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(n,"processHeaderMsgArgs Bad or Missing Sid Error");if(this.ma.hdr<0||this.ma.hdr>this.ma.size)throw this.fail(n,"processHeaderMsgArgs Bad or Missing Header Size Error");if(this.ma.size<0)throw this.fail(n,"processHeaderMsgArgs Bad or Missing Size Error")}protoParseInt(n){if(n.length===0)return-1;let u=0;for(let _=0;_<n.length;_++){if(n[_]<48||n[_]>57)return-1;u=u*10+(n[_]-f0)}return u}}var et;(function(g){g[g.OP_START=0]="OP_START",g[g.OP_PLUS=1]="OP_PLUS",g[g.OP_PLUS_O=2]="OP_PLUS_O",g[g.OP_PLUS_OK=3]="OP_PLUS_OK",g[g.OP_MINUS=4]="OP_MINUS",g[g.OP_MINUS_E=5]="OP_MINUS_E",g[g.OP_MINUS_ER=6]="OP_MINUS_ER",g[g.OP_MINUS_ERR=7]="OP_MINUS_ERR",g[g.OP_MINUS_ERR_SPC=8]="OP_MINUS_ERR_SPC",g[g.MINUS_ERR_ARG=9]="MINUS_ERR_ARG",g[g.OP_M=10]="OP_M",g[g.OP_MS=11]="OP_MS",g[g.OP_MSG=12]="OP_MSG",g[g.OP_MSG_SPC=13]="OP_MSG_SPC",g[g.MSG_ARG=14]="MSG_ARG",g[g.MSG_PAYLOAD=15]="MSG_PAYLOAD",g[g.MSG_END=16]="MSG_END",g[g.OP_H=17]="OP_H",g[g.OP_P=18]="OP_P",g[g.OP_PI=19]="OP_PI",g[g.OP_PIN=20]="OP_PIN",g[g.OP_PING=21]="OP_PING",g[g.OP_PO=22]="OP_PO",g[g.OP_PON=23]="OP_PON",g[g.OP_PONG=24]="OP_PONG",g[g.OP_I=25]="OP_I",g[g.OP_IN=26]="OP_IN",g[g.OP_INF=27]="OP_INF",g[g.OP_INFO=28]="OP_INFO",g[g.OP_INFO_SPC=29]="OP_INFO_SPC",g[g.INFO_ARG=30]="INFO_ARG"})(et||(et={}));var tt;(function(g){g[g.CR=13]="CR",g[g.E=69]="E",g[g.e=101]="e",g[g.F=70]="F",g[g.f=102]="f",g[g.G=71]="G",g[g.g=103]="g",g[g.H=72]="H",g[g.h=104]="h",g[g.I=73]="I",g[g.i=105]="i",g[g.K=75]="K",g[g.k=107]="k",g[g.M=77]="M",g[g.m=109]="m",g[g.MINUS=45]="MINUS",g[g.N=78]="N",g[g.n=110]="n",g[g.NL=10]="NL",g[g.O=79]="O",g[g.o=111]="o",g[g.P=80]="P",g[g.p=112]="p",g[g.PLUS=43]="PLUS",g[g.R=82]="R",g[g.r=114]="r",g[g.S=83]="S",g[g.s=115]="s",g[g.SPACE=32]="SPACE",g[g.TAB=9]="TAB"})(tt||(tt={}));(function(g){var n=function(B,W){this.hi=B|0,this.lo=W|0},u=function(B){var W,Z=new Float64Array(16);if(B)for(W=0;W<B.length;W++)Z[W]=B[W];return Z},_=function(){throw new Error("no PRNG")},x=new Uint8Array(16),k=new Uint8Array(32);k[0]=9;var S=u(),h=u([1]),N=u([56129,1]),q=u([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),ne=u([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),J=u([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),G=u([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),ve=u([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function Ee(B,W){return B<<W|B>>>32-W}function $e(B,W){var Z=B[W+3]&255;return Z=Z<<8|B[W+2]&255,Z=Z<<8|B[W+1]&255,Z<<8|B[W+0]&255}function _t(B,W){var Z=B[W]<<24|B[W+1]<<16|B[W+2]<<8|B[W+3],X=B[W+4]<<24|B[W+5]<<16|B[W+6]<<8|B[W+7];return new n(Z,X)}function Tt(B,W,Z){var X;for(X=0;X<4;X++)B[W+X]=Z&255,Z>>>=8}function xt(B,W,Z){B[W]=Z.hi>>24&255,B[W+1]=Z.hi>>16&255,B[W+2]=Z.hi>>8&255,B[W+3]=Z.hi&255,B[W+4]=Z.lo>>24&255,B[W+5]=Z.lo>>16&255,B[W+6]=Z.lo>>8&255,B[W+7]=Z.lo&255}function Ct(B,W,Z,X,de){var ge,Ae=0;for(ge=0;ge<de;ge++)Ae|=B[W+ge]^Z[X+ge];return(1&Ae-1>>>8)-1}function Li(B,W,Z,X){return Ct(B,W,Z,X,16)}function Yt(B,W,Z,X){return Ct(B,W,Z,X,32)}function Vt(B,W,Z,X,de){var ge=new Uint32Array(16),Ae=new Uint32Array(16),Me=new Uint32Array(16),Ie=new Uint32Array(4),Te,Ke,Rt;for(Te=0;Te<4;Te++)Ae[5*Te]=$e(X,4*Te),Ae[1+Te]=$e(Z,4*Te),Ae[6+Te]=$e(W,4*Te),Ae[11+Te]=$e(Z,16+4*Te);for(Te=0;Te<16;Te++)Me[Te]=Ae[Te];for(Te=0;Te<20;Te++){for(Ke=0;Ke<4;Ke++){for(Rt=0;Rt<4;Rt++)Ie[Rt]=Ae[(5*Ke+4*Rt)%16];for(Ie[1]^=Ee(Ie[0]+Ie[3]|0,7),Ie[2]^=Ee(Ie[1]+Ie[0]|0,9),Ie[3]^=Ee(Ie[2]+Ie[1]|0,13),Ie[0]^=Ee(Ie[3]+Ie[2]|0,18),Rt=0;Rt<4;Rt++)ge[4*Ke+(Ke+Rt)%4]=Ie[Rt]}for(Rt=0;Rt<16;Rt++)Ae[Rt]=ge[Rt]}if(de){for(Te=0;Te<16;Te++)Ae[Te]=Ae[Te]+Me[Te]|0;for(Te=0;Te<4;Te++)Ae[5*Te]=Ae[5*Te]-$e(X,4*Te)|0,Ae[6+Te]=Ae[6+Te]-$e(W,4*Te)|0;for(Te=0;Te<4;Te++)Tt(B,4*Te,Ae[5*Te]),Tt(B,16+4*Te,Ae[6+Te])}else for(Te=0;Te<16;Te++)Tt(B,4*Te,Ae[Te]+Me[Te]|0)}function yt(B,W,Z,X){return Vt(B,W,Z,X,!1),0}function ri(B,W,Z,X){return Vt(B,W,Z,X,!0),0}var Bt=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function ji(B,W,Z,X,de,ge,Ae){var Me=new Uint8Array(16),Ie=new Uint8Array(64),Te,Ke;if(!de)return 0;for(Ke=0;Ke<16;Ke++)Me[Ke]=0;for(Ke=0;Ke<8;Ke++)Me[Ke]=ge[Ke];for(;de>=64;){for(yt(Ie,Me,Ae,Bt),Ke=0;Ke<64;Ke++)B[W+Ke]=(Z?Z[X+Ke]:0)^Ie[Ke];for(Te=1,Ke=8;Ke<16;Ke++)Te=Te+(Me[Ke]&255)|0,Me[Ke]=Te&255,Te>>>=8;de-=64,W+=64,Z&&(X+=64)}if(de>0)for(yt(Ie,Me,Ae,Bt),Ke=0;Ke<de;Ke++)B[W+Ke]=(Z?Z[X+Ke]:0)^Ie[Ke];return 0}function Lt(B,W,Z,X,de){return ji(B,W,null,0,Z,X,de)}function kt(B,W,Z,X,de){var ge=new Uint8Array(32);return ri(ge,X,de,Bt),Lt(B,W,Z,X.subarray(16),ge)}function pi(B,W,Z,X,de,ge,Ae){var Me=new Uint8Array(32);return ri(Me,ge,Ae,Bt),ji(B,W,Z,X,de,ge.subarray(16),Me)}function De(B,W){var Z,X=0;for(Z=0;Z<17;Z++)X=X+(B[Z]+W[Z]|0)|0,B[Z]=X&255,X>>>=8}var Ut=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]);function ni(B,W,Z,X,de,ge){var Ae,Me,Ie,Te,Ke=new Uint32Array(17),Rt=new Uint32Array(17),Qt=new Uint32Array(17),Jt=new Uint32Array(17),Xr=new Uint32Array(17);for(Ie=0;Ie<17;Ie++)Rt[Ie]=Qt[Ie]=0;for(Ie=0;Ie<16;Ie++)Rt[Ie]=ge[Ie];for(Rt[3]&=15,Rt[4]&=252,Rt[7]&=15,Rt[8]&=252,Rt[11]&=15,Rt[12]&=252,Rt[15]&=15;de>0;){for(Ie=0;Ie<17;Ie++)Jt[Ie]=0;for(Ie=0;Ie<16&&Ie<de;++Ie)Jt[Ie]=Z[X+Ie];for(Jt[Ie]=1,X+=Ie,de-=Ie,De(Qt,Jt),Me=0;Me<17;Me++)for(Ke[Me]=0,Ie=0;Ie<17;Ie++)Ke[Me]=Ke[Me]+Qt[Ie]*(Ie<=Me?Rt[Me-Ie]:320*Rt[Me+17-Ie]|0)|0|0;for(Me=0;Me<17;Me++)Qt[Me]=Ke[Me];for(Te=0,Ie=0;Ie<16;Ie++)Te=Te+Qt[Ie]|0,Qt[Ie]=Te&255,Te>>>=8;for(Te=Te+Qt[16]|0,Qt[16]=Te&3,Te=5*(Te>>>2)|0,Ie=0;Ie<16;Ie++)Te=Te+Qt[Ie]|0,Qt[Ie]=Te&255,Te>>>=8;Te=Te+Qt[16]|0,Qt[16]=Te}for(Ie=0;Ie<17;Ie++)Xr[Ie]=Qt[Ie];for(De(Qt,Ut),Ae=-(Qt[16]>>>7)|0,Ie=0;Ie<17;Ie++)Qt[Ie]^=Ae&(Xr[Ie]^Qt[Ie]);for(Ie=0;Ie<16;Ie++)Jt[Ie]=ge[Ie+16];for(Jt[16]=0,De(Qt,Jt),Ie=0;Ie<16;Ie++)B[W+Ie]=Qt[Ie];return 0}function oi(B,W,Z,X,de,ge){var Ae=new Uint8Array(16);return ni(Ae,0,Z,X,de,ge),Li(B,W,Ae,0)}function ws(B,W,Z,X,de){var ge;if(Z<32)return-1;for(pi(B,0,W,0,Z,X,de),ni(B,16,B,32,Z-32,B),ge=0;ge<16;ge++)B[ge]=0;return 0}function Ni(B,W,Z,X,de){var ge,Ae=new Uint8Array(32);if(Z<32||(kt(Ae,0,32,X,de),oi(W,16,W,32,Z-32,Ae)!==0))return-1;for(pi(B,0,W,0,Z,X,de),ge=0;ge<32;ge++)B[ge]=0;return 0}function si(B,W){var Z;for(Z=0;Z<16;Z++)B[Z]=W[Z]|0}function gi(B){var W,Z;for(Z=0;Z<16;Z++)B[Z]+=65536,W=Math.floor(B[Z]/65536),B[(Z+1)*(Z<15?1:0)]+=W-1+37*(W-1)*(Z===15?1:0),B[Z]-=W*65536}function Zi(B,W,Z){for(var X,de=~(Z-1),ge=0;ge<16;ge++)X=de&(B[ge]^W[ge]),B[ge]^=X,W[ge]^=X}function Dr(B,W){var Z,X,de,ge=u(),Ae=u();for(Z=0;Z<16;Z++)Ae[Z]=W[Z];for(gi(Ae),gi(Ae),gi(Ae),X=0;X<2;X++){for(ge[0]=Ae[0]-65517,Z=1;Z<15;Z++)ge[Z]=Ae[Z]-65535-(ge[Z-1]>>16&1),ge[Z-1]&=65535;ge[15]=Ae[15]-32767-(ge[14]>>16&1),de=ge[15]>>16&1,ge[14]&=65535,Zi(Ae,ge,1-de)}for(Z=0;Z<16;Z++)B[2*Z]=Ae[Z]&255,B[2*Z+1]=Ae[Z]>>8}function Yr(B,W){var Z=new Uint8Array(32),X=new Uint8Array(32);return Dr(Z,B),Dr(X,W),Yt(Z,0,X,0)}function Lr(B){var W=new Uint8Array(32);return Dr(W,B),W[0]&1}function Ss(B,W){var Z;for(Z=0;Z<16;Z++)B[Z]=W[2*Z]+(W[2*Z+1]<<8);B[15]&=32767}function wi(B,W,Z){var X;for(X=0;X<16;X++)B[X]=W[X]+Z[X]|0}function ki(B,W,Z){var X;for(X=0;X<16;X++)B[X]=W[X]-Z[X]|0}function Mt(B,W,Z){var X,de,ge=new Float64Array(31);for(X=0;X<31;X++)ge[X]=0;for(X=0;X<16;X++)for(de=0;de<16;de++)ge[X+de]+=W[X]*Z[de];for(X=0;X<15;X++)ge[X]+=38*ge[X+16];for(X=0;X<16;X++)B[X]=ge[X];gi(B),gi(B)}function $i(B,W){Mt(B,W,W)}function Gs(B,W){var Z=u(),X;for(X=0;X<16;X++)Z[X]=W[X];for(X=253;X>=0;X--)$i(Z,Z),X!==2&&X!==4&&Mt(Z,Z,W);for(X=0;X<16;X++)B[X]=Z[X]}function Hr(B,W){var Z=u(),X;for(X=0;X<16;X++)Z[X]=W[X];for(X=250;X>=0;X--)$i(Z,Z),X!==1&&Mt(Z,Z,W);for(X=0;X<16;X++)B[X]=Z[X]}function Rr(B,W,Z){var X=new Uint8Array(32),de=new Float64Array(80),ge,Ae,Me=u(),Ie=u(),Te=u(),Ke=u(),Rt=u(),Qt=u();for(Ae=0;Ae<31;Ae++)X[Ae]=W[Ae];for(X[31]=W[31]&127|64,X[0]&=248,Ss(de,Z),Ae=0;Ae<16;Ae++)Ie[Ae]=de[Ae],Ke[Ae]=Me[Ae]=Te[Ae]=0;for(Me[0]=Ke[0]=1,Ae=254;Ae>=0;--Ae)ge=X[Ae>>>3]>>>(Ae&7)&1,Zi(Me,Ie,ge),Zi(Te,Ke,ge),wi(Rt,Me,Te),ki(Me,Me,Te),wi(Te,Ie,Ke),ki(Ie,Ie,Ke),$i(Ke,Rt),$i(Qt,Me),Mt(Me,Te,Me),Mt(Te,Ie,Rt),wi(Rt,Me,Te),ki(Me,Me,Te),$i(Ie,Me),ki(Te,Ke,Qt),Mt(Me,Te,N),wi(Me,Me,Ke),Mt(Te,Te,Me),Mt(Me,Ke,Qt),Mt(Ke,Ie,de),$i(Ie,Rt),Zi(Me,Ie,ge),Zi(Te,Ke,ge);for(Ae=0;Ae<16;Ae++)de[Ae+16]=Me[Ae],de[Ae+32]=Te[Ae],de[Ae+48]=Ie[Ae],de[Ae+64]=Ke[Ae];var Jt=de.subarray(32),Xr=de.subarray(16);return Gs(Jt,Jt),Mt(Xr,Xr,Jt),Dr(B,Xr),0}function Or(B,W){return Rr(B,W,k)}function zs(B,W){return _(W,32),Or(B,W)}function be(B,W,Z){var X=new Uint8Array(32);return Rr(X,Z,W),ri(B,x,X,Bt)}var Is=ws,on=Ni;function Gt(B,W,Z,X,de,ge){var Ae=new Uint8Array(32);return be(Ae,de,ge),Is(B,W,Z,X,Ae)}function Si(B,W,Z,X,de,ge){var Ae=new Uint8Array(32);return be(Ae,de,ge),on(B,W,Z,X,Ae)}function Qr(){var B=0,W=0,Z=0,X=0,de=65535,ge,Ae,Me;for(Me=0;Me<arguments.length;Me++)ge=arguments[Me].lo,Ae=arguments[Me].hi,B+=ge&de,W+=ge>>>16,Z+=Ae&de,X+=Ae>>>16;return W+=B>>>16,Z+=W>>>16,X+=Z>>>16,new n(Z&de|X<<16,B&de|W<<16)}function es(B,W){return new n(B.hi>>>W,B.lo>>>W|B.hi<<32-W)}function vr(){var B=0,W=0,Z;for(Z=0;Z<arguments.length;Z++)B^=arguments[Z].lo,W^=arguments[Z].hi;return new n(W,B)}function Ki(B,W){var Z,X,de=32-W;return W<32?(Z=B.hi>>>W|B.lo<<de,X=B.lo>>>W|B.hi<<de):W<64&&(Z=B.lo>>>W|B.hi<<de,X=B.hi>>>W|B.lo<<de),new n(Z,X)}function br(B,W,Z){var X=B.hi&W.hi^~B.hi&Z.hi,de=B.lo&W.lo^~B.lo&Z.lo;return new n(X,de)}function an(B,W,Z){var X=B.hi&W.hi^B.hi&Z.hi^W.hi&Z.hi,de=B.lo&W.lo^B.lo&Z.lo^W.lo&Z.lo;return new n(X,de)}function ln(B){return vr(Ki(B,28),Ki(B,34),Ki(B,39))}function Oe(B){return vr(Ki(B,14),Ki(B,18),Ki(B,41))}function Zr(B){return vr(Ki(B,1),Ki(B,8),es(B,7))}function Yi(B){return vr(Ki(B,19),Ki(B,61),es(B,6))}var Wr=[new n(1116352408,3609767458),new n(1899447441,602891725),new n(3049323471,3964484399),new n(3921009573,2173295548),new n(961987163,4081628472),new n(1508970993,3053834265),new n(2453635748,2937671579),new n(2870763221,3664609560),new n(3624381080,2734883394),new n(310598401,1164996542),new n(607225278,1323610764),new n(1426881987,3590304994),new n(1925078388,4068182383),new n(2162078206,991336113),new n(2614888103,633803317),new n(3248222580,3479774868),new n(3835390401,2666613458),new n(4022224774,944711139),new n(264347078,2341262773),new n(604807628,2007800933),new n(770255983,1495990901),new n(1249150122,1856431235),new n(1555081692,3175218132),new n(1996064986,2198950837),new n(2554220882,3999719339),new n(2821834349,766784016),new n(2952996808,2566594879),new n(3210313671,3203337956),new n(3336571891,1034457026),new n(3584528711,2466948901),new n(113926993,3758326383),new n(338241895,168717936),new n(666307205,1188179964),new n(773529912,1546045734),new n(1294757372,1522805485),new n(1396182291,2643833823),new n(1695183700,2343527390),new n(1986661051,1014477480),new n(2177026350,1206759142),new n(2456956037,344077627),new n(2730485921,1290863460),new n(2820302411,3158454273),new n(3259730800,3505952657),new n(3345764771,106217008),new n(3516065817,3606008344),new n(3600352804,1432725776),new n(4094571909,1467031594),new n(275423344,851169720),new n(430227734,3100823752),new n(506948616,1363258195),new n(659060556,3750685593),new n(883997877,3785050280),new n(958139571,3318307427),new n(1322822218,3812723403),new n(1537002063,2003034995),new n(1747873779,3602036899),new n(1955562222,1575990012),new n(2024104815,1125592928),new n(2227730452,2716904306),new n(2361852424,442776044),new n(2428436474,593698344),new n(2756734187,3733110249),new n(3204031479,2999351573),new n(3329325298,3815920427),new n(3391569614,3928383900),new n(3515267271,566280711),new n(3940187606,3454069534),new n(4118630271,4000239992),new n(116418474,1914138554),new n(174292421,2731055270),new n(289380356,3203993006),new n(460393269,320620315),new n(685471733,587496836),new n(852142971,1086792851),new n(1017036298,365543100),new n(1126000580,2618297676),new n(1288033470,3409855158),new n(1501505948,4234509866),new n(1607167915,987167468),new n(1816402316,1246189591)];function ts(B,W,Z){var X=[],de=[],ge=[],Ae=[],Me,Ie,Te;for(Ie=0;Ie<8;Ie++)X[Ie]=ge[Ie]=_t(B,8*Ie);for(var Ke=0;Z>=128;){for(Ie=0;Ie<16;Ie++)Ae[Ie]=_t(W,8*Ie+Ke);for(Ie=0;Ie<80;Ie++){for(Te=0;Te<8;Te++)de[Te]=ge[Te];for(Me=Qr(ge[7],Oe(ge[4]),br(ge[4],ge[5],ge[6]),Wr[Ie],Ae[Ie%16]),de[7]=Qr(Me,ln(ge[0]),an(ge[0],ge[1],ge[2])),de[3]=Qr(de[3],Me),Te=0;Te<8;Te++)ge[(Te+1)%8]=de[Te];if(Ie%16===15)for(Te=0;Te<16;Te++)Ae[Te]=Qr(Ae[Te],Ae[(Te+9)%16],Zr(Ae[(Te+1)%16]),Yi(Ae[(Te+14)%16]))}for(Ie=0;Ie<8;Ie++)ge[Ie]=Qr(ge[Ie],X[Ie]),X[Ie]=ge[Ie];Ke+=128,Z-=128}for(Ie=0;Ie<8;Ie++)xt(B,8*Ie,X[Ie]);return Z}var je=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]);function St(B,W,Z){var X=new Uint8Array(64),de=new Uint8Array(256),ge,Ae=Z;for(ge=0;ge<64;ge++)X[ge]=je[ge];for(ts(X,W,Z),Z%=128,ge=0;ge<256;ge++)de[ge]=0;for(ge=0;ge<Z;ge++)de[ge]=W[Ae-Z+ge];for(de[Z]=128,Z=256-128*(Z<112?1:0),de[Z-9]=0,xt(de,Z-8,new n(Ae/536870912|0,Ae<<3)),ts(X,de,Z),ge=0;ge<64;ge++)B[ge]=X[ge];return 0}function pt(B,W){var Z=u(),X=u(),de=u(),ge=u(),Ae=u(),Me=u(),Ie=u(),Te=u(),Ke=u();ki(Z,B[1],B[0]),ki(Ke,W[1],W[0]),Mt(Z,Z,Ke),wi(X,B[0],B[1]),wi(Ke,W[0],W[1]),Mt(X,X,Ke),Mt(de,B[3],W[3]),Mt(de,de,ne),Mt(ge,B[2],W[2]),wi(ge,ge,ge),ki(Ae,X,Z),ki(Me,ge,de),wi(Ie,ge,de),wi(Te,X,Z),Mt(B[0],Ae,Me),Mt(B[1],Te,Ie),Mt(B[2],Ie,Me),Mt(B[3],Ae,Te)}function Qi(B,W,Z){var X;for(X=0;X<4;X++)Zi(B[X],W[X],Z)}function ur(B,W){var Z=u(),X=u(),de=u();Gs(de,W[2]),Mt(Z,W[0],de),Mt(X,W[1],de),Dr(B,X),B[31]^=Lr(Z)<<7}function vt(B,W,Z){var X,de;for(si(B[0],S),si(B[1],h),si(B[2],h),si(B[3],S),de=255;de>=0;--de)X=Z[de/8|0]>>(de&7)&1,Qi(B,W,X),pt(W,B),pt(B,B),Qi(B,W,X)}function dr(B,W){var Z=[u(),u(),u(),u()];si(Z[0],J),si(Z[1],G),si(Z[2],h),Mt(Z[3],J,G),vt(B,Z,W)}function Fr(B,W,Z){var X=new Uint8Array(64),de=[u(),u(),u(),u()],ge;for(Z||_(W,32),St(X,W,32),X[0]&=248,X[31]&=127,X[31]|=64,dr(de,X),ur(B,de),ge=0;ge<32;ge++)W[ge+32]=B[ge];return 0}var Br=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function wr(B,W){var Z,X,de,ge;for(X=63;X>=32;--X){for(Z=0,de=X-32,ge=X-12;de<ge;++de)W[de]+=Z-16*W[X]*Br[de-(X-32)],Z=Math.floor((W[de]+128)/256),W[de]-=Z*256;W[de]+=Z,W[X]=0}for(Z=0,de=0;de<32;de++)W[de]+=Z-(W[31]>>4)*Br[de],Z=W[de]>>8,W[de]&=255;for(de=0;de<32;de++)W[de]-=Z*Br[de];for(X=0;X<32;X++)W[X+1]+=W[X]>>8,B[X]=W[X]&255}function te(B){var W=new Float64Array(64),Z;for(Z=0;Z<64;Z++)W[Z]=B[Z];for(Z=0;Z<64;Z++)B[Z]=0;wr(B,W)}function D(B,W,Z,X){var de=new Uint8Array(64),ge=new Uint8Array(64),Ae=new Uint8Array(64),Me,Ie,Te=new Float64Array(64),Ke=[u(),u(),u(),u()];St(de,X,32),de[0]&=248,de[31]&=127,de[31]|=64;var Rt=Z+64;for(Me=0;Me<Z;Me++)B[64+Me]=W[Me];for(Me=0;Me<32;Me++)B[32+Me]=de[32+Me];for(St(Ae,B.subarray(32),Z+32),te(Ae),dr(Ke,Ae),ur(B,Ke),Me=32;Me<64;Me++)B[Me]=X[Me];for(St(ge,B,Z+64),te(ge),Me=0;Me<64;Me++)Te[Me]=0;for(Me=0;Me<32;Me++)Te[Me]=Ae[Me];for(Me=0;Me<32;Me++)for(Ie=0;Ie<32;Ie++)Te[Me+Ie]+=ge[Me]*de[Ie];return wr(B.subarray(32),Te),Rt}function L(B,W){var Z=u(),X=u(),de=u(),ge=u(),Ae=u(),Me=u(),Ie=u();return si(B[2],h),Ss(B[1],W),$i(de,B[1]),Mt(ge,de,q),ki(de,de,B[2]),wi(ge,B[2],ge),$i(Ae,ge),$i(Me,Ae),Mt(Ie,Me,Ae),Mt(Z,Ie,de),Mt(Z,Z,ge),Hr(Z,Z),Mt(Z,Z,de),Mt(Z,Z,ge),Mt(Z,Z,ge),Mt(B[0],Z,ge),$i(X,B[0]),Mt(X,X,ge),Yr(X,de)&&Mt(B[0],B[0],ve),$i(X,B[0]),Mt(X,X,ge),Yr(X,de)?-1:(Lr(B[0])===W[31]>>7&&ki(B[0],S,B[0]),Mt(B[3],B[0],B[1]),0)}function j(B,W,Z,X){var de,ge=new Uint8Array(32),Ae=new Uint8Array(64),Me=[u(),u(),u(),u()],Ie=[u(),u(),u(),u()];if(Z<64||L(Ie,X))return-1;for(de=0;de<Z;de++)B[de]=W[de];for(de=0;de<32;de++)B[de+32]=X[de];if(St(Ae,B,Z),te(Ae),vt(Me,Ie,Ae),dr(Ie,W.subarray(32)),pt(Me,Ie),ur(ge,Me),Z-=64,Yt(W,0,ge,0)){for(de=0;de<Z;de++)B[de]=0;return-1}for(de=0;de<Z;de++)B[de]=W[de+64];return Z}var K=32,le=24,he=32,fe=16,oe=32,we=32,Pe=32,xe=32,Fe=32,ot=le,ut=he,qt=fe,gt=64,zt=32,Et=64,Ii=32,fi=64;g.lowlevel={crypto_core_hsalsa20:ri,crypto_stream_xor:pi,crypto_stream:kt,crypto_stream_salsa20_xor:ji,crypto_stream_salsa20:Lt,crypto_onetimeauth:ni,crypto_onetimeauth_verify:oi,crypto_verify_16:Li,crypto_verify_32:Yt,crypto_secretbox:ws,crypto_secretbox_open:Ni,crypto_scalarmult:Rr,crypto_scalarmult_base:Or,crypto_box_beforenm:be,crypto_box_afternm:Is,crypto_box:Gt,crypto_box_open:Si,crypto_box_keypair:zs,crypto_hash:St,crypto_sign:D,crypto_sign_keypair:Fr,crypto_sign_open:j,crypto_secretbox_KEYBYTES:K,crypto_secretbox_NONCEBYTES:le,crypto_secretbox_ZEROBYTES:he,crypto_secretbox_BOXZEROBYTES:fe,crypto_scalarmult_BYTES:oe,crypto_scalarmult_SCALARBYTES:we,crypto_box_PUBLICKEYBYTES:Pe,crypto_box_SECRETKEYBYTES:xe,crypto_box_BEFORENMBYTES:Fe,crypto_box_NONCEBYTES:ot,crypto_box_ZEROBYTES:ut,crypto_box_BOXZEROBYTES:qt,crypto_sign_BYTES:gt,crypto_sign_PUBLICKEYBYTES:zt,crypto_sign_SECRETKEYBYTES:Et,crypto_sign_SEEDBYTES:Ii,crypto_hash_BYTES:fi,gf:u,D:q,L:Br,pack25519:Dr,unpack25519:Ss,M:Mt,A:wi,S:$i,Z:ki,pow2523:Hr,add:pt,set25519:si,modL:wr,scalarmult:vt,scalarbase:dr};function At(B,W){if(B.length!==K)throw new Error("bad key size");if(W.length!==le)throw new Error("bad nonce size")}function Xt(B,W){if(B.length!==Pe)throw new Error("bad public key size");if(W.length!==xe)throw new Error("bad secret key size")}function jt(){for(var B=0;B<arguments.length;B++)if(!(arguments[B]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function Ri(B){for(var W=0;W<B.length;W++)B[W]=0}g.randomBytes=function(B){var W=new Uint8Array(B);return _(W,B),W},g.secretbox=function(B,W,Z){jt(B,W,Z),At(Z,W);for(var X=new Uint8Array(he+B.length),de=new Uint8Array(X.length),ge=0;ge<B.length;ge++)X[ge+he]=B[ge];return ws(de,X,X.length,W,Z),de.subarray(fe)},g.secretbox.open=function(B,W,Z){jt(B,W,Z),At(Z,W);for(var X=new Uint8Array(fe+B.length),de=new Uint8Array(X.length),ge=0;ge<B.length;ge++)X[ge+fe]=B[ge];return X.length<32||Ni(de,X,X.length,W,Z)!==0?null:de.subarray(he)},g.secretbox.keyLength=K,g.secretbox.nonceLength=le,g.secretbox.overheadLength=fe,g.scalarMult=function(B,W){if(jt(B,W),B.length!==we)throw new Error("bad n size");if(W.length!==oe)throw new Error("bad p size");var Z=new Uint8Array(oe);return Rr(Z,B,W),Z},g.scalarMult.base=function(B){if(jt(B),B.length!==we)throw new Error("bad n size");var W=new Uint8Array(oe);return Or(W,B),W},g.scalarMult.scalarLength=we,g.scalarMult.groupElementLength=oe,g.box=function(B,W,Z,X){var de=g.box.before(Z,X);return g.secretbox(B,W,de)},g.box.before=function(B,W){jt(B,W),Xt(B,W);var Z=new Uint8Array(Fe);return be(Z,B,W),Z},g.box.after=g.secretbox,g.box.open=function(B,W,Z,X){var de=g.box.before(Z,X);return g.secretbox.open(B,W,de)},g.box.open.after=g.secretbox.open,g.box.keyPair=function(){var B=new Uint8Array(Pe),W=new Uint8Array(xe);return zs(B,W),{publicKey:B,secretKey:W}},g.box.keyPair.fromSecretKey=function(B){if(jt(B),B.length!==xe)throw new Error("bad secret key size");var W=new Uint8Array(Pe);return Or(W,B),{publicKey:W,secretKey:new Uint8Array(B)}},g.box.publicKeyLength=Pe,g.box.secretKeyLength=xe,g.box.sharedKeyLength=Fe,g.box.nonceLength=ot,g.box.overheadLength=g.secretbox.overheadLength,g.sign=function(B,W){if(jt(B,W),W.length!==Et)throw new Error("bad secret key size");var Z=new Uint8Array(gt+B.length);return D(Z,B,B.length,W),Z},g.sign.open=function(B,W){if(jt(B,W),W.length!==zt)throw new Error("bad public key size");var Z=new Uint8Array(B.length),X=j(Z,B,B.length,W);if(X<0)return null;for(var de=new Uint8Array(X),ge=0;ge<de.length;ge++)de[ge]=Z[ge];return de},g.sign.detached=function(B,W){for(var Z=g.sign(B,W),X=new Uint8Array(gt),de=0;de<X.length;de++)X[de]=Z[de];return X},g.sign.detached.verify=function(B,W,Z){if(jt(B,W,Z),W.length!==gt)throw new Error("bad signature size");if(Z.length!==zt)throw new Error("bad public key size");var X=new Uint8Array(gt+B.length),de=new Uint8Array(gt+B.length),ge;for(ge=0;ge<gt;ge++)X[ge]=W[ge];for(ge=0;ge<B.length;ge++)X[ge+gt]=B[ge];return j(de,X,X.length,Z)>=0},g.sign.keyPair=function(){var B=new Uint8Array(zt),W=new Uint8Array(Et);return Fr(B,W),{publicKey:B,secretKey:W}},g.sign.keyPair.fromSecretKey=function(B){if(jt(B),B.length!==Et)throw new Error("bad secret key size");for(var W=new Uint8Array(zt),Z=0;Z<W.length;Z++)W[Z]=B[32+Z];return{publicKey:W,secretKey:new Uint8Array(B)}},g.sign.keyPair.fromSeed=function(B){if(jt(B),B.length!==Ii)throw new Error("bad seed size");for(var W=new Uint8Array(zt),Z=new Uint8Array(Et),X=0;X<32;X++)Z[X]=B[X];return Fr(W,Z,!0),{publicKey:W,secretKey:Z}},g.sign.publicKeyLength=zt,g.sign.secretKeyLength=Et,g.sign.seedLength=Ii,g.sign.signatureLength=gt,g.hash=function(B){jt(B);var W=new Uint8Array(fi);return St(W,B,B.length),W},g.hash.hashLength=fi,g.verify=function(B,W){return jt(B,W),B.length===0||W.length===0||B.length!==W.length?!1:Ct(B,0,W,0,B.length)===0},g.setPRNG=function(B){_=B},function(){var B=typeof globalThis<"u"?globalThis.crypto||globalThis.msCrypto:null;if(B&&B.getRandomValues){var W=65536;g.setPRNG(function(Z,X){var de,ge=new Uint8Array(X);for(de=0;de<X;de+=W)B.getRandomValues(ge.subarray(de,de+Math.min(X-de,W)));for(de=0;de<X;de++)Z[de]=ge[de];Ri(ge)})}else typeof require<"u"&&(B=require("crypto"),B&&B.randomBytes&&g.setPRNG(function(Z,X){var de,ge=B.randomBytes(X);for(de=0;de<X;de++)Z[de]=ge[de];Ri(ge)}))}()})(typeof module<"u"&&module.exports?module.exports:globalThis.nacl=globalThis.nacl||{});const vh=typeof module<"u"&&module.exports?module.exports:globalThis.nacl;vh.sign.keyPair.fromSeed,vh.sign.detached,vh.sign.detached.verify,vh.randomBytes;var Gf;(function(g){g.InvalidPrefixByte="nkeys: invalid prefix byte",g.InvalidKey="nkeys: invalid key",g.InvalidPublicKey="nkeys: invalid public key",g.InvalidSeedLen="nkeys: invalid seed length",g.InvalidSeed="nkeys: invalid seed",g.InvalidEncoding="nkeys: invalid encoded key",g.InvalidSignature="nkeys: signature verification failed",g.CannotSign="nkeys: cannot sign, no private key available",g.PublicKeyOnly="nkeys: no seed or private key available",g.InvalidChecksum="nkeys: invalid checksum",g.SerializationError="nkeys: serialization error",g.ApiError="nkeys: api error",g.ClearedPair="nkeys: pair is cleared"})(Gf||(Gf={}));var Hf;(function(g){g[g.Seed=144]="Seed",g[g.Private=120]="Private",g[g.Operator=112]="Operator",g[g.Server=104]="Server",g[g.Cluster=16]="Cluster",g[g.Account=0]="Account",g[g.User=160]="User"})(Hf||(Hf={}));function m0(g){return n=>{let u={};return g.forEach(_=>{const x=_(n)||{};u=Object.assign(u,x)}),u}}function _0(){return()=>{}}function g0(g,n){return()=>{const u=typeof g=="function"?g():g,_=typeof n=="function"?n():n;return{user:u,pass:_}}}function y0(g){return()=>({auth_token:typeof g=="function"?g():g})}const km=2*60*1e3,x0=2,Em=2*1e3;function v0(){return{maxPingOut:2,maxReconnectAttempts:10,noRandomize:!1,pedantic:!1,pingInterval:km,reconnect:!0,reconnectJitter:100,reconnectJitterTLS:1e3,reconnectTimeWait:Em,tls:void 0,verbose:!1,waitOnFirstConnect:!1,ignoreAuthErrorAbort:!1}}function b0(g){const n=[];return typeof g.authenticator=="function"&&n.push(g.authenticator),Array.isArray(g.authenticator)&&n.push(...g.authenticator),g.token&&n.push(y0(g.token)),g.user&&n.push(g0(g.user,g.pass)),n.length===0?_0():m0(n)}function w0(g){const n=`${dd}:${Sm()}`;if(g=g||{servers:[n]},g.servers=g.servers||[],typeof g.servers=="string"&&(g.servers=[g.servers]),g.servers.length>0&&g.port)throw new ht("port and servers options are mutually exclusive",He.InvalidOption);g.servers.length===0&&g.port&&(g.servers=[`${dd}:${g.port}`]),g.servers&&g.servers.length===0&&(g.servers=[n]);const u=Bh(v0(),g);if(u.authenticator=b0(u),["reconnectDelayHandler","authenticator"].forEach(_=>{if(u[_]&&typeof u[_]!="function")throw new ht(`${_} option should be a function`,He.NotFunction)}),u.reconnectDelayHandler||(u.reconnectDelayHandler=()=>{let _=u.tls?u.reconnectJitterTLS:u.reconnectJitter;return _&&(_++,_=Math.floor(Math.random()*_)),u.reconnectTimeWait+_}),u.inboxPrefix)try{nn(u.inboxPrefix)}catch(_){throw new ht(_.message,He.ApiError)}if(u.resolve===void 0&&(u.resolve=typeof xd()=="function"),u.resolve&&typeof xd()!="function")throw new ht("'resolve' is not supported on this client",He.InvalidOption);return u}function S0(g,n){const{proto:u,tls_required:_,tls_available:x}=g;if((u===void 0||u<1)&&n.noEcho)throw new ht("noEcho",He.ServerOptionNotAvailable);const k=_||x||!1;if(n.tls&&!k)throw new ht("tls",He.ServerOptionNotAvailable)}const I0=1024*32,T0=/^INFO\s+([^\r\n]+)\r\n/i,k0=Ql(`PONG\r
`),Zf=Ql(`PING\r
`);class E0{constructor(n,u,_){U(this,"echo");U(this,"no_responders");U(this,"protocol");U(this,"verbose");U(this,"pedantic");U(this,"jwt");U(this,"nkey");U(this,"sig");U(this,"user");U(this,"pass");U(this,"auth_token");U(this,"tls_required");U(this,"name");U(this,"lang");U(this,"version");U(this,"headers");this.protocol=1,this.version=n.version,this.lang=n.lang,this.echo=u.noEcho?!1:void 0,this.verbose=u.verbose,this.pedantic=u.pedantic,this.tls_required=u.tls?!0:void 0,this.name=u.name;const x=(u&&typeof u.authenticator=="function"?u.authenticator(_):{})||{};Bh(this,x)}}class Am extends hr{constructor(u,_,x={}){var S;super();U(this,"sid");U(this,"queue");U(this,"draining");U(this,"max");U(this,"subject");U(this,"drained");U(this,"protocol");U(this,"timer");U(this,"info");U(this,"cleanupFn");U(this,"closed");U(this,"requestSubject");Bh(this,x),this.protocol=u,this.subject=_,this.draining=!1,this.noIterator=typeof x.callback=="function",this.closed=Di();const k=!((S=u.options)!=null&&S.noAsyncTraces);x.timeout&&(this.timer=Ga(x.timeout,k),this.timer.then(()=>{this.timer=void 0}).catch(h=>{this.stop(h),this.noIterator&&this.callback(h,{})})),this.noIterator||this.iterClosed.then(()=>{this.closed.resolve(),this.unsubscribe()})}setPrePostHandlers(u){if(this.noIterator){const _=this.callback,x=u.ingestionFilterFn?u.ingestionFilterFn:()=>({ingest:!0,protocol:!1}),k=u.protocolFilterFn?u.protocolFilterFn:()=>!0,S=u.dispatchedFn?u.dispatchedFn:()=>{};this.callback=(h,N)=>{const{ingest:q}=x(N);q&&k(N)&&(_(h,N),S(N))}}else this.protocolFilterFn=u.protocolFilterFn,this.dispatchedFn=u.dispatchedFn}callback(u,_){this.cancelTimeout(),u?this.stop(u):this.push(_)}close(){if(!this.isClosed()){this.cancelTimeout();const u=()=>{if(this.stop(),this.cleanupFn)try{this.cleanupFn(this,this.info)}catch{}this.closed.resolve()};this.noIterator?u():this.push(u)}}unsubscribe(u){this.protocol.unsubscribe(this,u)}cancelTimeout(){this.timer&&(this.timer.cancel(),this.timer=void 0)}drain(){return this.protocol.isClosed()?Promise.reject(ht.errorForCode(He.ConnectionClosed)):this.isClosed()?Promise.reject(ht.errorForCode(He.SubClosed)):(this.drained||(this.draining=!0,this.protocol.unsub(this),this.drained=this.protocol.flush(Di()).then(()=>{this.protocol.subscriptions.cancel(this)}).catch(()=>{this.protocol.subscriptions.cancel(this)})),this.drained)}isDraining(){return this.draining}isClosed(){return this.done}getSubject(){return this.subject}getMax(){return this.max}getID(){return this.sid}}class A0{constructor(){U(this,"mux");U(this,"subs");U(this,"sidCounter");this.sidCounter=0,this.mux=null,this.subs=new Map}size(){return this.subs.size}add(n){return this.sidCounter++,n.sid=this.sidCounter,this.subs.set(n.sid,n),n}setMux(n){return this.mux=n,n}getMux(){return this.mux}get(n){return this.subs.get(n)}resub(n){return this.sidCounter++,this.subs.delete(n.sid),n.sid=this.sidCounter,this.subs.set(n.sid,n),n}all(){return Array.from(this.subs.values())}cancel(n){n&&(n.close(),this.subs.delete(n.sid))}handleError(n){if(n&&n.permissionContext){const u=n.permissionContext,_=this.all();let x;if(u.operation==="subscription"&&(x=_.find(k=>k.subject===u.subject&&k.queue===u.queue)),u.operation==="publish"&&(x=_.find(k=>k.requestSubject===u.subject)),x)return x.callback(n,{}),x.close(),this.subs.delete(x.sid),x!==this.mux}return!1}close(){this.subs.forEach(n=>{n.close()})}}class Lh{constructor(n,u){U(this,"connected");U(this,"connectedOnce");U(this,"infoReceived");U(this,"info");U(this,"muxSubscriptions");U(this,"options");U(this,"outbound");U(this,"pongs");U(this,"subscriptions");U(this,"transport");U(this,"noMorePublishing");U(this,"connectError");U(this,"publisher");U(this,"_closed");U(this,"closed");U(this,"listeners");U(this,"heartbeats");U(this,"parser");U(this,"outMsgs");U(this,"inMsgs");U(this,"outBytes");U(this,"inBytes");U(this,"pendingLimit");U(this,"lastError");U(this,"abortReconnect");U(this,"whyClosed");U(this,"servers");U(this,"server");U(this,"features");U(this,"connectPromise");this._closed=!1,this.connected=!1,this.connectedOnce=!1,this.infoReceived=!1,this.noMorePublishing=!1,this.abortReconnect=!1,this.listeners=[],this.pendingLimit=I0,this.outMsgs=0,this.inMsgs=0,this.outBytes=0,this.inBytes=0,this.options=n,this.publisher=u,this.subscriptions=new A0,this.muxSubscriptions=new h0,this.outbound=new Za,this.pongs=[],this.whyClosed="",this.pendingLimit=n.pendingLimit||this.pendingLimit,this.features=new qy({major:0,minor:0,micro:0}),this.connectPromise=null;const _=typeof n.servers=="string"?[n.servers]:n.servers;this.servers=new c0(_,{randomize:!n.noRandomize}),this.closed=Di(),this.parser=new qf(this),this.heartbeats=new u0(this,this.options.pingInterval||km,this.options.maxPingOut||x0)}resetOutbound(){this.outbound.reset();const n=this.pongs;this.pongs=[];const u=ht.errorForCode(He.Disconnect);u.stack="",n.forEach(_=>{_.reject(u)}),this.parser=new qf(this),this.infoReceived=!1}dispatchStatus(n){this.listeners.forEach(u=>{u.push(n)})}status(){const n=new hr;return this.listeners.push(n),n}prepare(){this.transport&&this.transport.discard(),this.info=void 0,this.resetOutbound();const n=Di();return n.catch(()=>{}),this.pongs.unshift(n),this.connectError=u=>{n.reject(u)},this.transport=Zy(),this.transport.closed().then(async u=>{if(this.connected=!1,!this.isClosed()){await this.disconnected(this.transport.closeError||this.lastError);return}}),n}disconnect(){this.dispatchStatus({type:$a.StaleConnection,data:""}),this.transport.disconnect()}reconnect(){return this.connected&&(this.dispatchStatus({type:$a.ClientInitiatedReconnect,data:""}),this.transport.disconnect()),Promise.resolve()}async disconnected(n){this.dispatchStatus({type:Ns.Disconnect,data:this.servers.getCurrentServer().toString()}),this.options.reconnect?await this.dialLoop().then(()=>{var u;this.dispatchStatus({type:Ns.Reconnect,data:this.servers.getCurrentServer().toString()}),((u=this.lastError)==null?void 0:u.code)===He.AuthenticationExpired&&(this.lastError=void 0)}).catch(u=>{this._close(u)}):await this._close(n)}async dial(n){const u=this.prepare();let _;try{_=Ga(this.options.timeout||2e4);const x=this.transport.connect(n,this.options);await Promise.race([x,_]),(async()=>{try{for await(const k of this.transport)this.parser.parse(k)}catch(k){console.log("reader closed",k)}})().then()}catch(x){u.reject(x)}try{await Promise.race([_,u]),_&&_.cancel(),this.connected=!0,this.connectError=void 0,this.sendSubscriptions(),this.connectedOnce=!0,this.server.didConnect=!0,this.server.reconnects=0,this.flushPending(),this.heartbeats.start()}catch(x){throw _&&_.cancel(),await this.transport.close(x),x}}async _doDial(n){const{resolve:u}=this.options,_=await n.resolve({fn:xd(),debug:this.options.debug,randomize:!this.options.noRandomize,resolve:u});let x=null;for(const k of _)try{x=null,this.dispatchStatus({type:$a.Reconnecting,data:k.toString()}),await this.dial(k);return}catch(S){x=S}throw x}dialLoop(){return this.connectPromise===null&&(this.connectPromise=this.dodialLoop(),this.connectPromise.then(()=>{}).catch(()=>{}).finally(()=>{this.connectPromise=null})),this.connectPromise}async dodialLoop(){let n;for(;;){this._closed&&this.servers.clear();const u=this.options.reconnectDelayHandler?this.options.reconnectDelayHandler():Em;let _=u;const x=this.selectServer();if(!x||this.abortReconnect)throw n||(this.lastError?this.lastError:ht.errorForCode(He.ConnectionRefused));const k=Date.now();if(x.lastConnect===0||x.lastConnect+u<=k){x.lastConnect=Date.now();try{await this._doDial(x);break}catch(S){if(n=S,!this.connectedOnce){if(this.options.waitOnFirstConnect)continue;this.servers.removeCurrentServer()}x.reconnects++;const h=this.options.maxReconnectAttempts||0;h!==-1&&x.reconnects>=h&&this.servers.removeCurrentServer()}}else _=Math.min(_,x.lastConnect+u-k),await Wa(_)}}static async connect(n,u){const _=new Lh(n,u);return await _.dialLoop(),_}static toError(n){const u=n?n.toLowerCase():"";if(u.indexOf("permissions violation")!==-1){const _=new ht(n,He.PermissionsViolation),x=n.match(/(Publish|Subscription) to "(\S+)"/);if(x){_.permissionContext={operation:x[1].toLowerCase(),subject:x[2],queue:void 0};const k=n.match(/using queue "(\S+)"/);k&&(_.permissionContext.queue=k[1])}return _}else return u.indexOf("authorization violation")!==-1?new ht(n,He.AuthorizationViolation):u.indexOf("user authentication expired")!==-1?new ht(n,He.AuthenticationExpired):u.indexOf("account authentication expired")!=-1?new ht(n,He.AccountExpired):u.indexOf("authentication timeout")!==-1?new ht(n,He.AuthenticationTimeout):new ht(n,He.ProtocolError)}processMsg(n,u){if(this.inMsgs++,this.inBytes+=u.length,!this.subscriptions.sidCounter)return;const _=this.subscriptions.get(n.sid);_&&(_.received+=1,_.callback&&_.callback(null,new Dd(n,u,this)),_.max!==void 0&&_.received>=_.max&&_.unsubscribe())}processError(n){const u=Mf(n),_=Lh.toError(u),x={type:Ns.Error,data:_.code};if(_.isPermissionError()){let k=!1;if(_.permissionContext){x.permissionContext=_.permissionContext;const S=this.subscriptions.getMux();k=(S==null?void 0:S.subject)===_.permissionContext.subject}this.subscriptions.handleError(_),this.muxSubscriptions.handleError(k,_),k&&this.subscriptions.setMux(null)}this.dispatchStatus(x),this.handleError(_)}handleError(n){n.isAuthError()?this.handleAuthError(n):n.isProtocolError()?this.lastError=n:n.isAuthTimeout()&&(this.lastError=n),n.isPermissionError()||(this.lastError=n)}handleAuthError(n){this.lastError&&n.code===this.lastError.code&&this.options.ignoreAuthErrorAbort===!1&&(this.abortReconnect=!0),this.connectError?this.connectError(n):this.disconnect()}processPing(){this.transport.send(k0)}processPong(){const n=this.pongs.shift();n&&n.resolve()}processInfo(n){const u=JSON.parse(Mf(n));this.info=u;const _=this.options&&this.options.ignoreClusterUpdates?void 0:this.servers.update(u,this.transport.isEncrypted());if(!this.infoReceived){this.features.update(qo(u.version)),this.infoReceived=!0,this.transport.isEncrypted()&&this.servers.updateTLSName();const{version:k,lang:S}=this.transport;try{const h=new E0({version:k,lang:S},this.options,u.nonce);u.headers&&(h.headers=!0,h.no_responders=!0);const N=JSON.stringify(h);this.transport.send(Ql(`CONNECT ${N}${Th}`)),this.transport.send(Zf)}catch(h){this._close(h)}}_&&this.dispatchStatus({type:Ns.Update,data:_}),(u.ldm!==void 0?u.ldm:!1)&&this.dispatchStatus({type:Ns.LDM,data:this.servers.getCurrentServer().toString()})}push(n){switch(n.kind){case qr.MSG:{const{msg:u,data:_}=n;this.processMsg(u,_);break}case qr.OK:break;case qr.ERR:this.processError(n.data);break;case qr.PING:this.processPing();break;case qr.PONG:this.processPong();break;case qr.INFO:this.processInfo(n.data);break}}sendCommand(n,...u){const _=this.outbound.length();let x;typeof n=="string"?x=Ql(n):x=n,this.outbound.fill(x,...u),_===0?queueMicrotask(()=>{this.flushPending()}):this.outbound.size()>=this.pendingLimit&&this.flushPending()}publish(n,u=bs,_){let x;if(u instanceof Uint8Array)x=u;else if(typeof u=="string")x=Ho.encode(u);else throw ht.errorForCode(He.BadPayload);let k=x.length;_=_||{},_.reply=_.reply||"";let S=bs,h=0;if(_.headers){if(this.info&&!this.info.headers)throw new ht("headers",He.ServerOptionNotAvailable);S=_.headers.encode(),h=S.length,k=x.length+h}if(this.info&&k>this.info.max_payload)throw ht.errorForCode(He.MaxPayloadExceeded);this.outBytes+=k,this.outMsgs++;let N;_.headers?(_.reply?N=`HPUB ${n} ${_.reply} ${h} ${k}\r
`:N=`HPUB ${n} ${h} ${k}\r
`,this.sendCommand(N,S,x,Dh)):(_.reply?N=`PUB ${n} ${_.reply} ${k}\r
`:N=`PUB ${n} ${k}\r
`,this.sendCommand(N,x,Dh))}request(n){return this.initMux(),this.muxSubscriptions.add(n),n}subscribe(n){return this.subscriptions.add(n),this._subunsub(n),n}_sub(n){n.queue?this.sendCommand(`SUB ${n.subject} ${n.queue} ${n.sid}\r
`):this.sendCommand(`SUB ${n.subject} ${n.sid}\r
`)}_subunsub(n){return this._sub(n),n.max&&this.unsubscribe(n,n.max),n}unsubscribe(n,u){this.unsub(n,u),(n.max===void 0||n.received>=n.max)&&this.subscriptions.cancel(n)}unsub(n,u){!n||this.isClosed()||(u?this.sendCommand(`UNSUB ${n.sid} ${u}\r
`):this.sendCommand(`UNSUB ${n.sid}\r
`),n.max=u)}resub(n,u){!n||this.isClosed()||(this.unsub(n),n.subject=u,this.subscriptions.resub(n),this._sub(n))}flush(n){return n||(n=Di()),this.pongs.push(n),this.outbound.fill(Zf),this.flushPending(),n}sendSubscriptions(){const n=[];this.subscriptions.all().forEach(u=>{const _=u;_.queue?n.push(`SUB ${_.subject} ${_.queue} ${_.sid}${Th}`):n.push(`SUB ${_.subject} ${_.sid}${Th}`)}),n.length&&this.transport.send(Ql(n.join("")))}async _close(n){this._closed||(this.whyClosed=new Error("close trace").stack||"",this.heartbeats.cancel(),this.connectError&&(this.connectError(n),this.connectError=void 0),this.muxSubscriptions.close(),this.subscriptions.close(),this.listeners.forEach(u=>{u.stop()}),this._closed=!0,await this.transport.close(n),await this.closed.resolve(n))}close(){return this._close()}isClosed(){return this._closed}drain(){const n=this.subscriptions.all(),u=[];return n.forEach(_=>{u.push(_.drain())}),Promise.all(u).then(async()=>(this.noMorePublishing=!0,await this.flush(),this.close())).catch(()=>{})}flushPending(){if(!(!this.infoReceived||!this.connected)&&this.outbound.size()){const n=this.outbound.drain();this.transport.send(n)}}initMux(){if(!this.subscriptions.getMux()){const u=this.muxSubscriptions.init(this.options.inboxPrefix),_=new Am(this,`${u}*`);_.callback=this.muxSubscriptions.dispatcher(),this.subscriptions.setMux(_),this.subscribe(_)}}selectServer(){const n=this.servers.selectServer();if(n!==void 0)return this.server=n,this.server}getServer(){return this.server}}const P0="$SRV";class Wf{constructor(n){U(this,"msg");this.msg=n}get data(){return this.msg.data}get sid(){return this.msg.sid}get subject(){return this.msg.subject}get reply(){return this.msg.reply||""}get headers(){return this.msg.headers}respond(n,u){return this.msg.respond(n,u)}respondError(n,u,_,x){var k,S;return x=x||{},x.headers=x.headers||Dn(),(k=x.headers)==null||k.set(Ch,`${n}`),(S=x.headers)==null||S.set(Ph,u),this.msg.respond(_,x)}json(n){return this.msg.json(n)}string(){return this.msg.string()}}class nc{constructor(n,u="",_=""){U(this,"subject");U(this,"queue");U(this,"srv");u!==""&&M0("service group",u);let x="";if(n instanceof hc)this.srv=n,x="";else if(n instanceof nc){const k=n;this.srv=k.srv,_===""&&k.queue!==""&&(_=k.queue),x=k.subject}else throw new Error("unknown ServiceGroup type");this.subject=this.calcSubject(x,u),this.queue=_}calcSubject(n,u=""){return u===""?n:n!==""?`${n}.${u}`:u}addEndpoint(n="",u){u=u||{subject:n};const _=typeof u=="function"?{handler:u,subject:n}:u;Kl("endpoint",n);let{subject:x,handler:k,metadata:S,queue:h}=_;x=x||n,h=h||this.queue,C0("endpoint subject",x),x=this.calcSubject(this.subject,x);const N={name:n,subject:x,queue:h,handler:k,metadata:S};return this.srv._addEndpoint(N)}addGroup(n="",u=""){return new nc(this,n,u)}}function C0(g,n){if(n==="")throw new Error(`${g} cannot be empty`);if(n.indexOf(" ")!==-1)throw new Error(`${g} cannot contain spaces: '${n}'`);const u=n.split(".");u.forEach((_,x)=>{if(_===">"&&x!==u.length-1)throw new Error(`${g} cannot have internal '>': '${n}'`)})}function M0(g,n){if(n.indexOf(" ")!==-1)throw new Error(`${g} cannot contain spaces: '${n}'`);n.split(".").forEach(_=>{if(_===">")throw new Error(`${g} name cannot contain internal '>': '${n}'`)})}class hc{constructor(n,u={name:"",version:""}){U(this,"nc");U(this,"_id");U(this,"config");U(this,"handlers");U(this,"internal");U(this,"_stopped");U(this,"_done");U(this,"started");this.nc=n,this.config=Object.assign({},u),this.config.queue||(this.config.queue="q"),Kl("name",this.config.name),Kl("queue",this.config.queue),qo(this.config.version),this._id=Zo.next(),this.internal=[],this._done=Di(),this._stopped=!1,this.handlers=[],this.started=new Date().toISOString(),this.reset(),this.nc.closed().then(()=>{this.close().catch()}).catch(_=>{this.close(_).catch()})}static controlSubject(n,u="",_="",x){const k=x??P0;return u===""&&_===""?`${k}.${n}`:(Kl("control subject name",u),_!==""?(Kl("control subject id",_),`${k}.${n}.${u}.${_}`):`${k}.${n}.${u}`)}get subjects(){return this.handlers.filter(n=>n.internal===!1).map(n=>n.subject)}get id(){return this._id}get name(){return this.config.name}get description(){return this.config.description??""}get version(){return this.config.version}get metadata(){return this.config.metadata}errorToHeader(n){const u=Dn();if(n instanceof Mh){const _=n;u.set(Ph,_.message),u.set(Ch,`${_.code}`)}else u.set(Ph,n.message),u.set(Ch,"500");return u}setupHandler(n,u=!1){const _=u?"":n.queue?n.queue:this.config.queue,{name:x,subject:k,handler:S}=n,h=n;h.internal=u,u&&this.internal.push(h),h.stats=new z0(x,k,_),h.queue=_;const N=S?(q,ne)=>{if(q){this.close(q);return}const J=Date.now();try{S(q,new Wf(ne))}catch(G){h.stats.countError(G),ne==null||ne.respond(bs,{headers:this.errorToHeader(G)})}finally{h.stats.countLatency(J)}}:void 0;return h.sub=this.nc.subscribe(k,{callback:N,queue:_}),h.sub.closed.then(()=>{this._stopped||this.close(new Error(`required subscription ${n.subject} stopped`)).catch()}).catch(q=>{if(!this._stopped){const ne=new Error(`required subscription ${n.subject} errored: ${q.message}`);ne.stack=q.stack,this.close(ne).catch()}}),h}info(){return{type:ec.INFO,name:this.name,id:this.id,version:this.version,description:this.description,metadata:this.metadata,endpoints:this.endpoints()}}endpoints(){return this.handlers.map(n=>{const{subject:u,metadata:_,name:x,queue:k}=n;return{subject:u,metadata:_,name:x,queue_group:k}})}async stats(){const n=[];for(const u of this.handlers){if(typeof this.config.statsHandler=="function")try{u.stats.data=await this.config.statsHandler(u)}catch(_){u.stats.countError(_)}n.push(u.stats.stats(u.qi))}return{type:ec.STATS,name:this.name,id:this.id,version:this.version,started:this.started,metadata:this.metadata,endpoints:n}}addInternalHandler(n,u){const _=`${n}`.toUpperCase();this._doAddInternalHandler(`${_}-all`,n,u),this._doAddInternalHandler(`${_}-kind`,n,u,this.name),this._doAddInternalHandler(`${_}`,n,u,this.name,this.id)}_doAddInternalHandler(n,u,_,x="",k=""){const S={};S.name=n,S.subject=hc.controlSubject(u,x,k),S.handler=_,this.setupHandler(S,!0)}start(){const n=Vs(),u=(S,h)=>S?(this.close(S),Promise.reject(S)):this.stats().then(N=>(h==null||h.respond(n.encode(N)),Promise.resolve())),_=(S,h)=>S?(this.close(S),Promise.reject(S)):(h==null||h.respond(n.encode(this.info())),Promise.resolve()),x=n.encode(this.ping()),k=(S,h)=>S?(this.close(S).then().catch(),Promise.reject(S)):(h.respond(x),Promise.resolve());return this.addInternalHandler(ro.PING,k),this.addInternalHandler(ro.STATS,u),this.addInternalHandler(ro.INFO,_),this.handlers.forEach(S=>{const{subject:h}=S;typeof h=="string"&&S.handler!==null&&this.setupHandler(S)}),Promise.resolve(this)}close(n){if(this._stopped)return this._done;this._stopped=!0;let u=[];return this.nc.isClosed()||(u=this.handlers.concat(this.internal).map(_=>_.sub.drain())),Promise.allSettled(u).then(()=>{this._done.resolve(n||null)}),this._done}get stopped(){return this._done}get isStopped(){return this._stopped}stop(n){return this.close(n)}ping(){return{type:ec.PING,name:this.name,id:this.id,version:this.version,metadata:this.metadata}}reset(){if(this.started=new Date().toISOString(),this.handlers)for(const n of this.handlers)n.stats.reset(n.qi)}addGroup(n,u){return new nc(this,n,u)}addEndpoint(n,u){return new nc(this).addEndpoint(n,u)}_addEndpoint(n){const u=new hr;u.noIterator=typeof n.handler=="function",u.noIterator||(n.handler=(x,k)=>{x?this.stop(x).catch():u.push(new Wf(k))},u.iterClosed.then(()=>{this.close().catch()}));const _=this.setupHandler(n,!1);return _.qi=u,this.handlers.push(_),u}}class z0{constructor(n,u,_=""){U(this,"name");U(this,"subject");U(this,"average_processing_time");U(this,"num_requests");U(this,"processing_time");U(this,"num_errors");U(this,"last_error");U(this,"data");U(this,"metadata");U(this,"queue");this.name=n,this.subject=u,this.average_processing_time=0,this.num_errors=0,this.num_requests=0,this.processing_time=0,this.queue=_}reset(n){this.num_requests=0,this.processing_time=0,this.average_processing_time=0,this.num_errors=0,this.last_error=void 0,this.data=void 0;const u=n;u&&(u.time=0,u.processed=0)}countLatency(n){this.num_requests++,this.processing_time+=Bi(Date.now()-n),this.average_processing_time=Math.round(this.processing_time/this.num_requests)}countError(n){this.num_errors++,this.last_error=n.message}_stats(){const{name:n,subject:u,average_processing_time:_,num_errors:x,num_requests:k,processing_time:S,last_error:h,data:N,queue:q}=this;return{name:n,subject:u,average_processing_time:_,num_errors:x,num_requests:k,processing_time:S,last_error:h,data:N,queue_group:q}}stats(n){const u=n;return(u==null?void 0:u.noIterator)===!1&&(this.processing_time=u.time,this.num_requests=u.processed,this.average_processing_time=this.processing_time>0&&this.num_requests>0?this.processing_time/this.num_requests:0),this._stats()}}class D0{constructor(n,u={strategy:Us.JitterTimer,maxWait:2e3},_){U(this,"nc");U(this,"prefix");U(this,"opts");this.nc=n,this.prefix=_,this.opts=u}ping(n="",u=""){return this.q(ro.PING,n,u)}stats(n="",u=""){return this.q(ro.STATS,n,u)}info(n="",u=""){return this.q(ro.INFO,n,u)}async q(n,u="",_=""){const x=new hr,k=Vs(),S=hc.controlSubject(n,u,_,this.prefix),h=await this.nc.requestMany(S,bs,this.opts);return(async()=>{for await(const N of h)try{const q=k.decode(N.data);x.push(q)}catch(q){x.push(()=>{x.stop(q)})}x.push(()=>{x.stop()})})().catch(N=>{x.stop(N)}),x}}function Pm(){return{key:{encode(g){return g},decode(g){return g}},value:{encode(g){return g},decode(g){return g}}}}function L0(){return{replicas:1,history:1,timeout:2e3,max_bytes:-1,maxValueSize:-1,codec:Pm(),storage:gd.File}}const Rh="KV-Operation",Xf="$KV",R0=/^[-/=.\w]+$/,O0=/^[-/=.>*\w]+$/,F0=/^[-\w]+$/;function B0(g){if(g.startsWith(".")||g.endsWith(".")||!R0.test(g))throw new Error(`invalid key: ${g}`)}function j0(g){if(g.startsWith(".")||g.endsWith(".")||!O0.test(g))throw new Error(`invalid key: ${g}`)}function N0(g){if(g.startsWith(".")||g.endsWith("."))throw new Error(`invalid key: ${g}`);const n=g.split(".");let u=!1;for(let _=0;_<n.length;_++)switch(n[_]){case"*":u=!0;break;case">":if(_!==n.length-1)throw new Error(`invalid key: ${g}`);u=!0;break}return u}function kh(g){if(!F0.test(g))throw new Error(`invalid bucket name: ${g}`)}var rn;(function(g){g.MsgIdHdr="Nats-Msg-Id",g.ExpectedStreamHdr="Nats-Expected-Stream",g.ExpectedLastSeqHdr="Nats-Expected-Last-Sequence",g.ExpectedLastMsgIdHdr="Nats-Expected-Last-Msg-Id",g.ExpectedLastSubjectSequenceHdr="Nats-Expected-Last-Subject-Sequence"})(rn||(rn={}));class oc{constructor(n,u,_){U(this,"js");U(this,"jsm");U(this,"stream");U(this,"bucket");U(this,"direct");U(this,"codec");U(this,"prefix");U(this,"editPrefix");U(this,"useJsPrefix");U(this,"_prefixLen");U(this,"validateKey",B0);U(this,"validateSearchKey",j0);U(this,"hasWildcards",N0);kh(n),this.js=u,this.jsm=_,this.bucket=n,this.prefix=Xf,this.editPrefix="",this.useJsPrefix=!1,this._prefixLen=0}static async create(n,u,_={}){kh(u);const x=await n.jetstreamManager(),k=new oc(u,n,x);return await k.init(_),k}static async bind(n,u,_={}){const x=await n.jetstreamManager(),k={config:{allow_direct:_.allow_direct}};kh(u);const S=new oc(u,n,x);return k.config.name=_.streamName??S.bucketName(),Object.assign(S,k),S.stream=k.config.name,S.codec=_.codec||Pm(),S.direct=k.config.allow_direct??!1,S.initializePrefixes(k),S}async init(n={}){const u=Object.assign(L0(),n);this.codec=u.codec;const _={};this.stream=_.name=n.streamName??this.bucketName(),_.retention=_d.Limits,_.max_msgs_per_subject=u.history,u.maxBucketSize&&(u.max_bytes=u.maxBucketSize),u.max_bytes&&(_.max_bytes=u.max_bytes),_.max_msg_size=u.maxValueSize,_.storage=u.storage;const x=n.placementCluster??"";if(x&&(n.placement={},n.placement.cluster=x,n.placement.tags=[]),n.placement&&(_.placement=n.placement),n.republish&&(_.republish=n.republish),n.description&&(_.description=n.description),n.mirror){const J=Object.assign({},n.mirror);J.name.startsWith(gs)||(J.name=`${gs}${J.name}`),_.mirror=J,_.mirror_direct=!0}else if(n.sources){const J=n.sources.map(G=>{const ve=Object.assign({},G),Ee=ve.name.startsWith(gs)?ve.name.substring(gs.length):ve.name;return ve.name.startsWith(gs)||(ve.name=`${gs}${ve.name}`),!G.external&&Ee!==this.bucket&&(ve.subject_transforms=[{src:`$KV.${Ee}.>`,dest:`$KV.${this.bucket}.>`}]),ve});_.sources=J,_.subjects=[this.subjectForBucket()]}else _.subjects=[this.subjectForBucket()];n.metadata&&(_.metadata=n.metadata),typeof n.compression=="boolean"&&(_.compression=n.compression?oo.S2:oo.None);const k=this.js.nc,S=k.getServerVersion(),h=S?yd(S,qo("2.7.2"))>=0:!1;_.discard=h?sc.New:sc.Old;const{ok:N,min:q}=k.features.get(ii.JS_ALLOW_DIRECT);if(!N&&n.allow_direct===!0){const J=S?`${S.major}.${S.minor}.${S.micro}`:"unknown";return Promise.reject(new Error(`allow_direct is not available on server version ${J} - requires ${q}`))}n.allow_direct=typeof n.allow_direct=="boolean"?n.allow_direct:N,_.allow_direct=n.allow_direct,this.direct=_.allow_direct,_.num_replicas=u.replicas,u.ttl&&(_.max_age=Bi(u.ttl)),_.allow_rollup_hdrs=!0;let ne;try{ne=await this.jsm.streams.info(_.name),!ne.config.allow_direct&&this.direct===!0&&(this.direct=!1)}catch(J){if(J.message==="stream not found")ne=await this.jsm.streams.add(_);else throw J}this.initializePrefixes(ne)}initializePrefixes(n){this._prefixLen=0,this.prefix=`$KV.${this.bucket}`,this.useJsPrefix=this.js.apiPrefix!=="$JS.API";const{mirror:u}=n.config;if(u){let _=u.name;if(_.startsWith(gs)&&(_=_.substring(gs.length)),u.external&&u.external.api!==""){const x=u.name.substring(gs.length);this.useJsPrefix=!1,this.prefix=`$KV.${x}`,this.editPrefix=`${u.external.api}.$KV.${_}`}else this.editPrefix=this.prefix}}bucketName(){return this.stream??`${gs}${this.bucket}`}subjectForBucket(){return`${this.prefix}.${this.bucket}.>`}subjectForKey(n,u=!1){const _=[];return u?(this.useJsPrefix&&_.push(this.js.apiPrefix),this.editPrefix!==""?_.push(this.editPrefix):_.push(this.prefix)):this.prefix&&_.push(this.prefix),_.push(n),_.join(".")}fullKeyName(n){return this.prefix!==""?`${this.prefix}.${n}`:`${Xf}.${this.bucket}.${n}`}get prefixLen(){return this._prefixLen===0&&(this._prefixLen=this.prefix.length+1),this._prefixLen}encodeKey(n){const u=[];for(const _ of n.split("."))switch(_){case">":case"*":u.push(_);break;default:u.push(this.codec.key.encode(_));break}return u.join(".")}decodeKey(n){const u=[];for(const _ of n.split("."))switch(_){case">":case"*":u.push(_);break;default:u.push(this.codec.key.decode(_));break}return u.join(".")}close(){return Promise.resolve()}dataLen(n,u){const _=u&&u.get(Gr.MessageSizeHdr)||"";return _!==""?parseInt(_,10):n.length}smToEntry(n){return new tx(this.bucket,this.prefixLen,n)}jmToEntry(n){const u=this.decodeKey(n.subject.substring(this.prefixLen));return new ix(this.bucket,u,n)}async create(n,u){var k;let _;try{const S=await this.put(n,u,{previousSeq:0});return Promise.resolve(S)}catch(S){if(_=S,((k=S==null?void 0:S.api_error)==null?void 0:k.err_code)!==10071)return Promise.reject(S)}let x=0;try{const S=await this.get(n);return(S==null?void 0:S.operation)==="DEL"||(S==null?void 0:S.operation)==="PURGE"?(x=S!==null?S.revision:0,this.update(n,u,x)):Promise.reject(_)}catch(S){return Promise.reject(S)}}update(n,u,_){if(_<=0)throw new Error("version must be greater than 0");return this.put(n,u,{previousSeq:_})}async put(n,u,_={}){var S,h;const x=this.encodeKey(n);this.validateKey(x);const k={};if(_.previousSeq!==void 0){const N=Dn();k.headers=N,N.set(rn.ExpectedLastSubjectSequenceHdr,`${_.previousSeq}`)}try{return(await this.js.publish(this.subjectForKey(x,!0),u,k)).seq}catch(N){const q=N;return q.isJetStreamError()?(q.message=(S=q.api_error)==null?void 0:S.description,q.code=`${(h=q.api_error)==null?void 0:h.code}`,Promise.reject(q)):Promise.reject(N)}}async get(n,u){const _=this.encodeKey(n);this.validateKey(_);let x={last_by_subj:this.subjectForKey(_)};u&&u.revision>0&&(x={seq:u.revision});let k;try{this.direct?k=await this.jsm.direct.getMessage(this.bucketName(),x):k=await this.jsm.streams.getMessage(this.bucketName(),x);const S=this.smToEntry(k);return S.key!==_?null:S}catch(S){if(S.code===He.JetStream404NoMessages)return null;throw S}}purge(n,u){return this._deleteOrPurge(n,"PURGE",u)}delete(n,u){return this._deleteOrPurge(n,"DEL",u)}async purgeDeletes(n=30*60*1e3){const u=Di(),_=[],x=await this.watch({key:">",initializedFn:()=>{u.resolve()}});(async()=>{for await(const N of x)(N.operation==="DEL"||N.operation==="PURGE")&&_.push(N)})().then(),await u,x.stop();const k=Date.now()-n,S=_.map(N=>{const q=this.subjectForKey(N.key);return N.created.getTime()>=k?this.jsm.streams.purge(this.stream,{filter:q,keep:1}):this.jsm.streams.purge(this.stream,{filter:q,keep:0})}),h=await Promise.all(S);return h.unshift({success:!0,purged:0}),h.reduce((N,q)=>(N.purged+=q.purged,N))}async _deleteOrPurge(n,u,_){if(!this.hasWildcards(n))return this._doDeleteOrPurge(n,u,_);const x=await this.keys(n),k=[];for await(const S of x)k.push(this._doDeleteOrPurge(S,u)),k.length===100&&(await Promise.all(k),k.length=0);k.length>0&&await Promise.all(k)}async _doDeleteOrPurge(n,u,_){const x=this.encodeKey(n);this.validateKey(x);const k=Dn();k.set(Rh,u),u==="PURGE"&&k.set(Gr.RollupHdr,Gr.RollupValueSubject),_!=null&&_.previousSeq&&k.set(rn.ExpectedLastSubjectSequenceHdr,`${_.previousSeq}`),await this.js.publish(this.subjectForKey(x,!0),bs,{headers:k})}_buildCC(n,u,_={}){let k=(Array.isArray(n)?n:[n]).map(N=>{const q=this.encodeKey(N);return this.validateSearchKey(N),this.fullKeyName(q)}),S=Hi.LastPerSubject;u===js.AllHistory&&(S=Hi.All),u===js.UpdatesOnly&&(S=Hi.New);let h;return k.length===1&&(h=k[0],k=void 0),Object.assign({deliver_policy:S,ack_policy:cr.None,filter_subjects:k,filter_subject:h,flow_control:!0,idle_heartbeat:Bi(5*1e3)},_)}remove(n){return this.purge(n)}async history(n={}){const u=n.key??">",_=new hr,x={};x.headers_only=n.headers_only||!1;let k;k=()=>{_.stop()};let S=0;const h=this._buildCC(u,js.AllHistory,x),N=h.filter_subject,q=zn(h);q.bindStream(this.stream),q.orderedConsumer(),q.callback((J,G)=>{if(J){_.stop(J);return}if(G){const ve=this.jmToEntry(G);_.push(ve),_.received++,(k&&S>0&&_.received>=S||G.info.pending===0)&&(_.push(k),k=void 0)}});const ne=await this.js.subscribe(N,q);if(k){const{info:{last:J}}=ne,G=J.num_pending+J.delivered.consumer_seq;if(G===0||_.received>=G)try{k()}catch(ve){_.stop(ve)}finally{k=void 0}else S=G}return _._data=ne,_.iterClosed.then(()=>{ne.unsubscribe()}),ne.closed.then(()=>{_.stop()}).catch(J=>{_.stop(J)}),_}canSetWatcherName(){const u=this.js.nc,{ok:_}=u.features.get(ii.JS_NEW_CONSUMER_CREATE_API);return _}async watch(n={}){const u=n.key??">",_=new hr,x={};x.headers_only=n.headers_only||!1;let k=js.LastValue;n.include===js.AllHistory?k=js.AllHistory:n.include===js.UpdatesOnly&&(k=js.UpdatesOnly);const S=n.ignoreDeletes===!0;let h=n.initializedFn,N=0;const q=this._buildCC(u,k,x),ne=q.filter_subject,J=zn(q);this.canSetWatcherName()&&J.consumerName(Zo.next()),J.bindStream(this.stream),n.resumeFromRevision&&n.resumeFromRevision>0&&J.startSequence(n.resumeFromRevision),J.orderedConsumer(),J.callback((ve,Ee)=>{if(ve){_.stop(ve);return}if(Ee){const $e=this.jmToEntry(Ee);if(S&&$e.operation==="DEL")return;_.push($e),_.received++,h&&(N>0&&_.received>=N||Ee.info.pending===0)&&(_.push(h),h=void 0)}});const G=await this.js.subscribe(ne,J);if(h){const{info:{last:ve}}=G,Ee=ve.num_pending+ve.delivered.consumer_seq;if(Ee===0||_.received>=Ee)try{h()}catch($e){_.stop($e)}finally{h=void 0}else N=Ee}return _._data=G,_.iterClosed.then(()=>{G.unsubscribe()}),G.closed.then(()=>{_.stop()}).catch(ve=>{_.stop(ve)}),_}async keys(n=">"){const u=new hr,_=this._buildCC(n,js.LastValue,{headers_only:!0}),x=Array.isArray(n)?">":_.filter_subject,k=zn(_);k.bindStream(this.stream),k.orderedConsumer();const S=await this.js.subscribe(x,k);return(async()=>{var N;for await(const q of S){const ne=(N=q.headers)==null?void 0:N.get(Rh);if(ne!=="DEL"&&ne!=="PURGE"){const J=this.decodeKey(q.subject.substring(this.prefixLen));u.push(J)}q.info.pending===0&&S.unsubscribe()}})().then(()=>{u.stop()}).catch(N=>{u.stop(N)}),S.info.last.num_pending===0&&S.unsubscribe(),u}purgeBucket(n){return this.jsm.streams.purge(this.bucketName(),n)}destroy(){return this.jsm.streams.delete(this.bucketName())}async status(){var k;const u=((k=this.js.nc.info)==null?void 0:k.cluster)??"",_=this.bucketName(),x=await this.jsm.streams.info(_);return new Cm(x,u)}}class Cm{constructor(n,u=""){U(this,"si");U(this,"cluster");this.si=n,this.cluster=u}get bucket(){return this.si.config.name.startsWith(gs)?this.si.config.name.substring(gs.length):this.si.config.name}get values(){return this.si.state.messages}get history(){return this.si.config.max_msgs_per_subject}get ttl(){return zd(this.si.config.max_age)}get bucket_location(){return this.cluster}get backingStore(){return this.si.config.storage}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get description(){return this.si.config.description??""}get maxBucketSize(){return this.si.config.max_bytes}get maxValueSize(){return this.si.config.max_msg_size}get max_bytes(){return this.si.config.max_bytes}get placement(){return this.si.config.placement||{cluster:"",tags:[]}}get placementCluster(){var n;return((n=this.si.config.placement)==null?void 0:n.cluster)??""}get republish(){return this.si.config.republish??{src:"",dest:""}}get streamInfo(){return this.si}get size(){return this.si.state.bytes}get metadata(){return this.si.config.metadata??{}}get compression(){return this.si.config.compression?this.si.config.compression!==oo.None:!1}}const Od="OBJ_",Jf="SHA-256=";function $0(g){return kh(g),`${Od}${g}`}function U0(g){return g.startsWith(Od)?g.substring(4):g}class wd{constructor(n){U(this,"si");U(this,"backingStore");this.si=n,this.backingStore="JetStream"}get bucket(){return U0(this.si.config.name)}get description(){return this.si.config.description??""}get ttl(){return this.si.config.max_age}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get sealed(){return this.si.config.sealed}get size(){return this.si.state.bytes}get streamInfo(){return this.si}get metadata(){return this.si.config.metadata}get compression(){return this.si.config.compression?this.si.config.compression!==oo.None:!1}}function bh(g){if(g===void 0)return;const{domain:n}=g;if(n===void 0)return g;const u=Object.assign({},g);if(delete u.domain,n==="")return u;if(u.external)throw new Error("domain and external are both set");return u.external={api:`$JS.${n}.API`},u}var Cs;(function(g){g[g.Unset=-1]="Unset",g[g.Consume=0]="Consume",g[g.Fetch=1]="Fetch"})(Cs||(Cs={}));var Cn;(function(g){g.HeartbeatsMissed="heartbeats_missed",g.ConsumerNotFound="consumer_not_found",g.StreamNotFound="stream_not_found",g.ConsumerDeleted="consumer_deleted",g.OrderedConsumerRecreated="ordered_consumer_recreated"})(Cn||(Cn={}));var qa;(function(g){g.DebugEvent="debug",g.Discard="discard",g.Reset="reset",g.Next="next"})(qa||(qa={}));const Kf=Uint8Array.of(43,65,67,75),V0=Uint8Array.of(45,78,65,75),Jl=Uint8Array.of(43,87,80,73),q0=Uint8Array.of(43,78,88,84),G0=Uint8Array.of(43,84,69,82,77),H0=Uint8Array.of(32);function ac(g,n=5e3){return new cx(g,n)}class ld extends hr{constructor(u,_,x=!1){super();U(this,"consumer");U(this,"opts");U(this,"sub");U(this,"monitor");U(this,"pending");U(this,"inbox");U(this,"refilling");U(this,"pong");U(this,"callback");U(this,"timeout");U(this,"cleanupHandler");U(this,"listeners");U(this,"statusIterator");U(this,"forOrderedConsumer");U(this,"resetHandler");U(this,"abortOnMissingResource");U(this,"bind");this.consumer=u;const k=_;this.opts=this.parseOptions(_,x),this.callback=k.callback||null,this.noIterator=typeof this.callback=="function",this.monitor=null,this.pong=null,this.pending={msgs:0,bytes:0,requests:0},this.refilling=x,this.timeout=null,this.inbox=nn(u.api.nc.options.inboxPrefix),this.listeners=[],this.forOrderedConsumer=!1,this.abortOnMissingResource=k.abort_on_missing_resource===!0,this.bind=k.bind===!0,this.start()}start(){const{max_messages:u,max_bytes:_,idle_heartbeat:x,threshold_bytes:k,threshold_messages:S}=this.opts;this.closed().then(N=>{if(this.cleanupHandler)try{this.cleanupHandler(N)}catch{}});const{sub:h}=this;h&&h.unsubscribe(),this.sub=this.consumer.api.nc.subscribe(this.inbox,{callback:(N,q)=>{var J,G,ve,Ee;if(N){this.stop(N);return}if((J=this.monitor)==null||J.work(),q.subject===this.inbox){if(md(q))return;const $e=(G=q.headers)==null?void 0:G.code,_t=((Ee=(ve=q.headers)==null?void 0:ve.description)==null?void 0:Ee.toLowerCase())||"unknown",{msgsLeft:Tt,bytesLeft:xt}=this.parseDiscard(q.headers);if(Tt>0||xt>0)this.pending.msgs-=Tt,this.pending.bytes-=xt,this.pending.requests--,this.notify(qa.Discard,{msgsLeft:Tt,bytesLeft:xt});else if($e===400){this.stop(new ht(_t,`${$e}`));return}else if($e===409&&_t==="consumer deleted"){if(this.notify(Cn.ConsumerDeleted,`${$e} ${_t}`),!this.refilling||this.abortOnMissingResource){const Ct=new ht(_t,`${$e}`);this.stop(Ct);return}}else this.notify(qa.DebugEvent,`${$e} ${_t}`)}else this._push(ac(q,this.consumer.api.timeout)),this.received++,this.pending.msgs&&this.pending.msgs--,this.pending.bytes&&(this.pending.bytes-=q.size());if(this.pending.msgs===0&&this.pending.bytes===0&&(this.pending.requests=0),this.refilling){if(u&&this.pending.msgs<=S||_&&this.pending.bytes<=k){const $e=this.pullOptions();this.pull($e)}}else this.pending.requests===0&&this._push(()=>{this.stop()})}}),this.sub.closed.then(()=>{this.sub.draining&&this._push(()=>{this.stop()})}),x&&(this.monitor=new Ld(x,N=>(this.notify(Cn.HeartbeatsMissed,N),this.resetPending().then(()=>{}).catch(()=>{}),!1),{maxOut:2})),(async()=>{var q;const N=this.consumer.api.nc.status();this.statusIterator=N;for await(const ne of N)switch(ne.type){case Ns.Disconnect:(q=this.monitor)==null||q.cancel();break;case Ns.Reconnect:this.resetPending().then(J=>{var G;J&&((G=this.monitor)==null||G.restart())}).catch(()=>{});break}})(),this.pull(this.pullOptions())}_push(u){if(!this.callback)super.push(u);else{const _=typeof u=="function"?u:null;try{_?_():this.callback(u)}catch(x){this.stop(x)}}}notify(u,_){this.listeners.length>0&&this.listeners.forEach(x=>{x.done||x.push({type:u,data:_})})}resetPending(){return this.bind?this.resetPendingNoInfo():this.resetPendingWithInfo()}resetPendingNoInfo(){return this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),Promise.resolve(!0)}async resetPendingWithInfo(){let u=0,_=0;const x=Md();let k=0;for(;;){if(this.done)return!1;if(this.consumer.api.nc.isClosed())return console.error("aborting resetPending - connection is closed"),!1;try{return await this.consumer.info(),u=0,this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),!0}catch(S){if(S.message==="stream not found"){if(_++,this.notify(Cn.StreamNotFound,_),!this.refilling||this.abortOnMissingResource)return this.stop(S),!1}else if(S.message==="consumer not found"){if(u++,this.notify(Cn.ConsumerNotFound,u),this.resetHandler)try{this.resetHandler()}catch{}if(!this.refilling||this.abortOnMissingResource)return this.stop(S),!1;if(this.forOrderedConsumer)return!1}else u=0,_=0;const h=x.backoff(k),N=Wa(h);await Promise.race([N,this.consumer.api.nc.closed()]),N.cancel(),k++}}}pull(u){this.pending.bytes+=u.max_bytes??0,this.pending.msgs+=u.batch??0,this.pending.requests++;const _=this.consumer.api.nc;this._push(()=>{_.publish(`${this.consumer.api.prefix}.CONSUMER.MSG.NEXT.${this.consumer.stream}.${this.consumer.name}`,this.consumer.api.jc.encode(u),{reply:this.inbox}),this.notify(qa.Next,u)})}pullOptions(){const u=this.opts.max_messages-this.pending.msgs,_=this.opts.max_bytes-this.pending.bytes,x=Bi(this.opts.idle_heartbeat),k=Bi(this.opts.expires);return{batch:u,max_bytes:_,idle_heartbeat:x,expires:k}}parseDiscard(u){const _={msgsLeft:0,bytesLeft:0},x=u==null?void 0:u.get(Gr.PendingMessagesHdr);x&&(_.msgsLeft=parseInt(x));const k=u==null?void 0:u.get(Gr.PendingBytesHdr);return k&&(_.bytesLeft=parseInt(k)),_}trackTimeout(u){this.timeout=u}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}clearTimers(){var u,_;(u=this.monitor)==null||u.cancel(),this.monitor=null,(_=this.timeout)==null||_.cancel(),this.timeout=null}setCleanupHandler(u){this.cleanupHandler=u}stop(u){var _,x;this.done||((_=this.sub)==null||_.unsubscribe(),this.clearTimers(),(x=this.statusIterator)==null||x.stop(),this._push(()=>{super.stop(u),this.listeners.forEach(k=>{k.stop()})}))}parseOptions(u,_=!1){const x=u||{};if(x.max_messages=x.max_messages||0,x.max_bytes=x.max_bytes||0,x.max_messages!==0&&x.max_bytes!==0)throw new Error("only specify one of max_messages or max_bytes");if(x.max_messages===0&&(x.max_messages=100),x.expires=x.expires||3e4,x.expires<1e3)throw new Error("expires should be at least 1000ms");if(x.idle_heartbeat=x.idle_heartbeat||x.expires/2,x.idle_heartbeat=x.idle_heartbeat>3e4?3e4:x.idle_heartbeat,_){const k=Math.round(x.max_messages*.75)||1;x.threshold_messages=x.threshold_messages||k;const S=Math.round(x.max_bytes*.75)||1;x.threshold_bytes=x.threshold_bytes||S}return x}status(){const u=new hr;return this.listeners.push(u),Promise.resolve(u)}}class Z0 extends hr{constructor(){super();U(this,"src");U(this,"listeners");this.listeners=[]}setSource(u){this.src&&(this.src.resetHandler=void 0,this.src.setCleanupHandler(),this.src.stop()),this.src=u,this.src.setCleanupHandler(_=>{this.stop(_||void 0)}),(async()=>{const _=await this.src.status();for await(const x of _)this.notify(x.type,x.data)})().catch(()=>{})}notify(u,_){this.listeners.length>0&&this.listeners.forEach(x=>{x.done||x.push({type:u,data:_})})}stop(u){var _;this.done||((_=this.src)==null||_.stop(u),super.stop(u),this.listeners.forEach(x=>{x.stop()}))}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}status(){const u=new hr;return this.listeners.push(u),Promise.resolve(u)}}class Mm{constructor(n,u){U(this,"api");U(this,"_info");U(this,"stream");U(this,"name");this.api=n,this._info=u,this.stream=u.stream_name,this.name=u.name}consume(n={max_messages:100,expires:3e4}){return Promise.resolve(new ld(this,n,!0))}fetch(n={max_messages:100,expires:3e4}){const u=new ld(this,n,!1),_=Math.round(u.opts.expires*1.05),x=Ga(_);return u.closed().catch(()=>{}).finally(()=>{x.cancel()}),x.catch(()=>{u.close().catch()}),u.trackTimeout(x),Promise.resolve(u)}next(n={expires:3e4}){const u=Di(),_=n;_.max_messages=1;const x=new ld(this,_,!1),k=Math.round(x.opts.expires*1.05);k>=6e4&&(async()=>{for await(const h of await x.status())if(h.type===Cn.HeartbeatsMissed&&h.data>=2){u.reject(new Error("consumer missed heartbeats"));break}})().catch(),(async()=>{for await(const h of x){u.resolve(h);break}})().catch(()=>{});const S=Ga(k);return x.closed().then(h=>{h?u.reject(h):u.resolve(null)}).catch(h=>{u.reject(h)}).finally(()=>{S.cancel()}),S.catch(h=>{u.resolve(null),x.close().catch()}),x.trackTimeout(S),u}delete(){const{stream_name:n,name:u}=this._info;return this.api.delete(n,u)}info(n=!1){if(n)return Promise.resolve(this._info);const{stream_name:u,name:_}=this._info;return this.api.info(u,_).then(x=>(this._info=x,this._info))}}class W0{constructor(n,u,_={}){U(this,"api");U(this,"consumerOpts");U(this,"consumer");U(this,"opts");U(this,"cursor");U(this,"stream");U(this,"namePrefix");U(this,"serial");U(this,"currentConsumer");U(this,"userCallback");U(this,"iter");U(this,"type");U(this,"startSeq");this.api=n,this.stream=u,this.cursor={stream_seq:1,deliver_seq:0},this.namePrefix=Zo.next(),typeof _.name_prefix=="string"&&(jh("name_prefix",_.name_prefix),this.namePrefix=_.name_prefix+this.namePrefix),this.serial=0,this.currentConsumer=null,this.userCallback=null,this.iter=null,this.type=Cs.Unset,this.consumerOpts=_,this.startSeq=this.consumerOpts.opt_start_seq||0,this.cursor.stream_seq=this.startSeq>0?this.startSeq-1:0}getConsumerOpts(n){this.serial++;const u=`${this.namePrefix}_${this.serial}`;n=n===0?1:n;const _={name:u,deliver_policy:Hi.StartSequence,opt_start_seq:n,ack_policy:cr.None,inactive_threshold:Bi(5*60*1e3),num_replicas:1};return this.consumerOpts.headers_only===!0&&(_.headers_only=!0),Array.isArray(this.consumerOpts.filterSubjects)&&(_.filter_subjects=this.consumerOpts.filterSubjects),typeof this.consumerOpts.filterSubjects=="string"&&(_.filter_subject=this.consumerOpts.filterSubjects),this.consumerOpts.replay_policy&&(_.replay_policy=this.consumerOpts.replay_policy),n===this.startSeq+1&&(_.deliver_policy=this.consumerOpts.deliver_policy||Hi.StartSequence,(this.consumerOpts.deliver_policy===Hi.LastPerSubject||this.consumerOpts.deliver_policy===Hi.New||this.consumerOpts.deliver_policy===Hi.Last)&&(delete _.opt_start_seq,_.deliver_policy=this.consumerOpts.deliver_policy),_.deliver_policy===Hi.LastPerSubject&&typeof _.filter_subjects>"u"&&typeof _.filter_subject>"u"&&(_.filter_subject=">"),this.consumerOpts.opt_start_time&&(delete _.opt_start_seq,_.deliver_policy=Hi.StartTime,_.opt_start_time=this.consumerOpts.opt_start_time),this.consumerOpts.inactive_threshold&&(_.inactive_threshold=Bi(this.consumerOpts.inactive_threshold))),_}async resetConsumer(n=0){var k,S,h,N;(k=this.consumer)==null||k.delete().catch(()=>{}),n=n===0?1:n,this.cursor.deliver_seq=0;const u=this.getConsumerOpts(n);u.max_deliver=1,u.mem_storage=!0;const _=Md();let x;for(let q=0;;q++)try{x=await this.api.add(this.stream,u),(S=this.iter)==null||S.notify(Cn.OrderedConsumerRecreated,x.name);break}catch(ne){if(ne.message==="stream not found"&&((h=this.iter)==null||h.notify(Cn.StreamNotFound,q),this.type===Cs.Fetch||this.opts.abort_on_missing_resource===!0))return(N=this.iter)==null||N.stop(ne),Promise.reject(ne);if(n===0&&q>=30)throw ne;await Wa(_.backoff(q+1))}return x}internalHandler(n){return u=>{var x;if(this.serial!==n)return;const _=u.info.deliverySequence;if(_!==this.cursor.deliver_seq+1){this.notifyOrderedResetAndReset();return}this.cursor.deliver_seq=_,this.cursor.stream_seq=u.info.streamSequence,this.userCallback?this.userCallback(u):(x=this.iter)==null||x.push(u)}}async reset(n={max_messages:100,expires:3e4},u){var N,q;u=u||{};const _=u.fromFetch||!1,x=u.orderedReset||!1;if(this.type===Cs.Fetch&&x){(N=this.iter)==null||N.src.stop(),await((q=this.iter)==null?void 0:q.closed()),this.currentConsumer=null;return}(this.currentConsumer===null||x)&&(this.currentConsumer=await this.resetConsumer(this.cursor.stream_seq+1)),(this.iter===null||_)&&(this.iter=new Z0),this.consumer=new Mm(this.api,this.currentConsumer);const k=n;k.callback=this.internalHandler(this.serial);let S=null;this.type===Cs.Fetch&&_?S=await this.consumer.fetch(n):this.type===Cs.Consume&&(S=await this.consumer.consume(n));const h=S;h.forOrderedConsumer=!0,h.resetHandler=()=>{this.notifyOrderedResetAndReset()},this.iter.setSource(h)}notifyOrderedResetAndReset(){var n;(n=this.iter)==null||n.notify(qa.Reset,""),this.reset(this.opts,{orderedReset:!0})}async consume(n={max_messages:100,expires:3e4}){if(n.bind)return Promise.reject(new Error("bind is not supported"));if(this.type===Cs.Fetch)return Promise.reject(new Error("ordered consumer initialized as fetch"));if(this.type===Cs.Consume)return Promise.reject(new Error("ordered consumer doesn't support concurrent consume"));const{callback:_}=n;return _&&(this.userCallback=_),this.type=Cs.Consume,this.opts=n,await this.reset(n),this.iter}async fetch(n={max_messages:100,expires:3e4}){var x;if(n.bind)return Promise.reject(new Error("bind is not supported"));if(this.type===Cs.Consume)return Promise.reject(new Error("ordered consumer already initialized as consume"));if(((x=this.iter)==null?void 0:x.done)===!1)return Promise.reject(new Error("ordered consumer doesn't support concurrent fetch"));const{callback:_}=n;return _&&(this.userCallback=_),this.type=Cs.Fetch,this.opts=n,await this.reset(n,{fromFetch:!0}),this.iter}async next(n={expires:3e4}){const u=n;if(u.bind)return Promise.reject(new Error("bind is not supported"));u.max_messages=1;const _=Di();return u.callback=k=>{this.userCallback=null,_.resolve(k)},(await this.fetch(u)).iterClosed.then(k=>{k&&_.reject(k),_.resolve(null)}).catch(k=>{_.reject(k)}),_}delete(){return this.currentConsumer?this.api.delete(this.stream,this.currentConsumer.name).then(n=>Promise.resolve(n)).catch(n=>Promise.reject(n)).finally(()=>{this.currentConsumer=null}):Promise.resolve(!1)}async info(n){return this.currentConsumer==null?(this.currentConsumer=await this.resetConsumer(this.serial),Promise.resolve(this.currentConsumer)):n&&this.currentConsumer?Promise.resolve(this.currentConsumer):this.api.info(this.stream,this.currentConsumer.name)}}class zm{constructor(n){U(this,"api");U(this,"notified");this.api=n,this.notified=!1}checkVersion(){const n=this.api.nc.features.get(ii.JS_SIMPLIFICATION);return n.ok?Promise.resolve():Promise.reject(new Error(`consumers framework is only supported on servers ${n.min} or better`))}async get(n,u={}){return typeof u=="object"?this.ordered(n,u):(await this.checkVersion(),this.api.info(n,u).then(_=>_.config.deliver_subject!==void 0?Promise.reject(new Error("push consumer not supported")):new Mm(this.api,_)).catch(_=>Promise.reject(_)))}async ordered(n,u){await this.checkVersion();const _=this.api;return new Fd(_.nc,_.opts).info(n).then(k=>Promise.resolve(new W0(this.api,n,u))).catch(k=>Promise.reject(k))}}class Nh{constructor(n,u){U(this,"api");U(this,"_info");this.api=n,this._info=u}get name(){return this._info.config.name}alternates(){return this.info().then(n=>n.alternates?n.alternates:[])}async best(){if(await this.info(),this._info.alternates){const n=await this.api.info(this._info.alternates[0].name);return new Nh(this.api,n)}else return this}info(n=!1,u){return n?Promise.resolve(this._info):this.api.info(this.name,u).then(_=>(this._info=_,this._info))}getConsumer(n){return new zm(new Rd(this.api.nc,this.api.opts)).get(this.name,n)}getMessage(n){return this.api.getMessage(this.name,n)}deleteMessage(n,u){return this.api.deleteMessage(this.name,n,u)}}class Fd extends cc{constructor(n,u){super(n,u)}checkStreamConfigVersions(n){const u=this.nc;if(n.metadata){const{min:x,ok:k}=u.features.get(ii.JS_STREAM_CONSUMER_METADATA);if(!k)throw new Error(`stream 'metadata' requires server ${x}`)}if(n.first_seq){const{min:x,ok:k}=u.features.get(ii.JS_STREAM_FIRST_SEQ);if(!k)throw new Error(`stream 'first_seq' requires server ${x}`)}if(n.subject_transform){const{min:x,ok:k}=u.features.get(ii.JS_STREAM_SUBJECT_TRANSFORM);if(!k)throw new Error(`stream 'subject_transform' requires server ${x}`)}if(n.compression){const{min:x,ok:k}=u.features.get(ii.JS_STREAM_COMPRESSION);if(!k)throw new Error(`stream 'compression' requires server ${x}`)}if(n.consumer_limits){const{min:x,ok:k}=u.features.get(ii.JS_DEFAULT_CONSUMER_LIMITS);if(!k)throw new Error(`stream 'consumer_limits' requires server ${x}`)}function _(x,k){var h;if((((h=k==null?void 0:k.subject_transforms)==null?void 0:h.length)||0)>0){const{min:N,ok:q}=u.features.get(ii.JS_STREAM_SOURCE_SUBJECT_TRANSFORM);if(!q)throw new Error(`${x} 'subject_transforms' requires server ${N}`)}}n.sources&&n.sources.forEach(x=>{_("stream sources",x)}),n.mirror&&_("stream mirror",n.mirror)}async add(n={}){var x;this.checkStreamConfigVersions(n),Vr(n.name),n.mirror=bh(n.mirror),n.sources=(x=n.sources)==null?void 0:x.map(bh);const _=await this._request(`${this.prefix}.STREAM.CREATE.${n.name}`,n);return this._fixInfo(_),_}async delete(n){return Vr(n),(await this._request(`${this.prefix}.STREAM.DELETE.${n}`)).success}async update(n,u={}){var h;if(typeof n=="object"){const N=n;n=N.name,u=N,console.trace("\x1B[33m >> streams.update(config: StreamConfig) api changed to streams.update(name: string, config: StreamUpdateConfig) - this shim will be removed - update your code.  \x1B[0m")}this.checkStreamConfigVersions(u),Vr(n);const _=await this.info(n),x=Object.assign(_.config,u);x.mirror=bh(x.mirror),x.sources=(h=x.sources)==null?void 0:h.map(bh);const S=await this._request(`${this.prefix}.STREAM.UPDATE.${n}`,x);return this._fixInfo(S),S}async info(n,u){Vr(n);const _=`${this.prefix}.STREAM.INFO.${n}`;let k=await this._request(_,u),{total:S,limit:h}=k,N=k.state.subjects?Object.getOwnPropertyNames(k.state.subjects).length:1;if(S&&S>N){const q=[k],ne=u||{};let J=0;for(;S>N;){J++,ne.offset=h*J;const ve=await this._request(_,ne);S=ve.total,q.push(ve);const Ee=Object.getOwnPropertyNames(ve.state.subjects).length;if(N+=Ee,Ee<h)break}let G={};for(let ve=0;ve<q.length;ve++)k=q[ve],k.state.subjects&&(G=Object.assign(G,k.state.subjects));k.offset=0,k.total=0,k.limit=0,k.state.subjects=G}return this._fixInfo(k),k}list(n=""){const u=n!=null&&n.length?{subject:n}:{},_=k=>{const S=k;return S.streams.forEach(h=>{this._fixInfo(h)}),S.streams},x=`${this.prefix}.STREAM.LIST`;return new Yl(x,_,this,u)}_fixInfo(n){n.config.sealed=n.config.sealed||!1,n.config.deny_delete=n.config.deny_delete||!1,n.config.deny_purge=n.config.deny_purge||!1,n.config.allow_rollup_hdrs=n.config.allow_rollup_hdrs||!1}async purge(n,u){if(u){const{keep:x,seq:k}=u;if(typeof x=="number"&&typeof k=="number")throw new Error("can specify one of keep or seq")}return Vr(n),await this._request(`${this.prefix}.STREAM.PURGE.${n}`,u)}async deleteMessage(n,u,_=!0){Vr(n);const x={seq:u};return _||(x.no_erase=!0),(await this._request(`${this.prefix}.STREAM.MSG.DELETE.${n}`,x)).success}async getMessage(n,u){Vr(n);const x=await this._request(`${this.prefix}.STREAM.MSG.GET.${n}`,u);return new Dm(x)}find(n){return this.findStream(n)}listKvs(){const n=_=>{var N;const k=_.streams.filter(q=>q.config.name.startsWith(gs));k.forEach(q=>{this._fixInfo(q)});let S="";return k.length&&(S=((N=this.nc.info)==null?void 0:N.cluster)??""),k.map(q=>new Cm(q,S))},u=`${this.prefix}.STREAM.LIST`;return new Yl(u,n,this)}listObjectStores(){const n=_=>{const k=_.streams.filter(h=>h.config.name.startsWith(Od));return k.forEach(h=>{this._fixInfo(h)}),k.map(h=>new wd(h))},u=`${this.prefix}.STREAM.LIST`;return new Yl(u,n,this)}names(n=""){const u=n!=null&&n.length?{subject:n}:{},_=k=>k.streams,x=`${this.prefix}.STREAM.NAMES`;return new Yl(x,_,this,u)}async get(n){const u=await this.info(n);return Promise.resolve(new Nh(this,u))}}class X0 extends cc{constructor(n,u){super(n,u)}async getMessage(n,u){Vr(n);let _=u;const{last_by_subj:x}=_;x&&(_=null);const k=_?this.jc.encode(_):bs,S=this.opts.apiPrefix||"$JS.API",h=x?`${S}.DIRECT.GET.${n}.${x}`:`${S}.DIRECT.GET.${n}`,N=await this.nc.request(h,k),q=Va(N);if(q)return Promise.reject(q);const ne=new Sd(N);return Promise.resolve(ne)}async getBatch(n,u){Vr(n);const x=`${this.opts.apiPrefix||"$JS.API"}.DIRECT.GET.${n}`;if(!Array.isArray(u.multi_last)||u.multi_last.length===0)return Promise.reject("multi_last is required");const k=JSON.stringify(u,(N,q)=>N==="up_to_time"&&q instanceof Date?q.toISOString():q),S=new hr,h=await this.nc.requestMany(x,k,{strategy:Us.SentinelMsg});return(async()=>{var J,G,ve;let N=!1,q=!1,ne;for await(const Ee of h){if(!N){N=!0;const $e=((J=Ee.headers)==null?void 0:J.code)||0;if($e!==0&&$e<200||$e>299){ne=(G=Ee.headers)==null?void 0:G.description.toLowerCase();break}if(((ve=Ee.headers)==null?void 0:ve.get("Nats-Num-Pending"))===""){q=!0;break}}if(Ee.data.length===0)break;S.push(new Sd(Ee))}S.push(()=>{if(q)throw new Error("batch direct get not supported by the server");if(ne)throw new Error(`bad request: ${ne}`);S.stop()})})(),Promise.resolve(S)}}class Sd{constructor(n){U(this,"data");U(this,"header");if(!n.headers)throw new Error("headers expected");this.data=n.data,this.header=n.headers}get subject(){return this.header.last(ja.Subject)}get seq(){const n=this.header.last(ja.Sequence);return typeof n=="string"?parseInt(n):0}get time(){return new Date(Date.parse(this.timestamp))}get timestamp(){return this.header.last(ja.TimeStamp)}get stream(){return this.header.last(ja.Stream)}json(n){return Vs(n).decode(this.data)}string(){return xs.decode(this.data)}}U(Sd,"jc");class J0 extends cc{constructor(u,_){super(u,_);U(this,"streams");U(this,"consumers");U(this,"direct");this.streams=new Fd(u,_),this.consumers=new Rd(u,_),this.direct=new X0(u,_)}async getAccountInfo(){return await this._request(`${this.prefix}.INFO`)}jetstream(){return this.nc.jetstream(this.getOptions())}advisories(){const u=new hr;return this.nc.subscribe("$JS.EVENT.ADVISORY.>",{callback:(_,x)=>{if(_)throw _;try{const k=this.parseJsResponse(x),S=k.type.split("."),h=S[S.length-1];u.push({kind:h,data:k})}catch(k){u.stop(k)}}}),u}}class Dm{constructor(n){U(this,"_header");U(this,"smr");this.smr=n}get subject(){return this.smr.message.subject}get seq(){return this.smr.message.seq}get timestamp(){return this.smr.message.time}get time(){return new Date(Date.parse(this.timestamp))}get data(){return this.smr.message.data?this._parse(this.smr.message.data):bs}get header(){if(!this._header)if(this.smr.message.hdrs){const n=this._parse(this.smr.message.hdrs);this._header=so.decode(n)}else this._header=Dn();return this._header}_parse(n){const u=atob(n),_=u.length,x=new Uint8Array(_);for(let k=0;k<_;k++)x[k]=u.charCodeAt(k);return x}json(n){return Vs(n).decode(this.data)}string(){return xs.decode(this.data)}}U(Dm,"jc");class K0{constructor(n){U(this,"api");this.api=n}get(n){return this.api.info(n).then(u=>new Nh(this.api,u))}}class cd{constructor(n){U(this,"info");U(this,"hdrs");this.info=n}get name(){return this.info.name}get description(){return this.info.description??""}get headers(){return this.hdrs||(this.hdrs=so.fromRecord(this.info.headers||{})),this.hdrs}get options(){return this.info.options}get bucket(){return this.info.bucket}get chunks(){return this.info.chunks}get deleted(){return this.info.deleted??!1}get digest(){return this.info.digest}get mtime(){return this.info.mtime}get nuid(){return this.info.nuid}get size(){return this.info.size}get revision(){return this.info.revision}get metadata(){return this.info.metadata||{}}isLink(){var n,u;return((n=this.info.options)==null?void 0:n.link)!==void 0&&((u=this.info.options)==null?void 0:u.link)!==null}}function Yf(g){const n={name:g.name,description:g.description??"",options:g.options,metadata:g.metadata};if(g.headers){const u=g.headers;n.headers=u.toRecord()}return n}function Y0(){return new ReadableStream({pull(g){g.enqueue(new Uint8Array(0)),g.close()}})}class rc{constructor(n,u,_){U(this,"jsm");U(this,"js");U(this,"stream");U(this,"name");this.name=n,this.jsm=u,this.js=_}_checkNotEmpty(n){return!n||n.length===0?{name:n,error:new Error("name cannot be empty")}:{name:n}}async info(n){const u=await this.rawInfo(n);return u?new cd(u):null}async list(){const n=[],u=await this.watch({ignoreDeletes:!0,includeHistory:!0});for await(const _ of u){if(_===null)break;n.push(_)}return Promise.resolve(n)}async rawInfo(n){const{name:u,error:_}=this._checkNotEmpty(n);if(_)return Promise.reject(_);const x=this._metaSubject(u);try{const k=await this.jsm.streams.getMessage(this.stream,{last_by_subj:x}),h=Vs().decode(k.data);return h.revision=k.seq,h}catch(k){return k.code==="404"?null:Promise.reject(k)}}async _si(n){try{return await this.jsm.streams.info(this.stream,n)}catch(u){return u.code==="404"?null:Promise.reject(u)}}async seal(){let n=await this._si();return n===null?Promise.reject(new Error("object store not found")):(n.config.sealed=!0,n=await this.jsm.streams.update(this.stream,n.config),Promise.resolve(new wd(n)))}async status(n){const u=await this._si(n);return u===null?Promise.reject(new Error("object store not found")):Promise.resolve(new wd(u))}destroy(){return this.jsm.streams.delete(this.stream)}async _put(n,u,_){var Li;const x=this.js.getOptions();_=_||{timeout:x.timeout},_.timeout=_.timeout||x.timeout,_.previousRevision=_.previousRevision??void 0;const{timeout:k,previousRevision:S}=_,h=this.js.nc.info,N=(h==null?void 0:h.max_payload)||1024;n=n||{},n.options=n.options||{};let q=((Li=n.options)==null?void 0:Li.max_chunk_size)||128*1024;q=q>N?N:q,n.options.max_chunk_size=q;const ne=await this.info(n.name),{name:J,error:G}=this._checkNotEmpty(n.name);if(G)return Promise.reject(G);const ve=Zo.next(),Ee=this._chunkSubject(ve),$e=this._metaSubject(J),_t=Object.assign({bucket:this.name,nuid:ve,size:0,chunks:0},Yf(n)),Tt=Di(),xt=[],Ct=new Za;try{const Yt=u?u.getReader():null,Vt=new $f;for(;;){const{done:yt,value:ri}=Yt?await Yt.read():{done:!0,value:void 0};if(yt){if(Ct.size()>0){const De=Ct.drain();Vt.update(De),_t.chunks++,_t.size+=De.length,xt.push(this.js.publish(Ee,De,{timeout:k}))}await Promise.all(xt),xt.length=0,_t.mtime=new Date().toISOString();const Bt=Vt.digest("base64"),ji=Bt.length%3,Lt=ji>0?"=".repeat(ji):"";_t.digest=`${Jf}${Bt}${Lt}`,_t.deleted=!1;const kt=Dn();typeof S=="number"&&kt.set(rn.ExpectedLastSubjectSequenceHdr,`${S}`),kt.set(Gr.RollupHdr,Gr.RollupValueSubject);const pi=await this.js.publish($e,Vs().encode(_t),{headers:kt,timeout:k});if(_t.revision=pi.seq,ne)try{await this.jsm.streams.purge(this.stream,{filter:`$O.${this.name}.C.${ne.nuid}`})}catch{}Tt.resolve(new cd(_t));break}if(ri)for(Ct.fill(ri);Ct.size()>q;){_t.chunks++,_t.size+=q;const Bt=Ct.drain(n.options.max_chunk_size);Vt.update(Bt),xt.push(this.js.publish(Ee,Bt,{timeout:k}))}}}catch(Yt){await this.jsm.streams.purge(this.stream,{filter:Ee}),Tt.reject(Yt)}return Tt}putBlob(n,u,_){function x(k){return new ReadableStream({pull(S){S.enqueue(k),S.close()}})}return u===null&&(u=new Uint8Array(0)),this.put(n,x(u),_)}put(n,u,_){var x;return(x=n==null?void 0:n.options)!=null&&x.link?Promise.reject(new Error("link cannot be set when putting the object in bucket")):this._put(n,u,_)}async getBlob(n){async function u(k){const S=new Za,h=k.getReader();for(;;){const{done:N,value:q}=await h.read();if(N)return S.drain();q&&q.length&&S.fill(q)}}const _=await this.get(n);if(_===null)return Promise.resolve(null);const x=await Promise.all([_.error,u(_.data)]);return x[0]?Promise.reject(x[0]):Promise.resolve(x[1])}async get(n){const u=await this.rawInfo(n);if(u===null||u.deleted)return Promise.resolve(null);if(u.options&&u.options.link){const ne=u.options.link.name||"";if(ne==="")throw new Error("link is a bucket");return(u.options.link.bucket!==this.name?await rc.create(this.js,u.options.link.bucket):this).get(ne)}const _=Di(),x={info:new cd(u),error:_};if(u.size===0)return x.data=Y0(),_.resolve(null),Promise.resolve(x);let k;const S=zn();S.orderedConsumer();const h=new $f,N=`$O.${this.name}.C.${u.nuid}`,q=await this.js.subscribe(N,S);return(async()=>{for await(const ne of q)if(ne.data.length>0&&(h.update(ne.data),k.enqueue(ne.data)),ne.info.pending===0){const J=h.digest("base64"),G=J.length%3,ve=G>0?"=".repeat(G):"",Ee=`${Jf}${J}${ve}`;Ee!==u.digest?k.error(new Error(`received a corrupt object, digests do not match received: ${u.digest} calculated ${Ee}`)):k.close(),q.unsubscribe()}})().then(()=>{_.resolve()}).catch(ne=>{k.error(ne),_.reject(ne)}),x.data=new ReadableStream({start(ne){k=ne},cancel(){q.unsubscribe()}}),x}linkStore(n,u){if(!(u instanceof rc))return Promise.reject("bucket required");const _=u,{name:x,error:k}=this._checkNotEmpty(n);if(k)return Promise.reject(k);const S={name:x,options:{link:{bucket:_.name}}};return this._put(S,null)}async link(n,u){const{name:_,error:x}=this._checkNotEmpty(n);if(x)return Promise.reject(x);if(u.deleted)return Promise.reject(new Error("src object is deleted"));if(u.isLink())return Promise.reject(new Error("src object is a link"));const k=await this.rawInfo(n);if(k!==null&&!k.deleted)return Promise.reject(new Error("an object already exists with that name"));const S={bucket:u.bucket,name:u.name},h={name:_,bucket:u.bucket,options:{link:S}};await this.js.publish(this._metaSubject(n),JSON.stringify(h));const N=await this.info(n);return Promise.resolve(N)}async delete(n){const u=await this.rawInfo(n);if(u===null)return Promise.resolve({purged:0,success:!1});u.deleted=!0,u.size=0,u.chunks=0,u.digest="";const _=Vs(),x=Dn();return x.set(Gr.RollupHdr,Gr.RollupValueSubject),await this.js.publish(this._metaSubject(u.name),_.encode(u),{headers:x}),this.jsm.streams.purge(this.stream,{filter:this._chunkSubject(u.nuid)})}async update(n,u={}){const _=await this.rawInfo(n);if(_===null)return Promise.reject(new Error("object not found"));if(_.deleted)return Promise.reject(new Error("cannot update meta for a deleted object"));u.name=u.name??_.name;const{name:x,error:k}=this._checkNotEmpty(u.name);if(k)return Promise.reject(k);if(n!==u.name){const N=await this.info(u.name);if(N&&!N.deleted)return Promise.reject(new Error("an object already exists with that name"))}u.name=x;const S=Object.assign({},_,Yf(u)),h=await this.js.publish(this._metaSubject(S.name),JSON.stringify(S));return n!==u.name&&await this.jsm.streams.purge(this.stream,{filter:this._metaSubject(n)}),Promise.resolve(h)}async watch(n={}){n.includeHistory=n.includeHistory??!1,n.ignoreDeletes=n.ignoreDeletes??!1;let u=!1;const _=new hr,x=this._metaSubjectAll();try{await this.jsm.streams.getMessage(this.stream,{last_by_subj:x})}catch(N){N.code==="404"?(_.push(null),u=!0):_.stop(N)}const k=Vs(),S=zn();S.orderedConsumer(),n.includeHistory?S.deliverLastPerSubject():(u=!0,S.deliverNew()),S.callback((N,q)=>{var ne;if(N){_.stop(N);return}if(q!==null){const J=k.decode(q.data);J.deleted&&n.ignoreDeletes===!0||_.push(J),((ne=q.info)==null?void 0:ne.pending)===0&&!u&&(u=!0,_.push(null))}});const h=await this.js.subscribe(x,S);return _._data=h,_.iterClosed.then(()=>{h.unsubscribe()}),h.closed.then(()=>{_.stop()}).catch(N=>{_.stop(N)}),_}_chunkSubject(n){return`$O.${this.name}.C.${n}`}_metaSubject(n){return`$O.${this.name}.M.${tc.encode(n)}`}_metaSubjectAll(){return`$O.${this.name}.M.>`}async init(n={}){try{this.stream=$0(this.name)}catch(x){return Promise.reject(x)}const u=(n==null?void 0:n.ttl)||0;delete n.ttl;const _=Object.assign({max_age:u},n);_.name=this.stream,_.num_replicas=n.replicas??1,_.allow_direct=!0,_.allow_rollup_hdrs=!0,_.discard=sc.New,_.subjects=[`$O.${this.name}.C.>`,`$O.${this.name}.M.>`],n.placement&&(_.placement=n.placement),n.metadata&&(_.metadata=n.metadata),typeof n.compression=="boolean"&&(_.compression=n.compression?oo.S2:oo.None);try{await this.jsm.streams.info(_.name)}catch(x){x.message==="stream not found"&&await this.jsm.streams.add(_)}}static async create(n,u,_={}){const x=await n.jetstreamManager(),k=new rc(u,x,n);return await k.init(_),Promise.resolve(k)}}class Q0{constructor(n){U(this,"js");this.js=n}kv(n,u={}){const _=this.js,{ok:x,min:k}=_.nc.features.get(ii.JS_KV);return x?u.bindOnly?oc.bind(this.js,n,u):oc.create(this.js,n,u):Promise.reject(new Error(`kv is only supported on servers ${k} or better`))}os(n,u={}){var S;if(typeof((S=crypto==null?void 0:crypto.subtle)==null?void 0:S.digest)!="function")return Promise.reject(new Error("objectstore: unable to calculate hashes - crypto.subtle.digest with sha256 support is required"));const _=this.js,{ok:x,min:k}=_.nc.features.get(ii.JS_OBJECTSTORE);return x?rc.create(this.js,n,u):Promise.reject(new Error(`objectstore is only supported on servers ${k} or better`))}}class Bd extends cc{constructor(u,_){super(u,_);U(this,"consumers");U(this,"streams");U(this,"consumerAPI");U(this,"streamAPI");this.consumerAPI=new Rd(u,_),this.streamAPI=new Fd(u,_),this.consumers=new zm(this.consumerAPI),this.streams=new K0(this.streamAPI)}jetstreamManager(u){u===void 0&&(u=this.opts.checkAPI);const _=Object.assign({},this.opts,{checkAPI:u});return this.nc.jetstreamManager(_)}get apiPrefix(){return this.prefix}get views(){return new Q0(this)}async publish(u,_=bs,x){x=x||{},x.expect=x.expect||{};const k=(x==null?void 0:x.headers)||Dn();x&&(x.msgID&&k.set(rn.MsgIdHdr,x.msgID),x.expect.lastMsgID&&k.set(rn.ExpectedLastMsgIdHdr,x.expect.lastMsgID),x.expect.streamName&&k.set(rn.ExpectedStreamHdr,x.expect.streamName),typeof x.expect.lastSequence=="number"&&k.set(rn.ExpectedLastSeqHdr,`${x.expect.lastSequence}`),typeof x.expect.lastSubjectSequence=="number"&&k.set(rn.ExpectedLastSubjectSequenceHdr,`${x.expect.lastSubjectSequence}`));const S=x.timeout||this.timeout,h={};S&&(h.timeout=S),x&&(h.headers=k);let{retries:N,retry_delay:q}=x;N=N||1,q=q||250;let ne;for(let G=0;G<N;G++)try{ne=await this.nc.request(u,_,h);break}catch(ve){if(ve.code==="503"&&G+1<N)await Wa(q);else throw ve}const J=this.parseJsResponse(ne);if(J.stream==="")throw ht.errorForCode(He.JetStreamInvalidAck);return J.duplicate=J.duplicate?J.duplicate:!1,J}async pull(u,_,x=0){Vr(u),Ua(_);let k=this.timeout;x>k&&(k=x),x=x<0?0:Bi(x);const S={batch:1,no_wait:x===0,expires:x},h=await this.nc.request(`${this.prefix}.CONSUMER.MSG.NEXT.${u}.${_}`,this.jc.encode(S),{noMux:!0,timeout:k}),N=Va(h);if(N)throw N;return ac(h,this.timeout)}fetch(u,_,x={}){Vr(u),Ua(_);let k=null;const S=(x.max_bytes??0)>0;let h=0;const N=S?x.max_bytes:0;let q=null;const ne={};if(ne.batch=x.batch||1,N){const xt=this.nc.features.get(ii.JS_PULL_MAX_BYTES);if(!xt.ok)throw new Error(`max_bytes is only supported on servers ${xt.min} or better`);ne.max_bytes=N}ne.no_wait=x.no_wait||!1,ne.no_wait&&ne.expires&&(ne.expires=0);const J=x.expires||0;if(J&&(ne.expires=Bi(J)),J===0&&ne.no_wait===!1)throw new Error("expires or no_wait is required");const G=x.idle_heartbeat||0;G&&(ne.idle_heartbeat=Bi(G),x.delay_heartbeat===!0&&(ne.idle_heartbeat=Bi(G*4)));const ve=new hr,Ee=ne.batch;let $e=0;ve.protocolFilterFn=(xt,Ct=!1)=>md(xt.msg)?(q==null||q.work(),!1):!0,ve.dispatchedFn=xt=>{if(xt){if(S&&(h+=xt.data.length),$e++,k&&xt.info.pending===0)return;(ve.getPending()===1&&xt.info.pending===0||Ee===$e||N>0&&h>=N)&&ve.stop()}};const _t=nn(this.nc.options.inboxPrefix),Tt=this.nc.subscribe(_t,{max:x.batch,callback:(xt,Ct)=>{xt===null&&(xt=Va(Ct)),xt!==null?(k&&(k.cancel(),k=null),Sy(xt)?ve.stop(Rm(xt)===null?void 0:xt):ve.stop(xt)):(q==null||q.work(),ve.received++,ve.push(ac(Ct,this.timeout)))}});return J&&(k=Ga(J),k.catch(()=>{Tt.isClosed()||(Tt.drain().catch(()=>{}),k=null),q&&q.cancel()})),(async()=>{try{G&&(q=new Ld(G,xt=>(ve.push(()=>{ve.err=new ht(`${Ms.IdleHeartbeatMissed}: ${xt}`,He.JetStreamIdleHeartBeat)}),!0)))}catch{}await Tt.closed,k!==null&&(k.cancel(),k=null),q&&q.cancel(),ve.stop()})().catch(),this.nc.publish(`${this.prefix}.CONSUMER.MSG.NEXT.${u}.${_}`,this.jc.encode(ne),{reply:_t}),ve}async pullSubscribe(u,_=zn()){const x=await this._processOptions(u,_);if(x.ordered)throw new Error("pull subscribers cannot be be ordered");if(x.config.deliver_subject)throw new Error("consumer info specifies deliver_subject - pull consumers cannot have deliver_subject set");const k=x.config.ack_policy;if(k===cr.None||k===cr.All)throw new Error("ack policy for pull consumers must be explicit");const S=this._buildTypedSubscriptionOpts(x),h=new rx(this,x.deliver,S);h.info=x;try{await this._maybeCreateConsumer(x)}catch(N){throw h.unsubscribe(),N}return h}async subscribe(u,_=zn()){const x=await this._processOptions(u,_);if(!x.isBind&&!x.config.deliver_subject)throw new Error("push consumer requires deliver_subject");const k=this._buildTypedSubscriptionOpts(x),S=new Lm(this,x.deliver,k);S.info=x;try{await this._maybeCreateConsumer(x)}catch(h){throw S.unsubscribe(),h}return S._maybeSetupHbMonitoring(),S}async _processOptions(u,_=zn()){const x=jf(_)?_.getOpts():_;if(x.isBind=jf(_)?_.isBind:!1,x.flow_control={heartbeat_count:0,fc_count:0,consumer_restarts:0},x.ordered){if(x.ordered_consumer_sequence={stream_seq:0,delivery_seq:0},x.config.ack_policy!==cr.NotSet&&x.config.ack_policy!==cr.None)throw new ht("ordered consumer: ack_policy can only be set to 'none'",He.ApiError);if(x.config.durable_name&&x.config.durable_name.length>0)throw new ht("ordered consumer: durable_name cannot be set",He.ApiError);if(x.config.deliver_subject&&x.config.deliver_subject.length>0)throw new ht("ordered consumer: deliver_subject cannot be set",He.ApiError);if(x.config.max_deliver!==void 0&&x.config.max_deliver>1)throw new ht("ordered consumer: max_deliver cannot be set",He.ApiError);if(x.config.deliver_group&&x.config.deliver_group.length>0)throw new ht("ordered consumer: deliver_group cannot be set",He.ApiError);x.config.deliver_subject=nn(this.nc.options.inboxPrefix),x.config.ack_policy=cr.None,x.config.max_deliver=1,x.config.flow_control=!0,x.config.idle_heartbeat=x.config.idle_heartbeat||Bi(5e3),x.config.ack_wait=Bi(22*60*60*1e3),x.config.mem_storage=!0,x.config.num_replicas=1}if(x.config.ack_policy===cr.NotSet&&(x.config.ack_policy=cr.All),x.api=this,x.config=x.config||{},x.stream=x.stream?x.stream:await this.findStream(u),x.attached=!1,x.config.durable_name)try{const k=await this.consumerAPI.info(x.stream,x.config.durable_name);if(k){if(k.config.filter_subject&&k.config.filter_subject!==u)throw new Error("subject does not match consumer");const S=x.config.deliver_group??"";if(S===""&&k.push_bound===!0)throw new Error("duplicate subscription");const h=k.config.deliver_group??"";if(S!==h)throw h===""?new Error("durable requires no queue group"):new Error(`durable requires queue group '${h}'`);x.last=k,x.config=k.config,x.attached=!0,x.config.durable_name||(x.name=k.name)}}catch(k){if(k.code!=="404")throw k}return!x.attached&&x.config.filter_subject===void 0&&x.config.filter_subjects===void 0&&(x.config.filter_subject=u),x.deliver=x.config.deliver_subject||nn(this.nc.options.inboxPrefix),x}_buildTypedSubscriptionOpts(u){const _={};return _.adapter=sx(u.callbackFn===void 0,this.timeout),_.ingestionFilterFn=Bd.ingestionFn(u.ordered),_.protocolFilterFn=(x,k=!1)=>{const S=x;return fd(S.msg)?(k||S.msg.respond(),!1):!0},!u.mack&&u.config.ack_policy!==cr.None&&(_.dispatchedFn=ax),u.callbackFn&&(_.callback=u.callbackFn),_.max=u.max||0,_.queue=u.queue,_}async _maybeCreateConsumer(u){if(u.attached)return;if(u.isBind)throw new Error(`unable to bind - durable consumer ${u.config.durable_name} doesn't exist in ${u.stream}`);u.config=Object.assign({deliver_policy:Hi.All,ack_policy:cr.Explicit,ack_wait:Bi(30*1e3),replay_policy:Ha.Instant},u.config);const _=await this.consumerAPI.add(u.stream,u.config);if(Array.isArray(u.config.filter_subjects&&!Array.isArray(_.config.filter_subjects)))throw new Error("jetstream server doesn't support consumers with multiple filter subjects");u.name=_.name,u.config=_.config,u.last=_}static ingestionFn(u){return(_,x)=>{var N;const k=x;if(!_)return{ingest:!1,protocol:!1};const S=_;if(Va(S.msg)||(N=k.monitor)==null||N.work(),md(S.msg)){const q=u?k._checkHbOrderConsumer(S.msg):!0;return u||k.info.flow_control.heartbeat_count++,{ingest:q,protocol:!0}}else if(fd(S.msg))return k.info.flow_control.fc_count++,{ingest:!0,protocol:!0};return{ingest:u?k._checkOrderedConsumer(_):!0,protocol:!1}}}}class jd{constructor(n){U(this,"options");U(this,"protocol");U(this,"draining");U(this,"listeners");U(this,"_services");this.draining=!1,this.options=w0(n),this.listeners=[]}static connect(n={}){return new Promise((u,_)=>{const x=new jd(n);Lh.connect(x.options,x).then(k=>{x.protocol=k,async function(){for await(const S of k.status())x.listeners.forEach(h=>{h.push(S)})}(),u(x)}).catch(k=>{_(k)})})}closed(){return this.protocol.closed}async close(){await this.protocol.close()}_check(n,u,_){if(this.isClosed())throw ht.errorForCode(He.ConnectionClosed);if(u&&this.isDraining()||_&&this.protocol.noMorePublishing)throw ht.errorForCode(He.ConnectionDraining);if(n=n||"",n.length===0)throw ht.errorForCode(He.BadSubject)}publish(n,u,_){this._check(n,!1,!0),this.protocol.publish(n,u,_)}publishMessage(n){return this.publish(n.subject,n.data,{reply:n.reply,headers:n.headers})}respondMessage(n){return n.reply?(this.publish(n.reply,n.data,{reply:n.reply,headers:n.headers}),!0):!1}subscribe(n,u={}){this._check(n,!0,!1);const _=new Am(this.protocol,n,u);return this.protocol.subscribe(_),_}_resub(n,u,_){this._check(u,!0,!1);const x=n;x.max=_,_&&(x.max=_+x.received),this.protocol.resub(x,u)}requestMany(n,u=bs,_={maxWait:1e3,maxMessages:-1}){const x=!this.protocol.options.noAsyncTraces;try{this._check(n,!0,!0)}catch(N){return Promise.reject(N)}if(_.strategy=_.strategy||Us.Timer,_.maxWait=_.maxWait||1e3,_.maxWait<1)return Promise.reject(new ht("timeout",He.InvalidOption));const k=new hr;function S(N){k.push(()=>{k.stop(N)})}function h(N,q){N||q===null?S(N===null?void 0:N):k.push(q)}if(_.noMux){const N=x?new Error().stack:null;let q=typeof _.maxMessages=="number"&&_.maxMessages>0?_.maxMessages:-1;const ne=this.subscribe(nn(this.options.inboxPrefix),{callback:(Ee,$e)=>{var _t,Tt;if(((_t=$e==null?void 0:$e.data)==null?void 0:_t.length)===0&&((Tt=$e==null?void 0:$e.headers)==null?void 0:Tt.status)===He.NoResponders&&(Ee=ht.errorForCode(He.NoResponders)),Ee){N&&(Ee.stack+=`

${N}`),J(Ee);return}h(null,$e),_.strategy===Us.Count&&(q--,q===0&&J()),_.strategy===Us.JitterTimer&&(ve(),G=setTimeout(()=>{J()},300)),_.strategy===Us.SentinelMsg&&$e&&$e.data.length===0&&J()}});ne.requestSubject=n,ne.closed.then(()=>{S()}).catch(Ee=>{k.stop(Ee)});const J=Ee=>{Ee&&k.push(()=>{throw Ee}),ve(),ne.drain().then(()=>{S()}).catch($e=>{S()})};k.iterClosed.then(()=>{ve(),ne==null||ne.unsubscribe()}).catch(Ee=>{ve(),ne==null||ne.unsubscribe()});try{this.publish(n,u,{reply:ne.getSubject()})}catch(Ee){J(Ee)}let G=setTimeout(()=>{J()},_.maxWait);const ve=()=>{G&&clearTimeout(G)}}else{const N=_;N.callback=h,k.iterClosed.then(()=>{q.cancel()}).catch(ne=>{q.cancel(ne)});const q=new $y(this.protocol.muxSubscriptions,n,N);this.protocol.request(q);try{this.publish(n,u,{reply:`${this.protocol.muxSubscriptions.baseInbox}${q.token}`,headers:_.headers})}catch(ne){q.cancel(ne)}}return Promise.resolve(k)}request(n,u,_={timeout:1e3,noMux:!1}){try{this._check(n,!0,!0)}catch(k){return Promise.reject(k)}const x=!this.protocol.options.noAsyncTraces;if(_.timeout=_.timeout||1e3,_.timeout<1)return Promise.reject(new ht("timeout",He.InvalidOption));if(!_.noMux&&_.reply)return Promise.reject(new ht("reply can only be used with noMux",He.InvalidOption));if(_.noMux){const k=_.reply?_.reply:nn(this.options.inboxPrefix),S=Di(),h=x?new Error:null,N=this.subscribe(k,{max:1,timeout:_.timeout,callback:(q,ne)=>{q?(h&&q.code!==He.Timeout&&(q.stack+=`

${h.stack}`),N.unsubscribe(),S.reject(q)):(q=gm(ne),q?(h&&(q.stack+=`

${h.stack}`),S.reject(q)):S.resolve(ne))}});return N.requestSubject=n,this.protocol.publish(n,u,{reply:k,headers:_.headers}),S}else{const k=new wm(this.protocol.muxSubscriptions,n,_,x);this.protocol.request(k);try{this.publish(n,u,{reply:`${this.protocol.muxSubscriptions.baseInbox}${k.token}`,headers:_.headers})}catch(h){k.cancel(h)}const S=Promise.race([k.timer,k.deferred]);return S.catch(()=>{k.cancel()}),S}}flush(){return this.isClosed()?Promise.reject(ht.errorForCode(He.ConnectionClosed)):this.protocol.flush()}drain(){return this.isClosed()?Promise.reject(ht.errorForCode(He.ConnectionClosed)):this.isDraining()?Promise.reject(ht.errorForCode(He.ConnectionDraining)):(this.draining=!0,this.protocol.drain())}isClosed(){return this.protocol.isClosed()}isDraining(){return this.draining}getServer(){const n=this.protocol.getServer();return n?n.listen:""}status(){const n=new hr;return n.iterClosed.then(()=>{const u=this.listeners.indexOf(n);this.listeners.splice(u,1)}),this.listeners.push(n),n}get info(){return this.protocol.isClosed()?void 0:this.protocol.info}async context(){return(await this.request("$SYS.REQ.USER.INFO")).json((u,_)=>u==="time"?new Date(Date.parse(_)):_)}stats(){return{inBytes:this.protocol.inBytes,outBytes:this.protocol.outBytes,inMsgs:this.protocol.inMsgs,outMsgs:this.protocol.outMsgs}}async jetstreamManager(n={}){const u=new J0(this,n);if(n.checkAPI!==!1)try{await u.getAccountInfo()}catch(_){const x=_;throw x.code===He.NoResponders&&(x.code=He.JetStreamNotEnabled),x}return u}jetstream(n={}){return new Bd(this,n)}getServerVersion(){const n=this.info;return n?qo(n.version):void 0}async rtt(){if(!this.protocol._closed&&!this.protocol.connected)throw ht.errorForCode(He.Disconnect);const n=Date.now();return await this.flush(),Date.now()-n}get features(){return this.protocol.features}get services(){return this._services||(this._services=new ex(this)),this._services}reconnect(){return this.isClosed()?Promise.reject(ht.errorForCode(He.ConnectionClosed)):this.isDraining()?Promise.reject(ht.errorForCode(He.ConnectionDraining)):this.protocol.reconnect()}}class ex{constructor(n){U(this,"nc");this.nc=n}add(n){try{return new hc(this.nc,n).start()}catch(u){return Promise.reject(u)}}client(n,u){return new D0(this.nc,n,u)}}class tx{constructor(n,u,_){U(this,"bucket");U(this,"sm");U(this,"prefixLen");this.bucket=n,this.prefixLen=u,this.sm=_}get key(){return this.sm.subject.substring(this.prefixLen)}get value(){return this.sm.data}get delta(){return 0}get created(){return this.sm.time}get revision(){return this.sm.seq}get operation(){return this.sm.header.get(Rh)||"PUT"}get length(){const n=this.sm.header.get(Gr.MessageSizeHdr)||"";return n!==""?parseInt(n,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class ix{constructor(n,u,_){U(this,"bucket");U(this,"key");U(this,"sm");this.bucket=n,this.key=u,this.sm=_}get value(){return this.sm.data}get created(){return new Date(zd(this.sm.info.timestampNanos))}get revision(){return this.sm.seq}get operation(){var n;return((n=this.sm.headers)==null?void 0:n.get(Rh))||"PUT"}get delta(){return this.sm.info.pending}get length(){var u;const n=((u=this.sm.headers)==null?void 0:u.get(Gr.MessageSizeHdr))||"";return n!==""?parseInt(n,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class Lm extends Gy{constructor(u,_,x){super(u.nc,_,x);U(this,"js");U(this,"monitor");this.js=u,this.monitor=null,this.sub.closed.then(()=>{this.monitor&&this.monitor.cancel()})}set info(u){this.sub.info=u}get info(){return this.sub.info}_resetOrderedConsumer(u){if(this.info===null||this.sub.isClosed())return;const _=nn(this.js.nc.options.inboxPrefix);this.js.nc._resub(this.sub,_);const k=this.info;k.config.name=Zo.next(),k.ordered_consumer_sequence.delivery_seq=0,k.flow_control.heartbeat_count=0,k.flow_control.fc_count=0,k.flow_control.consumer_restarts++,k.deliver=_,k.config.deliver_subject=_,k.config.deliver_policy=Hi.StartSequence,k.config.opt_start_seq=u;const S={};S.stream_name=this.info.stream,S.config=k.config;const h=`${k.api.prefix}.CONSUMER.CREATE.${k.stream}`;this.js._request(h,S,{retries:-1}).then(N=>{const q=N,ne=this.sub.info;ne.last=q,this.info.config=q.config,this.info.name=q.name}).catch(N=>{const q=new ht(`unable to recreate ordered consumer ${k.stream} at seq ${u}`,He.RequestError,N);this.sub.callback(q,{})})}_maybeSetupHbMonitoring(){var _,x;const u=((x=(_=this.info)==null?void 0:_.config)==null?void 0:x.idle_heartbeat)||0;u&&this._setupHbMonitoring(zd(u))}_setupHbMonitoring(u,_=0){const x={cancelAfter:0,maxOut:2};_&&(x.cancelAfter=_);const k=this.sub,S=h=>{var ne,J,G,ve;const N=Ey(409,`${Ms.IdleHeartbeatMissed}: ${h}`,this.sub.subject);if(!((ne=this.info)==null?void 0:ne.ordered))this.sub.callback(null,N);else{if(!this.js.nc.protocol.connected)return!1;const Ee=((G=(J=this.info)==null?void 0:J.ordered_consumer_sequence)==null?void 0:G.stream_seq)||0;return this._resetOrderedConsumer(Ee+1),(ve=this.monitor)==null||ve.restart(),!1}return!k.noIterator};this.monitor=new Ld(u,S,x)}_checkHbOrderConsumer(u){const _=u.headers.get(Gr.ConsumerStalledHdr);_!==""&&this.js.nc.publish(_);const x=parseInt(u.headers.get(Gr.LastConsumerSeqHdr),10),k=this.info.ordered_consumer_sequence;return this.info.flow_control.heartbeat_count++,x!==k.delivery_seq&&this._resetOrderedConsumer(k.stream_seq+1),!1}_checkOrderedConsumer(u){const _=this.info.ordered_consumer_sequence,x=u.info.streamSequence,k=u.info.deliverySequence;return k!=_.delivery_seq+1?(this._resetOrderedConsumer(_.stream_seq+1),!1):(_.delivery_seq=k,_.stream_seq=x,!0)}async destroy(){this.isClosed()||await this.drain();const u=this.sub.info,_=u.config.durable_name||u.name,x=`${u.api.prefix}.CONSUMER.DELETE.${u.stream}.${_}`;await u.api._request(x)}async consumerInfo(){const u=this.sub.info,_=u.config.durable_name||u.name,x=`${u.api.prefix}.CONSUMER.INFO.${u.stream}.${_}`,k=await u.api._request(x);return u.last=k,k}}class rx extends Lm{constructor(n,u,_){super(n,u,_)}pull(n={batch:1}){const{stream:u,config:_,name:x}=this.sub.info,k=_.durable_name??x,S={};if(S.batch=n.batch||1,S.no_wait=n.no_wait||!1,(n.max_bytes??0)>0){const q=this.js.nc.features.get(ii.JS_PULL_MAX_BYTES);if(!q.ok)throw new Error(`max_bytes is only supported on servers ${q.min} or better`);S.max_bytes=n.max_bytes}let h=0;n.expires&&n.expires>0&&(h=n.expires,S.expires=Bi(h));let N=0;if(n.idle_heartbeat&&n.idle_heartbeat>0&&(N=n.idle_heartbeat,S.idle_heartbeat=Bi(N)),N&&h===0)throw new Error("idle_heartbeat requires expires");if(N>h)throw new Error("expires must be greater than idle_heartbeat");if(this.info){this.monitor&&this.monitor.cancel(),h&&N&&(this.monitor?this.monitor._change(N,h):this._setupHbMonitoring(N,h));const q=this.info.api,ne=`${q.prefix}.CONSUMER.MSG.NEXT.${u}.${k}`,J=this.sub.subject;q.nc.publish(ne,q.jc.encode(S),{reply:J})}}}function sx(g,n){return g?ox(n):nx(n)}function nx(g){return(n,u)=>n?[n,null]:(n=Va(u),n?[n,null]:[null,ac(u,g)])}function ox(g){return(n,u)=>{if(n)return[n,null];const _=Va(u);return _!==null?[Rm(_),null]:[null,ac(u,g)]}}function Rm(g){if(g!==null)switch(g.code){case He.JetStream404NoMessages:case He.JetStream408RequestTimeout:return null;case He.JetStream409:return Ay(g)?g:null;default:return g}return null}function ax(g){g&&g.ack()}function lx(g){const n=g.split(".");if(n.length===9&&n.splice(2,0,"_",""),n.length<11||n[0]!=="$JS"||n[1]!=="ACK")throw new Error("not js message");const u={};return u.domain=n[2]==="_"?"":n[2],u.account_hash=n[3],u.stream=n[4],u.consumer=n[5],u.redeliveryCount=parseInt(n[6],10),u.redelivered=u.redeliveryCount>1,u.streamSequence=parseInt(n[7],10),u.deliverySequence=parseInt(n[8],10),u.timestampNanos=parseInt(n[9],10),u.pending=parseInt(n[10],10),u}class cx{constructor(n,u){U(this,"msg");U(this,"di");U(this,"didAck");U(this,"timeout");this.msg=n,this.didAck=!1,this.timeout=u}get subject(){return this.msg.subject}get sid(){return this.msg.sid}get data(){return this.msg.data}get headers(){return this.msg.headers}get info(){return this.di||(this.di=lx(this.reply)),this.di}get redelivered(){return this.info.redeliveryCount>1}get reply(){return this.msg.reply||""}get seq(){return this.info.streamSequence}doAck(n){this.didAck||(this.didAck=!this.isWIP(n),this.msg.respond(n))}isWIP(n){return n.length===4&&n[0]===Jl[0]&&n[1]===Jl[1]&&n[2]===Jl[2]&&n[3]===Jl[3]}async ackAck(n){var _;n=n||{},n.timeout=n.timeout||this.timeout;const u=Di();if(this.didAck)u.resolve(!1);else if(this.didAck=!0,this.msg.reply){const k=this.msg.publisher,S=!((_=k.options)!=null&&_.noAsyncTraces),h=new wm(k.muxSubscriptions,this.msg.reply,{timeout:n.timeout},S);k.request(h);try{k.publish(this.msg.reply,Kf,{reply:`${k.muxSubscriptions.baseInbox}${h.token}`})}catch(N){h.cancel(N)}try{await Promise.race([h.timer,h.deferred]),u.resolve(!0)}catch(N){h.cancel(N),u.reject(N)}}else u.resolve(!1);return u}ack(){this.doAck(Kf)}nak(n){let u=V0;n&&(u=pd().encode(`-NAK ${JSON.stringify({delay:Bi(n)})}`)),this.doAck(u)}working(){this.doAck(Jl)}next(n,u={batch:1}){const _={};_.batch=u.batch||1,_.no_wait=u.no_wait||!1,u.expires&&u.expires>0&&(_.expires=Bi(u.expires));const x=Vs().encode(_),k=Za.concat(q0,H0,x),S=n?{reply:n}:void 0;this.msg.respond(k,S)}term(n=""){let u=G0;(n==null?void 0:n.length)>0&&(u=pd().encode(`+TERM ${n}`)),this.doAck(u)}json(){return this.msg.json()}string(){return this.msg.string()}}const hx="1.29.2",ux="nats.ws";class dx{constructor(){U(this,"version");U(this,"lang");U(this,"closeError");U(this,"connected");U(this,"done");U(this,"socket");U(this,"options");U(this,"socketClosed");U(this,"encrypted");U(this,"peeked");U(this,"yields");U(this,"signal");U(this,"closedNotification");this.version=hx,this.lang=ux,this.connected=!1,this.done=!1,this.socketClosed=!1,this.encrypted=!1,this.peeked=!1,this.yields=[],this.signal=Di(),this.closedNotification=Di()}async connect(n,u){const _=Di();if(u.tls)return _.reject(new ht("tls",He.InvalidOption)),_;this.options=u;const x=n.src;if(u.wsFactory){const{socket:k,encrypted:S}=await u.wsFactory(n.src,u);this.socket=k,this.encrypted=S}else this.encrypted=x.indexOf("wss://")===0,this.socket=new WebSocket(x);return this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{this.isDiscarded()},this.socket.onmessage=k=>{if(this.isDiscarded())return;if(this.yields.push(new Uint8Array(k.data)),this.peeked){this.signal.resolve();return}const S=Za.concat(...this.yields),h=Ky(S);if(h!==""){const N=T0.exec(h);if(!N){u.debug&&console.error("!!!",yh(S)),_.reject(new Error("unexpected response from server"));return}try{const q=JSON.parse(N[1]);S0(q,this.options),this.peeked=!0,this.connected=!0,this.signal.resolve(),_.resolve()}catch(q){_.reject(q);return}}},this.socket.onclose=k=>{if(this.isDiscarded())return;this.socketClosed=!0;let S;this.done||(k.wasClean||(S=new Error(k.reason)),this._closed(S))},this.socket.onerror=k=>{if(this.isDiscarded())return;const S=k,h=new ht(S.message,He.Unknown,new Error(S.error));_.reject(h)},_}disconnect(){this._closed(void 0,!0)}async _closed(n,u=!0){if(!this.isDiscarded()&&this.connected&&!this.done){if(this.closeError=n,!n)for(;!this.socketClosed&&this.socket.bufferedAmount>0;)await Wa(100);this.done=!0;try{this.socket.close(n?1002:1e3,n?n.message:void 0)}catch{}u&&this.closedNotification.resolve(n)}}get isClosed(){return this.done}[Symbol.asyncIterator](){return this.iterate()}async*iterate(){for(;;){if(this.isDiscarded())return;this.yields.length===0&&await this.signal;const n=this.yields;this.yields=[];for(let u=0;u<n.length;u++)this.options.debug&&console.info(`> ${yh(n[u])}`),yield n[u];if(this.done)break;this.yields.length===0&&(n.length=0,this.yields=n,this.signal=Di())}}isEncrypted(){return this.connected&&this.encrypted}send(n){if(!this.isDiscarded())try{this.socket.send(n.buffer),this.options.debug&&console.info(`< ${yh(n)}`);return}catch(u){this.options.debug&&console.error(`!!! ${yh(n)}: ${u}`)}}close(n){return this._closed(n,!1)}closed(){return this.closedNotification}isDiscarded(){return this.done?(this.discard(),!0):!1}discard(){var n;this.done=!0;try{(n=this.socket)==null||n.close()}catch{}}}function px(g,n){/^(.*:\/\/)(.*)/.test(g)||(typeof n=="boolean"?g=`${n===!0?"https":"http"}://${g}`:g=`https://${g}`);let _=new URL(g);const x=_.protocol.toLowerCase();x==="ws:"&&(n=!1),x==="wss:"&&(n=!0),x!=="https:"&&x!=="http"&&(g=g.replace(/^(.*:\/\/)(.*)/gm,"$2"),_=new URL(`http://${g}`));let k,S;const h=_.hostname,N=_.pathname,q=_.search||"";switch(x){case"http:":case"ws:":case"nats:":S=_.port||"80",k="ws:";break;case"https:":case"wss:":case"tls:":S=_.port||"443",k="wss:";break;default:S=_.port||n===!0?"443":"80",k=n===!0?"wss:":"ws:";break}return`${k}//${h}:${S}${N}${q}`}function fx(g={}){return Hy({defaultPort:443,urlParseFn:px,factory:()=>new dx}),jd.connect(g)}const mx=pd(),_x="---";class gx{constructor(n=!0){U(this,"isConnected",Gi(!1));U(this,"vehicles",Gi({}));U(this,"stops",Gi({}));U(this,"trips",Gi({}));U(this,"subscriptions",Gi({}));U(this,"subscriptionsQueue",{});U(this,"nc");U(this,"js",Gi());n&&this.load()}async load(){this.nc=await fx({servers:[Xg],waitOnFirstConnect:!0,maxReconnectAttempts:-1}),this.isConnected.value=!0,this.js.value=this.nc.jetstream(),await this.processSubscriptionsQueue(),(async()=>{if(!this.nc)throw new Error("NATS connection is not initialized");for await(const n of this.nc.status())n.type===Ns.Disconnect&&(this.isConnected.value=!1),n.type===Ns.Reconnect&&(this.isConnected.value=!0,await this.processSubscriptionsQueue())})()}async subscribe(n,u){if(this.subscriptions.value[n])return;if(!this.isConnected.value||!this.js.value){this.subscriptionsQueue[n]=u;return}let _=()=>{};this.subscriptions.value[n]={pending:new Promise(S=>{_=S})};const x=zn();x.deliverTo(nn()),x.deliverAll(),x.ackNone(),x.replayInstantly();const k=await this.js.value.subscribe(n,x);this.subscriptions.value[n].subscription=k,_(),(async()=>{for await(const S of k){const h=mx.decode(S.data);if(h!==_x){const N=JSON.parse(h);h!==JSON.stringify(u.value[N.id])&&(u.value=Object.freeze({...u.value,[N.id]:Object.freeze(N)}))}}})()}async unsubscribe(n){var u,_;if(this.subscriptions.value[n]){const{pending:x}=this.subscriptions.value[n];x&&await x,(_=(u=this.subscriptions.value[n])==null?void 0:u.subscription)==null||_.unsubscribe(),delete this.subscriptions.value[n]}this.subscriptionsQueue[n]&&delete this.subscriptionsQueue[n]}async processSubscriptionsQueue(){await Promise.all(Object.keys(this.subscriptionsQueue).map(async n=>{await this.subscribe(n,this.subscriptionsQueue[n]),delete this.subscriptionsQueue[n]}))}useStops(){return this.subscribe("data.map.stop.>",this.stops),{stops:_i(()=>Object.values(this.stops.value)),loading:Gi(!1),unsubscribe:async()=>{await this.unsubscribe("data.map.stop.>")}}}useVehicles(){return this.subscribe("data.map.vehicle.>",this.vehicles),{vehicles:_i(()=>Object.values(this.vehicles.value)),loading:Gi(!1),unsubscribe:async()=>{await this.unsubscribe("data.map.vehicle.>")}}}useStop(n){return n&&this.subscribe(`data.map.stop.${n.value}`,this.stops),io(n,async(u,_)=>{_&&await this.unsubscribe(`data.map.stop.${_}`),u&&await this.subscribe(`data.map.stop.${u}`,this.stops)}),{stop:_i(()=>n.value?this.stops.value[n.value]??null:null),loading:Gi(!1),unsubscribe:async()=>{await this.unsubscribe(`data.map.stop.${n.value}`)}}}useVehicle(n){return n&&this.subscribe(`data.map.vehicle.${n.value}`,this.vehicles),io(n,async(u,_)=>{_&&await this.unsubscribe(`data.map.vehicle.${_}`),u&&await this.subscribe(`data.map.vehicle.${u}`,this.vehicles)}),{vehicle:_i(()=>n.value?this.vehicles.value[n.value]??null:null),loading:Gi(!1),unsubscribe:async()=>{await this.unsubscribe(`data.map.vehicle.${n.value}`)}}}useTrip(n){return n.value&&this.subscribe(`data.map.trip.${n.value}`,this.trips),io(n,async(u,_)=>{_&&await this.unsubscribe(`data.map.trip.${_}`),u&&await this.subscribe(`data.map.trip.${u}`,this.trips)}),{trip:_i(()=>n.value?this.trips.value[n.value]??null:null),loading:Gi(!1),unsubscribe:async()=>{await this.unsubscribe(`data.map.trip.${n.value}`)}}}}const Mn=new gx,yx={class:"absolute top-0 left-0 right-0 mx-2 mt-2 h-12 flex rounded-md py-1 pr-1 gap-x-1 items-center justify-between bg-white border-1 border-gray-200 shadow-xl z-20 md:transform md:-translate-x-1/2 md:right-auto md:left-1/2 md:w-96 dark:bg-dark-400 dark:text-gray-300 dark:border-dark-800"},xx=["alt"],vx={key:0,class:"flex flex-grow h-full"},bx=["value","title","placeholder"],wx={key:1,class:"flex gap-x-2 mr-2 items-center"},Sx=qs({__name:"AppBar",props:{searchInput:{}},emits:["update:search-input"],setup(g,{emit:n}){const u=g,_=n,{isConnected:x}=Mn,{t:k}=Go(),S=cm(),h=hm(),{needRefresh:N,updateServiceWorker:q}=_y(),ne=Uo(u,"searchInput"),J=_i({get(){return ne.value},set(G){_("update:search-input",G),G.length>0&&S.name!=="search"&&h.push({name:"search"}),G.length===0&&S.name==="search"&&h.push({name:"home"})}});return(G,ve)=>{const Ee=lc("router-link"),$e=fy,_t=uy;return Le(),mt("div",yx,[Vi(Ee,{to:{name:"home"},class:"p-2"},{default:tr(()=>[Qe("img",{alt:st(k)("logo_alt"),src:ry,class:"w-6 h-6"},null,8,xx)]),_:1}),st(x)?(Le(),mt("div",vx,[Qe("input",{value:J.value,type:"text",class:"bg-transparent p-2 border border-transparent focus:outline-none focus-visible:outline-none focus-visible:rounded-md focus-visible:border-gray-300 focus-visible:border-opacity-50 w-full h-full",title:st(k)("search"),placeholder:`${st(k)("search")} ...`,autofocus:"",onInput:ve[0]||(ve[0]=Tt=>J.value=Tt.currentTarget.value),onKeydown:ve[1]||(ve[1]=Jg(Tt=>G.$router.back(),["escape"])),onClick:ve[2]||(ve[2]=Tt=>G.$router.push({name:"search"}))},null,40,bx)])):(Le(),mt("div",wx,[Qe("span",null,hi(st(k)("no_connection")),1),Vi($e,{class:"text-red-600"})])),st(N)?(Le(),Ft(Na,{key:2,class:"h-full gap-x-1",onClick:ve[3]||(ve[3]=Tt=>st(q)(!0))},{default:tr(()=>[Vi(_t),Qe("span",null,hi(st(k)("update")),1)]),_:1})):zi("",!0)])}}});var Eh={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v4.7.1/LICENSE.txt
 */var Ix=Eh.exports,Qf;function Tx(){return Qf||(Qf=1,function(g,n){(function(u,_){g.exports=_()})(Ix,function(){var u={},_={};function x(S,h,N){if(_[S]=N,S==="index"){var q="var sharedModule = {}; ("+_.shared+")(sharedModule); ("+_.worker+")(sharedModule);",ne={};return _.shared(ne),_.index(u,ne),typeof window<"u"&&u.setWorkerUrl(window.URL.createObjectURL(new Blob([q],{type:"text/javascript"}))),u}}x("shared",["exports"],function(S){function h(i,t,r,o){return new(r||(r=Promise))(function(c,f){function m(T){try{b(o.next(T))}catch(E){f(E)}}function y(T){try{b(o.throw(T))}catch(E){f(E)}}function b(T){var E;T.done?c(T.value):(E=T.value,E instanceof r?E:new r(function(P){P(E)})).then(m,y)}b((o=o.apply(i,t||[])).next())})}function N(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}typeof SuppressedError=="function"&&SuppressedError;var q=ne;function ne(i,t){this.x=i,this.y=t}ne.prototype={clone:function(){return new ne(this.x,this.y)},add:function(i){return this.clone()._add(i)},sub:function(i){return this.clone()._sub(i)},multByPoint:function(i){return this.clone()._multByPoint(i)},divByPoint:function(i){return this.clone()._divByPoint(i)},mult:function(i){return this.clone()._mult(i)},div:function(i){return this.clone()._div(i)},rotate:function(i){return this.clone()._rotate(i)},rotateAround:function(i,t){return this.clone()._rotateAround(i,t)},matMult:function(i){return this.clone()._matMult(i)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(i){return this.x===i.x&&this.y===i.y},dist:function(i){return Math.sqrt(this.distSqr(i))},distSqr:function(i){var t=i.x-this.x,r=i.y-this.y;return t*t+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith:function(i){return this.angleWithSep(i.x,i.y)},angleWithSep:function(i,t){return Math.atan2(this.x*t-this.y*i,this.x*i+this.y*t)},_matMult:function(i){var t=i[2]*this.x+i[3]*this.y;return this.x=i[0]*this.x+i[1]*this.y,this.y=t,this},_add:function(i){return this.x+=i.x,this.y+=i.y,this},_sub:function(i){return this.x-=i.x,this.y-=i.y,this},_mult:function(i){return this.x*=i,this.y*=i,this},_div:function(i){return this.x/=i,this.y/=i,this},_multByPoint:function(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint:function(i){return this.x/=i.x,this.y/=i.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var i=this.y;return this.y=this.x,this.x=-i,this},_rotate:function(i){var t=Math.cos(i),r=Math.sin(i),o=r*this.x+t*this.y;return this.x=t*this.x-r*this.y,this.y=o,this},_rotateAround:function(i,t){var r=Math.cos(i),o=Math.sin(i),c=t.y+o*(this.x-t.x)+r*(this.y-t.y);return this.x=t.x+r*(this.x-t.x)-o*(this.y-t.y),this.y=c,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},ne.convert=function(i){return i instanceof ne?i:Array.isArray(i)?new ne(i[0],i[1]):i};var J=N(q),G=ve;function ve(i,t,r,o){this.cx=3*i,this.bx=3*(r-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(o-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=t,this.p2x=r,this.p2y=o}ve.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,t){if(t===void 0&&(t=1e-6),i<0)return 0;if(i>1)return 1;for(var r=i,o=0;o<8;o++){var c=this.sampleCurveX(r)-i;if(Math.abs(c)<t)return r;var f=this.sampleCurveDerivativeX(r);if(Math.abs(f)<1e-6)break;r-=c/f}var m=0,y=1;for(r=i,o=0;o<20&&(c=this.sampleCurveX(r),!(Math.abs(c-i)<t));o++)i>c?m=r:y=r,r=.5*(y-m)+m;return r},solve:function(i,t){return this.sampleCurveY(this.solveCurveX(i,t))}};var Ee=N(G);let $e,_t;function Tt(){return $e==null&&($e=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),$e}function xt(){if(_t==null&&(_t=!1,Tt())){const t=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(t){for(let o=0;o<5*5;o++){const c=4*o;t.fillStyle=`rgb(${c},${c+1},${c+2})`,t.fillRect(o%5,Math.floor(o/5),1,1)}const r=t.getImageData(0,0,5,5).data;for(let o=0;o<5*5*4;o++)if(o%4!=3&&r[o]!==o){_t=!0;break}}}return _t||!1}function Ct(i,t,r,o){const c=new Ee(i,t,r,o);return f=>c.solve(f)}const Li=Ct(.25,.1,.25,1);function Yt(i,t,r){return Math.min(r,Math.max(t,i))}function Vt(i,t,r){const o=r-t,c=((i-t)%o+o)%o+t;return c===t?r:c}function yt(i,...t){for(const r of t)for(const o in r)i[o]=r[o];return i}let ri=1;function Bt(i,t,r){const o={};for(const c in i)o[c]=t.call(this,i[c],c,i);return o}function ji(i,t,r){const o={};for(const c in i)t.call(this,i[c],c,i)&&(o[c]=i[c]);return o}function Lt(i){return Array.isArray(i)?i.map(Lt):typeof i=="object"&&i?Bt(i,Lt):i}const kt={};function pi(i){kt[i]||(typeof console<"u"&&console.warn(i),kt[i]=!0)}function De(i,t,r){return(r.y-i.y)*(t.x-i.x)>(t.y-i.y)*(r.x-i.x)}function Ut(i){return typeof WorkerGlobalScope<"u"&&i!==void 0&&i instanceof WorkerGlobalScope}let ni=null;function oi(i){return typeof ImageBitmap<"u"&&i instanceof ImageBitmap}const ws="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function Ni(i,t,r,o,c){return h(this,void 0,void 0,function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const f=new VideoFrame(i,{timestamp:0});try{const m=f==null?void 0:f.format;if(!m||!m.startsWith("BGR")&&!m.startsWith("RGB"))throw new Error(`Unrecognized format ${m}`);const y=m.startsWith("BGR"),b=new Uint8ClampedArray(o*c*4);if(yield f.copyTo(b,function(T,E,P,z,R){const F=4*Math.max(-E,0),$=(Math.max(0,P)-P)*z*4+F,Q=4*z,ie=Math.max(0,E),_e=Math.max(0,P);return{rect:{x:ie,y:_e,width:Math.min(T.width,E+z)-ie,height:Math.min(T.height,P+R)-_e},layout:[{offset:$,stride:Q}]}}(i,t,r,o,c)),y)for(let T=0;T<b.length;T+=4){const E=b[T];b[T]=b[T+2],b[T+2]=E}return b}finally{f.close()}})}let si,gi;const Zi="AbortError";function Dr(){return new Error(Zi)}const Yr={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function Lr(i){return Yr.REGISTERED_PROTOCOLS[i.substring(0,i.indexOf("://"))]}const Ss="global-dispatcher";class wi extends Error{constructor(t,r,o,c){super(`AJAXError: ${r} (${t}): ${o}`),this.status=t,this.statusText=r,this.url=o,this.body=c}}const ki=()=>Ut(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,Mt=function(i,t){if(/:\/\//.test(i.url)&&!/^https?:|^file:/.test(i.url)){const o=Lr(i.url);if(o)return o(i,t);if(Ut(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:i,targetMapId:Ss},t)}if(!(/^file:/.test(r=i.url)||/^file:/.test(ki())&&!/^\w+:/.test(r))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(o,c){return h(this,void 0,void 0,function*(){const f=new Request(o.url,{method:o.method||"GET",body:o.body,credentials:o.credentials,headers:o.headers,cache:o.cache,referrer:ki(),signal:c.signal});o.type!=="json"||f.headers.has("Accept")||f.headers.set("Accept","application/json");const m=yield fetch(f);if(!m.ok){const T=yield m.blob();throw new wi(m.status,m.statusText,o.url,T)}let y;y=o.type==="arrayBuffer"||o.type==="image"?m.arrayBuffer():o.type==="json"?m.json():m.text();const b=yield y;if(c.signal.aborted)throw Dr();return{data:b,cacheControl:m.headers.get("Cache-Control"),expires:m.headers.get("Expires")}})}(i,t);if(Ut(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:i,mustQueue:!0,targetMapId:Ss},t)}var r;return function(o,c){return new Promise((f,m)=>{var y;const b=new XMLHttpRequest;b.open(o.method||"GET",o.url,!0),o.type!=="arrayBuffer"&&o.type!=="image"||(b.responseType="arraybuffer");for(const T in o.headers)b.setRequestHeader(T,o.headers[T]);o.type==="json"&&(b.responseType="text",!((y=o.headers)===null||y===void 0)&&y.Accept||b.setRequestHeader("Accept","application/json")),b.withCredentials=o.credentials==="include",b.onerror=()=>{m(new Error(b.statusText))},b.onload=()=>{if(!c.signal.aborted)if((b.status>=200&&b.status<300||b.status===0)&&b.response!==null){let T=b.response;if(o.type==="json")try{T=JSON.parse(b.response)}catch(E){return void m(E)}f({data:T,cacheControl:b.getResponseHeader("Cache-Control"),expires:b.getResponseHeader("Expires")})}else{const T=new Blob([b.response],{type:b.getResponseHeader("Content-Type")});m(new wi(b.status,b.statusText,o.url,T))}},c.signal.addEventListener("abort",()=>{b.abort(),m(Dr())}),b.send(o.body)})}(i,t)};function $i(i){if(!i||i.indexOf("://")<=0||i.indexOf("data:image/")===0||i.indexOf("blob:")===0)return!0;const t=new URL(i),r=window.location;return t.protocol===r.protocol&&t.host===r.host}function Gs(i,t,r){r[i]&&r[i].indexOf(t)!==-1||(r[i]=r[i]||[],r[i].push(t))}function Hr(i,t,r){if(r&&r[i]){const o=r[i].indexOf(t);o!==-1&&r[i].splice(o,1)}}class Rr{constructor(t,r={}){yt(this,r),this.type=t}}class Or extends Rr{constructor(t,r={}){super("error",yt({error:t},r))}}class zs{on(t,r){return this._listeners=this._listeners||{},Gs(t,r,this._listeners),this}off(t,r){return Hr(t,r,this._listeners),Hr(t,r,this._oneTimeListeners),this}once(t,r){return r?(this._oneTimeListeners=this._oneTimeListeners||{},Gs(t,r,this._oneTimeListeners),this):new Promise(o=>this.once(t,o))}fire(t,r){typeof t=="string"&&(t=new Rr(t,r||{}));const o=t.type;if(this.listens(o)){t.target=this;const c=this._listeners&&this._listeners[o]?this._listeners[o].slice():[];for(const y of c)y.call(this,t);const f=this._oneTimeListeners&&this._oneTimeListeners[o]?this._oneTimeListeners[o].slice():[];for(const y of f)Hr(o,y,this._oneTimeListeners),y.call(this,t);const m=this._eventedParent;m&&(yt(t,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),m.fire(t))}else t instanceof Or&&console.error(t.error);return this}listens(t){return this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t)}setEventedParent(t,r){return this._eventedParent=t,this._eventedParentData=r,this}}var be={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"enum",default:"mercator",values:{mercator:{},globe:{}}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const Is=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function on(i,t){const r={};for(const o in i)o!=="ref"&&(r[o]=i[o]);return Is.forEach(o=>{o in t&&(r[o]=t[o])}),r}function Gt(i,t){if(Array.isArray(i)){if(!Array.isArray(t)||i.length!==t.length)return!1;for(let r=0;r<i.length;r++)if(!Gt(i[r],t[r]))return!1;return!0}if(typeof i=="object"&&i!==null&&t!==null){if(typeof t!="object"||Object.keys(i).length!==Object.keys(t).length)return!1;for(const r in i)if(!Gt(i[r],t[r]))return!1;return!0}return i===t}function Si(i,t){i.push(t)}function Qr(i,t,r){Si(r,{command:"addSource",args:[i,t[i]]})}function es(i,t,r){Si(t,{command:"removeSource",args:[i]}),r[i]=!0}function vr(i,t,r,o){es(i,r,o),Qr(i,t,r)}function Ki(i,t,r){let o;for(o in i[r])if(Object.prototype.hasOwnProperty.call(i[r],o)&&o!=="data"&&!Gt(i[r][o],t[r][o]))return!1;for(o in t[r])if(Object.prototype.hasOwnProperty.call(t[r],o)&&o!=="data"&&!Gt(i[r][o],t[r][o]))return!1;return!0}function br(i,t,r,o,c,f){i=i||{},t=t||{};for(const m in i)Object.prototype.hasOwnProperty.call(i,m)&&(Gt(i[m],t[m])||r.push({command:f,args:[o,m,t[m],c]}));for(const m in t)Object.prototype.hasOwnProperty.call(t,m)&&!Object.prototype.hasOwnProperty.call(i,m)&&(Gt(i[m],t[m])||r.push({command:f,args:[o,m,t[m],c]}))}function an(i){return i.id}function ln(i,t){return i[t.id]=t,i}class Oe{constructor(t,r,o,c){this.message=(t?`${t}: `:"")+o,c&&(this.identifier=c),r!=null&&r.__line__&&(this.line=r.__line__)}}function Zr(i,...t){for(const r of t)for(const o in r)i[o]=r[o];return i}class Yi extends Error{constructor(t,r){super(r),this.message=r,this.key=t}}class Wr{constructor(t,r=[]){this.parent=t,this.bindings={};for(const[o,c]of r)this.bindings[o]=c}concat(t){return new Wr(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}const ts={kind:"null"},je={kind:"number"},St={kind:"string"},pt={kind:"boolean"},Qi={kind:"color"},ur={kind:"object"},vt={kind:"value"},dr={kind:"collator"},Fr={kind:"formatted"},Br={kind:"padding"},wr={kind:"resolvedImage"},te={kind:"variableAnchorOffsetCollection"};function D(i,t){return{kind:"array",itemType:i,N:t}}function L(i){if(i.kind==="array"){const t=L(i.itemType);return typeof i.N=="number"?`array<${t}, ${i.N}>`:i.itemType.kind==="value"?"array":`array<${t}>`}return i.kind}const j=[ts,je,St,pt,Qi,Fr,ur,D(vt),Br,wr,te];function K(i,t){if(t.kind==="error")return null;if(i.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!K(i.itemType,t.itemType))&&(typeof i.N!="number"||i.N===t.N))return null}else{if(i.kind===t.kind)return null;if(i.kind==="value"){for(const r of j)if(!K(r,t))return null}}return`Expected ${L(i)} but found ${L(t)} instead.`}function le(i,t){return t.some(r=>r.kind===i.kind)}function he(i,t){return t.some(r=>r==="null"?i===null:r==="array"?Array.isArray(i):r==="object"?i&&!Array.isArray(i)&&typeof i=="object":r===typeof i)}function fe(i,t){return i.kind==="array"&&t.kind==="array"?i.itemType.kind===t.itemType.kind&&typeof i.N=="number":i.kind===t.kind}const oe=.96422,we=.82521,Pe=4/29,xe=6/29,Fe=3*xe*xe,ot=xe*xe*xe,ut=Math.PI/180,qt=180/Math.PI;function gt(i){return(i%=360)<0&&(i+=360),i}function zt([i,t,r,o]){let c,f;const m=Ii((.2225045*(i=Et(i))+.7168786*(t=Et(t))+.0606169*(r=Et(r)))/1);i===t&&t===r?c=f=m:(c=Ii((.4360747*i+.3850649*t+.1430804*r)/oe),f=Ii((.0139322*i+.0971045*t+.7141733*r)/we));const y=116*m-16;return[y<0?0:y,500*(c-m),200*(m-f),o]}function Et(i){return i<=.04045?i/12.92:Math.pow((i+.055)/1.055,2.4)}function Ii(i){return i>ot?Math.pow(i,1/3):i/Fe+Pe}function fi([i,t,r,o]){let c=(i+16)/116,f=isNaN(t)?c:c+t/500,m=isNaN(r)?c:c-r/200;return c=1*Xt(c),f=oe*Xt(f),m=we*Xt(m),[At(3.1338561*f-1.6168667*c-.4906146*m),At(-.9787684*f+1.9161415*c+.033454*m),At(.0719453*f-.2289914*c+1.4052427*m),o]}function At(i){return(i=i<=.00304?12.92*i:1.055*Math.pow(i,1/2.4)-.055)<0?0:i>1?1:i}function Xt(i){return i>xe?i*i*i:Fe*(i-Pe)}function jt(i){return parseInt(i.padEnd(2,i),16)/255}function Ri(i,t){return B(t?i/100:i,0,1)}function B(i,t,r){return Math.min(Math.max(t,i),r)}function W(i){return!i.some(Number.isNaN)}const Z={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};class X{constructor(t,r,o,c=1,f=!0){this.r=t,this.g=r,this.b=o,this.a=c,f||(this.r*=c,this.g*=c,this.b*=c,c||this.overwriteGetter("rgb",[t,r,o,c]))}static parse(t){if(t instanceof X)return t;if(typeof t!="string")return;const r=function(o){if((o=o.toLowerCase().trim())==="transparent")return[0,0,0,0];const c=Z[o];if(c){const[m,y,b]=c;return[m/255,y/255,b/255,1]}if(o.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(o)){const m=o.length<6?1:2;let y=1;return[jt(o.slice(y,y+=m)),jt(o.slice(y,y+=m)),jt(o.slice(y,y+=m)),jt(o.slice(y,y+m)||"ff")]}if(o.startsWith("rgb")){const m=o.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(m){const[y,b,T,E,P,z,R,F,$,Q,ie,_e]=m,ce=[E||" ",R||" ",Q].join("");if(ce==="  "||ce==="  /"||ce===",,"||ce===",,,"){const me=[T,z,$].join(""),Se=me==="%%%"?100:me===""?255:0;if(Se){const ze=[B(+b/Se,0,1),B(+P/Se,0,1),B(+F/Se,0,1),ie?Ri(+ie,_e):1];if(W(ze))return ze}}return}}const f=o.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(f){const[m,y,b,T,E,P,z,R,F]=f,$=[b||" ",E||" ",z].join("");if($==="  "||$==="  /"||$===",,"||$===",,,"){const Q=[+y,B(+T,0,100),B(+P,0,100),R?Ri(+R,F):1];if(W(Q))return function([ie,_e,ce,me]){function Se(ze){const We=(ze+ie/30)%12,ft=_e*Math.min(ce,1-ce);return ce-ft*Math.max(-1,Math.min(We-3,9-We,1))}return ie=gt(ie),_e/=100,ce/=100,[Se(0),Se(8),Se(4),me]}(Q)}}}(t);return r?new X(...r,!1):void 0}get rgb(){const{r:t,g:r,b:o,a:c}=this,f=c||1/0;return this.overwriteGetter("rgb",[t/f,r/f,o/f,c])}get hcl(){return this.overwriteGetter("hcl",function(t){const[r,o,c,f]=zt(t),m=Math.sqrt(o*o+c*c);return[Math.round(1e4*m)?gt(Math.atan2(c,o)*qt):NaN,m,r,f]}(this.rgb))}get lab(){return this.overwriteGetter("lab",zt(this.rgb))}overwriteGetter(t,r){return Object.defineProperty(this,t,{value:r}),r}toString(){const[t,r,o,c]=this.rgb;return`rgba(${[t,r,o].map(f=>Math.round(255*f)).join(",")},${c})`}}X.black=new X(0,0,0,1),X.white=new X(1,1,1,1),X.transparent=new X(0,0,0,0),X.red=new X(1,0,0,1);class de{constructor(t,r,o){this.sensitivity=t?r?"variant":"case":r?"accent":"base",this.locale=o,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,r){return this.collator.compare(t,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class ge{constructor(t,r,o,c,f){this.text=t,this.image=r,this.scale=o,this.fontStack=c,this.textColor=f}}class Ae{constructor(t){this.sections=t}static fromString(t){return new Ae([new ge(t,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(t=>t.text.length!==0||t.image&&t.image.name.length!==0)}static factory(t){return t instanceof Ae?t:Ae.fromString(t)}toString(){return this.sections.length===0?"":this.sections.map(t=>t.text).join("")}}class Me{constructor(t){this.values=t.slice()}static parse(t){if(t instanceof Me)return t;if(typeof t=="number")return new Me([t,t,t,t]);if(Array.isArray(t)&&!(t.length<1||t.length>4)){for(const r of t)if(typeof r!="number")return;switch(t.length){case 1:t=[t[0],t[0],t[0],t[0]];break;case 2:t=[t[0],t[1],t[0],t[1]];break;case 3:t=[t[0],t[1],t[2],t[1]]}return new Me(t)}}toString(){return JSON.stringify(this.values)}}const Ie=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class Te{constructor(t){this.values=t.slice()}static parse(t){if(t instanceof Te)return t;if(Array.isArray(t)&&!(t.length<1)&&t.length%2==0){for(let r=0;r<t.length;r+=2){const o=t[r],c=t[r+1];if(typeof o!="string"||!Ie.has(o)||!Array.isArray(c)||c.length!==2||typeof c[0]!="number"||typeof c[1]!="number")return}return new Te(t)}}toString(){return JSON.stringify(this.values)}}class Ke{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new Ke({name:t,available:!1}):null}}function Rt(i,t,r,o){return typeof i=="number"&&i>=0&&i<=255&&typeof t=="number"&&t>=0&&t<=255&&typeof r=="number"&&r>=0&&r<=255?o===void 0||typeof o=="number"&&o>=0&&o<=1?null:`Invalid rgba value [${[i,t,r,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof o=="number"?[i,t,r,o]:[i,t,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Qt(i){if(i===null||typeof i=="string"||typeof i=="boolean"||typeof i=="number"||i instanceof X||i instanceof de||i instanceof Ae||i instanceof Me||i instanceof Te||i instanceof Ke)return!0;if(Array.isArray(i)){for(const t of i)if(!Qt(t))return!1;return!0}if(typeof i=="object"){for(const t in i)if(!Qt(i[t]))return!1;return!0}return!1}function Jt(i){if(i===null)return ts;if(typeof i=="string")return St;if(typeof i=="boolean")return pt;if(typeof i=="number")return je;if(i instanceof X)return Qi;if(i instanceof de)return dr;if(i instanceof Ae)return Fr;if(i instanceof Me)return Br;if(i instanceof Te)return te;if(i instanceof Ke)return wr;if(Array.isArray(i)){const t=i.length;let r;for(const o of i){const c=Jt(o);if(r){if(r===c)continue;r=vt;break}r=c}return D(r||vt,t)}return ur}function Xr(i){const t=typeof i;return i===null?"":t==="string"||t==="number"||t==="boolean"?String(i):i instanceof X||i instanceof Ae||i instanceof Me||i instanceof Te||i instanceof Ke?i.toString():JSON.stringify(i)}class is{constructor(t,r){this.type=t,this.value=r}static parse(t,r){if(t.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Qt(t[1]))return r.error("invalid value");const o=t[1];let c=Jt(o);const f=r.expectedType;return c.kind!=="array"||c.N!==0||!f||f.kind!=="array"||typeof f.N=="number"&&f.N!==0||(c=f),new is(c,o)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}class Oi{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}}const Wo={string:St,number:je,boolean:pt,object:ur};class rs{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");let o,c=1;const f=t[0];if(f==="array"){let y,b;if(t.length>2){const T=t[1];if(typeof T!="string"||!(T in Wo)||T==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);y=Wo[T],c++}else y=vt;if(t.length>3){if(t[2]!==null&&(typeof t[2]!="number"||t[2]<0||t[2]!==Math.floor(t[2])))return r.error('The length argument to "array" must be a positive integer literal',2);b=t[2],c++}o=D(y,b)}else{if(!Wo[f])throw new Error(`Types doesn't contain name = ${f}`);o=Wo[f]}const m=[];for(;c<t.length;c++){const y=r.parse(t[c],c,vt);if(!y)return null;m.push(y)}return new rs(o,m)}evaluate(t){for(let r=0;r<this.args.length;r++){const o=this.args[r].evaluate(t);if(!K(this.type,Jt(o)))return o;if(r===this.args.length-1)throw new Oi(`Expected value to be of type ${L(this.type)}, but found ${L(Jt(o))} instead.`)}throw new Error}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}}const Ja={"to-boolean":pt,"to-color":Qi,"to-number":je,"to-string":St};class ss{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");const o=t[0];if(!Ja[o])throw new Error(`Can't parse ${o} as it is not part of the known types`);if((o==="to-boolean"||o==="to-string")&&t.length!==2)return r.error("Expected one argument.");const c=Ja[o],f=[];for(let m=1;m<t.length;m++){const y=r.parse(t[m],m,vt);if(!y)return null;f.push(y)}return new ss(c,f)}evaluate(t){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(t);case"color":{let r,o;for(const c of this.args){if(r=c.evaluate(t),o=null,r instanceof X)return r;if(typeof r=="string"){const f=t.parseColor(r);if(f)return f}else if(Array.isArray(r)&&(o=r.length<3||r.length>4?`Invalid rbga value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:Rt(r[0],r[1],r[2],r[3]),!o))return new X(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new Oi(o||`Could not parse color from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"padding":{let r;for(const o of this.args){r=o.evaluate(t);const c=Me.parse(r);if(c)return c}throw new Oi(`Could not parse padding from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"variableAnchorOffsetCollection":{let r;for(const o of this.args){r=o.evaluate(t);const c=Te.parse(r);if(c)return c}throw new Oi(`Could not parse variableAnchorOffsetCollection from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"number":{let r=null;for(const o of this.args){if(r=o.evaluate(t),r===null)return 0;const c=Number(r);if(!isNaN(c))return c}throw new Oi(`Could not convert ${JSON.stringify(r)} to number.`)}case"formatted":return Ae.fromString(Xr(this.args[0].evaluate(t)));case"resolvedImage":return Ke.fromString(Xr(this.args[0].evaluate(t)));default:return Xr(this.args[0].evaluate(t))}}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}}const $h=["Unknown","Point","LineString","Polygon"];class Xo{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?$h[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(t){let r=this._parseColorCache[t];return r||(r=this._parseColorCache[t]=X.parse(t)),r}}class cn{constructor(t,r,o=[],c,f=new Wr,m=[]){this.registry=t,this.path=o,this.key=o.map(y=>`[${y}]`).join(""),this.scope=f,this.errors=m,this.expectedType=c,this._isConstant=r}parse(t,r,o,c,f={}){return r?this.concat(r,o,c)._parse(t,f):this._parse(t,f)}_parse(t,r){function o(c,f,m){return m==="assert"?new rs(f,[c]):m==="coerce"?new ss(f,[c]):c}if(t!==null&&typeof t!="string"&&typeof t!="boolean"&&typeof t!="number"||(t=["literal",t]),Array.isArray(t)){if(t.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const c=t[0];if(typeof c!="string")return this.error(`Expression name must be a string, but found ${typeof c} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const f=this.registry[c];if(f){let m=f.parse(t,this);if(!m)return null;if(this.expectedType){const y=this.expectedType,b=m.type;if(y.kind!=="string"&&y.kind!=="number"&&y.kind!=="boolean"&&y.kind!=="object"&&y.kind!=="array"||b.kind!=="value")if(y.kind!=="color"&&y.kind!=="formatted"&&y.kind!=="resolvedImage"||b.kind!=="value"&&b.kind!=="string")if(y.kind!=="padding"||b.kind!=="value"&&b.kind!=="number"&&b.kind!=="array")if(y.kind!=="variableAnchorOffsetCollection"||b.kind!=="value"&&b.kind!=="array"){if(this.checkSubtype(y,b))return null}else m=o(m,y,r.typeAnnotation||"coerce");else m=o(m,y,r.typeAnnotation||"coerce");else m=o(m,y,r.typeAnnotation||"coerce");else m=o(m,y,r.typeAnnotation||"assert")}if(!(m instanceof is)&&m.type.kind!=="resolvedImage"&&this._isConstant(m)){const y=new Xo;try{m=new is(m.type,m.evaluate(y))}catch(b){return this.error(b.message),null}}return m}return this.error(`Unknown expression "${c}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(t===void 0?"'undefined' value invalid. Use null instead.":typeof t=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,r,o){const c=typeof t=="number"?this.path.concat(t):this.path,f=o?this.scope.concat(o):this.scope;return new cn(this.registry,this._isConstant,c,r||null,f,this.errors)}error(t,...r){const o=`${this.key}${r.map(c=>`[${c}]`).join("")}`;this.errors.push(new Yi(o,t))}checkSubtype(t,r){const o=K(t,r);return o&&this.error(o),o}}class Hs{constructor(t,r){this.type=r.type,this.bindings=[].concat(t),this.result=r}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const r of this.bindings)t(r[1]);t(this.result)}static parse(t,r){if(t.length<4)return r.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const o=[];for(let f=1;f<t.length-1;f+=2){const m=t[f];if(typeof m!="string")return r.error(`Expected string, but found ${typeof m} instead.`,f);if(/[^a-zA-Z0-9_]/.test(m))return r.error("Variable names must contain only alphanumeric characters or '_'.",f);const y=r.parse(t[f+1],f+1);if(!y)return null;o.push([m,y])}const c=r.parse(t[t.length-1],t.length-1,r.expectedType,o);return c?new Hs(o,c):null}outputDefined(){return this.result.outputDefined()}}class Wt{constructor(t,r){this.type=r.type,this.name=t,this.boundExpression=r}static parse(t,r){if(t.length!==2||typeof t[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const o=t[1];return r.scope.has(o)?new Wt(o,r.scope.get(o)):r.error(`Unknown variable "${o}". Make sure "${o}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}}class Ka{constructor(t,r,o){this.type=t,this.index=r,this.input=o}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const o=r.parse(t[1],1,je),c=r.parse(t[2],2,D(r.expectedType||vt));return o&&c?new Ka(c.type.itemType,o,c):null}evaluate(t){const r=this.index.evaluate(t),o=this.input.evaluate(t);if(r<0)throw new Oi(`Array index out of bounds: ${r} < 0.`);if(r>=o.length)throw new Oi(`Array index out of bounds: ${r} > ${o.length-1}.`);if(r!==Math.floor(r))throw new Oi(`Array index must be an integer, but found ${r} instead.`);return o[r]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}}class Ya{constructor(t,r){this.type=pt,this.needle=t,this.haystack=r}static parse(t,r){if(t.length!==3)return r.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const o=r.parse(t[1],1,vt),c=r.parse(t[2],2,vt);return o&&c?le(o.type,[pt,St,je,ts,vt])?new Ya(o,c):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${L(o.type)} instead`):null}evaluate(t){const r=this.needle.evaluate(t),o=this.haystack.evaluate(t);if(!o)return!1;if(!he(r,["boolean","string","number","null"]))throw new Oi(`Expected first argument to be of type boolean, string, number or null, but found ${L(Jt(r))} instead.`);if(!he(o,["string","array"]))throw new Oi(`Expected second argument to be of type array or string, but found ${L(Jt(o))} instead.`);return o.indexOf(r)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}}class Rn{constructor(t,r,o){this.type=je,this.needle=t,this.haystack=r,this.fromIndex=o}static parse(t,r){if(t.length<=2||t.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const o=r.parse(t[1],1,vt),c=r.parse(t[2],2,vt);if(!o||!c)return null;if(!le(o.type,[pt,St,je,ts,vt]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${L(o.type)} instead`);if(t.length===4){const f=r.parse(t[3],3,je);return f?new Rn(o,c,f):null}return new Rn(o,c)}evaluate(t){const r=this.needle.evaluate(t),o=this.haystack.evaluate(t);if(!he(r,["boolean","string","number","null"]))throw new Oi(`Expected first argument to be of type boolean, string, number or null, but found ${L(Jt(r))} instead.`);let c;if(this.fromIndex&&(c=this.fromIndex.evaluate(t)),he(o,["string"])){const f=o.indexOf(r,c);return f===-1?-1:[...o.slice(0,f)].length}if(he(o,["array"]))return o.indexOf(r,c);throw new Oi(`Expected second argument to be of type array or string, but found ${L(Jt(o))} instead.`)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}}class Qa{constructor(t,r,o,c,f,m){this.inputType=t,this.type=r,this.input=o,this.cases=c,this.outputs=f,this.otherwise=m}static parse(t,r){if(t.length<5)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return r.error("Expected an even number of arguments.");let o,c;r.expectedType&&r.expectedType.kind!=="value"&&(c=r.expectedType);const f={},m=[];for(let T=2;T<t.length-1;T+=2){let E=t[T];const P=t[T+1];Array.isArray(E)||(E=[E]);const z=r.concat(T);if(E.length===0)return z.error("Expected at least one branch label.");for(const F of E){if(typeof F!="number"&&typeof F!="string")return z.error("Branch labels must be numbers or strings.");if(typeof F=="number"&&Math.abs(F)>Number.MAX_SAFE_INTEGER)return z.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof F=="number"&&Math.floor(F)!==F)return z.error("Numeric branch labels must be integer values.");if(o){if(z.checkSubtype(o,Jt(F)))return null}else o=Jt(F);if(f[String(F)]!==void 0)return z.error("Branch labels must be unique.");f[String(F)]=m.length}const R=r.parse(P,T,c);if(!R)return null;c=c||R.type,m.push(R)}const y=r.parse(t[1],1,vt);if(!y)return null;const b=r.parse(t[t.length-1],t.length-1,c);return b?y.type.kind!=="value"&&r.concat(1).checkSubtype(o,y.type)?null:new Qa(o,c,y,f,m,b):null}evaluate(t){const r=this.input.evaluate(t);return(Jt(r)===this.inputType&&this.outputs[this.cases[r]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}}class Jo{constructor(t,r,o){this.type=t,this.branches=r,this.otherwise=o}static parse(t,r){if(t.length<4)return r.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return r.error("Expected an odd number of arguments.");let o;r.expectedType&&r.expectedType.kind!=="value"&&(o=r.expectedType);const c=[];for(let m=1;m<t.length-1;m+=2){const y=r.parse(t[m],m,pt);if(!y)return null;const b=r.parse(t[m+1],m+1,o);if(!b)return null;c.push([y,b]),o=o||b.type}const f=r.parse(t[t.length-1],t.length-1,o);if(!f)return null;if(!o)throw new Error("Can't infer output type");return new Jo(o,c,f)}evaluate(t){for(const[r,o]of this.branches)if(r.evaluate(t))return o.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[r,o]of this.branches)t(r),t(o);t(this.otherwise)}outputDefined(){return this.branches.every(([t,r])=>r.outputDefined())&&this.otherwise.outputDefined()}}class lo{constructor(t,r,o,c){this.type=t,this.input=r,this.beginIndex=o,this.endIndex=c}static parse(t,r){if(t.length<=2||t.length>=5)return r.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const o=r.parse(t[1],1,vt),c=r.parse(t[2],2,je);if(!o||!c)return null;if(!le(o.type,[D(vt),St,vt]))return r.error(`Expected first argument to be of type array or string, but found ${L(o.type)} instead`);if(t.length===4){const f=r.parse(t[3],3,je);return f?new lo(o.type,o,c,f):null}return new lo(o.type,o,c)}evaluate(t){const r=this.input.evaluate(t),o=this.beginIndex.evaluate(t);let c;if(this.endIndex&&(c=this.endIndex.evaluate(t)),he(r,["string"]))return[...r].slice(o,c).join("");if(he(r,["array"]))return r.slice(o,c);throw new Oi(`Expected first argument to be of type array or string, but found ${L(Jt(r))} instead.`)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}}function Ko(i,t){const r=i.length-1;let o,c,f=0,m=r,y=0;for(;f<=m;)if(y=Math.floor((f+m)/2),o=i[y],c=i[y+1],o<=t){if(y===r||t<c)return y;f=y+1}else{if(!(o>t))throw new Oi("Input is not a number.");m=y-1}return 0}class On{constructor(t,r,o){this.type=t,this.input=r,this.labels=[],this.outputs=[];for(const[c,f]of o)this.labels.push(c),this.outputs.push(f)}static parse(t,r){if(t.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return r.error("Expected an even number of arguments.");const o=r.parse(t[1],1,je);if(!o)return null;const c=[];let f=null;r.expectedType&&r.expectedType.kind!=="value"&&(f=r.expectedType);for(let m=1;m<t.length;m+=2){const y=m===1?-1/0:t[m],b=t[m+1],T=m,E=m+1;if(typeof y!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',T);if(c.length&&c[c.length-1][0]>=y)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',T);const P=r.parse(b,E,f);if(!P)return null;f=f||P.type,c.push([y,P])}return new On(f,o,c)}evaluate(t){const r=this.labels,o=this.outputs;if(r.length===1)return o[0].evaluate(t);const c=this.input.evaluate(t);if(c<=r[0])return o[0].evaluate(t);const f=r.length;return c>=r[f-1]?o[f-1].evaluate(t):o[Ko(r,c)].evaluate(t)}eachChild(t){t(this.input);for(const r of this.outputs)t(r)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}}function uc(i){return i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Uh=dc;function dc(i,t,r,o){this.cx=3*i,this.bx=3*(r-i)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(o-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=i,this.p1y=t,this.p2x=r,this.p2y=o}dc.prototype={sampleCurveX:function(i){return((this.ax*i+this.bx)*i+this.cx)*i},sampleCurveY:function(i){return((this.ay*i+this.by)*i+this.cy)*i},sampleCurveDerivativeX:function(i){return(3*this.ax*i+2*this.bx)*i+this.cx},solveCurveX:function(i,t){if(t===void 0&&(t=1e-6),i<0)return 0;if(i>1)return 1;for(var r=i,o=0;o<8;o++){var c=this.sampleCurveX(r)-i;if(Math.abs(c)<t)return r;var f=this.sampleCurveDerivativeX(r);if(Math.abs(f)<1e-6)break;r-=c/f}var m=0,y=1;for(r=i,o=0;o<20&&(c=this.sampleCurveX(r),!(Math.abs(c-i)<t));o++)i>c?m=r:y=r,r=.5*(y-m)+m;return r},solve:function(i,t){return this.sampleCurveY(this.solveCurveX(i,t))}};var Vh=uc(Uh);function hn(i,t,r){return i+r*(t-i)}function co(i,t,r){return i.map((o,c)=>hn(o,t[c],r))}const Sr={number:hn,color:function(i,t,r,o="rgb"){switch(o){case"rgb":{const[c,f,m,y]=co(i.rgb,t.rgb,r);return new X(c,f,m,y,!1)}case"hcl":{const[c,f,m,y]=i.hcl,[b,T,E,P]=t.hcl;let z,R;if(isNaN(c)||isNaN(b))isNaN(c)?isNaN(b)?z=NaN:(z=b,m!==1&&m!==0||(R=T)):(z=c,E!==1&&E!==0||(R=f));else{let _e=b-c;b>c&&_e>180?_e-=360:b<c&&c-b>180&&(_e+=360),z=c+r*_e}const[F,$,Q,ie]=function([_e,ce,me,Se]){return _e=isNaN(_e)?0:_e*ut,fi([me,Math.cos(_e)*ce,Math.sin(_e)*ce,Se])}([z,R??hn(f,T,r),hn(m,E,r),hn(y,P,r)]);return new X(F,$,Q,ie,!1)}case"lab":{const[c,f,m,y]=fi(co(i.lab,t.lab,r));return new X(c,f,m,y,!1)}}},array:co,padding:function(i,t,r){return new Me(co(i.values,t.values,r))},variableAnchorOffsetCollection:function(i,t,r){const o=i.values,c=t.values;if(o.length!==c.length)throw new Oi(`Cannot interpolate values of different length. from: ${i.toString()}, to: ${t.toString()}`);const f=[];for(let m=0;m<o.length;m+=2){if(o[m]!==c[m])throw new Oi(`Cannot interpolate values containing mismatched anchors. from[${m}]: ${o[m]}, to[${m}]: ${c[m]}`);f.push(o[m]);const[y,b]=o[m+1],[T,E]=c[m+1];f.push([hn(y,T,r),hn(b,E,r)])}return new Te(f)}};class Ir{constructor(t,r,o,c,f){this.type=t,this.operator=r,this.interpolation=o,this.input=c,this.labels=[],this.outputs=[];for(const[m,y]of f)this.labels.push(m),this.outputs.push(y)}static interpolationFactor(t,r,o,c){let f=0;if(t.name==="exponential")f=Yo(r,t.base,o,c);else if(t.name==="linear")f=Yo(r,1,o,c);else if(t.name==="cubic-bezier"){const m=t.controlPoints;f=new Vh(m[0],m[1],m[2],m[3]).solve(Yo(r,1,o,c))}return f}static parse(t,r){let[o,c,f,...m]=t;if(!Array.isArray(c)||c.length===0)return r.error("Expected an interpolation type expression.",1);if(c[0]==="linear")c={name:"linear"};else if(c[0]==="exponential"){const T=c[1];if(typeof T!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);c={name:"exponential",base:T}}else{if(c[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(c[0])}`,1,0);{const T=c.slice(1);if(T.length!==4||T.some(E=>typeof E!="number"||E<0||E>1))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);c={name:"cubic-bezier",controlPoints:T}}}if(t.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(f=r.parse(f,2,je),!f)return null;const y=[];let b=null;o==="interpolate-hcl"||o==="interpolate-lab"?b=Qi:r.expectedType&&r.expectedType.kind!=="value"&&(b=r.expectedType);for(let T=0;T<m.length;T+=2){const E=m[T],P=m[T+1],z=T+3,R=T+4;if(typeof E!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',z);if(y.length&&y[y.length-1][0]>=E)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',z);const F=r.parse(P,R,b);if(!F)return null;b=b||F.type,y.push([E,F])}return fe(b,je)||fe(b,Qi)||fe(b,Br)||fe(b,te)||fe(b,D(je))?new Ir(b,o,c,f,y):r.error(`Type ${L(b)} is not interpolatable.`)}evaluate(t){const r=this.labels,o=this.outputs;if(r.length===1)return o[0].evaluate(t);const c=this.input.evaluate(t);if(c<=r[0])return o[0].evaluate(t);const f=r.length;if(c>=r[f-1])return o[f-1].evaluate(t);const m=Ko(r,c),y=Ir.interpolationFactor(this.interpolation,c,r[m],r[m+1]),b=o[m].evaluate(t),T=o[m+1].evaluate(t);switch(this.operator){case"interpolate":return Sr[this.type.kind](b,T,y);case"interpolate-hcl":return Sr.color(b,T,y,"hcl");case"interpolate-lab":return Sr.color(b,T,y,"lab")}}eachChild(t){t(this.input);for(const r of this.outputs)t(r)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}}function Yo(i,t,r,o){const c=o-r,f=i-r;return c===0?0:t===1?f/c:(Math.pow(t,f)-1)/(Math.pow(t,c)-1)}class Qo{constructor(t,r){this.type=t,this.args=r}static parse(t,r){if(t.length<2)return r.error("Expectected at least one argument.");let o=null;const c=r.expectedType;c&&c.kind!=="value"&&(o=c);const f=[];for(const y of t.slice(1)){const b=r.parse(y,1+f.length,o,void 0,{typeAnnotation:"omit"});if(!b)return null;o=o||b.type,f.push(b)}if(!o)throw new Error("No output type");const m=c&&f.some(y=>K(c,y.type));return new Qo(m?vt:o,f)}evaluate(t){let r,o=null,c=0;for(const f of this.args)if(c++,o=f.evaluate(t),o&&o instanceof Ke&&!o.available&&(r||(r=o.name),o=null,c===this.args.length&&(o=r)),o!==null)break;return o}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}}function ea(i,t){return i==="=="||i==="!="?t.kind==="boolean"||t.kind==="string"||t.kind==="number"||t.kind==="null"||t.kind==="value":t.kind==="string"||t.kind==="number"||t.kind==="value"}function pc(i,t,r,o){return o.compare(t,r)===0}function Fn(i,t,r){const o=i!=="=="&&i!=="!=";return class Om{constructor(f,m,y){this.type=pt,this.lhs=f,this.rhs=m,this.collator=y,this.hasUntypedArgument=f.type.kind==="value"||m.type.kind==="value"}static parse(f,m){if(f.length!==3&&f.length!==4)return m.error("Expected two or three arguments.");const y=f[0];let b=m.parse(f[1],1,vt);if(!b)return null;if(!ea(y,b.type))return m.concat(1).error(`"${y}" comparisons are not supported for type '${L(b.type)}'.`);let T=m.parse(f[2],2,vt);if(!T)return null;if(!ea(y,T.type))return m.concat(2).error(`"${y}" comparisons are not supported for type '${L(T.type)}'.`);if(b.type.kind!==T.type.kind&&b.type.kind!=="value"&&T.type.kind!=="value")return m.error(`Cannot compare types '${L(b.type)}' and '${L(T.type)}'.`);o&&(b.type.kind==="value"&&T.type.kind!=="value"?b=new rs(T.type,[b]):b.type.kind!=="value"&&T.type.kind==="value"&&(T=new rs(b.type,[T])));let E=null;if(f.length===4){if(b.type.kind!=="string"&&T.type.kind!=="string"&&b.type.kind!=="value"&&T.type.kind!=="value")return m.error("Cannot use collator to compare non-string types.");if(E=m.parse(f[3],3,dr),!E)return null}return new Om(b,T,E)}evaluate(f){const m=this.lhs.evaluate(f),y=this.rhs.evaluate(f);if(o&&this.hasUntypedArgument){const b=Jt(m),T=Jt(y);if(b.kind!==T.kind||b.kind!=="string"&&b.kind!=="number")throw new Oi(`Expected arguments for "${i}" to be (string, string) or (number, number), but found (${b.kind}, ${T.kind}) instead.`)}if(this.collator&&!o&&this.hasUntypedArgument){const b=Jt(m),T=Jt(y);if(b.kind!=="string"||T.kind!=="string")return t(f,m,y)}return this.collator?r(f,m,y,this.collator.evaluate(f)):t(f,m,y)}eachChild(f){f(this.lhs),f(this.rhs),this.collator&&f(this.collator)}outputDefined(){return!0}}}const qh=Fn("==",function(i,t,r){return t===r},pc),fc=Fn("!=",function(i,t,r){return t!==r},function(i,t,r,o){return!pc(0,t,r,o)}),mc=Fn("<",function(i,t,r){return t<r},function(i,t,r,o){return o.compare(t,r)<0}),Gh=Fn(">",function(i,t,r){return t>r},function(i,t,r,o){return o.compare(t,r)>0}),Hh=Fn("<=",function(i,t,r){return t<=r},function(i,t,r,o){return o.compare(t,r)<=0}),_c=Fn(">=",function(i,t,r){return t>=r},function(i,t,r,o){return o.compare(t,r)>=0});class ho{constructor(t,r,o){this.type=dr,this.locale=o,this.caseSensitive=t,this.diacriticSensitive=r}static parse(t,r){if(t.length!==2)return r.error("Expected one argument.");const o=t[1];if(typeof o!="object"||Array.isArray(o))return r.error("Collator options argument must be an object.");const c=r.parse(o["case-sensitive"]!==void 0&&o["case-sensitive"],1,pt);if(!c)return null;const f=r.parse(o["diacritic-sensitive"]!==void 0&&o["diacritic-sensitive"],1,pt);if(!f)return null;let m=null;return o.locale&&(m=r.parse(o.locale,1,St),!m)?null:new ho(c,f,m)}evaluate(t){return new de(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}}class el{constructor(t,r,o,c,f){this.type=St,this.number=t,this.locale=r,this.currency=o,this.minFractionDigits=c,this.maxFractionDigits=f}static parse(t,r){if(t.length!==3)return r.error("Expected two arguments.");const o=r.parse(t[1],1,je);if(!o)return null;const c=t[2];if(typeof c!="object"||Array.isArray(c))return r.error("NumberFormat options argument must be an object.");let f=null;if(c.locale&&(f=r.parse(c.locale,1,St),!f))return null;let m=null;if(c.currency&&(m=r.parse(c.currency,1,St),!m))return null;let y=null;if(c["min-fraction-digits"]&&(y=r.parse(c["min-fraction-digits"],1,je),!y))return null;let b=null;return c["max-fraction-digits"]&&(b=r.parse(c["max-fraction-digits"],1,je),!b)?null:new el(o,f,m,y,b)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}}class ta{constructor(t){this.type=Fr,this.sections=t}static parse(t,r){if(t.length<2)return r.error("Expected at least one argument.");const o=t[1];if(!Array.isArray(o)&&typeof o=="object")return r.error("First argument must be an image or text section.");const c=[];let f=!1;for(let m=1;m<=t.length-1;++m){const y=t[m];if(f&&typeof y=="object"&&!Array.isArray(y)){f=!1;let b=null;if(y["font-scale"]&&(b=r.parse(y["font-scale"],1,je),!b))return null;let T=null;if(y["text-font"]&&(T=r.parse(y["text-font"],1,D(St)),!T))return null;let E=null;if(y["text-color"]&&(E=r.parse(y["text-color"],1,Qi),!E))return null;const P=c[c.length-1];P.scale=b,P.font=T,P.textColor=E}else{const b=r.parse(t[m],1,vt);if(!b)return null;const T=b.type.kind;if(T!=="string"&&T!=="value"&&T!=="null"&&T!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");f=!0,c.push({content:b,scale:null,font:null,textColor:null})}}return new ta(c)}evaluate(t){return new Ae(this.sections.map(r=>{const o=r.content.evaluate(t);return Jt(o)===wr?new ge("",o,null,null,null):new ge(Xr(o),null,r.scale?r.scale.evaluate(t):null,r.font?r.font.evaluate(t).join(","):null,r.textColor?r.textColor.evaluate(t):null)}))}eachChild(t){for(const r of this.sections)t(r.content),r.scale&&t(r.scale),r.font&&t(r.font),r.textColor&&t(r.textColor)}outputDefined(){return!1}}class tl{constructor(t){this.type=wr,this.input=t}static parse(t,r){if(t.length!==2)return r.error("Expected two arguments.");const o=r.parse(t[1],1,St);return o?new tl(o):r.error("No image name provided.")}evaluate(t){const r=this.input.evaluate(t),o=Ke.fromString(r);return o&&t.availableImages&&(o.available=t.availableImages.indexOf(r)>-1),o}eachChild(t){t(this.input)}outputDefined(){return!1}}class il{constructor(t){this.type=je,this.input=t}static parse(t,r){if(t.length!==2)return r.error(`Expected 1 argument, but found ${t.length-1} instead.`);const o=r.parse(t[1],1);return o?o.type.kind!=="array"&&o.type.kind!=="string"&&o.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${L(o.type)} instead.`):new il(o):null}evaluate(t){const r=this.input.evaluate(t);if(typeof r=="string")return[...r].length;if(Array.isArray(r))return r.length;throw new Oi(`Expected value to be of type string or array, but found ${L(Jt(r))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}}const Ts=8192;function Zh(i,t){const r=(180+i[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i[1]*Math.PI/360)))/360,c=Math.pow(2,t.z);return[Math.round(r*c*Ts),Math.round(o*c*Ts)]}function rl(i,t){const r=Math.pow(2,t.z);return[(c=(i[0]/Ts+t.x)/r,360*c-180),(o=(i[1]/Ts+t.y)/r,360/Math.PI*Math.atan(Math.exp((180-360*o)*Math.PI/180))-90)];var o,c}function un(i,t){i[0]=Math.min(i[0],t[0]),i[1]=Math.min(i[1],t[1]),i[2]=Math.max(i[2],t[0]),i[3]=Math.max(i[3],t[1])}function Zs(i,t){return!(i[0]<=t[0]||i[2]>=t[2]||i[1]<=t[1]||i[3]>=t[3])}function Kt(i,t,r){const o=i[0]-t[0],c=i[1]-t[1],f=i[0]-r[0],m=i[1]-r[1];return o*m-f*c==0&&o*f<=0&&c*m<=0}function ia(i,t,r,o){return(c=[o[0]-r[0],o[1]-r[1]])[0]*(f=[t[0]-i[0],t[1]-i[1]])[1]-c[1]*f[0]!=0&&!(!yc(i,t,r,o)||!yc(r,o,i,t));var c,f}function Wh(i,t,r){for(const o of r)for(let c=0;c<o.length-1;++c)if(ia(i,t,o[c],o[c+1]))return!0;return!1}function Bn(i,t,r=!1){let o=!1;for(const y of t)for(let b=0;b<y.length-1;b++){if(Kt(i,y[b],y[b+1]))return r;(f=y[b])[1]>(c=i)[1]!=(m=y[b+1])[1]>c[1]&&c[0]<(m[0]-f[0])*(c[1]-f[1])/(m[1]-f[1])+f[0]&&(o=!o)}var c,f,m;return o}function Xh(i,t){for(const r of t)if(Bn(i,r))return!0;return!1}function gc(i,t){for(const r of i)if(!Bn(r,t))return!1;for(let r=0;r<i.length-1;++r)if(Wh(i[r],i[r+1],t))return!1;return!0}function Jh(i,t){for(const r of t)if(gc(i,r))return!0;return!1}function yc(i,t,r,o){const c=o[0]-r[0],f=o[1]-r[1],m=(i[0]-r[0])*f-c*(i[1]-r[1]),y=(t[0]-r[0])*f-c*(t[1]-r[1]);return m>0&&y<0||m<0&&y>0}function sl(i,t,r){const o=[];for(let c=0;c<i.length;c++){const f=[];for(let m=0;m<i[c].length;m++){const y=Zh(i[c][m],r);un(t,y),f.push(y)}o.push(f)}return o}function xc(i,t,r){const o=[];for(let c=0;c<i.length;c++){const f=sl(i[c],t,r);o.push(f)}return o}function vc(i,t,r,o){if(i[0]<r[0]||i[0]>r[2]){const c=.5*o;let f=i[0]-r[0]>c?-o:r[0]-i[0]>c?o:0;f===0&&(f=i[0]-r[2]>c?-o:r[2]-i[0]>c?o:0),i[0]+=f}un(t,i)}function bc(i,t,r,o){const c=Math.pow(2,o.z)*Ts,f=[o.x*Ts,o.y*Ts],m=[];for(const y of i)for(const b of y){const T=[b.x+f[0],b.y+f[1]];vc(T,t,r,c),m.push(T)}return m}function wc(i,t,r,o){const c=Math.pow(2,o.z)*Ts,f=[o.x*Ts,o.y*Ts],m=[];for(const b of i){const T=[];for(const E of b){const P=[E.x+f[0],E.y+f[1]];un(t,P),T.push(P)}m.push(T)}if(t[2]-t[0]<=c/2){(y=t)[0]=y[1]=1/0,y[2]=y[3]=-1/0;for(const b of m)for(const T of b)vc(T,t,r,c)}var y;return m}class dn{constructor(t,r){this.type=pt,this.geojson=t,this.geometries=r}static parse(t,r){if(t.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Qt(t[1])){const o=t[1];if(o.type==="FeatureCollection"){const c=[];for(const f of o.features){const{type:m,coordinates:y}=f.geometry;m==="Polygon"&&c.push(y),m==="MultiPolygon"&&c.push(...y)}if(c.length)return new dn(o,{type:"MultiPolygon",coordinates:c})}else if(o.type==="Feature"){const c=o.geometry.type;if(c==="Polygon"||c==="MultiPolygon")return new dn(o,o.geometry)}else if(o.type==="Polygon"||o.type==="MultiPolygon")return new dn(o,o)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(r,o){const c=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],m=r.canonicalID();if(o.type==="Polygon"){const y=sl(o.coordinates,f,m),b=bc(r.geometry(),c,f,m);if(!Zs(c,f))return!1;for(const T of b)if(!Bn(T,y))return!1}if(o.type==="MultiPolygon"){const y=xc(o.coordinates,f,m),b=bc(r.geometry(),c,f,m);if(!Zs(c,f))return!1;for(const T of b)if(!Xh(T,y))return!1}return!0}(t,this.geometries);if(t.geometryType()==="LineString")return function(r,o){const c=[1/0,1/0,-1/0,-1/0],f=[1/0,1/0,-1/0,-1/0],m=r.canonicalID();if(o.type==="Polygon"){const y=sl(o.coordinates,f,m),b=wc(r.geometry(),c,f,m);if(!Zs(c,f))return!1;for(const T of b)if(!gc(T,y))return!1}if(o.type==="MultiPolygon"){const y=xc(o.coordinates,f,m),b=wc(r.geometry(),c,f,m);if(!Zs(c,f))return!1;for(const T of b)if(!Jh(T,y))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let Sc=class{constructor(i=[],t=(r,o)=>r<o?-1:r>o?1:0){if(this.data=i,this.length=this.data.length,this.compare=t,this.length>0)for(let r=(this.length>>1)-1;r>=0;r--)this._down(r)}push(i){this.data.push(i),this._up(this.length++)}pop(){if(this.length===0)return;const i=this.data[0],t=this.data.pop();return--this.length>0&&(this.data[0]=t,this._down(0)),i}peek(){return this.data[0]}_up(i){const{data:t,compare:r}=this,o=t[i];for(;i>0;){const c=i-1>>1,f=t[c];if(r(o,f)>=0)break;t[i]=f,i=c}t[i]=o}_down(i){const{data:t,compare:r}=this,o=this.length>>1,c=t[i];for(;i<o;){let f=1+(i<<1);const m=f+1;if(m<this.length&&r(t[m],t[f])<0&&(f=m),r(t[f],c)>=0)break;t[i]=t[f],i=f}t[i]=c}};function Kh(i,t,r,o,c){Ic(i,t,r,o||i.length-1,c)}function Ic(i,t,r,o,c){for(;o>r;){if(o-r>600){var f=o-r+1,m=t-r+1,y=Math.log(f),b=.5*Math.exp(2*y/3),T=.5*Math.sqrt(y*b*(f-b)/f)*(m-f/2<0?-1:1);Ic(i,t,Math.max(r,Math.floor(t-m*b/f+T)),Math.min(o,Math.floor(t+(f-m)*b/f+T)),c)}var E=i[t],P=r,z=o;for(uo(i,r,t),c(i[o],E)>0&&uo(i,r,o);P<z;){for(uo(i,P,z),P++,z--;c(i[P],E)<0;)P++;for(;c(i[z],E)>0;)z--}c(i[r],E)===0?uo(i,r,z):uo(i,++z,o),z<=t&&(r=z+1),t<=z&&(o=z-1)}}function uo(i,t,r){var o=i[t];i[t]=i[r],i[r]=o}function ra(i,t){if(i.length<=1)return[i];const r=[];let o,c;for(const f of i){const m=Qh(f);m!==0&&(f.area=Math.abs(m),c===void 0&&(c=m<0),c===m<0?(o&&r.push(o),o=[f]):o.push(f))}if(o&&r.push(o),t>1)for(let f=0;f<r.length;f++)r[f].length<=t||(Kh(r[f],t,1,r[f].length-1,Yh),r[f]=r[f].slice(0,t));return r}function Yh(i,t){return t.area-i.area}function Qh(i){let t=0;for(let r,o,c=0,f=i.length,m=f-1;c<f;m=c++)r=i[c],o=i[m],t+=(o.x-r.x)*(r.y+o.y);return t}const Tc=1/298.257223563,kc=Tc*(2-Tc),Ec=Math.PI/180;class nl{constructor(t){const r=6378.137*Ec*1e3,o=Math.cos(t*Ec),c=1/(1-kc*(1-o*o)),f=Math.sqrt(c);this.kx=r*f*o,this.ky=r*f*c*(1-kc)}distance(t,r){const o=this.wrap(t[0]-r[0])*this.kx,c=(t[1]-r[1])*this.ky;return Math.sqrt(o*o+c*c)}pointOnLine(t,r){let o,c,f,m,y=1/0;for(let b=0;b<t.length-1;b++){let T=t[b][0],E=t[b][1],P=this.wrap(t[b+1][0]-T)*this.kx,z=(t[b+1][1]-E)*this.ky,R=0;P===0&&z===0||(R=(this.wrap(r[0]-T)*this.kx*P+(r[1]-E)*this.ky*z)/(P*P+z*z),R>1?(T=t[b+1][0],E=t[b+1][1]):R>0&&(T+=P/this.kx*R,E+=z/this.ky*R)),P=this.wrap(r[0]-T)*this.kx,z=(r[1]-E)*this.ky;const F=P*P+z*z;F<y&&(y=F,o=T,c=E,f=b,m=R)}return{point:[o,c],index:f,t:Math.max(0,Math.min(1,m))}}wrap(t){for(;t<-180;)t+=360;for(;t>180;)t-=360;return t}}function Ac(i,t){return t[0]-i[0]}function sa(i){return i[1]-i[0]+1}function Ds(i,t){return i[1]>=i[0]&&i[1]<t}function ol(i,t){if(i[0]>i[1])return[null,null];const r=sa(i);if(t){if(r===2)return[i,null];const c=Math.floor(r/2);return[[i[0],i[0]+c],[i[0]+c,i[1]]]}if(r===1)return[i,null];const o=Math.floor(r/2)-1;return[[i[0],i[0]+o],[i[0]+o+1,i[1]]]}function al(i,t){if(!Ds(t,i.length))return[1/0,1/0,-1/0,-1/0];const r=[1/0,1/0,-1/0,-1/0];for(let o=t[0];o<=t[1];++o)un(r,i[o]);return r}function ll(i){const t=[1/0,1/0,-1/0,-1/0];for(const r of i)for(const o of r)un(t,o);return t}function Pc(i){return i[0]!==-1/0&&i[1]!==-1/0&&i[2]!==1/0&&i[3]!==1/0}function po(i,t,r){if(!Pc(i)||!Pc(t))return NaN;let o=0,c=0;return i[2]<t[0]&&(o=t[0]-i[2]),i[0]>t[2]&&(o=i[0]-t[2]),i[1]>t[3]&&(c=i[1]-t[3]),i[3]<t[1]&&(c=t[1]-i[3]),r.distance([0,0],[o,c])}function pn(i,t,r){const o=r.pointOnLine(t,i);return r.distance(i,o.point)}function cl(i,t,r,o,c){const f=Math.min(pn(i,[r,o],c),pn(t,[r,o],c)),m=Math.min(pn(r,[i,t],c),pn(o,[i,t],c));return Math.min(f,m)}function eu(i,t,r,o,c){if(!Ds(t,i.length)||!Ds(o,r.length))return 1/0;let f=1/0;for(let m=t[0];m<t[1];++m){const y=i[m],b=i[m+1];for(let T=o[0];T<o[1];++T){const E=r[T],P=r[T+1];if(ia(y,b,E,P))return 0;f=Math.min(f,cl(y,b,E,P,c))}}return f}function tu(i,t,r,o,c){if(!Ds(t,i.length)||!Ds(o,r.length))return NaN;let f=1/0;for(let m=t[0];m<=t[1];++m)for(let y=o[0];y<=o[1];++y)if(f=Math.min(f,c.distance(i[m],r[y])),f===0)return f;return f}function Pi(i,t,r){if(Bn(i,t,!0))return 0;let o=1/0;for(const c of t){const f=c[0],m=c[c.length-1];if(f!==m&&(o=Math.min(o,pn(i,[m,f],r)),o===0))return o;const y=r.pointOnLine(c,i);if(o=Math.min(o,r.distance(i,y.point)),o===0)return o}return o}function iu(i,t,r,o){if(!Ds(t,i.length))return NaN;for(let f=t[0];f<=t[1];++f)if(Bn(i[f],r,!0))return 0;let c=1/0;for(let f=t[0];f<t[1];++f){const m=i[f],y=i[f+1];for(const b of r)for(let T=0,E=b.length,P=E-1;T<E;P=T++){const z=b[P],R=b[T];if(ia(m,y,z,R))return 0;c=Math.min(c,cl(m,y,z,R,o))}}return c}function Ot(i,t){for(const r of i)for(const o of r)if(Bn(o,t,!0))return!0;return!1}function hl(i,t,r,o=1/0){const c=ll(i),f=ll(t);if(o!==1/0&&po(c,f,r)>=o)return o;if(Zs(c,f)){if(Ot(i,t))return 0}else if(Ot(t,i))return 0;let m=1/0;for(const y of i)for(let b=0,T=y.length,E=T-1;b<T;E=b++){const P=y[E],z=y[b];for(const R of t)for(let F=0,$=R.length,Q=$-1;F<$;Q=F++){const ie=R[Q],_e=R[F];if(ia(P,z,ie,_e))return 0;m=Math.min(m,cl(P,z,ie,_e,r))}}return m}function ui(i,t,r,o,c,f){if(!f)return;const m=po(al(o,f),c,r);m<t&&i.push([m,f,[0,0]])}function ei(i,t,r,o,c,f,m){if(!f||!m)return;const y=po(al(o,f),al(c,m),r);y<t&&i.push([y,f,m])}function fn(i,t,r,o,c=1/0){let f=Math.min(o.distance(i[0],r[0][0]),c);if(f===0)return f;const m=new Sc([[0,[0,i.length-1],[0,0]]],Ac),y=ll(r);for(;m.length>0;){const b=m.pop();if(b[0]>=f)continue;const T=b[1],E=t?50:100;if(sa(T)<=E){if(!Ds(T,i.length))return NaN;if(t){const P=iu(i,T,r,o);if(isNaN(P)||P===0)return P;f=Math.min(f,P)}else for(let P=T[0];P<=T[1];++P){const z=Pi(i[P],r,o);if(f=Math.min(f,z),f===0)return 0}}else{const P=ol(T,t);ui(m,f,o,i,y,P[0]),ui(m,f,o,i,y,P[1])}}return f}function fo(i,t,r,o,c,f=1/0){let m=Math.min(f,c.distance(i[0],r[0]));if(m===0)return m;const y=new Sc([[0,[0,i.length-1],[0,r.length-1]]],Ac);for(;y.length>0;){const b=y.pop();if(b[0]>=m)continue;const T=b[1],E=b[2],P=t?50:100,z=o?50:100;if(sa(T)<=P&&sa(E)<=z){if(!Ds(T,i.length)&&Ds(E,r.length))return NaN;let R;if(t&&o)R=eu(i,T,r,E,c),m=Math.min(m,R);else if(t&&!o){const F=i.slice(T[0],T[1]+1);for(let $=E[0];$<=E[1];++$)if(R=pn(r[$],F,c),m=Math.min(m,R),m===0)return m}else if(!t&&o){const F=r.slice(E[0],E[1]+1);for(let $=T[0];$<=T[1];++$)if(R=pn(i[$],F,c),m=Math.min(m,R),m===0)return m}else R=tu(i,T,r,E,c),m=Math.min(m,R)}else{const R=ol(T,t),F=ol(E,o);ei(y,m,c,i,r,R[0],F[0]),ei(y,m,c,i,r,R[0],F[1]),ei(y,m,c,i,r,R[1],F[0]),ei(y,m,c,i,r,R[1],F[1])}}return m}function na(i){return i.type==="MultiPolygon"?i.coordinates.map(t=>({type:"Polygon",coordinates:t})):i.type==="MultiLineString"?i.coordinates.map(t=>({type:"LineString",coordinates:t})):i.type==="MultiPoint"?i.coordinates.map(t=>({type:"Point",coordinates:t})):[i]}class mn{constructor(t,r){this.type=je,this.geojson=t,this.geometries=r}static parse(t,r){if(t.length!==2)return r.error(`'distance' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Qt(t[1])){const o=t[1];if(o.type==="FeatureCollection")return new mn(o,o.features.map(c=>na(c.geometry)).flat());if(o.type==="Feature")return new mn(o,na(o.geometry));if("type"in o&&"coordinates"in o)return new mn(o,na(o))}return r.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(r,o){const c=r.geometry(),f=c.flat().map(b=>rl([b.x,b.y],r.canonical));if(c.length===0)return NaN;const m=new nl(f[0][1]);let y=1/0;for(const b of o){switch(b.type){case"Point":y=Math.min(y,fo(f,!1,[b.coordinates],!1,m,y));break;case"LineString":y=Math.min(y,fo(f,!1,b.coordinates,!0,m,y));break;case"Polygon":y=Math.min(y,fn(f,!1,b.coordinates,m,y))}if(y===0)return y}return y}(t,this.geometries);if(t.geometryType()==="LineString")return function(r,o){const c=r.geometry(),f=c.flat().map(b=>rl([b.x,b.y],r.canonical));if(c.length===0)return NaN;const m=new nl(f[0][1]);let y=1/0;for(const b of o){switch(b.type){case"Point":y=Math.min(y,fo(f,!0,[b.coordinates],!1,m,y));break;case"LineString":y=Math.min(y,fo(f,!0,b.coordinates,!0,m,y));break;case"Polygon":y=Math.min(y,fn(f,!0,b.coordinates,m,y))}if(y===0)return y}return y}(t,this.geometries);if(t.geometryType()==="Polygon")return function(r,o){const c=r.geometry();if(c.length===0||c[0].length===0)return NaN;const f=ra(c,0).map(b=>b.map(T=>T.map(E=>rl([E.x,E.y],r.canonical)))),m=new nl(f[0][0][0][1]);let y=1/0;for(const b of o)for(const T of f){switch(b.type){case"Point":y=Math.min(y,fn([b.coordinates],!1,T,m,y));break;case"LineString":y=Math.min(y,fn(b.coordinates,!0,T,m,y));break;case"Polygon":y=Math.min(y,hl(T,b.coordinates,m,y))}if(y===0)return y}return y}(t,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}const jn={"==":qh,"!=":fc,">":Gh,"<":mc,">=":_c,"<=":Hh,array:rs,at:Ka,boolean:rs,case:Jo,coalesce:Qo,collator:ho,format:ta,image:tl,in:Ya,"index-of":Rn,interpolate:Ir,"interpolate-hcl":Ir,"interpolate-lab":Ir,length:il,let:Hs,literal:is,match:Qa,number:rs,"number-format":el,object:rs,slice:lo,step:On,string:rs,"to-boolean":ss,"to-color":ss,"to-number":ss,"to-string":ss,var:Wt,within:dn,distance:mn};class Jr{constructor(t,r,o,c){this.name=t,this.type=r,this._evaluate=o,this.args=c}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}static parse(t,r){const o=t[0],c=Jr.definitions[o];if(!c)return r.error(`Unknown expression "${o}". If you wanted a literal array, use ["literal", [...]].`,0);const f=Array.isArray(c)?c[0]:c.type,m=Array.isArray(c)?[[c[1],c[2]]]:c.overloads,y=m.filter(([T])=>!Array.isArray(T)||T.length===t.length-1);let b=null;for(const[T,E]of y){b=new cn(r.registry,aa,r.path,null,r.scope);const P=[];let z=!1;for(let R=1;R<t.length;R++){const F=t[R],$=Array.isArray(T)?T[R-1]:T.type,Q=b.parse(F,1+P.length,$);if(!Q){z=!0;break}P.push(Q)}if(!z)if(Array.isArray(T)&&T.length!==P.length)b.error(`Expected ${T.length} arguments, but found ${P.length} instead.`);else{for(let R=0;R<P.length;R++){const F=Array.isArray(T)?T[R]:T.type,$=P[R];b.concat(R+1).checkSubtype(F,$.type)}if(b.errors.length===0)return new Jr(o,f,E,P)}}if(y.length===1)r.errors.push(...b.errors);else{const T=(y.length?y:m).map(([P])=>{return z=P,Array.isArray(z)?`(${z.map(L).join(", ")})`:`(${L(z.type)}...)`;var z}).join(" | "),E=[];for(let P=1;P<t.length;P++){const z=r.parse(t[P],1+E.length);if(!z)return null;E.push(L(z.type))}r.error(`Expected arguments of type ${T}, but found (${E.join(", ")}) instead.`)}return null}static register(t,r){Jr.definitions=r;for(const o in r)t[o]=Jr}}function Cc(i,[t,r,o,c]){t=t.evaluate(i),r=r.evaluate(i),o=o.evaluate(i);const f=c?c.evaluate(i):1,m=Rt(t,r,o,f);if(m)throw new Oi(m);return new X(t/255,r/255,o/255,f,!1)}function ul(i,t){return i in t}function oa(i,t){const r=t[i];return r===void 0?null:r}function _n(i){return{type:i}}function aa(i){if(i instanceof Wt)return aa(i.boundExpression);if(i instanceof Jr&&i.name==="error"||i instanceof ho||i instanceof dn||i instanceof mn)return!1;const t=i instanceof ss||i instanceof rs;let r=!0;return i.eachChild(o=>{r=t?r&&aa(o):r&&o instanceof is}),!!r&&mo(i)&&_o(i,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function mo(i){if(i instanceof Jr&&(i.name==="get"&&i.args.length===1||i.name==="feature-state"||i.name==="has"&&i.args.length===1||i.name==="properties"||i.name==="geometry-type"||i.name==="id"||/^filter-/.test(i.name))||i instanceof dn||i instanceof mn)return!1;let t=!0;return i.eachChild(r=>{t&&!mo(r)&&(t=!1)}),t}function Nn(i){if(i instanceof Jr&&i.name==="feature-state")return!1;let t=!0;return i.eachChild(r=>{t&&!Nn(r)&&(t=!1)}),t}function _o(i,t){if(i instanceof Jr&&t.indexOf(i.name)>=0)return!1;let r=!0;return i.eachChild(o=>{r&&!_o(o,t)&&(r=!1)}),r}function dl(i){return{result:"success",value:i}}function Ws(i){return{result:"error",value:i}}function $n(i){return i["property-type"]==="data-driven"||i["property-type"]==="cross-faded-data-driven"}function Mc(i){return!!i.expression&&i.expression.parameters.indexOf("zoom")>-1}function pl(i){return!!i.expression&&i.expression.interpolated}function Ht(i){return i instanceof Number?"number":i instanceof String?"string":i instanceof Boolean?"boolean":Array.isArray(i)?"array":i===null?"null":typeof i}function la(i){return typeof i=="object"&&i!==null&&!Array.isArray(i)}function ru(i){return i}function zc(i,t){const r=t.type==="color",o=i.stops&&typeof i.stops[0][0]=="object",c=o||!(o||i.property!==void 0),f=i.type||(pl(t)?"exponential":"interval");if(r||t.type==="padding"){const E=r?X.parse:Me.parse;(i=Zr({},i)).stops&&(i.stops=i.stops.map(P=>[P[0],E(P[1])])),i.default=E(i.default?i.default:t.default)}if(i.colorSpace&&(m=i.colorSpace)!=="rgb"&&m!=="hcl"&&m!=="lab")throw new Error(`Unknown color space: "${i.colorSpace}"`);var m;let y,b,T;if(f==="exponential")y=yo;else if(f==="interval")y=Lc;else if(f==="categorical"){y=Dc,b=Object.create(null);for(const E of i.stops)b[E[0]]=E[1];T=typeof i.stops[0][0]}else{if(f!=="identity")throw new Error(`Unknown function type "${f}"`);y=su}if(o){const E={},P=[];for(let F=0;F<i.stops.length;F++){const $=i.stops[F],Q=$[0].zoom;E[Q]===void 0&&(E[Q]={zoom:Q,type:i.type,property:i.property,default:i.default,stops:[]},P.push(Q)),E[Q].stops.push([$[0].value,$[1]])}const z=[];for(const F of P)z.push([E[F].zoom,zc(E[F],t)]);const R={name:"linear"};return{kind:"composite",interpolationType:R,interpolationFactor:Ir.interpolationFactor.bind(void 0,R),zoomStops:z.map(F=>F[0]),evaluate:({zoom:F},$)=>yo({stops:z,base:i.base},t,F).evaluate(F,$)}}if(c){const E=f==="exponential"?{name:"exponential",base:i.base!==void 0?i.base:1}:null;return{kind:"camera",interpolationType:E,interpolationFactor:Ir.interpolationFactor.bind(void 0,E),zoomStops:i.stops.map(P=>P[0]),evaluate:({zoom:P})=>y(i,t,P,b,T)}}return{kind:"source",evaluate(E,P){const z=P&&P.properties?P.properties[i.property]:void 0;return z===void 0?go(i.default,t.default):y(i,t,z,b,T)}}}function go(i,t,r){return i!==void 0?i:t!==void 0?t:r!==void 0?r:void 0}function Dc(i,t,r,o,c){return go(typeof r===c?o[r]:void 0,i.default,t.default)}function Lc(i,t,r){if(Ht(r)!=="number")return go(i.default,t.default);const o=i.stops.length;if(o===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[o-1][0])return i.stops[o-1][1];const c=Ko(i.stops.map(f=>f[0]),r);return i.stops[c][1]}function yo(i,t,r){const o=i.base!==void 0?i.base:1;if(Ht(r)!=="number")return go(i.default,t.default);const c=i.stops.length;if(c===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[c-1][0])return i.stops[c-1][1];const f=Ko(i.stops.map(E=>E[0]),r),m=function(E,P,z,R){const F=R-z,$=E-z;return F===0?0:P===1?$/F:(Math.pow(P,$)-1)/(Math.pow(P,F)-1)}(r,o,i.stops[f][0],i.stops[f+1][0]),y=i.stops[f][1],b=i.stops[f+1][1],T=Sr[t.type]||ru;return typeof y.evaluate=="function"?{evaluate(...E){const P=y.evaluate.apply(void 0,E),z=b.evaluate.apply(void 0,E);if(P!==void 0&&z!==void 0)return T(P,z,m,i.colorSpace)}}:T(y,b,m,i.colorSpace)}function su(i,t,r){switch(t.type){case"color":r=X.parse(r);break;case"formatted":r=Ae.fromString(r.toString());break;case"resolvedImage":r=Ke.fromString(r.toString());break;case"padding":r=Me.parse(r);break;default:Ht(r)===t.type||t.type==="enum"&&t.values[r]||(r=void 0)}return go(r,i.default,t.default)}Jr.register(jn,{error:[{kind:"error"},[St],(i,[t])=>{throw new Oi(t.evaluate(i))}],typeof:[St,[vt],(i,[t])=>L(Jt(t.evaluate(i)))],"to-rgba":[D(je,4),[Qi],(i,[t])=>{const[r,o,c,f]=t.evaluate(i).rgb;return[255*r,255*o,255*c,f]}],rgb:[Qi,[je,je,je],Cc],rgba:[Qi,[je,je,je,je],Cc],has:{type:pt,overloads:[[[St],(i,[t])=>ul(t.evaluate(i),i.properties())],[[St,ur],(i,[t,r])=>ul(t.evaluate(i),r.evaluate(i))]]},get:{type:vt,overloads:[[[St],(i,[t])=>oa(t.evaluate(i),i.properties())],[[St,ur],(i,[t,r])=>oa(t.evaluate(i),r.evaluate(i))]]},"feature-state":[vt,[St],(i,[t])=>oa(t.evaluate(i),i.featureState||{})],properties:[ur,[],i=>i.properties()],"geometry-type":[St,[],i=>i.geometryType()],id:[vt,[],i=>i.id()],zoom:[je,[],i=>i.globals.zoom],"heatmap-density":[je,[],i=>i.globals.heatmapDensity||0],"line-progress":[je,[],i=>i.globals.lineProgress||0],accumulated:[vt,[],i=>i.globals.accumulated===void 0?null:i.globals.accumulated],"+":[je,_n(je),(i,t)=>{let r=0;for(const o of t)r+=o.evaluate(i);return r}],"*":[je,_n(je),(i,t)=>{let r=1;for(const o of t)r*=o.evaluate(i);return r}],"-":{type:je,overloads:[[[je,je],(i,[t,r])=>t.evaluate(i)-r.evaluate(i)],[[je],(i,[t])=>-t.evaluate(i)]]},"/":[je,[je,je],(i,[t,r])=>t.evaluate(i)/r.evaluate(i)],"%":[je,[je,je],(i,[t,r])=>t.evaluate(i)%r.evaluate(i)],ln2:[je,[],()=>Math.LN2],pi:[je,[],()=>Math.PI],e:[je,[],()=>Math.E],"^":[je,[je,je],(i,[t,r])=>Math.pow(t.evaluate(i),r.evaluate(i))],sqrt:[je,[je],(i,[t])=>Math.sqrt(t.evaluate(i))],log10:[je,[je],(i,[t])=>Math.log(t.evaluate(i))/Math.LN10],ln:[je,[je],(i,[t])=>Math.log(t.evaluate(i))],log2:[je,[je],(i,[t])=>Math.log(t.evaluate(i))/Math.LN2],sin:[je,[je],(i,[t])=>Math.sin(t.evaluate(i))],cos:[je,[je],(i,[t])=>Math.cos(t.evaluate(i))],tan:[je,[je],(i,[t])=>Math.tan(t.evaluate(i))],asin:[je,[je],(i,[t])=>Math.asin(t.evaluate(i))],acos:[je,[je],(i,[t])=>Math.acos(t.evaluate(i))],atan:[je,[je],(i,[t])=>Math.atan(t.evaluate(i))],min:[je,_n(je),(i,t)=>Math.min(...t.map(r=>r.evaluate(i)))],max:[je,_n(je),(i,t)=>Math.max(...t.map(r=>r.evaluate(i)))],abs:[je,[je],(i,[t])=>Math.abs(t.evaluate(i))],round:[je,[je],(i,[t])=>{const r=t.evaluate(i);return r<0?-Math.round(-r):Math.round(r)}],floor:[je,[je],(i,[t])=>Math.floor(t.evaluate(i))],ceil:[je,[je],(i,[t])=>Math.ceil(t.evaluate(i))],"filter-==":[pt,[St,vt],(i,[t,r])=>i.properties()[t.value]===r.value],"filter-id-==":[pt,[vt],(i,[t])=>i.id()===t.value],"filter-type-==":[pt,[St],(i,[t])=>i.geometryType()===t.value],"filter-<":[pt,[St,vt],(i,[t,r])=>{const o=i.properties()[t.value],c=r.value;return typeof o==typeof c&&o<c}],"filter-id-<":[pt,[vt],(i,[t])=>{const r=i.id(),o=t.value;return typeof r==typeof o&&r<o}],"filter->":[pt,[St,vt],(i,[t,r])=>{const o=i.properties()[t.value],c=r.value;return typeof o==typeof c&&o>c}],"filter-id->":[pt,[vt],(i,[t])=>{const r=i.id(),o=t.value;return typeof r==typeof o&&r>o}],"filter-<=":[pt,[St,vt],(i,[t,r])=>{const o=i.properties()[t.value],c=r.value;return typeof o==typeof c&&o<=c}],"filter-id-<=":[pt,[vt],(i,[t])=>{const r=i.id(),o=t.value;return typeof r==typeof o&&r<=o}],"filter->=":[pt,[St,vt],(i,[t,r])=>{const o=i.properties()[t.value],c=r.value;return typeof o==typeof c&&o>=c}],"filter-id->=":[pt,[vt],(i,[t])=>{const r=i.id(),o=t.value;return typeof r==typeof o&&r>=o}],"filter-has":[pt,[vt],(i,[t])=>t.value in i.properties()],"filter-has-id":[pt,[],i=>i.id()!==null&&i.id()!==void 0],"filter-type-in":[pt,[D(St)],(i,[t])=>t.value.indexOf(i.geometryType())>=0],"filter-id-in":[pt,[D(vt)],(i,[t])=>t.value.indexOf(i.id())>=0],"filter-in-small":[pt,[St,D(vt)],(i,[t,r])=>r.value.indexOf(i.properties()[t.value])>=0],"filter-in-large":[pt,[St,D(vt)],(i,[t,r])=>function(o,c,f,m){for(;f<=m;){const y=f+m>>1;if(c[y]===o)return!0;c[y]>o?m=y-1:f=y+1}return!1}(i.properties()[t.value],r.value,0,r.value.length-1)],all:{type:pt,overloads:[[[pt,pt],(i,[t,r])=>t.evaluate(i)&&r.evaluate(i)],[_n(pt),(i,t)=>{for(const r of t)if(!r.evaluate(i))return!1;return!0}]]},any:{type:pt,overloads:[[[pt,pt],(i,[t,r])=>t.evaluate(i)||r.evaluate(i)],[_n(pt),(i,t)=>{for(const r of t)if(r.evaluate(i))return!0;return!1}]]},"!":[pt,[pt],(i,[t])=>!t.evaluate(i)],"is-supported-script":[pt,[St],(i,[t])=>{const r=i.globals&&i.globals.isSupportedScript;return!r||r(t.evaluate(i))}],upcase:[St,[St],(i,[t])=>t.evaluate(i).toUpperCase()],downcase:[St,[St],(i,[t])=>t.evaluate(i).toLowerCase()],concat:[St,_n(vt),(i,t)=>t.map(r=>Xr(r.evaluate(i))).join("")],"resolved-locale":[St,[dr],(i,[t])=>t.evaluate(i).resolvedLocale()]});class ca{constructor(t,r){var o;this.expression=t,this._warningHistory={},this._evaluator=new Xo,this._defaultValue=r?(o=r).type==="color"&&la(o.default)?new X(0,0,0,0):o.type==="color"?X.parse(o.default)||null:o.type==="padding"?Me.parse(o.default)||null:o.type==="variableAnchorOffsetCollection"?Te.parse(o.default)||null:o.default===void 0?null:o.default:null,this._enumValues=r&&r.type==="enum"?r.values:null}evaluateWithoutErrorHandling(t,r,o,c,f,m){return this._evaluator.globals=t,this._evaluator.feature=r,this._evaluator.featureState=o,this._evaluator.canonical=c,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=m,this.expression.evaluate(this._evaluator)}evaluate(t,r,o,c,f,m){this._evaluator.globals=t,this._evaluator.feature=r||null,this._evaluator.featureState=o||null,this._evaluator.canonical=c,this._evaluator.availableImages=f||null,this._evaluator.formattedSection=m||null;try{const y=this.expression.evaluate(this._evaluator);if(y==null||typeof y=="number"&&y!=y)return this._defaultValue;if(this._enumValues&&!(y in this._enumValues))throw new Oi(`Expected value to be one of ${Object.keys(this._enumValues).map(b=>JSON.stringify(b)).join(", ")}, but found ${JSON.stringify(y)} instead.`);return y}catch(y){return this._warningHistory[y.message]||(this._warningHistory[y.message]=!0,typeof console<"u"&&console.warn(y.message)),this._defaultValue}}}function xo(i){return Array.isArray(i)&&i.length>0&&typeof i[0]=="string"&&i[0]in jn}function ha(i,t){const r=new cn(jn,aa,[],t?function(c){const f={color:Qi,string:St,number:je,enum:St,boolean:pt,formatted:Fr,padding:Br,resolvedImage:wr,variableAnchorOffsetCollection:te};return c.type==="array"?D(f[c.value]||vt,c.length):f[c.type]}(t):void 0),o=r.parse(i,void 0,void 0,void 0,t&&t.type==="string"?{typeAnnotation:"coerce"}:void 0);return o?dl(new ca(o,t)):Ws(r.errors)}class vo{constructor(t,r){this.kind=t,this._styleExpression=r,this.isStateDependent=t!=="constant"&&!Nn(r.expression)}evaluateWithoutErrorHandling(t,r,o,c,f,m){return this._styleExpression.evaluateWithoutErrorHandling(t,r,o,c,f,m)}evaluate(t,r,o,c,f,m){return this._styleExpression.evaluate(t,r,o,c,f,m)}}class Un{constructor(t,r,o,c){this.kind=t,this.zoomStops=o,this._styleExpression=r,this.isStateDependent=t!=="camera"&&!Nn(r.expression),this.interpolationType=c}evaluateWithoutErrorHandling(t,r,o,c,f,m){return this._styleExpression.evaluateWithoutErrorHandling(t,r,o,c,f,m)}evaluate(t,r,o,c,f,m){return this._styleExpression.evaluate(t,r,o,c,f,m)}interpolationFactor(t,r,o){return this.interpolationType?Ir.interpolationFactor(this.interpolationType,t,r,o):0}}function bo(i,t){const r=ha(i,t);if(r.result==="error")return r;const o=r.value.expression,c=mo(o);if(!c&&!$n(t))return Ws([new Yi("","data expressions not supported")]);const f=_o(o,["zoom"]);if(!f&&!Mc(t))return Ws([new Yi("","zoom expressions not supported")]);const m=Vn(o);return m||f?m instanceof Yi?Ws([m]):m instanceof Ir&&!pl(t)?Ws([new Yi("",'"interpolate" expressions cannot be used with this property')]):dl(m?new Un(c?"camera":"composite",r.value,m.labels,m instanceof Ir?m.interpolation:void 0):new vo(c?"constant":"source",r.value)):Ws([new Yi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class wo{constructor(t,r){this._parameters=t,this._specification=r,Zr(this,zc(this._parameters,this._specification))}static deserialize(t){return new wo(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function Vn(i){let t=null;if(i instanceof Hs)t=Vn(i.result);else if(i instanceof Qo){for(const r of i.args)if(t=Vn(r),t)break}else(i instanceof On||i instanceof Ir)&&i.input instanceof Jr&&i.input.name==="zoom"&&(t=i);return t instanceof Yi||i.eachChild(r=>{const o=Vn(r);o instanceof Yi?t=o:!t&&o?t=new Yi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):t&&o&&t!==o&&(t=new Yi("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}function ua(i){if(i===!0||i===!1)return!0;if(!Array.isArray(i)||i.length===0)return!1;switch(i[0]){case"has":return i.length>=2&&i[1]!=="$id"&&i[1]!=="$type";case"in":return i.length>=3&&(typeof i[1]!="string"||Array.isArray(i[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return i.length!==3||Array.isArray(i[1])||Array.isArray(i[2]);case"any":case"all":for(const t of i.slice(1))if(!ua(t)&&typeof t!="boolean")return!1;return!0;default:return!0}}const Rc={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function qn(i){if(i==null)return{filter:()=>!0,needGeometry:!1};ua(i)||(i=da(i));const t=ha(i,Rc);if(t.result==="error")throw new Error(t.value.map(r=>`${r.key}: ${r.message}`).join(", "));return{filter:(r,o,c)=>t.value.evaluate(r,o,{},c),needGeometry:Oc(i)}}function nu(i,t){return i<t?-1:i>t?1:0}function Oc(i){if(!Array.isArray(i))return!1;if(i[0]==="within"||i[0]==="distance")return!0;for(let t=1;t<i.length;t++)if(Oc(i[t]))return!0;return!1}function da(i){if(!i)return!0;const t=i[0];return i.length<=1?t!=="any":t==="=="?fl(i[1],i[2],"=="):t==="!="?gn(fl(i[1],i[2],"==")):t==="<"||t===">"||t==="<="||t===">="?fl(i[1],i[2],t):t==="any"?(r=i.slice(1),["any"].concat(r.map(da))):t==="all"?["all"].concat(i.slice(1).map(da)):t==="none"?["all"].concat(i.slice(1).map(da).map(gn)):t==="in"?Fc(i[1],i.slice(2)):t==="!in"?gn(Fc(i[1],i.slice(2))):t==="has"?So(i[1]):t!=="!has"||gn(So(i[1]));var r}function fl(i,t,r){switch(i){case"$type":return[`filter-type-${r}`,t];case"$id":return[`filter-id-${r}`,t];default:return[`filter-${r}`,i,t]}}function Fc(i,t){if(t.length===0)return!1;switch(i){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(r=>typeof r!=typeof t[0])?["filter-in-large",i,["literal",t.sort(nu)]]:["filter-in-small",i,["literal",t]]}}function So(i){switch(i){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",i]}}function gn(i){return["!",i]}function pr(i){const t=typeof i;if(t==="number"||t==="boolean"||t==="string"||i==null)return JSON.stringify(i);if(Array.isArray(i)){let c="[";for(const f of i)c+=`${pr(f)},`;return`${c}]`}const r=Object.keys(i).sort();let o="{";for(let c=0;c<r.length;c++)o+=`${JSON.stringify(r[c])}:${pr(i[r[c]])},`;return`${o}}`}function Io(i){let t="";for(const r of Is)t+=`/${pr(i[r])}`;return t}function ml(i){const t=i.value;return t?[new Oe(i.key,t,"constants have been deprecated as of v8")]:[]}function Ci(i){return i instanceof Number||i instanceof String||i instanceof Boolean?i.valueOf():i}function yn(i){if(Array.isArray(i))return i.map(yn);if(i instanceof Object&&!(i instanceof Number||i instanceof String||i instanceof Boolean)){const t={};for(const r in i)t[r]=yn(i[r]);return t}return Ci(i)}function ir(i){const t=i.key,r=i.value,o=i.valueSpec||{},c=i.objectElementValidators||{},f=i.style,m=i.styleSpec,y=i.validateSpec;let b=[];const T=Ht(r);if(T!=="object")return[new Oe(t,r,`object expected, ${T} found`)];for(const E in r){const P=E.split(".")[0],z=o[P]||o["*"];let R;if(c[P])R=c[P];else if(o[P])R=y;else if(c["*"])R=c["*"];else{if(!o["*"]){b.push(new Oe(t,r[E],`unknown property "${E}"`));continue}R=y}b=b.concat(R({key:(t&&`${t}.`)+E,value:r[E],valueSpec:z,style:f,styleSpec:m,object:r,objectKey:E,validateSpec:y},r))}for(const E in o)c[E]||o[E].required&&o[E].default===void 0&&r[E]===void 0&&b.push(new Oe(t,r,`missing required property "${E}"`));return b}function pa(i){const t=i.value,r=i.valueSpec,o=i.style,c=i.styleSpec,f=i.key,m=i.arrayElementValidator||i.validateSpec;if(Ht(t)!=="array")return[new Oe(f,t,`array expected, ${Ht(t)} found`)];if(r.length&&t.length!==r.length)return[new Oe(f,t,`array length ${r.length} expected, length ${t.length} found`)];if(r["min-length"]&&t.length<r["min-length"])return[new Oe(f,t,`array length at least ${r["min-length"]} expected, length ${t.length} found`)];let y={type:r.value,values:r.values};c.$version<7&&(y.function=r.function),Ht(r.value)==="object"&&(y=r.value);let b=[];for(let T=0;T<t.length;T++)b=b.concat(m({array:t,arrayIndex:T,value:t[T],valueSpec:y,validateSpec:i.validateSpec,style:o,styleSpec:c,key:`${f}[${T}]`}));return b}function To(i){const t=i.key,r=i.value,o=i.valueSpec;let c=Ht(r);return c==="number"&&r!=r&&(c="NaN"),c!=="number"?[new Oe(t,r,`number expected, ${c} found`)]:"minimum"in o&&r<o.minimum?[new Oe(t,r,`${r} is less than the minimum value ${o.minimum}`)]:"maximum"in o&&r>o.maximum?[new Oe(t,r,`${r} is greater than the maximum value ${o.maximum}`)]:[]}function Bc(i){const t=i.valueSpec,r=Ci(i.value.type);let o,c,f,m={};const y=r!=="categorical"&&i.value.property===void 0,b=!y,T=Ht(i.value.stops)==="array"&&Ht(i.value.stops[0])==="array"&&Ht(i.value.stops[0][0])==="object",E=ir({key:i.key,value:i.value,valueSpec:i.styleSpec.function,validateSpec:i.validateSpec,style:i.style,styleSpec:i.styleSpec,objectElementValidators:{stops:function(R){if(r==="identity")return[new Oe(R.key,R.value,'identity function may not have a "stops" property')];let F=[];const $=R.value;return F=F.concat(pa({key:R.key,value:$,valueSpec:R.valueSpec,validateSpec:R.validateSpec,style:R.style,styleSpec:R.styleSpec,arrayElementValidator:P})),Ht($)==="array"&&$.length===0&&F.push(new Oe(R.key,$,"array must have at least one stop")),F},default:function(R){return R.validateSpec({key:R.key,value:R.value,valueSpec:t,validateSpec:R.validateSpec,style:R.style,styleSpec:R.styleSpec})}}});return r==="identity"&&y&&E.push(new Oe(i.key,i.value,'missing required property "property"')),r==="identity"||i.value.stops||E.push(new Oe(i.key,i.value,'missing required property "stops"')),r==="exponential"&&i.valueSpec.expression&&!pl(i.valueSpec)&&E.push(new Oe(i.key,i.value,"exponential functions not supported")),i.styleSpec.$version>=8&&(b&&!$n(i.valueSpec)?E.push(new Oe(i.key,i.value,"property functions not supported")):y&&!Mc(i.valueSpec)&&E.push(new Oe(i.key,i.value,"zoom functions not supported"))),r!=="categorical"&&!T||i.value.property!==void 0||E.push(new Oe(i.key,i.value,'"property" property is required')),E;function P(R){let F=[];const $=R.value,Q=R.key;if(Ht($)!=="array")return[new Oe(Q,$,`array expected, ${Ht($)} found`)];if($.length!==2)return[new Oe(Q,$,`array length 2 expected, length ${$.length} found`)];if(T){if(Ht($[0])!=="object")return[new Oe(Q,$,`object expected, ${Ht($[0])} found`)];if($[0].zoom===void 0)return[new Oe(Q,$,"object stop key must have zoom")];if($[0].value===void 0)return[new Oe(Q,$,"object stop key must have value")];if(f&&f>Ci($[0].zoom))return[new Oe(Q,$[0].zoom,"stop zoom values must appear in ascending order")];Ci($[0].zoom)!==f&&(f=Ci($[0].zoom),c=void 0,m={}),F=F.concat(ir({key:`${Q}[0]`,value:$[0],valueSpec:{zoom:{}},validateSpec:R.validateSpec,style:R.style,styleSpec:R.styleSpec,objectElementValidators:{zoom:To,value:z}}))}else F=F.concat(z({key:`${Q}[0]`,value:$[0],valueSpec:{},validateSpec:R.validateSpec,style:R.style,styleSpec:R.styleSpec},$));return xo(yn($[1]))?F.concat([new Oe(`${Q}[1]`,$[1],"expressions are not allowed in function stops.")]):F.concat(R.validateSpec({key:`${Q}[1]`,value:$[1],valueSpec:t,validateSpec:R.validateSpec,style:R.style,styleSpec:R.styleSpec}))}function z(R,F){const $=Ht(R.value),Q=Ci(R.value),ie=R.value!==null?R.value:F;if(o){if($!==o)return[new Oe(R.key,ie,`${$} stop domain type must match previous stop domain type ${o}`)]}else o=$;if($!=="number"&&$!=="string"&&$!=="boolean")return[new Oe(R.key,ie,"stop domain value must be a number, string, or boolean")];if($!=="number"&&r!=="categorical"){let _e=`number expected, ${$} found`;return $n(t)&&r===void 0&&(_e+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Oe(R.key,ie,_e)]}return r!=="categorical"||$!=="number"||isFinite(Q)&&Math.floor(Q)===Q?r!=="categorical"&&$==="number"&&c!==void 0&&Q<c?[new Oe(R.key,ie,"stop domain values must appear in ascending order")]:(c=Q,r==="categorical"&&Q in m?[new Oe(R.key,ie,"stop domain values must be unique")]:(m[Q]=!0,[])):[new Oe(R.key,ie,`integer expected, found ${Q}`)]}}function Xs(i){const t=(i.expressionContext==="property"?bo:ha)(yn(i.value),i.valueSpec);if(t.result==="error")return t.value.map(o=>new Oe(`${i.key}${o.key}`,i.value,o.message));const r=t.value.expression||t.value._styleExpression.expression;if(i.expressionContext==="property"&&i.propertyKey==="text-font"&&!r.outputDefined())return[new Oe(i.key,i.value,`Invalid data expression for "${i.propertyKey}". Output values must be contained as literals within the expression.`)];if(i.expressionContext==="property"&&i.propertyType==="layout"&&!Nn(r))return[new Oe(i.key,i.value,'"feature-state" data expressions are not supported with layout properties.')];if(i.expressionContext==="filter"&&!Nn(r))return[new Oe(i.key,i.value,'"feature-state" data expressions are not supported with filters.')];if(i.expressionContext&&i.expressionContext.indexOf("cluster")===0){if(!_o(r,["zoom","feature-state"]))return[new Oe(i.key,i.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(i.expressionContext==="cluster-initial"&&!mo(r))return[new Oe(i.key,i.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ko(i){const t=i.key,r=i.value,o=i.valueSpec,c=[];return Array.isArray(o.values)?o.values.indexOf(Ci(r))===-1&&c.push(new Oe(t,r,`expected one of [${o.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(o.values).indexOf(Ci(r))===-1&&c.push(new Oe(t,r,`expected one of [${Object.keys(o.values).join(", ")}], ${JSON.stringify(r)} found`)),c}function xn(i){return ua(yn(i.value))?Xs(Zr({},i,{expressionContext:"filter",valueSpec:{value:"boolean"}})):jc(i)}function jc(i){const t=i.value,r=i.key;if(Ht(t)!=="array")return[new Oe(r,t,`array expected, ${Ht(t)} found`)];const o=i.styleSpec;let c,f=[];if(t.length<1)return[new Oe(r,t,"filter array must have at least 1 element")];switch(f=f.concat(ko({key:`${r}[0]`,value:t[0],valueSpec:o.filter_operator,style:i.style,styleSpec:i.styleSpec})),Ci(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&Ci(t[1])==="$type"&&f.push(new Oe(r,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&f.push(new Oe(r,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(c=Ht(t[1]),c!=="string"&&f.push(new Oe(`${r}[1]`,t[1],`string expected, ${c} found`)));for(let m=2;m<t.length;m++)c=Ht(t[m]),Ci(t[1])==="$type"?f=f.concat(ko({key:`${r}[${m}]`,value:t[m],valueSpec:o.geometry_type,style:i.style,styleSpec:i.styleSpec})):c!=="string"&&c!=="number"&&c!=="boolean"&&f.push(new Oe(`${r}[${m}]`,t[m],`string, number, or boolean expected, ${c} found`));break;case"any":case"all":case"none":for(let m=1;m<t.length;m++)f=f.concat(jc({key:`${r}[${m}]`,value:t[m],style:i.style,styleSpec:i.styleSpec}));break;case"has":case"!has":c=Ht(t[1]),t.length!==2?f.push(new Oe(r,t,`filter array for "${t[0]}" operator must have 2 elements`)):c!=="string"&&f.push(new Oe(`${r}[1]`,t[1],`string expected, ${c} found`))}return f}function fa(i,t){const r=i.key,o=i.validateSpec,c=i.style,f=i.styleSpec,m=i.value,y=i.objectKey,b=f[`${t}_${i.layerType}`];if(!b)return[];const T=y.match(/^(.*)-transition$/);if(t==="paint"&&T&&b[T[1]]&&b[T[1]].transition)return o({key:r,value:m,valueSpec:f.transition,style:c,styleSpec:f});const E=i.valueSpec||b[y];if(!E)return[new Oe(r,m,`unknown property "${y}"`)];let P;if(Ht(m)==="string"&&$n(E)&&!E.tokens&&(P=/^{([^}]+)}$/.exec(m)))return[new Oe(r,m,`"${y}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(P[1])} }\`.`)];const z=[];return i.layerType==="symbol"&&(y==="text-field"&&c&&!c.glyphs&&z.push(new Oe(r,m,'use of "text-field" requires a style "glyphs" property')),y==="text-font"&&la(yn(m))&&Ci(m.type)==="identity"&&z.push(new Oe(r,m,'"text-font" does not support identity functions'))),z.concat(o({key:i.key,value:m,valueSpec:E,style:c,styleSpec:f,expressionContext:"property",propertyType:t,propertyKey:y}))}function _l(i){return fa(i,"paint")}function ma(i){return fa(i,"layout")}function gl(i){let t=[];const r=i.value,o=i.key,c=i.style,f=i.styleSpec;r.type||r.ref||t.push(new Oe(o,r,'either "type" or "ref" is required'));let m=Ci(r.type);const y=Ci(r.ref);if(r.id){const b=Ci(r.id);for(let T=0;T<i.arrayIndex;T++){const E=c.layers[T];Ci(E.id)===b&&t.push(new Oe(o,r.id,`duplicate layer id "${r.id}", previously used at line ${E.id.__line__}`))}}if("ref"in r){let b;["type","source","source-layer","filter","layout"].forEach(T=>{T in r&&t.push(new Oe(o,r[T],`"${T}" is prohibited for ref layers`))}),c.layers.forEach(T=>{Ci(T.id)===y&&(b=T)}),b?b.ref?t.push(new Oe(o,r.ref,"ref cannot reference another ref layer")):m=Ci(b.type):t.push(new Oe(o,r.ref,`ref layer "${y}" not found`))}else if(m!=="background")if(r.source){const b=c.sources&&c.sources[r.source],T=b&&Ci(b.type);b?T==="vector"&&m==="raster"?t.push(new Oe(o,r.source,`layer "${r.id}" requires a raster source`)):T!=="raster-dem"&&m==="hillshade"?t.push(new Oe(o,r.source,`layer "${r.id}" requires a raster-dem source`)):T==="raster"&&m!=="raster"?t.push(new Oe(o,r.source,`layer "${r.id}" requires a vector source`)):T!=="vector"||r["source-layer"]?T==="raster-dem"&&m!=="hillshade"?t.push(new Oe(o,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):m!=="line"||!r.paint||!r.paint["line-gradient"]||T==="geojson"&&b.lineMetrics||t.push(new Oe(o,r,`layer "${r.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new Oe(o,r,`layer "${r.id}" must specify a "source-layer"`)):t.push(new Oe(o,r.source,`source "${r.source}" not found`))}else t.push(new Oe(o,r,'missing required property "source"'));return t=t.concat(ir({key:o,value:r,valueSpec:f.layer,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,objectElementValidators:{"*":()=>[],type:()=>i.validateSpec({key:`${o}.type`,value:r.type,valueSpec:f.layer.type,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,object:r,objectKey:"type"}),filter:xn,layout:b=>ir({layer:r,key:b.key,value:b.value,style:b.style,styleSpec:b.styleSpec,validateSpec:b.validateSpec,objectElementValidators:{"*":T=>ma(Zr({layerType:m},T))}}),paint:b=>ir({layer:r,key:b.key,value:b.value,style:b.style,styleSpec:b.styleSpec,validateSpec:b.validateSpec,objectElementValidators:{"*":T=>_l(Zr({layerType:m},T))}})}})),t}function Js(i){const t=i.value,r=i.key,o=Ht(t);return o!=="string"?[new Oe(r,t,`string expected, ${o} found`)]:[]}const Nc={promoteId:function({key:i,value:t}){if(Ht(t)==="string")return Js({key:i,value:t});{const r=[];for(const o in t)r.push(...Js({key:`${i}.${o}`,value:t[o]}));return r}}};function _a(i){const t=i.value,r=i.key,o=i.styleSpec,c=i.style,f=i.validateSpec;if(!t.type)return[new Oe(r,t,'"type" is required')];const m=Ci(t.type);let y;switch(m){case"vector":case"raster":return y=ir({key:r,value:t,valueSpec:o[`source_${m.replace("-","_")}`],style:i.style,styleSpec:o,objectElementValidators:Nc,validateSpec:f}),y;case"raster-dem":return y=function(b){var T;const E=(T=b.sourceName)!==null&&T!==void 0?T:"",P=b.value,z=b.styleSpec,R=z.source_raster_dem,F=b.style;let $=[];const Q=Ht(P);if(P===void 0)return $;if(Q!=="object")return $.push(new Oe("source_raster_dem",P,`object expected, ${Q} found`)),$;const ie=Ci(P.encoding)==="custom",_e=["redFactor","greenFactor","blueFactor","baseShift"],ce=b.value.encoding?`"${b.value.encoding}"`:"Default";for(const me in P)!ie&&_e.includes(me)?$.push(new Oe(me,P[me],`In "${E}": "${me}" is only valid when "encoding" is set to "custom". ${ce} encoding found`)):R[me]?$=$.concat(b.validateSpec({key:me,value:P[me],valueSpec:R[me],validateSpec:b.validateSpec,style:F,styleSpec:z})):$.push(new Oe(me,P[me],`unknown property "${me}"`));return $}({sourceName:r,value:t,style:i.style,styleSpec:o,validateSpec:f}),y;case"geojson":if(y=ir({key:r,value:t,valueSpec:o.source_geojson,style:c,styleSpec:o,validateSpec:f,objectElementValidators:Nc}),t.cluster)for(const b in t.clusterProperties){const[T,E]=t.clusterProperties[b],P=typeof T=="string"?[T,["accumulated"],["get",b]]:T;y.push(...Xs({key:`${r}.${b}.map`,value:E,validateSpec:f,expressionContext:"cluster-map"})),y.push(...Xs({key:`${r}.${b}.reduce`,value:P,validateSpec:f,expressionContext:"cluster-reduce"}))}return y;case"video":return ir({key:r,value:t,valueSpec:o.source_video,style:c,validateSpec:f,styleSpec:o});case"image":return ir({key:r,value:t,valueSpec:o.source_image,style:c,validateSpec:f,styleSpec:o});case"canvas":return[new Oe(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return ko({key:`${r}.type`,value:t.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:c,validateSpec:f,styleSpec:o})}}function Eo(i){const t=i.value,r=i.styleSpec,o=r.light,c=i.style;let f=[];const m=Ht(t);if(t===void 0)return f;if(m!=="object")return f=f.concat([new Oe("light",t,`object expected, ${m} found`)]),f;for(const y in t){const b=y.match(/^(.*)-transition$/);f=f.concat(b&&o[b[1]]&&o[b[1]].transition?i.validateSpec({key:y,value:t[y],valueSpec:r.transition,validateSpec:i.validateSpec,style:c,styleSpec:r}):o[y]?i.validateSpec({key:y,value:t[y],valueSpec:o[y],validateSpec:i.validateSpec,style:c,styleSpec:r}):[new Oe(y,t[y],`unknown property "${y}"`)])}return f}function yl(i){const t=i.value,r=i.styleSpec,o=r.sky,c=i.style,f=Ht(t);if(t===void 0)return[];if(f!=="object")return[new Oe("sky",t,`object expected, ${f} found`)];let m=[];for(const y in t)m=m.concat(o[y]?i.validateSpec({key:y,value:t[y],valueSpec:o[y],style:c,styleSpec:r}):[new Oe(y,t[y],`unknown property "${y}"`)]);return m}function xl(i){const t=i.value,r=i.styleSpec,o=r.terrain,c=i.style;let f=[];const m=Ht(t);if(t===void 0)return f;if(m!=="object")return f=f.concat([new Oe("terrain",t,`object expected, ${m} found`)]),f;for(const y in t)f=f.concat(o[y]?i.validateSpec({key:y,value:t[y],valueSpec:o[y],validateSpec:i.validateSpec,style:c,styleSpec:r}):[new Oe(y,t[y],`unknown property "${y}"`)]);return f}function vl(i){let t=[];const r=i.value,o=i.key;if(Array.isArray(r)){const c=[],f=[];for(const m in r)r[m].id&&c.includes(r[m].id)&&t.push(new Oe(o,r,`all the sprites' ids must be unique, but ${r[m].id} is duplicated`)),c.push(r[m].id),r[m].url&&f.includes(r[m].url)&&t.push(new Oe(o,r,`all the sprites' URLs must be unique, but ${r[m].url} is duplicated`)),f.push(r[m].url),t=t.concat(ir({key:`${o}[${m}]`,value:r[m],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:i.validateSpec}));return t}return Js({key:o,value:r})}const bl={"*":()=>[],array:pa,boolean:function(i){const t=i.value,r=i.key,o=Ht(t);return o!=="boolean"?[new Oe(r,t,`boolean expected, ${o} found`)]:[]},number:To,color:function(i){const t=i.key,r=i.value,o=Ht(r);return o!=="string"?[new Oe(t,r,`color expected, ${o} found`)]:X.parse(String(r))?[]:[new Oe(t,r,`color expected, "${r}" found`)]},constants:ml,enum:ko,filter:xn,function:Bc,layer:gl,object:ir,source:_a,light:Eo,sky:yl,terrain:xl,projection:function(i){const t=i.value,r=i.styleSpec,o=r.projection,c=i.style,f=Ht(t);if(t===void 0)return[];if(f!=="object")return[new Oe("projection",t,`object expected, ${f} found`)];let m=[];for(const y in t)m=m.concat(o[y]?i.validateSpec({key:y,value:t[y],valueSpec:o[y],style:c,styleSpec:r}):[new Oe(y,t[y],`unknown property "${y}"`)]);return m},string:Js,formatted:function(i){return Js(i).length===0?[]:Xs(i)},resolvedImage:function(i){return Js(i).length===0?[]:Xs(i)},padding:function(i){const t=i.key,r=i.value;if(Ht(r)==="array"){if(r.length<1||r.length>4)return[new Oe(t,r,`padding requires 1 to 4 values; ${r.length} values found`)];const o={type:"number"};let c=[];for(let f=0;f<r.length;f++)c=c.concat(i.validateSpec({key:`${t}[${f}]`,value:r[f],validateSpec:i.validateSpec,valueSpec:o}));return c}return To({key:t,value:r,valueSpec:{}})},variableAnchorOffsetCollection:function(i){const t=i.key,r=i.value,o=Ht(r),c=i.styleSpec;if(o!=="array"||r.length<1||r.length%2!=0)return[new Oe(t,r,"variableAnchorOffsetCollection requires a non-empty array of even length")];let f=[];for(let m=0;m<r.length;m+=2)f=f.concat(ko({key:`${t}[${m}]`,value:r[m],valueSpec:c.layout_symbol["text-anchor"]})),f=f.concat(pa({key:`${t}[${m+1}]`,value:r[m+1],valueSpec:{length:2,value:"number"},validateSpec:i.validateSpec,style:i.style,styleSpec:c}));return f},sprite:vl};function vn(i){const t=i.value,r=i.valueSpec,o=i.styleSpec;return i.validateSpec=vn,r.expression&&la(Ci(t))?Bc(i):r.expression&&xo(yn(t))?Xs(i):r.type&&bl[r.type]?bl[r.type](i):ir(Zr({},i,{valueSpec:r.type?o[r.type]:r}))}function wl(i){const t=i.value,r=i.key,o=Js(i);return o.length||(t.indexOf("{fontstack}")===-1&&o.push(new Oe(r,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&o.push(new Oe(r,t,'"glyphs" url must include a "{range}" token'))),o}function ns(i,t=be){let r=[];return r=r.concat(vn({key:"",value:i,valueSpec:t.$root,styleSpec:t,style:i,validateSpec:vn,objectElementValidators:{glyphs:wl,"*":()=>[]}})),i.constants&&(r=r.concat(ml({key:"constants",value:i.constants,style:i,styleSpec:t,validateSpec:vn}))),$c(r)}function os(i){return function(t){return i({...t,validateSpec:vn})}}function $c(i){return[].concat(i).sort((t,r)=>t.line-r.line)}function as(i){return function(...t){return $c(i.apply(this,t))}}ns.source=as(os(_a)),ns.sprite=as(os(vl)),ns.glyphs=as(os(wl)),ns.light=as(os(Eo)),ns.sky=as(os(yl)),ns.terrain=as(os(xl)),ns.layer=as(os(gl)),ns.filter=as(os(xn)),ns.paintProperty=as(os(_l)),ns.layoutProperty=as(os(ma));const bn=ns,Uc=bn.light,ou=bn.sky,au=bn.paintProperty,Vc=bn.layoutProperty;function Sl(i,t){let r=!1;if(t&&t.length)for(const o of t)i.fire(new Or(new Error(o.message))),r=!0;return r}class Gn{constructor(t,r,o){const c=this.cells=[];if(t instanceof ArrayBuffer){this.arrayBuffer=t;const m=new Int32Array(this.arrayBuffer);t=m[0],this.d=(r=m[1])+2*(o=m[2]);for(let b=0;b<this.d*this.d;b++){const T=m[3+b],E=m[3+b+1];c.push(T===E?null:m.subarray(T,E))}const y=m[3+c.length+1];this.keys=m.subarray(m[3+c.length],y),this.bboxes=m.subarray(y),this.insert=this._insertReadonly}else{this.d=r+2*o;for(let m=0;m<this.d*this.d;m++)c.push([]);this.keys=[],this.bboxes=[]}this.n=r,this.extent=t,this.padding=o,this.scale=r/t,this.uid=0;const f=o/r*t;this.min=-f,this.max=t+f}insert(t,r,o,c,f){this._forEachCell(r,o,c,f,this._insertCell,this.uid++,void 0,void 0),this.keys.push(t),this.bboxes.push(r),this.bboxes.push(o),this.bboxes.push(c),this.bboxes.push(f)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(t,r,o,c,f,m){this.cells[f].push(m)}query(t,r,o,c,f){const m=this.min,y=this.max;if(t<=m&&r<=m&&y<=o&&y<=c&&!f)return Array.prototype.slice.call(this.keys);{const b=[];return this._forEachCell(t,r,o,c,this._queryCell,b,{},f),b}}_queryCell(t,r,o,c,f,m,y,b){const T=this.cells[f];if(T!==null){const E=this.keys,P=this.bboxes;for(let z=0;z<T.length;z++){const R=T[z];if(y[R]===void 0){const F=4*R;(b?b(P[F+0],P[F+1],P[F+2],P[F+3]):t<=P[F+2]&&r<=P[F+3]&&o>=P[F+0]&&c>=P[F+1])?(y[R]=!0,m.push(E[R])):y[R]=!1}}}}_forEachCell(t,r,o,c,f,m,y,b){const T=this._convertToCellCoord(t),E=this._convertToCellCoord(r),P=this._convertToCellCoord(o),z=this._convertToCellCoord(c);for(let R=T;R<=P;R++)for(let F=E;F<=z;F++){const $=this.d*F+R;if((!b||b(this._convertFromCellCoord(R),this._convertFromCellCoord(F),this._convertFromCellCoord(R+1),this._convertFromCellCoord(F+1)))&&f.call(this,t,r,o,c,$,m,y,b))return}}_convertFromCellCoord(t){return(t-this.padding)/this.scale}_convertToCellCoord(t){return Math.max(0,Math.min(this.d-1,Math.floor(t*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const t=this.cells,r=3+this.cells.length+1+1;let o=0;for(let m=0;m<this.cells.length;m++)o+=this.cells[m].length;const c=new Int32Array(r+o+this.keys.length+this.bboxes.length);c[0]=this.extent,c[1]=this.n,c[2]=this.padding;let f=r;for(let m=0;m<t.length;m++){const y=t[m];c[3+m]=f,c.set(y,f),f+=y.length}return c[3+t.length]=f,c.set(this.keys,f),f+=this.keys.length,c[3+t.length+1]=f,c.set(this.bboxes,f),f+=this.bboxes.length,c.buffer}static serialize(t,r){const o=t.toArrayBuffer();return r&&r.push(o),{buffer:o}}static deserialize(t){return new Gn(t.buffer)}}const ks={};function Xe(i,t,r={}){if(ks[i])throw new Error(`${i} is already registered.`);Object.defineProperty(t,"_classRegistryKey",{value:i,writeable:!1}),ks[i]={klass:t,omit:r.omit||[],shallow:r.shallow||[]}}Xe("Object",Object),Xe("TransferableGridIndex",Gn),Xe("Color",X),Xe("Error",Error),Xe("AJAXError",wi),Xe("ResolvedImage",Ke),Xe("StylePropertyFunction",wo),Xe("StyleExpression",ca,{omit:["_evaluator"]}),Xe("ZoomDependentExpression",Un),Xe("ZoomConstantExpression",vo),Xe("CompoundExpression",Jr,{omit:["_evaluate"]});for(const i in jn)jn[i]._classRegistryKey||Xe(`Expression_${i}`,jn[i]);function qc(i){return i&&typeof ArrayBuffer<"u"&&(i instanceof ArrayBuffer||i.constructor&&i.constructor.name==="ArrayBuffer")}function Ao(i){return i.$name||i.constructor._classRegistryKey}function Gc(i){return!function(t){if(t===null||typeof t!="object")return!1;const r=Ao(t);return!(!r||r==="Object")}(i)&&(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||i instanceof Blob||i instanceof Error||qc(i)||oi(i)||ArrayBuffer.isView(i)||i instanceof ImageData)}function Po(i,t){if(Gc(i))return(qc(i)||oi(i))&&t&&t.push(i),ArrayBuffer.isView(i)&&t&&t.push(i.buffer),i instanceof ImageData&&t&&t.push(i.data.buffer),i;if(Array.isArray(i)){const f=[];for(const m of i)f.push(Po(m,t));return f}if(typeof i!="object")throw new Error("can't serialize object of type "+typeof i);const r=Ao(i);if(!r)throw new Error(`can't serialize object of unregistered class ${i.constructor.name}`);if(!ks[r])throw new Error(`${r} is not registered.`);const{klass:o}=ks[r],c=o.serialize?o.serialize(i,t):{};if(o.serialize){if(t&&c===t[t.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const f in i){if(!i.hasOwnProperty(f)||ks[r].omit.indexOf(f)>=0)continue;const m=i[f];c[f]=ks[r].shallow.indexOf(f)>=0?m:Po(m,t)}i instanceof Error&&(c.message=i.message)}if(c.$name)throw new Error("$name property is reserved for worker serialization logic.");return r!=="Object"&&(c.$name=r),c}function Hn(i){if(Gc(i))return i;if(Array.isArray(i))return i.map(Hn);if(typeof i!="object")throw new Error("can't deserialize object of type "+typeof i);const t=Ao(i)||"Object";if(!ks[t])throw new Error(`can't deserialize unregistered class ${t}`);const{klass:r}=ks[t];if(!r)throw new Error(`can't deserialize unregistered class ${t}`);if(r.deserialize)return r.deserialize(i);const o=Object.create(r.prototype);for(const c of Object.keys(i)){if(c==="$name")continue;const f=i[c];o[c]=ks[t].shallow.indexOf(c)>=0?f:Hn(f)}return o}class Il{constructor(){this.first=!0}update(t,r){const o=Math.floor(t);return this.first?(this.first=!1,this.lastIntegerZoom=o,this.lastIntegerZoomTime=0,this.lastZoom=t,this.lastFloorZoom=o,!0):(this.lastFloorZoom>o?(this.lastIntegerZoom=o+1,this.lastIntegerZoomTime=r):this.lastFloorZoom<o&&(this.lastIntegerZoom=o,this.lastIntegerZoomTime=r),t!==this.lastZoom&&(this.lastZoom=t,this.lastFloorZoom=o,!0))}}const Nt={"Latin-1 Supplement":i=>i>=128&&i<=255,"Hangul Jamo":i=>i>=4352&&i<=4607,Khmer:i=>i>=6016&&i<=6143,"General Punctuation":i=>i>=8192&&i<=8303,"Letterlike Symbols":i=>i>=8448&&i<=8527,"Number Forms":i=>i>=8528&&i<=8591,"Miscellaneous Technical":i=>i>=8960&&i<=9215,"Control Pictures":i=>i>=9216&&i<=9279,"Optical Character Recognition":i=>i>=9280&&i<=9311,"Enclosed Alphanumerics":i=>i>=9312&&i<=9471,"Geometric Shapes":i=>i>=9632&&i<=9727,"Miscellaneous Symbols":i=>i>=9728&&i<=9983,"Miscellaneous Symbols and Arrows":i=>i>=11008&&i<=11263,"Ideographic Description Characters":i=>i>=12272&&i<=12287,"CJK Symbols and Punctuation":i=>i>=12288&&i<=12351,Katakana:i=>i>=12448&&i<=12543,Kanbun:i=>i>=12688&&i<=12703,"CJK Strokes":i=>i>=12736&&i<=12783,"Enclosed CJK Letters and Months":i=>i>=12800&&i<=13055,"CJK Compatibility":i=>i>=13056&&i<=13311,"Yijing Hexagram Symbols":i=>i>=19904&&i<=19967,"Private Use Area":i=>i>=57344&&i<=63743,"Vertical Forms":i=>i>=65040&&i<=65055,"CJK Compatibility Forms":i=>i>=65072&&i<=65103,"Small Form Variants":i=>i>=65104&&i<=65135,"Halfwidth and Fullwidth Forms":i=>i>=65280&&i<=65519};function Tl(i){for(const t of i)if(El(t.charCodeAt(0)))return!0;return!1}function lu(i){for(const t of i)if(!hu(t.charCodeAt(0)))return!1;return!0}function kl(i){const t=i.map(r=>{try{return new RegExp(`\\p{sc=${r}}`,"u").source}catch{return null}}).filter(r=>r);return new RegExp(t.join("|"),"u")}const cu=kl(["Arab","Dupl","Mong","Ougr","Syrc"]);function hu(i){return!cu.test(String.fromCodePoint(i))}const wn=kl(["Bopo","Hani","Hira","Kana","Kits","Nshu","Tang","Yiii"]);function El(i){return!(i!==746&&i!==747&&(i<4352||!(Nt["CJK Compatibility Forms"](i)&&!(i>=65097&&i<=65103)||Nt["CJK Compatibility"](i)||Nt["CJK Strokes"](i)||!(!Nt["CJK Symbols and Punctuation"](i)||i>=12296&&i<=12305||i>=12308&&i<=12319||i===12336)||Nt["Enclosed CJK Letters and Months"](i)||Nt["Ideographic Description Characters"](i)||Nt.Kanbun(i)||Nt.Katakana(i)&&i!==12540||!(!Nt["Halfwidth and Fullwidth Forms"](i)||i===65288||i===65289||i===65293||i>=65306&&i<=65310||i===65339||i===65341||i===65343||i>=65371&&i<=65503||i===65507||i>=65512&&i<=65519)||!(!Nt["Small Form Variants"](i)||i>=65112&&i<=65118||i>=65123&&i<=65126)||Nt["Vertical Forms"](i)||Nt["Yijing Hexagram Symbols"](i)||new RegExp("\\p{sc=Cans}","u").test(String.fromCodePoint(i))||new RegExp("\\p{sc=Hang}","u").test(String.fromCodePoint(i))||wn.test(String.fromCodePoint(i)))))}function Hc(i){return!(El(i)||function(t){return!!(Nt["Latin-1 Supplement"](t)&&(t===167||t===169||t===174||t===177||t===188||t===189||t===190||t===215||t===247)||Nt["General Punctuation"](t)&&(t===8214||t===8224||t===8225||t===8240||t===8241||t===8251||t===8252||t===8258||t===8263||t===8264||t===8265||t===8273)||Nt["Letterlike Symbols"](t)||Nt["Number Forms"](t)||Nt["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||t===9003||t>=9085&&t<=9114||t>=9150&&t<=9165||t===9167||t>=9169&&t<=9179||t>=9186&&t<=9215)||Nt["Control Pictures"](t)&&t!==9251||Nt["Optical Character Recognition"](t)||Nt["Enclosed Alphanumerics"](t)||Nt["Geometric Shapes"](t)||Nt["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||Nt["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||Nt["CJK Symbols and Punctuation"](t)||Nt.Katakana(t)||Nt["Private Use Area"](t)||Nt["CJK Compatibility Forms"](t)||Nt["Small Form Variants"](t)||Nt["Halfwidth and Fullwidth Forms"](t)||t===8734||t===8756||t===8757||t>=9984&&t<=10087||t>=10102&&t<=10131||t===65532||t===65533)}(i))}const uu=kl(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function Zc(i){return uu.test(String.fromCodePoint(i))}function Wc(i,t){return!(!t&&Zc(i)||i>=2304&&i<=3583||i>=3840&&i<=4255||Nt.Khmer(i))}function du(i){for(const t of i)if(Zc(t.charCodeAt(0)))return!0;return!1}const Sn=new class{constructor(){this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null}setState(i){this.pluginStatus=i.pluginStatus,this.pluginURL=i.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(i){this.applyArabicShaping=i.applyArabicShaping,this.processBidirectionalText=i.processBidirectionalText,this.processStyledBidirectionalText=i.processStyledBidirectionalText}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getPluginURL(){return this.pluginURL}getRTLTextPluginStatus(){return this.pluginStatus}};class ti{constructor(t,r){this.zoom=t,r?(this.now=r.now,this.fadeDuration=r.fadeDuration,this.zoomHistory=r.zoomHistory,this.transition=r.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new Il,this.transition={})}isSupportedScript(t){return function(r,o){for(const c of r)if(!Wc(c.charCodeAt(0),o))return!1;return!0}(t,Sn.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const t=this.zoom,r=t-Math.floor(t),o=this.crossFadingFactor();return t>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:r+(1-r)*o}:{fromScale:.5,toScale:1,t:1-(1-o)*r}}}class Co{constructor(t,r){this.property=t,this.value=r,this.expression=function(o,c){if(la(o))return new wo(o,c);if(xo(o)){const f=bo(o,c);if(f.result==="error")throw new Error(f.value.map(m=>`${m.key}: ${m.message}`).join(", "));return f.value}{let f=o;return c.type==="color"&&typeof o=="string"?f=X.parse(o):c.type!=="padding"||typeof o!="number"&&!Array.isArray(o)?c.type==="variableAnchorOffsetCollection"&&Array.isArray(o)&&(f=Te.parse(o)):f=Me.parse(o),{kind:"constant",evaluate:()=>f}}}(r===void 0?t.specification.default:r,t.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(t,r,o){return this.property.possiblyEvaluate(this,t,r,o)}}class Mo{constructor(t){this.property=t,this.value=new Co(t,void 0)}transitioned(t,r){return new ga(this.property,this.value,r,yt({},t.transition,this.transition),t.now)}untransitioned(){return new ga(this.property,this.value,null,{},0)}}class Al{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues)}getValue(t){return Lt(this._values[t].value.value)}setValue(t,r){Object.prototype.hasOwnProperty.call(this._values,t)||(this._values[t]=new Mo(this._values[t].property)),this._values[t].value=new Co(this._values[t].property,r===null?void 0:Lt(r))}getTransition(t){return Lt(this._values[t].transition)}setTransition(t,r){Object.prototype.hasOwnProperty.call(this._values,t)||(this._values[t]=new Mo(this._values[t].property)),this._values[t].transition=Lt(r)||void 0}serialize(){const t={};for(const r of Object.keys(this._values)){const o=this.getValue(r);o!==void 0&&(t[r]=o);const c=this.getTransition(r);c!==void 0&&(t[`${r}-transition`]=c)}return t}transitioned(t,r){const o=new Xc(this._properties);for(const c of Object.keys(this._values))o._values[c]=this._values[c].transitioned(t,r._values[c]);return o}untransitioned(){const t=new Xc(this._properties);for(const r of Object.keys(this._values))t._values[r]=this._values[r].untransitioned();return t}}class ga{constructor(t,r,o,c,f){this.property=t,this.value=r,this.begin=f+c.delay||0,this.end=this.begin+c.duration||0,t.specification.transition&&(c.delay||c.duration)&&(this.prior=o)}possiblyEvaluate(t,r,o){const c=t.now||0,f=this.value.possiblyEvaluate(t,r,o),m=this.prior;if(m){if(c>this.end)return this.prior=null,f;if(this.value.isDataDriven())return this.prior=null,f;if(c<this.begin)return m.possiblyEvaluate(t,r,o);{const y=(c-this.begin)/(this.end-this.begin);return this.property.interpolate(m.possiblyEvaluate(t,r,o),f,function(b){if(b<=0)return 0;if(b>=1)return 1;const T=b*b,E=T*b;return 4*(b<.5?E:3*(b-T)+E-.75)}(y))}}return f}}class Xc{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,r,o){const c=new xa(this._properties);for(const f of Object.keys(this._values))c._values[f]=this._values[f].possiblyEvaluate(t,r,o);return c}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class ya{constructor(t){this._properties=t,this._values=Object.create(t.defaultPropertyValues)}hasValue(t){return this._values[t].value!==void 0}getValue(t){return Lt(this._values[t].value)}setValue(t,r){this._values[t]=new Co(this._values[t].property,r===null?void 0:Lt(r))}serialize(){const t={};for(const r of Object.keys(this._values)){const o=this.getValue(r);o!==void 0&&(t[r]=o)}return t}possiblyEvaluate(t,r,o){const c=new xa(this._properties);for(const f of Object.keys(this._values))c._values[f]=this._values[f].possiblyEvaluate(t,r,o);return c}}class Tr{constructor(t,r,o){this.property=t,this.value=r,this.parameters=o}isConstant(){return this.value.kind==="constant"}constantOr(t){return this.value.kind==="constant"?this.value.value:t}evaluate(t,r,o,c){return this.property.evaluate(this.value,this.parameters,t,r,o,c)}}class xa{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class lt{constructor(t){this.specification=t}possiblyEvaluate(t,r){if(t.isDataDriven())throw new Error("Value should not be data driven");return t.expression.evaluate(r)}interpolate(t,r,o){const c=Sr[this.specification.type];return c?c(t,r,o):t}}class dt{constructor(t,r){this.specification=t,this.overrides=r}possiblyEvaluate(t,r,o,c){return new Tr(this,t.expression.kind==="constant"||t.expression.kind==="camera"?{kind:"constant",value:t.expression.evaluate(r,null,{},o,c)}:t.expression,r)}interpolate(t,r,o){if(t.value.kind!=="constant"||r.value.kind!=="constant")return t;if(t.value.value===void 0||r.value.value===void 0)return new Tr(this,{kind:"constant",value:void 0},t.parameters);const c=Sr[this.specification.type];if(c){const f=c(t.value.value,r.value.value,o);return new Tr(this,{kind:"constant",value:f},t.parameters)}return t}evaluate(t,r,o,c,f,m){return t.kind==="constant"?t.value:t.evaluate(r,o,c,f,m)}}class va extends dt{possiblyEvaluate(t,r,o,c){if(t.value===void 0)return new Tr(this,{kind:"constant",value:void 0},r);if(t.expression.kind==="constant"){const f=t.expression.evaluate(r,null,{},o,c),m=t.property.specification.type==="resolvedImage"&&typeof f!="string"?f.name:f,y=this._calculate(m,m,m,r);return new Tr(this,{kind:"constant",value:y},r)}if(t.expression.kind==="camera"){const f=this._calculate(t.expression.evaluate({zoom:r.zoom-1}),t.expression.evaluate({zoom:r.zoom}),t.expression.evaluate({zoom:r.zoom+1}),r);return new Tr(this,{kind:"constant",value:f},r)}return new Tr(this,t.expression,r)}evaluate(t,r,o,c,f,m){if(t.kind==="source"){const y=t.evaluate(r,o,c,f,m);return this._calculate(y,y,y,r)}return t.kind==="composite"?this._calculate(t.evaluate({zoom:Math.floor(r.zoom)-1},o,c),t.evaluate({zoom:Math.floor(r.zoom)},o,c),t.evaluate({zoom:Math.floor(r.zoom)+1},o,c),r):t.value}_calculate(t,r,o,c){return c.zoom>c.zoomHistory.lastIntegerZoom?{from:t,to:r}:{from:o,to:r}}interpolate(t){return t}}class Pl{constructor(t){this.specification=t}possiblyEvaluate(t,r,o,c){if(t.value!==void 0){if(t.expression.kind==="constant"){const f=t.expression.evaluate(r,null,{},o,c);return this._calculate(f,f,f,r)}return this._calculate(t.expression.evaluate(new ti(Math.floor(r.zoom-1),r)),t.expression.evaluate(new ti(Math.floor(r.zoom),r)),t.expression.evaluate(new ti(Math.floor(r.zoom+1),r)),r)}}_calculate(t,r,o,c){return c.zoom>c.zoomHistory.lastIntegerZoom?{from:t,to:r}:{from:o,to:r}}interpolate(t){return t}}class ba{constructor(t){this.specification=t}possiblyEvaluate(t,r,o,c){return!!t.expression.evaluate(r,null,{},o,c)}interpolate(){return!1}}class kr{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const r in t){const o=t[r];o.specification.overridable&&this.overridableProperties.push(r);const c=this.defaultPropertyValues[r]=new Co(o,void 0),f=this.defaultTransitionablePropertyValues[r]=new Mo(o);this.defaultTransitioningPropertyValues[r]=f.untransitioned(),this.defaultPossiblyEvaluatedValues[r]=c.possiblyEvaluate({})}}}Xe("DataDrivenProperty",dt),Xe("DataConstantProperty",lt),Xe("CrossFadedDataDrivenProperty",va),Xe("CrossFadedProperty",Pl),Xe("ColorRampProperty",ba);const p="-transition";class e extends zs{constructor(t,r){if(super(),this.id=t.id,this.type=t.type,this._featureFilter={filter:()=>!0,needGeometry:!1},t.type!=="custom"&&(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,t.type!=="background"&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),r.layout&&(this._unevaluatedLayout=new ya(r.layout)),r.paint)){this._transitionablePaint=new Al(r.paint);for(const o in t.paint)this.setPaintProperty(o,t.paint[o],{validate:!1});for(const o in t.layout)this.setLayoutProperty(o,t.layout[o],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new xa(r.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(t){return t==="visibility"?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,r,o={}){r!=null&&this._validate(Vc,`layers.${this.id}.layout.${t}`,t,r,o)||(t!=="visibility"?this._unevaluatedLayout.setValue(t,r):this.visibility=r)}getPaintProperty(t){return t.endsWith(p)?this._transitionablePaint.getTransition(t.slice(0,-11)):this._transitionablePaint.getValue(t)}setPaintProperty(t,r,o={}){if(r!=null&&this._validate(au,`layers.${this.id}.paint.${t}`,t,r,o))return!1;if(t.endsWith(p))return this._transitionablePaint.setTransition(t.slice(0,-11),r||void 0),!1;{const c=this._transitionablePaint._values[t],f=c.property.specification["property-type"]==="cross-faded-data-driven",m=c.value.isDataDriven(),y=c.value;this._transitionablePaint.setValue(t,r),this._handleSpecialPaintPropertyUpdate(t);const b=this._transitionablePaint._values[t].value;return b.isDataDriven()||m||f||this._handleOverridablePaintPropertyUpdate(t,y,b)}}_handleSpecialPaintPropertyUpdate(t){}_handleOverridablePaintPropertyUpdate(t,r,o){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||this.visibility==="none"}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,r){t.getCrossfadeParameters&&(this._crossfadeParameters=t.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,r)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,r)}serialize(){const t={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(t.layout=t.layout||{},t.layout.visibility=this.visibility),ji(t,(r,o)=>!(r===void 0||o==="layout"&&!Object.keys(r).length||o==="paint"&&!Object.keys(r).length))}_validate(t,r,o,c,f={}){return(!f||f.validate!==!1)&&Sl(this,t.call(bn,{key:r,layerType:this.type,objectKey:o,value:c,styleSpec:be,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const t in this.paint._values){const r=this.paint.get(t);if(r instanceof Tr&&$n(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}return!1}}const s={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class a{constructor(t,r){this._structArray=t,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class l{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,r){return t._trim(),r&&(t.isTransferred=!0,r.push(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const r=Object.create(this.prototype);return r.arrayBuffer=t.arrayBuffer,r.length=t.length,r.capacity=t.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function d(i,t=1){let r=0,o=0;return{members:i.map(c=>{const f=s[c.type].BYTES_PER_ELEMENT,m=r=v(r,Math.max(t,f)),y=c.components||1;return o=Math.max(o,f),r+=f*y,{name:c.name,type:c.type,components:y,offset:m}}),size:v(r,Math.max(o,t)),alignment:t}}function v(i,t){return Math.ceil(i/t)*t}class w extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,r)}emplace(t,r,o){const c=2*t;return this.int16[c+0]=r,this.int16[c+1]=o,t}}w.prototype.bytesPerElement=4,Xe("StructArrayLayout2i4",w);class I extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o){const c=this.length;return this.resize(c+1),this.emplace(c,t,r,o)}emplace(t,r,o,c){const f=3*t;return this.int16[f+0]=r,this.int16[f+1]=o,this.int16[f+2]=c,t}}I.prototype.bytesPerElement=6,Xe("StructArrayLayout3i6",I);class A extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,c){const f=this.length;return this.resize(f+1),this.emplace(f,t,r,o,c)}emplace(t,r,o,c,f){const m=4*t;return this.int16[m+0]=r,this.int16[m+1]=o,this.int16[m+2]=c,this.int16[m+3]=f,t}}A.prototype.bytesPerElement=8,Xe("StructArrayLayout4i8",A);class C extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,c,f,m){const y=this.length;return this.resize(y+1),this.emplace(y,t,r,o,c,f,m)}emplace(t,r,o,c,f,m,y){const b=6*t;return this.int16[b+0]=r,this.int16[b+1]=o,this.int16[b+2]=c,this.int16[b+3]=f,this.int16[b+4]=m,this.int16[b+5]=y,t}}C.prototype.bytesPerElement=12,Xe("StructArrayLayout2i4i12",C);class M extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,c,f,m){const y=this.length;return this.resize(y+1),this.emplace(y,t,r,o,c,f,m)}emplace(t,r,o,c,f,m,y){const b=4*t,T=8*t;return this.int16[b+0]=r,this.int16[b+1]=o,this.uint8[T+4]=c,this.uint8[T+5]=f,this.uint8[T+6]=m,this.uint8[T+7]=y,t}}M.prototype.bytesPerElement=8,Xe("StructArrayLayout2i4ub8",M);class O extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,r)}emplace(t,r,o){const c=2*t;return this.float32[c+0]=r,this.float32[c+1]=o,t}}O.prototype.bytesPerElement=8,Xe("StructArrayLayout2f8",O);class V extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,o,c,f,m,y,b,T,E){const P=this.length;return this.resize(P+1),this.emplace(P,t,r,o,c,f,m,y,b,T,E)}emplace(t,r,o,c,f,m,y,b,T,E,P){const z=10*t;return this.uint16[z+0]=r,this.uint16[z+1]=o,this.uint16[z+2]=c,this.uint16[z+3]=f,this.uint16[z+4]=m,this.uint16[z+5]=y,this.uint16[z+6]=b,this.uint16[z+7]=T,this.uint16[z+8]=E,this.uint16[z+9]=P,t}}V.prototype.bytesPerElement=20,Xe("StructArrayLayout10ui20",V);class H extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,o,c,f,m,y,b,T,E,P,z){const R=this.length;return this.resize(R+1),this.emplace(R,t,r,o,c,f,m,y,b,T,E,P,z)}emplace(t,r,o,c,f,m,y,b,T,E,P,z,R){const F=12*t;return this.int16[F+0]=r,this.int16[F+1]=o,this.int16[F+2]=c,this.int16[F+3]=f,this.uint16[F+4]=m,this.uint16[F+5]=y,this.uint16[F+6]=b,this.uint16[F+7]=T,this.int16[F+8]=E,this.int16[F+9]=P,this.int16[F+10]=z,this.int16[F+11]=R,t}}H.prototype.bytesPerElement=24,Xe("StructArrayLayout4i4ui4i24",H);class ee extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,o){const c=this.length;return this.resize(c+1),this.emplace(c,t,r,o)}emplace(t,r,o,c){const f=3*t;return this.float32[f+0]=r,this.float32[f+1]=o,this.float32[f+2]=c,t}}ee.prototype.bytesPerElement=12,Xe("StructArrayLayout3f12",ee);class re extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint32[1*t+0]=r,t}}re.prototype.bytesPerElement=4,Xe("StructArrayLayout1ul4",re);class se extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,o,c,f,m,y,b,T){const E=this.length;return this.resize(E+1),this.emplace(E,t,r,o,c,f,m,y,b,T)}emplace(t,r,o,c,f,m,y,b,T,E){const P=10*t,z=5*t;return this.int16[P+0]=r,this.int16[P+1]=o,this.int16[P+2]=c,this.int16[P+3]=f,this.int16[P+4]=m,this.int16[P+5]=y,this.uint32[z+3]=b,this.uint16[P+8]=T,this.uint16[P+9]=E,t}}se.prototype.bytesPerElement=20,Xe("StructArrayLayout6i1ul2ui20",se);class ae extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,c,f,m){const y=this.length;return this.resize(y+1),this.emplace(y,t,r,o,c,f,m)}emplace(t,r,o,c,f,m,y){const b=6*t;return this.int16[b+0]=r,this.int16[b+1]=o,this.int16[b+2]=c,this.int16[b+3]=f,this.int16[b+4]=m,this.int16[b+5]=y,t}}ae.prototype.bytesPerElement=12,Xe("StructArrayLayout2i2i2i12",ae);class Y extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,c,f){const m=this.length;return this.resize(m+1),this.emplace(m,t,r,o,c,f)}emplace(t,r,o,c,f,m){const y=4*t,b=8*t;return this.float32[y+0]=r,this.float32[y+1]=o,this.float32[y+2]=c,this.int16[b+6]=f,this.int16[b+7]=m,t}}Y.prototype.bytesPerElement=16,Xe("StructArrayLayout2f1f2i16",Y);class ue extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,r,o,c,f,m){const y=this.length;return this.resize(y+1),this.emplace(y,t,r,o,c,f,m)}emplace(t,r,o,c,f,m,y){const b=16*t,T=4*t,E=8*t;return this.uint8[b+0]=r,this.uint8[b+1]=o,this.float32[T+1]=c,this.float32[T+2]=f,this.int16[E+6]=m,this.int16[E+7]=y,t}}ue.prototype.bytesPerElement=16,Xe("StructArrayLayout2ub2f2i16",ue);class pe extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,o){const c=this.length;return this.resize(c+1),this.emplace(c,t,r,o)}emplace(t,r,o,c){const f=3*t;return this.uint16[f+0]=r,this.uint16[f+1]=o,this.uint16[f+2]=c,t}}pe.prototype.bytesPerElement=6,Xe("StructArrayLayout3ui6",pe);class ye extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,o,c,f,m,y,b,T,E,P,z,R,F,$,Q,ie){const _e=this.length;return this.resize(_e+1),this.emplace(_e,t,r,o,c,f,m,y,b,T,E,P,z,R,F,$,Q,ie)}emplace(t,r,o,c,f,m,y,b,T,E,P,z,R,F,$,Q,ie,_e){const ce=24*t,me=12*t,Se=48*t;return this.int16[ce+0]=r,this.int16[ce+1]=o,this.uint16[ce+2]=c,this.uint16[ce+3]=f,this.uint32[me+2]=m,this.uint32[me+3]=y,this.uint32[me+4]=b,this.uint16[ce+10]=T,this.uint16[ce+11]=E,this.uint16[ce+12]=P,this.float32[me+7]=z,this.float32[me+8]=R,this.uint8[Se+36]=F,this.uint8[Se+37]=$,this.uint8[Se+38]=Q,this.uint32[me+10]=ie,this.int16[ce+22]=_e,t}}ye.prototype.bytesPerElement=48,Xe("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",ye);class Ce extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,o,c,f,m,y,b,T,E,P,z,R,F,$,Q,ie,_e,ce,me,Se,ze,We,ft,Ge,Ve,at,it){const Ye=this.length;return this.resize(Ye+1),this.emplace(Ye,t,r,o,c,f,m,y,b,T,E,P,z,R,F,$,Q,ie,_e,ce,me,Se,ze,We,ft,Ge,Ve,at,it)}emplace(t,r,o,c,f,m,y,b,T,E,P,z,R,F,$,Q,ie,_e,ce,me,Se,ze,We,ft,Ge,Ve,at,it,Ye){const ke=32*t,ct=16*t;return this.int16[ke+0]=r,this.int16[ke+1]=o,this.int16[ke+2]=c,this.int16[ke+3]=f,this.int16[ke+4]=m,this.int16[ke+5]=y,this.int16[ke+6]=b,this.int16[ke+7]=T,this.uint16[ke+8]=E,this.uint16[ke+9]=P,this.uint16[ke+10]=z,this.uint16[ke+11]=R,this.uint16[ke+12]=F,this.uint16[ke+13]=$,this.uint16[ke+14]=Q,this.uint16[ke+15]=ie,this.uint16[ke+16]=_e,this.uint16[ke+17]=ce,this.uint16[ke+18]=me,this.uint16[ke+19]=Se,this.uint16[ke+20]=ze,this.uint16[ke+21]=We,this.uint16[ke+22]=ft,this.uint32[ct+12]=Ge,this.float32[ct+13]=Ve,this.float32[ct+14]=at,this.uint16[ke+30]=it,this.uint16[ke+31]=Ye,t}}Ce.prototype.bytesPerElement=64,Xe("StructArrayLayout8i15ui1ul2f2ui64",Ce);class Re extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.float32[1*t+0]=r,t}}Re.prototype.bytesPerElement=4,Xe("StructArrayLayout1f4",Re);class qe extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,o){const c=this.length;return this.resize(c+1),this.emplace(c,t,r,o)}emplace(t,r,o,c){const f=3*t;return this.uint16[6*t+0]=r,this.float32[f+1]=o,this.float32[f+2]=c,t}}qe.prototype.bytesPerElement=12,Xe("StructArrayLayout1ui2f12",qe);class Je extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r,o){const c=this.length;return this.resize(c+1),this.emplace(c,t,r,o)}emplace(t,r,o,c){const f=4*t;return this.uint32[2*t+0]=r,this.uint16[f+2]=o,this.uint16[f+3]=c,t}}Je.prototype.bytesPerElement=8,Xe("StructArrayLayout1ul2ui8",Je);class Ne extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,r)}emplace(t,r,o){const c=2*t;return this.uint16[c+0]=r,this.uint16[c+1]=o,t}}Ne.prototype.bytesPerElement=4,Xe("StructArrayLayout2ui4",Ne);class Be extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const r=this.length;return this.resize(r+1),this.emplace(r,t)}emplace(t,r){return this.uint16[1*t+0]=r,t}}Be.prototype.bytesPerElement=2,Xe("StructArrayLayout1ui2",Be);class rt extends l{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,r,o,c){const f=this.length;return this.resize(f+1),this.emplace(f,t,r,o,c)}emplace(t,r,o,c,f){const m=4*t;return this.float32[m+0]=r,this.float32[m+1]=o,this.float32[m+2]=c,this.float32[m+3]=f,t}}rt.prototype.bytesPerElement=16,Xe("StructArrayLayout4f16",rt);class It extends a{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new J(this.anchorPointX,this.anchorPointY)}}It.prototype.size=20;class Ue extends se{get(t){return new It(this,t)}}Xe("CollisionBoxArray",Ue);class Ze extends a{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(t){this._structArray.uint8[this._pos1+37]=t}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(t){this._structArray.uint8[this._pos1+38]=t}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(t){this._structArray.uint32[this._pos4+10]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}Ze.prototype.size=48;class bt extends ye{get(t){return new Ze(this,t)}}Xe("PlacedSymbolArray",bt);class yi extends a{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(t){this._structArray.uint32[this._pos4+12]=t}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}yi.prototype.size=64;class Pt extends Ce{get(t){return new yi(this,t)}}Xe("SymbolInstanceArray",Pt);class $t extends Re{getoffsetX(t){return this.float32[1*t+0]}}Xe("GlyphOffsetArray",$t);class xi extends I{getx(t){return this.int16[3*t+0]}gety(t){return this.int16[3*t+1]}gettileUnitDistanceFromAnchor(t){return this.int16[3*t+2]}}Xe("SymbolLineVertexArray",xi);class rr extends a{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}rr.prototype.size=12;class ls extends qe{get(t){return new rr(this,t)}}Xe("TextAnchorOffsetArray",ls);class vi extends a{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}vi.prototype.size=8;class Er extends Je{get(t){return new vi(this,t)}}Xe("FeatureIndexArray",Er);class fr extends w{}class mr extends w{}class _r extends w{}class Es extends C{}class Zn extends M{}class wa extends O{}class cs extends V{}class In extends H{}class Sa extends ee{}class Cl extends re{}class jr extends ae{}class hs extends ue{}class Nr extends pe{}class Ks extends Ne{}const gr=d([{name:"a_pos",components:2,type:"Int16"}],4),{members:sr}=gr;class ai{constructor(t=[]){this.segments=t}prepareSegment(t,r,o,c){let f=this.segments[this.segments.length-1];return t>ai.MAX_VERTEX_ARRAY_LENGTH&&pi(`Max vertices per segment is ${ai.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!f||f.vertexLength+t>ai.MAX_VERTEX_ARRAY_LENGTH||f.sortKey!==c)&&(f={vertexOffset:r.length,primitiveOffset:o.length,vertexLength:0,primitiveLength:0},c!==void 0&&(f.sortKey=c),this.segments.push(f)),f}get(){return this.segments}destroy(){for(const t of this.segments)for(const r in t.vaos)t.vaos[r].destroy()}static simpleSegment(t,r,o,c){return new ai([{vertexOffset:t,primitiveOffset:r,vertexLength:o,primitiveLength:c,vaos:{},sortKey:0}])}}function Ei(i,t){return 256*(i=Yt(Math.floor(i),0,255))+Yt(Math.floor(t),0,255)}ai.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Xe("SegmentVector",ai);const Ls=d([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var Wn={exports:{}},Ia={exports:{}};Ia.exports=function(i,t){var r,o,c,f,m,y,b,T;for(o=i.length-(r=3&i.length),c=t,m=3432918353,y=461845907,T=0;T<o;)b=255&i.charCodeAt(T)|(255&i.charCodeAt(++T))<<8|(255&i.charCodeAt(++T))<<16|(255&i.charCodeAt(++T))<<24,++T,c=27492+(65535&(f=5*(65535&(c=(c^=b=(65535&(b=(b=(65535&b)*m+(((b>>>16)*m&65535)<<16)&4294967295)<<15|b>>>17))*y+(((b>>>16)*y&65535)<<16)&4294967295)<<13|c>>>19))+((5*(c>>>16)&65535)<<16)&4294967295))+((58964+(f>>>16)&65535)<<16);switch(b=0,r){case 3:b^=(255&i.charCodeAt(T+2))<<16;case 2:b^=(255&i.charCodeAt(T+1))<<8;case 1:c^=b=(65535&(b=(b=(65535&(b^=255&i.charCodeAt(T)))*m+(((b>>>16)*m&65535)<<16)&4294967295)<<15|b>>>17))*y+(((b>>>16)*y&65535)<<16)&4294967295}return c^=i.length,c=2246822507*(65535&(c^=c>>>16))+((2246822507*(c>>>16)&65535)<<16)&4294967295,c=3266489909*(65535&(c^=c>>>13))+((3266489909*(c>>>16)&65535)<<16)&4294967295,(c^=c>>>16)>>>0};var pu=Ia.exports,Jc={exports:{}};Jc.exports=function(i,t){for(var r,o=i.length,c=t^o,f=0;o>=4;)r=1540483477*(65535&(r=255&i.charCodeAt(f)|(255&i.charCodeAt(++f))<<8|(255&i.charCodeAt(++f))<<16|(255&i.charCodeAt(++f))<<24))+((1540483477*(r>>>16)&65535)<<16),c=1540483477*(65535&c)+((1540483477*(c>>>16)&65535)<<16)^(r=1540483477*(65535&(r^=r>>>24))+((1540483477*(r>>>16)&65535)<<16)),o-=4,++f;switch(o){case 3:c^=(255&i.charCodeAt(f+2))<<16;case 2:c^=(255&i.charCodeAt(f+1))<<8;case 1:c=1540483477*(65535&(c^=255&i.charCodeAt(f)))+((1540483477*(c>>>16)&65535)<<16)}return c=1540483477*(65535&(c^=c>>>13))+((1540483477*(c>>>16)&65535)<<16),(c^=c>>>15)>>>0};var Kc=pu,Tn=Jc.exports;Wn.exports=Kc,Wn.exports.murmur3=Kc,Wn.exports.murmur2=Tn;var Ta=N(Wn.exports);class zo{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(t,r,o,c){this.ids.push(Ml(t)),this.positions.push(r,o,c)}getPositions(t){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const r=Ml(t);let o=0,c=this.ids.length-1;for(;o<c;){const m=o+c>>1;this.ids[m]>=r?c=m:o=m+1}const f=[];for(;this.ids[o]===r;)f.push({index:this.positions[3*o],start:this.positions[3*o+1],end:this.positions[3*o+2]}),o++;return f}static serialize(t,r){const o=new Float64Array(t.ids),c=new Uint32Array(t.positions);return Do(o,c,0,o.length-1),r&&r.push(o.buffer,c.buffer),{ids:o,positions:c}}static deserialize(t){const r=new zo;return r.ids=t.ids,r.positions=t.positions,r.indexed=!0,r}}function Ml(i){const t=+i;return!isNaN(t)&&t<=Number.MAX_SAFE_INTEGER?t:Ta(String(i))}function Do(i,t,r,o){for(;r<o;){const c=i[r+o>>1];let f=r-1,m=o+1;for(;;){do f++;while(i[f]<c);do m--;while(i[m]>c);if(f>=m)break;Lo(i,f,m),Lo(t,3*f,3*m),Lo(t,3*f+1,3*m+1),Lo(t,3*f+2,3*m+2)}m-r<o-m?(Do(i,t,r,m),r=m+1):(Do(i,t,m+1,o),o=m)}}function Lo(i,t,r){const o=i[t];i[t]=i[r],i[r]=o}Xe("FeaturePositionMap",zo);class Rs{constructor(t,r){this.gl=t.gl,this.location=r}}class Yc extends Rs{constructor(t,r){super(t,r),this.current=0}set(t){this.current!==t&&(this.current=t,this.gl.uniform1f(this.location,t))}}class Vd extends Rs{constructor(t,r){super(t,r),this.current=[0,0,0,0]}set(t){t[0]===this.current[0]&&t[1]===this.current[1]&&t[2]===this.current[2]&&t[3]===this.current[3]||(this.current=t,this.gl.uniform4f(this.location,t[0],t[1],t[2],t[3]))}}class qd extends Rs{constructor(t,r){super(t,r),this.current=X.transparent}set(t){t.r===this.current.r&&t.g===this.current.g&&t.b===this.current.b&&t.a===this.current.a||(this.current=t,this.gl.uniform4f(this.location,t.r,t.g,t.b,t.a))}}const Qm=new Float32Array(16);function fu(i){return[Ei(255*i.r,255*i.g),Ei(255*i.b,255*i.a)]}class zl{constructor(t,r,o){this.value=t,this.uniformNames=r.map(c=>`u_${c}`),this.type=o}setUniform(t,r,o){t.set(o.constantOr(this.value))}getBinding(t,r,o){return this.type==="color"?new qd(t,r):new Yc(t,r)}}class ka{constructor(t,r){this.uniformNames=r.map(o=>`u_${o}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(t,r){this.pixelRatioFrom=r.pixelRatio,this.pixelRatioTo=t.pixelRatio,this.patternFrom=r.tlbr,this.patternTo=t.tlbr}setUniform(t,r,o,c){const f=c==="u_pattern_to"?this.patternTo:c==="u_pattern_from"?this.patternFrom:c==="u_pixel_ratio_to"?this.pixelRatioTo:c==="u_pixel_ratio_from"?this.pixelRatioFrom:null;f&&t.set(f)}getBinding(t,r,o){return o.substr(0,9)==="u_pattern"?new Vd(t,r):new Yc(t,r)}}class kn{constructor(t,r,o,c){this.expression=t,this.type=o,this.maxValue=0,this.paintVertexAttributes=r.map(f=>({name:`a_${f}`,type:"Float32",components:o==="color"?2:1,offset:0})),this.paintVertexArray=new c}populatePaintArray(t,r,o,c,f){const m=this.paintVertexArray.length,y=this.expression.evaluate(new ti(0),r,{},c,[],f);this.paintVertexArray.resize(t),this._setPaintValue(m,t,y)}updatePaintArray(t,r,o,c){const f=this.expression.evaluate({zoom:0},o,c);this._setPaintValue(t,r,f)}_setPaintValue(t,r,o){if(this.type==="color"){const c=fu(o);for(let f=t;f<r;f++)this.paintVertexArray.emplace(f,c[0],c[1])}else{for(let c=t;c<r;c++)this.paintVertexArray.emplace(c,o);this.maxValue=Math.max(this.maxValue,Math.abs(o))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Os{constructor(t,r,o,c,f,m){this.expression=t,this.uniformNames=r.map(y=>`u_${y}_t`),this.type=o,this.useIntegerZoom=c,this.zoom=f,this.maxValue=0,this.paintVertexAttributes=r.map(y=>({name:`a_${y}`,type:"Float32",components:o==="color"?4:2,offset:0})),this.paintVertexArray=new m}populatePaintArray(t,r,o,c,f){const m=this.expression.evaluate(new ti(this.zoom),r,{},c,[],f),y=this.expression.evaluate(new ti(this.zoom+1),r,{},c,[],f),b=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(b,t,m,y)}updatePaintArray(t,r,o,c){const f=this.expression.evaluate({zoom:this.zoom},o,c),m=this.expression.evaluate({zoom:this.zoom+1},o,c);this._setPaintValue(t,r,f,m)}_setPaintValue(t,r,o,c){if(this.type==="color"){const f=fu(o),m=fu(c);for(let y=t;y<r;y++)this.paintVertexArray.emplace(y,f[0],f[1],m[0],m[1])}else{for(let f=t;f<r;f++)this.paintVertexArray.emplace(f,o,c);this.maxValue=Math.max(this.maxValue,Math.abs(o),Math.abs(c))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,r){const o=this.useIntegerZoom?Math.floor(r.zoom):r.zoom,c=Yt(this.expression.interpolationFactor(o,this.zoom,this.zoom+1),0,1);t.set(c)}getBinding(t,r,o){return new Yc(t,r)}}class Xn{constructor(t,r,o,c,f,m){this.expression=t,this.type=r,this.useIntegerZoom=o,this.zoom=c,this.layerId=m,this.zoomInPaintVertexArray=new f,this.zoomOutPaintVertexArray=new f}populatePaintArray(t,r,o){const c=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(t),this.zoomOutPaintVertexArray.resize(t),this._setPaintValues(c,t,r.patterns&&r.patterns[this.layerId],o)}updatePaintArray(t,r,o,c,f){this._setPaintValues(t,r,o.patterns&&o.patterns[this.layerId],f)}_setPaintValues(t,r,o,c){if(!c||!o)return;const{min:f,mid:m,max:y}=o,b=c[f],T=c[m],E=c[y];if(b&&T&&E)for(let P=t;P<r;P++)this.zoomInPaintVertexArray.emplace(P,T.tl[0],T.tl[1],T.br[0],T.br[1],b.tl[0],b.tl[1],b.br[0],b.br[1],T.pixelRatio,b.pixelRatio),this.zoomOutPaintVertexArray.emplace(P,T.tl[0],T.tl[1],T.br[0],T.br[1],E.tl[0],E.tl[1],E.br[0],E.br[1],T.pixelRatio,E.pixelRatio)}upload(t){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=t.createVertexBuffer(this.zoomInPaintVertexArray,Ls.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=t.createVertexBuffer(this.zoomOutPaintVertexArray,Ls.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class Gd{constructor(t,r,o){this.binders={},this._buffers=[];const c=[];for(const f in t.paint._values){if(!o(f))continue;const m=t.paint.get(f);if(!(m instanceof Tr&&$n(m.property.specification)))continue;const y=e_(f,t.type),b=m.value,T=m.property.specification.type,E=m.property.useIntegerZoom,P=m.property.specification["property-type"],z=P==="cross-faded"||P==="cross-faded-data-driven";if(b.kind==="constant")this.binders[f]=z?new ka(b.value,y):new zl(b.value,y,T),c.push(`/u_${f}`);else if(b.kind==="source"||z){const R=Hd(f,T,"source");this.binders[f]=z?new Xn(b,T,E,r,R,t.id):new kn(b,y,T,R),c.push(`/a_${f}`)}else{const R=Hd(f,T,"composite");this.binders[f]=new Os(b,y,T,E,r,R),c.push(`/z_${f}`)}}this.cacheKey=c.sort().join("")}getMaxValue(t){const r=this.binders[t];return r instanceof kn||r instanceof Os?r.maxValue:0}populatePaintArrays(t,r,o,c,f){for(const m in this.binders){const y=this.binders[m];(y instanceof kn||y instanceof Os||y instanceof Xn)&&y.populatePaintArray(t,r,o,c,f)}}setConstantPatternPositions(t,r){for(const o in this.binders){const c=this.binders[o];c instanceof ka&&c.setConstantPatternPositions(t,r)}}updatePaintArrays(t,r,o,c,f){let m=!1;for(const y in t){const b=r.getPositions(y);for(const T of b){const E=o.feature(T.index);for(const P in this.binders){const z=this.binders[P];if((z instanceof kn||z instanceof Os||z instanceof Xn)&&z.expression.isStateDependent===!0){const R=c.paint.get(P);z.expression=R.value,z.updatePaintArray(T.start,T.end,E,t[y],f),m=!0}}}}return m}defines(){const t=[];for(const r in this.binders){const o=this.binders[r];(o instanceof zl||o instanceof ka)&&t.push(...o.uniformNames.map(c=>`#define HAS_UNIFORM_${c}`))}return t}getBinderAttributes(){const t=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof kn||o instanceof Os)for(let c=0;c<o.paintVertexAttributes.length;c++)t.push(o.paintVertexAttributes[c].name);else if(o instanceof Xn)for(let c=0;c<Ls.members.length;c++)t.push(Ls.members[c].name)}return t}getBinderUniforms(){const t=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof zl||o instanceof ka||o instanceof Os)for(const c of o.uniformNames)t.push(c)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t,r){const o=[];for(const c in this.binders){const f=this.binders[c];if(f instanceof zl||f instanceof ka||f instanceof Os){for(const m of f.uniformNames)if(r[m]){const y=f.getBinding(t,r[m],m);o.push({name:m,property:c,binding:y})}}}return o}setUniforms(t,r,o,c){for(const{name:f,property:m,binding:y}of r)this.binders[m].setUniform(y,c,o.get(m),f)}updatePaintBuffers(t){this._buffers=[];for(const r in this.binders){const o=this.binders[r];if(t&&o instanceof Xn){const c=t.fromScale===2?o.zoomInPaintVertexBuffer:o.zoomOutPaintVertexBuffer;c&&this._buffers.push(c)}else(o instanceof kn||o instanceof Os)&&o.paintVertexBuffer&&this._buffers.push(o.paintVertexBuffer)}}upload(t){for(const r in this.binders){const o=this.binders[r];(o instanceof kn||o instanceof Os||o instanceof Xn)&&o.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const r=this.binders[t];(r instanceof kn||r instanceof Os||r instanceof Xn)&&r.destroy()}}}class Ro{constructor(t,r,o=()=>!0){this.programConfigurations={};for(const c of t)this.programConfigurations[c.id]=new Gd(c,r,o);this.needsUpload=!1,this._featureMap=new zo,this._bufferOffset=0}populatePaintArrays(t,r,o,c,f,m){for(const y in this.programConfigurations)this.programConfigurations[y].populatePaintArrays(t,r,c,f,m);r.id!==void 0&&this._featureMap.add(r.id,o,this._bufferOffset,t),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,r,o,c){for(const f of o)this.needsUpload=this.programConfigurations[f.id].updatePaintArrays(t,this._featureMap,r,f,c)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}function e_(i,t){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[i]||[i.replace(`${t}-`,"").replace(/-/g,"_")]}function Hd(i,t,r){const o={color:{source:O,composite:rt},number:{source:Re,composite:O}},c=function(f){return{"line-pattern":{source:cs,composite:cs},"fill-pattern":{source:cs,composite:cs},"fill-extrusion-pattern":{source:cs,composite:cs}}[f]}(i);return c&&c[r]||o[t][r]}Xe("ConstantBinder",zl),Xe("CrossFadedConstantBinder",ka),Xe("SourceExpressionBinder",kn),Xe("CrossFadedCompositeBinder",Xn),Xe("CompositeExpressionBinder",Os),Xe("ProgramConfiguration",Gd,{omit:["_buffers"]}),Xe("ProgramConfigurationSet",Ro);const Ui=8192,mu=Math.pow(2,14)-1,Zd=-mu-1;function Oo(i){const t=Ui/i.extent,r=i.loadGeometry();for(let o=0;o<r.length;o++){const c=r[o];for(let f=0;f<c.length;f++){const m=c[f],y=Math.round(m.x*t),b=Math.round(m.y*t);m.x=Yt(y,Zd,mu),m.y=Yt(b,Zd,mu),(y<m.x||y>m.x+1||b<m.y||b>m.y+1)&&pi("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return r}function Fo(i,t){return{type:i.type,id:i.id,properties:i.properties,geometry:t?Oo(i):[]}}function Qc(i,t,r,o,c){i.emplaceBack(2*t+(o+1)/2,2*r+(c+1)/2)}class _u{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.hasPattern=!1,this.layoutVertexArray=new mr,this.indexArray=new Nr,this.segments=new ai,this.programConfigurations=new Ro(t.layers,t.zoom),this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(t,r,o){const c=this.layers[0],f=[];let m=null,y=!1;c.type==="circle"&&(m=c.layout.get("circle-sort-key"),y=!m.isConstant());for(const{feature:b,id:T,index:E,sourceLayerIndex:P}of t){const z=this.layers[0]._featureFilter.needGeometry,R=Fo(b,z);if(!this.layers[0]._featureFilter.filter(new ti(this.zoom),R,o))continue;const F=y?m.evaluate(R,{},o):void 0,$={id:T,properties:b.properties,type:b.type,sourceLayerIndex:P,index:E,geometry:z?R.geometry:Oo(b),patterns:{},sortKey:F};f.push($)}y&&f.sort((b,T)=>b.sortKey-T.sortKey);for(const b of f){const{geometry:T,index:E,sourceLayerIndex:P}=b,z=t[E].feature;this.addFeature(b,T,E,o),r.featureIndex.insert(z,T,E,P,this.index)}}update(t,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,r,this.stateDependentLayers,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,sr),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,r,o,c){for(const f of r)for(const m of f){const y=m.x,b=m.y;if(y<0||y>=Ui||b<0||b>=Ui)continue;const T=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),E=T.vertexLength;Qc(this.layoutVertexArray,y,b,-1,-1),Qc(this.layoutVertexArray,y,b,1,-1),Qc(this.layoutVertexArray,y,b,1,1),Qc(this.layoutVertexArray,y,b,-1,1),this.indexArray.emplaceBack(E,E+1,E+2),this.indexArray.emplaceBack(E,E+3,E+2),T.vertexLength+=4,T.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,{},c)}}function Wd(i,t){for(let r=0;r<i.length;r++)if(Ea(t,i[r]))return!0;for(let r=0;r<t.length;r++)if(Ea(i,t[r]))return!0;return!!gu(i,t)}function t_(i,t,r){return!!Ea(i,t)||!!yu(t,i,r)}function Xd(i,t){if(i.length===1)return Kd(t,i[0]);for(let r=0;r<t.length;r++){const o=t[r];for(let c=0;c<o.length;c++)if(Ea(i,o[c]))return!0}for(let r=0;r<i.length;r++)if(Kd(t,i[r]))return!0;for(let r=0;r<t.length;r++)if(gu(i,t[r]))return!0;return!1}function i_(i,t,r){if(i.length>1){if(gu(i,t))return!0;for(let o=0;o<t.length;o++)if(yu(t[o],i,r))return!0}for(let o=0;o<i.length;o++)if(yu(i[o],t,r))return!0;return!1}function gu(i,t){if(i.length===0||t.length===0)return!1;for(let r=0;r<i.length-1;r++){const o=i[r],c=i[r+1];for(let f=0;f<t.length-1;f++)if(r_(o,c,t[f],t[f+1]))return!0}return!1}function r_(i,t,r,o){return De(i,r,o)!==De(t,r,o)&&De(i,t,r)!==De(i,t,o)}function yu(i,t,r){const o=r*r;if(t.length===1)return i.distSqr(t[0])<o;for(let c=1;c<t.length;c++)if(Jd(i,t[c-1],t[c])<o)return!0;return!1}function Jd(i,t,r){const o=t.distSqr(r);if(o===0)return i.distSqr(t);const c=((i.x-t.x)*(r.x-t.x)+(i.y-t.y)*(r.y-t.y))/o;return i.distSqr(c<0?t:c>1?r:r.sub(t)._mult(c)._add(t))}function Kd(i,t){let r,o,c,f=!1;for(let m=0;m<i.length;m++){r=i[m];for(let y=0,b=r.length-1;y<r.length;b=y++)o=r[y],c=r[b],o.y>t.y!=c.y>t.y&&t.x<(c.x-o.x)*(t.y-o.y)/(c.y-o.y)+o.x&&(f=!f)}return f}function Ea(i,t){let r=!1;for(let o=0,c=i.length-1;o<i.length;c=o++){const f=i[o],m=i[c];f.y>t.y!=m.y>t.y&&t.x<(m.x-f.x)*(t.y-f.y)/(m.y-f.y)+f.x&&(r=!r)}return r}function s_(i,t,r){const o=r[0],c=r[2];if(i.x<o.x&&t.x<o.x||i.x>c.x&&t.x>c.x||i.y<o.y&&t.y<o.y||i.y>c.y&&t.y>c.y)return!1;const f=De(i,t,r[0]);return f!==De(i,t,r[1])||f!==De(i,t,r[2])||f!==De(i,t,r[3])}function Dl(i,t,r){const o=t.paint.get(i).value;return o.kind==="constant"?o.value:r.programConfigurations.get(t.id).getMaxValue(i)}function eh(i){return Math.sqrt(i[0]*i[0]+i[1]*i[1])}function th(i,t,r,o,c){if(!t[0]&&!t[1])return i;const f=J.convert(t)._mult(c);r==="viewport"&&f._rotate(-o);const m=[];for(let y=0;y<i.length;y++)m.push(i[y].sub(f));return m}let Yd,Qd;Xe("CircleBucket",_u,{omit:["layers"]});var n_={get paint(){return Qd=Qd||new kr({"circle-radius":new dt(be.paint_circle["circle-radius"]),"circle-color":new dt(be.paint_circle["circle-color"]),"circle-blur":new dt(be.paint_circle["circle-blur"]),"circle-opacity":new dt(be.paint_circle["circle-opacity"]),"circle-translate":new lt(be.paint_circle["circle-translate"]),"circle-translate-anchor":new lt(be.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new lt(be.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new lt(be.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new dt(be.paint_circle["circle-stroke-width"]),"circle-stroke-color":new dt(be.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new dt(be.paint_circle["circle-stroke-opacity"])})},get layout(){return Yd=Yd||new kr({"circle-sort-key":new dt(be.layout_circle["circle-sort-key"])})}},Ar=1e-6,Aa=typeof Float32Array<"u"?Float32Array:Array;function xu(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function ep(i,t,r){var o=t[0],c=t[1],f=t[2],m=t[3],y=t[4],b=t[5],T=t[6],E=t[7],P=t[8],z=t[9],R=t[10],F=t[11],$=t[12],Q=t[13],ie=t[14],_e=t[15],ce=r[0],me=r[1],Se=r[2],ze=r[3];return i[0]=ce*o+me*y+Se*P+ze*$,i[1]=ce*c+me*b+Se*z+ze*Q,i[2]=ce*f+me*T+Se*R+ze*ie,i[3]=ce*m+me*E+Se*F+ze*_e,i[4]=(ce=r[4])*o+(me=r[5])*y+(Se=r[6])*P+(ze=r[7])*$,i[5]=ce*c+me*b+Se*z+ze*Q,i[6]=ce*f+me*T+Se*R+ze*ie,i[7]=ce*m+me*E+Se*F+ze*_e,i[8]=(ce=r[8])*o+(me=r[9])*y+(Se=r[10])*P+(ze=r[11])*$,i[9]=ce*c+me*b+Se*z+ze*Q,i[10]=ce*f+me*T+Se*R+ze*ie,i[11]=ce*m+me*E+Se*F+ze*_e,i[12]=(ce=r[12])*o+(me=r[13])*y+(Se=r[14])*P+(ze=r[15])*$,i[13]=ce*c+me*b+Se*z+ze*Q,i[14]=ce*f+me*T+Se*R+ze*ie,i[15]=ce*m+me*E+Se*F+ze*_e,i}Math.hypot||(Math.hypot=function(){for(var i=0,t=arguments.length;t--;)i+=arguments[t]*arguments[t];return Math.sqrt(i)});var Ll,o_=ep;function ih(i,t,r){var o=t[0],c=t[1],f=t[2],m=t[3];return i[0]=r[0]*o+r[4]*c+r[8]*f+r[12]*m,i[1]=r[1]*o+r[5]*c+r[9]*f+r[13]*m,i[2]=r[2]*o+r[6]*c+r[10]*f+r[14]*m,i[3]=r[3]*o+r[7]*c+r[11]*f+r[15]*m,i}Ll=new Aa(4),Aa!=Float32Array&&(Ll[0]=0,Ll[1]=0,Ll[2]=0,Ll[3]=0);class a_ extends e{constructor(t){super(t,n_)}createBucket(t){return new _u(t)}queryRadius(t){const r=t;return Dl("circle-radius",this,r)+Dl("circle-stroke-width",this,r)+eh(this.paint.get("circle-translate"))}queryIntersectsFeature(t,r,o,c,f,m,y,b){const T=th(t,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),m.angle,y),E=this.paint.get("circle-radius").evaluate(r,o)+this.paint.get("circle-stroke-width").evaluate(r,o),P=this.paint.get("circle-pitch-alignment")==="map",z=P?T:function(F,$){return F.map(Q=>tp(Q,$))}(T,b),R=P?E*y:E;for(const F of c)for(const $ of F){const Q=P?$:tp($,b);let ie=R;const _e=ih([],[$.x,$.y,0,1],b);if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?ie*=_e[3]/m.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(ie*=m.cameraToCenterDistance/_e[3]),t_(z,Q,ie))return!0}return!1}}function tp(i,t){const r=ih([],[i.x,i.y,0,1],t);return new J(r[0]/r[3],r[1]/r[3])}class ip extends _u{}let rp;Xe("HeatmapBucket",ip,{omit:["layers"]});var l_={get paint(){return rp=rp||new kr({"heatmap-radius":new dt(be.paint_heatmap["heatmap-radius"]),"heatmap-weight":new dt(be.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new lt(be.paint_heatmap["heatmap-intensity"]),"heatmap-color":new ba(be.paint_heatmap["heatmap-color"]),"heatmap-opacity":new lt(be.paint_heatmap["heatmap-opacity"])})}};function vu(i,{width:t,height:r},o,c){if(c){if(c instanceof Uint8ClampedArray)c=new Uint8Array(c.buffer);else if(c.length!==t*r*o)throw new RangeError(`mismatched image size. expected: ${c.length} but got: ${t*r*o}`)}else c=new Uint8Array(t*r*o);return i.width=t,i.height=r,i.data=c,i}function sp(i,{width:t,height:r},o){if(t===i.width&&r===i.height)return;const c=vu({},{width:t,height:r},o);bu(i,c,{x:0,y:0},{x:0,y:0},{width:Math.min(i.width,t),height:Math.min(i.height,r)},o),i.width=t,i.height=r,i.data=c.data}function bu(i,t,r,o,c,f){if(c.width===0||c.height===0)return t;if(c.width>i.width||c.height>i.height||r.x>i.width-c.width||r.y>i.height-c.height)throw new RangeError("out of range source coordinates for image copy");if(c.width>t.width||c.height>t.height||o.x>t.width-c.width||o.y>t.height-c.height)throw new RangeError("out of range destination coordinates for image copy");const m=i.data,y=t.data;if(m===y)throw new Error("srcData equals dstData, so image is already copied");for(let b=0;b<c.height;b++){const T=((r.y+b)*i.width+r.x)*f,E=((o.y+b)*t.width+o.x)*f;for(let P=0;P<c.width*f;P++)y[E+P]=m[T+P]}return t}class Rl{constructor(t,r){vu(this,t,1,r)}resize(t){sp(this,t,1)}clone(){return new Rl({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,r,o,c,f){bu(t,r,o,c,f,1)}}class us{constructor(t,r){vu(this,t,4,r)}resize(t){sp(this,t,4)}replace(t,r){r?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new us({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,r,o,c,f){bu(t,r,o,c,f,4)}}function np(i){const t={},r=i.resolution||256,o=i.clips?i.clips.length:1,c=i.image||new us({width:r,height:o});if(Math.log(r)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${r}`);const f=(m,y,b)=>{t[i.evaluationKey]=b;const T=i.expression.evaluate(t);c.data[m+y+0]=Math.floor(255*T.r/T.a),c.data[m+y+1]=Math.floor(255*T.g/T.a),c.data[m+y+2]=Math.floor(255*T.b/T.a),c.data[m+y+3]=Math.floor(255*T.a)};if(i.clips)for(let m=0,y=0;m<o;++m,y+=4*r)for(let b=0,T=0;b<r;b++,T+=4){const E=b/(r-1),{start:P,end:z}=i.clips[m];f(y,T,P*(1-E)+z*E)}else for(let m=0,y=0;m<r;m++,y+=4)f(0,y,m/(r-1));return c}Xe("AlphaImage",Rl),Xe("RGBAImage",us);const wu="big-fb";class c_ extends e{createBucket(t){return new ip(t)}constructor(t){super(t,l_),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){t==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=np({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(wu)&&this.heatmapFbos.delete(wu)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let op;var h_={get paint(){return op=op||new kr({"hillshade-illumination-direction":new lt(be.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new lt(be.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new lt(be.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new lt(be.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new lt(be.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new lt(be.paint_hillshade["hillshade-accent-color"])})}};class u_ extends e{constructor(t){super(t,h_)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}const d_=d([{name:"a_pos",components:2,type:"Int16"}],4),{members:p_}=d_;function ap(i,t,r=2){const o=t&&t.length,c=o?t[0]*r:i.length;let f=lp(i,0,c,r,!0);const m=[];if(!f||f.next===f.prev)return m;let y,b,T;if(o&&(f=function(E,P,z,R){const F=[];for(let $=0,Q=P.length;$<Q;$++){const ie=lp(E,P[$]*R,$<Q-1?P[$+1]*R:E.length,R,!1);ie===ie.next&&(ie.steiner=!0),F.push(b_(ie))}F.sort(y_);for(let $=0;$<F.length;$++)z=x_(F[$],z);return z}(i,t,f,r)),i.length>80*r){y=1/0,b=1/0;let E=-1/0,P=-1/0;for(let z=r;z<c;z+=r){const R=i[z],F=i[z+1];R<y&&(y=R),F<b&&(b=F),R>E&&(E=R),F>P&&(P=F)}T=Math.max(E-y,P-b),T=T!==0?32767/T:0}return Ol(f,m,r,y,b,T,0),m}function lp(i,t,r,o,c){let f;if(c===function(m,y,b,T){let E=0;for(let P=y,z=b-T;P<b;P+=T)E+=(m[z]-m[P])*(m[P+1]+m[z+1]),z=P;return E}(i,t,r,o)>0)for(let m=t;m<r;m+=o)f=up(m/o|0,i[m],i[m+1],f);else for(let m=r-o;m>=t;m-=o)f=up(m/o|0,i[m],i[m+1],f);return f&&rh(f,f.next)&&(Bl(f),f=f.next),f}function Bo(i,t){if(!i)return i;t||(t=i);let r,o=i;do if(r=!1,o.steiner||!rh(o,o.next)&&Fi(o.prev,o,o.next)!==0)o=o.next;else{if(Bl(o),o=t=o.prev,o===o.next)break;r=!0}while(r||o!==t);return t}function Ol(i,t,r,o,c,f,m){if(!i)return;!m&&f&&function(b,T,E,P){let z=b;do z.z===0&&(z.z=Su(z.x,z.y,T,E,P)),z.prevZ=z.prev,z.nextZ=z.next,z=z.next;while(z!==b);z.prevZ.nextZ=null,z.prevZ=null,function(R){let F,$=1;do{let Q,ie=R;R=null;let _e=null;for(F=0;ie;){F++;let ce=ie,me=0;for(let ze=0;ze<$&&(me++,ce=ce.nextZ,ce);ze++);let Se=$;for(;me>0||Se>0&&ce;)me!==0&&(Se===0||!ce||ie.z<=ce.z)?(Q=ie,ie=ie.nextZ,me--):(Q=ce,ce=ce.nextZ,Se--),_e?_e.nextZ=Q:R=Q,Q.prevZ=_e,_e=Q;ie=ce}_e.nextZ=null,$*=2}while(F>1)}(z)}(i,o,c,f);let y=i;for(;i.prev!==i.next;){const b=i.prev,T=i.next;if(f?m_(i,o,c,f):f_(i))t.push(b.i,i.i,T.i),Bl(i),i=T.next,y=T.next;else if((i=T)===y){m?m===1?Ol(i=__(Bo(i),t),t,r,o,c,f,2):m===2&&g_(i,t,r,o,c,f):Ol(Bo(i),t,r,o,c,f,1);break}}}function f_(i){const t=i.prev,r=i,o=i.next;if(Fi(t,r,o)>=0)return!1;const c=t.x,f=r.x,m=o.x,y=t.y,b=r.y,T=o.y,E=c<f?c<m?c:m:f<m?f:m,P=y<b?y<T?y:T:b<T?b:T,z=c>f?c>m?c:m:f>m?f:m,R=y>b?y>T?y:T:b>T?b:T;let F=o.next;for(;F!==t;){if(F.x>=E&&F.x<=z&&F.y>=P&&F.y<=R&&Pa(c,y,f,b,m,T,F.x,F.y)&&Fi(F.prev,F,F.next)>=0)return!1;F=F.next}return!0}function m_(i,t,r,o){const c=i.prev,f=i,m=i.next;if(Fi(c,f,m)>=0)return!1;const y=c.x,b=f.x,T=m.x,E=c.y,P=f.y,z=m.y,R=y<b?y<T?y:T:b<T?b:T,F=E<P?E<z?E:z:P<z?P:z,$=y>b?y>T?y:T:b>T?b:T,Q=E>P?E>z?E:z:P>z?P:z,ie=Su(R,F,t,r,o),_e=Su($,Q,t,r,o);let ce=i.prevZ,me=i.nextZ;for(;ce&&ce.z>=ie&&me&&me.z<=_e;){if(ce.x>=R&&ce.x<=$&&ce.y>=F&&ce.y<=Q&&ce!==c&&ce!==m&&Pa(y,E,b,P,T,z,ce.x,ce.y)&&Fi(ce.prev,ce,ce.next)>=0||(ce=ce.prevZ,me.x>=R&&me.x<=$&&me.y>=F&&me.y<=Q&&me!==c&&me!==m&&Pa(y,E,b,P,T,z,me.x,me.y)&&Fi(me.prev,me,me.next)>=0))return!1;me=me.nextZ}for(;ce&&ce.z>=ie;){if(ce.x>=R&&ce.x<=$&&ce.y>=F&&ce.y<=Q&&ce!==c&&ce!==m&&Pa(y,E,b,P,T,z,ce.x,ce.y)&&Fi(ce.prev,ce,ce.next)>=0)return!1;ce=ce.prevZ}for(;me&&me.z<=_e;){if(me.x>=R&&me.x<=$&&me.y>=F&&me.y<=Q&&me!==c&&me!==m&&Pa(y,E,b,P,T,z,me.x,me.y)&&Fi(me.prev,me,me.next)>=0)return!1;me=me.nextZ}return!0}function __(i,t){let r=i;do{const o=r.prev,c=r.next.next;!rh(o,c)&&cp(o,r,r.next,c)&&Fl(o,c)&&Fl(c,o)&&(t.push(o.i,r.i,c.i),Bl(r),Bl(r.next),r=i=c),r=r.next}while(r!==i);return Bo(r)}function g_(i,t,r,o,c,f){let m=i;do{let y=m.next.next;for(;y!==m.prev;){if(m.i!==y.i&&w_(m,y)){let b=hp(m,y);return m=Bo(m,m.next),b=Bo(b,b.next),Ol(m,t,r,o,c,f,0),void Ol(b,t,r,o,c,f,0)}y=y.next}m=m.next}while(m!==i)}function y_(i,t){return i.x-t.x}function x_(i,t){const r=function(c,f){let m=f;const y=c.x,b=c.y;let T,E=-1/0;do{if(b<=m.y&&b>=m.next.y&&m.next.y!==m.y){const $=m.x+(b-m.y)*(m.next.x-m.x)/(m.next.y-m.y);if($<=y&&$>E&&(E=$,T=m.x<m.next.x?m:m.next,$===y))return T}m=m.next}while(m!==f);if(!T)return null;const P=T,z=T.x,R=T.y;let F=1/0;m=T;do{if(y>=m.x&&m.x>=z&&y!==m.x&&Pa(b<R?y:E,b,z,R,b<R?E:y,b,m.x,m.y)){const $=Math.abs(b-m.y)/(y-m.x);Fl(m,c)&&($<F||$===F&&(m.x>T.x||m.x===T.x&&v_(T,m)))&&(T=m,F=$)}m=m.next}while(m!==P);return T}(i,t);if(!r)return t;const o=hp(r,i);return Bo(o,o.next),Bo(r,r.next)}function v_(i,t){return Fi(i.prev,i,t.prev)<0&&Fi(t.next,i,i.next)<0}function Su(i,t,r,o,c){return(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-r)*c|0)|i<<8))|i<<4))|i<<2))|i<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-o)*c|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function b_(i){let t=i,r=i;do(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next;while(t!==i);return r}function Pa(i,t,r,o,c,f,m,y){return(c-m)*(t-y)>=(i-m)*(f-y)&&(i-m)*(o-y)>=(r-m)*(t-y)&&(r-m)*(f-y)>=(c-m)*(o-y)}function w_(i,t){return i.next.i!==t.i&&i.prev.i!==t.i&&!function(r,o){let c=r;do{if(c.i!==r.i&&c.next.i!==r.i&&c.i!==o.i&&c.next.i!==o.i&&cp(c,c.next,r,o))return!0;c=c.next}while(c!==r);return!1}(i,t)&&(Fl(i,t)&&Fl(t,i)&&function(r,o){let c=r,f=!1;const m=(r.x+o.x)/2,y=(r.y+o.y)/2;do c.y>y!=c.next.y>y&&c.next.y!==c.y&&m<(c.next.x-c.x)*(y-c.y)/(c.next.y-c.y)+c.x&&(f=!f),c=c.next;while(c!==r);return f}(i,t)&&(Fi(i.prev,i,t.prev)||Fi(i,t.prev,t))||rh(i,t)&&Fi(i.prev,i,i.next)>0&&Fi(t.prev,t,t.next)>0)}function Fi(i,t,r){return(t.y-i.y)*(r.x-t.x)-(t.x-i.x)*(r.y-t.y)}function rh(i,t){return i.x===t.x&&i.y===t.y}function cp(i,t,r,o){const c=nh(Fi(i,t,r)),f=nh(Fi(i,t,o)),m=nh(Fi(r,o,i)),y=nh(Fi(r,o,t));return c!==f&&m!==y||!(c!==0||!sh(i,r,t))||!(f!==0||!sh(i,o,t))||!(m!==0||!sh(r,i,o))||!(y!==0||!sh(r,t,o))}function sh(i,t,r){return t.x<=Math.max(i.x,r.x)&&t.x>=Math.min(i.x,r.x)&&t.y<=Math.max(i.y,r.y)&&t.y>=Math.min(i.y,r.y)}function nh(i){return i>0?1:i<0?-1:0}function Fl(i,t){return Fi(i.prev,i,i.next)<0?Fi(i,t,i.next)>=0&&Fi(i,i.prev,t)>=0:Fi(i,t,i.prev)<0||Fi(i,i.next,t)<0}function hp(i,t){const r=Iu(i.i,i.x,i.y),o=Iu(t.i,t.x,t.y),c=i.next,f=t.prev;return i.next=t,t.prev=i,r.next=c,c.prev=r,o.next=r,r.prev=o,f.next=o,o.prev=f,o}function up(i,t,r,o){const c=Iu(i,t,r);return o?(c.next=o.next,c.prev=o,o.next.prev=c,o.next=c):(c.prev=c,c.next=c),c}function Bl(i){i.next.prev=i.prev,i.prev.next=i.next,i.prevZ&&(i.prevZ.nextZ=i.nextZ),i.nextZ&&(i.nextZ.prevZ=i.prevZ)}function Iu(i,t,r){return{i,x:t,y:r,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Tu(i,t,r){const o=r.patternDependencies;let c=!1;for(const f of t){const m=f.paint.get(`${i}-pattern`);m.isConstant()||(c=!0);const y=m.constantOr(null);y&&(c=!0,o[y.to]=!0,o[y.from]=!0)}return c}function ku(i,t,r,o,c){const f=c.patternDependencies;for(const m of t){const y=m.paint.get(`${i}-pattern`).value;if(y.kind!=="constant"){let b=y.evaluate({zoom:o-1},r,{},c.availableImages),T=y.evaluate({zoom:o},r,{},c.availableImages),E=y.evaluate({zoom:o+1},r,{},c.availableImages);b=b&&b.name?b.name:b,T=T&&T.name?T.name:T,E=E&&E.name?E.name:E,f[b]=!0,f[T]=!0,f[E]=!0,r.patterns[m.id]={min:b,mid:T,max:E}}}return r}class Eu{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new _r,this.indexArray=new Nr,this.indexArray2=new Ks,this.programConfigurations=new Ro(t.layers,t.zoom),this.segments=new ai,this.segments2=new ai,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(t,r,o){this.hasPattern=Tu("fill",this.layers,r);const c=this.layers[0].layout.get("fill-sort-key"),f=!c.isConstant(),m=[];for(const{feature:y,id:b,index:T,sourceLayerIndex:E}of t){const P=this.layers[0]._featureFilter.needGeometry,z=Fo(y,P);if(!this.layers[0]._featureFilter.filter(new ti(this.zoom),z,o))continue;const R=f?c.evaluate(z,{},o,r.availableImages):void 0,F={id:b,properties:y.properties,type:y.type,sourceLayerIndex:E,index:T,geometry:P?z.geometry:Oo(y),patterns:{},sortKey:R};m.push(F)}f&&m.sort((y,b)=>y.sortKey-b.sortKey);for(const y of m){const{geometry:b,index:T,sourceLayerIndex:E}=y;if(this.hasPattern){const P=ku("fill",this.layers,y,this.zoom,r);this.patternFeatures.push(P)}else this.addFeature(y,b,T,o,{});r.featureIndex.insert(t[T].feature,b,T,E,this.index)}}update(t,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,r,this.stateDependentLayers,o)}addFeatures(t,r,o){for(const c of this.patternFeatures)this.addFeature(c,c.geometry,c.index,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,p_),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,r,o,c,f){for(const m of ra(r,500)){let y=0;for(const R of m)y+=R.length;const b=this.segments.prepareSegment(y,this.layoutVertexArray,this.indexArray),T=b.vertexLength,E=[],P=[];for(const R of m){if(R.length===0)continue;R!==m[0]&&P.push(E.length/2);const F=this.segments2.prepareSegment(R.length,this.layoutVertexArray,this.indexArray2),$=F.vertexLength;this.layoutVertexArray.emplaceBack(R[0].x,R[0].y),this.indexArray2.emplaceBack($+R.length-1,$),E.push(R[0].x),E.push(R[0].y);for(let Q=1;Q<R.length;Q++)this.layoutVertexArray.emplaceBack(R[Q].x,R[Q].y),this.indexArray2.emplaceBack($+Q-1,$+Q),E.push(R[Q].x),E.push(R[Q].y);F.vertexLength+=R.length,F.primitiveLength+=R.length}const z=ap(E,P);for(let R=0;R<z.length;R+=3)this.indexArray.emplaceBack(T+z[R],T+z[R+1],T+z[R+2]);b.vertexLength+=y,b.primitiveLength+=z.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,f,c)}}let dp,pp;Xe("FillBucket",Eu,{omit:["layers","patternFeatures"]});var S_={get paint(){return pp=pp||new kr({"fill-antialias":new lt(be.paint_fill["fill-antialias"]),"fill-opacity":new dt(be.paint_fill["fill-opacity"]),"fill-color":new dt(be.paint_fill["fill-color"]),"fill-outline-color":new dt(be.paint_fill["fill-outline-color"]),"fill-translate":new lt(be.paint_fill["fill-translate"]),"fill-translate-anchor":new lt(be.paint_fill["fill-translate-anchor"]),"fill-pattern":new va(be.paint_fill["fill-pattern"])})},get layout(){return dp=dp||new kr({"fill-sort-key":new dt(be.layout_fill["fill-sort-key"])})}};class I_ extends e{constructor(t){super(t,S_)}recalculate(t,r){super.recalculate(t,r);const o=this.paint._values["fill-outline-color"];o.value.kind==="constant"&&o.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(t){return new Eu(t)}queryRadius(){return eh(this.paint.get("fill-translate"))}queryIntersectsFeature(t,r,o,c,f,m,y){return Xd(th(t,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),m.angle,y),c)}isTileClipped(){return!0}}const T_=d([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),k_=d([{name:"a_centroid",components:2,type:"Int16"}],4),{members:E_}=T_;var Jn={},A_=q,fp=Ca;function Ca(i,t,r,o,c){this.properties={},this.extent=r,this.type=0,this._pbf=i,this._geometry=-1,this._keys=o,this._values=c,i.readFields(P_,this,t)}function P_(i,t,r){i==1?t.id=r.readVarint():i==2?function(o,c){for(var f=o.readVarint()+o.pos;o.pos<f;){var m=c._keys[o.readVarint()],y=c._values[o.readVarint()];c.properties[m]=y}}(r,t):i==3?t.type=r.readVarint():i==4&&(t._geometry=r.pos)}function C_(i){for(var t,r,o=0,c=0,f=i.length,m=f-1;c<f;m=c++)o+=((r=i[m]).x-(t=i[c]).x)*(t.y+r.y);return o}Ca.types=["Unknown","Point","LineString","Polygon"],Ca.prototype.loadGeometry=function(){var i=this._pbf;i.pos=this._geometry;for(var t,r=i.readVarint()+i.pos,o=1,c=0,f=0,m=0,y=[];i.pos<r;){if(c<=0){var b=i.readVarint();o=7&b,c=b>>3}if(c--,o===1||o===2)f+=i.readSVarint(),m+=i.readSVarint(),o===1&&(t&&y.push(t),t=[]),t.push(new A_(f,m));else{if(o!==7)throw new Error("unknown command "+o);t&&t.push(t[0].clone())}}return t&&y.push(t),y},Ca.prototype.bbox=function(){var i=this._pbf;i.pos=this._geometry;for(var t=i.readVarint()+i.pos,r=1,o=0,c=0,f=0,m=1/0,y=-1/0,b=1/0,T=-1/0;i.pos<t;){if(o<=0){var E=i.readVarint();r=7&E,o=E>>3}if(o--,r===1||r===2)(c+=i.readSVarint())<m&&(m=c),c>y&&(y=c),(f+=i.readSVarint())<b&&(b=f),f>T&&(T=f);else if(r!==7)throw new Error("unknown command "+r)}return[m,b,y,T]},Ca.prototype.toGeoJSON=function(i,t,r){var o,c,f=this.extent*Math.pow(2,r),m=this.extent*i,y=this.extent*t,b=this.loadGeometry(),T=Ca.types[this.type];function E(R){for(var F=0;F<R.length;F++){var $=R[F];R[F]=[360*($.x+m)/f-180,360/Math.PI*Math.atan(Math.exp((180-360*($.y+y)/f)*Math.PI/180))-90]}}switch(this.type){case 1:var P=[];for(o=0;o<b.length;o++)P[o]=b[o][0];E(b=P);break;case 2:for(o=0;o<b.length;o++)E(b[o]);break;case 3:for(b=function(R){var F=R.length;if(F<=1)return[R];for(var $,Q,ie=[],_e=0;_e<F;_e++){var ce=C_(R[_e]);ce!==0&&(Q===void 0&&(Q=ce<0),Q===ce<0?($&&ie.push($),$=[R[_e]]):$.push(R[_e]))}return $&&ie.push($),ie}(b),o=0;o<b.length;o++)for(c=0;c<b[o].length;c++)E(b[o][c])}b.length===1?b=b[0]:T="Multi"+T;var z={type:"Feature",geometry:{type:T,coordinates:b},properties:this.properties};return"id"in this&&(z.id=this.id),z};var M_=fp,mp=_p;function _p(i,t){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=i,this._keys=[],this._values=[],this._features=[],i.readFields(z_,this,t),this.length=this._features.length}function z_(i,t,r){i===15?t.version=r.readVarint():i===1?t.name=r.readString():i===5?t.extent=r.readVarint():i===2?t._features.push(r.pos):i===3?t._keys.push(r.readString()):i===4&&t._values.push(function(o){for(var c=null,f=o.readVarint()+o.pos;o.pos<f;){var m=o.readVarint()>>3;c=m===1?o.readString():m===2?o.readFloat():m===3?o.readDouble():m===4?o.readVarint64():m===5?o.readVarint():m===6?o.readSVarint():m===7?o.readBoolean():null}return c}(r))}_p.prototype.feature=function(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];var t=this._pbf.readVarint()+this._pbf.pos;return new M_(this._pbf,t,this.extent,this._keys,this._values)};var D_=mp;function L_(i,t,r){if(i===3){var o=new D_(r,r.readVarint()+r.pos);o.length&&(t[o.name]=o)}}Jn.VectorTile=function(i,t){this.layers=i.readFields(L_,{},t)},Jn.VectorTileFeature=fp,Jn.VectorTileLayer=mp;const R_=Jn.VectorTileFeature.types,Au=Math.pow(2,13);function jl(i,t,r,o,c,f,m,y){i.emplaceBack(t,r,2*Math.floor(o*Au)+m,c*Au*2,f*Au*2,Math.round(y))}class Pu{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.hasPattern=!1,this.layoutVertexArray=new Es,this.centroidVertexArray=new fr,this.indexArray=new Nr,this.programConfigurations=new Ro(t.layers,t.zoom),this.segments=new ai,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(t,r,o){this.features=[],this.hasPattern=Tu("fill-extrusion",this.layers,r);for(const{feature:c,id:f,index:m,sourceLayerIndex:y}of t){const b=this.layers[0]._featureFilter.needGeometry,T=Fo(c,b);if(!this.layers[0]._featureFilter.filter(new ti(this.zoom),T,o))continue;const E={id:f,sourceLayerIndex:y,index:m,geometry:b?T.geometry:Oo(c),properties:c.properties,type:c.type,patterns:{}};this.hasPattern?this.features.push(ku("fill-extrusion",this.layers,E,this.zoom,r)):this.addFeature(E,E.geometry,m,o,{}),r.featureIndex.insert(c,E.geometry,m,y,this.index,!0)}}addFeatures(t,r,o){for(const c of this.features){const{geometry:f}=c;this.addFeature(c,f,c.index,r,o)}}update(t,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,r,this.stateDependentLayers,o)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,E_),this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,k_.members,!0),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(t,r,o,c,f){for(const m of ra(r,500)){const y={x:0,y:0,vertexCount:0};let b=0;for(const F of m)b+=F.length;let T=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(const F of m){if(F.length===0||F_(F))continue;let $=0;for(let Q=0;Q<F.length;Q++){const ie=F[Q];if(Q>=1){const _e=F[Q-1];if(!O_(ie,_e)){T.vertexLength+4>ai.MAX_VERTEX_ARRAY_LENGTH&&(T=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const ce=ie.sub(_e)._perp()._unit(),me=_e.dist(ie);$+me>32768&&($=0),jl(this.layoutVertexArray,ie.x,ie.y,ce.x,ce.y,0,0,$),jl(this.layoutVertexArray,ie.x,ie.y,ce.x,ce.y,0,1,$),y.x+=2*ie.x,y.y+=2*ie.y,y.vertexCount+=2,$+=me,jl(this.layoutVertexArray,_e.x,_e.y,ce.x,ce.y,0,0,$),jl(this.layoutVertexArray,_e.x,_e.y,ce.x,ce.y,0,1,$),y.x+=2*_e.x,y.y+=2*_e.y,y.vertexCount+=2;const Se=T.vertexLength;this.indexArray.emplaceBack(Se,Se+2,Se+1),this.indexArray.emplaceBack(Se+1,Se+2,Se+3),T.vertexLength+=4,T.primitiveLength+=2}}}}if(T.vertexLength+b>ai.MAX_VERTEX_ARRAY_LENGTH&&(T=this.segments.prepareSegment(b,this.layoutVertexArray,this.indexArray)),R_[t.type]!=="Polygon")continue;const E=[],P=[],z=T.vertexLength;for(const F of m)if(F.length!==0){F!==m[0]&&P.push(E.length/2);for(let $=0;$<F.length;$++){const Q=F[$];jl(this.layoutVertexArray,Q.x,Q.y,0,0,1,1,0),y.x+=Q.x,y.y+=Q.y,y.vertexCount+=1,E.push(Q.x),E.push(Q.y)}}const R=ap(E,P);for(let F=0;F<R.length;F+=3)this.indexArray.emplaceBack(z+R[F],z+R[F+2],z+R[F+1]);T.primitiveLength+=R.length/3,T.vertexLength+=b;for(let F=0;F<y.vertexCount;F++){const $=Math.floor(y.x/y.vertexCount),Q=Math.floor(y.y/y.vertexCount);this.centroidVertexArray.emplaceBack($,Q)}}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,f,c)}}function O_(i,t){return i.x===t.x&&(i.x<0||i.x>Ui)||i.y===t.y&&(i.y<0||i.y>Ui)}function F_(i){return i.every(t=>t.x<0)||i.every(t=>t.x>Ui)||i.every(t=>t.y<0)||i.every(t=>t.y>Ui)}let gp;Xe("FillExtrusionBucket",Pu,{omit:["layers","features"]});var B_={get paint(){return gp=gp||new kr({"fill-extrusion-opacity":new lt(be["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new dt(be["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new lt(be["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new lt(be["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new va(be["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new dt(be["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new dt(be["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new lt(be["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class j_ extends e{constructor(t){super(t,B_)}createBucket(t){return new Pu(t)}queryRadius(){return eh(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature(t,r,o,c,f,m,y,b){const T=th(t,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),m.angle,y),E=this.paint.get("fill-extrusion-height").evaluate(r,o),P=this.paint.get("fill-extrusion-base").evaluate(r,o),z=function(F,$,Q,ie){const _e=[];for(const ce of F){const me=[ce.x,ce.y,0,1];ih(me,me,$),_e.push(new J(me[0]/me[3],me[1]/me[3]))}return _e}(T,b),R=function(F,$,Q,ie){const _e=[],ce=[],me=ie[8]*$,Se=ie[9]*$,ze=ie[10]*$,We=ie[11]*$,ft=ie[8]*Q,Ge=ie[9]*Q,Ve=ie[10]*Q,at=ie[11]*Q;for(const it of F){const Ye=[],ke=[];for(const ct of it){const nt=ct.x,wt=ct.y,di=ie[0]*nt+ie[4]*wt+ie[12],ci=ie[1]*nt+ie[5]*wt+ie[13],Wi=ie[2]*nt+ie[6]*wt+ie[14],As=ie[3]*nt+ie[7]*wt+ie[15],or=Wi+ze,Xi=As+We,Pr=di+ft,Cr=ci+Ge,Mr=Wi+Ve,Mi=As+at,Ji=new J((di+me)/Xi,(ci+Se)/Xi);Ji.z=or/Xi,Ye.push(Ji);const yr=new J(Pr/Mi,Cr/Mi);yr.z=Mr/Mi,ke.push(yr)}_e.push(Ye),ce.push(ke)}return[_e,ce]}(c,P,E,b);return function(F,$,Q){let ie=1/0;Xd(Q,$)&&(ie=yp(Q,$[0]));for(let _e=0;_e<$.length;_e++){const ce=$[_e],me=F[_e];for(let Se=0;Se<ce.length-1;Se++){const ze=ce[Se],We=[ze,ce[Se+1],me[Se+1],me[Se],ze];Wd(Q,We)&&(ie=Math.min(ie,yp(Q,We)))}}return ie!==1/0&&ie}(R[0],R[1],z)}}function Nl(i,t){return i.x*t.x+i.y*t.y}function yp(i,t){if(i.length===1){let r=0;const o=t[r++];let c;for(;!c||o.equals(c);)if(c=t[r++],!c)return 1/0;for(;r<t.length;r++){const f=t[r],m=i[0],y=c.sub(o),b=f.sub(o),T=m.sub(o),E=Nl(y,y),P=Nl(y,b),z=Nl(b,b),R=Nl(T,y),F=Nl(T,b),$=E*z-P*P,Q=(z*R-P*F)/$,ie=(E*F-P*R)/$,_e=o.z*(1-Q-ie)+c.z*Q+f.z*ie;if(isFinite(_e))return _e}return 1/0}{let r=1/0;for(const o of t)r=Math.min(r,o.z);return r}}const N_=d([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:$_}=N_,U_=d([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:V_}=U_,q_=Jn.VectorTileFeature.types,G_=Math.cos(Math.PI/180*37.5),xp=Math.pow(2,14)/.5;class Cu{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(r=>r.id),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(r=>{this.gradients[r.id]={}}),this.layoutVertexArray=new Zn,this.layoutVertexArray2=new wa,this.indexArray=new Nr,this.programConfigurations=new Ro(t.layers,t.zoom),this.segments=new ai,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(r=>r.isStateDependent()).map(r=>r.id)}populate(t,r,o){this.hasPattern=Tu("line",this.layers,r);const c=this.layers[0].layout.get("line-sort-key"),f=!c.isConstant(),m=[];for(const{feature:y,id:b,index:T,sourceLayerIndex:E}of t){const P=this.layers[0]._featureFilter.needGeometry,z=Fo(y,P);if(!this.layers[0]._featureFilter.filter(new ti(this.zoom),z,o))continue;const R=f?c.evaluate(z,{},o):void 0,F={id:b,properties:y.properties,type:y.type,sourceLayerIndex:E,index:T,geometry:P?z.geometry:Oo(y),patterns:{},sortKey:R};m.push(F)}f&&m.sort((y,b)=>y.sortKey-b.sortKey);for(const y of m){const{geometry:b,index:T,sourceLayerIndex:E}=y;if(this.hasPattern){const P=ku("line",this.layers,y,this.zoom,r);this.patternFeatures.push(P)}else this.addFeature(y,b,T,o,{});r.featureIndex.insert(t[T].feature,b,T,E,this.index)}}update(t,r,o){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,r,this.stateDependentLayers,o)}addFeatures(t,r,o){for(const c of this.patternFeatures)this.addFeature(c,c.geometry,c.index,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,V_)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,$_),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&Object.prototype.hasOwnProperty.call(t.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(t.properties,"mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,r,o,c,f){const m=this.layers[0].layout,y=m.get("line-join").evaluate(t,{}),b=m.get("line-cap"),T=m.get("line-miter-limit"),E=m.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(const P of r)this.addLine(P,t,y,b,T,E);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,o,f,c)}addLine(t,r,o,c,f,m){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let ie=0;ie<t.length-1;ie++)this.totalDistance+=t[ie].dist(t[ie+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const y=q_[r.type]==="Polygon";let b=t.length;for(;b>=2&&t[b-1].equals(t[b-2]);)b--;let T=0;for(;T<b-1&&t[T].equals(t[T+1]);)T++;if(b<(y?3:2))return;o==="bevel"&&(f=1.05);const E=this.overscaling<=16?15*Ui/(512*this.overscaling):0,P=this.segments.prepareSegment(10*b,this.layoutVertexArray,this.indexArray);let z,R,F,$,Q;this.e1=this.e2=-1,y&&(z=t[b-2],Q=t[T].sub(z)._unit()._perp());for(let ie=T;ie<b;ie++){if(F=ie===b-1?y?t[T+1]:void 0:t[ie+1],F&&t[ie].equals(F))continue;Q&&($=Q),z&&(R=z),z=t[ie],Q=F?F.sub(z)._unit()._perp():$,$=$||Q;let _e=$.add(Q);_e.x===0&&_e.y===0||_e._unit();const ce=$.x*Q.x+$.y*Q.y,me=_e.x*Q.x+_e.y*Q.y,Se=me!==0?1/me:1/0,ze=2*Math.sqrt(2-2*me),We=me<G_&&R&&F,ft=$.x*Q.y-$.y*Q.x>0;if(We&&ie>T){const at=z.dist(R);if(at>2*E){const it=z.sub(z.sub(R)._mult(E/at)._round());this.updateDistance(R,it),this.addCurrentVertex(it,$,0,0,P),R=it}}const Ge=R&&F;let Ve=Ge?o:y?"butt":c;if(Ge&&Ve==="round"&&(Se<m?Ve="miter":Se<=2&&(Ve="fakeround")),Ve==="miter"&&Se>f&&(Ve="bevel"),Ve==="bevel"&&(Se>2&&(Ve="flipbevel"),Se<f&&(Ve="miter")),R&&this.updateDistance(R,z),Ve==="miter")_e._mult(Se),this.addCurrentVertex(z,_e,0,0,P);else if(Ve==="flipbevel"){if(Se>100)_e=Q.mult(-1);else{const at=Se*$.add(Q).mag()/$.sub(Q).mag();_e._perp()._mult(at*(ft?-1:1))}this.addCurrentVertex(z,_e,0,0,P),this.addCurrentVertex(z,_e.mult(-1),0,0,P)}else if(Ve==="bevel"||Ve==="fakeround"){const at=-Math.sqrt(Se*Se-1),it=ft?at:0,Ye=ft?0:at;if(R&&this.addCurrentVertex(z,$,it,Ye,P),Ve==="fakeround"){const ke=Math.round(180*ze/Math.PI/20);for(let ct=1;ct<ke;ct++){let nt=ct/ke;if(nt!==.5){const di=nt-.5;nt+=nt*di*(nt-1)*((1.0904+ce*(ce*(3.55645-1.43519*ce)-3.2452))*di*di+(.848013+ce*(.215638*ce-1.06021)))}const wt=Q.sub($)._mult(nt)._add($)._unit()._mult(ft?-1:1);this.addHalfVertex(z,wt.x,wt.y,!1,ft,0,P)}}F&&this.addCurrentVertex(z,Q,-it,-Ye,P)}else if(Ve==="butt")this.addCurrentVertex(z,_e,0,0,P);else if(Ve==="square"){const at=R?1:-1;this.addCurrentVertex(z,_e,at,at,P)}else Ve==="round"&&(R&&(this.addCurrentVertex(z,$,0,0,P),this.addCurrentVertex(z,$,1,1,P,!0)),F&&(this.addCurrentVertex(z,Q,-1,-1,P,!0),this.addCurrentVertex(z,Q,0,0,P)));if(We&&ie<b-1){const at=z.dist(F);if(at>2*E){const it=z.add(F.sub(z)._mult(E/at)._round());this.updateDistance(z,it),this.addCurrentVertex(it,Q,0,0,P),z=it}}}}addCurrentVertex(t,r,o,c,f,m=!1){const y=r.y*c-r.x,b=-r.y-r.x*c;this.addHalfVertex(t,r.x+r.y*o,r.y-r.x*o,m,!1,o,f),this.addHalfVertex(t,y,b,m,!0,-c,f),this.distance>xp/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(t,r,o,c,f,m))}addHalfVertex({x:t,y:r},o,c,f,m,y,b){const T=.5*(this.lineClips?this.scaledDistance*(xp-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((t<<1)+(f?1:0),(r<<1)+(m?1:0),Math.round(63*o)+128,Math.round(63*c)+128,1+(y===0?0:y<0?-1:1)|(63&T)<<2,T>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const E=b.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,E),b.primitiveLength++),m?this.e2=E:this.e1=E}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(t,r){this.distance+=t.dist(r),this.updateScaledDistance()}}let vp,bp;Xe("LineBucket",Cu,{omit:["layers","patternFeatures"]});var wp={get paint(){return bp=bp||new kr({"line-opacity":new dt(be.paint_line["line-opacity"]),"line-color":new dt(be.paint_line["line-color"]),"line-translate":new lt(be.paint_line["line-translate"]),"line-translate-anchor":new lt(be.paint_line["line-translate-anchor"]),"line-width":new dt(be.paint_line["line-width"]),"line-gap-width":new dt(be.paint_line["line-gap-width"]),"line-offset":new dt(be.paint_line["line-offset"]),"line-blur":new dt(be.paint_line["line-blur"]),"line-dasharray":new Pl(be.paint_line["line-dasharray"]),"line-pattern":new va(be.paint_line["line-pattern"]),"line-gradient":new ba(be.paint_line["line-gradient"])})},get layout(){return vp=vp||new kr({"line-cap":new lt(be.layout_line["line-cap"]),"line-join":new dt(be.layout_line["line-join"]),"line-miter-limit":new lt(be.layout_line["line-miter-limit"]),"line-round-limit":new lt(be.layout_line["line-round-limit"]),"line-sort-key":new dt(be.layout_line["line-sort-key"])})}};class H_ extends dt{possiblyEvaluate(t,r){return r=new ti(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,zoomHistory:r.zoomHistory,transition:r.transition}),super.possiblyEvaluate(t,r)}evaluate(t,r,o,c){return r=yt({},r,{zoom:Math.floor(r.zoom)}),super.evaluate(t,r,o,c)}}let oh;class Z_ extends e{constructor(t){super(t,wp),this.gradientVersion=0,oh||(oh=new H_(wp.paint.properties["line-width"].specification),oh.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(t){if(t==="line-gradient"){const r=this.gradientExpression();this.stepInterpolant=!!function(o){return o._styleExpression!==void 0}(r)&&r._styleExpression.expression instanceof On,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(t,r){super.recalculate(t,r),this.paint._values["line-floorwidth"]=oh.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,t)}createBucket(t){return new Cu(t)}queryRadius(t){const r=t,o=Sp(Dl("line-width",this,r),Dl("line-gap-width",this,r)),c=Dl("line-offset",this,r);return o/2+Math.abs(c)+eh(this.paint.get("line-translate"))}queryIntersectsFeature(t,r,o,c,f,m,y){const b=th(t,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),m.angle,y),T=y/2*Sp(this.paint.get("line-width").evaluate(r,o),this.paint.get("line-gap-width").evaluate(r,o)),E=this.paint.get("line-offset").evaluate(r,o);return E&&(c=function(P,z){const R=[];for(let F=0;F<P.length;F++){const $=P[F],Q=[];for(let ie=0;ie<$.length;ie++){const _e=$[ie-1],ce=$[ie],me=$[ie+1],Se=ie===0?new J(0,0):ce.sub(_e)._unit()._perp(),ze=ie===$.length-1?new J(0,0):me.sub(ce)._unit()._perp(),We=Se._add(ze)._unit(),ft=We.x*ze.x+We.y*ze.y;ft!==0&&We._mult(1/ft),Q.push(We._mult(z)._add(ce))}R.push(Q)}return R}(c,E*y)),function(P,z,R){for(let F=0;F<z.length;F++){const $=z[F];if(P.length>=3){for(let Q=0;Q<$.length;Q++)if(Ea(P,$[Q]))return!0}if(i_(P,$,R))return!0}return!1}(b,c,T)}isTileClipped(){return!0}}function Sp(i,t){return t>0?t+2*i:i}const W_=d([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),X_=d([{name:"a_projected_pos",components:3,type:"Float32"}],4);d([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const J_=d([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);d([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Ip=d([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),K_=d([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function Y_(i,t,r){return i.sections.forEach(o=>{o.text=function(c,f,m){const y=f.layout.get("text-transform").evaluate(m,{});return y==="uppercase"?c=c.toLocaleUpperCase():y==="lowercase"&&(c=c.toLocaleLowerCase()),Sn.applyArabicShaping&&(c=Sn.applyArabicShaping(c)),c}(o.text,t,r)}),i}d([{name:"triangle",components:3,type:"Uint16"}]),d([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),d([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),d([{type:"Float32",name:"offsetX"}]),d([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),d([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);const $l={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"};var qi=24,Tp=li,kp=function(i,t,r,o,c){var f,m,y=8*c-o-1,b=(1<<y)-1,T=b>>1,E=-7,P=c-1,z=-1,R=i[t+P];for(P+=z,f=R&(1<<-E)-1,R>>=-E,E+=y;E>0;f=256*f+i[t+P],P+=z,E-=8);for(m=f&(1<<-E)-1,f>>=-E,E+=o;E>0;m=256*m+i[t+P],P+=z,E-=8);if(f===0)f=1-T;else{if(f===b)return m?NaN:1/0*(R?-1:1);m+=Math.pow(2,o),f-=T}return(R?-1:1)*m*Math.pow(2,f-o)},Ep=function(i,t,r,o,c,f){var m,y,b,T=8*f-c-1,E=(1<<T)-1,P=E>>1,z=c===23?Math.pow(2,-24)-Math.pow(2,-77):0,R=0,F=1,$=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(y=isNaN(t)?1:0,m=E):(m=Math.floor(Math.log(t)/Math.LN2),t*(b=Math.pow(2,-m))<1&&(m--,b*=2),(t+=m+P>=1?z/b:z*Math.pow(2,1-P))*b>=2&&(m++,b/=2),m+P>=E?(y=0,m=E):m+P>=1?(y=(t*b-1)*Math.pow(2,c),m+=P):(y=t*Math.pow(2,P-1)*Math.pow(2,c),m=0));c>=8;i[r+R]=255&y,R+=F,y/=256,c-=8);for(m=m<<c|y,T+=c;T>0;i[r+R]=255&m,R+=F,m/=256,T-=8);i[r+R-F]|=128*$};function li(i){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(i)?i:new Uint8Array(i||0),this.pos=0,this.type=0,this.length=this.buf.length}li.Varint=0,li.Fixed64=1,li.Bytes=2,li.Fixed32=5;var Mu=4294967296,Ap=1/Mu,Pp=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");function En(i){return i.type===li.Bytes?i.readVarint()+i.pos:i.pos+1}function Ma(i,t,r){return r?4294967296*t+(i>>>0):4294967296*(t>>>0)+(i>>>0)}function Cp(i,t,r){var o=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));r.realloc(o);for(var c=r.pos-1;c>=i;c--)r.buf[c+o]=r.buf[c]}function Q_(i,t){for(var r=0;r<i.length;r++)t.writeVarint(i[r])}function eg(i,t){for(var r=0;r<i.length;r++)t.writeSVarint(i[r])}function tg(i,t){for(var r=0;r<i.length;r++)t.writeFloat(i[r])}function ig(i,t){for(var r=0;r<i.length;r++)t.writeDouble(i[r])}function rg(i,t){for(var r=0;r<i.length;r++)t.writeBoolean(i[r])}function sg(i,t){for(var r=0;r<i.length;r++)t.writeFixed32(i[r])}function ng(i,t){for(var r=0;r<i.length;r++)t.writeSFixed32(i[r])}function og(i,t){for(var r=0;r<i.length;r++)t.writeFixed64(i[r])}function ag(i,t){for(var r=0;r<i.length;r++)t.writeSFixed64(i[r])}function ah(i,t){return(i[t]|i[t+1]<<8|i[t+2]<<16)+16777216*i[t+3]}function za(i,t,r){i[r]=t,i[r+1]=t>>>8,i[r+2]=t>>>16,i[r+3]=t>>>24}function Mp(i,t){return(i[t]|i[t+1]<<8|i[t+2]<<16)+(i[t+3]<<24)}li.prototype={destroy:function(){this.buf=null},readFields:function(i,t,r){for(r=r||this.length;this.pos<r;){var o=this.readVarint(),c=o>>3,f=this.pos;this.type=7&o,i(c,t,this),this.pos===f&&this.skip(o)}return t},readMessage:function(i,t){return this.readFields(i,t,this.readVarint()+this.pos)},readFixed32:function(){var i=ah(this.buf,this.pos);return this.pos+=4,i},readSFixed32:function(){var i=Mp(this.buf,this.pos);return this.pos+=4,i},readFixed64:function(){var i=ah(this.buf,this.pos)+ah(this.buf,this.pos+4)*Mu;return this.pos+=8,i},readSFixed64:function(){var i=ah(this.buf,this.pos)+Mp(this.buf,this.pos+4)*Mu;return this.pos+=8,i},readFloat:function(){var i=kp(this.buf,this.pos,!0,23,4);return this.pos+=4,i},readDouble:function(){var i=kp(this.buf,this.pos,!0,52,8);return this.pos+=8,i},readVarint:function(i){var t,r,o=this.buf;return t=127&(r=o[this.pos++]),r<128?t:(t|=(127&(r=o[this.pos++]))<<7,r<128?t:(t|=(127&(r=o[this.pos++]))<<14,r<128?t:(t|=(127&(r=o[this.pos++]))<<21,r<128?t:function(c,f,m){var y,b,T=m.buf;if(y=(112&(b=T[m.pos++]))>>4,b<128||(y|=(127&(b=T[m.pos++]))<<3,b<128)||(y|=(127&(b=T[m.pos++]))<<10,b<128)||(y|=(127&(b=T[m.pos++]))<<17,b<128)||(y|=(127&(b=T[m.pos++]))<<24,b<128)||(y|=(1&(b=T[m.pos++]))<<31,b<128))return Ma(c,y,f);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(r=o[this.pos]))<<28,i,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var i=this.readVarint();return i%2==1?(i+1)/-2:i/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var i=this.readVarint()+this.pos,t=this.pos;return this.pos=i,i-t>=12&&Pp?function(r,o,c){return Pp.decode(r.subarray(o,c))}(this.buf,t,i):function(r,o,c){for(var f="",m=o;m<c;){var y,b,T,E=r[m],P=null,z=E>239?4:E>223?3:E>191?2:1;if(m+z>c)break;z===1?E<128&&(P=E):z===2?(192&(y=r[m+1]))==128&&(P=(31&E)<<6|63&y)<=127&&(P=null):z===3?(b=r[m+2],(192&(y=r[m+1]))==128&&(192&b)==128&&((P=(15&E)<<12|(63&y)<<6|63&b)<=2047||P>=55296&&P<=57343)&&(P=null)):z===4&&(b=r[m+2],T=r[m+3],(192&(y=r[m+1]))==128&&(192&b)==128&&(192&T)==128&&((P=(15&E)<<18|(63&y)<<12|(63&b)<<6|63&T)<=65535||P>=1114112)&&(P=null)),P===null?(P=65533,z=1):P>65535&&(P-=65536,f+=String.fromCharCode(P>>>10&1023|55296),P=56320|1023&P),f+=String.fromCharCode(P),m+=z}return f}(this.buf,t,i)},readBytes:function(){var i=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,i);return this.pos=i,t},readPackedVarint:function(i,t){if(this.type!==li.Bytes)return i.push(this.readVarint(t));var r=En(this);for(i=i||[];this.pos<r;)i.push(this.readVarint(t));return i},readPackedSVarint:function(i){if(this.type!==li.Bytes)return i.push(this.readSVarint());var t=En(this);for(i=i||[];this.pos<t;)i.push(this.readSVarint());return i},readPackedBoolean:function(i){if(this.type!==li.Bytes)return i.push(this.readBoolean());var t=En(this);for(i=i||[];this.pos<t;)i.push(this.readBoolean());return i},readPackedFloat:function(i){if(this.type!==li.Bytes)return i.push(this.readFloat());var t=En(this);for(i=i||[];this.pos<t;)i.push(this.readFloat());return i},readPackedDouble:function(i){if(this.type!==li.Bytes)return i.push(this.readDouble());var t=En(this);for(i=i||[];this.pos<t;)i.push(this.readDouble());return i},readPackedFixed32:function(i){if(this.type!==li.Bytes)return i.push(this.readFixed32());var t=En(this);for(i=i||[];this.pos<t;)i.push(this.readFixed32());return i},readPackedSFixed32:function(i){if(this.type!==li.Bytes)return i.push(this.readSFixed32());var t=En(this);for(i=i||[];this.pos<t;)i.push(this.readSFixed32());return i},readPackedFixed64:function(i){if(this.type!==li.Bytes)return i.push(this.readFixed64());var t=En(this);for(i=i||[];this.pos<t;)i.push(this.readFixed64());return i},readPackedSFixed64:function(i){if(this.type!==li.Bytes)return i.push(this.readSFixed64());var t=En(this);for(i=i||[];this.pos<t;)i.push(this.readSFixed64());return i},skip:function(i){var t=7&i;if(t===li.Varint)for(;this.buf[this.pos++]>127;);else if(t===li.Bytes)this.pos=this.readVarint()+this.pos;else if(t===li.Fixed32)this.pos+=4;else{if(t!==li.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(i,t){this.writeVarint(i<<3|t)},realloc:function(i){for(var t=this.length||16;t<this.pos+i;)t*=2;if(t!==this.length){var r=new Uint8Array(t);r.set(this.buf),this.buf=r,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(i){this.realloc(4),za(this.buf,i,this.pos),this.pos+=4},writeSFixed32:function(i){this.realloc(4),za(this.buf,i,this.pos),this.pos+=4},writeFixed64:function(i){this.realloc(8),za(this.buf,-1&i,this.pos),za(this.buf,Math.floor(i*Ap),this.pos+4),this.pos+=8},writeSFixed64:function(i){this.realloc(8),za(this.buf,-1&i,this.pos),za(this.buf,Math.floor(i*Ap),this.pos+4),this.pos+=8},writeVarint:function(i){(i=+i||0)>268435455||i<0?function(t,r){var o,c;if(t>=0?(o=t%4294967296|0,c=t/4294967296|0):(c=~(-t/4294967296),4294967295^(o=~(-t%4294967296))?o=o+1|0:(o=0,c=c+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");r.realloc(10),function(f,m,y){y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,f>>>=7,y.buf[y.pos++]=127&f|128,y.buf[y.pos]=127&(f>>>=7)}(o,0,r),function(f,m){var y=(7&f)<<4;m.buf[m.pos++]|=y|((f>>>=3)?128:0),f&&(m.buf[m.pos++]=127&f|((f>>>=7)?128:0),f&&(m.buf[m.pos++]=127&f|((f>>>=7)?128:0),f&&(m.buf[m.pos++]=127&f|((f>>>=7)?128:0),f&&(m.buf[m.pos++]=127&f|((f>>>=7)?128:0),f&&(m.buf[m.pos++]=127&f)))))}(c,r)}(i,this):(this.realloc(4),this.buf[this.pos++]=127&i|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=127&(i>>>=7)|(i>127?128:0),i<=127||(this.buf[this.pos++]=i>>>7&127))))},writeSVarint:function(i){this.writeVarint(i<0?2*-i-1:2*i)},writeBoolean:function(i){this.writeVarint(!!i)},writeString:function(i){i=String(i),this.realloc(4*i.length),this.pos++;var t=this.pos;this.pos=function(o,c,f){for(var m,y,b=0;b<c.length;b++){if((m=c.charCodeAt(b))>55295&&m<57344){if(!y){m>56319||b+1===c.length?(o[f++]=239,o[f++]=191,o[f++]=189):y=m;continue}if(m<56320){o[f++]=239,o[f++]=191,o[f++]=189,y=m;continue}m=y-55296<<10|m-56320|65536,y=null}else y&&(o[f++]=239,o[f++]=191,o[f++]=189,y=null);m<128?o[f++]=m:(m<2048?o[f++]=m>>6|192:(m<65536?o[f++]=m>>12|224:(o[f++]=m>>18|240,o[f++]=m>>12&63|128),o[f++]=m>>6&63|128),o[f++]=63&m|128)}return f}(this.buf,i,this.pos);var r=this.pos-t;r>=128&&Cp(t,r,this),this.pos=t-1,this.writeVarint(r),this.pos+=r},writeFloat:function(i){this.realloc(4),Ep(this.buf,i,this.pos,!0,23,4),this.pos+=4},writeDouble:function(i){this.realloc(8),Ep(this.buf,i,this.pos,!0,52,8),this.pos+=8},writeBytes:function(i){var t=i.length;this.writeVarint(t),this.realloc(t);for(var r=0;r<t;r++)this.buf[this.pos++]=i[r]},writeRawMessage:function(i,t){this.pos++;var r=this.pos;i(t,this);var o=this.pos-r;o>=128&&Cp(r,o,this),this.pos=r-1,this.writeVarint(o),this.pos+=o},writeMessage:function(i,t,r){this.writeTag(i,li.Bytes),this.writeRawMessage(t,r)},writePackedVarint:function(i,t){t.length&&this.writeMessage(i,Q_,t)},writePackedSVarint:function(i,t){t.length&&this.writeMessage(i,eg,t)},writePackedBoolean:function(i,t){t.length&&this.writeMessage(i,rg,t)},writePackedFloat:function(i,t){t.length&&this.writeMessage(i,tg,t)},writePackedDouble:function(i,t){t.length&&this.writeMessage(i,ig,t)},writePackedFixed32:function(i,t){t.length&&this.writeMessage(i,sg,t)},writePackedSFixed32:function(i,t){t.length&&this.writeMessage(i,ng,t)},writePackedFixed64:function(i,t){t.length&&this.writeMessage(i,og,t)},writePackedSFixed64:function(i,t){t.length&&this.writeMessage(i,ag,t)},writeBytesField:function(i,t){this.writeTag(i,li.Bytes),this.writeBytes(t)},writeFixed32Field:function(i,t){this.writeTag(i,li.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(i,t){this.writeTag(i,li.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(i,t){this.writeTag(i,li.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(i,t){this.writeTag(i,li.Fixed64),this.writeSFixed64(t)},writeVarintField:function(i,t){this.writeTag(i,li.Varint),this.writeVarint(t)},writeSVarintField:function(i,t){this.writeTag(i,li.Varint),this.writeSVarint(t)},writeStringField:function(i,t){this.writeTag(i,li.Bytes),this.writeString(t)},writeFloatField:function(i,t){this.writeTag(i,li.Fixed32),this.writeFloat(t)},writeDoubleField:function(i,t){this.writeTag(i,li.Fixed64),this.writeDouble(t)},writeBooleanField:function(i,t){this.writeVarintField(i,!!t)}};var zu=N(Tp);const Du=3;function lg(i,t,r){i===1&&r.readMessage(cg,t)}function cg(i,t,r){if(i===3){const{id:o,bitmap:c,width:f,height:m,left:y,top:b,advance:T}=r.readMessage(hg,{});t.push({id:o,bitmap:new Rl({width:f+2*Du,height:m+2*Du},c),metrics:{width:f,height:m,left:y,top:b,advance:T}})}}function hg(i,t,r){i===1?t.id=r.readVarint():i===2?t.bitmap=r.readBytes():i===3?t.width=r.readVarint():i===4?t.height=r.readVarint():i===5?t.left=r.readSVarint():i===6?t.top=r.readSVarint():i===7&&(t.advance=r.readVarint())}const zp=Du;function Dp(i){let t=0,r=0;for(const m of i)t+=m.w*m.h,r=Math.max(r,m.w);i.sort((m,y)=>y.h-m.h);const o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),r),h:1/0}];let c=0,f=0;for(const m of i)for(let y=o.length-1;y>=0;y--){const b=o[y];if(!(m.w>b.w||m.h>b.h)){if(m.x=b.x,m.y=b.y,f=Math.max(f,m.y+m.h),c=Math.max(c,m.x+m.w),m.w===b.w&&m.h===b.h){const T=o.pop();y<o.length&&(o[y]=T)}else m.h===b.h?(b.x+=m.w,b.w-=m.w):m.w===b.w?(b.y+=m.h,b.h-=m.h):(o.push({x:b.x+m.w,y:b.y,w:b.w-m.w,h:m.h}),b.y+=m.h,b.h-=m.h);break}}return{w:c,h:f,fill:t/(c*f)||0}}const $r=1;class Lu{constructor(t,{pixelRatio:r,version:o,stretchX:c,stretchY:f,content:m,textFitWidth:y,textFitHeight:b}){this.paddedRect=t,this.pixelRatio=r,this.stretchX=c,this.stretchY=f,this.content=m,this.version=o,this.textFitWidth=y,this.textFitHeight=b}get tl(){return[this.paddedRect.x+$r,this.paddedRect.y+$r]}get br(){return[this.paddedRect.x+this.paddedRect.w-$r,this.paddedRect.y+this.paddedRect.h-$r]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2*$r)/this.pixelRatio,(this.paddedRect.h-2*$r)/this.pixelRatio]}}class Lp{constructor(t,r){const o={},c={};this.haveRenderCallbacks=[];const f=[];this.addImages(t,o,f),this.addImages(r,c,f);const{w:m,h:y}=Dp(f),b=new us({width:m||1,height:y||1});for(const T in t){const E=t[T],P=o[T].paddedRect;us.copy(E.data,b,{x:0,y:0},{x:P.x+$r,y:P.y+$r},E.data)}for(const T in r){const E=r[T],P=c[T].paddedRect,z=P.x+$r,R=P.y+$r,F=E.data.width,$=E.data.height;us.copy(E.data,b,{x:0,y:0},{x:z,y:R},E.data),us.copy(E.data,b,{x:0,y:$-1},{x:z,y:R-1},{width:F,height:1}),us.copy(E.data,b,{x:0,y:0},{x:z,y:R+$},{width:F,height:1}),us.copy(E.data,b,{x:F-1,y:0},{x:z-1,y:R},{width:1,height:$}),us.copy(E.data,b,{x:0,y:0},{x:z+F,y:R},{width:1,height:$})}this.image=b,this.iconPositions=o,this.patternPositions=c}addImages(t,r,o){for(const c in t){const f=t[c],m={x:0,y:0,w:f.data.width+2*$r,h:f.data.height+2*$r};o.push(m),r[c]=new Lu(m,f),f.hasRenderCallback&&this.haveRenderCallbacks.push(c)}}patchUpdatedImages(t,r){t.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const o in t.updatedImages)this.patchUpdatedImage(this.iconPositions[o],t.getImage(o),r),this.patchUpdatedImage(this.patternPositions[o],t.getImage(o),r)}patchUpdatedImage(t,r,o){if(!t||!r||t.version===r.version)return;t.version=r.version;const[c,f]=t.tl;o.update(r.data,void 0,{x:c,y:f})}}var Kn;Xe("ImagePosition",Lu),Xe("ImageAtlas",Lp),S.ah=void 0,(Kn=S.ah||(S.ah={}))[Kn.none=0]="none",Kn[Kn.horizontal=1]="horizontal",Kn[Kn.vertical=2]="vertical",Kn[Kn.horizontalOnly=3]="horizontalOnly";const Ul=-17;class Vl{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(t,r){const o=new Vl;return o.scale=t||1,o.fontStack=r,o}static forImage(t){const r=new Vl;return r.imageName=t,r}}class Da{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,r){const o=new Da;for(let c=0;c<t.sections.length;c++){const f=t.sections[c];f.image?o.addImageSection(f):o.addTextSection(f,r)}return o}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSectionIndex(t){return this.sectionIndex[t]}getCharCode(t){return this.text.charCodeAt(t)}verticalizePunctuation(){this.text=function(t){let r="";for(let o=0;o<t.length;o++){const c=t.charCodeAt(o+1)||null,f=t.charCodeAt(o-1)||null;r+=c&&Hc(c)&&!$l[t[o+1]]||f&&Hc(f)&&!$l[t[o-1]]||!$l[t[o]]?t[o]:$l[t[o]]}return r}(this.text)}trim(){let t=0;for(let o=0;o<this.text.length&&ch[this.text.charCodeAt(o)];o++)t++;let r=this.text.length;for(let o=this.text.length-1;o>=0&&o>=t&&ch[this.text.charCodeAt(o)];o--)r--;this.text=this.text.substring(t,r),this.sectionIndex=this.sectionIndex.slice(t,r)}substring(t,r){const o=new Da;return o.text=this.text.substring(t,r),o.sectionIndex=this.sectionIndex.slice(t,r),o.sections=this.sections,o}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,r)=>Math.max(t,this.sections[r].scale),0)}addTextSection(t,r){this.text+=t.text,this.sections.push(Vl.forText(t.scale,t.fontStack||r));const o=this.sections.length-1;for(let c=0;c<t.text.length;++c)this.sectionIndex.push(o)}addImageSection(t){const r=t.image?t.image.name:"";if(r.length===0)return void pi("Can't add FormattedSection with an empty image.");const o=this.getNextImageSectionCharCode();o?(this.text+=String.fromCharCode(o),this.sections.push(Vl.forImage(r)),this.sectionIndex.push(this.sections.length-1)):pi("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function lh(i,t,r,o,c,f,m,y,b,T,E,P,z,R,F){const $=Da.fromFeature(i,c);let Q;P===S.ah.vertical&&$.verticalizePunctuation();const{processBidirectionalText:ie,processStyledBidirectionalText:_e}=Sn;if(ie&&$.sections.length===1){Q=[];const Se=ie($.toString(),Ru($,T,f,t,o,R));for(const ze of Se){const We=new Da;We.text=ze,We.sections=$.sections;for(let ft=0;ft<ze.length;ft++)We.sectionIndex.push(0);Q.push(We)}}else if(_e){Q=[];const Se=_e($.text,$.sectionIndex,Ru($,T,f,t,o,R));for(const ze of Se){const We=new Da;We.text=ze[0],We.sectionIndex=ze[1],We.sections=$.sections,Q.push(We)}}else Q=function(Se,ze){const We=[],ft=Se.text;let Ge=0;for(const Ve of ze)We.push(Se.substring(Ge,Ve)),Ge=Ve;return Ge<ft.length&&We.push(Se.substring(Ge,ft.length)),We}($,Ru($,T,f,t,o,R));const ce=[],me={positionedLines:ce,text:$.toString(),top:E[1],bottom:E[1],left:E[0],right:E[0],writingMode:P,iconsInText:!1,verticalizable:!1};return function(Se,ze,We,ft,Ge,Ve,at,it,Ye,ke,ct,nt){let wt=0,di=Ul,ci=0,Wi=0;const As=it==="right"?1:it==="left"?0:.5;let or=0;for(const Mi of Ge){Mi.trim();const Ji=Mi.getMaxScale(),yr=(Ji-1)*qi,ar={positionedGlyphs:[],lineOffset:0};Se.positionedLines[or]=ar;const zr=ar.positionedGlyphs;let lr=0;if(!Mi.length()){di+=Ve,++or;continue}for(let Ur=0;Ur<Mi.length();Ur++){const Zt=Mi.getSection(Ur),mi=Mi.getSectionIndex(Ur),bi=Mi.getCharCode(Ur);let Kr=0,Ai=null,Fa=null,Qs=null,en=qi;const Ps=!(Ye===S.ah.horizontal||!ct&&!El(bi)||ct&&(ch[bi]||(Xi=bi,new RegExp("\\p{sc=Arab}","u").test(String.fromCodePoint(Xi)))));if(Zt.imageName){const fs=ft[Zt.imageName];if(!fs)continue;Qs=Zt.imageName,Se.iconsInText=Se.iconsInText||!0,Fa=fs.paddedRect;const er=fs.displaySize;Zt.scale=Zt.scale*qi/nt,Ai={width:er[0],height:er[1],left:$r,top:-zp,advance:Ps?er[1]:er[0]},Kr=yr+(qi-er[1]*Zt.scale),en=Ai.advance;const An=Ps?er[0]*Zt.scale-qi*Ji:er[1]*Zt.scale-qi*Ji;An>0&&An>lr&&(lr=An)}else{const fs=We[Zt.fontStack],er=fs&&fs[bi];if(er&&er.rect)Fa=er.rect,Ai=er.metrics;else{const An=ze[Zt.fontStack],Xl=An&&An[bi];if(!Xl)continue;Ai=Xl.metrics}Kr=(Ji-Zt.scale)*qi}Ps?(Se.verticalizable=!0,zr.push({glyph:bi,imageName:Qs,x:wt,y:di+Kr,vertical:Ps,scale:Zt.scale,fontStack:Zt.fontStack,sectionIndex:mi,metrics:Ai,rect:Fa}),wt+=en*Zt.scale+ke):(zr.push({glyph:bi,imageName:Qs,x:wt,y:di+Kr,vertical:Ps,scale:Zt.scale,fontStack:Zt.fontStack,sectionIndex:mi,metrics:Ai,rect:Fa}),wt+=Ai.advance*Zt.scale+ke)}zr.length!==0&&(ci=Math.max(wt-ke,ci),fg(zr,0,zr.length-1,As,lr)),wt=0;const ps=Ve*Ji+lr;ar.lineOffset=Math.max(lr,yr),di+=ps,Wi=Math.max(ps,Wi),++or}var Xi;const Pr=di-Ul,{horizontalAlign:Cr,verticalAlign:Mr}=Ou(at);(function(Mi,Ji,yr,ar,zr,lr,ps,Ur,Zt){const mi=(Ji-yr)*zr;let bi=0;bi=lr!==ps?-Ur*ar-Ul:(-ar*Zt+.5)*ps;for(const Kr of Mi)for(const Ai of Kr.positionedGlyphs)Ai.x+=mi,Ai.y+=bi})(Se.positionedLines,As,Cr,Mr,ci,Wi,Ve,Pr,Ge.length),Se.top+=-Mr*Pr,Se.bottom=Se.top+Pr,Se.left+=-Cr*ci,Se.right=Se.left+ci}(me,t,r,o,Q,m,y,b,P,T,z,F),!function(Se){for(const ze of Se)if(ze.positionedGlyphs.length!==0)return!1;return!0}(ce)&&me}const ch={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},ug={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},dg={40:!0};function Rp(i,t,r,o,c,f){if(t.imageName){const m=o[t.imageName];return m?m.displaySize[0]*t.scale*qi/f+c:0}{const m=r[t.fontStack],y=m&&m[i];return y?y.metrics.advance*t.scale+c:0}}function Op(i,t,r,o){const c=Math.pow(i-t,2);return o?i<t?c/2:2*c:c+Math.abs(r)*r}function pg(i,t,r){let o=0;return i===10&&(o-=1e4),r&&(o+=150),i!==40&&i!==65288||(o+=50),t!==41&&t!==65289||(o+=50),o}function Fp(i,t,r,o,c,f){let m=null,y=Op(t,r,c,f);for(const b of o){const T=Op(t-b.x,r,c,f)+b.badness;T<=y&&(m=b,y=T)}return{index:i,x:t,priorBreak:m,badness:y}}function Bp(i){return i?Bp(i.priorBreak).concat(i.index):[]}function Ru(i,t,r,o,c,f){if(!i)return[];const m=[],y=function(P,z,R,F,$,Q){let ie=0;for(let _e=0;_e<P.length();_e++){const ce=P.getSection(_e);ie+=Rp(P.getCharCode(_e),ce,F,$,z,Q)}return ie/Math.max(1,Math.ceil(ie/R))}(i,t,r,o,c,f),b=i.text.indexOf("​")>=0;let T=0;for(let P=0;P<i.length();P++){const z=i.getSection(P),R=i.getCharCode(P);if(ch[R]||(T+=Rp(R,z,o,c,t,f)),P<i.length()-1){const F=!((E=R)<11904)&&(!!Nt["CJK Compatibility Forms"](E)||!!Nt["CJK Compatibility"](E)||!!Nt["CJK Strokes"](E)||!!Nt["CJK Symbols and Punctuation"](E)||!!Nt["Enclosed CJK Letters and Months"](E)||!!Nt["Halfwidth and Fullwidth Forms"](E)||!!Nt["Ideographic Description Characters"](E)||!!Nt["Vertical Forms"](E)||wn.test(String.fromCodePoint(E)));(ug[R]||F||z.imageName||P!==i.length()-2&&dg[i.getCharCode(P+1)])&&m.push(Fp(P+1,T,y,m,pg(R,i.getCharCode(P+1),F&&b),!1))}}var E;return Bp(Fp(i.length(),T,y,m,0,!0))}function Ou(i){let t=.5,r=.5;switch(i){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(i){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:t,verticalAlign:r}}function fg(i,t,r,o,c){if(!o&&!c)return;const f=i[r],m=(i[r].x+f.metrics.advance*f.scale)*o;for(let y=t;y<=r;y++)i[y].x-=m,i[y].y+=c}function mg(i,t,r){const{horizontalAlign:o,verticalAlign:c}=Ou(r),f=t[0]-i.displaySize[0]*o,m=t[1]-i.displaySize[1]*c;return{image:i,top:m,bottom:m+i.displaySize[1],left:f,right:f+i.displaySize[0]}}function jp(i){var t,r;let o=i.left,c=i.top,f=i.right-o,m=i.bottom-c;const y=(t=i.image.textFitWidth)!==null&&t!==void 0?t:"stretchOrShrink",b=(r=i.image.textFitHeight)!==null&&r!==void 0?r:"stretchOrShrink",T=(i.image.content[2]-i.image.content[0])/(i.image.content[3]-i.image.content[1]);if(b==="proportional"){if(y==="stretchOnly"&&f/m<T||y==="proportional"){const E=Math.ceil(m*T);o*=E/f,f=E}}else if(y==="proportional"&&b==="stretchOnly"&&T!==0&&f/m>T){const E=Math.ceil(f/T);c*=E/m,m=E}return{x1:o,y1:c,x2:o+f,y2:c+m}}function Np(i,t,r,o,c,f){const m=i.image;let y;if(m.content){const Q=m.content,ie=m.pixelRatio||1;y=[Q[0]/ie,Q[1]/ie,m.displaySize[0]-Q[2]/ie,m.displaySize[1]-Q[3]/ie]}const b=t.left*f,T=t.right*f;let E,P,z,R;r==="width"||r==="both"?(R=c[0]+b-o[3],P=c[0]+T+o[1]):(R=c[0]+(b+T-m.displaySize[0])/2,P=R+m.displaySize[0]);const F=t.top*f,$=t.bottom*f;return r==="height"||r==="both"?(E=c[1]+F-o[0],z=c[1]+$+o[2]):(E=c[1]+(F+$-m.displaySize[1])/2,z=E+m.displaySize[1]),{image:m,top:E,right:P,bottom:z,left:R,collisionPadding:y}}const ql=255,Ys=128,Yn=ql*Ys;function $p(i,t){const{expression:r}=t;if(r.kind==="constant")return{kind:"constant",layoutSize:r.evaluate(new ti(i+1))};if(r.kind==="source")return{kind:"source"};{const{zoomStops:o,interpolationType:c}=r;let f=0;for(;f<o.length&&o[f]<=i;)f++;f=Math.max(0,f-1);let m=f;for(;m<o.length&&o[m]<i+1;)m++;m=Math.min(o.length-1,m);const y=o[f],b=o[m];return r.kind==="composite"?{kind:"composite",minZoom:y,maxZoom:b,interpolationType:c}:{kind:"camera",minZoom:y,maxZoom:b,minSize:r.evaluate(new ti(y)),maxSize:r.evaluate(new ti(b)),interpolationType:c}}}function Fu(i,t,r){let o="never";const c=i.get(t);return c?o=c:i.get(r)&&(o="always"),o}const _g=Jn.VectorTileFeature.types,gg=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function hh(i,t,r,o,c,f,m,y,b,T,E,P,z){const R=y?Math.min(Yn,Math.round(y[0])):0,F=y?Math.min(Yn,Math.round(y[1])):0;i.emplaceBack(t,r,Math.round(32*o),Math.round(32*c),f,m,(R<<1)+(b?1:0),F,16*T,16*E,256*P,256*z)}function Bu(i,t,r){i.emplaceBack(t.x,t.y,r),i.emplaceBack(t.x,t.y,r),i.emplaceBack(t.x,t.y,r),i.emplaceBack(t.x,t.y,r)}function yg(i){for(const t of i.sections)if(du(t.text))return!0;return!1}class ju{constructor(t){this.layoutVertexArray=new In,this.indexArray=new Nr,this.programConfigurations=t,this.segments=new ai,this.dynamicLayoutVertexArray=new Sa,this.opacityVertexArray=new Cl,this.hasVisibleVertices=!1,this.placedSymbolArray=new bt}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(t,r,o,c){this.isEmpty()||(o&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,W_.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,X_.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,gg,!0),this.opacityVertexBuffer.itemSize=1),(o||c)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Xe("SymbolBuffers",ju);class Nu{constructor(t,r,o){this.layoutVertexArray=new t,this.layoutAttributes=r,this.indexArray=new o,this.segments=new ai,this.collisionVertexArray=new hs}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,J_.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}Xe("CollisionBuffers",Nu);class La{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(m=>m.id),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=xu([]),this.placementViewportMatrix=xu([]);const r=this.layers[0]._unevaluatedLayout._values;this.textSizeData=$p(this.zoom,r["text-size"]),this.iconSizeData=$p(this.zoom,r["icon-size"]);const o=this.layers[0].layout,c=o.get("symbol-sort-key"),f=o.get("symbol-z-order");this.canOverlap=Fu(o,"text-overlap","text-allow-overlap")!=="never"||Fu(o,"icon-overlap","icon-allow-overlap")!=="never"||o.get("text-ignore-placement")||o.get("icon-ignore-placement"),this.sortFeaturesByKey=f!=="viewport-y"&&!c.isConstant(),this.sortFeaturesByY=(f==="viewport-y"||f==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,o.get("symbol-placement")==="point"&&(this.writingModes=o.get("text-writing-mode").map(m=>S.ah[m])),this.stateDependentLayerIds=this.layers.filter(m=>m.isStateDependent()).map(m=>m.id),this.sourceID=t.sourceID}createArrays(){this.text=new ju(new Ro(this.layers,this.zoom,t=>/^text/.test(t))),this.icon=new ju(new Ro(this.layers,this.zoom,t=>/^icon/.test(t))),this.glyphOffsetArray=new $t,this.lineVertexArray=new xi,this.symbolInstances=new Pt,this.textAnchorOffsets=new ls}calculateGlyphDependencies(t,r,o,c,f){for(let m=0;m<t.length;m++)if(r[t.charCodeAt(m)]=!0,(o||c)&&f){const y=$l[t.charAt(m)];y&&(r[y.charCodeAt(0)]=!0)}}populate(t,r,o){const c=this.layers[0],f=c.layout,m=f.get("text-font"),y=f.get("text-field"),b=f.get("icon-image"),T=(y.value.kind!=="constant"||y.value.value instanceof Ae&&!y.value.value.isEmpty()||y.value.value.toString().length>0)&&(m.value.kind!=="constant"||m.value.value.length>0),E=b.value.kind!=="constant"||!!b.value.value||Object.keys(b.parameters).length>0,P=f.get("symbol-sort-key");if(this.features=[],!T&&!E)return;const z=r.iconDependencies,R=r.glyphDependencies,F=r.availableImages,$=new ti(this.zoom);for(const{feature:Q,id:ie,index:_e,sourceLayerIndex:ce}of t){const me=c._featureFilter.needGeometry,Se=Fo(Q,me);if(!c._featureFilter.filter($,Se,o))continue;let ze,We;if(me||(Se.geometry=Oo(Q)),T){const Ge=c.getValueAndResolveTokens("text-field",Se,o,F),Ve=Ae.factory(Ge),at=this.hasRTLText=this.hasRTLText||yg(Ve);(!at||Sn.getRTLTextPluginStatus()==="unavailable"||at&&Sn.isParsed())&&(ze=Y_(Ve,c,Se))}if(E){const Ge=c.getValueAndResolveTokens("icon-image",Se,o,F);We=Ge instanceof Ke?Ge:Ke.fromString(Ge)}if(!ze&&!We)continue;const ft=this.sortFeaturesByKey?P.evaluate(Se,{},o):void 0;if(this.features.push({id:ie,text:ze,icon:We,index:_e,sourceLayerIndex:ce,geometry:Se.geometry,properties:Q.properties,type:_g[Q.type],sortKey:ft}),We&&(z[We.name]=!0),ze){const Ge=m.evaluate(Se,{},o).join(","),Ve=f.get("text-rotation-alignment")!=="viewport"&&f.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(S.ah.vertical)>=0;for(const at of ze.sections)if(at.image)z[at.image.name]=!0;else{const it=Tl(ze.toString()),Ye=at.fontStack||Ge,ke=R[Ye]=R[Ye]||{};this.calculateGlyphDependencies(at.text,ke,Ve,this.allowVerticalPlacement,it)}}}f.get("symbol-placement")==="line"&&(this.features=function(Q){const ie={},_e={},ce=[];let me=0;function Se(Ge){ce.push(Q[Ge]),me++}function ze(Ge,Ve,at){const it=_e[Ge];return delete _e[Ge],_e[Ve]=it,ce[it].geometry[0].pop(),ce[it].geometry[0]=ce[it].geometry[0].concat(at[0]),it}function We(Ge,Ve,at){const it=ie[Ve];return delete ie[Ve],ie[Ge]=it,ce[it].geometry[0].shift(),ce[it].geometry[0]=at[0].concat(ce[it].geometry[0]),it}function ft(Ge,Ve,at){const it=at?Ve[0][Ve[0].length-1]:Ve[0][0];return`${Ge}:${it.x}:${it.y}`}for(let Ge=0;Ge<Q.length;Ge++){const Ve=Q[Ge],at=Ve.geometry,it=Ve.text?Ve.text.toString():null;if(!it){Se(Ge);continue}const Ye=ft(it,at),ke=ft(it,at,!0);if(Ye in _e&&ke in ie&&_e[Ye]!==ie[ke]){const ct=We(Ye,ke,at),nt=ze(Ye,ke,ce[ct].geometry);delete ie[Ye],delete _e[ke],_e[ft(it,ce[nt].geometry,!0)]=nt,ce[ct].geometry=null}else Ye in _e?ze(Ye,ke,at):ke in ie?We(Ye,ke,at):(Se(Ge),ie[Ye]=me-1,_e[ke]=me-1)}return ce.filter(Ge=>Ge.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((Q,ie)=>Q.sortKey-ie.sortKey)}update(t,r,o){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(t,r,this.layers,o),this.icon.programConfigurations.updatePaintArrays(t,r,this.layers,o))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,r){const o=this.lineVertexArray.length;if(t.segment!==void 0){let c=t.dist(r[t.segment+1]),f=t.dist(r[t.segment]);const m={};for(let y=t.segment+1;y<r.length;y++)m[y]={x:r[y].x,y:r[y].y,tileUnitDistanceFromAnchor:c},y<r.length-1&&(c+=r[y+1].dist(r[y]));for(let y=t.segment||0;y>=0;y--)m[y]={x:r[y].x,y:r[y].y,tileUnitDistanceFromAnchor:f},y>0&&(f+=r[y-1].dist(r[y]));for(let y=0;y<r.length;y++){const b=m[y];this.lineVertexArray.emplaceBack(b.x,b.y,b.tileUnitDistanceFromAnchor)}}return{lineStartIndex:o,lineLength:this.lineVertexArray.length-o}}addSymbols(t,r,o,c,f,m,y,b,T,E,P,z){const R=t.indexArray,F=t.layoutVertexArray,$=t.segments.prepareSegment(4*r.length,F,R,this.canOverlap?m.sortKey:void 0),Q=this.glyphOffsetArray.length,ie=$.vertexLength,_e=this.allowVerticalPlacement&&y===S.ah.vertical?Math.PI/2:0,ce=m.text&&m.text.sections;for(let me=0;me<r.length;me++){const{tl:Se,tr:ze,bl:We,br:ft,tex:Ge,pixelOffsetTL:Ve,pixelOffsetBR:at,minFontScaleX:it,minFontScaleY:Ye,glyphOffset:ke,isSDF:ct,sectionIndex:nt}=r[me],wt=$.vertexLength,di=ke[1];hh(F,b.x,b.y,Se.x,di+Se.y,Ge.x,Ge.y,o,ct,Ve.x,Ve.y,it,Ye),hh(F,b.x,b.y,ze.x,di+ze.y,Ge.x+Ge.w,Ge.y,o,ct,at.x,Ve.y,it,Ye),hh(F,b.x,b.y,We.x,di+We.y,Ge.x,Ge.y+Ge.h,o,ct,Ve.x,at.y,it,Ye),hh(F,b.x,b.y,ft.x,di+ft.y,Ge.x+Ge.w,Ge.y+Ge.h,o,ct,at.x,at.y,it,Ye),Bu(t.dynamicLayoutVertexArray,b,_e),R.emplaceBack(wt,wt+1,wt+2),R.emplaceBack(wt+1,wt+2,wt+3),$.vertexLength+=4,$.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(ke[0]),me!==r.length-1&&nt===r[me+1].sectionIndex||t.programConfigurations.populatePaintArrays(F.length,m,m.index,{},z,ce&&ce[nt])}t.placedSymbolArray.emplaceBack(b.x,b.y,Q,this.glyphOffsetArray.length-Q,ie,T,E,b.segment,o?o[0]:0,o?o[1]:0,c[0],c[1],y,0,!1,0,P)}_addCollisionDebugVertex(t,r,o,c,f,m){return r.emplaceBack(0,0),t.emplaceBack(o.x,o.y,c,f,Math.round(m.x),Math.round(m.y))}addCollisionDebugVertices(t,r,o,c,f,m,y){const b=f.segments.prepareSegment(4,f.layoutVertexArray,f.indexArray),T=b.vertexLength,E=f.layoutVertexArray,P=f.collisionVertexArray,z=y.anchorX,R=y.anchorY;this._addCollisionDebugVertex(E,P,m,z,R,new J(t,r)),this._addCollisionDebugVertex(E,P,m,z,R,new J(o,r)),this._addCollisionDebugVertex(E,P,m,z,R,new J(o,c)),this._addCollisionDebugVertex(E,P,m,z,R,new J(t,c)),b.vertexLength+=4;const F=f.indexArray;F.emplaceBack(T,T+1),F.emplaceBack(T+1,T+2),F.emplaceBack(T+2,T+3),F.emplaceBack(T+3,T),b.primitiveLength+=4}addDebugCollisionBoxes(t,r,o,c){for(let f=t;f<r;f++){const m=this.collisionBoxArray.get(f);this.addCollisionDebugVertices(m.x1,m.y1,m.x2,m.y2,c?this.textCollisionBox:this.iconCollisionBox,m.anchorPoint,o)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Nu(jr,Ip.members,Ks),this.iconCollisionBox=new Nu(jr,Ip.members,Ks);for(let t=0;t<this.symbolInstances.length;t++){const r=this.symbolInstances.get(t);this.addDebugCollisionBoxes(r.textBoxStartIndex,r.textBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.verticalTextBoxStartIndex,r.verticalTextBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.iconBoxStartIndex,r.iconBoxEndIndex,r,!1),this.addDebugCollisionBoxes(r.verticalIconBoxStartIndex,r.verticalIconBoxEndIndex,r,!1)}}_deserializeCollisionBoxesForSymbol(t,r,o,c,f,m,y,b,T){const E={};for(let P=r;P<o;P++){const z=t.get(P);E.textBox={x1:z.x1,y1:z.y1,x2:z.x2,y2:z.y2,anchorPointX:z.anchorPointX,anchorPointY:z.anchorPointY},E.textFeatureIndex=z.featureIndex;break}for(let P=c;P<f;P++){const z=t.get(P);E.verticalTextBox={x1:z.x1,y1:z.y1,x2:z.x2,y2:z.y2,anchorPointX:z.anchorPointX,anchorPointY:z.anchorPointY},E.verticalTextFeatureIndex=z.featureIndex;break}for(let P=m;P<y;P++){const z=t.get(P);E.iconBox={x1:z.x1,y1:z.y1,x2:z.x2,y2:z.y2,anchorPointX:z.anchorPointX,anchorPointY:z.anchorPointY},E.iconFeatureIndex=z.featureIndex;break}for(let P=b;P<T;P++){const z=t.get(P);E.verticalIconBox={x1:z.x1,y1:z.y1,x2:z.x2,y2:z.y2,anchorPointX:z.anchorPointX,anchorPointY:z.anchorPointY},E.verticalIconFeatureIndex=z.featureIndex;break}return E}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const o=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,o.textBoxStartIndex,o.textBoxEndIndex,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o.iconBoxStartIndex,o.iconBoxEndIndex,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(t,r){const o=t.placedSymbolArray.get(r),c=o.vertexStartIndex+4*o.numGlyphs;for(let f=o.vertexStartIndex;f<c;f+=4)t.indexArray.emplaceBack(f,f+1,f+2),t.indexArray.emplaceBack(f+1,f+2,f+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(t),o=Math.cos(t),c=[],f=[],m=[];for(let y=0;y<this.symbolInstances.length;++y){m.push(y);const b=this.symbolInstances.get(y);c.push(0|Math.round(r*b.anchorX+o*b.anchorY)),f.push(b.featureIndex)}return m.sort((y,b)=>c[y]-c[b]||f[b]-f[y]),m}addToSortKeyRanges(t,r){const o=this.sortKeyRanges[this.sortKeyRanges.length-1];o&&o.sortKey===r?o.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const o=this.symbolInstances.get(r);this.featureSortOrder.push(o.featureIndex),[o.rightJustifiedTextSymbolIndex,o.centerJustifiedTextSymbolIndex,o.leftJustifiedTextSymbolIndex].forEach((c,f,m)=>{c>=0&&m.indexOf(c)===f&&this.addIndicesForPlacedSymbol(this.text,c)}),o.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,o.verticalPlacedTextSymbolIndex),o.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,o.placedIconSymbolIndex),o.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,o.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Up,Vp;Xe("SymbolBucket",La,{omit:["layers","collisionBoxArray","features","compareText"]}),La.MAX_GLYPHS=65535,La.addDynamicAttributes=Bu;var $u={get paint(){return Vp=Vp||new kr({"icon-opacity":new dt(be.paint_symbol["icon-opacity"]),"icon-color":new dt(be.paint_symbol["icon-color"]),"icon-halo-color":new dt(be.paint_symbol["icon-halo-color"]),"icon-halo-width":new dt(be.paint_symbol["icon-halo-width"]),"icon-halo-blur":new dt(be.paint_symbol["icon-halo-blur"]),"icon-translate":new lt(be.paint_symbol["icon-translate"]),"icon-translate-anchor":new lt(be.paint_symbol["icon-translate-anchor"]),"text-opacity":new dt(be.paint_symbol["text-opacity"]),"text-color":new dt(be.paint_symbol["text-color"],{runtimeType:Qi,getOverride:i=>i.textColor,hasOverride:i=>!!i.textColor}),"text-halo-color":new dt(be.paint_symbol["text-halo-color"]),"text-halo-width":new dt(be.paint_symbol["text-halo-width"]),"text-halo-blur":new dt(be.paint_symbol["text-halo-blur"]),"text-translate":new lt(be.paint_symbol["text-translate"]),"text-translate-anchor":new lt(be.paint_symbol["text-translate-anchor"])})},get layout(){return Up=Up||new kr({"symbol-placement":new lt(be.layout_symbol["symbol-placement"]),"symbol-spacing":new lt(be.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new lt(be.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new dt(be.layout_symbol["symbol-sort-key"]),"symbol-z-order":new lt(be.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new lt(be.layout_symbol["icon-allow-overlap"]),"icon-overlap":new lt(be.layout_symbol["icon-overlap"]),"icon-ignore-placement":new lt(be.layout_symbol["icon-ignore-placement"]),"icon-optional":new lt(be.layout_symbol["icon-optional"]),"icon-rotation-alignment":new lt(be.layout_symbol["icon-rotation-alignment"]),"icon-size":new dt(be.layout_symbol["icon-size"]),"icon-text-fit":new lt(be.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new lt(be.layout_symbol["icon-text-fit-padding"]),"icon-image":new dt(be.layout_symbol["icon-image"]),"icon-rotate":new dt(be.layout_symbol["icon-rotate"]),"icon-padding":new dt(be.layout_symbol["icon-padding"]),"icon-keep-upright":new lt(be.layout_symbol["icon-keep-upright"]),"icon-offset":new dt(be.layout_symbol["icon-offset"]),"icon-anchor":new dt(be.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new lt(be.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new lt(be.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new lt(be.layout_symbol["text-rotation-alignment"]),"text-field":new dt(be.layout_symbol["text-field"]),"text-font":new dt(be.layout_symbol["text-font"]),"text-size":new dt(be.layout_symbol["text-size"]),"text-max-width":new dt(be.layout_symbol["text-max-width"]),"text-line-height":new lt(be.layout_symbol["text-line-height"]),"text-letter-spacing":new dt(be.layout_symbol["text-letter-spacing"]),"text-justify":new dt(be.layout_symbol["text-justify"]),"text-radial-offset":new dt(be.layout_symbol["text-radial-offset"]),"text-variable-anchor":new lt(be.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new dt(be.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new dt(be.layout_symbol["text-anchor"]),"text-max-angle":new lt(be.layout_symbol["text-max-angle"]),"text-writing-mode":new lt(be.layout_symbol["text-writing-mode"]),"text-rotate":new dt(be.layout_symbol["text-rotate"]),"text-padding":new lt(be.layout_symbol["text-padding"]),"text-keep-upright":new lt(be.layout_symbol["text-keep-upright"]),"text-transform":new dt(be.layout_symbol["text-transform"]),"text-offset":new dt(be.layout_symbol["text-offset"]),"text-allow-overlap":new lt(be.layout_symbol["text-allow-overlap"]),"text-overlap":new lt(be.layout_symbol["text-overlap"]),"text-ignore-placement":new lt(be.layout_symbol["text-ignore-placement"]),"text-optional":new lt(be.layout_symbol["text-optional"])})}};class qp{constructor(t){if(t.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=t.property.overrides?t.property.overrides.runtimeType:ts,this.defaultValue=t}evaluate(t){if(t.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(t.formattedSection))return r.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Xe("FormatSectionOverride",qp,{omit:["defaultValue"]});class uh extends e{constructor(t){super(t,$u)}recalculate(t,r){if(super.recalculate(t,r),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const o=this.layout.get("text-writing-mode");if(o){const c=[];for(const f of o)c.indexOf(f)<0&&c.push(f);this.layout._values["text-writing-mode"]=c}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(t,r,o,c){const f=this.layout.get(t).evaluate(r,{},o,c),m=this._unevaluatedLayout._values[t];return m.isDataDriven()||xo(m.value)||!f?f:function(y,b){return b.replace(/{([^{}]+)}/g,(T,E)=>y&&E in y?String(y[E]):"")}(r.properties,f)}createBucket(t){return new La(t)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const t of $u.paint.overridableProperties){if(!uh.hasPaintOverride(this.layout,t))continue;const r=this.paint.get(t),o=new qp(r),c=new ca(o,r.property.specification);let f=null;f=r.value.kind==="constant"||r.value.kind==="source"?new vo("source",c):new Un("composite",c,r.value.zoomStops),this.paint._values[t]=new Tr(r.property,f,r.parameters)}}_handleOverridablePaintPropertyUpdate(t,r,o){return!(!this.layout||r.isDataDriven()||o.isDataDriven())&&uh.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,r){const o=t.get("text-field"),c=$u.paint.properties[r];let f=!1;const m=y=>{for(const b of y)if(c.overrides&&c.overrides.hasOverride(b))return void(f=!0)};if(o.value.kind==="constant"&&o.value.value instanceof Ae)m(o.value.value.sections);else if(o.value.kind==="source"){const y=T=>{f||(T instanceof is&&Jt(T.value)===Fr?m(T.value.sections):T instanceof ta?m(T.sections):T.eachChild(y))},b=o.value;b._styleExpression&&y(b._styleExpression.expression)}return f}}let Gp;var xg={get paint(){return Gp=Gp||new kr({"background-color":new lt(be.paint_background["background-color"]),"background-pattern":new Pl(be.paint_background["background-pattern"]),"background-opacity":new lt(be.paint_background["background-opacity"])})}};class vg extends e{constructor(t){super(t,xg)}}let Hp;var bg={get paint(){return Hp=Hp||new kr({"raster-opacity":new lt(be.paint_raster["raster-opacity"]),"raster-hue-rotate":new lt(be.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new lt(be.paint_raster["raster-brightness-min"]),"raster-brightness-max":new lt(be.paint_raster["raster-brightness-max"]),"raster-saturation":new lt(be.paint_raster["raster-saturation"]),"raster-contrast":new lt(be.paint_raster["raster-contrast"]),"raster-resampling":new lt(be.paint_raster["raster-resampling"]),"raster-fade-duration":new lt(be.paint_raster["raster-fade-duration"])})}};class wg extends e{constructor(t){super(t,bg)}}class Sg extends e{constructor(t){super(t,{}),this.onAdd=r=>{this.implementation.onAdd&&this.implementation.onAdd(r,r.painter.context.gl)},this.onRemove=r=>{this.implementation.onRemove&&this.implementation.onRemove(r,r.painter.context.gl)},this.implementation=t}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class Ig{constructor(t){this._methodToThrottle=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._methodToThrottle()},0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const Uu=63710088e-1;class Qn{constructor(t,r){if(isNaN(t)||isNaN(r))throw new Error(`Invalid LngLat object: (${t}, ${r})`);if(this.lng=+t,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Qn(Vt(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const r=Math.PI/180,o=this.lat*r,c=t.lat*r,f=Math.sin(o)*Math.sin(c)+Math.cos(o)*Math.cos(c)*Math.cos((t.lng-this.lng)*r);return Uu*Math.acos(Math.min(f,1))}static convert(t){if(t instanceof Qn)return t;if(Array.isArray(t)&&(t.length===2||t.length===3))return new Qn(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&typeof t=="object"&&t!==null)return new Qn(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const Zp=2*Math.PI*Uu;function Wp(i){return Zp*Math.cos(i*Math.PI/180)}function Xp(i){return(180+i)/360}function Jp(i){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i*Math.PI/360)))/360}function Kp(i,t){return i/Wp(t)}function Vu(i){return 360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90}class Gl{constructor(t,r,o=0){this.x=+t,this.y=+r,this.z=+o}static fromLngLat(t,r=0){const o=Qn.convert(t);return new Gl(Xp(o.lng),Jp(o.lat),Kp(r,o.lat))}toLngLat(){return new Qn(360*this.x-180,Vu(this.y))}toAltitude(){return this.z*Wp(Vu(this.y))}meterInMercatorCoordinateUnits(){return 1/Zp*(t=Vu(this.y),1/Math.cos(t*Math.PI/180));var t}}function Yp(i,t,r){var o=2*Math.PI*6378137/256/Math.pow(2,r);return[i*o-2*Math.PI*6378137/2,t*o-2*Math.PI*6378137/2]}class qu{constructor(t,r,o){if(!function(c,f,m){return!(c<0||c>25||m<0||m>=Math.pow(2,c)||f<0||f>=Math.pow(2,c))}(t,r,o))throw new Error(`x=${r}, y=${o}, z=${t} outside of bounds. 0<=x<${Math.pow(2,t)}, 0<=y<${Math.pow(2,t)} 0<=z<=25 `);this.z=t,this.x=r,this.y=o,this.key=Hl(0,t,t,r,o)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,r,o){const c=(m=this.y,y=this.z,b=Yp(256*(f=this.x),256*(m=Math.pow(2,y)-m-1),y),T=Yp(256*(f+1),256*(m+1),y),b[0]+","+b[1]+","+T[0]+","+T[1]);var f,m,y,b,T;const E=function(P,z,R){let F,$="";for(let Q=P;Q>0;Q--)F=1<<Q-1,$+=(z&F?1:0)+(R&F?2:0);return $}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(o==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,r>1?"@2x":"").replace(/{quadkey}/g,E).replace(/{bbox-epsg-3857}/g,c)}isChildOf(t){const r=this.z-t.z;return r>0&&t.x===this.x>>r&&t.y===this.y>>r}getTilePoint(t){const r=Math.pow(2,this.z);return new J((t.x*r-this.x)*Ui,(t.y*r-this.y)*Ui)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Qp{constructor(t,r){this.wrap=t,this.canonical=r,this.key=Hl(t,r.z,r.z,r.x,r.y)}}class ds{constructor(t,r,o,c,f){if(t<o)throw new Error(`overscaledZ should be >= z; overscaledZ = ${t}; z = ${o}`);this.overscaledZ=t,this.wrap=r,this.canonical=new qu(o,+c,+f),this.key=Hl(r,t,o,c,f)}clone(){return new ds(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){if(t>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${t}; overscaledZ = ${this.overscaledZ}`);const r=this.canonical.z-t;return t>this.canonical.z?new ds(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new ds(t,this.wrap,t,this.canonical.x>>r,this.canonical.y>>r)}calculateScaledKey(t,r){if(t>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${t}; overscaledZ = ${this.overscaledZ}`);const o=this.canonical.z-t;return t>this.canonical.z?Hl(this.wrap*+r,t,this.canonical.z,this.canonical.x,this.canonical.y):Hl(this.wrap*+r,t,t,this.canonical.x>>o,this.canonical.y>>o)}isChildOf(t){if(t.wrap!==this.wrap)return!1;const r=this.canonical.z-t.canonical.z;return t.overscaledZ===0||t.overscaledZ<this.overscaledZ&&t.canonical.x===this.canonical.x>>r&&t.canonical.y===this.canonical.y>>r}children(t){if(this.overscaledZ>=t)return[new ds(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,o=2*this.canonical.x,c=2*this.canonical.y;return[new ds(r,this.wrap,r,o,c),new ds(r,this.wrap,r,o+1,c),new ds(r,this.wrap,r,o,c+1),new ds(r,this.wrap,r,o+1,c+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new ds(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new ds(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Qp(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(t){return this.canonical.getTilePoint(new Gl(t.x-this.wrap,t.y))}}function Hl(i,t,r,o,c){(i*=2)<0&&(i=-1*i-1);const f=1<<r;return(f*f*i+f*c+o).toString(36)+r.toString(36)+t.toString(36)}Xe("CanonicalTileID",qu),Xe("OverscaledTileID",ds,{omit:["posMatrix"]});class ef{constructor(t,r,o,c=1,f=1,m=1,y=0){if(this.uid=t,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(o&&!["mapbox","terrarium","custom"].includes(o))return void pi(`"${o}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=r.height;const b=this.dim=r.height-2;switch(this.data=new Uint32Array(r.data.buffer),o){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=c,this.greenFactor=f,this.blueFactor=m,this.baseShift=y;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let T=0;T<b;T++)this.data[this._idx(-1,T)]=this.data[this._idx(0,T)],this.data[this._idx(b,T)]=this.data[this._idx(b-1,T)],this.data[this._idx(T,-1)]=this.data[this._idx(T,0)],this.data[this._idx(T,b)]=this.data[this._idx(T,b-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(b,-1)]=this.data[this._idx(b-1,0)],this.data[this._idx(-1,b)]=this.data[this._idx(0,b-1)],this.data[this._idx(b,b)]=this.data[this._idx(b-1,b-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let T=0;T<b;T++)for(let E=0;E<b;E++){const P=this.get(T,E);P>this.max&&(this.max=P),P<this.min&&(this.min=P)}}get(t,r){const o=new Uint8Array(this.data.buffer),c=4*this._idx(t,r);return this.unpack(o[c],o[c+1],o[c+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(t,r){if(t<-1||t>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(r+1)*this.stride+(t+1)}unpack(t,r,o){return t*this.redFactor+r*this.greenFactor+o*this.blueFactor-this.baseShift}getPixels(){return new us({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(t,r,o){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let c=r*this.dim,f=r*this.dim+this.dim,m=o*this.dim,y=o*this.dim+this.dim;switch(r){case-1:c=f-1;break;case 1:f=c+1}switch(o){case-1:m=y-1;break;case 1:y=m+1}const b=-r*this.dim,T=-o*this.dim;for(let E=m;E<y;E++)for(let P=c;P<f;P++)this.data[this._idx(P,E)]=t.data[this._idx(P+b,E+T)]}}Xe("DEMData",ef);class tf{constructor(t){this._stringToNumber={},this._numberToString=[];for(let r=0;r<t.length;r++){const o=t[r];this._stringToNumber[o]=r,this._numberToString[r]=o}}encode(t){return this._stringToNumber[t]}decode(t){if(t>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${t} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[t]}}class rf{constructor(t,r,o,c,f){this.type="Feature",this._vectorTileFeature=t,t._z=r,t._x=o,t._y=c,this.properties=t.properties,this.id=f}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={geometry:this.geometry};for(const r in this)r!=="_geometry"&&r!=="_vectorTileFeature"&&(t[r]=this[r]);return t}}class sf{constructor(t,r){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new Gn(Ui,16,0),this.grid3D=new Gn(Ui,16,0),this.featureIndexArray=new Er,this.promoteId=r}insert(t,r,o,c,f,m){const y=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(o,c,f);const b=m?this.grid3D:this.grid;for(let T=0;T<r.length;T++){const E=r[T],P=[1/0,1/0,-1/0,-1/0];for(let z=0;z<E.length;z++){const R=E[z];P[0]=Math.min(P[0],R.x),P[1]=Math.min(P[1],R.y),P[2]=Math.max(P[2],R.x),P[3]=Math.max(P[3],R.y)}P[0]<Ui&&P[1]<Ui&&P[2]>=0&&P[3]>=0&&b.insert(y,P[0],P[1],P[2],P[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new Jn.VectorTile(new zu(this.rawTileData)).layers,this.sourceLayerCoder=new tf(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(t,r,o,c){this.loadVTLayers();const f=t.params||{},m=Ui/t.tileSize/t.scale,y=qn(f.filter),b=t.queryGeometry,T=t.queryPadding*m,E=of(b),P=this.grid.query(E.minX-T,E.minY-T,E.maxX+T,E.maxY+T),z=of(t.cameraQueryGeometry),R=this.grid3D.query(z.minX-T,z.minY-T,z.maxX+T,z.maxY+T,(Q,ie,_e,ce)=>function(me,Se,ze,We,ft){for(const Ve of me)if(Se<=Ve.x&&ze<=Ve.y&&We>=Ve.x&&ft>=Ve.y)return!0;const Ge=[new J(Se,ze),new J(Se,ft),new J(We,ft),new J(We,ze)];if(me.length>2){for(const Ve of Ge)if(Ea(me,Ve))return!0}for(let Ve=0;Ve<me.length-1;Ve++)if(s_(me[Ve],me[Ve+1],Ge))return!0;return!1}(t.cameraQueryGeometry,Q-T,ie-T,_e+T,ce+T));for(const Q of R)P.push(Q);P.sort(Tg);const F={};let $;for(let Q=0;Q<P.length;Q++){const ie=P[Q];if(ie===$)continue;$=ie;const _e=this.featureIndexArray.get(ie);let ce=null;this.loadMatchingFeature(F,_e.bucketIndex,_e.sourceLayerIndex,_e.featureIndex,y,f.layers,f.availableImages,r,o,c,(me,Se,ze)=>(ce||(ce=Oo(me)),Se.queryIntersectsFeature(b,me,ze,ce,this.z,t.transform,m,t.pixelPosMatrix)))}return F}loadMatchingFeature(t,r,o,c,f,m,y,b,T,E,P){const z=this.bucketLayerIDs[r];if(m&&!function(Q,ie){for(let _e=0;_e<Q.length;_e++)if(ie.indexOf(Q[_e])>=0)return!0;return!1}(m,z))return;const R=this.sourceLayerCoder.decode(o),F=this.vtLayers[R].feature(c);if(f.needGeometry){const Q=Fo(F,!0);if(!f.filter(new ti(this.tileID.overscaledZ),Q,this.tileID.canonical))return}else if(!f.filter(new ti(this.tileID.overscaledZ),F))return;const $=this.getId(F,R);for(let Q=0;Q<z.length;Q++){const ie=z[Q];if(m&&m.indexOf(ie)<0)continue;const _e=b[ie];if(!_e)continue;let ce={};$&&E&&(ce=E.getState(_e.sourceLayer||"_geojsonTileLayer",$));const me=yt({},T[ie]);me.paint=nf(me.paint,_e.paint,F,ce,y),me.layout=nf(me.layout,_e.layout,F,ce,y);const Se=!P||P(F,_e,ce);if(!Se)continue;const ze=new rf(F,this.z,this.x,this.y,$);ze.layer=me;let We=t[ie];We===void 0&&(We=t[ie]=[]),We.push({featureIndex:c,feature:ze,intersectionZ:Se})}}lookupSymbolFeatures(t,r,o,c,f,m,y,b){const T={};this.loadVTLayers();const E=qn(f);for(const P of t)this.loadMatchingFeature(T,o,c,P,E,m,y,b,r);return T}hasLayer(t){for(const r of this.bucketLayerIDs)for(const o of r)if(t===o)return!0;return!1}getId(t,r){let o=t.id;return this.promoteId&&(o=t.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[r]],typeof o=="boolean"&&(o=Number(o))),o}}function nf(i,t,r,o,c){return Bt(i,(f,m)=>{const y=t instanceof xa?t.get(m):null;return y&&y.evaluate?y.evaluate(r,o,c):y})}function of(i){let t=1/0,r=1/0,o=-1/0,c=-1/0;for(const f of i)t=Math.min(t,f.x),r=Math.min(r,f.y),o=Math.max(o,f.x),c=Math.max(c,f.y);return{minX:t,minY:r,maxX:o,maxY:c}}function Tg(i,t){return t-i}function af(i,t,r,o,c){const f=[];for(let m=0;m<i.length;m++){const y=i[m];let b;for(let T=0;T<y.length-1;T++){let E=y[T],P=y[T+1];E.x<t&&P.x<t||(E.x<t?E=new J(t,E.y+(t-E.x)/(P.x-E.x)*(P.y-E.y))._round():P.x<t&&(P=new J(t,E.y+(t-E.x)/(P.x-E.x)*(P.y-E.y))._round()),E.y<r&&P.y<r||(E.y<r?E=new J(E.x+(r-E.y)/(P.y-E.y)*(P.x-E.x),r)._round():P.y<r&&(P=new J(E.x+(r-E.y)/(P.y-E.y)*(P.x-E.x),r)._round()),E.x>=o&&P.x>=o||(E.x>=o?E=new J(o,E.y+(o-E.x)/(P.x-E.x)*(P.y-E.y))._round():P.x>=o&&(P=new J(o,E.y+(o-E.x)/(P.x-E.x)*(P.y-E.y))._round()),E.y>=c&&P.y>=c||(E.y>=c?E=new J(E.x+(c-E.y)/(P.y-E.y)*(P.x-E.x),c)._round():P.y>=c&&(P=new J(E.x+(c-E.y)/(P.y-E.y)*(P.x-E.x),c)._round()),b&&E.equals(b[b.length-1])||(b=[E],f.push(b)),b.push(P)))))}}return f}Xe("FeatureIndex",sf,{omit:["rawTileData","sourceLayerCoder"]});class eo extends J{constructor(t,r,o,c){super(t,r),this.angle=o,c!==void 0&&(this.segment=c)}clone(){return new eo(this.x,this.y,this.angle,this.segment)}}function lf(i,t,r,o,c){if(t.segment===void 0||r===0)return!0;let f=t,m=t.segment+1,y=0;for(;y>-r/2;){if(m--,m<0)return!1;y-=i[m].dist(f),f=i[m]}y+=i[m].dist(i[m+1]),m++;const b=[];let T=0;for(;y<r/2;){const E=i[m],P=i[m+1];if(!P)return!1;let z=i[m-1].angleTo(E)-E.angleTo(P);for(z=Math.abs((z+3*Math.PI)%(2*Math.PI)-Math.PI),b.push({distance:y,angleDelta:z}),T+=z;y-b[0].distance>o;)T-=b.shift().angleDelta;if(T>c)return!1;m++,y+=E.dist(P)}return!0}function cf(i){let t=0;for(let r=0;r<i.length-1;r++)t+=i[r].dist(i[r+1]);return t}function hf(i,t,r){return i?.6*t*r:0}function uf(i,t){return Math.max(i?i.right-i.left:0,t?t.right-t.left:0)}function kg(i,t,r,o,c,f){const m=hf(r,c,f),y=uf(r,o)*f;let b=0;const T=cf(i)/2;for(let E=0;E<i.length-1;E++){const P=i[E],z=i[E+1],R=P.dist(z);if(b+R>T){const F=(T-b)/R,$=Sr.number(P.x,z.x,F),Q=Sr.number(P.y,z.y,F),ie=new eo($,Q,z.angleTo(P),E);return ie._round(),!m||lf(i,ie,y,m,t)?ie:void 0}b+=R}}function Eg(i,t,r,o,c,f,m,y,b){const T=hf(o,f,m),E=uf(o,c),P=E*m,z=i[0].x===0||i[0].x===b||i[0].y===0||i[0].y===b;return t-P<t/4&&(t=P+t/4),df(i,z?t/2*y%t:(E/2+2*f)*m*y%t,t,T,r,P,z,!1,b)}function df(i,t,r,o,c,f,m,y,b){const T=f/2,E=cf(i);let P=0,z=t-r,R=[];for(let F=0;F<i.length-1;F++){const $=i[F],Q=i[F+1],ie=$.dist(Q),_e=Q.angleTo($);for(;z+r<P+ie;){z+=r;const ce=(z-P)/ie,me=Sr.number($.x,Q.x,ce),Se=Sr.number($.y,Q.y,ce);if(me>=0&&me<b&&Se>=0&&Se<b&&z-T>=0&&z+T<=E){const ze=new eo(me,Se,_e,F);ze._round(),o&&!lf(i,ze,f,o,c)||R.push(ze)}}P+=ie}return y||R.length||m||(R=df(i,P/2,r,o,c,f,m,!0,b)),R}Xe("Anchor",eo);const Ra=$r;function pf(i,t,r,o){const c=[],f=i.image,m=f.pixelRatio,y=f.paddedRect.w-2*Ra,b=f.paddedRect.h-2*Ra;let T={x1:i.left,y1:i.top,x2:i.right,y2:i.bottom};const E=f.stretchX||[[0,y]],P=f.stretchY||[[0,b]],z=(ke,ct)=>ke+ct[1]-ct[0],R=E.reduce(z,0),F=P.reduce(z,0),$=y-R,Q=b-F;let ie=0,_e=R,ce=0,me=F,Se=0,ze=$,We=0,ft=Q;if(f.content&&o){const ke=f.content,ct=ke[2]-ke[0],nt=ke[3]-ke[1];(f.textFitWidth||f.textFitHeight)&&(T=jp(i)),ie=dh(E,0,ke[0]),ce=dh(P,0,ke[1]),_e=dh(E,ke[0],ke[2]),me=dh(P,ke[1],ke[3]),Se=ke[0]-ie,We=ke[1]-ce,ze=ct-_e,ft=nt-me}const Ge=T.x1,Ve=T.y1,at=T.x2-Ge,it=T.y2-Ve,Ye=(ke,ct,nt,wt)=>{const di=ph(ke.stretch-ie,_e,at,Ge),ci=fh(ke.fixed-Se,ze,ke.stretch,R),Wi=ph(ct.stretch-ce,me,it,Ve),As=fh(ct.fixed-We,ft,ct.stretch,F),or=ph(nt.stretch-ie,_e,at,Ge),Xi=fh(nt.fixed-Se,ze,nt.stretch,R),Pr=ph(wt.stretch-ce,me,it,Ve),Cr=fh(wt.fixed-We,ft,wt.stretch,F),Mr=new J(di,Wi),Mi=new J(or,Wi),Ji=new J(or,Pr),yr=new J(di,Pr),ar=new J(ci/m,As/m),zr=new J(Xi/m,Cr/m),lr=t*Math.PI/180;if(lr){const Zt=Math.sin(lr),mi=Math.cos(lr),bi=[mi,-Zt,Zt,mi];Mr._matMult(bi),Mi._matMult(bi),yr._matMult(bi),Ji._matMult(bi)}const ps=ke.stretch+ke.fixed,Ur=ct.stretch+ct.fixed;return{tl:Mr,tr:Mi,bl:yr,br:Ji,tex:{x:f.paddedRect.x+Ra+ps,y:f.paddedRect.y+Ra+Ur,w:nt.stretch+nt.fixed-ps,h:wt.stretch+wt.fixed-Ur},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:ar,pixelOffsetBR:zr,minFontScaleX:ze/m/at,minFontScaleY:ft/m/it,isSDF:r}};if(o&&(f.stretchX||f.stretchY)){const ke=ff(E,$,R),ct=ff(P,Q,F);for(let nt=0;nt<ke.length-1;nt++){const wt=ke[nt],di=ke[nt+1];for(let ci=0;ci<ct.length-1;ci++)c.push(Ye(wt,ct[ci],di,ct[ci+1]))}}else c.push(Ye({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:y+1},{fixed:0,stretch:b+1}));return c}function dh(i,t,r){let o=0;for(const c of i)o+=Math.max(t,Math.min(r,c[1]))-Math.max(t,Math.min(r,c[0]));return o}function ff(i,t,r){const o=[{fixed:-Ra,stretch:0}];for(const[c,f]of i){const m=o[o.length-1];o.push({fixed:c-m.stretch,stretch:m.stretch}),o.push({fixed:c-m.stretch,stretch:m.stretch+(f-c)})}return o.push({fixed:t+Ra,stretch:r}),o}function ph(i,t,r,o){return i/t*r+o}function fh(i,t,r,o){return i-t*r/o}class mh{constructor(t,r,o,c,f,m,y,b,T,E){var P;if(this.boxStartIndex=t.length,T){let z=m.top,R=m.bottom;const F=m.collisionPadding;F&&(z-=F[1],R+=F[3]);let $=R-z;$>0&&($=Math.max(10,$),this.circleDiameter=$)}else{const z=!((P=m.image)===null||P===void 0)&&P.content&&(m.image.textFitWidth||m.image.textFitHeight)?jp(m):{x1:m.left,y1:m.top,x2:m.right,y2:m.bottom};z.y1=z.y1*y-b[0],z.y2=z.y2*y+b[2],z.x1=z.x1*y-b[3],z.x2=z.x2*y+b[1];const R=m.collisionPadding;if(R&&(z.x1-=R[0]*y,z.y1-=R[1]*y,z.x2+=R[2]*y,z.y2+=R[3]*y),E){const F=new J(z.x1,z.y1),$=new J(z.x2,z.y1),Q=new J(z.x1,z.y2),ie=new J(z.x2,z.y2),_e=E*Math.PI/180;F._rotate(_e),$._rotate(_e),Q._rotate(_e),ie._rotate(_e),z.x1=Math.min(F.x,$.x,Q.x,ie.x),z.x2=Math.max(F.x,$.x,Q.x,ie.x),z.y1=Math.min(F.y,$.y,Q.y,ie.y),z.y2=Math.max(F.y,$.y,Q.y,ie.y)}t.emplaceBack(r.x,r.y,z.x1,z.y1,z.x2,z.y2,o,c,f)}this.boxEndIndex=t.length}}class Ag{constructor(t=[],r=(o,c)=>o<c?-1:o>c?1:0){if(this.data=t,this.length=this.data.length,this.compare=r,this.length>0)for(let o=(this.length>>1)-1;o>=0;o--)this._down(o)}push(t){this.data.push(t),this._up(this.length++)}pop(){if(this.length===0)return;const t=this.data[0],r=this.data.pop();return--this.length>0&&(this.data[0]=r,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:r,compare:o}=this,c=r[t];for(;t>0;){const f=t-1>>1,m=r[f];if(o(c,m)>=0)break;r[t]=m,t=f}r[t]=c}_down(t){const{data:r,compare:o}=this,c=this.length>>1,f=r[t];for(;t<c;){let m=1+(t<<1);const y=m+1;if(y<this.length&&o(r[y],r[m])<0&&(m=y),o(r[m],f)>=0)break;r[t]=r[m],t=m}r[t]=f}}function Pg(i,t=1,r=!1){let o=1/0,c=1/0,f=-1/0,m=-1/0;const y=i[0];for(let R=0;R<y.length;R++){const F=y[R];(!R||F.x<o)&&(o=F.x),(!R||F.y<c)&&(c=F.y),(!R||F.x>f)&&(f=F.x),(!R||F.y>m)&&(m=F.y)}const b=Math.min(f-o,m-c);let T=b/2;const E=new Ag([],Cg);if(b===0)return new J(o,c);for(let R=o;R<f;R+=b)for(let F=c;F<m;F+=b)E.push(new Oa(R+T,F+T,T,i));let P=function(R){let F=0,$=0,Q=0;const ie=R[0];for(let _e=0,ce=ie.length,me=ce-1;_e<ce;me=_e++){const Se=ie[_e],ze=ie[me],We=Se.x*ze.y-ze.x*Se.y;$+=(Se.x+ze.x)*We,Q+=(Se.y+ze.y)*We,F+=3*We}return new Oa($/F,Q/F,0,R)}(i),z=E.length;for(;E.length;){const R=E.pop();(R.d>P.d||!P.d)&&(P=R,r&&console.log("found best %d after %d probes",Math.round(1e4*R.d)/1e4,z)),R.max-P.d<=t||(T=R.h/2,E.push(new Oa(R.p.x-T,R.p.y-T,T,i)),E.push(new Oa(R.p.x+T,R.p.y-T,T,i)),E.push(new Oa(R.p.x-T,R.p.y+T,T,i)),E.push(new Oa(R.p.x+T,R.p.y+T,T,i)),z+=4)}return r&&(console.log(`num probes: ${z}`),console.log(`best distance: ${P.d}`)),P.p}function Cg(i,t){return t.max-i.max}function Oa(i,t,r,o){this.p=new J(i,t),this.h=r,this.d=function(c,f){let m=!1,y=1/0;for(let b=0;b<f.length;b++){const T=f[b];for(let E=0,P=T.length,z=P-1;E<P;z=E++){const R=T[E],F=T[z];R.y>c.y!=F.y>c.y&&c.x<(F.x-R.x)*(c.y-R.y)/(F.y-R.y)+R.x&&(m=!m),y=Math.min(y,Jd(c,R,F))}}return(m?1:-1)*Math.sqrt(y)}(this.p,o),this.max=this.d+this.h*Math.SQRT2}var nr;S.aq=void 0,(nr=S.aq||(S.aq={}))[nr.center=1]="center",nr[nr.left=2]="left",nr[nr.right=3]="right",nr[nr.top=4]="top",nr[nr.bottom=5]="bottom",nr[nr["top-left"]=6]="top-left",nr[nr["top-right"]=7]="top-right",nr[nr["bottom-left"]=8]="bottom-left",nr[nr["bottom-right"]=9]="bottom-right";const to=7,Gu=Number.POSITIVE_INFINITY;function mf(i,t){return t[1]!==Gu?function(r,o,c){let f=0,m=0;switch(o=Math.abs(o),c=Math.abs(c),r){case"top-right":case"top-left":case"top":m=c-to;break;case"bottom-right":case"bottom-left":case"bottom":m=-c+to}switch(r){case"top-right":case"bottom-right":case"right":f=-o;break;case"top-left":case"bottom-left":case"left":f=o}return[f,m]}(i,t[0],t[1]):function(r,o){let c=0,f=0;o<0&&(o=0);const m=o/Math.SQRT2;switch(r){case"top-right":case"top-left":f=m-to;break;case"bottom-right":case"bottom-left":f=-m+to;break;case"bottom":f=-o+to;break;case"top":f=o-to}switch(r){case"top-right":case"bottom-right":c=-m;break;case"top-left":case"bottom-left":c=m;break;case"left":c=o;break;case"right":c=-o}return[c,f]}(i,t[0])}function _f(i,t,r){var o;const c=i.layout,f=(o=c.get("text-variable-anchor-offset"))===null||o===void 0?void 0:o.evaluate(t,{},r);if(f){const y=f.values,b=[];for(let T=0;T<y.length;T+=2){const E=b[T]=y[T],P=y[T+1].map(z=>z*qi);E.startsWith("top")?P[1]-=to:E.startsWith("bottom")&&(P[1]+=to),b[T+1]=P}return new Te(b)}const m=c.get("text-variable-anchor");if(m){let y;y=i._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[c.get("text-radial-offset").evaluate(t,{},r)*qi,Gu]:c.get("text-offset").evaluate(t,{},r).map(T=>T*qi);const b=[];for(const T of m)b.push(T,mf(T,y));return new Te(b)}return null}function Hu(i){switch(i){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Mg(i,t,r,o,c,f,m,y,b,T,E){let P=f.textMaxSize.evaluate(t,{});P===void 0&&(P=m);const z=i.layers[0].layout,R=z.get("icon-offset").evaluate(t,{},E),F=yf(r.horizontal),$=m/24,Q=i.tilePixelRatio*$,ie=i.tilePixelRatio*P/24,_e=i.tilePixelRatio*y,ce=i.tilePixelRatio*z.get("symbol-spacing"),me=z.get("text-padding")*i.tilePixelRatio,Se=function(ke,ct,nt,wt=1){const di=ke.get("icon-padding").evaluate(ct,{},nt),ci=di&&di.values;return[ci[0]*wt,ci[1]*wt,ci[2]*wt,ci[3]*wt]}(z,t,E,i.tilePixelRatio),ze=z.get("text-max-angle")/180*Math.PI,We=z.get("text-rotation-alignment")!=="viewport"&&z.get("symbol-placement")!=="point",ft=z.get("icon-rotation-alignment")==="map"&&z.get("symbol-placement")!=="point",Ge=z.get("symbol-placement"),Ve=ce/2,at=z.get("icon-text-fit");let it;o&&at!=="none"&&(i.allowVerticalPlacement&&r.vertical&&(it=Np(o,r.vertical,at,z.get("icon-text-fit-padding"),R,$)),F&&(o=Np(o,F,at,z.get("icon-text-fit-padding"),R,$)));const Ye=(ke,ct)=>{ct.x<0||ct.x>=Ui||ct.y<0||ct.y>=Ui||function(nt,wt,di,ci,Wi,As,or,Xi,Pr,Cr,Mr,Mi,Ji,yr,ar,zr,lr,ps,Ur,Zt,mi,bi,Kr,Ai,Fa){const Qs=nt.addToLineVertexArray(wt,di);let en,Ps,fs,er,An=0,Xl=0,wf=0,Sf=0,ed=-1,td=-1;const Pn={};let If=Ta("");if(nt.allowVerticalPlacement&&ci.vertical){const xr=Xi.layout.get("text-rotate").evaluate(mi,{},Ai)+90;fs=new mh(Pr,wt,Cr,Mr,Mi,ci.vertical,Ji,yr,ar,xr),or&&(er=new mh(Pr,wt,Cr,Mr,Mi,or,lr,ps,ar,xr))}if(Wi){const xr=Xi.layout.get("icon-rotate").evaluate(mi,{}),ms=Xi.layout.get("icon-text-fit")!=="none",jo=pf(Wi,xr,Kr,ms),Bs=or?pf(or,xr,Kr,ms):void 0;Ps=new mh(Pr,wt,Cr,Mr,Mi,Wi,lr,ps,!1,xr),An=4*jo.length;const No=nt.iconSizeData;let tn=null;No.kind==="source"?(tn=[Ys*Xi.layout.get("icon-size").evaluate(mi,{})],tn[0]>Yn&&pi(`${nt.layerIds[0]}: Value for "icon-size" is >= ${ql}. Reduce your "icon-size".`)):No.kind==="composite"&&(tn=[Ys*bi.compositeIconSizes[0].evaluate(mi,{},Ai),Ys*bi.compositeIconSizes[1].evaluate(mi,{},Ai)],(tn[0]>Yn||tn[1]>Yn)&&pi(`${nt.layerIds[0]}: Value for "icon-size" is >= ${ql}. Reduce your "icon-size".`)),nt.addSymbols(nt.icon,jo,tn,Zt,Ur,mi,S.ah.none,wt,Qs.lineStartIndex,Qs.lineLength,-1,Ai),ed=nt.icon.placedSymbolArray.length-1,Bs&&(Xl=4*Bs.length,nt.addSymbols(nt.icon,Bs,tn,Zt,Ur,mi,S.ah.vertical,wt,Qs.lineStartIndex,Qs.lineLength,-1,Ai),td=nt.icon.placedSymbolArray.length-1)}const Tf=Object.keys(ci.horizontal);for(const xr of Tf){const ms=ci.horizontal[xr];if(!en){If=Ta(ms.text);const Bs=Xi.layout.get("text-rotate").evaluate(mi,{},Ai);en=new mh(Pr,wt,Cr,Mr,Mi,ms,Ji,yr,ar,Bs)}const jo=ms.positionedLines.length===1;if(wf+=gf(nt,wt,ms,As,Xi,ar,mi,zr,Qs,ci.vertical?S.ah.horizontal:S.ah.horizontalOnly,jo?Tf:[xr],Pn,ed,bi,Ai),jo)break}ci.vertical&&(Sf+=gf(nt,wt,ci.vertical,As,Xi,ar,mi,zr,Qs,S.ah.vertical,["vertical"],Pn,td,bi,Ai));const Lg=en?en.boxStartIndex:nt.collisionBoxArray.length,Rg=en?en.boxEndIndex:nt.collisionBoxArray.length,Og=fs?fs.boxStartIndex:nt.collisionBoxArray.length,Fg=fs?fs.boxEndIndex:nt.collisionBoxArray.length,Bg=Ps?Ps.boxStartIndex:nt.collisionBoxArray.length,jg=Ps?Ps.boxEndIndex:nt.collisionBoxArray.length,Ng=er?er.boxStartIndex:nt.collisionBoxArray.length,$g=er?er.boxEndIndex:nt.collisionBoxArray.length;let Fs=-1;const gh=(xr,ms)=>xr&&xr.circleDiameter?Math.max(xr.circleDiameter,ms):ms;Fs=gh(en,Fs),Fs=gh(fs,Fs),Fs=gh(Ps,Fs),Fs=gh(er,Fs);const kf=Fs>-1?1:0;kf&&(Fs*=Fa/qi),nt.glyphOffsetArray.length>=La.MAX_GLYPHS&&pi("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),mi.sortKey!==void 0&&nt.addToSortKeyRanges(nt.symbolInstances.length,mi.sortKey);const Ug=_f(Xi,mi,Ai),[Vg,qg]=function(xr,ms){const jo=xr.length,Bs=ms==null?void 0:ms.values;if((Bs==null?void 0:Bs.length)>0)for(let No=0;No<Bs.length;No+=2){const tn=Bs[No+1];xr.emplaceBack(S.aq[Bs[No]],tn[0],tn[1])}return[jo,xr.length]}(nt.textAnchorOffsets,Ug);nt.symbolInstances.emplaceBack(wt.x,wt.y,Pn.right>=0?Pn.right:-1,Pn.center>=0?Pn.center:-1,Pn.left>=0?Pn.left:-1,Pn.vertical||-1,ed,td,If,Lg,Rg,Og,Fg,Bg,jg,Ng,$g,Cr,wf,Sf,An,Xl,kf,0,Ji,Fs,Vg,qg)}(i,ct,ke,r,o,c,it,i.layers[0],i.collisionBoxArray,t.index,t.sourceLayerIndex,i.index,Q,[me,me,me,me],We,b,_e,Se,ft,R,t,f,T,E,m)};if(Ge==="line")for(const ke of af(t.geometry,0,0,Ui,Ui)){const ct=Eg(ke,ce,ze,r.vertical||F,o,24,ie,i.overscaling,Ui);for(const nt of ct)F&&zg(i,F.text,Ve,nt)||Ye(ke,nt)}else if(Ge==="line-center"){for(const ke of t.geometry)if(ke.length>1){const ct=kg(ke,ze,r.vertical||F,o,24,ie);ct&&Ye(ke,ct)}}else if(t.type==="Polygon")for(const ke of ra(t.geometry,0)){const ct=Pg(ke,16);Ye(ke[0],new eo(ct.x,ct.y,0))}else if(t.type==="LineString")for(const ke of t.geometry)Ye(ke,new eo(ke[0].x,ke[0].y,0));else if(t.type==="Point")for(const ke of t.geometry)for(const ct of ke)Ye([ct],new eo(ct.x,ct.y,0))}function gf(i,t,r,o,c,f,m,y,b,T,E,P,z,R,F){const $=function(_e,ce,me,Se,ze,We,ft,Ge){const Ve=Se.layout.get("text-rotate").evaluate(We,{})*Math.PI/180,at=[];for(const it of ce.positionedLines)for(const Ye of it.positionedGlyphs){if(!Ye.rect)continue;const ke=Ye.rect||{};let ct=zp+1,nt=!0,wt=1,di=0;const ci=(ze||Ge)&&Ye.vertical,Wi=Ye.metrics.advance*Ye.scale/2;if(Ge&&ce.verticalizable&&(di=it.lineOffset/2-(Ye.imageName?-(qi-Ye.metrics.width*Ye.scale)/2:(Ye.scale-1)*qi)),Ye.imageName){const Zt=ft[Ye.imageName];nt=Zt.sdf,wt=Zt.pixelRatio,ct=$r/wt}const As=ze?[Ye.x+Wi,Ye.y]:[0,0];let or=ze?[0,0]:[Ye.x+Wi+me[0],Ye.y+me[1]-di],Xi=[0,0];ci&&(Xi=or,or=[0,0]);const Pr=Ye.metrics.isDoubleResolution?2:1,Cr=(Ye.metrics.left-ct)*Ye.scale-Wi+or[0],Mr=(-Ye.metrics.top-ct)*Ye.scale+or[1],Mi=Cr+ke.w/Pr*Ye.scale/wt,Ji=Mr+ke.h/Pr*Ye.scale/wt,yr=new J(Cr,Mr),ar=new J(Mi,Mr),zr=new J(Cr,Ji),lr=new J(Mi,Ji);if(ci){const Zt=new J(-Wi,Wi-Ul),mi=-Math.PI/2,bi=qi/2-Wi,Kr=new J(5-Ul-bi,-(Ye.imageName?bi:0)),Ai=new J(...Xi);yr._rotateAround(mi,Zt)._add(Kr)._add(Ai),ar._rotateAround(mi,Zt)._add(Kr)._add(Ai),zr._rotateAround(mi,Zt)._add(Kr)._add(Ai),lr._rotateAround(mi,Zt)._add(Kr)._add(Ai)}if(Ve){const Zt=Math.sin(Ve),mi=Math.cos(Ve),bi=[mi,-Zt,Zt,mi];yr._matMult(bi),ar._matMult(bi),zr._matMult(bi),lr._matMult(bi)}const ps=new J(0,0),Ur=new J(0,0);at.push({tl:yr,tr:ar,bl:zr,br:lr,tex:ke,writingMode:ce.writingMode,glyphOffset:As,sectionIndex:Ye.sectionIndex,isSDF:nt,pixelOffsetTL:ps,pixelOffsetBR:Ur,minFontScaleX:0,minFontScaleY:0})}return at}(0,r,y,c,f,m,o,i.allowVerticalPlacement),Q=i.textSizeData;let ie=null;Q.kind==="source"?(ie=[Ys*c.layout.get("text-size").evaluate(m,{})],ie[0]>Yn&&pi(`${i.layerIds[0]}: Value for "text-size" is >= ${ql}. Reduce your "text-size".`)):Q.kind==="composite"&&(ie=[Ys*R.compositeTextSizes[0].evaluate(m,{},F),Ys*R.compositeTextSizes[1].evaluate(m,{},F)],(ie[0]>Yn||ie[1]>Yn)&&pi(`${i.layerIds[0]}: Value for "text-size" is >= ${ql}. Reduce your "text-size".`)),i.addSymbols(i.text,$,ie,y,f,m,T,t,b.lineStartIndex,b.lineLength,z,F);for(const _e of E)P[_e]=i.text.placedSymbolArray.length-1;return 4*$.length}function yf(i){for(const t in i)return i[t];return null}function zg(i,t,r,o){const c=i.compareText;if(t in c){const f=c[t];for(let m=f.length-1;m>=0;m--)if(o.dist(f[m])<r)return!0}else c[t]=[];return c[t].push(o),!1}const xf=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Zu{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[r,o]=new Uint8Array(t,0,2);if(r!==219)throw new Error("Data does not appear to be in a KDBush format.");const c=o>>4;if(c!==1)throw new Error(`Got v${c} data when expected v1.`);const f=xf[15&o];if(!f)throw new Error("Unrecognized array type.");const[m]=new Uint16Array(t,2,1),[y]=new Uint32Array(t,4,1);return new Zu(y,m,f,t)}constructor(t,r=64,o=Float64Array,c){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+r,2),65535),this.ArrayType=o,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const f=xf.indexOf(this.ArrayType),m=2*t*this.ArrayType.BYTES_PER_ELEMENT,y=t*this.IndexArrayType.BYTES_PER_ELEMENT,b=(8-y%8)%8;if(f<0)throw new Error(`Unexpected typed array class: ${o}.`);c&&c instanceof ArrayBuffer?(this.data=c,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+y+b,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+m+y+b),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+y+b,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+f]),new Uint16Array(this.data,2,1)[0]=r,new Uint32Array(this.data,4,1)[0]=t)}add(t,r){const o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=t,this.coords[this._pos++]=r,o}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return Wu(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,r,o,c){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:f,coords:m,nodeSize:y}=this,b=[0,f.length-1,0],T=[];for(;b.length;){const E=b.pop()||0,P=b.pop()||0,z=b.pop()||0;if(P-z<=y){for(let Q=z;Q<=P;Q++){const ie=m[2*Q],_e=m[2*Q+1];ie>=t&&ie<=o&&_e>=r&&_e<=c&&T.push(f[Q])}continue}const R=z+P>>1,F=m[2*R],$=m[2*R+1];F>=t&&F<=o&&$>=r&&$<=c&&T.push(f[R]),(E===0?t<=F:r<=$)&&(b.push(z),b.push(R-1),b.push(1-E)),(E===0?o>=F:c>=$)&&(b.push(R+1),b.push(P),b.push(1-E))}return T}within(t,r,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:c,coords:f,nodeSize:m}=this,y=[0,c.length-1,0],b=[],T=o*o;for(;y.length;){const E=y.pop()||0,P=y.pop()||0,z=y.pop()||0;if(P-z<=m){for(let Q=z;Q<=P;Q++)bf(f[2*Q],f[2*Q+1],t,r)<=T&&b.push(c[Q]);continue}const R=z+P>>1,F=f[2*R],$=f[2*R+1];bf(F,$,t,r)<=T&&b.push(c[R]),(E===0?t-o<=F:r-o<=$)&&(y.push(z),y.push(R-1),y.push(1-E)),(E===0?t+o>=F:r+o>=$)&&(y.push(R+1),y.push(P),y.push(1-E))}return b}}function Wu(i,t,r,o,c,f){if(c-o<=r)return;const m=o+c>>1;vf(i,t,m,o,c,f),Wu(i,t,r,o,m-1,1-f),Wu(i,t,r,m+1,c,1-f)}function vf(i,t,r,o,c,f){for(;c>o;){if(c-o>600){const T=c-o+1,E=r-o+1,P=Math.log(T),z=.5*Math.exp(2*P/3),R=.5*Math.sqrt(P*z*(T-z)/T)*(E-T/2<0?-1:1);vf(i,t,r,Math.max(o,Math.floor(r-E*z/T+R)),Math.min(c,Math.floor(r+(T-E)*z/T+R)),f)}const m=t[2*r+f];let y=o,b=c;for(Zl(i,t,o,r),t[2*c+f]>m&&Zl(i,t,o,c);y<b;){for(Zl(i,t,y,b),y++,b--;t[2*y+f]<m;)y++;for(;t[2*b+f]>m;)b--}t[2*o+f]===m?Zl(i,t,o,b):(b++,Zl(i,t,b,c)),b<=r&&(o=b+1),r<=b&&(c=b-1)}}function Zl(i,t,r,o){Xu(i,r,o),Xu(t,2*r,2*o),Xu(t,2*r+1,2*o+1)}function Xu(i,t,r){const o=i[t];i[t]=i[r],i[r]=o}function bf(i,t,r,o){const c=i-r,f=t-o;return c*c+f*f}var Ju;S.bg=void 0,(Ju=S.bg||(S.bg={})).create="create",Ju.load="load",Ju.fullLoad="fullLoad";let _h=null,Wl=[];const Ku=1e3/60,Yu="loadTime",Qu="fullLoadTime",Dg={mark(i){performance.mark(i)},frame(i){const t=i;_h!=null&&Wl.push(t-_h),_h=t},clearMetrics(){_h=null,Wl=[],performance.clearMeasures(Yu),performance.clearMeasures(Qu);for(const i in S.bg)performance.clearMarks(S.bg[i])},getPerformanceMetrics(){performance.measure(Yu,S.bg.create,S.bg.load),performance.measure(Qu,S.bg.create,S.bg.fullLoad);const i=performance.getEntriesByName(Yu)[0].duration,t=performance.getEntriesByName(Qu)[0].duration,r=Wl.length,o=1/(Wl.reduce((f,m)=>f+m,0)/r/1e3),c=Wl.filter(f=>f>Ku).reduce((f,m)=>f+(m-Ku)/Ku,0);return{loadTime:i,fullLoadTime:t,fps:o,percentDroppedFrames:c/(r+c)*100,totalFrames:r}}};S.$=class extends A{},S.A=Aa,S.B=ou,S.C=function(i){if(ni==null){const t=i.navigator?i.navigator.userAgent:null;ni=!!i.safari||!(!t||!(/\b(iPad|iPhone|iPod)\b/.test(t)||t.match("Safari")&&!t.match("Chrome")))}return ni},S.D=lt,S.E=zs,S.F=class{constructor(i,t){this.target=i,this.mapId=t,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new Ig(()=>this.process()),this.subscription=function(r,o,c,f){return r.addEventListener(o,c,!1),{unsubscribe:()=>{r.removeEventListener(o,c,!1)}}}(this.target,"message",r=>this.receive(r)),this.globalScope=Ut(self)?i:window}registerMessageHandler(i,t){this.messageHandlers[i]=t}sendAsync(i,t){return new Promise((r,o)=>{const c=Math.round(1e18*Math.random()).toString(36).substring(0,10);this.resolveRejects[c]={resolve:r,reject:o},t&&t.signal.addEventListener("abort",()=>{delete this.resolveRejects[c];const y={id:c,type:"<cancel>",origin:location.origin,targetMapId:i.targetMapId,sourceMapId:this.mapId};this.target.postMessage(y)},{once:!0});const f=[],m=Object.assign(Object.assign({},i),{id:c,sourceMapId:this.mapId,origin:location.origin,data:Po(i.data,f)});this.target.postMessage(m,{transfer:f})})}receive(i){const t=i.data,r=t.id;if(!(t.origin!=="file://"&&location.origin!=="file://"&&t.origin!=="resource://android"&&location.origin!=="resource://android"&&t.origin!==location.origin||t.targetMapId&&this.mapId!==t.targetMapId)){if(t.type==="<cancel>"){delete this.tasks[r];const o=this.abortControllers[r];return delete this.abortControllers[r],void(o&&o.abort())}if(Ut(self)||t.mustQueue)return this.tasks[r]=t,this.taskQueue.push(r),void this.invoker.trigger();this.processTask(r,t)}}process(){if(this.taskQueue.length===0)return;const i=this.taskQueue.shift(),t=this.tasks[i];delete this.tasks[i],this.taskQueue.length>0&&this.invoker.trigger(),t&&this.processTask(i,t)}processTask(i,t){return h(this,void 0,void 0,function*(){if(t.type==="<response>"){const c=this.resolveRejects[i];return delete this.resolveRejects[i],c?void(t.error?c.reject(Hn(t.error)):c.resolve(Hn(t.data))):void 0}if(!this.messageHandlers[t.type])return void this.completeTask(i,new Error(`Could not find a registered handler for ${t.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const r=Hn(t.data),o=new AbortController;this.abortControllers[i]=o;try{const c=yield this.messageHandlers[t.type](t.sourceMapId,r,o);this.completeTask(i,null,c)}catch(c){this.completeTask(i,c)}})}completeTask(i,t,r){const o=[];delete this.abortControllers[i];const c={id:i,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:t?Po(t):null,data:Po(r,o)};this.target.postMessage(c,{transfer:o})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},S.G=Ss,S.H=function(){var i=new Aa(16);return Aa!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i},S.I=Lu,S.J=function(i,t,r){var o,c,f,m,y,b,T,E,P,z,R,F,$=r[0],Q=r[1],ie=r[2];return t===i?(i[12]=t[0]*$+t[4]*Q+t[8]*ie+t[12],i[13]=t[1]*$+t[5]*Q+t[9]*ie+t[13],i[14]=t[2]*$+t[6]*Q+t[10]*ie+t[14],i[15]=t[3]*$+t[7]*Q+t[11]*ie+t[15]):(c=t[1],f=t[2],m=t[3],y=t[4],b=t[5],T=t[6],E=t[7],P=t[8],z=t[9],R=t[10],F=t[11],i[0]=o=t[0],i[1]=c,i[2]=f,i[3]=m,i[4]=y,i[5]=b,i[6]=T,i[7]=E,i[8]=P,i[9]=z,i[10]=R,i[11]=F,i[12]=o*$+y*Q+P*ie+t[12],i[13]=c*$+b*Q+z*ie+t[13],i[14]=f*$+T*Q+R*ie+t[14],i[15]=m*$+E*Q+F*ie+t[15]),i},S.K=function(i,t,r){var o=r[0],c=r[1],f=r[2];return i[0]=t[0]*o,i[1]=t[1]*o,i[2]=t[2]*o,i[3]=t[3]*o,i[4]=t[4]*c,i[5]=t[5]*c,i[6]=t[6]*c,i[7]=t[7]*c,i[8]=t[8]*f,i[9]=t[9]*f,i[10]=t[10]*f,i[11]=t[11]*f,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i},S.L=ep,S.M=function(i,t){const r={};for(let o=0;o<t.length;o++){const c=t[o];c in i&&(r[c]=i[c])}return r},S.N=Qn,S.O=Xp,S.P=J,S.Q=Jp,S.R=us,S.S=ds,S.T=Al,S.U=Tt,S.V=xt,S.W=Ni,S.X=Ui,S.Y=d,S.Z=Gl,S._=h,S.a=Yr,S.a$=function(i,t){var r=i[0],o=i[1],c=i[2],f=i[3],m=i[4],y=i[5],b=i[6],T=i[7],E=i[8],P=i[9],z=i[10],R=i[11],F=i[12],$=i[13],Q=i[14],ie=i[15],_e=t[0],ce=t[1],me=t[2],Se=t[3],ze=t[4],We=t[5],ft=t[6],Ge=t[7],Ve=t[8],at=t[9],it=t[10],Ye=t[11],ke=t[12],ct=t[13],nt=t[14],wt=t[15];return Math.abs(r-_e)<=Ar*Math.max(1,Math.abs(r),Math.abs(_e))&&Math.abs(o-ce)<=Ar*Math.max(1,Math.abs(o),Math.abs(ce))&&Math.abs(c-me)<=Ar*Math.max(1,Math.abs(c),Math.abs(me))&&Math.abs(f-Se)<=Ar*Math.max(1,Math.abs(f),Math.abs(Se))&&Math.abs(m-ze)<=Ar*Math.max(1,Math.abs(m),Math.abs(ze))&&Math.abs(y-We)<=Ar*Math.max(1,Math.abs(y),Math.abs(We))&&Math.abs(b-ft)<=Ar*Math.max(1,Math.abs(b),Math.abs(ft))&&Math.abs(T-Ge)<=Ar*Math.max(1,Math.abs(T),Math.abs(Ge))&&Math.abs(E-Ve)<=Ar*Math.max(1,Math.abs(E),Math.abs(Ve))&&Math.abs(P-at)<=Ar*Math.max(1,Math.abs(P),Math.abs(at))&&Math.abs(z-it)<=Ar*Math.max(1,Math.abs(z),Math.abs(it))&&Math.abs(R-Ye)<=Ar*Math.max(1,Math.abs(R),Math.abs(Ye))&&Math.abs(F-ke)<=Ar*Math.max(1,Math.abs(F),Math.abs(ke))&&Math.abs($-ct)<=Ar*Math.max(1,Math.abs($),Math.abs(ct))&&Math.abs(Q-nt)<=Ar*Math.max(1,Math.abs(Q),Math.abs(nt))&&Math.abs(ie-wt)<=Ar*Math.max(1,Math.abs(ie),Math.abs(wt))},S.a0=ai,S.a1=qu,S.a2=Oe,S.a3=i=>{const t=window.document.createElement("video");return t.muted=!0,new Promise(r=>{t.onloadstart=()=>{r(t)};for(const o of i){const c=window.document.createElement("source");$i(o)||(t.crossOrigin="Anonymous"),c.src=o,t.appendChild(c)}})},S.a4=function(){return ri++},S.a5=Ue,S.a6=La,S.a7=qn,S.a8=Fo,S.a9=rf,S.aA=function(i){if(i.type==="custom")return new Sg(i);switch(i.type){case"background":return new vg(i);case"circle":return new a_(i);case"fill":return new I_(i);case"fill-extrusion":return new j_(i);case"heatmap":return new c_(i);case"hillshade":return new u_(i);case"line":return new Z_(i);case"raster":return new wg(i);case"symbol":return new uh(i)}},S.aB=Lt,S.aC=function(i,t){if(!i)return[{command:"setStyle",args:[t]}];let r=[];try{if(!Gt(i.version,t.version))return[{command:"setStyle",args:[t]}];Gt(i.center,t.center)||r.push({command:"setCenter",args:[t.center]}),Gt(i.zoom,t.zoom)||r.push({command:"setZoom",args:[t.zoom]}),Gt(i.bearing,t.bearing)||r.push({command:"setBearing",args:[t.bearing]}),Gt(i.pitch,t.pitch)||r.push({command:"setPitch",args:[t.pitch]}),Gt(i.sprite,t.sprite)||r.push({command:"setSprite",args:[t.sprite]}),Gt(i.glyphs,t.glyphs)||r.push({command:"setGlyphs",args:[t.glyphs]}),Gt(i.transition,t.transition)||r.push({command:"setTransition",args:[t.transition]}),Gt(i.light,t.light)||r.push({command:"setLight",args:[t.light]}),Gt(i.terrain,t.terrain)||r.push({command:"setTerrain",args:[t.terrain]}),Gt(i.sky,t.sky)||r.push({command:"setSky",args:[t.sky]}),Gt(i.projection,t.projection)||r.push({command:"setProjection",args:[t.projection]});const o={},c=[];(function(m,y,b,T){let E;for(E in y=y||{},m=m||{})Object.prototype.hasOwnProperty.call(m,E)&&(Object.prototype.hasOwnProperty.call(y,E)||es(E,b,T));for(E in y)Object.prototype.hasOwnProperty.call(y,E)&&(Object.prototype.hasOwnProperty.call(m,E)?Gt(m[E],y[E])||(m[E].type==="geojson"&&y[E].type==="geojson"&&Ki(m,y,E)?Si(b,{command:"setGeoJSONSourceData",args:[E,y[E].data]}):vr(E,y,b,T)):Qr(E,y,b))})(i.sources,t.sources,c,o);const f=[];i.layers&&i.layers.forEach(m=>{"source"in m&&o[m.source]?r.push({command:"removeLayer",args:[m.id]}):f.push(m)}),r=r.concat(c),function(m,y,b){y=y||[];const T=(m=m||[]).map(an),E=y.map(an),P=m.reduce(ln,{}),z=y.reduce(ln,{}),R=T.slice(),F=Object.create(null);let $,Q,ie,_e,ce;for(let me=0,Se=0;me<T.length;me++)$=T[me],Object.prototype.hasOwnProperty.call(z,$)?Se++:(Si(b,{command:"removeLayer",args:[$]}),R.splice(R.indexOf($,Se),1));for(let me=0,Se=0;me<E.length;me++)$=E[E.length-1-me],R[R.length-1-me]!==$&&(Object.prototype.hasOwnProperty.call(P,$)?(Si(b,{command:"removeLayer",args:[$]}),R.splice(R.lastIndexOf($,R.length-Se),1)):Se++,_e=R[R.length-me],Si(b,{command:"addLayer",args:[z[$],_e]}),R.splice(R.length-me,0,$),F[$]=!0);for(let me=0;me<E.length;me++)if($=E[me],Q=P[$],ie=z[$],!F[$]&&!Gt(Q,ie))if(Gt(Q.source,ie.source)&&Gt(Q["source-layer"],ie["source-layer"])&&Gt(Q.type,ie.type)){for(ce in br(Q.layout,ie.layout,b,$,null,"setLayoutProperty"),br(Q.paint,ie.paint,b,$,null,"setPaintProperty"),Gt(Q.filter,ie.filter)||Si(b,{command:"setFilter",args:[$,ie.filter]}),Gt(Q.minzoom,ie.minzoom)&&Gt(Q.maxzoom,ie.maxzoom)||Si(b,{command:"setLayerZoomRange",args:[$,ie.minzoom,ie.maxzoom]}),Q)Object.prototype.hasOwnProperty.call(Q,ce)&&ce!=="layout"&&ce!=="paint"&&ce!=="filter"&&ce!=="metadata"&&ce!=="minzoom"&&ce!=="maxzoom"&&(ce.indexOf("paint.")===0?br(Q[ce],ie[ce],b,$,ce.slice(6),"setPaintProperty"):Gt(Q[ce],ie[ce])||Si(b,{command:"setLayerProperty",args:[$,ce,ie[ce]]}));for(ce in ie)Object.prototype.hasOwnProperty.call(ie,ce)&&!Object.prototype.hasOwnProperty.call(Q,ce)&&ce!=="layout"&&ce!=="paint"&&ce!=="filter"&&ce!=="metadata"&&ce!=="minzoom"&&ce!=="maxzoom"&&(ce.indexOf("paint.")===0?br(Q[ce],ie[ce],b,$,ce.slice(6),"setPaintProperty"):Gt(Q[ce],ie[ce])||Si(b,{command:"setLayerProperty",args:[$,ce,ie[ce]]}))}else Si(b,{command:"removeLayer",args:[$]}),_e=R[R.lastIndexOf($)+1],Si(b,{command:"addLayer",args:[ie,_e]})}(f,t.layers,r)}catch(o){console.warn("Unable to compute style diff:",o),r=[{command:"setStyle",args:[t]}]}return r},S.aD=function(i){const t=[],r=i.id;return r===void 0&&t.push({message:`layers.${r}: missing required property "id"`}),i.render===void 0&&t.push({message:`layers.${r}: missing required method "render"`}),i.renderingMode&&i.renderingMode!=="2d"&&i.renderingMode!=="3d"&&t.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),t},S.aE=function i(t,r){if(Array.isArray(t)){if(!Array.isArray(r)||t.length!==r.length)return!1;for(let o=0;o<t.length;o++)if(!i(t[o],r[o]))return!1;return!0}if(typeof t=="object"&&t!==null&&r!==null){if(typeof r!="object"||Object.keys(t).length!==Object.keys(r).length)return!1;for(const o in t)if(!i(t[o],r[o]))return!1;return!0}return t===r},S.aF=Bt,S.aG=ji,S.aH=class extends Rs{constructor(i,t){super(i,t),this.current=0}set(i){this.current!==i&&(this.current=i,this.gl.uniform1i(this.location,i))}},S.aI=Yc,S.aJ=class extends Rs{constructor(i,t){super(i,t),this.current=Qm}set(i){if(i[12]!==this.current[12]||i[0]!==this.current[0])return this.current=i,void this.gl.uniformMatrix4fv(this.location,!1,i);for(let t=1;t<16;t++)if(i[t]!==this.current[t]){this.current=i,this.gl.uniformMatrix4fv(this.location,!1,i);break}}},S.aK=Vd,S.aL=qd,S.aM=X,S.aN=class extends Rs{constructor(i,t){super(i,t),this.current=[0,0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]&&i[2]===this.current[2]||(this.current=i,this.gl.uniform3f(this.location,i[0],i[1],i[2]))}},S.aO=class extends Rs{constructor(i,t){super(i,t),this.current=[0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]||(this.current=i,this.gl.uniform2f(this.location,i[0],i[1]))}},S.aP=function(i,t,r,o,c,f,m){var y=1/(t-r),b=1/(o-c),T=1/(f-m);return i[0]=-2*y,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*b,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*T,i[11]=0,i[12]=(t+r)*y,i[13]=(c+o)*b,i[14]=(m+f)*T,i[15]=1,i},S.aQ=o_,S.aR=class extends Y{},S.aS=K_,S.aT=class extends pe{},S.aU=wu,S.aV=function(i){return i<=1?1:Math.pow(2,Math.ceil(Math.log(i)/Math.LN2))},S.aW=np,S.aX=fr,S.aY=Nr,S.aZ=class extends Be{},S.a_=function(i,t){return i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2]&&i[3]===t[3]&&i[4]===t[4]&&i[5]===t[5]&&i[6]===t[6]&&i[7]===t[7]&&i[8]===t[8]&&i[9]===t[9]&&i[10]===t[10]&&i[11]===t[11]&&i[12]===t[12]&&i[13]===t[13]&&i[14]===t[14]&&i[15]===t[15]},S.aa=function(i){const t={};if(i.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(r,o,c,f)=>{const m=c||f;return t[o]=!m||m.toLowerCase(),""}),t["max-age"]){const r=parseInt(t["max-age"],10);isNaN(r)?delete t["max-age"]:t["max-age"]=r}return t},S.ab=function(i,t){const r=[];for(const o in i)o in t||r.push(o);return r},S.ac=Yt,S.ad=function(i,t,r){var o=Math.sin(r),c=Math.cos(r),f=t[0],m=t[1],y=t[2],b=t[3],T=t[4],E=t[5],P=t[6],z=t[7];return t!==i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i[0]=f*c+T*o,i[1]=m*c+E*o,i[2]=y*c+P*o,i[3]=b*c+z*o,i[4]=T*c-f*o,i[5]=E*c-m*o,i[6]=P*c-y*o,i[7]=z*c-b*o,i},S.ae=function(i){var t=new Aa(16);return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],t},S.af=ih,S.ag=function(i,t){let r=0,o=0;if(i.kind==="constant")o=i.layoutSize;else if(i.kind!=="source"){const{interpolationType:c,minZoom:f,maxZoom:m}=i,y=c?Yt(Ir.interpolationFactor(c,t,f,m),0,1):0;i.kind==="camera"?o=Sr.number(i.minSize,i.maxSize,y):r=y}return{uSizeT:r,uSize:o}},S.ai=function(i,{uSize:t,uSizeT:r},{lowerSize:o,upperSize:c}){return i.kind==="source"?o/Ys:i.kind==="composite"?Sr.number(o/Ys,c/Ys,r):t},S.aj=Bu,S.ak=function(i,t,r,o){const c=t.y-i.y,f=t.x-i.x,m=o.y-r.y,y=o.x-r.x,b=m*f-y*c;if(b===0)return null;const T=(y*(i.y-r.y)-m*(i.x-r.x))/b;return new J(i.x+T*f,i.y+T*c)},S.al=af,S.am=Wd,S.an=xu,S.ao=function(i){let t=1/0,r=1/0,o=-1/0,c=-1/0;for(const f of i)t=Math.min(t,f.x),r=Math.min(r,f.y),o=Math.max(o,f.x),c=Math.max(c,f.y);return[t,r,o,c]},S.ap=qi,S.ar=Fu,S.as=function(i,t){var r=t[0],o=t[1],c=t[2],f=t[3],m=t[4],y=t[5],b=t[6],T=t[7],E=t[8],P=t[9],z=t[10],R=t[11],F=t[12],$=t[13],Q=t[14],ie=t[15],_e=r*y-o*m,ce=r*b-c*m,me=r*T-f*m,Se=o*b-c*y,ze=o*T-f*y,We=c*T-f*b,ft=E*$-P*F,Ge=E*Q-z*F,Ve=E*ie-R*F,at=P*Q-z*$,it=P*ie-R*$,Ye=z*ie-R*Q,ke=_e*Ye-ce*it+me*at+Se*Ve-ze*Ge+We*ft;return ke?(i[0]=(y*Ye-b*it+T*at)*(ke=1/ke),i[1]=(c*it-o*Ye-f*at)*ke,i[2]=($*We-Q*ze+ie*Se)*ke,i[3]=(z*ze-P*We-R*Se)*ke,i[4]=(b*Ve-m*Ye-T*Ge)*ke,i[5]=(r*Ye-c*Ve+f*Ge)*ke,i[6]=(Q*me-F*We-ie*ce)*ke,i[7]=(E*We-z*me+R*ce)*ke,i[8]=(m*it-y*Ve+T*ft)*ke,i[9]=(o*Ve-r*it-f*ft)*ke,i[10]=(F*ze-$*me+ie*_e)*ke,i[11]=(P*me-E*ze-R*_e)*ke,i[12]=(y*Ge-m*at-b*ft)*ke,i[13]=(r*at-o*Ge+c*ft)*ke,i[14]=($*ce-F*Se-Q*_e)*ke,i[15]=(E*Se-P*ce+z*_e)*ke,i):null},S.at=Hu,S.au=Ou,S.av=Zu,S.aw=function(){const i={},t=be.$version;for(const r in be.$root){const o=be.$root[r];if(o.required){let c=null;c=r==="version"?t:o.type==="array"?[]:{},c!=null&&(i[r]=c)}}return i},S.ax=Il,S.ay=ki,S.az=function(i){i=i.slice();const t=Object.create(null);for(let r=0;r<i.length;r++)t[i[r].id]=i[r];for(let r=0;r<i.length;r++)"ref"in i[r]&&(i[r]=on(i[r],t[i[r].ref]));return i},S.b=oi,S.b0=function(i,t){return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i},S.b1=function(i,t,r){return i[0]=t[0]*r[0],i[1]=t[1]*r[1],i[2]=t[2]*r[2],i[3]=t[3]*r[3],i},S.b2=function(i,t){return i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+i[3]*t[3]},S.b3=Vt,S.b4=Qp,S.b5=Kp,S.b6=function(i,t,r,o,c){var f,m=1/Math.tan(t/2);return i[0]=m/r,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=m,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,c!=null&&c!==1/0?(i[10]=(c+o)*(f=1/(o-c)),i[14]=2*c*o*f):(i[10]=-1,i[14]=-2*o),i},S.b7=function(i,t,r){var o=Math.sin(r),c=Math.cos(r),f=t[4],m=t[5],y=t[6],b=t[7],T=t[8],E=t[9],P=t[10],z=t[11];return t!==i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]),i[4]=f*c+T*o,i[5]=m*c+E*o,i[6]=y*c+P*o,i[7]=b*c+z*o,i[8]=T*c-f*o,i[9]=E*c-m*o,i[10]=P*c-y*o,i[11]=z*c-b*o,i},S.b8=Ct,S.b9=Li,S.bA=Tp,S.bB=function(i){return i.message===Zi},S.bC=ha,S.bD=Sn,S.ba=function(i){return i*Math.PI/180},S.bb=function(i,t){const{x:r,y:o}=Gl.fromLngLat(t);return!(i<0||i>25||o<0||o>=1||r<0||r>=1)},S.bc=function(i,t){return i[0]=t[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=t[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},S.bd=class extends I{},S.be=Uu,S.bf=Dg,S.bh=wi,S.bi=function(i,t){Yr.REGISTERED_PROTOCOLS[i]=t},S.bj=function(i){delete Yr.REGISTERED_PROTOCOLS[i]},S.bk=function(i,t){const r={};for(let c=0;c<i.length;c++){const f=t&&t[i[c].id]||Io(i[c]);t&&(t[i[c].id]=f);let m=r[f];m||(m=r[f]=[]),m.push(i[c])}const o=[];for(const c in r)o.push(r[c]);return o},S.bl=Xe,S.bm=tf,S.bn=sf,S.bo=Lp,S.bp=function(i){i.bucket.createArrays(),i.bucket.tilePixelRatio=Ui/(512*i.bucket.overscaling),i.bucket.compareText={},i.bucket.iconsNeedLinear=!1;const t=i.bucket.layers[0],r=t.layout,o=t._unevaluatedLayout._values,c={layoutIconSize:o["icon-size"].possiblyEvaluate(new ti(i.bucket.zoom+1),i.canonical),layoutTextSize:o["text-size"].possiblyEvaluate(new ti(i.bucket.zoom+1),i.canonical),textMaxSize:o["text-size"].possiblyEvaluate(new ti(18))};if(i.bucket.textSizeData.kind==="composite"){const{minZoom:T,maxZoom:E}=i.bucket.textSizeData;c.compositeTextSizes=[o["text-size"].possiblyEvaluate(new ti(T),i.canonical),o["text-size"].possiblyEvaluate(new ti(E),i.canonical)]}if(i.bucket.iconSizeData.kind==="composite"){const{minZoom:T,maxZoom:E}=i.bucket.iconSizeData;c.compositeIconSizes=[o["icon-size"].possiblyEvaluate(new ti(T),i.canonical),o["icon-size"].possiblyEvaluate(new ti(E),i.canonical)]}const f=r.get("text-line-height")*qi,m=r.get("text-rotation-alignment")!=="viewport"&&r.get("symbol-placement")!=="point",y=r.get("text-keep-upright"),b=r.get("text-size");for(const T of i.bucket.features){const E=r.get("text-font").evaluate(T,{},i.canonical).join(","),P=b.evaluate(T,{},i.canonical),z=c.layoutTextSize.evaluate(T,{},i.canonical),R=c.layoutIconSize.evaluate(T,{},i.canonical),F={horizontal:{},vertical:void 0},$=T.text;let Q,ie=[0,0];if($){const me=$.toString(),Se=r.get("text-letter-spacing").evaluate(T,{},i.canonical)*qi,ze=lu(me)?Se:0,We=r.get("text-anchor").evaluate(T,{},i.canonical),ft=_f(t,T,i.canonical);if(!ft){const it=r.get("text-radial-offset").evaluate(T,{},i.canonical);ie=it?mf(We,[it*qi,Gu]):r.get("text-offset").evaluate(T,{},i.canonical).map(Ye=>Ye*qi)}let Ge=m?"center":r.get("text-justify").evaluate(T,{},i.canonical);const Ve=r.get("symbol-placement")==="point"?r.get("text-max-width").evaluate(T,{},i.canonical)*qi:1/0,at=()=>{i.bucket.allowVerticalPlacement&&Tl(me)&&(F.vertical=lh($,i.glyphMap,i.glyphPositions,i.imagePositions,E,Ve,f,We,"left",ze,ie,S.ah.vertical,!0,z,P))};if(!m&&ft){const it=new Set;if(Ge==="auto")for(let ke=0;ke<ft.values.length;ke+=2)it.add(Hu(ft.values[ke]));else it.add(Ge);let Ye=!1;for(const ke of it)if(!F.horizontal[ke])if(Ye)F.horizontal[ke]=F.horizontal[0];else{const ct=lh($,i.glyphMap,i.glyphPositions,i.imagePositions,E,Ve,f,"center",ke,ze,ie,S.ah.horizontal,!1,z,P);ct&&(F.horizontal[ke]=ct,Ye=ct.positionedLines.length===1)}at()}else{Ge==="auto"&&(Ge=Hu(We));const it=lh($,i.glyphMap,i.glyphPositions,i.imagePositions,E,Ve,f,We,Ge,ze,ie,S.ah.horizontal,!1,z,P);it&&(F.horizontal[Ge]=it),at(),Tl(me)&&m&&y&&(F.vertical=lh($,i.glyphMap,i.glyphPositions,i.imagePositions,E,Ve,f,We,Ge,ze,ie,S.ah.vertical,!1,z,P))}}let _e=!1;if(T.icon&&T.icon.name){const me=i.imageMap[T.icon.name];me&&(Q=mg(i.imagePositions[T.icon.name],r.get("icon-offset").evaluate(T,{},i.canonical),r.get("icon-anchor").evaluate(T,{},i.canonical)),_e=!!me.sdf,i.bucket.sdfIcons===void 0?i.bucket.sdfIcons=_e:i.bucket.sdfIcons!==_e&&pi("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(me.pixelRatio!==i.bucket.pixelRatio||r.get("icon-rotate").constantOr(1)!==0)&&(i.bucket.iconsNeedLinear=!0))}const ce=yf(F.horizontal)||F.vertical;i.bucket.iconsInText=!!ce&&ce.iconsInText,(ce||Q)&&Mg(i.bucket,T,F,Q,i.imageMap,c,z,R,ie,_e,i.canonical)}i.showCollisionBoxes&&i.bucket.generateCollisionDebugBuffers()},S.bq=Cu,S.br=Eu,S.bs=Pu,S.bt=Jn,S.bu=zu,S.bv=class{constructor(i){this._marks={start:[i.url,"start"].join("#"),end:[i.url,"end"].join("#"),measure:i.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let i=performance.getEntriesByName(this._marks.measure);return i.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),i=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),i}},S.bw=function(i,t,r,o,c){return h(this,void 0,void 0,function*(){if(xt())try{return yield Ni(i,t,r,o,c)}catch{}return function(f,m,y,b,T){const E=f.width,P=f.height;si&&gi||(si=new OffscreenCanvas(E,P),gi=si.getContext("2d",{willReadFrequently:!0})),si.width=E,si.height=P,gi.drawImage(f,0,0,E,P);const z=gi.getImageData(m,y,b,T);return gi.clearRect(0,0,E,P),z.data}(i,t,r,o,c)})},S.bx=ef,S.by=N,S.bz=q,S.c=Dr,S.d=i=>h(void 0,void 0,void 0,function*(){if(i.byteLength===0)return createImageBitmap(new ImageData(1,1));const t=new Blob([new Uint8Array(i)],{type:"image/png"});try{return createImageBitmap(t)}catch(r){throw new Error(`Could not load image because of ${r.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}),S.e=yt,S.f=i=>new Promise((t,r)=>{const o=new Image;o.onload=()=>{t(o),URL.revokeObjectURL(o.src),o.onload=null,window.requestAnimationFrame(()=>{o.src=ws})},o.onerror=()=>r(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const c=new Blob([new Uint8Array(i)],{type:"image/png"});o.src=i.byteLength?URL.createObjectURL(c):ws}),S.g=Lr,S.h=(i,t)=>Mt(yt(i,{type:"json"}),t),S.i=Ut,S.j=Or,S.k=Rr,S.l=(i,t)=>Mt(yt(i,{type:"arrayBuffer"}),t),S.m=Mt,S.n=function(i){return new zu(i).readFields(lg,[])},S.o=Rl,S.p=Dp,S.q=kr,S.r=Uc,S.s=$i,S.t=Sl,S.u=bn,S.v=be,S.w=pi,S.x=function([i,t,r]){return t+=90,t*=Math.PI/180,r*=Math.PI/180,{x:i*Math.cos(t)*Math.sin(r),y:i*Math.sin(t)*Math.sin(r),z:i*Math.cos(r)}},S.y=Sr,S.z=ti}),x("worker",["./shared"],function(S){class h{constructor(D){this.keyCache={},D&&this.replace(D)}replace(D){this._layerConfigs={},this._layers={},this.update(D,[])}update(D,L){for(const K of D){this._layerConfigs[K.id]=K;const le=this._layers[K.id]=S.aA(K);le._featureFilter=S.a7(le.filter),this.keyCache[K.id]&&delete this.keyCache[K.id]}for(const K of L)delete this.keyCache[K],delete this._layerConfigs[K],delete this._layers[K];this.familiesBySource={};const j=S.bk(Object.values(this._layerConfigs),this.keyCache);for(const K of j){const le=K.map(xe=>this._layers[xe.id]),he=le[0];if(he.visibility==="none")continue;const fe=he.source||"";let oe=this.familiesBySource[fe];oe||(oe=this.familiesBySource[fe]={});const we=he.sourceLayer||"_geojsonTileLayer";let Pe=oe[we];Pe||(Pe=oe[we]=[]),Pe.push(le)}}}class N{constructor(D){const L={},j=[];for(const fe in D){const oe=D[fe],we=L[fe]={};for(const Pe in oe){const xe=oe[+Pe];if(!xe||xe.bitmap.width===0||xe.bitmap.height===0)continue;const Fe={x:0,y:0,w:xe.bitmap.width+2,h:xe.bitmap.height+2};j.push(Fe),we[Pe]={rect:Fe,metrics:xe.metrics}}}const{w:K,h:le}=S.p(j),he=new S.o({width:K||1,height:le||1});for(const fe in D){const oe=D[fe];for(const we in oe){const Pe=oe[+we];if(!Pe||Pe.bitmap.width===0||Pe.bitmap.height===0)continue;const xe=L[fe][we].rect;S.o.copy(Pe.bitmap,he,{x:0,y:0},{x:xe.x+1,y:xe.y+1},Pe.bitmap)}}this.image=he,this.positions=L}}S.bl("GlyphAtlas",N);class q{constructor(D){this.tileID=new S.S(D.tileID.overscaledZ,D.tileID.wrap,D.tileID.canonical.z,D.tileID.canonical.x,D.tileID.canonical.y),this.uid=D.uid,this.zoom=D.zoom,this.pixelRatio=D.pixelRatio,this.tileSize=D.tileSize,this.source=D.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=D.showCollisionBoxes,this.collectResourceTiming=!!D.collectResourceTiming,this.returnDependencies=!!D.returnDependencies,this.promoteId=D.promoteId,this.inFlightDependencies=[]}parse(D,L,j,K){return S._(this,void 0,void 0,function*(){this.status="parsing",this.data=D,this.collisionBoxArray=new S.a5;const le=new S.bm(Object.keys(D.layers).sort()),he=new S.bn(this.tileID,this.promoteId);he.bucketLayerIDs=[];const fe={},oe={featureIndex:he,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:j},we=L.familiesBySource[this.source];for(const At in we){const Xt=D.layers[At];if(!Xt)continue;Xt.version===1&&S.w(`Vector tile source "${this.source}" layer "${At}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const jt=le.encode(At),Ri=[];for(let B=0;B<Xt.length;B++){const W=Xt.feature(B),Z=he.getId(W,At);Ri.push({feature:W,id:Z,index:B,sourceLayerIndex:jt})}for(const B of we[At]){const W=B[0];W.source!==this.source&&S.w(`layer.source = ${W.source} does not equal this.source = ${this.source}`),W.minzoom&&this.zoom<Math.floor(W.minzoom)||W.maxzoom&&this.zoom>=W.maxzoom||W.visibility!=="none"&&(ne(B,this.zoom,j),(fe[W.id]=W.createBucket({index:he.bucketLayerIDs.length,layers:B,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:jt,sourceID:this.source})).populate(Ri,oe,this.tileID.canonical),he.bucketLayerIDs.push(B.map(Z=>Z.id)))}}const Pe=S.aF(oe.glyphDependencies,At=>Object.keys(At).map(Number));this.inFlightDependencies.forEach(At=>At==null?void 0:At.abort()),this.inFlightDependencies=[];let xe=Promise.resolve({});if(Object.keys(Pe).length){const At=new AbortController;this.inFlightDependencies.push(At),xe=K.sendAsync({type:"GG",data:{stacks:Pe,source:this.source,tileID:this.tileID,type:"glyphs"}},At)}const Fe=Object.keys(oe.iconDependencies);let ot=Promise.resolve({});if(Fe.length){const At=new AbortController;this.inFlightDependencies.push(At),ot=K.sendAsync({type:"GI",data:{icons:Fe,source:this.source,tileID:this.tileID,type:"icons"}},At)}const ut=Object.keys(oe.patternDependencies);let qt=Promise.resolve({});if(ut.length){const At=new AbortController;this.inFlightDependencies.push(At),qt=K.sendAsync({type:"GI",data:{icons:ut,source:this.source,tileID:this.tileID,type:"patterns"}},At)}const[gt,zt,Et]=yield Promise.all([xe,ot,qt]),Ii=new N(gt),fi=new S.bo(zt,Et);for(const At in fe){const Xt=fe[At];Xt instanceof S.a6?(ne(Xt.layers,this.zoom,j),S.bp({bucket:Xt,glyphMap:gt,glyphPositions:Ii.positions,imageMap:zt,imagePositions:fi.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical})):Xt.hasPattern&&(Xt instanceof S.bq||Xt instanceof S.br||Xt instanceof S.bs)&&(ne(Xt.layers,this.zoom,j),Xt.addFeatures(oe,this.tileID.canonical,fi.patternPositions))}return this.status="done",{buckets:Object.values(fe).filter(At=>!At.isEmpty()),featureIndex:he,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Ii.image,imageAtlas:fi,glyphMap:this.returnDependencies?gt:null,iconMap:this.returnDependencies?zt:null,glyphPositions:this.returnDependencies?Ii.positions:null}})}}function ne(te,D,L){const j=new S.z(D);for(const K of te)K.recalculate(j,L)}class J{constructor(D,L,j){this.actor=D,this.layerIndex=L,this.availableImages=j,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(D,L){return S._(this,void 0,void 0,function*(){const j=yield S.l(D.request,L);try{return{vectorTile:new S.bt.VectorTile(new S.bu(j.data)),rawData:j.data,cacheControl:j.cacheControl,expires:j.expires}}catch(K){const le=new Uint8Array(j.data);let he=`Unable to parse the tile at ${D.request.url}, `;throw he+=le[0]===31&&le[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${K.message}`,new Error(he)}})}loadTile(D){return S._(this,void 0,void 0,function*(){const L=D.uid,j=!!(D&&D.request&&D.request.collectResourceTiming)&&new S.bv(D.request),K=new q(D);this.loading[L]=K;const le=new AbortController;K.abort=le;try{const he=yield this.loadVectorTile(D,le);if(delete this.loading[L],!he)return null;const fe=he.rawData,oe={};he.expires&&(oe.expires=he.expires),he.cacheControl&&(oe.cacheControl=he.cacheControl);const we={};if(j){const xe=j.finish();xe&&(we.resourceTiming=JSON.parse(JSON.stringify(xe)))}K.vectorTile=he.vectorTile;const Pe=K.parse(he.vectorTile,this.layerIndex,this.availableImages,this.actor);this.loaded[L]=K,this.fetching[L]={rawTileData:fe,cacheControl:oe,resourceTiming:we};try{const xe=yield Pe;return S.e({rawTileData:fe.slice(0)},xe,oe,we)}finally{delete this.fetching[L]}}catch(he){throw delete this.loading[L],K.status="done",this.loaded[L]=K,he}})}reloadTile(D){return S._(this,void 0,void 0,function*(){const L=D.uid;if(!this.loaded||!this.loaded[L])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const j=this.loaded[L];if(j.showCollisionBoxes=D.showCollisionBoxes,j.status==="parsing"){const K=yield j.parse(j.vectorTile,this.layerIndex,this.availableImages,this.actor);let le;if(this.fetching[L]){const{rawTileData:he,cacheControl:fe,resourceTiming:oe}=this.fetching[L];delete this.fetching[L],le=S.e({rawTileData:he.slice(0)},K,fe,oe)}else le=K;return le}if(j.status==="done"&&j.vectorTile)return j.parse(j.vectorTile,this.layerIndex,this.availableImages,this.actor)})}abortTile(D){return S._(this,void 0,void 0,function*(){const L=this.loading,j=D.uid;L&&L[j]&&L[j].abort&&(L[j].abort.abort(),delete L[j])})}removeTile(D){return S._(this,void 0,void 0,function*(){this.loaded&&this.loaded[D.uid]&&delete this.loaded[D.uid]})}}class G{constructor(){this.loaded={}}loadTile(D){return S._(this,void 0,void 0,function*(){const{uid:L,encoding:j,rawImageData:K,redFactor:le,greenFactor:he,blueFactor:fe,baseShift:oe}=D,we=K.width+2,Pe=K.height+2,xe=S.b(K)?new S.R({width:we,height:Pe},yield S.bw(K,-1,-1,we,Pe)):K,Fe=new S.bx(L,xe,j,le,he,fe,oe);return this.loaded=this.loaded||{},this.loaded[L]=Fe,Fe})}removeTile(D){const L=this.loaded,j=D.uid;L&&L[j]&&delete L[j]}}function ve(te,D){if(te.length!==0){Ee(te[0],D);for(var L=1;L<te.length;L++)Ee(te[L],!D)}}function Ee(te,D){for(var L=0,j=0,K=0,le=te.length,he=le-1;K<le;he=K++){var fe=(te[K][0]-te[he][0])*(te[he][1]+te[K][1]),oe=L+fe;j+=Math.abs(L)>=Math.abs(fe)?L-oe+fe:fe-oe+L,L=oe}L+j>=0!=!!D&&te.reverse()}var $e=S.by(function te(D,L){var j,K=D&&D.type;if(K==="FeatureCollection")for(j=0;j<D.features.length;j++)te(D.features[j],L);else if(K==="GeometryCollection")for(j=0;j<D.geometries.length;j++)te(D.geometries[j],L);else if(K==="Feature")te(D.geometry,L);else if(K==="Polygon")ve(D.coordinates,L);else if(K==="MultiPolygon")for(j=0;j<D.coordinates.length;j++)ve(D.coordinates[j],L);return D});const _t=S.bt.VectorTileFeature.prototype.toGeoJSON;var Tt={exports:{}},xt=S.bz,Ct=S.bt.VectorTileFeature,Li=Yt;function Yt(te,D){this.options=D||{},this.features=te,this.length=te.length}function Vt(te,D){this.id=typeof te.id=="number"?te.id:void 0,this.type=te.type,this.rawGeometry=te.type===1?[te.geometry]:te.geometry,this.properties=te.tags,this.extent=D||4096}Yt.prototype.feature=function(te){return new Vt(this.features[te],this.options.extent)},Vt.prototype.loadGeometry=function(){var te=this.rawGeometry;this.geometry=[];for(var D=0;D<te.length;D++){for(var L=te[D],j=[],K=0;K<L.length;K++)j.push(new xt(L[K][0],L[K][1]));this.geometry.push(j)}return this.geometry},Vt.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var te=this.geometry,D=1/0,L=-1/0,j=1/0,K=-1/0,le=0;le<te.length;le++)for(var he=te[le],fe=0;fe<he.length;fe++){var oe=he[fe];D=Math.min(D,oe.x),L=Math.max(L,oe.x),j=Math.min(j,oe.y),K=Math.max(K,oe.y)}return[D,j,L,K]},Vt.prototype.toGeoJSON=Ct.prototype.toGeoJSON;var yt=S.bA,ri=Li;function Bt(te){var D=new yt;return function(L,j){for(var K in L.layers)j.writeMessage(3,ji,L.layers[K])}(te,D),D.finish()}function ji(te,D){var L;D.writeVarintField(15,te.version||1),D.writeStringField(1,te.name||""),D.writeVarintField(5,te.extent||4096);var j={keys:[],values:[],keycache:{},valuecache:{}};for(L=0;L<te.length;L++)j.feature=te.feature(L),D.writeMessage(2,Lt,j);var K=j.keys;for(L=0;L<K.length;L++)D.writeStringField(3,K[L]);var le=j.values;for(L=0;L<le.length;L++)D.writeMessage(4,ni,le[L])}function Lt(te,D){var L=te.feature;L.id!==void 0&&D.writeVarintField(1,L.id),D.writeMessage(2,kt,te),D.writeVarintField(3,L.type),D.writeMessage(4,Ut,L)}function kt(te,D){var L=te.feature,j=te.keys,K=te.values,le=te.keycache,he=te.valuecache;for(var fe in L.properties){var oe=L.properties[fe],we=le[fe];if(oe!==null){we===void 0&&(j.push(fe),le[fe]=we=j.length-1),D.writeVarint(we);var Pe=typeof oe;Pe!=="string"&&Pe!=="boolean"&&Pe!=="number"&&(oe=JSON.stringify(oe));var xe=Pe+":"+oe,Fe=he[xe];Fe===void 0&&(K.push(oe),he[xe]=Fe=K.length-1),D.writeVarint(Fe)}}}function pi(te,D){return(D<<3)+(7&te)}function De(te){return te<<1^te>>31}function Ut(te,D){for(var L=te.loadGeometry(),j=te.type,K=0,le=0,he=L.length,fe=0;fe<he;fe++){var oe=L[fe],we=1;j===1&&(we=oe.length),D.writeVarint(pi(1,we));for(var Pe=j===3?oe.length-1:oe.length,xe=0;xe<Pe;xe++){xe===1&&j!==1&&D.writeVarint(pi(2,Pe-1));var Fe=oe[xe].x-K,ot=oe[xe].y-le;D.writeVarint(De(Fe)),D.writeVarint(De(ot)),K+=Fe,le+=ot}j===3&&D.writeVarint(pi(7,1))}}function ni(te,D){var L=typeof te;L==="string"?D.writeStringField(1,te):L==="boolean"?D.writeBooleanField(7,te):L==="number"&&(te%1!=0?D.writeDoubleField(3,te):te<0?D.writeSVarintField(6,te):D.writeVarintField(5,te))}Tt.exports=Bt,Tt.exports.fromVectorTileJs=Bt,Tt.exports.fromGeojsonVt=function(te,D){D=D||{};var L={};for(var j in te)L[j]=new ri(te[j].features,D),L[j].name=j,L[j].version=D.version,L[j].extent=D.extent;return Bt({layers:L})},Tt.exports.GeoJSONWrapper=ri;var oi=S.by(Tt.exports);const ws={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:te=>te},Ni=Math.fround||(si=new Float32Array(1),te=>(si[0]=+te,si[0]));var si;const gi=3,Zi=5,Dr=6;class Yr{constructor(D){this.options=Object.assign(Object.create(ws),D),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(D){const{log:L,minZoom:j,maxZoom:K}=this.options;L&&console.time("total time");const le=`prepare ${D.length} points`;L&&console.time(le),this.points=D;const he=[];for(let oe=0;oe<D.length;oe++){const we=D[oe];if(!we.geometry)continue;const[Pe,xe]=we.geometry.coordinates,Fe=Ni(wi(Pe)),ot=Ni(ki(xe));he.push(Fe,ot,1/0,oe,-1,1),this.options.reduce&&he.push(0)}let fe=this.trees[K+1]=this._createTree(he);L&&console.timeEnd(le);for(let oe=K;oe>=j;oe--){const we=+Date.now();fe=this.trees[oe]=this._createTree(this._cluster(fe,oe)),L&&console.log("z%d: %d clusters in %dms",oe,fe.numItems,+Date.now()-we)}return L&&console.timeEnd("total time"),this}getClusters(D,L){let j=((D[0]+180)%360+360)%360-180;const K=Math.max(-90,Math.min(90,D[1]));let le=D[2]===180?180:((D[2]+180)%360+360)%360-180;const he=Math.max(-90,Math.min(90,D[3]));if(D[2]-D[0]>=360)j=-180,le=180;else if(j>le){const xe=this.getClusters([j,K,180,he],L),Fe=this.getClusters([-180,K,le,he],L);return xe.concat(Fe)}const fe=this.trees[this._limitZoom(L)],oe=fe.range(wi(j),ki(he),wi(le),ki(K)),we=fe.data,Pe=[];for(const xe of oe){const Fe=this.stride*xe;Pe.push(we[Fe+Zi]>1?Lr(we,Fe,this.clusterProps):this.points[we[Fe+gi]])}return Pe}getChildren(D){const L=this._getOriginId(D),j=this._getOriginZoom(D),K="No cluster with the specified id.",le=this.trees[j];if(!le)throw new Error(K);const he=le.data;if(L*this.stride>=he.length)throw new Error(K);const fe=this.options.radius/(this.options.extent*Math.pow(2,j-1)),oe=le.within(he[L*this.stride],he[L*this.stride+1],fe),we=[];for(const Pe of oe){const xe=Pe*this.stride;he[xe+4]===D&&we.push(he[xe+Zi]>1?Lr(he,xe,this.clusterProps):this.points[he[xe+gi]])}if(we.length===0)throw new Error(K);return we}getLeaves(D,L,j){const K=[];return this._appendLeaves(K,D,L=L||10,j=j||0,0),K}getTile(D,L,j){const K=this.trees[this._limitZoom(D)],le=Math.pow(2,D),{extent:he,radius:fe}=this.options,oe=fe/he,we=(j-oe)/le,Pe=(j+1+oe)/le,xe={features:[]};return this._addTileFeatures(K.range((L-oe)/le,we,(L+1+oe)/le,Pe),K.data,L,j,le,xe),L===0&&this._addTileFeatures(K.range(1-oe/le,we,1,Pe),K.data,le,j,le,xe),L===le-1&&this._addTileFeatures(K.range(0,we,oe/le,Pe),K.data,-1,j,le,xe),xe.features.length?xe:null}getClusterExpansionZoom(D){let L=this._getOriginZoom(D)-1;for(;L<=this.options.maxZoom;){const j=this.getChildren(D);if(L++,j.length!==1)break;D=j[0].properties.cluster_id}return L}_appendLeaves(D,L,j,K,le){const he=this.getChildren(L);for(const fe of he){const oe=fe.properties;if(oe&&oe.cluster?le+oe.point_count<=K?le+=oe.point_count:le=this._appendLeaves(D,oe.cluster_id,j,K,le):le<K?le++:D.push(fe),D.length===j)break}return le}_createTree(D){const L=new S.av(D.length/this.stride|0,this.options.nodeSize,Float32Array);for(let j=0;j<D.length;j+=this.stride)L.add(D[j],D[j+1]);return L.finish(),L.data=D,L}_addTileFeatures(D,L,j,K,le,he){for(const fe of D){const oe=fe*this.stride,we=L[oe+Zi]>1;let Pe,xe,Fe;if(we)Pe=Ss(L,oe,this.clusterProps),xe=L[oe],Fe=L[oe+1];else{const qt=this.points[L[oe+gi]];Pe=qt.properties;const[gt,zt]=qt.geometry.coordinates;xe=wi(gt),Fe=ki(zt)}const ot={type:1,geometry:[[Math.round(this.options.extent*(xe*le-j)),Math.round(this.options.extent*(Fe*le-K))]],tags:Pe};let ut;ut=we||this.options.generateId?L[oe+gi]:this.points[L[oe+gi]].id,ut!==void 0&&(ot.id=ut),he.features.push(ot)}}_limitZoom(D){return Math.max(this.options.minZoom,Math.min(Math.floor(+D),this.options.maxZoom+1))}_cluster(D,L){const{radius:j,extent:K,reduce:le,minPoints:he}=this.options,fe=j/(K*Math.pow(2,L)),oe=D.data,we=[],Pe=this.stride;for(let xe=0;xe<oe.length;xe+=Pe){if(oe[xe+2]<=L)continue;oe[xe+2]=L;const Fe=oe[xe],ot=oe[xe+1],ut=D.within(oe[xe],oe[xe+1],fe),qt=oe[xe+Zi];let gt=qt;for(const zt of ut){const Et=zt*Pe;oe[Et+2]>L&&(gt+=oe[Et+Zi])}if(gt>qt&&gt>=he){let zt,Et=Fe*qt,Ii=ot*qt,fi=-1;const At=((xe/Pe|0)<<5)+(L+1)+this.points.length;for(const Xt of ut){const jt=Xt*Pe;if(oe[jt+2]<=L)continue;oe[jt+2]=L;const Ri=oe[jt+Zi];Et+=oe[jt]*Ri,Ii+=oe[jt+1]*Ri,oe[jt+4]=At,le&&(zt||(zt=this._map(oe,xe,!0),fi=this.clusterProps.length,this.clusterProps.push(zt)),le(zt,this._map(oe,jt)))}oe[xe+4]=At,we.push(Et/gt,Ii/gt,1/0,At,-1,gt),le&&we.push(fi)}else{for(let zt=0;zt<Pe;zt++)we.push(oe[xe+zt]);if(gt>1)for(const zt of ut){const Et=zt*Pe;if(!(oe[Et+2]<=L)){oe[Et+2]=L;for(let Ii=0;Ii<Pe;Ii++)we.push(oe[Et+Ii])}}}}return we}_getOriginId(D){return D-this.points.length>>5}_getOriginZoom(D){return(D-this.points.length)%32}_map(D,L,j){if(D[L+Zi]>1){const he=this.clusterProps[D[L+Dr]];return j?Object.assign({},he):he}const K=this.points[D[L+gi]].properties,le=this.options.map(K);return j&&le===K?Object.assign({},le):le}}function Lr(te,D,L){return{type:"Feature",id:te[D+gi],properties:Ss(te,D,L),geometry:{type:"Point",coordinates:[(j=te[D],360*(j-.5)),Mt(te[D+1])]}};var j}function Ss(te,D,L){const j=te[D+Zi],K=j>=1e4?`${Math.round(j/1e3)}k`:j>=1e3?Math.round(j/100)/10+"k":j,le=te[D+Dr],he=le===-1?{}:Object.assign({},L[le]);return Object.assign(he,{cluster:!0,cluster_id:te[D+gi],point_count:j,point_count_abbreviated:K})}function wi(te){return te/360+.5}function ki(te){const D=Math.sin(te*Math.PI/180),L=.5-.25*Math.log((1+D)/(1-D))/Math.PI;return L<0?0:L>1?1:L}function Mt(te){const D=(180-360*te)*Math.PI/180;return 360*Math.atan(Math.exp(D))/Math.PI-90}function $i(te,D,L,j){let K=j;const le=D+(L-D>>1);let he,fe=L-D;const oe=te[D],we=te[D+1],Pe=te[L],xe=te[L+1];for(let Fe=D+3;Fe<L;Fe+=3){const ot=Gs(te[Fe],te[Fe+1],oe,we,Pe,xe);if(ot>K)he=Fe,K=ot;else if(ot===K){const ut=Math.abs(Fe-le);ut<fe&&(he=Fe,fe=ut)}}K>j&&(he-D>3&&$i(te,D,he,j),te[he+2]=K,L-he>3&&$i(te,he,L,j))}function Gs(te,D,L,j,K,le){let he=K-L,fe=le-j;if(he!==0||fe!==0){const oe=((te-L)*he+(D-j)*fe)/(he*he+fe*fe);oe>1?(L=K,j=le):oe>0&&(L+=he*oe,j+=fe*oe)}return he=te-L,fe=D-j,he*he+fe*fe}function Hr(te,D,L,j){const K={id:te??null,type:D,geometry:L,tags:j,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(D==="Point"||D==="MultiPoint"||D==="LineString")Rr(K,L);else if(D==="Polygon")Rr(K,L[0]);else if(D==="MultiLineString")for(const le of L)Rr(K,le);else if(D==="MultiPolygon")for(const le of L)Rr(K,le[0]);return K}function Rr(te,D){for(let L=0;L<D.length;L+=3)te.minX=Math.min(te.minX,D[L]),te.minY=Math.min(te.minY,D[L+1]),te.maxX=Math.max(te.maxX,D[L]),te.maxY=Math.max(te.maxY,D[L+1])}function Or(te,D,L,j){if(!D.geometry)return;const K=D.geometry.coordinates;if(K&&K.length===0)return;const le=D.geometry.type,he=Math.pow(L.tolerance/((1<<L.maxZoom)*L.extent),2);let fe=[],oe=D.id;if(L.promoteId?oe=D.properties[L.promoteId]:L.generateId&&(oe=j||0),le==="Point")zs(K,fe);else if(le==="MultiPoint")for(const we of K)zs(we,fe);else if(le==="LineString")be(K,fe,he,!1);else if(le==="MultiLineString"){if(L.lineMetrics){for(const we of K)fe=[],be(we,fe,he,!1),te.push(Hr(oe,"LineString",fe,D.properties));return}Is(K,fe,he,!1)}else if(le==="Polygon")Is(K,fe,he,!0);else{if(le!=="MultiPolygon"){if(le==="GeometryCollection"){for(const we of D.geometry.geometries)Or(te,{id:oe,geometry:we,properties:D.properties},L,j);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const we of K){const Pe=[];Is(we,Pe,he,!0),fe.push(Pe)}}te.push(Hr(oe,le,fe,D.properties))}function zs(te,D){D.push(on(te[0]),Gt(te[1]),0)}function be(te,D,L,j){let K,le,he=0;for(let oe=0;oe<te.length;oe++){const we=on(te[oe][0]),Pe=Gt(te[oe][1]);D.push(we,Pe,0),oe>0&&(he+=j?(K*Pe-we*le)/2:Math.sqrt(Math.pow(we-K,2)+Math.pow(Pe-le,2))),K=we,le=Pe}const fe=D.length-3;D[2]=1,$i(D,0,fe,L),D[fe+2]=1,D.size=Math.abs(he),D.start=0,D.end=D.size}function Is(te,D,L,j){for(let K=0;K<te.length;K++){const le=[];be(te[K],le,L,j),D.push(le)}}function on(te){return te/360+.5}function Gt(te){const D=Math.sin(te*Math.PI/180),L=.5-.25*Math.log((1+D)/(1-D))/Math.PI;return L<0?0:L>1?1:L}function Si(te,D,L,j,K,le,he,fe){if(j/=D,le>=(L/=D)&&he<j)return te;if(he<L||le>=j)return null;const oe=[];for(const we of te){const Pe=we.geometry;let xe=we.type;const Fe=K===0?we.minX:we.minY,ot=K===0?we.maxX:we.maxY;if(Fe>=L&&ot<j){oe.push(we);continue}if(ot<L||Fe>=j)continue;let ut=[];if(xe==="Point"||xe==="MultiPoint")Qr(Pe,ut,L,j,K);else if(xe==="LineString")es(Pe,ut,L,j,K,!1,fe.lineMetrics);else if(xe==="MultiLineString")Ki(Pe,ut,L,j,K,!1);else if(xe==="Polygon")Ki(Pe,ut,L,j,K,!0);else if(xe==="MultiPolygon")for(const qt of Pe){const gt=[];Ki(qt,gt,L,j,K,!0),gt.length&&ut.push(gt)}if(ut.length){if(fe.lineMetrics&&xe==="LineString"){for(const qt of ut)oe.push(Hr(we.id,xe,qt,we.tags));continue}xe!=="LineString"&&xe!=="MultiLineString"||(ut.length===1?(xe="LineString",ut=ut[0]):xe="MultiLineString"),xe!=="Point"&&xe!=="MultiPoint"||(xe=ut.length===3?"Point":"MultiPoint"),oe.push(Hr(we.id,xe,ut,we.tags))}}return oe.length?oe:null}function Qr(te,D,L,j,K){for(let le=0;le<te.length;le+=3){const he=te[le+K];he>=L&&he<=j&&br(D,te[le],te[le+1],te[le+2])}}function es(te,D,L,j,K,le,he){let fe=vr(te);const oe=K===0?an:ln;let we,Pe,xe=te.start;for(let gt=0;gt<te.length-3;gt+=3){const zt=te[gt],Et=te[gt+1],Ii=te[gt+2],fi=te[gt+3],At=te[gt+4],Xt=K===0?zt:Et,jt=K===0?fi:At;let Ri=!1;he&&(we=Math.sqrt(Math.pow(zt-fi,2)+Math.pow(Et-At,2))),Xt<L?jt>L&&(Pe=oe(fe,zt,Et,fi,At,L),he&&(fe.start=xe+we*Pe)):Xt>j?jt<j&&(Pe=oe(fe,zt,Et,fi,At,j),he&&(fe.start=xe+we*Pe)):br(fe,zt,Et,Ii),jt<L&&Xt>=L&&(Pe=oe(fe,zt,Et,fi,At,L),Ri=!0),jt>j&&Xt<=j&&(Pe=oe(fe,zt,Et,fi,At,j),Ri=!0),!le&&Ri&&(he&&(fe.end=xe+we*Pe),D.push(fe),fe=vr(te)),he&&(xe+=we)}let Fe=te.length-3;const ot=te[Fe],ut=te[Fe+1],qt=K===0?ot:ut;qt>=L&&qt<=j&&br(fe,ot,ut,te[Fe+2]),Fe=fe.length-3,le&&Fe>=3&&(fe[Fe]!==fe[0]||fe[Fe+1]!==fe[1])&&br(fe,fe[0],fe[1],fe[2]),fe.length&&D.push(fe)}function vr(te){const D=[];return D.size=te.size,D.start=te.start,D.end=te.end,D}function Ki(te,D,L,j,K,le){for(const he of te)es(he,D,L,j,K,le,!1)}function br(te,D,L,j){te.push(D,L,j)}function an(te,D,L,j,K,le){const he=(le-D)/(j-D);return br(te,le,L+(K-L)*he,1),he}function ln(te,D,L,j,K,le){const he=(le-L)/(K-L);return br(te,D+(j-D)*he,le,1),he}function Oe(te,D){const L=[];for(let j=0;j<te.length;j++){const K=te[j],le=K.type;let he;if(le==="Point"||le==="MultiPoint"||le==="LineString")he=Zr(K.geometry,D);else if(le==="MultiLineString"||le==="Polygon"){he=[];for(const fe of K.geometry)he.push(Zr(fe,D))}else if(le==="MultiPolygon"){he=[];for(const fe of K.geometry){const oe=[];for(const we of fe)oe.push(Zr(we,D));he.push(oe)}}L.push(Hr(K.id,le,he,K.tags))}return L}function Zr(te,D){const L=[];L.size=te.size,te.start!==void 0&&(L.start=te.start,L.end=te.end);for(let j=0;j<te.length;j+=3)L.push(te[j]+D,te[j+1],te[j+2]);return L}function Yi(te,D){if(te.transformed)return te;const L=1<<te.z,j=te.x,K=te.y;for(const le of te.features){const he=le.geometry,fe=le.type;if(le.geometry=[],fe===1)for(let oe=0;oe<he.length;oe+=2)le.geometry.push(Wr(he[oe],he[oe+1],D,L,j,K));else for(let oe=0;oe<he.length;oe++){const we=[];for(let Pe=0;Pe<he[oe].length;Pe+=2)we.push(Wr(he[oe][Pe],he[oe][Pe+1],D,L,j,K));le.geometry.push(we)}}return te.transformed=!0,te}function Wr(te,D,L,j,K,le){return[Math.round(L*(te*j-K)),Math.round(L*(D*j-le))]}function ts(te,D,L,j,K){const le=D===K.maxZoom?0:K.tolerance/((1<<D)*K.extent),he={features:[],numPoints:0,numSimplified:0,numFeatures:te.length,source:null,x:L,y:j,z:D,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const fe of te)je(he,fe,le,K);return he}function je(te,D,L,j){const K=D.geometry,le=D.type,he=[];if(te.minX=Math.min(te.minX,D.minX),te.minY=Math.min(te.minY,D.minY),te.maxX=Math.max(te.maxX,D.maxX),te.maxY=Math.max(te.maxY,D.maxY),le==="Point"||le==="MultiPoint")for(let fe=0;fe<K.length;fe+=3)he.push(K[fe],K[fe+1]),te.numPoints++,te.numSimplified++;else if(le==="LineString")St(he,K,te,L,!1,!1);else if(le==="MultiLineString"||le==="Polygon")for(let fe=0;fe<K.length;fe++)St(he,K[fe],te,L,le==="Polygon",fe===0);else if(le==="MultiPolygon")for(let fe=0;fe<K.length;fe++){const oe=K[fe];for(let we=0;we<oe.length;we++)St(he,oe[we],te,L,!0,we===0)}if(he.length){let fe=D.tags||null;if(le==="LineString"&&j.lineMetrics){fe={};for(const we in D.tags)fe[we]=D.tags[we];fe.mapbox_clip_start=K.start/K.size,fe.mapbox_clip_end=K.end/K.size}const oe={geometry:he,type:le==="Polygon"||le==="MultiPolygon"?3:le==="LineString"||le==="MultiLineString"?2:1,tags:fe};D.id!==null&&(oe.id=D.id),te.features.push(oe)}}function St(te,D,L,j,K,le){const he=j*j;if(j>0&&D.size<(K?he:j))return void(L.numPoints+=D.length/3);const fe=[];for(let oe=0;oe<D.length;oe+=3)(j===0||D[oe+2]>he)&&(L.numSimplified++,fe.push(D[oe],D[oe+1])),L.numPoints++;K&&function(oe,we){let Pe=0;for(let xe=0,Fe=oe.length,ot=Fe-2;xe<Fe;ot=xe,xe+=2)Pe+=(oe[xe]-oe[ot])*(oe[xe+1]+oe[ot+1]);if(Pe>0===we)for(let xe=0,Fe=oe.length;xe<Fe/2;xe+=2){const ot=oe[xe],ut=oe[xe+1];oe[xe]=oe[Fe-2-xe],oe[xe+1]=oe[Fe-1-xe],oe[Fe-2-xe]=ot,oe[Fe-1-xe]=ut}}(fe,le),te.push(fe)}const pt={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Qi{constructor(D,L){const j=(L=this.options=function(le,he){for(const fe in he)le[fe]=he[fe];return le}(Object.create(pt),L)).debug;if(j&&console.time("preprocess data"),L.maxZoom<0||L.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(L.promoteId&&L.generateId)throw new Error("promoteId and generateId cannot be used together.");let K=function(le,he){const fe=[];if(le.type==="FeatureCollection")for(let oe=0;oe<le.features.length;oe++)Or(fe,le.features[oe],he,oe);else Or(fe,le.type==="Feature"?le:{geometry:le},he);return fe}(D,L);this.tiles={},this.tileCoords=[],j&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",L.indexMaxZoom,L.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),K=function(le,he){const fe=he.buffer/he.extent;let oe=le;const we=Si(le,1,-1-fe,fe,0,-1,2,he),Pe=Si(le,1,1-fe,2+fe,0,-1,2,he);return(we||Pe)&&(oe=Si(le,1,-fe,1+fe,0,-1,2,he)||[],we&&(oe=Oe(we,1).concat(oe)),Pe&&(oe=oe.concat(Oe(Pe,-1)))),oe}(K,L),K.length&&this.splitTile(K,0,0,0),j&&(K.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(D,L,j,K,le,he,fe){const oe=[D,L,j,K],we=this.options,Pe=we.debug;for(;oe.length;){K=oe.pop(),j=oe.pop(),L=oe.pop(),D=oe.pop();const xe=1<<L,Fe=ur(L,j,K);let ot=this.tiles[Fe];if(!ot&&(Pe>1&&console.time("creation"),ot=this.tiles[Fe]=ts(D,L,j,K,we),this.tileCoords.push({z:L,x:j,y:K}),Pe)){Pe>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",L,j,K,ot.numFeatures,ot.numPoints,ot.numSimplified),console.timeEnd("creation"));const Ri=`z${L}`;this.stats[Ri]=(this.stats[Ri]||0)+1,this.total++}if(ot.source=D,le==null){if(L===we.indexMaxZoom||ot.numPoints<=we.indexMaxPoints)continue}else{if(L===we.maxZoom||L===le)continue;if(le!=null){const Ri=le-L;if(j!==he>>Ri||K!==fe>>Ri)continue}}if(ot.source=null,D.length===0)continue;Pe>1&&console.time("clipping");const ut=.5*we.buffer/we.extent,qt=.5-ut,gt=.5+ut,zt=1+ut;let Et=null,Ii=null,fi=null,At=null,Xt=Si(D,xe,j-ut,j+gt,0,ot.minX,ot.maxX,we),jt=Si(D,xe,j+qt,j+zt,0,ot.minX,ot.maxX,we);D=null,Xt&&(Et=Si(Xt,xe,K-ut,K+gt,1,ot.minY,ot.maxY,we),Ii=Si(Xt,xe,K+qt,K+zt,1,ot.minY,ot.maxY,we),Xt=null),jt&&(fi=Si(jt,xe,K-ut,K+gt,1,ot.minY,ot.maxY,we),At=Si(jt,xe,K+qt,K+zt,1,ot.minY,ot.maxY,we),jt=null),Pe>1&&console.timeEnd("clipping"),oe.push(Et||[],L+1,2*j,2*K),oe.push(Ii||[],L+1,2*j,2*K+1),oe.push(fi||[],L+1,2*j+1,2*K),oe.push(At||[],L+1,2*j+1,2*K+1)}}getTile(D,L,j){D=+D,L=+L,j=+j;const K=this.options,{extent:le,debug:he}=K;if(D<0||D>24)return null;const fe=1<<D,oe=ur(D,L=L+fe&fe-1,j);if(this.tiles[oe])return Yi(this.tiles[oe],le);he>1&&console.log("drilling down to z%d-%d-%d",D,L,j);let we,Pe=D,xe=L,Fe=j;for(;!we&&Pe>0;)Pe--,xe>>=1,Fe>>=1,we=this.tiles[ur(Pe,xe,Fe)];return we&&we.source?(he>1&&(console.log("found parent tile z%d-%d-%d",Pe,xe,Fe),console.time("drilling down")),this.splitTile(we.source,Pe,xe,Fe,D,L,j),he>1&&console.timeEnd("drilling down"),this.tiles[oe]?Yi(this.tiles[oe],le):null):null}}function ur(te,D,L){return 32*((1<<te)*L+D)+te}function vt(te,D){return D?te.properties[D]:te.id}function dr(te,D){if(te==null)return!0;if(te.type==="Feature")return vt(te,D)!=null;if(te.type==="FeatureCollection"){const L=new Set;for(const j of te.features){const K=vt(j,D);if(K==null||L.has(K))return!1;L.add(K)}return!0}return!1}function Fr(te,D){const L=new Map;if(te!=null)if(te.type==="Feature")L.set(vt(te,D),te);else for(const j of te.features)L.set(vt(j,D),j);return L}class Br extends J{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(D,L){return S._(this,void 0,void 0,function*(){const j=D.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const K=this._geoJSONIndex.getTile(j.z,j.x,j.y);if(!K)return null;const le=new class{constructor(fe){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=S.X,this.length=fe.length,this._features=fe}feature(fe){return new class{constructor(oe){this._feature=oe,this.extent=S.X,this.type=oe.type,this.properties=oe.tags,"id"in oe&&!isNaN(oe.id)&&(this.id=parseInt(oe.id,10))}loadGeometry(){if(this._feature.type===1){const oe=[];for(const we of this._feature.geometry)oe.push([new S.P(we[0],we[1])]);return oe}{const oe=[];for(const we of this._feature.geometry){const Pe=[];for(const xe of we)Pe.push(new S.P(xe[0],xe[1]));oe.push(Pe)}return oe}}toGeoJSON(oe,we,Pe){return _t.call(this,oe,we,Pe)}}(this._features[fe])}}(K.features);let he=oi(le);return he.byteOffset===0&&he.byteLength===he.buffer.byteLength||(he=new Uint8Array(he)),{vectorTile:le,rawData:he.buffer}})}loadData(D){return S._(this,void 0,void 0,function*(){var L;(L=this._pendingRequest)===null||L===void 0||L.abort();const j=!!(D&&D.request&&D.request.collectResourceTiming)&&new S.bv(D.request);this._pendingRequest=new AbortController;try{this._pendingData=this.loadAndProcessGeoJSON(D,this._pendingRequest),this._geoJSONIndex=D.cluster?new Yr(function({superclusterOptions:he,clusterProperties:fe}){if(!fe||!he)return he;const oe={},we={},Pe={accumulated:null,zoom:0},xe={properties:null},Fe=Object.keys(fe);for(const ot of Fe){const[ut,qt]=fe[ot],gt=S.bC(qt),zt=S.bC(typeof ut=="string"?[ut,["accumulated"],["get",ot]]:ut);oe[ot]=gt.value,we[ot]=zt.value}return he.map=ot=>{xe.properties=ot;const ut={};for(const qt of Fe)ut[qt]=oe[qt].evaluate(Pe,xe);return ut},he.reduce=(ot,ut)=>{xe.properties=ut;for(const qt of Fe)Pe.accumulated=ot[qt],ot[qt]=we[qt].evaluate(Pe,xe)},he}(D)).load((yield this._pendingData).features):(K=yield this._pendingData,new Qi(K,D.geojsonVtOptions)),this.loaded={};const le={};if(j){const he=j.finish();he&&(le.resourceTiming={},le.resourceTiming[D.source]=JSON.parse(JSON.stringify(he)))}return le}catch(le){if(delete this._pendingRequest,S.bB(le))return{abandoned:!0};throw le}var K})}getData(){return S._(this,void 0,void 0,function*(){return this._pendingData})}reloadTile(D){const L=this.loaded;return L&&L[D.uid]?super.reloadTile(D):this.loadTile(D)}loadAndProcessGeoJSON(D,L){return S._(this,void 0,void 0,function*(){let j=yield this.loadGeoJSON(D,L);if(delete this._pendingRequest,typeof j!="object")throw new Error(`Input data given to '${D.source}' is not a valid GeoJSON object.`);if($e(j,!0),D.filter){const K=S.bC(D.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(K.result==="error")throw new Error(K.value.map(he=>`${he.key}: ${he.message}`).join(", "));j={type:"FeatureCollection",features:j.features.filter(he=>K.value.evaluate({zoom:0},he))}}return j})}loadGeoJSON(D,L){return S._(this,void 0,void 0,function*(){const{promoteId:j}=D;if(D.request){const K=yield S.h(D.request,L);return this._dataUpdateable=dr(K.data,j)?Fr(K.data,j):void 0,K.data}if(typeof D.data=="string")try{const K=JSON.parse(D.data);return this._dataUpdateable=dr(K,j)?Fr(K,j):void 0,K}catch{throw new Error(`Input data given to '${D.source}' is not a valid GeoJSON object.`)}if(!D.dataDiff)throw new Error(`Input data given to '${D.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${D.source}`);return function(K,le,he){var fe,oe,we,Pe;if(le.removeAll&&K.clear(),le.remove)for(const xe of le.remove)K.delete(xe);if(le.add)for(const xe of le.add){const Fe=vt(xe,he);Fe!=null&&K.set(Fe,xe)}if(le.update)for(const xe of le.update){let Fe=K.get(xe.id);if(Fe==null)continue;const ot=!xe.removeAllProperties&&(((fe=xe.removeProperties)===null||fe===void 0?void 0:fe.length)>0||((oe=xe.addOrUpdateProperties)===null||oe===void 0?void 0:oe.length)>0);if((xe.newGeometry||xe.removeAllProperties||ot)&&(Fe=Object.assign({},Fe),K.set(xe.id,Fe),ot&&(Fe.properties=Object.assign({},Fe.properties))),xe.newGeometry&&(Fe.geometry=xe.newGeometry),xe.removeAllProperties)Fe.properties={};else if(((we=xe.removeProperties)===null||we===void 0?void 0:we.length)>0)for(const ut of xe.removeProperties)Object.prototype.hasOwnProperty.call(Fe.properties,ut)&&delete Fe.properties[ut];if(((Pe=xe.addOrUpdateProperties)===null||Pe===void 0?void 0:Pe.length)>0)for(const{key:ut,value:qt}of xe.addOrUpdateProperties)Fe.properties[ut]=qt}}(this._dataUpdateable,D.dataDiff,j),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}})}removeSource(D){return S._(this,void 0,void 0,function*(){this._pendingRequest&&this._pendingRequest.abort()})}getClusterExpansionZoom(D){return this._geoJSONIndex.getClusterExpansionZoom(D.clusterId)}getClusterChildren(D){return this._geoJSONIndex.getChildren(D.clusterId)}getClusterLeaves(D){return this._geoJSONIndex.getLeaves(D.clusterId,D.limit,D.offset)}}class wr{constructor(D){this.self=D,this.actor=new S.F(D),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(L,j)=>{if(this.externalWorkerSourceTypes[L])throw new Error(`Worker source with name "${L}" already registered.`);this.externalWorkerSourceTypes[L]=j},this.self.addProtocol=S.bi,this.self.removeProtocol=S.bj,this.self.registerRTLTextPlugin=L=>{if(S.bD.isParsed())throw new Error("RTL text plugin already registered.");S.bD.setMethods(L)},this.actor.registerMessageHandler("LDT",(L,j)=>this._getDEMWorkerSource(L,j.source).loadTile(j)),this.actor.registerMessageHandler("RDT",(L,j)=>S._(this,void 0,void 0,function*(){this._getDEMWorkerSource(L,j.source).removeTile(j)})),this.actor.registerMessageHandler("GCEZ",(L,j)=>S._(this,void 0,void 0,function*(){return this._getWorkerSource(L,j.type,j.source).getClusterExpansionZoom(j)})),this.actor.registerMessageHandler("GCC",(L,j)=>S._(this,void 0,void 0,function*(){return this._getWorkerSource(L,j.type,j.source).getClusterChildren(j)})),this.actor.registerMessageHandler("GCL",(L,j)=>S._(this,void 0,void 0,function*(){return this._getWorkerSource(L,j.type,j.source).getClusterLeaves(j)})),this.actor.registerMessageHandler("LD",(L,j)=>this._getWorkerSource(L,j.type,j.source).loadData(j)),this.actor.registerMessageHandler("GD",(L,j)=>this._getWorkerSource(L,j.type,j.source).getData()),this.actor.registerMessageHandler("LT",(L,j)=>this._getWorkerSource(L,j.type,j.source).loadTile(j)),this.actor.registerMessageHandler("RT",(L,j)=>this._getWorkerSource(L,j.type,j.source).reloadTile(j)),this.actor.registerMessageHandler("AT",(L,j)=>this._getWorkerSource(L,j.type,j.source).abortTile(j)),this.actor.registerMessageHandler("RMT",(L,j)=>this._getWorkerSource(L,j.type,j.source).removeTile(j)),this.actor.registerMessageHandler("RS",(L,j)=>S._(this,void 0,void 0,function*(){if(!this.workerSources[L]||!this.workerSources[L][j.type]||!this.workerSources[L][j.type][j.source])return;const K=this.workerSources[L][j.type][j.source];delete this.workerSources[L][j.type][j.source],K.removeSource!==void 0&&K.removeSource(j)})),this.actor.registerMessageHandler("RM",L=>S._(this,void 0,void 0,function*(){delete this.layerIndexes[L],delete this.availableImages[L],delete this.workerSources[L],delete this.demWorkerSources[L]})),this.actor.registerMessageHandler("SR",(L,j)=>S._(this,void 0,void 0,function*(){this.referrer=j})),this.actor.registerMessageHandler("SRPS",(L,j)=>this._syncRTLPluginState(L,j)),this.actor.registerMessageHandler("IS",(L,j)=>S._(this,void 0,void 0,function*(){this.self.importScripts(j)})),this.actor.registerMessageHandler("SI",(L,j)=>this._setImages(L,j)),this.actor.registerMessageHandler("UL",(L,j)=>S._(this,void 0,void 0,function*(){this._getLayerIndex(L).update(j.layers,j.removedIds)})),this.actor.registerMessageHandler("SL",(L,j)=>S._(this,void 0,void 0,function*(){this._getLayerIndex(L).replace(j)}))}_setImages(D,L){return S._(this,void 0,void 0,function*(){this.availableImages[D]=L;for(const j in this.workerSources[D]){const K=this.workerSources[D][j];for(const le in K)K[le].availableImages=L}})}_syncRTLPluginState(D,L){return S._(this,void 0,void 0,function*(){if(S.bD.isParsed())return S.bD.getState();if(L.pluginStatus!=="loading")return S.bD.setState(L),L;const j=L.pluginURL;if(this.self.importScripts(j),S.bD.isParsed()){const K={pluginStatus:"loaded",pluginURL:j};return S.bD.setState(K),K}throw S.bD.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${j}`)})}_getAvailableImages(D){let L=this.availableImages[D];return L||(L=[]),L}_getLayerIndex(D){let L=this.layerIndexes[D];return L||(L=this.layerIndexes[D]=new h),L}_getWorkerSource(D,L,j){if(this.workerSources[D]||(this.workerSources[D]={}),this.workerSources[D][L]||(this.workerSources[D][L]={}),!this.workerSources[D][L][j]){const K={sendAsync:(le,he)=>(le.targetMapId=D,this.actor.sendAsync(le,he))};switch(L){case"vector":this.workerSources[D][L][j]=new J(K,this._getLayerIndex(D),this._getAvailableImages(D));break;case"geojson":this.workerSources[D][L][j]=new Br(K,this._getLayerIndex(D),this._getAvailableImages(D));break;default:this.workerSources[D][L][j]=new this.externalWorkerSourceTypes[L](K,this._getLayerIndex(D),this._getAvailableImages(D))}}return this.workerSources[D][L][j]}_getDEMWorkerSource(D,L){return this.demWorkerSources[D]||(this.demWorkerSources[D]={}),this.demWorkerSources[D][L]||(this.demWorkerSources[D][L]=new G),this.demWorkerSources[D][L]}}return S.i(self)&&(self.worker=new wr(self)),wr}),x("index",["exports","./shared"],function(S,h){var N="4.7.1";let q,ne;const J={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frameAsync:p=>new Promise((e,s)=>{const a=requestAnimationFrame(e);p.signal.addEventListener("abort",()=>{cancelAnimationFrame(a),s(h.c())})}),getImageData(p,e=0){return this.getImageCanvasContext(p).getImageData(-e,-e,p.width+2*e,p.height+2*e)},getImageCanvasContext(p){const e=window.document.createElement("canvas"),s=e.getContext("2d",{willReadFrequently:!0});if(!s)throw new Error("failed to create canvas 2d context");return e.width=p.width,e.height=p.height,s.drawImage(p,0,0,p.width,p.height),s},resolveURL:p=>(q||(q=document.createElement("a")),q.href=p,q.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(ne==null&&(ne=matchMedia("(prefers-reduced-motion: reduce)")),ne.matches)}};class G{static testProp(e){if(!G.docStyle)return e[0];for(let s=0;s<e.length;s++)if(e[s]in G.docStyle)return e[s];return e[0]}static create(e,s,a){const l=window.document.createElement(e);return s!==void 0&&(l.className=s),a&&a.appendChild(l),l}static createNS(e,s){return window.document.createElementNS(e,s)}static disableDrag(){G.docStyle&&G.selectProp&&(G.userSelect=G.docStyle[G.selectProp],G.docStyle[G.selectProp]="none")}static enableDrag(){G.docStyle&&G.selectProp&&(G.docStyle[G.selectProp]=G.userSelect)}static setTransform(e,s){e.style[G.transformProp]=s}static addEventListener(e,s,a,l={}){e.addEventListener(s,a,"passive"in l?l:l.capture)}static removeEventListener(e,s,a,l={}){e.removeEventListener(s,a,"passive"in l?l:l.capture)}static suppressClickInternal(e){e.preventDefault(),e.stopPropagation(),window.removeEventListener("click",G.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",G.suppressClickInternal,!0),window.setTimeout(()=>{window.removeEventListener("click",G.suppressClickInternal,!0)},0)}static getScale(e){const s=e.getBoundingClientRect();return{x:s.width/e.offsetWidth||1,y:s.height/e.offsetHeight||1,boundingClientRect:s}}static getPoint(e,s,a){const l=s.boundingClientRect;return new h.P((a.clientX-l.left)/s.x-e.clientLeft,(a.clientY-l.top)/s.y-e.clientTop)}static mousePos(e,s){const a=G.getScale(e);return G.getPoint(e,a,s)}static touchPos(e,s){const a=[],l=G.getScale(e);for(let d=0;d<s.length;d++)a.push(G.getPoint(e,l,s[d]));return a}static mouseButton(e){return e.button}static remove(e){e.parentNode&&e.parentNode.removeChild(e)}}G.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,G.selectProp=G.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),G.transformProp=G.testProp(["transform","WebkitTransform"]);const ve={supported:!1,testSupport:function(p){!_t&&$e&&(Tt?xt(p):Ee=p)}};let Ee,$e,_t=!1,Tt=!1;function xt(p){const e=p.createTexture();p.bindTexture(p.TEXTURE_2D,e);try{if(p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,$e),p.isContextLost())return;ve.supported=!0}catch{}p.deleteTexture(e),_t=!0}var Ct;typeof document<"u"&&($e=document.createElement("img"),$e.onload=()=>{Ee&&xt(Ee),Ee=null,Tt=!0},$e.onerror=()=>{_t=!0,Ee=null},$e.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(p){let e,s,a,l;p.resetRequestQueue=()=>{e=[],s=0,a=0,l={}},p.addThrottleControl=I=>{const A=a++;return l[A]=I,A},p.removeThrottleControl=I=>{delete l[I],v()},p.getImage=(I,A,C=!0)=>new Promise((M,O)=>{ve.supported&&(I.headers||(I.headers={}),I.headers.accept="image/webp,*/*"),h.e(I,{type:"image"}),e.push({abortController:A,requestParameters:I,supportImageRefresh:C,state:"queued",onError:V=>{O(V)},onSuccess:V=>{M(V)}}),v()});const d=I=>h._(this,void 0,void 0,function*(){I.state="running";const{requestParameters:A,supportImageRefresh:C,onError:M,onSuccess:O,abortController:V}=I,H=C===!1&&!h.i(self)&&!h.g(A.url)&&(!A.headers||Object.keys(A.headers).reduce((se,ae)=>se&&ae==="accept",!0));s++;const ee=H?w(A,V):h.m(A,V);try{const se=yield ee;delete I.abortController,I.state="completed",se.data instanceof HTMLImageElement||h.b(se.data)?O(se):se.data&&O({data:yield(re=se.data,typeof createImageBitmap=="function"?h.d(re):h.f(re)),cacheControl:se.cacheControl,expires:se.expires})}catch(se){delete I.abortController,M(se)}finally{s--,v()}var re}),v=()=>{const I=(()=>{for(const A of Object.keys(l))if(l[A]())return!0;return!1})()?h.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:h.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let A=s;A<I&&e.length>0;A++){const C=e.shift();C.abortController.signal.aborted?A--:d(C)}},w=(I,A)=>new Promise((C,M)=>{const O=new Image,V=I.url,H=I.credentials;H&&H==="include"?O.crossOrigin="use-credentials":(H&&H==="same-origin"||!h.s(V))&&(O.crossOrigin="anonymous"),A.signal.addEventListener("abort",()=>{O.src="",M(h.c())}),O.fetchPriority="high",O.onload=()=>{O.onerror=O.onload=null,C({data:O})},O.onerror=()=>{O.onerror=O.onload=null,A.signal.aborted||M(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},O.src=V})}(Ct||(Ct={})),Ct.resetRequestQueue();class Li{constructor(e){this._transformRequestFn=e}transformRequest(e,s){return this._transformRequestFn&&this._transformRequestFn(e,s)||{url:e}}setTransformRequest(e){this._transformRequestFn=e}}function Yt(p){var e=new h.A(3);return e[0]=p[0],e[1]=p[1],e[2]=p[2],e}var Vt,yt=function(p,e,s){return p[0]=e[0]-s[0],p[1]=e[1]-s[1],p[2]=e[2]-s[2],p};Vt=new h.A(3),h.A!=Float32Array&&(Vt[0]=0,Vt[1]=0,Vt[2]=0);var ri=function(p){var e=p[0],s=p[1];return e*e+s*s};function Bt(p){const e=[];if(typeof p=="string")e.push({id:"default",url:p});else if(p&&p.length>0){const s=[];for(const{id:a,url:l}of p){const d=`${a}${l}`;s.indexOf(d)===-1&&(s.push(d),e.push({id:a,url:l}))}}return e}function ji(p,e,s){const a=p.split("?");return a[0]+=`${e}${s}`,a.join("?")}(function(){var p=new h.A(2);h.A!=Float32Array&&(p[0]=0,p[1]=0)})();class Lt{constructor(e,s,a,l){this.context=e,this.format=a,this.texture=e.gl.createTexture(),this.update(s,l)}update(e,s,a){const{width:l,height:d}=e,v=!(this.size&&this.size[0]===l&&this.size[1]===d||a),{context:w}=this,{gl:I}=w;if(this.useMipmap=!!(s&&s.useMipmap),I.bindTexture(I.TEXTURE_2D,this.texture),w.pixelStoreUnpackFlipY.set(!1),w.pixelStoreUnpack.set(1),w.pixelStoreUnpackPremultiplyAlpha.set(this.format===I.RGBA&&(!s||s.premultiply!==!1)),v)this.size=[l,d],e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||h.b(e)?I.texImage2D(I.TEXTURE_2D,0,this.format,this.format,I.UNSIGNED_BYTE,e):I.texImage2D(I.TEXTURE_2D,0,this.format,l,d,0,this.format,I.UNSIGNED_BYTE,e.data);else{const{x:A,y:C}=a||{x:0,y:0};e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||h.b(e)?I.texSubImage2D(I.TEXTURE_2D,0,A,C,I.RGBA,I.UNSIGNED_BYTE,e):I.texSubImage2D(I.TEXTURE_2D,0,A,C,l,d,I.RGBA,I.UNSIGNED_BYTE,e.data)}this.useMipmap&&this.isSizePowerOfTwo()&&I.generateMipmap(I.TEXTURE_2D)}bind(e,s,a){const{context:l}=this,{gl:d}=l;d.bindTexture(d.TEXTURE_2D,this.texture),a!==d.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(a=d.LINEAR),e!==this.filter&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,e),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,a||e),this.filter=e),s!==this.wrap&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,s),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,s),this.wrap=s)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}function kt(p){const{userImage:e}=p;return!!(e&&e.render&&e.render())&&(p.data.replace(new Uint8Array(e.data.buffer)),!0)}class pi extends h.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new h.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(e){if(this.loaded!==e&&(this.loaded=e,e)){for(const{ids:s,promiseResolve:a}of this.requestors)a(this._getImagesForIds(s));this.requestors=[]}}getImage(e){const s=this.images[e];if(s&&!s.data&&s.spriteData){const a=s.spriteData;s.data=new h.R({width:a.width,height:a.height},a.context.getImageData(a.x,a.y,a.width,a.height).data),s.spriteData=null}return s}addImage(e,s){if(this.images[e])throw new Error(`Image id ${e} already exist, use updateImage instead`);this._validate(e,s)&&(this.images[e]=s)}_validate(e,s){let a=!0;const l=s.data||s.spriteData;return this._validateStretch(s.stretchX,l&&l.width)||(this.fire(new h.j(new Error(`Image "${e}" has invalid "stretchX" value`))),a=!1),this._validateStretch(s.stretchY,l&&l.height)||(this.fire(new h.j(new Error(`Image "${e}" has invalid "stretchY" value`))),a=!1),this._validateContent(s.content,s)||(this.fire(new h.j(new Error(`Image "${e}" has invalid "content" value`))),a=!1),a}_validateStretch(e,s){if(!e)return!0;let a=0;for(const l of e){if(l[0]<a||l[1]<l[0]||s<l[1])return!1;a=l[1]}return!0}_validateContent(e,s){if(!e)return!0;if(e.length!==4)return!1;const a=s.spriteData,l=a&&a.width||s.data.width,d=a&&a.height||s.data.height;return!(e[0]<0||l<e[0]||e[1]<0||d<e[1]||e[2]<0||l<e[2]||e[3]<0||d<e[3]||e[2]<e[0]||e[3]<e[1])}updateImage(e,s,a=!0){const l=this.getImage(e);if(a&&(l.data.width!==s.data.width||l.data.height!==s.data.height))throw new Error(`size mismatch between old image (${l.data.width}x${l.data.height}) and new image (${s.data.width}x${s.data.height}).`);s.version=l.version+1,this.images[e]=s,this.updatedImages[e]=!0}removeImage(e){const s=this.images[e];delete this.images[e],delete this.patterns[e],s.userImage&&s.userImage.onRemove&&s.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(e){return new Promise((s,a)=>{let l=!0;if(!this.isLoaded())for(const d of e)this.images[d]||(l=!1);this.isLoaded()||l?s(this._getImagesForIds(e)):this.requestors.push({ids:e,promiseResolve:s})})}_getImagesForIds(e){const s={};for(const a of e){let l=this.getImage(a);l||(this.fire(new h.k("styleimagemissing",{id:a})),l=this.getImage(a)),l?s[a]={data:l.data.clone(),pixelRatio:l.pixelRatio,sdf:l.sdf,version:l.version,stretchX:l.stretchX,stretchY:l.stretchY,content:l.content,textFitWidth:l.textFitWidth,textFitHeight:l.textFitHeight,hasRenderCallback:!!(l.userImage&&l.userImage.render)}:h.w(`Image "${a}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return s}getPixelSize(){const{width:e,height:s}=this.atlasImage;return{width:e,height:s}}getPattern(e){const s=this.patterns[e],a=this.getImage(e);if(!a)return null;if(s&&s.position.version===a.version)return s.position;if(s)s.position.version=a.version;else{const l={w:a.data.width+2,h:a.data.height+2,x:0,y:0},d=new h.I(l,a);this.patterns[e]={bin:l,position:d}}return this._updatePatternAtlas(),this.patterns[e].position}bind(e){const s=e.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new Lt(e,this.atlasImage,s.RGBA),this.atlasTexture.bind(s.LINEAR,s.CLAMP_TO_EDGE)}_updatePatternAtlas(){const e=[];for(const d in this.patterns)e.push(this.patterns[d].bin);const{w:s,h:a}=h.p(e),l=this.atlasImage;l.resize({width:s||1,height:a||1});for(const d in this.patterns){const{bin:v}=this.patterns[d],w=v.x+1,I=v.y+1,A=this.getImage(d).data,C=A.width,M=A.height;h.R.copy(A,l,{x:0,y:0},{x:w,y:I},{width:C,height:M}),h.R.copy(A,l,{x:0,y:M-1},{x:w,y:I-1},{width:C,height:1}),h.R.copy(A,l,{x:0,y:0},{x:w,y:I+M},{width:C,height:1}),h.R.copy(A,l,{x:C-1,y:0},{x:w-1,y:I},{width:1,height:M}),h.R.copy(A,l,{x:0,y:0},{x:w+C,y:I},{width:1,height:M})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(e){for(const s of e){if(this.callbackDispatchedThisFrame[s])continue;this.callbackDispatchedThisFrame[s]=!0;const a=this.getImage(s);a||h.w(`Image with ID: "${s}" was not found`),kt(a)&&this.updateImage(s,a)}}}const De=1e20;function Ut(p,e,s,a,l,d,v,w,I){for(let A=e;A<e+a;A++)ni(p,s*d+A,d,l,v,w,I);for(let A=s;A<s+l;A++)ni(p,A*d+e,1,a,v,w,I)}function ni(p,e,s,a,l,d,v){d[0]=0,v[0]=-De,v[1]=De,l[0]=p[e];for(let w=1,I=0,A=0;w<a;w++){l[w]=p[e+w*s];const C=w*w;do{const M=d[I];A=(l[w]-l[M]+C-M*M)/(w-M)/2}while(A<=v[I]&&--I>-1);I++,d[I]=w,v[I]=A,v[I+1]=De}for(let w=0,I=0;w<a;w++){for(;v[I+1]<w;)I++;const A=d[I],C=w-A;p[e+w*s]=l[A]+C*C}}class oi{constructor(e,s){this.requestManager=e,this.localIdeographFontFamily=s,this.entries={}}setURL(e){this.url=e}getGlyphs(e){return h._(this,void 0,void 0,function*(){const s=[];for(const d in e)for(const v of e[d])s.push(this._getAndCacheGlyphsPromise(d,v));const a=yield Promise.all(s),l={};for(const{stack:d,id:v,glyph:w}of a)l[d]||(l[d]={}),l[d][v]=w&&{id:w.id,bitmap:w.bitmap.clone(),metrics:w.metrics};return l})}_getAndCacheGlyphsPromise(e,s){return h._(this,void 0,void 0,function*(){let a=this.entries[e];a||(a=this.entries[e]={glyphs:{},requests:{},ranges:{}});let l=a.glyphs[s];if(l!==void 0)return{stack:e,id:s,glyph:l};if(l=this._tinySDF(a,e,s),l)return a.glyphs[s]=l,{stack:e,id:s,glyph:l};const d=Math.floor(s/256);if(256*d>65535)throw new Error("glyphs > 65535 not supported");if(a.ranges[d])return{stack:e,id:s,glyph:l};if(!this.url)throw new Error("glyphsUrl is not set");if(!a.requests[d]){const w=oi.loadGlyphRange(e,d,this.url,this.requestManager);a.requests[d]=w}const v=yield a.requests[d];for(const w in v)this._doesCharSupportLocalGlyph(+w)||(a.glyphs[+w]=v[+w]);return a.ranges[d]=!0,{stack:e,id:s,glyph:v[s]||null}})}_doesCharSupportLocalGlyph(e){return!!this.localIdeographFontFamily&&new RegExp("\\p{Ideo}|\\p{sc=Hang}|\\p{sc=Hira}|\\p{sc=Kana}","u").test(String.fromCodePoint(e))}_tinySDF(e,s,a){const l=this.localIdeographFontFamily;if(!l||!this._doesCharSupportLocalGlyph(a))return;let d=e.tinySDF;if(!d){let w="400";/bold/i.test(s)?w="900":/medium/i.test(s)?w="500":/light/i.test(s)&&(w="200"),d=e.tinySDF=new oi.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:l,fontWeight:w})}const v=d.draw(String.fromCharCode(a));return{id:a,bitmap:new h.o({width:v.width||60,height:v.height||60},v.data),metrics:{width:v.glyphWidth/2||24,height:v.glyphHeight/2||24,left:v.glyphLeft/2+.5||0,top:v.glyphTop/2-27.5||-8,advance:v.glyphAdvance/2||24,isDoubleResolution:!0}}}}oi.loadGlyphRange=function(p,e,s,a){return h._(this,void 0,void 0,function*(){const l=256*e,d=l+255,v=a.transformRequest(s.replace("{fontstack}",p).replace("{range}",`${l}-${d}`),"Glyphs"),w=yield h.l(v,new AbortController);if(!w||!w.data)throw new Error(`Could not load glyph range. range: ${e}, ${l}-${d}`);const I={};for(const A of h.n(w.data))I[A.id]=A;return I})},oi.TinySDF=class{constructor({fontSize:p=24,buffer:e=3,radius:s=8,cutoff:a=.25,fontFamily:l="sans-serif",fontWeight:d="normal",fontStyle:v="normal"}={}){this.buffer=e,this.cutoff=a,this.radius=s;const w=this.size=p+4*e,I=this._createCanvas(w),A=this.ctx=I.getContext("2d",{willReadFrequently:!0});A.font=`${v} ${d} ${p}px ${l}`,A.textBaseline="alphabetic",A.textAlign="left",A.fillStyle="black",this.gridOuter=new Float64Array(w*w),this.gridInner=new Float64Array(w*w),this.f=new Float64Array(w),this.z=new Float64Array(w+1),this.v=new Uint16Array(w)}_createCanvas(p){const e=document.createElement("canvas");return e.width=e.height=p,e}draw(p){const{width:e,actualBoundingBoxAscent:s,actualBoundingBoxDescent:a,actualBoundingBoxLeft:l,actualBoundingBoxRight:d}=this.ctx.measureText(p),v=Math.ceil(s),w=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(d-l))),I=Math.min(this.size-this.buffer,v+Math.ceil(a)),A=w+2*this.buffer,C=I+2*this.buffer,M=Math.max(A*C,0),O=new Uint8ClampedArray(M),V={data:O,width:A,height:C,glyphWidth:w,glyphHeight:I,glyphTop:v,glyphLeft:0,glyphAdvance:e};if(w===0||I===0)return V;const{ctx:H,buffer:ee,gridInner:re,gridOuter:se}=this;H.clearRect(ee,ee,w,I),H.fillText(p,ee,ee+v);const ae=H.getImageData(ee,ee,w,I);se.fill(De,0,M),re.fill(0,0,M);for(let Y=0;Y<I;Y++)for(let ue=0;ue<w;ue++){const pe=ae.data[4*(Y*w+ue)+3]/255;if(pe===0)continue;const ye=(Y+ee)*A+ue+ee;if(pe===1)se[ye]=0,re[ye]=De;else{const Ce=.5-pe;se[ye]=Ce>0?Ce*Ce:0,re[ye]=Ce<0?Ce*Ce:0}}Ut(se,0,0,A,C,A,this.f,this.v,this.z),Ut(re,ee,ee,w,I,A,this.f,this.v,this.z);for(let Y=0;Y<M;Y++){const ue=Math.sqrt(se[Y])-Math.sqrt(re[Y]);O[Y]=Math.round(255-255*(ue/this.radius+this.cutoff))}return V}};class ws{constructor(){this.specification=h.v.light.position}possiblyEvaluate(e,s){return h.x(e.expression.evaluate(s))}interpolate(e,s,a){return{x:h.y.number(e.x,s.x,a),y:h.y.number(e.y,s.y,a),z:h.y.number(e.z,s.z,a)}}}let Ni;class si extends h.E{constructor(e){super(),Ni=Ni||new h.q({anchor:new h.D(h.v.light.anchor),position:new ws,color:new h.D(h.v.light.color),intensity:new h.D(h.v.light.intensity)}),this._transitionable=new h.T(Ni),this.setLight(e),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(e,s={}){if(!this._validate(h.r,e,s))for(const a in e){const l=e[a];a.endsWith("-transition")?this._transitionable.setTransition(a.slice(0,-11),l):this._transitionable.setValue(a,l)}}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,s,a){return(!a||a.validate!==!1)&&h.t(this,e.call(h.u,{value:s,style:{glyphs:!0,sprite:!0},styleSpec:h.v}))}}const gi=new h.q({"sky-color":new h.D(h.v.sky["sky-color"]),"horizon-color":new h.D(h.v.sky["horizon-color"]),"fog-color":new h.D(h.v.sky["fog-color"]),"fog-ground-blend":new h.D(h.v.sky["fog-ground-blend"]),"horizon-fog-blend":new h.D(h.v.sky["horizon-fog-blend"]),"sky-horizon-blend":new h.D(h.v.sky["sky-horizon-blend"]),"atmosphere-blend":new h.D(h.v.sky["atmosphere-blend"])});class Zi extends h.E{constructor(e){super(),this._transitionable=new h.T(gi),this.setSky(e),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new h.z(0))}setSky(e,s={}){if(!this._validate(h.B,e,s)){e||(e={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(const a in e){const l=e[a];a.endsWith("-transition")?this._transitionable.setTransition(a.slice(0,-11),l):this._transitionable.setValue(a,l)}}}getSky(){return this._transitionable.serialize()}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(e,s,a={}){return(a==null?void 0:a.validate)!==!1&&h.t(this,e.call(h.u,h.e({value:s,style:{glyphs:!0,sprite:!0},styleSpec:h.v})))}calculateFogBlendOpacity(e){return e<60?0:e<70?(e-60)/10:1}}class Dr{constructor(e,s){this.width=e,this.height=s,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(e,s){const a=e.join(",")+String(s);return this.dashEntry[a]||(this.dashEntry[a]=this.addDash(e,s)),this.dashEntry[a]}getDashRanges(e,s,a){const l=[];let d=e.length%2==1?-e[e.length-1]*a:0,v=e[0]*a,w=!0;l.push({left:d,right:v,isDash:w,zeroLength:e[0]===0});let I=e[0];for(let A=1;A<e.length;A++){w=!w;const C=e[A];d=I*a,I+=C,v=I*a,l.push({left:d,right:v,isDash:w,zeroLength:C===0})}return l}addRoundDash(e,s,a){const l=s/2;for(let d=-a;d<=a;d++){const v=this.width*(this.nextRow+a+d);let w=0,I=e[w];for(let A=0;A<this.width;A++){A/I.right>1&&(I=e[++w]);const C=Math.abs(A-I.left),M=Math.abs(A-I.right),O=Math.min(C,M);let V;const H=d/a*(l+1);if(I.isDash){const ee=l-Math.abs(H);V=Math.sqrt(O*O+ee*ee)}else V=l-Math.sqrt(O*O+H*H);this.data[v+A]=Math.max(0,Math.min(255,V+128))}}}addRegularDash(e){for(let w=e.length-1;w>=0;--w){const I=e[w],A=e[w+1];I.zeroLength?e.splice(w,1):A&&A.isDash===I.isDash&&(A.left=I.left,e.splice(w,1))}const s=e[0],a=e[e.length-1];s.isDash===a.isDash&&(s.left=a.left-this.width,a.right=s.right+this.width);const l=this.width*this.nextRow;let d=0,v=e[d];for(let w=0;w<this.width;w++){w/v.right>1&&(v=e[++d]);const I=Math.abs(w-v.left),A=Math.abs(w-v.right),C=Math.min(I,A);this.data[l+w]=Math.max(0,Math.min(255,(v.isDash?C:-C)+128))}}addDash(e,s){const a=s?7:0,l=2*a+1;if(this.nextRow+l>this.height)return h.w("LineAtlas out of space"),null;let d=0;for(let w=0;w<e.length;w++)d+=e[w];if(d!==0){const w=this.width/d,I=this.getDashRanges(e,this.width,w);s?this.addRoundDash(I,w,a):this.addRegularDash(I)}const v={y:(this.nextRow+a+.5)/this.height,height:2*a/this.height,width:d};return this.nextRow+=l,this.dirty=!0,v}bind(e){const s=e.gl;this.texture?(s.bindTexture(s.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,s.texSubImage2D(s.TEXTURE_2D,0,0,0,this.width,this.height,s.ALPHA,s.UNSIGNED_BYTE,this.data))):(this.texture=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this.texture),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texImage2D(s.TEXTURE_2D,0,s.ALPHA,this.width,this.height,0,s.ALPHA,s.UNSIGNED_BYTE,this.data))}}const Yr="maplibre_preloaded_worker_pool";class Lr{constructor(){this.active={}}acquire(e){if(!this.workers)for(this.workers=[];this.workers.length<Lr.workerCount;)this.workers.push(new Worker(h.a.WORKER_URL));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.numActive()===0&&(this.workers.forEach(s=>{s.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Yr]}numActive(){return Object.keys(this.active).length}}const Ss=Math.floor(J.hardwareConcurrency/2);let wi,ki;function Mt(){return wi||(wi=new Lr),wi}Lr.workerCount=h.C(globalThis)?Math.max(Math.min(Ss,3),1):1;class $i{constructor(e,s){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=s;const a=this.workerPool.acquire(s);for(let l=0;l<a.length;l++){const d=new h.F(a[l],s);d.name=`Worker ${l}`,this.actors.push(d)}if(!this.actors.length)throw new Error("No actors found")}broadcast(e,s){const a=[];for(const l of this.actors)a.push(l.sendAsync({type:e,data:s}));return Promise.all(a)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(e=!0){this.actors.forEach(s=>{s.remove()}),this.actors=[],e&&this.workerPool.release(this.id)}registerMessageHandler(e,s){for(const a of this.actors)a.registerMessageHandler(e,s)}}function Gs(){return ki||(ki=new $i(Mt(),h.G),ki.registerMessageHandler("GR",(p,e,s)=>h.m(e,s))),ki}function Hr(p,e){const s=h.H();return h.J(s,s,[1,1,0]),h.K(s,s,[.5*p.width,.5*p.height,1]),h.L(s,s,p.calculatePosMatrix(e.toUnwrapped()))}function Rr(p,e,s,a,l,d){const v=function(M,O,V){if(M)for(const H of M){const ee=O[H];if(ee&&ee.source===V&&ee.type==="fill-extrusion")return!0}else for(const H in O){const ee=O[H];if(ee.source===V&&ee.type==="fill-extrusion")return!0}return!1}(l&&l.layers,e,p.id),w=d.maxPitchScaleFactor(),I=p.tilesIn(a,w,v);I.sort(Or);const A=[];for(const M of I)A.push({wrappedTileID:M.tileID.wrapped().key,queryResults:M.tile.queryRenderedFeatures(e,s,p._state,M.queryGeometry,M.cameraQueryGeometry,M.scale,l,d,w,Hr(p.transform,M.tileID))});const C=function(M){const O={},V={};for(const H of M){const ee=H.queryResults,re=H.wrappedTileID,se=V[re]=V[re]||{};for(const ae in ee){const Y=ee[ae],ue=se[ae]=se[ae]||{},pe=O[ae]=O[ae]||[];for(const ye of Y)ue[ye.featureIndex]||(ue[ye.featureIndex]=!0,pe.push(ye))}}return O}(A);for(const M in C)C[M].forEach(O=>{const V=O.feature,H=p.getFeatureState(V.layer["source-layer"],V.id);V.source=V.layer.source,V.layer["source-layer"]&&(V.sourceLayer=V.layer["source-layer"]),V.state=H});return C}function Or(p,e){const s=p.tileID,a=e.tileID;return s.overscaledZ-a.overscaledZ||s.canonical.y-a.canonical.y||s.wrap-a.wrap||s.canonical.x-a.canonical.x}function zs(p,e,s){return h._(this,void 0,void 0,function*(){let a=p;if(p.url?a=(yield h.h(e.transformRequest(p.url,"Source"),s)).data:yield J.frameAsync(s),!a)return null;const l=h.M(h.e(a,p),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in a&&a.vector_layers&&(l.vectorLayerIds=a.vector_layers.map(d=>d.id)),l})}class be{constructor(e,s){e&&(s?this.setSouthWest(e).setNorthEast(s):Array.isArray(e)&&(e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1])))}setNorthEast(e){return this._ne=e instanceof h.N?new h.N(e.lng,e.lat):h.N.convert(e),this}setSouthWest(e){return this._sw=e instanceof h.N?new h.N(e.lng,e.lat):h.N.convert(e),this}extend(e){const s=this._sw,a=this._ne;let l,d;if(e instanceof h.N)l=e,d=e;else{if(!(e instanceof be))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(be.convert(e)):this.extend(h.N.convert(e)):e&&("lng"in e||"lon"in e)&&"lat"in e?this.extend(h.N.convert(e)):this;if(l=e._sw,d=e._ne,!l||!d)return this}return s||a?(s.lng=Math.min(l.lng,s.lng),s.lat=Math.min(l.lat,s.lat),a.lng=Math.max(d.lng,a.lng),a.lat=Math.max(d.lat,a.lat)):(this._sw=new h.N(l.lng,l.lat),this._ne=new h.N(d.lng,d.lat)),this}getCenter(){return new h.N((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new h.N(this.getWest(),this.getNorth())}getSouthEast(){return new h.N(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:s,lat:a}=h.N.convert(e);let l=this._sw.lng<=s&&s<=this._ne.lng;return this._sw.lng>this._ne.lng&&(l=this._sw.lng>=s&&s>=this._ne.lng),this._sw.lat<=a&&a<=this._ne.lat&&l}static convert(e){return e instanceof be?e:e&&new be(e)}static fromLngLat(e,s=0){const a=360*s/40075017,l=a/Math.cos(Math.PI/180*e.lat);return new be(new h.N(e.lng-l,e.lat-a),new h.N(e.lng+l,e.lat+a))}adjustAntiMeridian(){const e=new h.N(this._sw.lng,this._sw.lat),s=new h.N(this._ne.lng,this._ne.lat);return new be(e,e.lng>s.lng?new h.N(s.lng+360,s.lat):s)}}class Is{constructor(e,s,a){this.bounds=be.convert(this.validateBounds(e)),this.minzoom=s||0,this.maxzoom=a||24}validateBounds(e){return Array.isArray(e)&&e.length===4?[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]:[-180,-90,180,90]}contains(e){const s=Math.pow(2,e.z),a=Math.floor(h.O(this.bounds.getWest())*s),l=Math.floor(h.Q(this.bounds.getNorth())*s),d=Math.ceil(h.O(this.bounds.getEast())*s),v=Math.ceil(h.Q(this.bounds.getSouth())*s);return e.x>=a&&e.x<d&&e.y>=l&&e.y<v}}class on extends h.E{constructor(e,s,a,l){if(super(),this.id=e,this.dispatcher=a,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,h.e(this,h.M(s,["url","scheme","tileSize","promoteId"])),this._options=h.e({type:"vector"},s),this._collectResourceTiming=s.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(l)}load(){return h._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new h.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const e=yield zs(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),e&&(h.e(this,e),e.bounds&&(this.tileBounds=new Is(e.bounds,this.minzoom,this.maxzoom)),this.fire(new h.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new h.k("data",{dataType:"source",sourceDataType:"content"})))}catch(e){this._tileJSONRequest=null,this.fire(new h.j(e))}})}loaded(){return this._loaded}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}onAdd(e){this.map=e,this.load()}setSourceProperty(e){this._tileJSONRequest&&this._tileJSONRequest.abort(),e(),this.load()}setTiles(e){return this.setSourceProperty(()=>{this._options.tiles=e}),this}setUrl(e){return this.setSourceProperty(()=>{this.url=e,this._options.url=e}),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return h.e({},this._options)}loadTile(e){return h._(this,void 0,void 0,function*(){const s=e.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),a={request:this.map._requestManager.transformRequest(s,"Tile"),uid:e.uid,tileID:e.tileID,zoom:e.tileID.overscaledZ,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};a.request.collectResourceTiming=this._collectResourceTiming;let l="RT";if(e.actor&&e.state!=="expired"){if(e.state==="loading")return new Promise((d,v)=>{e.reloadPromise={resolve:d,reject:v}})}else e.actor=this.dispatcher.getActor(),l="LT";e.abortController=new AbortController;try{const d=yield e.actor.sendAsync({type:l,data:a},e.abortController);if(delete e.abortController,e.aborted)return;this._afterTileLoadWorkerResponse(e,d)}catch(d){if(delete e.abortController,e.aborted)return;if(d&&d.status!==404)throw d;this._afterTileLoadWorkerResponse(e,null)}})}_afterTileLoadWorkerResponse(e,s){if(s&&s.resourceTiming&&(e.resourceTiming=s.resourceTiming),s&&this.map._refreshExpiredTiles&&e.setExpiryData(s),e.loadVectorData(s,this.map.painter),e.reloadPromise){const a=e.reloadPromise;e.reloadPromise=null,this.loadTile(e).then(a.resolve).catch(a.reject)}}abortTile(e){return h._(this,void 0,void 0,function*(){e.abortController&&(e.abortController.abort(),delete e.abortController),e.actor&&(yield e.actor.sendAsync({type:"AT",data:{uid:e.uid,type:this.type,source:this.id}}))})}unloadTile(e){return h._(this,void 0,void 0,function*(){e.unloadVectorData(),e.actor&&(yield e.actor.sendAsync({type:"RMT",data:{uid:e.uid,type:this.type,source:this.id}}))})}hasTransition(){return!1}}class Gt extends h.E{constructor(e,s,a,l){super(),this.id=e,this.dispatcher=a,this.setEventedParent(l),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=h.e({type:"raster"},s),h.e(this,h.M(s,["url","scheme","tileSize"]))}load(){return h._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new h.k("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const e=yield zs(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,e&&(h.e(this,e),e.bounds&&(this.tileBounds=new Is(e.bounds,this.minzoom,this.maxzoom)),this.fire(new h.k("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new h.k("data",{dataType:"source",sourceDataType:"content"})))}catch(e){this._tileJSONRequest=null,this.fire(new h.j(e))}})}loaded(){return this._loaded}onAdd(e){this.map=e,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(e){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),e(),this.load()}setTiles(e){return this.setSourceProperty(()=>{this._options.tiles=e}),this}setUrl(e){return this.setSourceProperty(()=>{this.url=e,this._options.url=e}),this}serialize(){return h.e({},this._options)}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e){return h._(this,void 0,void 0,function*(){const s=e.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);e.abortController=new AbortController;try{const a=yield Ct.getImage(this.map._requestManager.transformRequest(s,"Tile"),e.abortController,this.map._refreshExpiredTiles);if(delete e.abortController,e.aborted)return void(e.state="unloaded");if(a&&a.data){this.map._refreshExpiredTiles&&a.cacheControl&&a.expires&&e.setExpiryData({cacheControl:a.cacheControl,expires:a.expires});const l=this.map.painter.context,d=l.gl,v=a.data;e.texture=this.map.painter.getTileTexture(v.width),e.texture?e.texture.update(v,{useMipmap:!0}):(e.texture=new Lt(l,v,d.RGBA,{useMipmap:!0}),e.texture.bind(d.LINEAR,d.CLAMP_TO_EDGE,d.LINEAR_MIPMAP_NEAREST)),e.state="loaded"}}catch(a){if(delete e.abortController,e.aborted)e.state="unloaded";else if(a)throw e.state="errored",a}})}abortTile(e){return h._(this,void 0,void 0,function*(){e.abortController&&(e.abortController.abort(),delete e.abortController)})}unloadTile(e){return h._(this,void 0,void 0,function*(){e.texture&&this.map.painter.saveTileTexture(e.texture)})}hasTransition(){return!1}}class Si extends Gt{constructor(e,s,a,l){super(e,s,a,l),this.type="raster-dem",this.maxzoom=22,this._options=h.e({type:"raster-dem"},s),this.encoding=s.encoding||"mapbox",this.redFactor=s.redFactor,this.greenFactor=s.greenFactor,this.blueFactor=s.blueFactor,this.baseShift=s.baseShift}loadTile(e){return h._(this,void 0,void 0,function*(){const s=e.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),a=this.map._requestManager.transformRequest(s,"Tile");e.neighboringTiles=this._getNeighboringTiles(e.tileID),e.abortController=new AbortController;try{const l=yield Ct.getImage(a,e.abortController,this.map._refreshExpiredTiles);if(delete e.abortController,e.aborted)return void(e.state="unloaded");if(l&&l.data){const d=l.data;this.map._refreshExpiredTiles&&l.cacheControl&&l.expires&&e.setExpiryData({cacheControl:l.cacheControl,expires:l.expires});const v=h.b(d)&&h.U()?d:yield this.readImageNow(d),w={type:this.type,uid:e.uid,source:this.id,rawImageData:v,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!e.actor||e.state==="expired"){e.actor=this.dispatcher.getActor();const I=yield e.actor.sendAsync({type:"LDT",data:w});e.dem=I,e.needsHillshadePrepare=!0,e.needsTerrainPrepare=!0,e.state="loaded"}}}catch(l){if(delete e.abortController,e.aborted)e.state="unloaded";else if(l)throw e.state="errored",l}})}readImageNow(e){return h._(this,void 0,void 0,function*(){if(typeof VideoFrame<"u"&&h.V()){const s=e.width+2,a=e.height+2;try{return new h.R({width:s,height:a},yield h.W(e,-1,-1,s,a))}catch{}}return J.getImageData(e,1)})}_getNeighboringTiles(e){const s=e.canonical,a=Math.pow(2,s.z),l=(s.x-1+a)%a,d=s.x===0?e.wrap-1:e.wrap,v=(s.x+1+a)%a,w=s.x+1===a?e.wrap+1:e.wrap,I={};return I[new h.S(e.overscaledZ,d,s.z,l,s.y).key]={backfilled:!1},I[new h.S(e.overscaledZ,w,s.z,v,s.y).key]={backfilled:!1},s.y>0&&(I[new h.S(e.overscaledZ,d,s.z,l,s.y-1).key]={backfilled:!1},I[new h.S(e.overscaledZ,e.wrap,s.z,s.x,s.y-1).key]={backfilled:!1},I[new h.S(e.overscaledZ,w,s.z,v,s.y-1).key]={backfilled:!1}),s.y+1<a&&(I[new h.S(e.overscaledZ,d,s.z,l,s.y+1).key]={backfilled:!1},I[new h.S(e.overscaledZ,e.wrap,s.z,s.x,s.y+1).key]={backfilled:!1},I[new h.S(e.overscaledZ,w,s.z,v,s.y+1).key]={backfilled:!1}),I}unloadTile(e){return h._(this,void 0,void 0,function*(){e.demTexture&&this.map.painter.saveTileTexture(e.demTexture),e.fbo&&(e.fbo.destroy(),delete e.fbo),e.dem&&delete e.dem,delete e.neighboringTiles,e.state="unloaded",e.actor&&(yield e.actor.sendAsync({type:"RDT",data:{type:this.type,uid:e.uid,source:this.id}}))})}}class Qr extends h.E{constructor(e,s,a,l){super(),this.id=e,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=a.getActor(),this.setEventedParent(l),this._data=s.data,this._options=h.e({},s),this._collectResourceTiming=s.collectResourceTiming,s.maxzoom!==void 0&&(this.maxzoom=s.maxzoom),s.type&&(this.type=s.type),s.attribution&&(this.attribution=s.attribution),this.promoteId=s.promoteId;const d=h.X/this.tileSize;s.clusterMaxZoom!==void 0&&this.maxzoom<=s.clusterMaxZoom&&h.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${s.clusterMaxZoom}".`),this.workerOptions=h.e({source:this.id,cluster:s.cluster||!1,geojsonVtOptions:{buffer:(s.buffer!==void 0?s.buffer:128)*d,tolerance:(s.tolerance!==void 0?s.tolerance:.375)*d,extent:h.X,maxZoom:this.maxzoom,lineMetrics:s.lineMetrics||!1,generateId:s.generateId||!1},superclusterOptions:{maxZoom:s.clusterMaxZoom!==void 0?s.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,s.clusterMinPoints||2),extent:h.X,radius:(s.clusterRadius||50)*d,log:!1,generateId:s.generateId||!1},clusterProperties:s.clusterProperties,filter:s.filter},s.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}load(){return h._(this,void 0,void 0,function*(){yield this._updateWorkerData()})}onAdd(e){this.map=e,this.load()}setData(e){return this._data=e,this._updateWorkerData(),this}updateData(e){return this._updateWorkerData(e),this}getData(){return h._(this,void 0,void 0,function*(){const e=h.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:e})})}setClusterOptions(e){return this.workerOptions.cluster=e.cluster,e&&(e.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=e.clusterRadius),e.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=e.clusterMaxZoom)),this._updateWorkerData(),this}getClusterExpansionZoom(e){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:e,source:this.id}})}getClusterChildren(e){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:e,source:this.id}})}getClusterLeaves(e,s,a){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:e,limit:s,offset:a}})}_updateWorkerData(e){return h._(this,void 0,void 0,function*(){const s=h.e({type:this.type},this.workerOptions);e?s.dataDiff=e:typeof this._data=="string"?(s.request=this.map._requestManager.transformRequest(J.resolveURL(this._data),"Source"),s.request.collectResourceTiming=this._collectResourceTiming):s.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new h.k("dataloading",{dataType:"source"}));try{const a=yield this.actor.sendAsync({type:"LD",data:s});if(this._pendingLoads--,this._removed||a.abandoned)return void this.fire(new h.k("dataabort",{dataType:"source"}));let l=null;a.resourceTiming&&a.resourceTiming[this.id]&&(l=a.resourceTiming[this.id].slice(0));const d={dataType:"source"};this._collectResourceTiming&&l&&l.length>0&&h.e(d,{resourceTiming:l}),this.fire(new h.k("data",Object.assign(Object.assign({},d),{sourceDataType:"metadata"}))),this.fire(new h.k("data",Object.assign(Object.assign({},d),{sourceDataType:"content"})))}catch(a){if(this._pendingLoads--,this._removed)return void this.fire(new h.k("dataabort",{dataType:"source"}));this.fire(new h.j(a))}})}loaded(){return this._pendingLoads===0}loadTile(e){return h._(this,void 0,void 0,function*(){const s=e.actor?"RT":"LT";e.actor=this.actor;const a={type:this.type,uid:e.uid,tileID:e.tileID,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};e.abortController=new AbortController;const l=yield this.actor.sendAsync({type:s,data:a},e.abortController);delete e.abortController,e.unloadVectorData(),e.aborted||e.loadVectorData(l,this.map.painter,s==="RT")})}abortTile(e){return h._(this,void 0,void 0,function*(){e.abortController&&(e.abortController.abort(),delete e.abortController),e.aborted=!0})}unloadTile(e){return h._(this,void 0,void 0,function*(){e.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:e.uid,type:this.type,source:this.id}})})}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return h.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}var es=h.Y([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class vr extends h.E{constructor(e,s,a,l){super(),this.id=e,this.dispatcher=a,this.coordinates=s.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(l),this.options=s}load(e){return h._(this,void 0,void 0,function*(){this._loaded=!1,this.fire(new h.k("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const s=yield Ct.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,s&&s.data&&(this.image=s.data,e&&(this.coordinates=e),this._finishLoading())}catch(s){this._request=null,this._loaded=!0,this.fire(new h.j(s))}})}loaded(){return this._loaded}updateImage(e){return e.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=e.url,this.load(e.coordinates).finally(()=>{this.texture=null}),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new h.k("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(e){this.coordinates=e;const s=e.map(h.Z.fromLngLat);this.tileID=function(l){let d=1/0,v=1/0,w=-1/0,I=-1/0;for(const O of l)d=Math.min(d,O.x),v=Math.min(v,O.y),w=Math.max(w,O.x),I=Math.max(I,O.y);const A=Math.max(w-d,I-v),C=Math.max(0,Math.floor(-Math.log(A)/Math.LN2)),M=Math.pow(2,C);return new h.a1(C,Math.floor((d+w)/2*M),Math.floor((v+I)/2*M))}(s),this.minzoom=this.maxzoom=this.tileID.z;const a=s.map(l=>this.tileID.getTilePoint(l)._round());return this._boundsArray=new h.$,this._boundsArray.emplaceBack(a[0].x,a[0].y,0,0),this._boundsArray.emplaceBack(a[1].x,a[1].y,h.X,0),this._boundsArray.emplaceBack(a[3].x,a[3].y,0,h.X),this._boundsArray.emplaceBack(a[2].x,a[2].y,h.X,h.X),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this.fire(new h.k("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const e=this.map.painter.context,s=e.gl;this.boundsBuffer||(this.boundsBuffer=e.createVertexBuffer(this._boundsArray,es.members)),this.boundsSegments||(this.boundsSegments=h.a0.simpleSegment(0,0,4,2)),this.texture||(this.texture=new Lt(e,this.image,s.RGBA),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE));let a=!1;for(const l in this.tiles){const d=this.tiles[l];d.state!=="loaded"&&(d.state="loaded",d.texture=this.texture,a=!0)}a&&this.fire(new h.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(e){return h._(this,void 0,void 0,function*(){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={}):e.state="errored"})}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class Ki extends vr{constructor(e,s,a,l){super(e,s,a,l),this.roundZoom=!0,this.type="video",this.options=s}load(){return h._(this,void 0,void 0,function*(){this._loaded=!1;const e=this.options;this.urls=[];for(const s of e.urls)this.urls.push(this.map._requestManager.transformRequest(s,"Source").url);try{const s=yield h.a3(this.urls);if(this._loaded=!0,!s)return;this.video=s,this.video.loop=!0,this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading()}catch(s){this.fire(new h.j(s))}})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(e){if(this.video){const s=this.video.seekable;e<s.start(0)||e>s.end(0)?this.fire(new h.j(new h.a2(`sources.${this.id}`,null,`Playback for this video can be set only between the ${s.start(0)} and ${s.end(0)}-second mark.`))):this.video.currentTime=e}}getVideo(){return this.video}onAdd(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const e=this.map.painter.context,s=e.gl;this.boundsBuffer||(this.boundsBuffer=e.createVertexBuffer(this._boundsArray,es.members)),this.boundsSegments||(this.boundsSegments=h.a0.simpleSegment(0,0,4,2)),this.texture?this.video.paused||(this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE),s.texSubImage2D(s.TEXTURE_2D,0,0,0,s.RGBA,s.UNSIGNED_BYTE,this.video)):(this.texture=new Lt(e,this.video,s.RGBA),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE));let a=!1;for(const l in this.tiles){const d=this.tiles[l];d.state!=="loaded"&&(d.state="loaded",d.texture=this.texture,a=!0)}a&&this.fire(new h.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class br extends vr{constructor(e,s,a,l){super(e,s,a,l),s.coordinates?Array.isArray(s.coordinates)&&s.coordinates.length===4&&!s.coordinates.some(d=>!Array.isArray(d)||d.length!==2||d.some(v=>typeof v!="number"))||this.fire(new h.j(new h.a2(`sources.${e}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new h.j(new h.a2(`sources.${e}`,null,'missing required property "coordinates"'))),s.animate&&typeof s.animate!="boolean"&&this.fire(new h.j(new h.a2(`sources.${e}`,null,'optional "animate" property must be a boolean value'))),s.canvas?typeof s.canvas=="string"||s.canvas instanceof HTMLCanvasElement||this.fire(new h.j(new h.a2(`sources.${e}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new h.j(new h.a2(`sources.${e}`,null,'missing required property "canvas"'))),this.options=s,this.animate=s.animate===void 0||s.animate}load(){return h._(this,void 0,void 0,function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new h.j(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())})}getCanvas(){return this.canvas}onAdd(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let e=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,e=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,e=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const s=this.map.painter.context,a=s.gl;this.boundsBuffer||(this.boundsBuffer=s.createVertexBuffer(this._boundsArray,es.members)),this.boundsSegments||(this.boundsSegments=h.a0.simpleSegment(0,0,4,2)),this.texture?(e||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new Lt(s,this.canvas,a.RGBA,{premultiply:!0});let l=!1;for(const d in this.tiles){const v=this.tiles[d];v.state!=="loaded"&&(v.state="loaded",v.texture=this.texture,l=!0)}l&&this.fire(new h.k("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const e of[this.canvas.width,this.canvas.height])if(isNaN(e)||e<=0)return!0;return!1}}const an={},ln=p=>{switch(p){case"geojson":return Qr;case"image":return vr;case"raster":return Gt;case"raster-dem":return Si;case"vector":return on;case"video":return Ki;case"canvas":return br}return an[p]},Oe="RTLPluginLoaded";class Zr extends h.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=Gs()}_syncState(e){return this.status=e,this.dispatcher.broadcast("SRPS",{pluginStatus:e,pluginURL:this.url}).catch(s=>{throw this.status="error",s})}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(e){return h._(this,arguments,void 0,function*(s,a=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=J.resolveURL(s),!this.url)throw new Error(`requested url ${s} is invalid`);if(this.status==="unavailable"){if(!a)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()})}_requestImport(){return h._(this,void 0,void 0,function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new h.k(Oe))})}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let Yi=null;function Wr(){return Yi||(Yi=new Zr),Yi}class ts{constructor(e,s){this.timeAdded=0,this.fadeEndTime=0,this.tileID=e,this.uid=h.a4(),this.uses=0,this.tileSize=s,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(e){const s=e+this.timeAdded;s<this.fadeEndTime||(this.fadeEndTime=s)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(e){this.demTexture&&e.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(e,s,a){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",e){e.featureIndex&&(this.latestFeatureIndex=e.featureIndex,e.rawTileData?(this.latestRawTileData=e.rawTileData,this.latestFeatureIndex.rawTileData=e.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=e.collisionBoxArray,this.buckets=function(l,d){const v={};if(!d)return v;for(const w of l){const I=w.layerIds.map(A=>d.getLayer(A)).filter(Boolean);if(I.length!==0){w.layers=I,w.stateDependentLayerIds&&(w.stateDependentLayers=w.stateDependentLayerIds.map(A=>I.filter(C=>C.id===A)[0]));for(const A of I)v[A.id]=w}}return v}(e.buckets,s.style),this.hasSymbolBuckets=!1;for(const l in this.buckets){const d=this.buckets[l];if(d instanceof h.a6){if(this.hasSymbolBuckets=!0,!a)break;d.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const l in this.buckets){const d=this.buckets[l];if(d instanceof h.a6&&d.hasRTLText){this.hasRTLText=!0,Wr().lazyLoad();break}}this.queryPadding=0;for(const l in this.buckets){const d=this.buckets[l];this.queryPadding=Math.max(this.queryPadding,s.style.getLayer(l).queryRadius(d))}e.imageAtlas&&(this.imageAtlas=e.imageAtlas),e.glyphAtlasImage&&(this.glyphAtlasImage=e.glyphAtlasImage)}else this.collisionBoxArray=new h.a5}unloadVectorData(){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(e){return this.buckets[e.id]}upload(e){for(const a in this.buckets){const l=this.buckets[a];l.uploadPending()&&l.upload(e)}const s=e.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new Lt(e,this.imageAtlas.image,s.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new Lt(e,this.glyphAtlasImage,s.ALPHA),this.glyphAtlasImage=null)}prepare(e){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture)}queryRenderedFeatures(e,s,a,l,d,v,w,I,A,C){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:l,cameraQueryGeometry:d,scale:v,tileSize:this.tileSize,pixelPosMatrix:C,transform:I,params:w,queryPadding:this.queryPadding*A},e,s,a):{}}querySourceFeatures(e,s){const a=this.latestFeatureIndex;if(!a||!a.rawTileData)return;const l=a.loadVTLayers(),d=s&&s.sourceLayer?s.sourceLayer:"",v=l._geojsonTileLayer||l[d];if(!v)return;const w=h.a7(s&&s.filter),{z:I,x:A,y:C}=this.tileID.canonical,M={z:I,x:A,y:C};for(let O=0;O<v.length;O++){const V=v.feature(O);if(w.needGeometry){const re=h.a8(V,!0);if(!w.filter(new h.z(this.tileID.overscaledZ),re,this.tileID.canonical))continue}else if(!w.filter(new h.z(this.tileID.overscaledZ),V))continue;const H=a.getId(V,d),ee=new h.a9(V,I,A,C,H);ee.tile=M,e.push(ee)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(e){const s=this.expirationTime;if(e.cacheControl){const a=h.aa(e.cacheControl);a["max-age"]&&(this.expirationTime=Date.now()+1e3*a["max-age"])}else e.expires&&(this.expirationTime=new Date(e.expires).getTime());if(this.expirationTime){const a=Date.now();let l=!1;if(this.expirationTime>a)l=!1;else if(s)if(this.expirationTime<s)l=!0;else{const d=this.expirationTime-s;d?this.expirationTime=a+Math.max(d,3e4):l=!0}else l=!0;l?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(e,s){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(e).length===0)return;const a=this.latestFeatureIndex.loadVTLayers();for(const l in this.buckets){if(!s.style.hasLayer(l))continue;const d=this.buckets[l],v=d.layers[0].sourceLayer||"_geojsonTileLayer",w=a[v],I=e[v];if(!w||!I||Object.keys(I).length===0)continue;d.update(I,w,this.imageAtlas&&this.imageAtlas.patternPositions||{});const A=s&&s.style&&s.style.getLayer(l);A&&(this.queryPadding=Math.max(this.queryPadding,A.queryRadius(d)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<J.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(e){this.symbolFadeHoldUntil=J.now()+e}setDependencies(e,s){const a={};for(const l of s)a[l]=!0;this.dependencies[e]=a}hasDependency(e,s){for(const a of e){const l=this.dependencies[a];if(l){for(const d of s)if(l[d])return!0}}return!1}}class je{constructor(e,s){this.max=e,this.onRemove=s,this.reset()}reset(){for(const e in this.data)for(const s of this.data[e])s.timeout&&clearTimeout(s.timeout),this.onRemove(s.value);return this.data={},this.order=[],this}add(e,s,a){const l=e.wrapped().key;this.data[l]===void 0&&(this.data[l]=[]);const d={value:s,timeout:void 0};if(a!==void 0&&(d.timeout=setTimeout(()=>{this.remove(e,d)},a)),this.data[l].push(d),this.order.push(l),this.order.length>this.max){const v=this._getAndRemoveByKey(this.order[0]);v&&this.onRemove(v)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const s=this.data[e].shift();return s.timeout&&clearTimeout(s.timeout),this.data[e].length===0&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),s.value}getByKey(e){const s=this.data[e];return s?s[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,s){if(!this.has(e))return this;const a=e.wrapped().key,l=s===void 0?0:this.data[a].indexOf(s),d=this.data[a][l];return this.data[a].splice(l,1),d.timeout&&clearTimeout(d.timeout),this.data[a].length===0&&delete this.data[a],this.onRemove(d.value),this.order.splice(this.order.indexOf(a),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const s=this._getAndRemoveByKey(this.order[0]);s&&this.onRemove(s)}return this}filter(e){const s=[];for(const a in this.data)for(const l of this.data[a])e(l.value)||s.push(l);for(const a of s)this.remove(a.value.tileID,a)}}class St{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,s,a){const l=String(s);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][l]=this.stateChanges[e][l]||{},h.e(this.stateChanges[e][l],a),this.deletedStates[e]===null){this.deletedStates[e]={};for(const d in this.state[e])d!==l&&(this.deletedStates[e][d]=null)}else if(this.deletedStates[e]&&this.deletedStates[e][l]===null){this.deletedStates[e][l]={};for(const d in this.state[e][l])a[d]||(this.deletedStates[e][l][d]=null)}else for(const d in a)this.deletedStates[e]&&this.deletedStates[e][l]&&this.deletedStates[e][l][d]===null&&delete this.deletedStates[e][l][d]}removeFeatureState(e,s,a){if(this.deletedStates[e]===null)return;const l=String(s);if(this.deletedStates[e]=this.deletedStates[e]||{},a&&s!==void 0)this.deletedStates[e][l]!==null&&(this.deletedStates[e][l]=this.deletedStates[e][l]||{},this.deletedStates[e][l][a]=null);else if(s!==void 0)if(this.stateChanges[e]&&this.stateChanges[e][l])for(a in this.deletedStates[e][l]={},this.stateChanges[e][l])this.deletedStates[e][l][a]=null;else this.deletedStates[e][l]=null;else this.deletedStates[e]=null}getState(e,s){const a=String(s),l=h.e({},(this.state[e]||{})[a],(this.stateChanges[e]||{})[a]);if(this.deletedStates[e]===null)return{};if(this.deletedStates[e]){const d=this.deletedStates[e][s];if(d===null)return{};for(const v in d)delete l[v]}return l}initializeTileState(e,s){e.setFeatureState(this.state,s)}coalesceChanges(e,s){const a={};for(const l in this.stateChanges){this.state[l]=this.state[l]||{};const d={};for(const v in this.stateChanges[l])this.state[l][v]||(this.state[l][v]={}),h.e(this.state[l][v],this.stateChanges[l][v]),d[v]=this.state[l][v];a[l]=d}for(const l in this.deletedStates){this.state[l]=this.state[l]||{};const d={};if(this.deletedStates[l]===null)for(const v in this.state[l])d[v]={},this.state[l][v]={};else for(const v in this.deletedStates[l]){if(this.deletedStates[l][v]===null)this.state[l][v]={};else for(const w of Object.keys(this.deletedStates[l][v]))delete this.state[l][v][w];d[v]=this.state[l][v]}a[l]=a[l]||{},h.e(a[l],d)}if(this.stateChanges={},this.deletedStates={},Object.keys(a).length!==0)for(const l in e)e[l].setFeatureState(a,s)}}class pt extends h.E{constructor(e,s,a){super(),this.id=e,this.dispatcher=a,this.on("data",l=>this._dataHandler(l)),this.on("dataloading",()=>{this._sourceErrored=!1}),this.on("error",()=>{this._sourceErrored=this._source.loaded()}),this._source=((l,d,v,w)=>{const I=new(ln(d.type))(l,d,v,w);if(I.id!==l)throw new Error(`Expected Source id to be ${l} instead of ${I.id}`);return I})(e,s,a,this),this._tiles={},this._cache=new je(0,l=>this._unloadTile(l)),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new St,this._didEmitContent=!1,this._updated=!1}onAdd(e){this.map=e,this._maxTileCacheSize=e?e._maxTileCacheSize:null,this._maxTileCacheZoomLevels=e?e._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(e)}onRemove(e){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(e)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const e in this._tiles){const s=this._tiles[e];if(s.state!=="loaded"&&s.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(e,s,a){return h._(this,void 0,void 0,function*(){try{yield this._source.loadTile(e),this._tileLoaded(e,s,a)}catch(l){e.state="errored",l.status!==404?this._source.fire(new h.j(l,{tile:e})):this.update(this.transform,this.terrain)}})}_unloadTile(e){this._source.unloadTile&&this._source.unloadTile(e)}_abortTile(e){this._source.abortTile&&this._source.abortTile(e),this._source.fire(new h.k("dataabort",{tile:e,coord:e.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const s in this._tiles){const a=this._tiles[s];a.upload(e),a.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map(e=>e.tileID).sort(Qi).map(e=>e.key)}getRenderableIds(e){const s=[];for(const a in this._tiles)this._isIdRenderable(a,e)&&s.push(this._tiles[a]);return e?s.sort((a,l)=>{const d=a.tileID,v=l.tileID,w=new h.P(d.canonical.x,d.canonical.y)._rotate(this.transform.angle),I=new h.P(v.canonical.x,v.canonical.y)._rotate(this.transform.angle);return d.overscaledZ-v.overscaledZ||I.y-w.y||I.x-w.x}).map(a=>a.tileID.key):s.map(a=>a.tileID).sort(Qi).map(a=>a.key)}hasRenderableParent(e){const s=this.findLoadedParent(e,0);return!!s&&this._isIdRenderable(s.tileID.key)}_isIdRenderable(e,s){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(s||!this._tiles[e].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const e in this._tiles)this._tiles[e].state!=="errored"&&this._reloadTile(e,"reloading")}}_reloadTile(e,s){return h._(this,void 0,void 0,function*(){const a=this._tiles[e];a&&(a.state!=="loading"&&(a.state=s),yield this._loadTile(a,e,s))})}_tileLoaded(e,s,a){e.timeAdded=J.now(),a==="expired"&&(e.refreshedUponExpiration=!0),this._setTileReloadTimer(s,e),this.getSource().type==="raster-dem"&&e.dem&&this._backfillDEM(e),this._state.initializeTileState(e,this.map?this.map.painter:null),e.aborted||this._source.fire(new h.k("data",{dataType:"source",tile:e,coord:e.tileID}))}_backfillDEM(e){const s=this.getRenderableIds();for(let l=0;l<s.length;l++){const d=s[l];if(e.neighboringTiles&&e.neighboringTiles[d]){const v=this.getTileByID(d);a(e,v),a(v,e)}}function a(l,d){l.needsHillshadePrepare=!0,l.needsTerrainPrepare=!0;let v=d.tileID.canonical.x-l.tileID.canonical.x;const w=d.tileID.canonical.y-l.tileID.canonical.y,I=Math.pow(2,l.tileID.canonical.z),A=d.tileID.key;v===0&&w===0||Math.abs(w)>1||(Math.abs(v)>1&&(Math.abs(v+I)===1?v+=I:Math.abs(v-I)===1&&(v-=I)),d.dem&&l.dem&&(l.dem.backfillBorder(d.dem,v,w),l.neighboringTiles&&l.neighboringTiles[A]&&(l.neighboringTiles[A].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,s,a,l){for(const d in this._tiles){let v=this._tiles[d];if(l[d]||!v.hasData()||v.tileID.overscaledZ<=s||v.tileID.overscaledZ>a)continue;let w=v.tileID;for(;v&&v.tileID.overscaledZ>s+1;){const A=v.tileID.scaledTo(v.tileID.overscaledZ-1);v=this._tiles[A.key],v&&v.hasData()&&(w=A)}let I=w;for(;I.overscaledZ>s;)if(I=I.scaledTo(I.overscaledZ-1),e[I.key]){l[w.key]=w;break}}}findLoadedParent(e,s){if(e.key in this._loadedParentTiles){const a=this._loadedParentTiles[e.key];return a&&a.tileID.overscaledZ>=s?a:null}for(let a=e.overscaledZ-1;a>=s;a--){const l=e.scaledTo(a),d=this._getLoadedTile(l);if(d)return d}}findLoadedSibling(e){return this._getLoadedTile(e)}_getLoadedTile(e){const s=this._tiles[e.key];return s&&s.hasData()?s:this._cache.getByKey(e.wrapped().key)}updateCacheSize(e){const s=Math.ceil(e.width/this._source.tileSize)+1,a=Math.ceil(e.height/this._source.tileSize)+1,l=Math.floor(s*a*(this._maxTileCacheZoomLevels===null?h.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),d=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,l):l;this._cache.setMaxSize(d)}handleWrapJump(e){const s=Math.round((e-(this._prevLng===void 0?e:this._prevLng))/360);if(this._prevLng=e,s){const a={};for(const l in this._tiles){const d=this._tiles[l];d.tileID=d.tileID.unwrapTo(d.tileID.wrap+s),a[d.tileID.key]=d}this._tiles=a;for(const l in this._timers)clearTimeout(this._timers[l]),delete this._timers[l];for(const l in this._tiles)this._setTileReloadTimer(l,this._tiles[l])}}_updateCoveredAndRetainedTiles(e,s,a,l,d,v){const w={},I={},A=Object.keys(e),C=J.now();for(const M of A){const O=e[M],V=this._tiles[M];if(!V||V.fadeEndTime!==0&&V.fadeEndTime<=C)continue;const H=this.findLoadedParent(O,s),ee=this.findLoadedSibling(O),re=H||ee||null;re&&(this._addTile(re.tileID),w[re.tileID.key]=re.tileID),I[M]=O}this._retainLoadedChildren(I,l,a,e);for(const M in w)e[M]||(this._coveredTiles[M]=!0,e[M]=w[M]);if(v){const M={},O={};for(const V of d)this._tiles[V.key].hasData()?M[V.key]=V:O[V.key]=V;for(const V in O){const H=O[V].children(this._source.maxzoom);this._tiles[H[0].key]&&this._tiles[H[1].key]&&this._tiles[H[2].key]&&this._tiles[H[3].key]&&(M[H[0].key]=e[H[0].key]=H[0],M[H[1].key]=e[H[1].key]=H[1],M[H[2].key]=e[H[2].key]=H[2],M[H[3].key]=e[H[3].key]=H[3],delete O[V])}for(const V in O){const H=O[V],ee=this.findLoadedParent(H,this._source.minzoom),re=this.findLoadedSibling(H),se=ee||re||null;if(se){M[se.tileID.key]=e[se.tileID.key]=se.tileID;for(const ae in M)M[ae].isChildOf(se.tileID)&&delete M[ae]}}for(const V in this._tiles)M[V]||(this._coveredTiles[V]=!0)}}update(e,s){if(!this._sourceLoaded||this._paused)return;let a;this.transform=e,this.terrain=s,this.updateCacheSize(e),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?a=e.getVisibleUnwrappedCoordinates(this._source.tileID).map(C=>new h.S(C.canonical.z,C.wrap,C.canonical.z,C.canonical.x,C.canonical.y)):(a=e.coveringTiles({tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:s}),this._source.hasTile&&(a=a.filter(C=>this._source.hasTile(C)))):a=[];const l=e.coveringZoomLevel(this._source),d=Math.max(l-pt.maxOverzooming,this._source.minzoom),v=Math.max(l+pt.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const C={};for(const M of a)if(M.canonical.z>this._source.minzoom){const O=M.scaledTo(M.canonical.z-1);C[O.key]=O;const V=M.scaledTo(Math.max(this._source.minzoom,Math.min(M.canonical.z,5)));C[V.key]=V}a=a.concat(Object.values(C))}const w=a.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,w&&this.fire(new h.k("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const I=this._updateRetainedTiles(a,l);ur(this._source.type)&&this._updateCoveredAndRetainedTiles(I,d,v,l,a,s);for(const C in I)this._tiles[C].clearFadeHold();const A=h.ab(this._tiles,I);for(const C of A){const M=this._tiles[C];M.hasSymbolBuckets&&!M.holdingForFade()?M.setHoldDuration(this.map._fadeDuration):M.hasSymbolBuckets&&!M.symbolFadeFinished()||this._removeTile(C)}this._updateLoadedParentTileCache(),this._updateLoadedSiblingTileCache()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(e)}_updateRetainedTiles(e,s){var a;const l={},d={},v=Math.max(s-pt.maxOverzooming,this._source.minzoom),w=Math.max(s+pt.maxUnderzooming,this._source.minzoom),I={};for(const A of e){const C=this._addTile(A);l[A.key]=A,C.hasData()||s<this._source.maxzoom&&(I[A.key]=A)}this._retainLoadedChildren(I,s,w,l);for(const A of e){let C=this._tiles[A.key];if(C.hasData())continue;if(s+1>this._source.maxzoom){const O=A.children(this._source.maxzoom)[0],V=this.getTile(O);if(V&&V.hasData()){l[O.key]=O;continue}}else{const O=A.children(this._source.maxzoom);if(l[O[0].key]&&l[O[1].key]&&l[O[2].key]&&l[O[3].key])continue}let M=C.wasRequested();for(let O=A.overscaledZ-1;O>=v;--O){const V=A.scaledTo(O);if(d[V.key])break;if(d[V.key]=!0,C=this.getTile(V),!C&&M&&(C=this._addTile(V)),C){const H=C.hasData();if((H||!(!((a=this.map)===null||a===void 0)&&a.cancelPendingTileRequestsWhileZooming)||M)&&(l[V.key]=V),M=C.wasRequested(),H)break}}}return l}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const s=[];let a,l=this._tiles[e].tileID;for(;l.overscaledZ>0;){if(l.key in this._loadedParentTiles){a=this._loadedParentTiles[l.key];break}s.push(l.key);const d=l.scaledTo(l.overscaledZ-1);if(a=this._getLoadedTile(d),a)break;l=d}for(const d of s)this._loadedParentTiles[d]=a}}_updateLoadedSiblingTileCache(){this._loadedSiblingTiles={};for(const e in this._tiles){const s=this._tiles[e].tileID,a=this._getLoadedTile(s);this._loadedSiblingTiles[s.key]=a}}_addTile(e){let s=this._tiles[e.key];if(s)return s;s=this._cache.getAndRemove(e),s&&(this._setTileReloadTimer(e.key,s),s.tileID=e,this._state.initializeTileState(s,this.map?this.map.painter:null),this._cacheTimers[e.key]&&(clearTimeout(this._cacheTimers[e.key]),delete this._cacheTimers[e.key],this._setTileReloadTimer(e.key,s)));const a=s;return s||(s=new ts(e,this._source.tileSize*e.overscaleFactor()),this._loadTile(s,e.key,s.state)),s.uses++,this._tiles[e.key]=s,a||this._source.fire(new h.k("dataloading",{tile:s,coord:s.tileID,dataType:"source"})),s}_setTileReloadTimer(e,s){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const a=s.getExpiryTimeout();a&&(this._timers[e]=setTimeout(()=>{this._reloadTile(e,"expired"),delete this._timers[e]},a))}_removeTile(e){const s=this._tiles[e];s&&(s.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),s.uses>0||(s.hasData()&&s.state!=="reloading"?this._cache.add(s.tileID,s,s.getExpiryTimeout()):(s.aborted=!0,this._abortTile(s),this._unloadTile(s))))}_dataHandler(e){const s=e.sourceDataType;e.dataType==="source"&&s==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&e.dataType==="source"&&s==="content"&&(this.reload(),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(e);this._cache.reset()}tilesIn(e,s,a){const l=[],d=this.transform;if(!d)return l;const v=a?d.getCameraQueryGeometry(e):e,w=e.map(H=>d.pointCoordinate(H,this.terrain)),I=v.map(H=>d.pointCoordinate(H,this.terrain)),A=this.getIds();let C=1/0,M=1/0,O=-1/0,V=-1/0;for(const H of I)C=Math.min(C,H.x),M=Math.min(M,H.y),O=Math.max(O,H.x),V=Math.max(V,H.y);for(let H=0;H<A.length;H++){const ee=this._tiles[A[H]];if(ee.holdingForFade())continue;const re=ee.tileID,se=Math.pow(2,d.zoom-ee.tileID.overscaledZ),ae=s*ee.queryPadding*h.X/ee.tileSize/se,Y=[re.getTilePoint(new h.Z(C,M)),re.getTilePoint(new h.Z(O,V))];if(Y[0].x-ae<h.X&&Y[0].y-ae<h.X&&Y[1].x+ae>=0&&Y[1].y+ae>=0){const ue=w.map(ye=>re.getTilePoint(ye)),pe=I.map(ye=>re.getTilePoint(ye));l.push({tile:ee,tileID:re,queryGeometry:ue,cameraQueryGeometry:pe,scale:se})}}return l}getVisibleCoordinates(e){const s=this.getRenderableIds(e).map(a=>this._tiles[a].tileID);for(const a of s)a.posMatrix=this.transform.calculatePosMatrix(a.toUnwrapped());return s}hasTransition(){if(this._source.hasTransition())return!0;if(ur(this._source.type)){const e=J.now();for(const s in this._tiles)if(this._tiles[s].fadeEndTime>=e)return!0}return!1}setFeatureState(e,s,a){this._state.updateState(e=e||"_geojsonTileLayer",s,a)}removeFeatureState(e,s,a){this._state.removeFeatureState(e=e||"_geojsonTileLayer",s,a)}getFeatureState(e,s){return this._state.getState(e=e||"_geojsonTileLayer",s)}setDependencies(e,s,a){const l=this._tiles[e];l&&l.setDependencies(s,a)}reloadTilesForDependencies(e,s){for(const a in this._tiles)this._tiles[a].hasDependency(e,s)&&this._reloadTile(a,"reloading");this._cache.filter(a=>!a.hasDependency(e,s))}}function Qi(p,e){const s=Math.abs(2*p.wrap)-+(p.wrap<0),a=Math.abs(2*e.wrap)-+(e.wrap<0);return p.overscaledZ-e.overscaledZ||a-s||e.canonical.y-p.canonical.y||e.canonical.x-p.canonical.x}function ur(p){return p==="raster"||p==="image"||p==="video"}pt.maxOverzooming=10,pt.maxUnderzooming=3;class vt{constructor(e,s){this.reset(e,s)}reset(e,s){this.points=e||[],this._distances=[0];for(let a=1;a<this.points.length;a++)this._distances[a]=this._distances[a-1]+this.points[a].dist(this.points[a-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(s||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(e){if(this.points.length===1)return this.points[0];e=h.ac(e,0,1);let s=1,a=this._distances[s];const l=e*this.paddedLength+this.padding;for(;a<l&&s<this._distances.length;)a=this._distances[++s];const d=s-1,v=this._distances[d],w=a-v,I=w>0?(l-v)/w:0;return this.points[d].mult(1-I).add(this.points[s].mult(I))}}function dr(p,e){let s=!0;return p==="always"||p!=="never"&&e!=="never"||(s=!1),s}class Fr{constructor(e,s,a){const l=this.boxCells=[],d=this.circleCells=[];this.xCellCount=Math.ceil(e/a),this.yCellCount=Math.ceil(s/a);for(let v=0;v<this.xCellCount*this.yCellCount;v++)l.push([]),d.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=e,this.height=s,this.xScale=this.xCellCount/e,this.yScale=this.yCellCount/s,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(e,s,a,l,d){this._forEachCell(s,a,l,d,this._insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(s),this.bboxes.push(a),this.bboxes.push(l),this.bboxes.push(d)}insertCircle(e,s,a,l){this._forEachCell(s-l,a-l,s+l,a+l,this._insertCircleCell,this.circleUid++),this.circleKeys.push(e),this.circles.push(s),this.circles.push(a),this.circles.push(l)}_insertBoxCell(e,s,a,l,d,v){this.boxCells[d].push(v)}_insertCircleCell(e,s,a,l,d,v){this.circleCells[d].push(v)}_query(e,s,a,l,d,v,w){if(a<0||e>this.width||l<0||s>this.height)return[];const I=[];if(e<=0&&s<=0&&this.width<=a&&this.height<=l){if(d)return[{key:null,x1:e,y1:s,x2:a,y2:l}];for(let A=0;A<this.boxKeys.length;A++)I.push({key:this.boxKeys[A],x1:this.bboxes[4*A],y1:this.bboxes[4*A+1],x2:this.bboxes[4*A+2],y2:this.bboxes[4*A+3]});for(let A=0;A<this.circleKeys.length;A++){const C=this.circles[3*A],M=this.circles[3*A+1],O=this.circles[3*A+2];I.push({key:this.circleKeys[A],x1:C-O,y1:M-O,x2:C+O,y2:M+O})}}else this._forEachCell(e,s,a,l,this._queryCell,I,{hitTest:d,overlapMode:v,seenUids:{box:{},circle:{}}},w);return I}query(e,s,a,l){return this._query(e,s,a,l,!1,null)}hitTest(e,s,a,l,d,v){return this._query(e,s,a,l,!0,d,v).length>0}hitTestCircle(e,s,a,l,d){const v=e-a,w=e+a,I=s-a,A=s+a;if(w<0||v>this.width||A<0||I>this.height)return!1;const C=[];return this._forEachCell(v,I,w,A,this._queryCellCircle,C,{hitTest:!0,overlapMode:l,circle:{x:e,y:s,radius:a},seenUids:{box:{},circle:{}}},d),C.length>0}_queryCell(e,s,a,l,d,v,w,I){const{seenUids:A,hitTest:C,overlapMode:M}=w,O=this.boxCells[d];if(O!==null){const H=this.bboxes;for(const ee of O)if(!A.box[ee]){A.box[ee]=!0;const re=4*ee,se=this.boxKeys[ee];if(e<=H[re+2]&&s<=H[re+3]&&a>=H[re+0]&&l>=H[re+1]&&(!I||I(se))&&(!C||!dr(M,se.overlapMode))&&(v.push({key:se,x1:H[re],y1:H[re+1],x2:H[re+2],y2:H[re+3]}),C))return!0}}const V=this.circleCells[d];if(V!==null){const H=this.circles;for(const ee of V)if(!A.circle[ee]){A.circle[ee]=!0;const re=3*ee,se=this.circleKeys[ee];if(this._circleAndRectCollide(H[re],H[re+1],H[re+2],e,s,a,l)&&(!I||I(se))&&(!C||!dr(M,se.overlapMode))){const ae=H[re],Y=H[re+1],ue=H[re+2];if(v.push({key:se,x1:ae-ue,y1:Y-ue,x2:ae+ue,y2:Y+ue}),C)return!0}}}return!1}_queryCellCircle(e,s,a,l,d,v,w,I){const{circle:A,seenUids:C,overlapMode:M}=w,O=this.boxCells[d];if(O!==null){const H=this.bboxes;for(const ee of O)if(!C.box[ee]){C.box[ee]=!0;const re=4*ee,se=this.boxKeys[ee];if(this._circleAndRectCollide(A.x,A.y,A.radius,H[re+0],H[re+1],H[re+2],H[re+3])&&(!I||I(se))&&!dr(M,se.overlapMode))return v.push(!0),!0}}const V=this.circleCells[d];if(V!==null){const H=this.circles;for(const ee of V)if(!C.circle[ee]){C.circle[ee]=!0;const re=3*ee,se=this.circleKeys[ee];if(this._circlesCollide(H[re],H[re+1],H[re+2],A.x,A.y,A.radius)&&(!I||I(se))&&!dr(M,se.overlapMode))return v.push(!0),!0}}}_forEachCell(e,s,a,l,d,v,w,I){const A=this._convertToXCellCoord(e),C=this._convertToYCellCoord(s),M=this._convertToXCellCoord(a),O=this._convertToYCellCoord(l);for(let V=A;V<=M;V++)for(let H=C;H<=O;H++)if(d.call(this,e,s,a,l,this.xCellCount*H+V,v,w,I))return}_convertToXCellCoord(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)))}_convertToYCellCoord(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)))}_circlesCollide(e,s,a,l,d,v){const w=l-e,I=d-s,A=a+v;return A*A>w*w+I*I}_circleAndRectCollide(e,s,a,l,d,v,w){const I=(v-l)/2,A=Math.abs(e-(l+I));if(A>I+a)return!1;const C=(w-d)/2,M=Math.abs(s-(d+C));if(M>C+a)return!1;if(A<=I||M<=C)return!0;const O=A-I,V=M-C;return O*O+V*V<=a*a}}function Br(p,e,s,a,l){const d=h.H();return e?(h.K(d,d,[1/l,1/l,1]),s||h.ad(d,d,a.angle)):h.L(d,a.labelPlaneMatrix,p),d}function wr(p,e,s,a,l){if(e){const d=h.ae(p);return h.K(d,d,[l,l,1]),s||h.ad(d,d,-a.angle),d}return a.glCoordMatrix}function te(p,e,s,a){let l;a?(l=[p,e,a(p,e),1],h.af(l,l,s)):(l=[p,e,0,1],qt(l,l,s));const d=l[3];return{point:new h.P(l[0]/d,l[1]/d),signedDistanceFromCamera:d,isOccluded:!1}}function D(p,e){return .5+p/e*.5}function L(p,e){return p.x>=-e[0]&&p.x<=e[0]&&p.y>=-e[1]&&p.y<=e[1]}function j(p,e,s,a,l,d,v,w,I,A,C,M,O,V,H){const ee=a?p.textSizeData:p.iconSizeData,re=h.ag(ee,s.transform.zoom),se=[256/s.width*2+1,256/s.height*2+1],ae=a?p.text.dynamicLayoutVertexArray:p.icon.dynamicLayoutVertexArray;ae.clear();const Y=p.lineVertexArray,ue=a?p.text.placedSymbolArray:p.icon.placedSymbolArray,pe=s.transform.width/s.transform.height;let ye=!1;for(let Ce=0;Ce<ue.length;Ce++){const Re=ue.get(Ce);if(Re.hidden||Re.writingMode===h.ah.vertical&&!ye){ut(Re.numGlyphs,ae);continue}ye=!1;const qe=te(Re.anchorX,Re.anchorY,e,H);if(!L(qe.point,se)){ut(Re.numGlyphs,ae);continue}const Je=D(s.transform.cameraToCenterDistance,qe.signedDistanceFromCamera),Ne=h.ai(ee,re,Re),Be=v?Ne/Je:Ne*Je,rt={getElevation:H,labelPlaneMatrix:l,lineVertexArray:Y,pitchWithMap:v,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},projection:A,tileAnchorPoint:new h.P(Re.anchorX,Re.anchorY),unwrappedTileID:C,width:M,height:O,translation:V},It=he(rt,Re,Be,!1,w,e,d,p.glyphOffsetArray,ae,pe,I);ye=It.useVertical,(It.notEnoughRoom||ye||It.needsFlipping&&he(rt,Re,Be,!0,w,e,d,p.glyphOffsetArray,ae,pe,I).notEnoughRoom)&&ut(Re.numGlyphs,ae)}a?p.text.dynamicLayoutVertexBuffer.updateData(ae):p.icon.dynamicLayoutVertexBuffer.updateData(ae)}function K(p,e,s,a,l,d,v,w){const I=d.glyphStartIndex+d.numGlyphs,A=d.lineStartIndex,C=d.lineStartIndex+d.lineLength,M=e.getoffsetX(d.glyphStartIndex),O=e.getoffsetX(I-1),V=Fe(p*M,s,a,l,d.segment,A,C,w,v);if(!V)return null;const H=Fe(p*O,s,a,l,d.segment,A,C,w,v);return H?w.projectionCache.anyProjectionOccluded?null:{first:V,last:H}:null}function le(p,e,s,a){return p===h.ah.horizontal&&Math.abs(s.y-e.y)>Math.abs(s.x-e.x)*a?{useVertical:!0}:(p===h.ah.vertical?e.y<s.y:e.x>s.x)?{needsFlipping:!0}:null}function he(p,e,s,a,l,d,v,w,I,A,C){const M=s/24,O=e.lineOffsetX*M,V=e.lineOffsetY*M;let H;if(e.numGlyphs>1){const ee=e.glyphStartIndex+e.numGlyphs,re=e.lineStartIndex,se=e.lineStartIndex+e.lineLength,ae=K(M,w,O,V,a,e,C,p);if(!ae)return{notEnoughRoom:!0};const Y=te(ae.first.point.x,ae.first.point.y,v,p.getElevation).point,ue=te(ae.last.point.x,ae.last.point.y,v,p.getElevation).point;if(l&&!a){const pe=le(e.writingMode,Y,ue,A);if(pe)return pe}H=[ae.first];for(let pe=e.glyphStartIndex+1;pe<ee-1;pe++)H.push(Fe(M*w.getoffsetX(pe),O,V,a,e.segment,re,se,p,C));H.push(ae.last)}else{if(l&&!a){const re=te(p.tileAnchorPoint.x,p.tileAnchorPoint.y,d,p.getElevation).point,se=e.lineStartIndex+e.segment+1,ae=new h.P(p.lineVertexArray.getx(se),p.lineVertexArray.gety(se)),Y=te(ae.x,ae.y,d,p.getElevation),ue=Y.signedDistanceFromCamera>0?Y.point:function(ye,Ce,Re,qe,Je,Ne){return fe(ye,Ce,Re,1,Je,Ne)}(p.tileAnchorPoint,ae,re,0,d,p),pe=le(e.writingMode,re,ue,A);if(pe)return pe}const ee=Fe(M*w.getoffsetX(e.glyphStartIndex),O,V,a,e.segment,e.lineStartIndex,e.lineStartIndex+e.lineLength,p,C);if(!ee||p.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};H=[ee]}for(const ee of H)h.aj(I,ee.point,ee.angle);return{}}function fe(p,e,s,a,l,d){const v=p.add(p.sub(e)._unit()),w=l!==void 0?te(v.x,v.y,l,d.getElevation).point:we(v.x,v.y,d).point,I=s.sub(w);return s.add(I._mult(a/I.mag()))}function oe(p,e,s){const a=e.projectionCache;if(a.projections[p])return a.projections[p];const l=new h.P(e.lineVertexArray.getx(p),e.lineVertexArray.gety(p)),d=we(l.x,l.y,e);if(d.signedDistanceFromCamera>0)return a.projections[p]=d.point,a.anyProjectionOccluded=a.anyProjectionOccluded||d.isOccluded,d.point;const v=p-s.direction;return function(w,I,A,C,M){return fe(w,I,A,C,void 0,M)}(s.distanceFromAnchor===0?e.tileAnchorPoint:new h.P(e.lineVertexArray.getx(v),e.lineVertexArray.gety(v)),l,s.previousVertex,s.absOffsetX-s.distanceFromAnchor+1,e)}function we(p,e,s){const a=p+s.translation[0],l=e+s.translation[1];let d;return!s.pitchWithMap&&s.projection.useSpecialProjectionForSymbols?(d=s.projection.projectTileCoordinates(a,l,s.unwrappedTileID,s.getElevation),d.point.x=(.5*d.point.x+.5)*s.width,d.point.y=(.5*-d.point.y+.5)*s.height):(d=te(a,l,s.labelPlaneMatrix,s.getElevation),d.isOccluded=!1),d}function Pe(p,e,s){return p._unit()._perp()._mult(e*s)}function xe(p,e,s,a,l,d,v,w,I){if(w.projectionCache.offsets[p])return w.projectionCache.offsets[p];const A=s.add(e);if(p+I.direction<a||p+I.direction>=l)return w.projectionCache.offsets[p]=A,A;const C=oe(p+I.direction,w,I),M=Pe(C.sub(s),v,I.direction),O=s.add(M),V=C.add(M);return w.projectionCache.offsets[p]=h.ak(d,A,O,V)||A,w.projectionCache.offsets[p]}function Fe(p,e,s,a,l,d,v,w,I){const A=a?p-e:p+e;let C=A>0?1:-1,M=0;a&&(C*=-1,M=Math.PI),C<0&&(M+=Math.PI);let O,V=C>0?d+l:d+l+1;w.projectionCache.cachedAnchorPoint?O=w.projectionCache.cachedAnchorPoint:(O=we(w.tileAnchorPoint.x,w.tileAnchorPoint.y,w).point,w.projectionCache.cachedAnchorPoint=O);let H,ee,re=O,se=O,ae=0,Y=0;const ue=Math.abs(A),pe=[];let ye;for(;ae+Y<=ue;){if(V+=C,V<d||V>=v)return null;ae+=Y,se=re,ee=H;const qe={absOffsetX:ue,direction:C,distanceFromAnchor:ae,previousVertex:se};if(re=oe(V,w,qe),s===0)pe.push(se),ye=re.sub(se);else{let Je;const Ne=re.sub(se);Je=Ne.mag()===0?Pe(oe(V+C,w,qe).sub(re),s,C):Pe(Ne,s,C),ee||(ee=se.add(Je)),H=xe(V,Je,re,d,v,ee,s,w,qe),pe.push(ee),ye=H.sub(ee)}Y=ye.mag()}const Ce=ye._mult((ue-ae)/Y)._add(ee||se),Re=M+Math.atan2(re.y-se.y,re.x-se.x);return pe.push(Ce),{point:Ce,angle:I?Re:0,path:pe}}const ot=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function ut(p,e){for(let s=0;s<p;s++){const a=e.length;e.resize(a+4),e.float32.set(ot,3*a)}}function qt(p,e,s){const a=e[0],l=e[1];return p[0]=s[0]*a+s[4]*l+s[12],p[1]=s[1]*a+s[5]*l+s[13],p[3]=s[3]*a+s[7]*l+s[15],p}const gt=100;class zt{constructor(e,s,a=new Fr(e.width+200,e.height+200,25),l=new Fr(e.width+200,e.height+200,25)){this.transform=e,this.mapProjection=s,this.grid=a,this.ignoredGrid=l,this.pitchFactor=Math.cos(e._pitch)*e.cameraToCenterDistance,this.screenRightBoundary=e.width+gt,this.screenBottomBoundary=e.height+gt,this.gridRightBoundary=e.width+200,this.gridBottomBoundary=e.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(e,s,a,l,d,v,w,I,A,C,M){const O=e.anchorPointX+I[0],V=e.anchorPointY+I[1],H=this.projectAndGetPerspectiveRatio(l,O,V,d,C),ee=a*H.perspectiveRatio;let re;if(v||w)re=this._projectCollisionBox(e,ee,l,d,v,w,I,H,C,M);else{const pe=H.point.x+(M?M.x*ee:0),ye=H.point.y+(M?M.y*ee:0);re={allPointsOccluded:!1,box:[pe+e.x1*ee,ye+e.y1*ee,pe+e.x2*ee,ye+e.y2*ee]}}const[se,ae,Y,ue]=re.box;return this.mapProjection.useSpecialProjectionForSymbols&&(v?re.allPointsOccluded:this.mapProjection.isOccluded(O,V,d))||H.perspectiveRatio<this.perspectiveRatioCutoff||!this.isInsideGrid(se,ae,Y,ue)||s!=="always"&&this.grid.hitTest(se,ae,Y,ue,s,A)?{box:[se,ae,Y,ue],placeable:!1,offscreen:!1}:{box:[se,ae,Y,ue],placeable:!0,offscreen:this.isOffscreen(se,ae,Y,ue)}}placeCollisionCircles(e,s,a,l,d,v,w,I,A,C,M,O,V,H,ee,re){const se=[],ae=new h.P(s.anchorX,s.anchorY),Y=this.getPerspectiveRatio(v,ae.x,ae.y,w,re),ue=(M?d/Y:d*Y)/h.ap,pe={getElevation:re,labelPlaneMatrix:I,lineVertexArray:a,pitchWithMap:M,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},projection:this.mapProjection,tileAnchorPoint:ae,unwrappedTileID:w,width:this.transform.width,height:this.transform.height,translation:ee},ye=K(ue,l,s.lineOffsetX*ue,s.lineOffsetY*ue,!1,s,!1,pe);let Ce=!1,Re=!1,qe=!0;if(ye){const Je=.5*V*Y+H,Ne=new h.P(-100,-100),Be=new h.P(this.screenRightBoundary,this.screenBottomBoundary),rt=new vt,It=ye.first,Ue=ye.last;let Ze=[];for(let Pt=It.path.length-1;Pt>=1;Pt--)Ze.push(It.path[Pt]);for(let Pt=1;Pt<Ue.path.length;Pt++)Ze.push(Ue.path[Pt]);const bt=2.5*Je;if(A){const Pt=this.projectPathToScreenSpace(Ze,pe,A);Ze=Pt.some($t=>$t.signedDistanceFromCamera<=0)?[]:Pt.map($t=>$t.point)}let yi=[];if(Ze.length>0){const Pt=Ze[0].clone(),$t=Ze[0].clone();for(let xi=1;xi<Ze.length;xi++)Pt.x=Math.min(Pt.x,Ze[xi].x),Pt.y=Math.min(Pt.y,Ze[xi].y),$t.x=Math.max($t.x,Ze[xi].x),$t.y=Math.max($t.y,Ze[xi].y);yi=Pt.x>=Ne.x&&$t.x<=Be.x&&Pt.y>=Ne.y&&$t.y<=Be.y?[Ze]:$t.x<Ne.x||Pt.x>Be.x||$t.y<Ne.y||Pt.y>Be.y?[]:h.al([Ze],Ne.x,Ne.y,Be.x,Be.y)}for(const Pt of yi){rt.reset(Pt,.25*Je);let $t=0;$t=rt.length<=.5*Je?1:Math.ceil(rt.paddedLength/bt)+1;for(let xi=0;xi<$t;xi++){const rr=xi/Math.max($t-1,1),ls=rt.lerp(rr),vi=ls.x+gt,Er=ls.y+gt;se.push(vi,Er,Je,0);const fr=vi-Je,mr=Er-Je,_r=vi+Je,Es=Er+Je;if(qe=qe&&this.isOffscreen(fr,mr,_r,Es),Re=Re||this.isInsideGrid(fr,mr,_r,Es),e!=="always"&&this.grid.hitTestCircle(vi,Er,Je,e,O)&&(Ce=!0,!C))return{circles:[],offscreen:!1,collisionDetected:Ce}}}}return{circles:!C&&Ce||!Re||Y<this.perspectiveRatioCutoff?[]:se,offscreen:qe,collisionDetected:Ce}}projectPathToScreenSpace(e,s,a){return e.map(l=>te(l.x,l.y,a,s.getElevation))}queryRenderedSymbols(e){if(e.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const s=[];let a=1/0,l=1/0,d=-1/0,v=-1/0;for(const C of e){const M=new h.P(C.x+gt,C.y+gt);a=Math.min(a,M.x),l=Math.min(l,M.y),d=Math.max(d,M.x),v=Math.max(v,M.y),s.push(M)}const w=this.grid.query(a,l,d,v).concat(this.ignoredGrid.query(a,l,d,v)),I={},A={};for(const C of w){const M=C.key;if(I[M.bucketInstanceId]===void 0&&(I[M.bucketInstanceId]={}),I[M.bucketInstanceId][M.featureIndex])continue;const O=[new h.P(C.x1,C.y1),new h.P(C.x2,C.y1),new h.P(C.x2,C.y2),new h.P(C.x1,C.y2)];h.am(s,O)&&(I[M.bucketInstanceId][M.featureIndex]=!0,A[M.bucketInstanceId]===void 0&&(A[M.bucketInstanceId]=[]),A[M.bucketInstanceId].push(M.featureIndex))}return A}insertCollisionBox(e,s,a,l,d,v){(a?this.ignoredGrid:this.grid).insert({bucketInstanceId:l,featureIndex:d,collisionGroupID:v,overlapMode:s},e[0],e[1],e[2],e[3])}insertCollisionCircles(e,s,a,l,d,v){const w=a?this.ignoredGrid:this.grid,I={bucketInstanceId:l,featureIndex:d,collisionGroupID:v,overlapMode:s};for(let A=0;A<e.length;A+=4)w.insertCircle(I,e[A],e[A+1],e[A+2])}projectAndGetPerspectiveRatio(e,s,a,l,d){let v;d?(v=[s,a,d(s,a),1],h.af(v,v,e)):(v=[s,a,0,1],qt(v,v,e));const w=v[3];return{point:new h.P((v[0]/w+1)/2*this.transform.width+gt,(-v[1]/w+1)/2*this.transform.height+gt),perspectiveRatio:.5+this.transform.cameraToCenterDistance/w*.5,isOccluded:!1,signedDistanceFromCamera:w}}getPerspectiveRatio(e,s,a,l,d){const v=this.mapProjection.useSpecialProjectionForSymbols?this.mapProjection.projectTileCoordinates(s,a,l,d):te(s,a,e,d);return .5+this.transform.cameraToCenterDistance/v.signedDistanceFromCamera*.5}isOffscreen(e,s,a,l){return a<gt||e>=this.screenRightBoundary||l<gt||s>this.screenBottomBoundary}isInsideGrid(e,s,a,l){return a>=0&&e<this.gridRightBoundary&&l>=0&&s<this.gridBottomBoundary}getViewportMatrix(){const e=h.an([]);return h.J(e,e,[-100,-100,0]),e}_projectCollisionBox(e,s,a,l,d,v,w,I,A,C){let M=new h.P(1,0),O=new h.P(0,1);const V=new h.P(e.anchorPointX+w[0],e.anchorPointY+w[1]);if(v&&!d){const qe=this.projectAndGetPerspectiveRatio(a,V.x+1,V.y,l,A).point.sub(I.point).unit(),Je=Math.atan(qe.y/qe.x)+(qe.x<0?Math.PI:0),Ne=Math.sin(Je),Be=Math.cos(Je);M=new h.P(Be,Ne),O=new h.P(-Ne,Be)}else if(!v&&d){const qe=-this.transform.angle,Je=Math.sin(qe),Ne=Math.cos(qe);M=new h.P(Ne,Je),O=new h.P(-Je,Ne)}let H=I.point,ee=s;if(d){H=V;const qe=this.transform.zoom-Math.floor(this.transform.zoom);ee=Math.pow(2,-qe),ee*=this.mapProjection.getPitchedTextCorrection(this.transform,V,l),C||(ee*=h.ac(.5+I.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))}C&&(H=H.add(M.mult(C.x*ee)).add(O.mult(C.y*ee)));const re=e.x1*ee,se=e.x2*ee,ae=(re+se)/2,Y=e.y1*ee,ue=e.y2*ee,pe=(Y+ue)/2,ye=[{offsetX:re,offsetY:Y},{offsetX:ae,offsetY:Y},{offsetX:se,offsetY:Y},{offsetX:se,offsetY:pe},{offsetX:se,offsetY:ue},{offsetX:ae,offsetY:ue},{offsetX:re,offsetY:ue},{offsetX:re,offsetY:pe}];let Ce=[];for(const{offsetX:qe,offsetY:Je}of ye)Ce.push(new h.P(H.x+M.x*qe+O.x*Je,H.y+M.y*qe+O.y*Je));let Re=!1;if(d){const qe=Ce.map(Je=>this.projectAndGetPerspectiveRatio(a,Je.x,Je.y,l,A));Re=qe.some(Je=>!Je.isOccluded),Ce=qe.map(Je=>Je.point)}else Re=!0;return{box:h.ao(Ce),allPointsOccluded:!Re}}}function Et(p,e,s){return e*(h.X/(p.tileSize*Math.pow(2,s-p.tileID.overscaledZ)))}class Ii{constructor(e,s,a,l){this.opacity=e?Math.max(0,Math.min(1,e.opacity+(e.placed?s:-s))):l&&a?1:0,this.placed=a}isHidden(){return this.opacity===0&&!this.placed}}class fi{constructor(e,s,a,l,d){this.text=new Ii(e?e.text:null,s,a,d),this.icon=new Ii(e?e.icon:null,s,l,d)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class At{constructor(e,s,a){this.text=e,this.icon=s,this.skipFade=a}}class Xt{constructor(){this.invProjMatrix=h.H(),this.viewportMatrix=h.H(),this.circles=[]}}class jt{constructor(e,s,a,l,d){this.bucketInstanceId=e,this.featureIndex=s,this.sourceLayerIndex=a,this.bucketIndex=l,this.tileID=d}}class Ri{constructor(e){this.crossSourceCollisions=e,this.maxGroupID=0,this.collisionGroups={}}get(e){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[e]){const s=++this.maxGroupID;this.collisionGroups[e]={ID:s,predicate:a=>a.collisionGroupID===s}}return this.collisionGroups[e]}}function B(p,e,s,a,l){const{horizontalAlign:d,verticalAlign:v}=h.au(p);return new h.P(-(d-.5)*e+a[0]*l,-(v-.5)*s+a[1]*l)}class W{constructor(e,s,a,l,d,v){this.transform=e.clone(),this.terrain=a,this.collisionIndex=new zt(this.transform,s),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=l,this.retainedQueryData={},this.collisionGroups=new Ri(d),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=v,v&&(v.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(e){const s=this.terrain;return s?(a,l)=>s.getElevation(e,a,l):null}getBucketParts(e,s,a,l){const d=a.getBucket(s),v=a.latestFeatureIndex;if(!d||!v||s.id!==d.layerIds[0])return;const w=a.collisionBoxArray,I=d.layers[0].layout,A=d.layers[0].paint,C=Math.pow(2,this.transform.zoom-a.tileID.overscaledZ),M=a.tileSize/h.X,O=a.tileID.toUnwrapped(),V=this.transform.calculatePosMatrix(O),H=I.get("text-pitch-alignment")==="map",ee=I.get("text-rotation-alignment")==="map",re=Et(a,1,this.transform.zoom),se=this.collisionIndex.mapProjection.translatePosition(this.transform,a,A.get("text-translate"),A.get("text-translate-anchor")),ae=this.collisionIndex.mapProjection.translatePosition(this.transform,a,A.get("icon-translate"),A.get("icon-translate-anchor")),Y=Br(V,H,ee,this.transform,re);let ue=null;if(H){const ye=wr(V,H,ee,this.transform,re);ue=h.L([],this.transform.labelPlaneMatrix,ye)}this.retainedQueryData[d.bucketInstanceId]=new jt(d.bucketInstanceId,v,d.sourceLayerIndex,d.index,a.tileID);const pe={bucket:d,layout:I,translationText:se,translationIcon:ae,posMatrix:V,unwrappedTileID:O,textLabelPlaneMatrix:Y,labelToScreenMatrix:ue,scale:C,textPixelRatio:M,holdingForFade:a.holdingForFade(),collisionBoxArray:w,partiallyEvaluatedTextSize:h.ag(d.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(d.sourceID)};if(l)for(const ye of d.sortKeyRanges){const{sortKey:Ce,symbolInstanceStart:Re,symbolInstanceEnd:qe}=ye;e.push({sortKey:Ce,symbolInstanceStart:Re,symbolInstanceEnd:qe,parameters:pe})}else e.push({symbolInstanceStart:0,symbolInstanceEnd:d.symbolInstances.length,parameters:pe})}attemptAnchorPlacement(e,s,a,l,d,v,w,I,A,C,M,O,V,H,ee,re,se,ae,Y){const ue=h.aq[e.textAnchor],pe=[e.textOffset0,e.textOffset1],ye=B(ue,a,l,pe,d),Ce=this.collisionIndex.placeCollisionBox(s,O,I,A,C,w,v,re,M.predicate,Y,ye);if((!ae||this.collisionIndex.placeCollisionBox(ae,O,I,A,C,w,v,se,M.predicate,Y,ye).placeable)&&Ce.placeable){let Re;if(this.prevPlacement&&this.prevPlacement.variableOffsets[V.crossTileID]&&this.prevPlacement.placements[V.crossTileID]&&this.prevPlacement.placements[V.crossTileID].text&&(Re=this.prevPlacement.variableOffsets[V.crossTileID].anchor),V.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[V.crossTileID]={textOffset:pe,width:a,height:l,anchor:ue,textBoxScale:d,prevAnchor:Re},this.markUsedJustification(H,ue,V,ee),H.allowVerticalPlacement&&(this.markUsedOrientation(H,ee,V),this.placedOrientations[V.crossTileID]=ee),{shift:ye,placedGlyphBoxes:Ce}}}placeLayerBucketPart(e,s,a){const{bucket:l,layout:d,translationText:v,translationIcon:w,posMatrix:I,unwrappedTileID:A,textLabelPlaneMatrix:C,labelToScreenMatrix:M,textPixelRatio:O,holdingForFade:V,collisionBoxArray:H,partiallyEvaluatedTextSize:ee,collisionGroup:re}=e.parameters,se=d.get("text-optional"),ae=d.get("icon-optional"),Y=h.ar(d,"text-overlap","text-allow-overlap"),ue=Y==="always",pe=h.ar(d,"icon-overlap","icon-allow-overlap"),ye=pe==="always",Ce=d.get("text-rotation-alignment")==="map",Re=d.get("text-pitch-alignment")==="map",qe=d.get("icon-text-fit")!=="none",Je=d.get("symbol-z-order")==="viewport-y",Ne=ue&&(ye||!l.hasIconData()||ae),Be=ye&&(ue||!l.hasTextData()||se);!l.collisionArrays&&H&&l.deserializeCollisionBoxes(H);const rt=this._getTerrainElevationFunc(this.retainedQueryData[l.bucketInstanceId].tileID),It=(Ue,Ze,bt)=>{var yi,Pt;if(s[Ue.crossTileID])return;if(V)return void(this.placements[Ue.crossTileID]=new At(!1,!1,!1));let $t=!1,xi=!1,rr=!0,ls=null,vi={box:null,placeable:!1,offscreen:null},Er={box:null,placeable:!1,offscreen:null},fr=null,mr=null,_r=null,Es=0,Zn=0,wa=0;Ze.textFeatureIndex?Es=Ze.textFeatureIndex:Ue.useRuntimeCollisionCircles&&(Es=Ue.featureIndex),Ze.verticalTextFeatureIndex&&(Zn=Ze.verticalTextFeatureIndex);const cs=Ze.textBox;if(cs){const jr=gr=>{let sr=h.ah.horizontal;if(l.allowVerticalPlacement&&!gr&&this.prevPlacement){const ai=this.prevPlacement.placedOrientations[Ue.crossTileID];ai&&(this.placedOrientations[Ue.crossTileID]=ai,sr=ai,this.markUsedOrientation(l,sr,Ue))}return sr},hs=(gr,sr)=>{if(l.allowVerticalPlacement&&Ue.numVerticalGlyphVertices>0&&Ze.verticalTextBox){for(const ai of l.writingModes)if(ai===h.ah.vertical?(vi=sr(),Er=vi):vi=gr(),vi&&vi.placeable)break}else vi=gr()},Nr=Ue.textAnchorOffsetStartIndex,Ks=Ue.textAnchorOffsetEndIndex;if(Ks===Nr){const gr=(sr,ai)=>{const Ei=this.collisionIndex.placeCollisionBox(sr,Y,O,I,A,Re,Ce,v,re.predicate,rt);return Ei&&Ei.placeable&&(this.markUsedOrientation(l,ai,Ue),this.placedOrientations[Ue.crossTileID]=ai),Ei};hs(()=>gr(cs,h.ah.horizontal),()=>{const sr=Ze.verticalTextBox;return l.allowVerticalPlacement&&Ue.numVerticalGlyphVertices>0&&sr?gr(sr,h.ah.vertical):{box:null,offscreen:null}}),jr(vi&&vi.placeable)}else{let gr=h.aq[(Pt=(yi=this.prevPlacement)===null||yi===void 0?void 0:yi.variableOffsets[Ue.crossTileID])===null||Pt===void 0?void 0:Pt.anchor];const sr=(Ei,Ls,Wn)=>{const Ia=Ei.x2-Ei.x1,pu=Ei.y2-Ei.y1,Jc=Ue.textBoxScale,Kc=qe&&pe==="never"?Ls:null;let Tn=null,Ta=Y==="never"?1:2,zo="never";gr&&Ta++;for(let Ml=0;Ml<Ta;Ml++){for(let Do=Nr;Do<Ks;Do++){const Lo=l.textAnchorOffsets.get(Do);if(gr&&Lo.textAnchor!==gr)continue;const Rs=this.attemptAnchorPlacement(Lo,Ei,Ia,pu,Jc,Ce,Re,O,I,A,re,zo,Ue,l,Wn,v,w,Kc,rt);if(Rs&&(Tn=Rs.placedGlyphBoxes,Tn&&Tn.placeable))return $t=!0,ls=Rs.shift,Tn}gr?gr=null:zo=Y}return a&&!Tn&&(Tn={box:this.collisionIndex.placeCollisionBox(cs,"always",O,I,A,Re,Ce,v,re.predicate,rt,new h.P(0,0)).box,offscreen:!1,placeable:!1}),Tn};hs(()=>sr(cs,Ze.iconBox,h.ah.horizontal),()=>{const Ei=Ze.verticalTextBox;return l.allowVerticalPlacement&&(!vi||!vi.placeable)&&Ue.numVerticalGlyphVertices>0&&Ei?sr(Ei,Ze.verticalIconBox,h.ah.vertical):{box:null,occluded:!0,offscreen:null}}),vi&&($t=vi.placeable,rr=vi.offscreen);const ai=jr(vi&&vi.placeable);if(!$t&&this.prevPlacement){const Ei=this.prevPlacement.variableOffsets[Ue.crossTileID];Ei&&(this.variableOffsets[Ue.crossTileID]=Ei,this.markUsedJustification(l,Ei.anchor,Ue,ai))}}}if(fr=vi,$t=fr&&fr.placeable,rr=fr&&fr.offscreen,Ue.useRuntimeCollisionCircles){const jr=l.text.placedSymbolArray.get(Ue.centerJustifiedTextSymbolIndex),hs=h.ai(l.textSizeData,ee,jr),Nr=d.get("text-padding");mr=this.collisionIndex.placeCollisionCircles(Y,jr,l.lineVertexArray,l.glyphOffsetArray,hs,I,A,C,M,a,Re,re.predicate,Ue.collisionCircleDiameter,Nr,v,rt),mr.circles.length&&mr.collisionDetected&&!a&&h.w("Collisions detected, but collision boxes are not shown"),$t=ue||mr.circles.length>0&&!mr.collisionDetected,rr=rr&&mr.offscreen}if(Ze.iconFeatureIndex&&(wa=Ze.iconFeatureIndex),Ze.iconBox){const jr=hs=>this.collisionIndex.placeCollisionBox(hs,pe,O,I,A,Re,Ce,w,re.predicate,rt,qe&&ls?ls:void 0);Er&&Er.placeable&&Ze.verticalIconBox?(_r=jr(Ze.verticalIconBox),xi=_r.placeable):(_r=jr(Ze.iconBox),xi=_r.placeable),rr=rr&&_r.offscreen}const In=se||Ue.numHorizontalGlyphVertices===0&&Ue.numVerticalGlyphVertices===0,Sa=ae||Ue.numIconVertices===0;In||Sa?Sa?In||(xi=xi&&$t):$t=xi&&$t:xi=$t=xi&&$t;const Cl=xi&&_r.placeable;if($t&&fr.placeable&&this.collisionIndex.insertCollisionBox(fr.box,Y,d.get("text-ignore-placement"),l.bucketInstanceId,Er&&Er.placeable&&Zn?Zn:Es,re.ID),Cl&&this.collisionIndex.insertCollisionBox(_r.box,pe,d.get("icon-ignore-placement"),l.bucketInstanceId,wa,re.ID),mr&&$t&&this.collisionIndex.insertCollisionCircles(mr.circles,Y,d.get("text-ignore-placement"),l.bucketInstanceId,Es,re.ID),a&&this.storeCollisionData(l.bucketInstanceId,bt,Ze,fr,_r,mr),Ue.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(l.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[Ue.crossTileID]=new At($t||Ne,xi||Be,rr||l.justReloaded),s[Ue.crossTileID]=!0};if(Je){if(e.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const Ue=l.getSortedSymbolIndexes(this.transform.angle);for(let Ze=Ue.length-1;Ze>=0;--Ze){const bt=Ue[Ze];It(l.symbolInstances.get(bt),l.collisionArrays[bt],bt)}}else for(let Ue=e.symbolInstanceStart;Ue<e.symbolInstanceEnd;Ue++)It(l.symbolInstances.get(Ue),l.collisionArrays[Ue],Ue);if(a&&l.bucketInstanceId in this.collisionCircleArrays){const Ue=this.collisionCircleArrays[l.bucketInstanceId];h.as(Ue.invProjMatrix,I),Ue.viewportMatrix=this.collisionIndex.getViewportMatrix()}l.justReloaded=!1}storeCollisionData(e,s,a,l,d,v){if(a.textBox||a.iconBox){let w,I;this.collisionBoxArrays.has(e)?w=this.collisionBoxArrays.get(e):(w=new Map,this.collisionBoxArrays.set(e,w)),w.has(s)?I=w.get(s):(I={text:null,icon:null},w.set(s,I)),a.textBox&&(I.text=l.box),a.iconBox&&(I.icon=d.box)}if(v){let w=this.collisionCircleArrays[e];w===void 0&&(w=this.collisionCircleArrays[e]=new Xt);for(let I=0;I<v.circles.length;I+=4)w.circles.push(v.circles[I+0]),w.circles.push(v.circles[I+1]),w.circles.push(v.circles[I+2]),w.circles.push(v.collisionDetected?1:0)}}markUsedJustification(e,s,a,l){let d;d=l===h.ah.vertical?a.verticalPlacedTextSymbolIndex:{left:a.leftJustifiedTextSymbolIndex,center:a.centerJustifiedTextSymbolIndex,right:a.rightJustifiedTextSymbolIndex}[h.at(s)];const v=[a.leftJustifiedTextSymbolIndex,a.centerJustifiedTextSymbolIndex,a.rightJustifiedTextSymbolIndex,a.verticalPlacedTextSymbolIndex];for(const w of v)w>=0&&(e.text.placedSymbolArray.get(w).crossTileID=d>=0&&w!==d?0:a.crossTileID)}markUsedOrientation(e,s,a){const l=s===h.ah.horizontal||s===h.ah.horizontalOnly?s:0,d=s===h.ah.vertical?s:0,v=[a.leftJustifiedTextSymbolIndex,a.centerJustifiedTextSymbolIndex,a.rightJustifiedTextSymbolIndex];for(const w of v)e.text.placedSymbolArray.get(w).placedOrientation=l;a.verticalPlacedTextSymbolIndex&&(e.text.placedSymbolArray.get(a.verticalPlacedTextSymbolIndex).placedOrientation=d)}commit(e){this.commitTime=e,this.zoomAtLastRecencyCheck=this.transform.zoom;const s=this.prevPlacement;let a=!1;this.prevZoomAdjustment=s?s.zoomAdjustment(this.transform.zoom):0;const l=s?s.symbolFadeChange(e):1,d=s?s.opacities:{},v=s?s.variableOffsets:{},w=s?s.placedOrientations:{};for(const I in this.placements){const A=this.placements[I],C=d[I];C?(this.opacities[I]=new fi(C,l,A.text,A.icon),a=a||A.text!==C.text.placed||A.icon!==C.icon.placed):(this.opacities[I]=new fi(null,l,A.text,A.icon,A.skipFade),a=a||A.text||A.icon)}for(const I in d){const A=d[I];if(!this.opacities[I]){const C=new fi(A,l,!1,!1);C.isHidden()||(this.opacities[I]=C,a=a||A.text.placed||A.icon.placed)}}for(const I in v)this.variableOffsets[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.variableOffsets[I]=v[I]);for(const I in w)this.placedOrientations[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.placedOrientations[I]=w[I]);if(s&&s.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");a?this.lastPlacementChangeTime=e:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=s?s.lastPlacementChangeTime:e)}updateLayerOpacities(e,s){const a={};for(const l of s){const d=l.getBucket(e);d&&l.latestFeatureIndex&&e.id===d.layerIds[0]&&this.updateBucketOpacities(d,l.tileID,a,l.collisionBoxArray)}}updateBucketOpacities(e,s,a,l){e.hasTextData()&&(e.text.opacityVertexArray.clear(),e.text.hasVisibleVertices=!1),e.hasIconData()&&(e.icon.opacityVertexArray.clear(),e.icon.hasVisibleVertices=!1),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexArray.clear(),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexArray.clear();const d=e.layers[0],v=d.layout,w=new fi(null,0,!1,!1,!0),I=v.get("text-allow-overlap"),A=v.get("icon-allow-overlap"),C=d._unevaluatedLayout.hasValue("text-variable-anchor")||d._unevaluatedLayout.hasValue("text-variable-anchor-offset"),M=v.get("text-rotation-alignment")==="map",O=v.get("text-pitch-alignment")==="map",V=v.get("icon-text-fit")!=="none",H=new fi(null,0,I&&(A||!e.hasIconData()||v.get("icon-optional")),A&&(I||!e.hasTextData()||v.get("text-optional")),!0);!e.collisionArrays&&l&&(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData())&&e.deserializeCollisionBoxes(l);const ee=(se,ae,Y)=>{for(let ue=0;ue<ae/4;ue++)se.opacityVertexArray.emplaceBack(Y);se.hasVisibleVertices=se.hasVisibleVertices||Y!==Rt},re=this.collisionBoxArrays.get(e.bucketInstanceId);for(let se=0;se<e.symbolInstances.length;se++){const ae=e.symbolInstances.get(se),{numHorizontalGlyphVertices:Y,numVerticalGlyphVertices:ue,crossTileID:pe}=ae;let ye=this.opacities[pe];a[pe]?ye=w:ye||(ye=H,this.opacities[pe]=ye),a[pe]=!0;const Ce=ae.numIconVertices>0,Re=this.placedOrientations[ae.crossTileID],qe=Re===h.ah.vertical,Je=Re===h.ah.horizontal||Re===h.ah.horizontalOnly;if(Y>0||ue>0){const Be=Ke(ye.text);ee(e.text,Y,qe?Rt:Be),ee(e.text,ue,Je?Rt:Be);const rt=ye.text.isHidden();[ae.rightJustifiedTextSymbolIndex,ae.centerJustifiedTextSymbolIndex,ae.leftJustifiedTextSymbolIndex].forEach(Ze=>{Ze>=0&&(e.text.placedSymbolArray.get(Ze).hidden=rt||qe?1:0)}),ae.verticalPlacedTextSymbolIndex>=0&&(e.text.placedSymbolArray.get(ae.verticalPlacedTextSymbolIndex).hidden=rt||Je?1:0);const It=this.variableOffsets[ae.crossTileID];It&&this.markUsedJustification(e,It.anchor,ae,Re);const Ue=this.placedOrientations[ae.crossTileID];Ue&&(this.markUsedJustification(e,"left",ae,Ue),this.markUsedOrientation(e,Ue,ae))}if(Ce){const Be=Ke(ye.icon),rt=!(V&&ae.verticalPlacedIconSymbolIndex&&qe);ae.placedIconSymbolIndex>=0&&(ee(e.icon,ae.numIconVertices,rt?Be:Rt),e.icon.placedSymbolArray.get(ae.placedIconSymbolIndex).hidden=ye.icon.isHidden()),ae.verticalPlacedIconSymbolIndex>=0&&(ee(e.icon,ae.numVerticalIconVertices,rt?Rt:Be),e.icon.placedSymbolArray.get(ae.verticalPlacedIconSymbolIndex).hidden=ye.icon.isHidden())}const Ne=re&&re.has(se)?re.get(se):{text:null,icon:null};if(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData()){const Be=e.collisionArrays[se];if(Be){let rt=new h.P(0,0);if(Be.textBox||Be.verticalTextBox){let It=!0;if(C){const Ue=this.variableOffsets[pe];Ue?(rt=B(Ue.anchor,Ue.width,Ue.height,Ue.textOffset,Ue.textBoxScale),M&&rt._rotate(O?this.transform.angle:-this.transform.angle)):It=!1}if(Be.textBox||Be.verticalTextBox){let Ue;Be.textBox&&(Ue=qe),Be.verticalTextBox&&(Ue=Je),Z(e.textCollisionBox.collisionVertexArray,ye.text.placed,!It||Ue,Ne.text,rt.x,rt.y)}}if(Be.iconBox||Be.verticalIconBox){const It=!!(!Je&&Be.verticalIconBox);let Ue;Be.iconBox&&(Ue=It),Be.verticalIconBox&&(Ue=!It),Z(e.iconCollisionBox.collisionVertexArray,ye.icon.placed,Ue,Ne.icon,V?rt.x:0,V?rt.y:0)}}}}if(e.sortFeatures(this.transform.angle),this.retainedQueryData[e.bucketInstanceId]&&(this.retainedQueryData[e.bucketInstanceId].featureSortOrder=e.featureSortOrder),e.hasTextData()&&e.text.opacityVertexBuffer&&e.text.opacityVertexBuffer.updateData(e.text.opacityVertexArray),e.hasIconData()&&e.icon.opacityVertexBuffer&&e.icon.opacityVertexBuffer.updateData(e.icon.opacityVertexArray),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexBuffer&&e.iconCollisionBox.collisionVertexBuffer.updateData(e.iconCollisionBox.collisionVertexArray),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexBuffer&&e.textCollisionBox.collisionVertexBuffer.updateData(e.textCollisionBox.collisionVertexArray),e.text.opacityVertexArray.length!==e.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${e.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${e.text.layoutVertexArray.length}) / 4`);if(e.icon.opacityVertexArray.length!==e.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${e.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${e.icon.layoutVertexArray.length}) / 4`);if(e.bucketInstanceId in this.collisionCircleArrays){const se=this.collisionCircleArrays[e.bucketInstanceId];e.placementInvProjMatrix=se.invProjMatrix,e.placementViewportMatrix=se.viewportMatrix,e.collisionCircleArray=se.circles,delete this.collisionCircleArrays[e.bucketInstanceId]}}symbolFadeChange(e){return this.fadeDuration===0?1:(e-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(e){return Math.max(0,(this.transform.zoom-e)/1.5)}hasTransitions(e){return this.stale||e-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(e,s){const a=this.zoomAtLastRecencyCheck===s?1-this.zoomAdjustment(s):1;return this.zoomAtLastRecencyCheck=s,this.commitTime+this.fadeDuration*a>e}setStale(){this.stale=!0}}function Z(p,e,s,a,l,d){a&&a.length!==0||(a=[0,0,0,0]);const v=a[0]-gt,w=a[1]-gt,I=a[2]-gt,A=a[3]-gt;p.emplaceBack(e?1:0,s?1:0,l||0,d||0,v,w),p.emplaceBack(e?1:0,s?1:0,l||0,d||0,I,w),p.emplaceBack(e?1:0,s?1:0,l||0,d||0,I,A),p.emplaceBack(e?1:0,s?1:0,l||0,d||0,v,A)}const X=Math.pow(2,25),de=Math.pow(2,24),ge=Math.pow(2,17),Ae=Math.pow(2,16),Me=Math.pow(2,9),Ie=Math.pow(2,8),Te=Math.pow(2,1);function Ke(p){if(p.opacity===0&&!p.placed)return 0;if(p.opacity===1&&p.placed)return 4294967295;const e=p.placed?1:0,s=Math.floor(127*p.opacity);return s*X+e*de+s*ge+e*Ae+s*Me+e*Ie+s*Te+e}const Rt=0;function Qt(){return{isOccluded:(p,e,s)=>!1,getPitchedTextCorrection:(p,e,s)=>1,get useSpecialProjectionForSymbols(){return!1},projectTileCoordinates(p,e,s,a){throw new Error("Not implemented.")},translatePosition:(p,e,s,a)=>function(l,d,v,w,I=!1){if(!v[0]&&!v[1])return[0,0];const A=I?w==="map"?l.angle:0:w==="viewport"?-l.angle:0;if(A){const C=Math.sin(A),M=Math.cos(A);v=[v[0]*M-v[1]*C,v[0]*C+v[1]*M]}return[I?v[0]:Et(d,v[0],l.zoom),I?v[1]:Et(d,v[1],l.zoom)]}(p,e,s,a),getCircleRadiusCorrection:p=>1}}class Jt{constructor(e){this._sortAcrossTiles=e.layout.get("symbol-z-order")!=="viewport-y"&&!e.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(e,s,a,l,d){const v=this._bucketParts;for(;this._currentTileIndex<e.length;)if(s.getBucketParts(v,l,e[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,d())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,v.sort((w,I)=>w.sortKey-I.sortKey));this._currentPartIndex<v.length;)if(s.placeLayerBucketPart(v[this._currentPartIndex],this._seenCrossTileIDs,a),this._currentPartIndex++,d())return!0;return!1}}class Xr{constructor(e,s,a,l,d,v,w,I){this.placement=new W(e,Qt(),s,v,w,I),this._currentPlacementIndex=a.length-1,this._forceFullPlacement=l,this._showCollisionBoxes=d,this._done=!1}isDone(){return this._done}continuePlacement(e,s,a){const l=J.now(),d=()=>!this._forceFullPlacement&&J.now()-l>2;for(;this._currentPlacementIndex>=0;){const v=s[e[this._currentPlacementIndex]],w=this.placement.collisionIndex.transform.zoom;if(v.type==="symbol"&&(!v.minzoom||v.minzoom<=w)&&(!v.maxzoom||v.maxzoom>w)){if(this._inProgressLayer||(this._inProgressLayer=new Jt(v)),this._inProgressLayer.continuePlacement(a[v.source],this.placement,this._showCollisionBoxes,v,d))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(e){return this.placement.commit(e),this.placement}}const is=512/h.X/2;class Oi{constructor(e,s,a){this.tileID=e,this.bucketInstanceId=a,this._symbolsByKey={};const l=new Map;for(let d=0;d<s.length;d++){const v=s.get(d),w=v.key,I=l.get(w);I?I.push(v):l.set(w,[v])}for(const[d,v]of l){const w={positions:v.map(I=>({x:Math.floor(I.anchorX*is),y:Math.floor(I.anchorY*is)})),crossTileIDs:v.map(I=>I.crossTileID)};if(w.positions.length>128){const I=new h.av(w.positions.length,16,Uint16Array);for(const{x:A,y:C}of w.positions)I.add(A,C);I.finish(),delete w.positions,w.index=I}this._symbolsByKey[d]=w}}getScaledCoordinates(e,s){const{x:a,y:l,z:d}=this.tileID.canonical,{x:v,y:w,z:I}=s.canonical,A=is/Math.pow(2,I-d),C=(w*h.X+e.anchorY)*A,M=l*h.X*is;return{x:Math.floor((v*h.X+e.anchorX)*A-a*h.X*is),y:Math.floor(C-M)}}findMatches(e,s,a){const l=this.tileID.canonical.z<s.canonical.z?1:Math.pow(2,this.tileID.canonical.z-s.canonical.z);for(let d=0;d<e.length;d++){const v=e.get(d);if(v.crossTileID)continue;const w=this._symbolsByKey[v.key];if(!w)continue;const I=this.getScaledCoordinates(v,s);if(w.index){const A=w.index.range(I.x-l,I.y-l,I.x+l,I.y+l).sort();for(const C of A){const M=w.crossTileIDs[C];if(!a[M]){a[M]=!0,v.crossTileID=M;break}}}else if(w.positions)for(let A=0;A<w.positions.length;A++){const C=w.positions[A],M=w.crossTileIDs[A];if(Math.abs(C.x-I.x)<=l&&Math.abs(C.y-I.y)<=l&&!a[M]){a[M]=!0,v.crossTileID=M;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map(({crossTileIDs:e})=>e)}}class Wo{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class rs{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(e){const s=Math.round((e-this.lng)/360);if(s!==0)for(const a in this.indexes){const l=this.indexes[a],d={};for(const v in l){const w=l[v];w.tileID=w.tileID.unwrapTo(w.tileID.wrap+s),d[w.tileID.key]=w}this.indexes[a]=d}this.lng=e}addBucket(e,s,a){if(this.indexes[e.overscaledZ]&&this.indexes[e.overscaledZ][e.key]){if(this.indexes[e.overscaledZ][e.key].bucketInstanceId===s.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(e.overscaledZ,this.indexes[e.overscaledZ][e.key])}for(let d=0;d<s.symbolInstances.length;d++)s.symbolInstances.get(d).crossTileID=0;this.usedCrossTileIDs[e.overscaledZ]||(this.usedCrossTileIDs[e.overscaledZ]={});const l=this.usedCrossTileIDs[e.overscaledZ];for(const d in this.indexes){const v=this.indexes[d];if(Number(d)>e.overscaledZ)for(const w in v){const I=v[w];I.tileID.isChildOf(e)&&I.findMatches(s.symbolInstances,e,l)}else{const w=v[e.scaledTo(Number(d)).key];w&&w.findMatches(s.symbolInstances,e,l)}}for(let d=0;d<s.symbolInstances.length;d++){const v=s.symbolInstances.get(d);v.crossTileID||(v.crossTileID=a.generate(),l[v.crossTileID]=!0)}return this.indexes[e.overscaledZ]===void 0&&(this.indexes[e.overscaledZ]={}),this.indexes[e.overscaledZ][e.key]=new Oi(e,s.symbolInstances,s.bucketInstanceId),!0}removeBucketCrossTileIDs(e,s){for(const a of s.getCrossTileIDsLists())for(const l of a)delete this.usedCrossTileIDs[e][l]}removeStaleBuckets(e){let s=!1;for(const a in this.indexes){const l=this.indexes[a];for(const d in l)e[l[d].bucketInstanceId]||(this.removeBucketCrossTileIDs(a,l[d]),delete l[d],s=!0)}return s}}class Ja{constructor(){this.layerIndexes={},this.crossTileIDs=new Wo,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(e,s,a){let l=this.layerIndexes[e.id];l===void 0&&(l=this.layerIndexes[e.id]=new rs);let d=!1;const v={};l.handleWrapJump(a);for(const w of s){const I=w.getBucket(e);I&&e.id===I.layerIds[0]&&(I.bucketInstanceId||(I.bucketInstanceId=++this.maxBucketInstanceId),l.addBucket(w.tileID,I,this.crossTileIDs)&&(d=!0),v[I.bucketInstanceId]=!0)}return l.removeStaleBuckets(v)&&(d=!0),d}pruneUnusedLayers(e){const s={};e.forEach(a=>{s[a]=!0});for(const a in this.layerIndexes)s[a]||delete this.layerIndexes[a]}}const ss=(p,e)=>h.t(p,e&&e.filter(s=>s.identifier!=="source.canvas")),$h=h.aw();class Xo extends h.E{constructor(e,s={}){super(),this._rtlPluginLoaded=()=>{for(const a in this.sourceCaches){const l=this.sourceCaches[a].getSource().type;l!=="vector"&&l!=="geojson"||this.sourceCaches[a].reload()}},this.map=e,this.dispatcher=new $i(Mt(),e._getMapId()),this.dispatcher.registerMessageHandler("GG",(a,l)=>this.getGlyphs(a,l)),this.dispatcher.registerMessageHandler("GI",(a,l)=>this.getImages(a,l)),this.imageManager=new pi,this.imageManager.setEventedParent(this),this.glyphManager=new oi(e._requestManager,s.localIdeographFontFamily),this.lineAtlas=new Dr(256,512),this.crossTileSymbolIndex=new Ja,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new h.ax,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("SR",h.ay()),Wr().on(Oe,this._rtlPluginLoaded),this.on("data",a=>{if(a.dataType!=="source"||a.sourceDataType!=="metadata")return;const l=this.sourceCaches[a.sourceId];if(!l)return;const d=l.getSource();if(d&&d.vectorLayerIds)for(const v in this._layers){const w=this._layers[v];w.source===d.id&&this._validateLayer(w)}})}loadURL(e,s={},a){this.fire(new h.k("dataloading",{dataType:"style"})),s.validate=typeof s.validate!="boolean"||s.validate;const l=this.map._requestManager.transformRequest(e,"Style");this._loadStyleRequest=new AbortController;const d=this._loadStyleRequest;h.h(l,this._loadStyleRequest).then(v=>{this._loadStyleRequest=null,this._load(v.data,s,a)}).catch(v=>{this._loadStyleRequest=null,v&&!d.signal.aborted&&this.fire(new h.j(v))})}loadJSON(e,s={},a){this.fire(new h.k("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,J.frameAsync(this._frameRequest).then(()=>{this._frameRequest=null,s.validate=s.validate!==!1,this._load(e,s,a)}).catch(()=>{})}loadEmpty(){this.fire(new h.k("dataloading",{dataType:"style"})),this._load($h,{validate:!1})}_load(e,s,a){var l;const d=s.transformStyle?s.transformStyle(a,e):e;if(!s.validate||!ss(this,h.u(d))){this._loaded=!0,this.stylesheet=d;for(const v in d.sources)this.addSource(v,d.sources[v],{validate:!1});d.sprite?this._loadSprite(d.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(d.glyphs),this._createLayers(),this.light=new si(this.stylesheet.light),this.sky=new Zi(this.stylesheet.sky),this.map.setTerrain((l=this.stylesheet.terrain)!==null&&l!==void 0?l:null),this.fire(new h.k("data",{dataType:"style"})),this.fire(new h.k("style.load"))}}_createLayers(){const e=h.az(this.stylesheet.layers);this.dispatcher.broadcast("SL",e),this._order=e.map(s=>s.id),this._layers={},this._serializedLayers=null;for(const s of e){const a=h.aA(s);a.setEventedParent(this,{layer:{id:s.id}}),this._layers[s.id]=a}}_loadSprite(e,s=!1,a=void 0){let l;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(d,v,w,I){return h._(this,void 0,void 0,function*(){const A=Bt(d),C=w>1?"@2x":"",M={},O={};for(const{id:V,url:H}of A){const ee=v.transformRequest(ji(H,C,".json"),"SpriteJSON");M[V]=h.h(ee,I);const re=v.transformRequest(ji(H,C,".png"),"SpriteImage");O[V]=Ct.getImage(re,I)}return yield Promise.all([...Object.values(M),...Object.values(O)]),function(V,H){return h._(this,void 0,void 0,function*(){const ee={};for(const re in V){ee[re]={};const se=J.getImageCanvasContext((yield H[re]).data),ae=(yield V[re]).data;for(const Y in ae){const{width:ue,height:pe,x:ye,y:Ce,sdf:Re,pixelRatio:qe,stretchX:Je,stretchY:Ne,content:Be,textFitWidth:rt,textFitHeight:It}=ae[Y];ee[re][Y]={data:null,pixelRatio:qe,sdf:Re,stretchX:Je,stretchY:Ne,content:Be,textFitWidth:rt,textFitHeight:It,spriteData:{width:ue,height:pe,x:ye,y:Ce,context:se}}}}return ee})}(M,O)})}(e,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then(d=>{if(this._spriteRequest=null,d)for(const v in d){this._spritesImagesIds[v]=[];const w=this._spritesImagesIds[v]?this._spritesImagesIds[v].filter(I=>!(I in d)):[];for(const I of w)this.imageManager.removeImage(I),this._changedImages[I]=!0;for(const I in d[v]){const A=v==="default"?I:`${v}:${I}`;this._spritesImagesIds[v].push(A),A in this.imageManager.images?this.imageManager.updateImage(A,d[v][I],!1):this.imageManager.addImage(A,d[v][I]),s&&(this._changedImages[A]=!0)}}}).catch(d=>{this._spriteRequest=null,l=d,this.fire(new h.j(l))}).finally(()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),s&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new h.k("data",{dataType:"style"})),a&&a(l)})}_unloadSprite(){for(const e of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(e),this._changedImages[e]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new h.k("data",{dataType:"style"}))}_validateLayer(e){const s=this.sourceCaches[e.source];if(!s)return;const a=e.sourceLayer;if(!a)return;const l=s.getSource();(l.type==="geojson"||l.vectorLayerIds&&l.vectorLayerIds.indexOf(a)===-1)&&this.fire(new h.j(new Error(`Source layer "${a}" does not exist on source "${l.id}" as specified by style layer "${e.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const e in this.sourceCaches)if(!this.sourceCaches[e].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(e,s=!1){const a=this._serializedAllLayers();if(!e||e.length===0)return Object.values(s?h.aB(a):a);const l=[];for(const d of e)if(a[d]){const v=s?h.aB(a[d]):a[d];l.push(v)}return l}_serializedAllLayers(){let e=this._serializedLayers;if(e)return e;e=this._serializedLayers={};const s=Object.keys(this._layers);for(const a of s){const l=this._layers[a];l.type!=="custom"&&(e[a]=l.serialize())}return e}hasTransitions(){if(this.light&&this.light.hasTransition()||this.sky&&this.sky.hasTransition())return!0;for(const e in this.sourceCaches)if(this.sourceCaches[e].hasTransition())return!0;for(const e in this._layers)if(this._layers[e].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(e){if(!this._loaded)return;const s=this._changed;if(s){const l=Object.keys(this._updatedLayers),d=Object.keys(this._removedLayers);(l.length||d.length)&&this._updateWorkerLayers(l,d);for(const v in this._updatedSources){const w=this._updatedSources[v];if(w==="reload")this._reloadSource(v);else{if(w!=="clear")throw new Error(`Invalid action ${w}`);this._clearSource(v)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const v in this._updatedPaintProps)this._layers[v].updateTransitions(e);this.light.updateTransitions(e),this.sky.updateTransitions(e),this._resetUpdates()}const a={};for(const l in this.sourceCaches){const d=this.sourceCaches[l];a[l]=d.used,d.used=!1}for(const l of this._order){const d=this._layers[l];d.recalculate(e,this._availableImages),!d.isHidden(e.zoom)&&d.source&&(this.sourceCaches[d.source].used=!0)}for(const l in a){const d=this.sourceCaches[l];!!a[l]!=!!d.used&&d.fire(new h.k("data",{sourceDataType:"visibility",dataType:"source",sourceId:l}))}this.light.recalculate(e),this.sky.recalculate(e),this.z=e.zoom,s&&this.fire(new h.k("data",{dataType:"style"}))}_updateTilesForChangedImages(){const e=Object.keys(this._changedImages);if(e.length){for(const s in this.sourceCaches)this.sourceCaches[s].reloadTilesForDependencies(["icons","patterns"],e);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const e in this.sourceCaches)this.sourceCaches[e].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(e,s){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(e,!1),removedIds:s})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(e,s={}){var a;this._checkLoaded();const l=this.serialize();if(e=s.transformStyle?s.transformStyle(l,e):e,((a=s.validate)===null||a===void 0||a)&&ss(this,h.u(e)))return!1;(e=h.aB(e)).layers=h.az(e.layers);const d=h.aC(l,e),v=this._getOperationsToPerform(d);if(v.unimplemented.length>0)throw new Error(`Unimplemented: ${v.unimplemented.join(", ")}.`);if(v.operations.length===0)return!1;for(const w of v.operations)w();return this.stylesheet=e,this._serializedLayers=null,!0}_getOperationsToPerform(e){const s=[],a=[];for(const l of e)switch(l.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":continue;case"addLayer":s.push(()=>this.addLayer.apply(this,l.args));break;case"removeLayer":s.push(()=>this.removeLayer.apply(this,l.args));break;case"setPaintProperty":s.push(()=>this.setPaintProperty.apply(this,l.args));break;case"setLayoutProperty":s.push(()=>this.setLayoutProperty.apply(this,l.args));break;case"setFilter":s.push(()=>this.setFilter.apply(this,l.args));break;case"addSource":s.push(()=>this.addSource.apply(this,l.args));break;case"removeSource":s.push(()=>this.removeSource.apply(this,l.args));break;case"setLayerZoomRange":s.push(()=>this.setLayerZoomRange.apply(this,l.args));break;case"setLight":s.push(()=>this.setLight.apply(this,l.args));break;case"setGeoJSONSourceData":s.push(()=>this.setGeoJSONSourceData.apply(this,l.args));break;case"setGlyphs":s.push(()=>this.setGlyphs.apply(this,l.args));break;case"setSprite":s.push(()=>this.setSprite.apply(this,l.args));break;case"setSky":s.push(()=>this.setSky.apply(this,l.args));break;case"setTerrain":s.push(()=>this.map.setTerrain.apply(this,l.args));break;case"setTransition":s.push(()=>{});break;default:a.push(l.command)}return{operations:s,unimplemented:a}}addImage(e,s){if(this.getImage(e))return this.fire(new h.j(new Error(`An image named "${e}" already exists.`)));this.imageManager.addImage(e,s),this._afterImageUpdated(e)}updateImage(e,s){this.imageManager.updateImage(e,s)}getImage(e){return this.imageManager.getImage(e)}removeImage(e){if(!this.getImage(e))return this.fire(new h.j(new Error(`An image named "${e}" does not exist.`)));this.imageManager.removeImage(e),this._afterImageUpdated(e)}_afterImageUpdated(e){this._availableImages=this.imageManager.listImages(),this._changedImages[e]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new h.k("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(e,s,a={}){if(this._checkLoaded(),this.sourceCaches[e]!==void 0)throw new Error(`Source "${e}" already exists.`);if(!s.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(s).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(s.type)>=0&&this._validate(h.u.source,`sources.${e}`,s,null,a))return;this.map&&this.map._collectResourceTiming&&(s.collectResourceTiming=!0);const l=this.sourceCaches[e]=new pt(e,s,this.dispatcher);l.style=this,l.setEventedParent(this,()=>({isSourceLoaded:l.loaded(),source:l.serialize(),sourceId:e})),l.onAdd(this.map),this._changed=!0}removeSource(e){if(this._checkLoaded(),this.sourceCaches[e]===void 0)throw new Error("There is no source with this ID");for(const a in this._layers)if(this._layers[a].source===e)return this.fire(new h.j(new Error(`Source "${e}" cannot be removed while layer "${a}" is using it.`)));const s=this.sourceCaches[e];delete this.sourceCaches[e],delete this._updatedSources[e],s.fire(new h.k("data",{sourceDataType:"metadata",dataType:"source",sourceId:e})),s.setEventedParent(null),s.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(e,s){if(this._checkLoaded(),this.sourceCaches[e]===void 0)throw new Error(`There is no source with this ID=${e}`);const a=this.sourceCaches[e].getSource();if(a.type!=="geojson")throw new Error(`geojsonSource.type is ${a.type}, which is !== 'geojson`);a.setData(s),this._changed=!0}getSource(e){return this.sourceCaches[e]&&this.sourceCaches[e].getSource()}addLayer(e,s,a={}){this._checkLoaded();const l=e.id;if(this.getLayer(l))return void this.fire(new h.j(new Error(`Layer "${l}" already exists on this map.`)));let d;if(e.type==="custom"){if(ss(this,h.aD(e)))return;d=h.aA(e)}else{if("source"in e&&typeof e.source=="object"&&(this.addSource(l,e.source),e=h.aB(e),e=h.e(e,{source:l})),this._validate(h.u.layer,`layers.${l}`,e,{arrayIndex:-1},a))return;d=h.aA(e),this._validateLayer(d),d.setEventedParent(this,{layer:{id:l}})}const v=s?this._order.indexOf(s):this._order.length;if(s&&v===-1)this.fire(new h.j(new Error(`Cannot add layer "${l}" before non-existing layer "${s}".`)));else{if(this._order.splice(v,0,l),this._layerOrderChanged=!0,this._layers[l]=d,this._removedLayers[l]&&d.source&&d.type!=="custom"){const w=this._removedLayers[l];delete this._removedLayers[l],w.type!==d.type?this._updatedSources[d.source]="clear":(this._updatedSources[d.source]="reload",this.sourceCaches[d.source].pause())}this._updateLayer(d),d.onAdd&&d.onAdd(this.map)}}moveLayer(e,s){if(this._checkLoaded(),this._changed=!0,!this._layers[e])return void this.fire(new h.j(new Error(`The layer '${e}' does not exist in the map's style and cannot be moved.`)));if(e===s)return;const a=this._order.indexOf(e);this._order.splice(a,1);const l=s?this._order.indexOf(s):this._order.length;s&&l===-1?this.fire(new h.j(new Error(`Cannot move layer "${e}" before non-existing layer "${s}".`))):(this._order.splice(l,0,e),this._layerOrderChanged=!0)}removeLayer(e){this._checkLoaded();const s=this._layers[e];if(!s)return void this.fire(new h.j(new Error(`Cannot remove non-existing layer "${e}".`)));s.setEventedParent(null);const a=this._order.indexOf(e);this._order.splice(a,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[e]=s,delete this._layers[e],this._serializedLayers&&delete this._serializedLayers[e],delete this._updatedLayers[e],delete this._updatedPaintProps[e],s.onRemove&&s.onRemove(this.map)}getLayer(e){return this._layers[e]}getLayersOrder(){return[...this._order]}hasLayer(e){return e in this._layers}setLayerZoomRange(e,s,a){this._checkLoaded();const l=this.getLayer(e);l?l.minzoom===s&&l.maxzoom===a||(s!=null&&(l.minzoom=s),a!=null&&(l.maxzoom=a),this._updateLayer(l)):this.fire(new h.j(new Error(`Cannot set the zoom range of non-existing layer "${e}".`)))}setFilter(e,s,a={}){this._checkLoaded();const l=this.getLayer(e);if(l){if(!h.aE(l.filter,s))return s==null?(l.filter=void 0,void this._updateLayer(l)):void(this._validate(h.u.filter,`layers.${l.id}.filter`,s,null,a)||(l.filter=h.aB(s),this._updateLayer(l)))}else this.fire(new h.j(new Error(`Cannot filter non-existing layer "${e}".`)))}getFilter(e){return h.aB(this.getLayer(e).filter)}setLayoutProperty(e,s,a,l={}){this._checkLoaded();const d=this.getLayer(e);d?h.aE(d.getLayoutProperty(s),a)||(d.setLayoutProperty(s,a,l),this._updateLayer(d)):this.fire(new h.j(new Error(`Cannot style non-existing layer "${e}".`)))}getLayoutProperty(e,s){const a=this.getLayer(e);if(a)return a.getLayoutProperty(s);this.fire(new h.j(new Error(`Cannot get style of non-existing layer "${e}".`)))}setPaintProperty(e,s,a,l={}){this._checkLoaded();const d=this.getLayer(e);d?h.aE(d.getPaintProperty(s),a)||(d.setPaintProperty(s,a,l)&&this._updateLayer(d),this._changed=!0,this._updatedPaintProps[e]=!0,this._serializedLayers=null):this.fire(new h.j(new Error(`Cannot style non-existing layer "${e}".`)))}getPaintProperty(e,s){return this.getLayer(e).getPaintProperty(s)}setFeatureState(e,s){this._checkLoaded();const a=e.source,l=e.sourceLayer,d=this.sourceCaches[a];if(d===void 0)return void this.fire(new h.j(new Error(`The source '${a}' does not exist in the map's style.`)));const v=d.getSource().type;v==="geojson"&&l?this.fire(new h.j(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):v!=="vector"||l?(e.id===void 0&&this.fire(new h.j(new Error("The feature id parameter must be provided."))),d.setFeatureState(l,e.id,s)):this.fire(new h.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(e,s){this._checkLoaded();const a=e.source,l=this.sourceCaches[a];if(l===void 0)return void this.fire(new h.j(new Error(`The source '${a}' does not exist in the map's style.`)));const d=l.getSource().type,v=d==="vector"?e.sourceLayer:void 0;d!=="vector"||v?s&&typeof e.id!="string"&&typeof e.id!="number"?this.fire(new h.j(new Error("A feature id is required to remove its specific state property."))):l.removeFeatureState(v,e.id,s):this.fire(new h.j(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(e){this._checkLoaded();const s=e.source,a=e.sourceLayer,l=this.sourceCaches[s];if(l!==void 0)return l.getSource().type!=="vector"||a?(e.id===void 0&&this.fire(new h.j(new Error("The feature id parameter must be provided."))),l.getFeatureState(a,e.id)):void this.fire(new h.j(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new h.j(new Error(`The source '${s}' does not exist in the map's style.`)))}getTransition(){return h.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const e=h.aF(this.sourceCaches,d=>d.serialize()),s=this._serializeByIds(this._order,!0),a=this.map.getTerrain()||void 0,l=this.stylesheet;return h.aG({version:l.version,name:l.name,metadata:l.metadata,light:l.light,sky:l.sky,center:l.center,zoom:l.zoom,bearing:l.bearing,pitch:l.pitch,sprite:l.sprite,glyphs:l.glyphs,transition:l.transition,sources:e,layers:s,terrain:a},d=>d!==void 0)}_updateLayer(e){this._updatedLayers[e.id]=!0,e.source&&!this._updatedSources[e.source]&&this.sourceCaches[e.source].getSource().type!=="raster"&&(this._updatedSources[e.source]="reload",this.sourceCaches[e.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(e){const s=v=>this._layers[v].type==="fill-extrusion",a={},l=[];for(let v=this._order.length-1;v>=0;v--){const w=this._order[v];if(s(w)){a[w]=v;for(const I of e){const A=I[w];if(A)for(const C of A)l.push(C)}}}l.sort((v,w)=>w.intersectionZ-v.intersectionZ);const d=[];for(let v=this._order.length-1;v>=0;v--){const w=this._order[v];if(s(w))for(let I=l.length-1;I>=0;I--){const A=l[I].feature;if(a[A.layer.id]<v)break;d.push(A),l.pop()}else for(const I of e){const A=I[w];if(A)for(const C of A)d.push(C.feature)}}return d}queryRenderedFeatures(e,s,a){s&&s.filter&&this._validate(h.u.filter,"queryRenderedFeatures.filter",s.filter,null,s);const l={};if(s&&s.layers){if(!Array.isArray(s.layers))return this.fire(new h.j(new Error("parameters.layers must be an Array."))),[];for(const w of s.layers){const I=this._layers[w];if(!I)return this.fire(new h.j(new Error(`The layer '${w}' does not exist in the map's style and cannot be queried for features.`))),[];l[I.source]=!0}}const d=[];s.availableImages=this._availableImages;const v=this._serializedAllLayers();for(const w in this.sourceCaches)s.layers&&!l[w]||d.push(Rr(this.sourceCaches[w],this._layers,v,e,s,a));return this.placement&&d.push(function(w,I,A,C,M,O,V){const H={},ee=O.queryRenderedSymbols(C),re=[];for(const se of Object.keys(ee).map(Number))re.push(V[se]);re.sort(Or);for(const se of re){const ae=se.featureIndex.lookupSymbolFeatures(ee[se.bucketInstanceId],I,se.bucketIndex,se.sourceLayerIndex,M.filter,M.layers,M.availableImages,w);for(const Y in ae){const ue=H[Y]=H[Y]||[],pe=ae[Y];pe.sort((ye,Ce)=>{const Re=se.featureSortOrder;if(Re){const qe=Re.indexOf(ye.featureIndex);return Re.indexOf(Ce.featureIndex)-qe}return Ce.featureIndex-ye.featureIndex});for(const ye of pe)ue.push(ye)}}for(const se in H)H[se].forEach(ae=>{const Y=ae.feature,ue=A[w[se].source].getFeatureState(Y.layer["source-layer"],Y.id);Y.source=Y.layer.source,Y.layer["source-layer"]&&(Y.sourceLayer=Y.layer["source-layer"]),Y.state=ue});return H}(this._layers,v,this.sourceCaches,e,s,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(d)}querySourceFeatures(e,s){s&&s.filter&&this._validate(h.u.filter,"querySourceFeatures.filter",s.filter,null,s);const a=this.sourceCaches[e];return a?function(l,d){const v=l.getRenderableIds().map(A=>l.getTileByID(A)),w=[],I={};for(let A=0;A<v.length;A++){const C=v[A],M=C.tileID.canonical.key;I[M]||(I[M]=!0,C.querySourceFeatures(w,d))}return w}(a,s):[]}getLight(){return this.light.getLight()}setLight(e,s={}){this._checkLoaded();const a=this.light.getLight();let l=!1;for(const v in e)if(!h.aE(e[v],a[v])){l=!0;break}if(!l)return;const d={now:J.now(),transition:h.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(e,s),this.light.updateTransitions(d)}getSky(){var e;return(e=this.stylesheet)===null||e===void 0?void 0:e.sky}setSky(e,s={}){const a=this.getSky();let l=!1;if(!e&&!a)return;if(e&&!a)l=!0;else if(!e&&a)l=!0;else for(const v in e)if(!h.aE(e[v],a[v])){l=!0;break}if(!l)return;const d={now:J.now(),transition:h.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=e,this.sky.setSky(e,s),this.sky.updateTransitions(d)}_validate(e,s,a,l,d={}){return(!d||d.validate!==!1)&&ss(this,e.call(h.u,h.e({key:s,style:this.serialize(),value:a,styleSpec:h.v},l)))}_remove(e=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),Wr().off(Oe,this._rtlPluginLoaded);for(const s in this._layers)this._layers[s].setEventedParent(null);for(const s in this.sourceCaches){const a=this.sourceCaches[s];a.setEventedParent(null),a.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),e&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(e)}_clearSource(e){this.sourceCaches[e].clearTiles()}_reloadSource(e){this.sourceCaches[e].resume(),this.sourceCaches[e].reload()}_updateSources(e){for(const s in this.sourceCaches)this.sourceCaches[s].update(e,this.map.terrain)}_generateCollisionBoxes(){for(const e in this.sourceCaches)this._reloadSource(e)}_updatePlacement(e,s,a,l,d=!1){let v=!1,w=!1;const I={};for(const A of this._order){const C=this._layers[A];if(C.type!=="symbol")continue;if(!I[C.source]){const O=this.sourceCaches[C.source];I[C.source]=O.getRenderableIds(!0).map(V=>O.getTileByID(V)).sort((V,H)=>H.tileID.overscaledZ-V.tileID.overscaledZ||(V.tileID.isLessThan(H.tileID)?-1:1))}const M=this.crossTileSymbolIndex.addLayer(C,I[C.source],e.center.lng);v=v||M}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((d=d||this._layerOrderChanged||a===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(J.now(),e.zoom))&&(this.pauseablePlacement=new Xr(e,this.map.terrain,this._order,d,s,a,l,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,I),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(J.now()),w=!0),v&&this.pauseablePlacement.placement.setStale()),w||v)for(const A of this._order){const C=this._layers[A];C.type==="symbol"&&this.placement.updateLayerOpacities(C,I[C.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(J.now())}_releaseSymbolFadeTiles(){for(const e in this.sourceCaches)this.sourceCaches[e].releaseSymbolFadeTiles()}getImages(e,s){return h._(this,void 0,void 0,function*(){const a=yield this.imageManager.getImages(s.icons);this._updateTilesForChangedImages();const l=this.sourceCaches[s.source];return l&&l.setDependencies(s.tileID.key,s.type,s.icons),a})}getGlyphs(e,s){return h._(this,void 0,void 0,function*(){const a=yield this.glyphManager.getGlyphs(s.stacks),l=this.sourceCaches[s.source];return l&&l.setDependencies(s.tileID.key,s.type,[""]),a})}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(e,s={}){this._checkLoaded(),e&&this._validate(h.u.glyphs,"glyphs",e,null,s)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=e,this.glyphManager.entries={},this.glyphManager.setURL(e))}addSprite(e,s,a={},l){this._checkLoaded();const d=[{id:e,url:s}],v=[...Bt(this.stylesheet.sprite),...d];this._validate(h.u.sprite,"sprite",v,null,a)||(this.stylesheet.sprite=v,this._loadSprite(d,!0,l))}removeSprite(e){this._checkLoaded();const s=Bt(this.stylesheet.sprite);if(s.find(a=>a.id===e)){if(this._spritesImagesIds[e])for(const a of this._spritesImagesIds[e])this.imageManager.removeImage(a),this._changedImages[a]=!0;s.splice(s.findIndex(a=>a.id===e),1),this.stylesheet.sprite=s.length>0?s:void 0,delete this._spritesImagesIds[e],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new h.k("data",{dataType:"style"}))}else this.fire(new h.j(new Error(`Sprite "${e}" doesn't exists on this map.`)))}getSprite(){return Bt(this.stylesheet.sprite)}setSprite(e,s={},a){this._checkLoaded(),e&&this._validate(h.u.sprite,"sprite",e,null,s)||(this.stylesheet.sprite=e,e?this._loadSprite(e,!0,a):(this._unloadSprite(),a&&a(null)))}}var cn=h.Y([{name:"a_pos",type:"Int16",components:2}]);const Hs={prelude:Wt(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture2D(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture2D(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}`),background:Wt(`uniform vec4 u_color;uniform float u_opacity;void main() {gl_FragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),backgroundPattern:Wt(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:Wt(`varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));gl_FragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;varying vec3 v_data;varying float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);float ele=get_elevation(circle_center);v_visibility=calculate_visibility(u_matrix*vec4(circle_center,ele,1.0));if (u_pitch_with_map) {vec2 corner_position=circle_center;if (u_scale_with_map) {corner_position+=extrude*(radius+stroke_width)*u_extrude_scale;} else {vec4 projected_center=u_matrix*vec4(circle_center,0,1);corner_position+=extrude*(radius+stroke_width)*u_extrude_scale*(projected_center.w/u_camera_to_center_distance);}gl_Position=u_matrix*vec4(corner_position,ele,1);} else {gl_Position=u_matrix*vec4(circle_center,ele,1);if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:Wt("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Wt(`uniform highp float u_intensity;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;varying vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec4 pos=vec4(floor(a_pos*0.5)+extrude,get_elevation(floor(a_pos*0.5)),1);gl_Position=u_matrix*pos;}`),heatmapTexture:Wt(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:Wt("varying float v_placed;varying float v_notUsed;void main() {float alpha=0.5;gl_FragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {gl_FragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {gl_FragColor*=.1;}}","attribute vec2 a_anchor_pos;attribute vec2 a_placed;attribute vec2 a_box_real;uniform mat4 u_matrix;uniform vec2 u_pixel_extrude_scale;varying float v_placed;varying float v_notUsed;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Wt("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Wt("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,get_elevation(a_pos),1);}"),fill:Wt(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_FragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);}`),fillOutline:Wt(`varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=outline_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillOutlinePattern:Wt(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}`),fillPattern:Wt(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:Wt(`varying vec4 v_color;void main() {gl_FragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t > 0.0 ? height : base,1);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:Wt(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);gl_FragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec2 a_pos;attribute vec4 a_normal_ed;
#ifdef TERRAIN3D
attribute vec2 a_centroid;
#endif
varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float z=t > 0.0 ? height : base;gl_Position=u_matrix*vec4(a_pos,z,1);vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:Wt(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Wt(`uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;
#define PI 3.141592653589793
void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;}"),line:Wt(`uniform lowp float u_device_pixel_ratio;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp float v_linesofar;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:Wt(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture2D(u_image,v_uv);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
attribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_uv_x;attribute float a_split_index;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec2 v_uv;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:Wt(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);gl_FragColor=color*alpha*opacity;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:Wt(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture2D(u_image,v_tex_a).a;float sdfdist_b=texture2D(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);gl_FragColor=color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
attribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:Wt(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);gl_FragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale )+0.5;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}"),symbolIcon:Wt(`uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec2 v_tex;varying float v_fade_opacity;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:Wt(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec2 v_data0;varying vec3 v_data1;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:Wt(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
gl_FragColor=vec4(1.0);
#endif
}`,`attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;varying vec4 v_data0;varying vec4 v_data1;vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_matrix*vec4(posInTile,elevation,1.0);}
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:Wt("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;varying vec2 v_texture_pos;varying float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture2D(u_texture,v_texture_pos);if (v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);gl_FragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {gl_FragColor=surface_color;}}","attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform mat4 u_fog_matrix;uniform float u_ele_delta;varying vec2 v_texture_pos;varying float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=u_matrix*vec4(a_pos3d.xy,ele-ele_delta,1.0);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:Wt("varying float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {gl_FragColor=pack(v_depth);}","attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform float u_ele_delta;varying float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=u_matrix*vec4(a_pos3d.xy,ele-ele_delta,1.0);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:Wt("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;varying vec2 v_texture_pos;void main() {vec4 rgba=texture2D(u_texture,v_texture_pos);gl_FragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform float u_ele_delta;varying vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=u_matrix*vec4(a_pos3d.xy,ele-ele_delta,1.0);}"),sky:Wt("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform float u_horizon;uniform float u_sky_horizon_blend;void main() {float y=gl_FragCoord.y;if (y > u_horizon) {float blend=y-u_horizon;if (blend < u_sky_horizon_blend) {gl_FragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {gl_FragColor=u_sky_color;}}}","attribute vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function Wt(p,e){const s=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,a=e.match(/attribute ([\w]+) ([\w]+)/g),l=p.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),d=e.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),v=d?d.concat(l):l,w={};return{fragmentSource:p=p.replace(s,(I,A,C,M,O)=>(w[O]=!0,A==="define"?`
#ifndef HAS_UNIFORM_u_${O}
varying ${C} ${M} ${O};
#else
uniform ${C} ${M} u_${O};
#endif
`:`
#ifdef HAS_UNIFORM_u_${O}
    ${C} ${M} ${O} = u_${O};
#endif
`)),vertexSource:e=e.replace(s,(I,A,C,M,O)=>{const V=M==="float"?"vec2":"vec4",H=O.match(/color/)?"color":V;return w[O]?A==="define"?`
#ifndef HAS_UNIFORM_u_${O}
uniform lowp float u_${O}_t;
attribute ${C} ${V} a_${O};
varying ${C} ${M} ${O};
#else
uniform ${C} ${M} u_${O};
#endif
`:H==="vec4"?`
#ifndef HAS_UNIFORM_u_${O}
    ${O} = a_${O};
#else
    ${C} ${M} ${O} = u_${O};
#endif
`:`
#ifndef HAS_UNIFORM_u_${O}
    ${O} = unpack_mix_${H}(a_${O}, u_${O}_t);
#else
    ${C} ${M} ${O} = u_${O};
#endif
`:A==="define"?`
#ifndef HAS_UNIFORM_u_${O}
uniform lowp float u_${O}_t;
attribute ${C} ${V} a_${O};
#else
uniform ${C} ${M} u_${O};
#endif
`:H==="vec4"?`
#ifndef HAS_UNIFORM_u_${O}
    ${C} ${M} ${O} = a_${O};
#else
    ${C} ${M} ${O} = u_${O};
#endif
`:`
#ifndef HAS_UNIFORM_u_${O}
    ${C} ${M} ${O} = unpack_mix_${H}(a_${O}, u_${O}_t);
#else
    ${C} ${M} ${O} = u_${O};
#endif
`}),staticAttributes:a,staticUniforms:v}}class Ka{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(e,s,a,l,d,v,w,I,A){this.context=e;let C=this.boundPaintVertexBuffers.length!==l.length;for(let M=0;!C&&M<l.length;M++)this.boundPaintVertexBuffers[M]!==l[M]&&(C=!0);!this.vao||this.boundProgram!==s||this.boundLayoutVertexBuffer!==a||C||this.boundIndexBuffer!==d||this.boundVertexOffset!==v||this.boundDynamicVertexBuffer!==w||this.boundDynamicVertexBuffer2!==I||this.boundDynamicVertexBuffer3!==A?this.freshBind(s,a,l,d,v,w,I,A):(e.bindVertexArray.set(this.vao),w&&w.bind(),d&&d.dynamicDraw&&d.bind(),I&&I.bind(),A&&A.bind())}freshBind(e,s,a,l,d,v,w,I){const A=e.numAttributes,C=this.context,M=C.gl;this.vao&&this.destroy(),this.vao=C.createVertexArray(),C.bindVertexArray.set(this.vao),this.boundProgram=e,this.boundLayoutVertexBuffer=s,this.boundPaintVertexBuffers=a,this.boundIndexBuffer=l,this.boundVertexOffset=d,this.boundDynamicVertexBuffer=v,this.boundDynamicVertexBuffer2=w,this.boundDynamicVertexBuffer3=I,s.enableAttributes(M,e);for(const O of a)O.enableAttributes(M,e);v&&v.enableAttributes(M,e),w&&w.enableAttributes(M,e),I&&I.enableAttributes(M,e),s.bind(),s.setVertexAttribPointers(M,e,d);for(const O of a)O.bind(),O.setVertexAttribPointers(M,e,d);v&&(v.bind(),v.setVertexAttribPointers(M,e,d)),l&&l.bind(),w&&(w.bind(),w.setVertexAttribPointers(M,e,d)),I&&(I.bind(),I.setVertexAttribPointers(M,e,d)),C.currentNumAttributes=A}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const Ya=(p,e,s,a,l)=>({u_matrix:p,u_texture:0,u_ele_delta:e,u_fog_matrix:s,u_fog_color:a?a.properties.get("fog-color"):h.aM.white,u_fog_ground_blend:a?a.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:a?a.calculateFogBlendOpacity(l):0,u_horizon_color:a?a.properties.get("horizon-color"):h.aM.white,u_horizon_fog_blend:a?a.properties.get("horizon-fog-blend"):1});function Rn(p){const e=[];for(let s=0;s<p.length;s++){if(p[s]===null)continue;const a=p[s].split(" ");e.push(a.pop())}return e}class Qa{constructor(e,s,a,l,d,v){const w=e.gl;this.program=w.createProgram();const I=Rn(s.staticAttributes),A=a?a.getBinderAttributes():[],C=I.concat(A),M=Hs.prelude.staticUniforms?Rn(Hs.prelude.staticUniforms):[],O=s.staticUniforms?Rn(s.staticUniforms):[],V=a?a.getBinderUniforms():[],H=M.concat(O).concat(V),ee=[];for(const ye of H)ee.indexOf(ye)<0&&ee.push(ye);const re=a?a.defines():[];d&&re.push("#define OVERDRAW_INSPECTOR;"),v&&re.push("#define TERRAIN3D;");const se=re.concat(Hs.prelude.fragmentSource,s.fragmentSource).join(`
`),ae=re.concat(Hs.prelude.vertexSource,s.vertexSource).join(`
`),Y=w.createShader(w.FRAGMENT_SHADER);if(w.isContextLost())return void(this.failedToCreate=!0);if(w.shaderSource(Y,se),w.compileShader(Y),!w.getShaderParameter(Y,w.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${w.getShaderInfoLog(Y)}`);w.attachShader(this.program,Y);const ue=w.createShader(w.VERTEX_SHADER);if(w.isContextLost())return void(this.failedToCreate=!0);if(w.shaderSource(ue,ae),w.compileShader(ue),!w.getShaderParameter(ue,w.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${w.getShaderInfoLog(ue)}`);w.attachShader(this.program,ue),this.attributes={};const pe={};this.numAttributes=C.length;for(let ye=0;ye<this.numAttributes;ye++)C[ye]&&(w.bindAttribLocation(this.program,ye,C[ye]),this.attributes[C[ye]]=ye);if(w.linkProgram(this.program),!w.getProgramParameter(this.program,w.LINK_STATUS))throw new Error(`Program failed to link: ${w.getProgramInfoLog(this.program)}`);w.deleteShader(ue),w.deleteShader(Y);for(let ye=0;ye<ee.length;ye++){const Ce=ee[ye];if(Ce&&!pe[Ce]){const Re=w.getUniformLocation(this.program,Ce);Re&&(pe[Ce]=Re)}}this.fixedUniforms=l(e,pe),this.terrainUniforms=((ye,Ce)=>({u_depth:new h.aH(ye,Ce.u_depth),u_terrain:new h.aH(ye,Ce.u_terrain),u_terrain_dim:new h.aI(ye,Ce.u_terrain_dim),u_terrain_matrix:new h.aJ(ye,Ce.u_terrain_matrix),u_terrain_unpack:new h.aK(ye,Ce.u_terrain_unpack),u_terrain_exaggeration:new h.aI(ye,Ce.u_terrain_exaggeration)}))(e,pe),this.binderUniforms=a?a.getUniforms(e,pe):[]}draw(e,s,a,l,d,v,w,I,A,C,M,O,V,H,ee,re,se,ae){const Y=e.gl;if(this.failedToCreate)return;if(e.program.set(this.program),e.setDepthMode(a),e.setStencilMode(l),e.setColorMode(d),e.setCullFace(v),I){e.activeTexture.set(Y.TEXTURE2),Y.bindTexture(Y.TEXTURE_2D,I.depthTexture),e.activeTexture.set(Y.TEXTURE3),Y.bindTexture(Y.TEXTURE_2D,I.texture);for(const pe in this.terrainUniforms)this.terrainUniforms[pe].set(I[pe])}for(const pe in this.fixedUniforms)this.fixedUniforms[pe].set(w[pe]);ee&&ee.setUniforms(e,this.binderUniforms,V,{zoom:H});let ue=0;switch(s){case Y.LINES:ue=2;break;case Y.TRIANGLES:ue=3;break;case Y.LINE_STRIP:ue=1}for(const pe of O.get()){const ye=pe.vaos||(pe.vaos={});(ye[A]||(ye[A]=new Ka)).bind(e,this,C,ee?ee.getPaintVertexBuffers():[],M,pe.vertexOffset,re,se,ae),Y.drawElements(s,pe.primitiveLength*ue,Y.UNSIGNED_SHORT,pe.primitiveOffset*ue*2)}}}function Jo(p,e,s){const a=1/Et(s,1,e.transform.tileZoom),l=Math.pow(2,s.tileID.overscaledZ),d=s.tileSize*Math.pow(2,e.transform.tileZoom)/l,v=d*(s.tileID.canonical.x+s.tileID.wrap*l),w=d*s.tileID.canonical.y;return{u_image:0,u_texsize:s.imageAtlasTexture.size,u_scale:[a,p.fromScale,p.toScale],u_fade:p.t,u_pixel_coord_upper:[v>>16,w>>16],u_pixel_coord_lower:[65535&v,65535&w]}}const lo=(p,e,s,a)=>{const l=e.style.light,d=l.properties.get("position"),v=[d.x,d.y,d.z],w=function(){var A=new h.A(9);return h.A!=Float32Array&&(A[1]=0,A[2]=0,A[3]=0,A[5]=0,A[6]=0,A[7]=0),A[0]=1,A[4]=1,A[8]=1,A}();l.properties.get("anchor")==="viewport"&&function(A,C){var M=Math.sin(C),O=Math.cos(C);A[0]=O,A[1]=M,A[2]=0,A[3]=-M,A[4]=O,A[5]=0,A[6]=0,A[7]=0,A[8]=1}(w,-e.transform.angle),function(A,C,M){var O=C[0],V=C[1],H=C[2];A[0]=O*M[0]+V*M[3]+H*M[6],A[1]=O*M[1]+V*M[4]+H*M[7],A[2]=O*M[2]+V*M[5]+H*M[8]}(v,v,w);const I=l.properties.get("color");return{u_matrix:p,u_lightpos:v,u_lightintensity:l.properties.get("intensity"),u_lightcolor:[I.r,I.g,I.b],u_vertical_gradient:+s,u_opacity:a}},Ko=(p,e,s,a,l,d,v)=>h.e(lo(p,e,s,a),Jo(d,e,v),{u_height_factor:-Math.pow(2,l.overscaledZ)/v.tileSize/8}),On=p=>({u_matrix:p}),uc=(p,e,s,a)=>h.e(On(p),Jo(s,e,a)),Uh=(p,e)=>({u_matrix:p,u_world:e}),dc=(p,e,s,a,l)=>h.e(uc(p,e,s,a),{u_world:l}),Vh=(p,e,s,a)=>{const l=p.transform;let d,v;if(a.paint.get("circle-pitch-alignment")==="map"){const w=Et(s,1,l.zoom);d=!0,v=[w,w]}else d=!1,v=l.pixelsToGLUnits;return{u_camera_to_center_distance:l.cameraToCenterDistance,u_scale_with_map:+(a.paint.get("circle-pitch-scale")==="map"),u_matrix:p.translatePosMatrix(e.posMatrix,s,a.paint.get("circle-translate"),a.paint.get("circle-translate-anchor")),u_pitch_with_map:+d,u_device_pixel_ratio:p.pixelRatio,u_extrude_scale:v}},hn=(p,e,s)=>({u_matrix:p,u_inv_matrix:e,u_camera_to_center_distance:s.cameraToCenterDistance,u_viewport_size:[s.width,s.height]}),co=(p,e,s=1)=>({u_matrix:p,u_color:e,u_overlay:0,u_overlay_scale:s}),Sr=p=>({u_matrix:p}),Ir=(p,e,s,a)=>({u_matrix:p,u_extrude_scale:Et(e,1,s),u_intensity:a}),Yo=(p,e,s,a)=>{const l=h.H();h.aP(l,0,p.width,p.height,0,0,1);const d=p.context.gl;return{u_matrix:l,u_world:[d.drawingBufferWidth,d.drawingBufferHeight],u_image:s,u_color_ramp:a,u_opacity:e.paint.get("heatmap-opacity")}};function Qo(p,e){const s=Math.pow(2,e.canonical.z),a=e.canonical.y;return[new h.Z(0,a/s).toLngLat().lat,new h.Z(0,(a+1)/s).toLngLat().lat]}const ea=(p,e,s,a)=>{const l=p.transform;return{u_matrix:mc(p,e,s,a),u_ratio:1/Et(e,1,l.zoom),u_device_pixel_ratio:p.pixelRatio,u_units_to_pixels:[1/l.pixelsToGLUnits[0],1/l.pixelsToGLUnits[1]]}},pc=(p,e,s,a,l)=>h.e(ea(p,e,s,l),{u_image:0,u_image_height:a}),Fn=(p,e,s,a,l)=>{const d=p.transform,v=fc(e,d);return{u_matrix:mc(p,e,s,l),u_texsize:e.imageAtlasTexture.size,u_ratio:1/Et(e,1,d.zoom),u_device_pixel_ratio:p.pixelRatio,u_image:0,u_scale:[v,a.fromScale,a.toScale],u_fade:a.t,u_units_to_pixels:[1/d.pixelsToGLUnits[0],1/d.pixelsToGLUnits[1]]}},qh=(p,e,s,a,l,d)=>{const v=p.lineAtlas,w=fc(e,p.transform),I=s.layout.get("line-cap")==="round",A=v.getDash(a.from,I),C=v.getDash(a.to,I),M=A.width*l.fromScale,O=C.width*l.toScale;return h.e(ea(p,e,s,d),{u_patternscale_a:[w/M,-A.height/2],u_patternscale_b:[w/O,-C.height/2],u_sdfgamma:v.width/(256*Math.min(M,O)*p.pixelRatio)/2,u_image:0,u_tex_y_a:A.y,u_tex_y_b:C.y,u_mix:l.t})};function fc(p,e){return 1/Et(p,1,e.tileZoom)}function mc(p,e,s,a){return p.translatePosMatrix(a?a.posMatrix:e.tileID.posMatrix,e,s.paint.get("line-translate"),s.paint.get("line-translate-anchor"))}const Gh=(p,e,s,a,l)=>{return{u_matrix:p,u_tl_parent:e,u_scale_parent:s,u_buffer_scale:1,u_fade_t:a.mix,u_opacity:a.opacity*l.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:l.paint.get("raster-brightness-min"),u_brightness_high:l.paint.get("raster-brightness-max"),u_saturation_factor:(v=l.paint.get("raster-saturation"),v>0?1-1/(1.001-v):-v),u_contrast_factor:(d=l.paint.get("raster-contrast"),d>0?1/(1-d):1+d),u_spin_weights:Hh(l.paint.get("raster-hue-rotate"))};var d,v};function Hh(p){p*=Math.PI/180;const e=Math.sin(p),s=Math.cos(p);return[(2*s+1)/3,(-Math.sqrt(3)*e-s+1)/3,(Math.sqrt(3)*e-s+1)/3]}const _c=(p,e,s,a,l,d,v,w,I,A,C,M,O,V)=>{const H=v.transform;return{u_is_size_zoom_constant:+(p==="constant"||p==="source"),u_is_size_feature_constant:+(p==="constant"||p==="camera"),u_size_t:e?e.uSizeT:0,u_size:e?e.uSize:0,u_camera_to_center_distance:H.cameraToCenterDistance,u_pitch:H.pitch/360*2*Math.PI,u_rotate_symbol:+s,u_aspect_ratio:H.width/H.height,u_fade_change:v.options.fadeDuration?v.symbolFadeChange:1,u_matrix:w,u_label_plane_matrix:I,u_coord_matrix:A,u_is_text:+M,u_pitch_with_map:+a,u_is_along_line:l,u_is_variable_anchor:d,u_texsize:O,u_texture:0,u_translation:C,u_pitched_scale:V}},ho=(p,e,s,a,l,d,v,w,I,A,C,M,O,V,H)=>{const ee=v.transform;return h.e(_c(p,e,s,a,l,d,v,w,I,A,C,M,O,H),{u_gamma_scale:a?Math.cos(ee._pitch)*ee.cameraToCenterDistance:1,u_device_pixel_ratio:v.pixelRatio,u_is_halo:+V})},el=(p,e,s,a,l,d,v,w,I,A,C,M,O,V)=>h.e(ho(p,e,s,a,l,d,v,w,I,A,C,!0,M,!0,V),{u_texsize_icon:O,u_texture_icon:1}),ta=(p,e,s)=>({u_matrix:p,u_opacity:e,u_color:s}),tl=(p,e,s,a,l,d)=>h.e(function(v,w,I,A){const C=I.imageManager.getPattern(v.from.toString()),M=I.imageManager.getPattern(v.to.toString()),{width:O,height:V}=I.imageManager.getPixelSize(),H=Math.pow(2,A.tileID.overscaledZ),ee=A.tileSize*Math.pow(2,I.transform.tileZoom)/H,re=ee*(A.tileID.canonical.x+A.tileID.wrap*H),se=ee*A.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:C.tl,u_pattern_br_a:C.br,u_pattern_tl_b:M.tl,u_pattern_br_b:M.br,u_texsize:[O,V],u_mix:w.t,u_pattern_size_a:C.displaySize,u_pattern_size_b:M.displaySize,u_scale_a:w.fromScale,u_scale_b:w.toScale,u_tile_units_to_pixels:1/Et(A,1,I.transform.tileZoom),u_pixel_coord_upper:[re>>16,se>>16],u_pixel_coord_lower:[65535&re,65535&se]}}(a,d,s,l),{u_matrix:p,u_opacity:e}),il={fillExtrusion:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_lightpos:new h.aN(p,e.u_lightpos),u_lightintensity:new h.aI(p,e.u_lightintensity),u_lightcolor:new h.aN(p,e.u_lightcolor),u_vertical_gradient:new h.aI(p,e.u_vertical_gradient),u_opacity:new h.aI(p,e.u_opacity)}),fillExtrusionPattern:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_lightpos:new h.aN(p,e.u_lightpos),u_lightintensity:new h.aI(p,e.u_lightintensity),u_lightcolor:new h.aN(p,e.u_lightcolor),u_vertical_gradient:new h.aI(p,e.u_vertical_gradient),u_height_factor:new h.aI(p,e.u_height_factor),u_image:new h.aH(p,e.u_image),u_texsize:new h.aO(p,e.u_texsize),u_pixel_coord_upper:new h.aO(p,e.u_pixel_coord_upper),u_pixel_coord_lower:new h.aO(p,e.u_pixel_coord_lower),u_scale:new h.aN(p,e.u_scale),u_fade:new h.aI(p,e.u_fade),u_opacity:new h.aI(p,e.u_opacity)}),fill:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix)}),fillPattern:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_image:new h.aH(p,e.u_image),u_texsize:new h.aO(p,e.u_texsize),u_pixel_coord_upper:new h.aO(p,e.u_pixel_coord_upper),u_pixel_coord_lower:new h.aO(p,e.u_pixel_coord_lower),u_scale:new h.aN(p,e.u_scale),u_fade:new h.aI(p,e.u_fade)}),fillOutline:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_world:new h.aO(p,e.u_world)}),fillOutlinePattern:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_world:new h.aO(p,e.u_world),u_image:new h.aH(p,e.u_image),u_texsize:new h.aO(p,e.u_texsize),u_pixel_coord_upper:new h.aO(p,e.u_pixel_coord_upper),u_pixel_coord_lower:new h.aO(p,e.u_pixel_coord_lower),u_scale:new h.aN(p,e.u_scale),u_fade:new h.aI(p,e.u_fade)}),circle:(p,e)=>({u_camera_to_center_distance:new h.aI(p,e.u_camera_to_center_distance),u_scale_with_map:new h.aH(p,e.u_scale_with_map),u_pitch_with_map:new h.aH(p,e.u_pitch_with_map),u_extrude_scale:new h.aO(p,e.u_extrude_scale),u_device_pixel_ratio:new h.aI(p,e.u_device_pixel_ratio),u_matrix:new h.aJ(p,e.u_matrix)}),collisionBox:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_pixel_extrude_scale:new h.aO(p,e.u_pixel_extrude_scale)}),collisionCircle:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_inv_matrix:new h.aJ(p,e.u_inv_matrix),u_camera_to_center_distance:new h.aI(p,e.u_camera_to_center_distance),u_viewport_size:new h.aO(p,e.u_viewport_size)}),debug:(p,e)=>({u_color:new h.aL(p,e.u_color),u_matrix:new h.aJ(p,e.u_matrix),u_overlay:new h.aH(p,e.u_overlay),u_overlay_scale:new h.aI(p,e.u_overlay_scale)}),clippingMask:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix)}),heatmap:(p,e)=>({u_extrude_scale:new h.aI(p,e.u_extrude_scale),u_intensity:new h.aI(p,e.u_intensity),u_matrix:new h.aJ(p,e.u_matrix)}),heatmapTexture:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_world:new h.aO(p,e.u_world),u_image:new h.aH(p,e.u_image),u_color_ramp:new h.aH(p,e.u_color_ramp),u_opacity:new h.aI(p,e.u_opacity)}),hillshade:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_image:new h.aH(p,e.u_image),u_latrange:new h.aO(p,e.u_latrange),u_light:new h.aO(p,e.u_light),u_shadow:new h.aL(p,e.u_shadow),u_highlight:new h.aL(p,e.u_highlight),u_accent:new h.aL(p,e.u_accent)}),hillshadePrepare:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_image:new h.aH(p,e.u_image),u_dimension:new h.aO(p,e.u_dimension),u_zoom:new h.aI(p,e.u_zoom),u_unpack:new h.aK(p,e.u_unpack)}),line:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_ratio:new h.aI(p,e.u_ratio),u_device_pixel_ratio:new h.aI(p,e.u_device_pixel_ratio),u_units_to_pixels:new h.aO(p,e.u_units_to_pixels)}),lineGradient:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_ratio:new h.aI(p,e.u_ratio),u_device_pixel_ratio:new h.aI(p,e.u_device_pixel_ratio),u_units_to_pixels:new h.aO(p,e.u_units_to_pixels),u_image:new h.aH(p,e.u_image),u_image_height:new h.aI(p,e.u_image_height)}),linePattern:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_texsize:new h.aO(p,e.u_texsize),u_ratio:new h.aI(p,e.u_ratio),u_device_pixel_ratio:new h.aI(p,e.u_device_pixel_ratio),u_image:new h.aH(p,e.u_image),u_units_to_pixels:new h.aO(p,e.u_units_to_pixels),u_scale:new h.aN(p,e.u_scale),u_fade:new h.aI(p,e.u_fade)}),lineSDF:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_ratio:new h.aI(p,e.u_ratio),u_device_pixel_ratio:new h.aI(p,e.u_device_pixel_ratio),u_units_to_pixels:new h.aO(p,e.u_units_to_pixels),u_patternscale_a:new h.aO(p,e.u_patternscale_a),u_patternscale_b:new h.aO(p,e.u_patternscale_b),u_sdfgamma:new h.aI(p,e.u_sdfgamma),u_image:new h.aH(p,e.u_image),u_tex_y_a:new h.aI(p,e.u_tex_y_a),u_tex_y_b:new h.aI(p,e.u_tex_y_b),u_mix:new h.aI(p,e.u_mix)}),raster:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_tl_parent:new h.aO(p,e.u_tl_parent),u_scale_parent:new h.aI(p,e.u_scale_parent),u_buffer_scale:new h.aI(p,e.u_buffer_scale),u_fade_t:new h.aI(p,e.u_fade_t),u_opacity:new h.aI(p,e.u_opacity),u_image0:new h.aH(p,e.u_image0),u_image1:new h.aH(p,e.u_image1),u_brightness_low:new h.aI(p,e.u_brightness_low),u_brightness_high:new h.aI(p,e.u_brightness_high),u_saturation_factor:new h.aI(p,e.u_saturation_factor),u_contrast_factor:new h.aI(p,e.u_contrast_factor),u_spin_weights:new h.aN(p,e.u_spin_weights)}),symbolIcon:(p,e)=>({u_is_size_zoom_constant:new h.aH(p,e.u_is_size_zoom_constant),u_is_size_feature_constant:new h.aH(p,e.u_is_size_feature_constant),u_size_t:new h.aI(p,e.u_size_t),u_size:new h.aI(p,e.u_size),u_camera_to_center_distance:new h.aI(p,e.u_camera_to_center_distance),u_pitch:new h.aI(p,e.u_pitch),u_rotate_symbol:new h.aH(p,e.u_rotate_symbol),u_aspect_ratio:new h.aI(p,e.u_aspect_ratio),u_fade_change:new h.aI(p,e.u_fade_change),u_matrix:new h.aJ(p,e.u_matrix),u_label_plane_matrix:new h.aJ(p,e.u_label_plane_matrix),u_coord_matrix:new h.aJ(p,e.u_coord_matrix),u_is_text:new h.aH(p,e.u_is_text),u_pitch_with_map:new h.aH(p,e.u_pitch_with_map),u_is_along_line:new h.aH(p,e.u_is_along_line),u_is_variable_anchor:new h.aH(p,e.u_is_variable_anchor),u_texsize:new h.aO(p,e.u_texsize),u_texture:new h.aH(p,e.u_texture),u_translation:new h.aO(p,e.u_translation),u_pitched_scale:new h.aI(p,e.u_pitched_scale)}),symbolSDF:(p,e)=>({u_is_size_zoom_constant:new h.aH(p,e.u_is_size_zoom_constant),u_is_size_feature_constant:new h.aH(p,e.u_is_size_feature_constant),u_size_t:new h.aI(p,e.u_size_t),u_size:new h.aI(p,e.u_size),u_camera_to_center_distance:new h.aI(p,e.u_camera_to_center_distance),u_pitch:new h.aI(p,e.u_pitch),u_rotate_symbol:new h.aH(p,e.u_rotate_symbol),u_aspect_ratio:new h.aI(p,e.u_aspect_ratio),u_fade_change:new h.aI(p,e.u_fade_change),u_matrix:new h.aJ(p,e.u_matrix),u_label_plane_matrix:new h.aJ(p,e.u_label_plane_matrix),u_coord_matrix:new h.aJ(p,e.u_coord_matrix),u_is_text:new h.aH(p,e.u_is_text),u_pitch_with_map:new h.aH(p,e.u_pitch_with_map),u_is_along_line:new h.aH(p,e.u_is_along_line),u_is_variable_anchor:new h.aH(p,e.u_is_variable_anchor),u_texsize:new h.aO(p,e.u_texsize),u_texture:new h.aH(p,e.u_texture),u_gamma_scale:new h.aI(p,e.u_gamma_scale),u_device_pixel_ratio:new h.aI(p,e.u_device_pixel_ratio),u_is_halo:new h.aH(p,e.u_is_halo),u_translation:new h.aO(p,e.u_translation),u_pitched_scale:new h.aI(p,e.u_pitched_scale)}),symbolTextAndIcon:(p,e)=>({u_is_size_zoom_constant:new h.aH(p,e.u_is_size_zoom_constant),u_is_size_feature_constant:new h.aH(p,e.u_is_size_feature_constant),u_size_t:new h.aI(p,e.u_size_t),u_size:new h.aI(p,e.u_size),u_camera_to_center_distance:new h.aI(p,e.u_camera_to_center_distance),u_pitch:new h.aI(p,e.u_pitch),u_rotate_symbol:new h.aH(p,e.u_rotate_symbol),u_aspect_ratio:new h.aI(p,e.u_aspect_ratio),u_fade_change:new h.aI(p,e.u_fade_change),u_matrix:new h.aJ(p,e.u_matrix),u_label_plane_matrix:new h.aJ(p,e.u_label_plane_matrix),u_coord_matrix:new h.aJ(p,e.u_coord_matrix),u_is_text:new h.aH(p,e.u_is_text),u_pitch_with_map:new h.aH(p,e.u_pitch_with_map),u_is_along_line:new h.aH(p,e.u_is_along_line),u_is_variable_anchor:new h.aH(p,e.u_is_variable_anchor),u_texsize:new h.aO(p,e.u_texsize),u_texsize_icon:new h.aO(p,e.u_texsize_icon),u_texture:new h.aH(p,e.u_texture),u_texture_icon:new h.aH(p,e.u_texture_icon),u_gamma_scale:new h.aI(p,e.u_gamma_scale),u_device_pixel_ratio:new h.aI(p,e.u_device_pixel_ratio),u_is_halo:new h.aH(p,e.u_is_halo),u_translation:new h.aO(p,e.u_translation),u_pitched_scale:new h.aI(p,e.u_pitched_scale)}),background:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_opacity:new h.aI(p,e.u_opacity),u_color:new h.aL(p,e.u_color)}),backgroundPattern:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_opacity:new h.aI(p,e.u_opacity),u_image:new h.aH(p,e.u_image),u_pattern_tl_a:new h.aO(p,e.u_pattern_tl_a),u_pattern_br_a:new h.aO(p,e.u_pattern_br_a),u_pattern_tl_b:new h.aO(p,e.u_pattern_tl_b),u_pattern_br_b:new h.aO(p,e.u_pattern_br_b),u_texsize:new h.aO(p,e.u_texsize),u_mix:new h.aI(p,e.u_mix),u_pattern_size_a:new h.aO(p,e.u_pattern_size_a),u_pattern_size_b:new h.aO(p,e.u_pattern_size_b),u_scale_a:new h.aI(p,e.u_scale_a),u_scale_b:new h.aI(p,e.u_scale_b),u_pixel_coord_upper:new h.aO(p,e.u_pixel_coord_upper),u_pixel_coord_lower:new h.aO(p,e.u_pixel_coord_lower),u_tile_units_to_pixels:new h.aI(p,e.u_tile_units_to_pixels)}),terrain:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_texture:new h.aH(p,e.u_texture),u_ele_delta:new h.aI(p,e.u_ele_delta),u_fog_matrix:new h.aJ(p,e.u_fog_matrix),u_fog_color:new h.aL(p,e.u_fog_color),u_fog_ground_blend:new h.aI(p,e.u_fog_ground_blend),u_fog_ground_blend_opacity:new h.aI(p,e.u_fog_ground_blend_opacity),u_horizon_color:new h.aL(p,e.u_horizon_color),u_horizon_fog_blend:new h.aI(p,e.u_horizon_fog_blend)}),terrainDepth:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_ele_delta:new h.aI(p,e.u_ele_delta)}),terrainCoords:(p,e)=>({u_matrix:new h.aJ(p,e.u_matrix),u_texture:new h.aH(p,e.u_texture),u_terrain_coords_id:new h.aI(p,e.u_terrain_coords_id),u_ele_delta:new h.aI(p,e.u_ele_delta)}),sky:(p,e)=>({u_sky_color:new h.aL(p,e.u_sky_color),u_horizon_color:new h.aL(p,e.u_horizon_color),u_horizon:new h.aI(p,e.u_horizon),u_sky_horizon_blend:new h.aI(p,e.u_sky_horizon_blend)})};class Ts{constructor(e,s,a){this.context=e;const l=e.gl;this.buffer=l.createBuffer(),this.dynamicDraw=!!a,this.context.unbindVAO(),e.bindElementBuffer.set(this.buffer),l.bufferData(l.ELEMENT_ARRAY_BUFFER,s.arrayBuffer,this.dynamicDraw?l.DYNAMIC_DRAW:l.STATIC_DRAW),this.dynamicDraw||delete s.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(e){const s=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),s.bufferSubData(s.ELEMENT_ARRAY_BUFFER,0,e.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Zh={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class rl{constructor(e,s,a,l){this.length=s.length,this.attributes=a,this.itemSize=s.bytesPerElement,this.dynamicDraw=l,this.context=e;const d=e.gl;this.buffer=d.createBuffer(),e.bindVertexBuffer.set(this.buffer),d.bufferData(d.ARRAY_BUFFER,s.arrayBuffer,this.dynamicDraw?d.DYNAMIC_DRAW:d.STATIC_DRAW),this.dynamicDraw||delete s.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(e){if(e.length!==this.length)throw new Error(`Length of new data is ${e.length}, which doesn't match current length of ${this.length}`);const s=this.context.gl;this.bind(),s.bufferSubData(s.ARRAY_BUFFER,0,e.arrayBuffer)}enableAttributes(e,s){for(let a=0;a<this.attributes.length;a++){const l=s.attributes[this.attributes[a].name];l!==void 0&&e.enableVertexAttribArray(l)}}setVertexAttribPointers(e,s,a){for(let l=0;l<this.attributes.length;l++){const d=this.attributes[l],v=s.attributes[d.name];v!==void 0&&e.vertexAttribPointer(v,d.components,e[Zh[d.type]],!1,this.itemSize,d.offset+this.itemSize*(a||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const un=new WeakMap;function Zs(p){var e;if(un.has(p))return un.get(p);{const s=(e=p.getParameter(p.VERSION))===null||e===void 0?void 0:e.startsWith("WebGL 2.0");return un.set(p,s),s}}class Kt{constructor(e){this.gl=e.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(e){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ia extends Kt{getDefault(){return h.aM.transparent}set(e){const s=this.current;(e.r!==s.r||e.g!==s.g||e.b!==s.b||e.a!==s.a||this.dirty)&&(this.gl.clearColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class Wh extends Kt{getDefault(){return 1}set(e){(e!==this.current||this.dirty)&&(this.gl.clearDepth(e),this.current=e,this.dirty=!1)}}class Bn extends Kt{getDefault(){return 0}set(e){(e!==this.current||this.dirty)&&(this.gl.clearStencil(e),this.current=e,this.dirty=!1)}}class Xh extends Kt{getDefault(){return[!0,!0,!0,!0]}set(e){const s=this.current;(e[0]!==s[0]||e[1]!==s[1]||e[2]!==s[2]||e[3]!==s[3]||this.dirty)&&(this.gl.colorMask(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class gc extends Kt{getDefault(){return!0}set(e){(e!==this.current||this.dirty)&&(this.gl.depthMask(e),this.current=e,this.dirty=!1)}}class Jh extends Kt{getDefault(){return 255}set(e){(e!==this.current||this.dirty)&&(this.gl.stencilMask(e),this.current=e,this.dirty=!1)}}class yc extends Kt{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(e){const s=this.current;(e.func!==s.func||e.ref!==s.ref||e.mask!==s.mask||this.dirty)&&(this.gl.stencilFunc(e.func,e.ref,e.mask),this.current=e,this.dirty=!1)}}class sl extends Kt{getDefault(){const e=this.gl;return[e.KEEP,e.KEEP,e.KEEP]}set(e){const s=this.current;(e[0]!==s[0]||e[1]!==s[1]||e[2]!==s[2]||this.dirty)&&(this.gl.stencilOp(e[0],e[1],e[2]),this.current=e,this.dirty=!1)}}class xc extends Kt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const s=this.gl;e?s.enable(s.STENCIL_TEST):s.disable(s.STENCIL_TEST),this.current=e,this.dirty=!1}}class vc extends Kt{getDefault(){return[0,1]}set(e){const s=this.current;(e[0]!==s[0]||e[1]!==s[1]||this.dirty)&&(this.gl.depthRange(e[0],e[1]),this.current=e,this.dirty=!1)}}class bc extends Kt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const s=this.gl;e?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST),this.current=e,this.dirty=!1}}class wc extends Kt{getDefault(){return this.gl.LESS}set(e){(e!==this.current||this.dirty)&&(this.gl.depthFunc(e),this.current=e,this.dirty=!1)}}class dn extends Kt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const s=this.gl;e?s.enable(s.BLEND):s.disable(s.BLEND),this.current=e,this.dirty=!1}}class Sc extends Kt{getDefault(){const e=this.gl;return[e.ONE,e.ZERO]}set(e){const s=this.current;(e[0]!==s[0]||e[1]!==s[1]||this.dirty)&&(this.gl.blendFunc(e[0],e[1]),this.current=e,this.dirty=!1)}}class Kh extends Kt{getDefault(){return h.aM.transparent}set(e){const s=this.current;(e.r!==s.r||e.g!==s.g||e.b!==s.b||e.a!==s.a||this.dirty)&&(this.gl.blendColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class Ic extends Kt{getDefault(){return this.gl.FUNC_ADD}set(e){(e!==this.current||this.dirty)&&(this.gl.blendEquation(e),this.current=e,this.dirty=!1)}}class uo extends Kt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const s=this.gl;e?s.enable(s.CULL_FACE):s.disable(s.CULL_FACE),this.current=e,this.dirty=!1}}class ra extends Kt{getDefault(){return this.gl.BACK}set(e){(e!==this.current||this.dirty)&&(this.gl.cullFace(e),this.current=e,this.dirty=!1)}}class Yh extends Kt{getDefault(){return this.gl.CCW}set(e){(e!==this.current||this.dirty)&&(this.gl.frontFace(e),this.current=e,this.dirty=!1)}}class Qh extends Kt{getDefault(){return null}set(e){(e!==this.current||this.dirty)&&(this.gl.useProgram(e),this.current=e,this.dirty=!1)}}class Tc extends Kt{getDefault(){return this.gl.TEXTURE0}set(e){(e!==this.current||this.dirty)&&(this.gl.activeTexture(e),this.current=e,this.dirty=!1)}}class kc extends Kt{getDefault(){const e=this.gl;return[0,0,e.drawingBufferWidth,e.drawingBufferHeight]}set(e){const s=this.current;(e[0]!==s[0]||e[1]!==s[1]||e[2]!==s[2]||e[3]!==s[3]||this.dirty)&&(this.gl.viewport(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class Ec extends Kt{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const s=this.gl;s.bindFramebuffer(s.FRAMEBUFFER,e),this.current=e,this.dirty=!1}}class nl extends Kt{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const s=this.gl;s.bindRenderbuffer(s.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class Ac extends Kt{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const s=this.gl;s.bindTexture(s.TEXTURE_2D,e),this.current=e,this.dirty=!1}}class sa extends Kt{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const s=this.gl;s.bindBuffer(s.ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class Ds extends Kt{getDefault(){return null}set(e){const s=this.gl;s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class ol extends Kt{getDefault(){return null}set(e){var s;if(e===this.current&&!this.dirty)return;const a=this.gl;Zs(a)?a.bindVertexArray(e):(s=a.getExtension("OES_vertex_array_object"))===null||s===void 0||s.bindVertexArrayOES(e),this.current=e,this.dirty=!1}}class al extends Kt{getDefault(){return 4}set(e){if(e===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_ALIGNMENT,e),this.current=e,this.dirty=!1}}class ll extends Kt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e),this.current=e,this.dirty=!1}}class Pc extends Kt{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,e),this.current=e,this.dirty=!1}}class po extends Kt{constructor(e,s){super(e),this.context=e,this.parent=s}getDefault(){return null}}class pn extends po{setDirty(){this.dirty=!0}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const s=this.gl;s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class cl extends po{set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const s=this.gl;s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class eu extends po{set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const s=this.gl;s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class tu{constructor(e,s,a,l,d){this.context=e,this.width=s,this.height=a;const v=e.gl,w=this.framebuffer=v.createFramebuffer();if(this.colorAttachment=new pn(e,w),l)this.depthAttachment=d?new eu(e,w):new cl(e,w);else if(d)throw new Error("Stencil cannot be set without depth");if(v.checkFramebufferStatus(v.FRAMEBUFFER)!==v.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer is not complete")}destroy(){const e=this.context.gl,s=this.colorAttachment.get();if(s&&e.deleteTexture(s),this.depthAttachment){const a=this.depthAttachment.get();a&&e.deleteRenderbuffer(a)}e.deleteFramebuffer(this.framebuffer)}}class Pi{constructor(e,s,a){this.blendFunction=e,this.blendColor=s,this.mask=a}}Pi.Replace=[1,0],Pi.disabled=new Pi(Pi.Replace,h.aM.transparent,[!1,!1,!1,!1]),Pi.unblended=new Pi(Pi.Replace,h.aM.transparent,[!0,!0,!0,!0]),Pi.alphaBlended=new Pi([1,771],h.aM.transparent,[!0,!0,!0,!0]);class iu{constructor(e){var s,a;if(this.gl=e,this.clearColor=new ia(this),this.clearDepth=new Wh(this),this.clearStencil=new Bn(this),this.colorMask=new Xh(this),this.depthMask=new gc(this),this.stencilMask=new Jh(this),this.stencilFunc=new yc(this),this.stencilOp=new sl(this),this.stencilTest=new xc(this),this.depthRange=new vc(this),this.depthTest=new bc(this),this.depthFunc=new wc(this),this.blend=new dn(this),this.blendFunc=new Sc(this),this.blendColor=new Kh(this),this.blendEquation=new Ic(this),this.cullFace=new uo(this),this.cullFaceSide=new ra(this),this.frontFace=new Yh(this),this.program=new Qh(this),this.activeTexture=new Tc(this),this.viewport=new kc(this),this.bindFramebuffer=new Ec(this),this.bindRenderbuffer=new nl(this),this.bindTexture=new Ac(this),this.bindVertexBuffer=new sa(this),this.bindElementBuffer=new Ds(this),this.bindVertexArray=new ol(this),this.pixelStoreUnpack=new al(this),this.pixelStoreUnpackPremultiplyAlpha=new ll(this),this.pixelStoreUnpackFlipY=new Pc(this),this.extTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=e.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),Zs(e)){this.HALF_FLOAT=e.HALF_FLOAT;const l=e.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(s=e.RGBA16F)!==null&&s!==void 0?s:l==null?void 0:l.RGBA16F_EXT,this.RGB16F=(a=e.RGB16F)!==null&&a!==void 0?a:l==null?void 0:l.RGB16F_EXT,e.getExtension("EXT_color_buffer_float")}else{e.getExtension("EXT_color_buffer_half_float"),e.getExtension("OES_texture_half_float_linear");const l=e.getExtension("OES_texture_half_float");this.HALF_FLOAT=l==null?void 0:l.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(e,s){return new Ts(this,e,s)}createVertexBuffer(e,s,a){return new rl(this,e,s,a)}createRenderbuffer(e,s,a){const l=this.gl,d=l.createRenderbuffer();return this.bindRenderbuffer.set(d),l.renderbufferStorage(l.RENDERBUFFER,e,s,a),this.bindRenderbuffer.set(null),d}createFramebuffer(e,s,a,l){return new tu(this,e,s,a,l)}clear({color:e,depth:s,stencil:a}){const l=this.gl;let d=0;e&&(d|=l.COLOR_BUFFER_BIT,this.clearColor.set(e),this.colorMask.set([!0,!0,!0,!0])),s!==void 0&&(d|=l.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(s),this.depthMask.set(!0)),a!==void 0&&(d|=l.STENCIL_BUFFER_BIT,this.clearStencil.set(a),this.stencilMask.set(255)),l.clear(d)}setCullFace(e){e.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(e.mode),this.frontFace.set(e.frontFace))}setDepthMode(e){e.func!==this.gl.ALWAYS||e.mask?(this.depthTest.set(!0),this.depthFunc.set(e.func),this.depthMask.set(e.mask),this.depthRange.set(e.range)):this.depthTest.set(!1)}setStencilMode(e){e.test.func!==this.gl.ALWAYS||e.mask?(this.stencilTest.set(!0),this.stencilMask.set(e.mask),this.stencilOp.set([e.fail,e.depthFail,e.pass]),this.stencilFunc.set({func:e.test.func,ref:e.ref,mask:e.test.mask})):this.stencilTest.set(!1)}setColorMode(e){h.aE(e.blendFunction,Pi.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(e.blendFunction),this.blendColor.set(e.blendColor)),this.colorMask.set(e.mask)}createVertexArray(){var e;return Zs(this.gl)?this.gl.createVertexArray():(e=this.gl.getExtension("OES_vertex_array_object"))===null||e===void 0?void 0:e.createVertexArrayOES()}deleteVertexArray(e){var s;return Zs(this.gl)?this.gl.deleteVertexArray(e):(s=this.gl.getExtension("OES_vertex_array_object"))===null||s===void 0?void 0:s.deleteVertexArrayOES(e)}unbindVAO(){this.bindVertexArray.set(null)}}class Ot{constructor(e,s,a){this.func=e,this.mask=s,this.range=a}}Ot.ReadOnly=!1,Ot.ReadWrite=!0,Ot.disabled=new Ot(519,Ot.ReadOnly,[0,1]);const hl=7680;class ui{constructor(e,s,a,l,d,v){this.test=e,this.ref=s,this.mask=a,this.fail=l,this.depthFail=d,this.pass=v}}ui.disabled=new ui({func:519,mask:0},0,0,hl,hl,hl);class ei{constructor(e,s,a){this.enable=e,this.mode=s,this.frontFace=a}}let fn;function fo(p,e,s,a,l){const d=p.context,v=d.gl,w=p.useProgram("collisionBox"),I=[];let A=0,C=0;for(let se=0;se<a.length;se++){const ae=a[se],Y=e.getTile(ae).getBucket(s);if(!Y)continue;const ue=l?Y.textCollisionBox:Y.iconCollisionBox,pe=Y.collisionCircleArray;if(pe.length>0){const ye=h.H();h.aQ(ye,Y.placementInvProjMatrix,p.transform.glCoordMatrix),h.aQ(ye,ye,Y.placementViewportMatrix),I.push({circleArray:pe,circleOffset:C,transform:ae.posMatrix,invTransform:ye,coord:ae}),A+=pe.length/4,C=A}ue&&w.draw(d,v.LINES,Ot.disabled,ui.disabled,p.colorModeForRenderPass(),ei.disabled,{u_matrix:ae.posMatrix,u_pixel_extrude_scale:[1/(M=p.transform).width,1/M.height]},p.style.map.terrain&&p.style.map.terrain.getTerrainData(ae),s.id,ue.layoutVertexBuffer,ue.indexBuffer,ue.segments,null,p.transform.zoom,null,null,ue.collisionVertexBuffer)}var M;if(!l||!I.length)return;const O=p.useProgram("collisionCircle"),V=new h.aR;V.resize(4*A),V._trim();let H=0;for(const se of I)for(let ae=0;ae<se.circleArray.length/4;ae++){const Y=4*ae,ue=se.circleArray[Y+0],pe=se.circleArray[Y+1],ye=se.circleArray[Y+2],Ce=se.circleArray[Y+3];V.emplace(H++,ue,pe,ye,Ce,0),V.emplace(H++,ue,pe,ye,Ce,1),V.emplace(H++,ue,pe,ye,Ce,2),V.emplace(H++,ue,pe,ye,Ce,3)}(!fn||fn.length<2*A)&&(fn=function(se){const ae=2*se,Y=new h.aT;Y.resize(ae),Y._trim();for(let ue=0;ue<ae;ue++){const pe=6*ue;Y.uint16[pe+0]=4*ue+0,Y.uint16[pe+1]=4*ue+1,Y.uint16[pe+2]=4*ue+2,Y.uint16[pe+3]=4*ue+2,Y.uint16[pe+4]=4*ue+3,Y.uint16[pe+5]=4*ue+0}return Y}(A));const ee=d.createIndexBuffer(fn,!0),re=d.createVertexBuffer(V,h.aS.members,!0);for(const se of I){const ae=hn(se.transform,se.invTransform,p.transform);O.draw(d,v.TRIANGLES,Ot.disabled,ui.disabled,p.colorModeForRenderPass(),ei.disabled,ae,p.style.map.terrain&&p.style.map.terrain.getTerrainData(se.coord),s.id,re,ee,h.a0.simpleSegment(0,2*se.circleOffset,se.circleArray.length,se.circleArray.length/2),null,p.transform.zoom,null,null,null)}re.destroy(),ee.destroy()}ei.disabled=new ei(!1,1029,2305),ei.backCCW=new ei(!0,1029,2305);const na=h.an(new Float32Array(16));function mn(p,e,s,a,l,d){const{horizontalAlign:v,verticalAlign:w}=h.au(p);return new h.P((-(v-.5)*e/l+a[0])*d,(-(w-.5)*s/l+a[1])*d)}function jn(p,e,s,a,l,d){const v=e.tileAnchorPoint.add(new h.P(e.translation[0],e.translation[1]));if(e.pitchWithMap){let w=a.mult(d);s||(w=w.rotate(-l));const I=v.add(w);return te(I.x,I.y,e.labelPlaneMatrix,e.getElevation).point}if(s){const w=we(e.tileAnchorPoint.x+1,e.tileAnchorPoint.y,e).point.sub(p),I=Math.atan(w.y/w.x)+(w.x<0?Math.PI:0);return p.add(a.rotate(I))}return p.add(a)}function Jr(p,e,s,a,l,d,v,w,I,A,C,M,O,V){const H=p.text.placedSymbolArray,ee=p.text.dynamicLayoutVertexArray,re=p.icon.dynamicLayoutVertexArray,se={};ee.clear();for(let ae=0;ae<H.length;ae++){const Y=H.get(ae),ue=Y.hidden||!Y.crossTileID||p.allowVerticalPlacement&&!Y.placedOrientation?null:a[Y.crossTileID];if(ue){const pe=new h.P(Y.anchorX,Y.anchorY),ye={getElevation:V,width:l.width,height:l.height,labelPlaneMatrix:d,lineVertexArray:null,pitchWithMap:s,projection:C,projectionCache:null,tileAnchorPoint:pe,translation:M,unwrappedTileID:O},Ce=s?te(pe.x,pe.y,v,V):we(pe.x,pe.y,ye),Re=D(l.cameraToCenterDistance,Ce.signedDistanceFromCamera);let qe=h.ai(p.textSizeData,I,Y)*Re/h.ap;s&&(qe*=p.tilePixelRatio/w);const{width:Je,height:Ne,anchor:Be,textOffset:rt,textBoxScale:It}=ue,Ue=mn(Be,Je,Ne,rt,It,qe),Ze=C.getPitchedTextCorrection(l,pe.add(new h.P(M[0],M[1])),O),bt=jn(Ce.point,ye,e,Ue,l.angle,Ze),yi=p.allowVerticalPlacement&&Y.placedOrientation===h.ah.vertical?Math.PI/2:0;for(let Pt=0;Pt<Y.numGlyphs;Pt++)h.aj(ee,bt,yi);A&&Y.associatedIconIndex>=0&&(se[Y.associatedIconIndex]={shiftedAnchor:bt,angle:yi})}else ut(Y.numGlyphs,ee)}if(A){re.clear();const ae=p.icon.placedSymbolArray;for(let Y=0;Y<ae.length;Y++){const ue=ae.get(Y);if(ue.hidden)ut(ue.numGlyphs,re);else{const pe=se[Y];if(pe)for(let ye=0;ye<ue.numGlyphs;ye++)h.aj(re,pe.shiftedAnchor,pe.angle);else ut(ue.numGlyphs,re)}}p.icon.dynamicLayoutVertexBuffer.updateData(re)}p.text.dynamicLayoutVertexBuffer.updateData(ee)}function Cc(p,e,s){return s.iconsInText&&e?"symbolTextAndIcon":p?"symbolSDF":"symbolIcon"}function ul(p,e,s,a,l,d,v,w,I,A,C,M){const O=p.context,V=O.gl,H=p.transform,ee=Qt(),re=w==="map",se=I==="map",ae=w!=="viewport"&&s.layout.get("symbol-placement")!=="point",Y=re&&!se&&!ae,ue=!se&&ae,pe=!s.layout.get("symbol-sort-key").isConstant();let ye=!1;const Ce=p.depthModeForSublayer(0,Ot.ReadOnly),Re=s._unevaluatedLayout.hasValue("text-variable-anchor")||s._unevaluatedLayout.hasValue("text-variable-anchor-offset"),qe=[],Je=ee.getCircleRadiusCorrection(H);for(const Ne of a){const Be=e.getTile(Ne),rt=Be.getBucket(s);if(!rt)continue;const It=l?rt.text:rt.icon;if(!It||!It.segments.get().length||!It.hasVisibleVertices)continue;const Ue=It.programConfigurations.get(s.id),Ze=l||rt.sdfIcons,bt=l?rt.textSizeData:rt.iconSizeData,yi=se||H.pitch!==0,Pt=p.useProgram(Cc(Ze,l,rt),Ue),$t=h.ag(bt,H.zoom),xi=p.style.map.terrain&&p.style.map.terrain.getTerrainData(Ne);let rr,ls,vi,Er,fr=[0,0],mr=null;if(l)ls=Be.glyphAtlasTexture,vi=V.LINEAR,rr=Be.glyphAtlasTexture.size,rt.iconsInText&&(fr=Be.imageAtlasTexture.size,mr=Be.imageAtlasTexture,Er=yi||p.options.rotating||p.options.zooming||bt.kind==="composite"||bt.kind==="camera"?V.LINEAR:V.NEAREST);else{const Ei=s.layout.get("icon-size").constantOr(0)!==1||rt.iconsNeedLinear;ls=Be.imageAtlasTexture,vi=Ze||p.options.rotating||p.options.zooming||Ei||yi?V.LINEAR:V.NEAREST,rr=Be.imageAtlasTexture.size}const _r=Et(Be,1,p.transform.zoom),Es=ue?Ne.posMatrix:na,Zn=Br(Es,se,re,p.transform,_r),wa=wr(Es,se,re,p.transform,_r),cs=wr(Ne.posMatrix,se,re,p.transform,_r),In=ee.translatePosition(p.transform,Be,d,v),Sa=Re&&rt.hasTextData(),Cl=s.layout.get("icon-text-fit")!=="none"&&Sa&&rt.hasIconData();if(ae){const Ei=p.style.map.terrain?(Wn,Ia)=>p.style.map.terrain.getElevation(Ne,Wn,Ia):null,Ls=s.layout.get("text-rotation-alignment")==="map";j(rt,Ne.posMatrix,p,l,Zn,cs,se,A,Ls,ee,Ne.toUnwrapped(),H.width,H.height,In,Ei)}const jr=Ne.posMatrix,hs=l&&Re||Cl,Nr=ae||hs?na:Zn,Ks=wa,gr=Ze&&s.paint.get(l?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let sr;sr=Ze?rt.iconsInText?el(bt.kind,$t,Y,se,ae,hs,p,jr,Nr,Ks,In,rr,fr,Je):ho(bt.kind,$t,Y,se,ae,hs,p,jr,Nr,Ks,In,l,rr,!0,Je):_c(bt.kind,$t,Y,se,ae,hs,p,jr,Nr,Ks,In,l,rr,Je);const ai={program:Pt,buffers:It,uniformValues:sr,atlasTexture:ls,atlasTextureIcon:mr,atlasInterpolation:vi,atlasInterpolationIcon:Er,isSDF:Ze,hasHalo:gr};if(pe&&rt.canOverlap){ye=!0;const Ei=It.segments.get();for(const Ls of Ei)qe.push({segments:new h.a0([Ls]),sortKey:Ls.sortKey,state:ai,terrainData:xi})}else qe.push({segments:It.segments,sortKey:0,state:ai,terrainData:xi})}ye&&qe.sort((Ne,Be)=>Ne.sortKey-Be.sortKey);for(const Ne of qe){const Be=Ne.state;if(O.activeTexture.set(V.TEXTURE0),Be.atlasTexture.bind(Be.atlasInterpolation,V.CLAMP_TO_EDGE),Be.atlasTextureIcon&&(O.activeTexture.set(V.TEXTURE1),Be.atlasTextureIcon&&Be.atlasTextureIcon.bind(Be.atlasInterpolationIcon,V.CLAMP_TO_EDGE)),Be.isSDF){const rt=Be.uniformValues;Be.hasHalo&&(rt.u_is_halo=1,oa(Be.buffers,Ne.segments,s,p,Be.program,Ce,C,M,rt,Ne.terrainData)),rt.u_is_halo=0}oa(Be.buffers,Ne.segments,s,p,Be.program,Ce,C,M,Be.uniformValues,Ne.terrainData)}}function oa(p,e,s,a,l,d,v,w,I,A){const C=a.context;l.draw(C,C.gl.TRIANGLES,d,v,w,ei.disabled,I,A,s.id,p.layoutVertexBuffer,p.indexBuffer,e,s.paint,a.transform.zoom,p.programConfigurations.get(s.id),p.dynamicLayoutVertexBuffer,p.opacityVertexBuffer)}function _n(p,e,s,a){const l=p.context,d=l.gl,v=ui.disabled,w=new Pi([d.ONE,d.ONE],h.aM.transparent,[!0,!0,!0,!0]),I=e.getBucket(s);if(!I)return;const A=a.key;let C=s.heatmapFbos.get(A);C||(C=mo(l,e.tileSize,e.tileSize),s.heatmapFbos.set(A,C)),l.bindFramebuffer.set(C.framebuffer),l.viewport.set([0,0,e.tileSize,e.tileSize]),l.clear({color:h.aM.transparent});const M=I.programConfigurations.get(s.id),O=p.useProgram("heatmap",M),V=p.style.map.terrain.getTerrainData(a);O.draw(l,d.TRIANGLES,Ot.disabled,v,w,ei.disabled,Ir(a.posMatrix,e,p.transform.zoom,s.paint.get("heatmap-intensity")),V,s.id,I.layoutVertexBuffer,I.indexBuffer,I.segments,s.paint,p.transform.zoom,M)}function aa(p,e,s){const a=p.context,l=a.gl;a.setColorMode(p.colorModeForRenderPass());const d=Nn(a,e),v=s.key,w=e.heatmapFbos.get(v);w&&(a.activeTexture.set(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,w.colorAttachment.get()),a.activeTexture.set(l.TEXTURE1),d.bind(l.LINEAR,l.CLAMP_TO_EDGE),p.useProgram("heatmapTexture").draw(a,l.TRIANGLES,Ot.disabled,ui.disabled,p.colorModeForRenderPass(),ei.disabled,Yo(p,e,0,1),null,e.id,p.rasterBoundsBuffer,p.quadTriangleIndexBuffer,p.rasterBoundsSegments,e.paint,p.transform.zoom),w.destroy(),e.heatmapFbos.delete(v))}function mo(p,e,s){var a,l;const d=p.gl,v=d.createTexture();d.bindTexture(d.TEXTURE_2D,v),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR);const w=(a=p.HALF_FLOAT)!==null&&a!==void 0?a:d.UNSIGNED_BYTE,I=(l=p.RGBA16F)!==null&&l!==void 0?l:d.RGBA;d.texImage2D(d.TEXTURE_2D,0,I,e,s,0,d.RGBA,w,null);const A=p.createFramebuffer(e,s,!1,!1);return A.colorAttachment.set(v),A}function Nn(p,e){return e.colorRampTexture||(e.colorRampTexture=new Lt(p,e.colorRamp,p.gl.RGBA)),e.colorRampTexture}function _o(p,e,s,a,l){if(!s||!a||!a.imageAtlas)return;const d=a.imageAtlas.patternPositions;let v=d[s.to.toString()],w=d[s.from.toString()];if(!v&&w&&(v=w),!w&&v&&(w=v),!v||!w){const I=l.getPaintProperty(e);v=d[I],w=d[I]}v&&w&&p.setConstantPatternPositions(v,w)}function dl(p,e,s,a,l,d,v){const w=p.context.gl,I="fill-pattern",A=s.paint.get(I),C=A&&A.constantOr(1),M=s.getCrossfadeParameters();let O,V,H,ee,re;v?(V=C&&!s.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",O=w.LINES):(V=C?"fillPattern":"fill",O=w.TRIANGLES);const se=A.constantOr(null);for(const ae of a){const Y=e.getTile(ae);if(C&&!Y.patternsLoaded())continue;const ue=Y.getBucket(s);if(!ue)continue;const pe=ue.programConfigurations.get(s.id),ye=p.useProgram(V,pe),Ce=p.style.map.terrain&&p.style.map.terrain.getTerrainData(ae);C&&(p.context.activeTexture.set(w.TEXTURE0),Y.imageAtlasTexture.bind(w.LINEAR,w.CLAMP_TO_EDGE),pe.updatePaintBuffers(M)),_o(pe,I,se,Y,s);const Re=Ce?ae:null,qe=p.translatePosMatrix(Re?Re.posMatrix:ae.posMatrix,Y,s.paint.get("fill-translate"),s.paint.get("fill-translate-anchor"));if(v){ee=ue.indexBuffer2,re=ue.segments2;const Je=[w.drawingBufferWidth,w.drawingBufferHeight];H=V==="fillOutlinePattern"&&C?dc(qe,p,M,Y,Je):Uh(qe,Je)}else ee=ue.indexBuffer,re=ue.segments,H=C?uc(qe,p,M,Y):On(qe);ye.draw(p.context,O,l,p.stencilModeForClipping(ae),d,ei.disabled,H,Ce,s.id,ue.layoutVertexBuffer,ee,re,s.paint,p.transform.zoom,pe)}}function Ws(p,e,s,a,l,d,v){const w=p.context,I=w.gl,A="fill-extrusion-pattern",C=s.paint.get(A),M=C.constantOr(1),O=s.getCrossfadeParameters(),V=s.paint.get("fill-extrusion-opacity"),H=C.constantOr(null);for(const ee of a){const re=e.getTile(ee),se=re.getBucket(s);if(!se)continue;const ae=p.style.map.terrain&&p.style.map.terrain.getTerrainData(ee),Y=se.programConfigurations.get(s.id),ue=p.useProgram(M?"fillExtrusionPattern":"fillExtrusion",Y);M&&(p.context.activeTexture.set(I.TEXTURE0),re.imageAtlasTexture.bind(I.LINEAR,I.CLAMP_TO_EDGE),Y.updatePaintBuffers(O)),_o(Y,A,H,re,s);const pe=p.translatePosMatrix(ee.posMatrix,re,s.paint.get("fill-extrusion-translate"),s.paint.get("fill-extrusion-translate-anchor")),ye=s.paint.get("fill-extrusion-vertical-gradient"),Ce=M?Ko(pe,p,ye,V,ee,O,re):lo(pe,p,ye,V);ue.draw(w,w.gl.TRIANGLES,l,d,v,ei.backCCW,Ce,ae,s.id,se.layoutVertexBuffer,se.indexBuffer,se.segments,s.paint,p.transform.zoom,Y,p.style.map.terrain&&se.centroidVertexBuffer)}}function $n(p,e,s,a,l,d,v){const w=p.context,I=w.gl,A=s.fbo;if(!A)return;const C=p.useProgram("hillshade"),M=p.style.map.terrain&&p.style.map.terrain.getTerrainData(e);w.activeTexture.set(I.TEXTURE0),I.bindTexture(I.TEXTURE_2D,A.colorAttachment.get()),C.draw(w,I.TRIANGLES,l,d,v,ei.disabled,((O,V,H,ee)=>{const re=H.paint.get("hillshade-shadow-color"),se=H.paint.get("hillshade-highlight-color"),ae=H.paint.get("hillshade-accent-color");let Y=H.paint.get("hillshade-illumination-direction")*(Math.PI/180);H.paint.get("hillshade-illumination-anchor")==="viewport"&&(Y-=O.transform.angle);const ue=!O.options.moving;return{u_matrix:ee?ee.posMatrix:O.transform.calculatePosMatrix(V.tileID.toUnwrapped(),ue),u_image:0,u_latrange:Qo(0,V.tileID),u_light:[H.paint.get("hillshade-exaggeration"),Y],u_shadow:re,u_highlight:se,u_accent:ae}})(p,s,a,M?e:null),M,a.id,p.rasterBoundsBuffer,p.quadTriangleIndexBuffer,p.rasterBoundsSegments)}function Mc(p,e,s,a,l,d){const v=p.context,w=v.gl,I=e.dem;if(I&&I.data){const A=I.dim,C=I.stride,M=I.getPixels();if(v.activeTexture.set(w.TEXTURE1),v.pixelStoreUnpackPremultiplyAlpha.set(!1),e.demTexture=e.demTexture||p.getTileTexture(C),e.demTexture){const V=e.demTexture;V.update(M,{premultiply:!1}),V.bind(w.NEAREST,w.CLAMP_TO_EDGE)}else e.demTexture=new Lt(v,M,w.RGBA,{premultiply:!1}),e.demTexture.bind(w.NEAREST,w.CLAMP_TO_EDGE);v.activeTexture.set(w.TEXTURE0);let O=e.fbo;if(!O){const V=new Lt(v,{width:A,height:A,data:null},w.RGBA);V.bind(w.LINEAR,w.CLAMP_TO_EDGE),O=e.fbo=v.createFramebuffer(A,A,!0,!1),O.colorAttachment.set(V.texture)}v.bindFramebuffer.set(O.framebuffer),v.viewport.set([0,0,A,A]),p.useProgram("hillshadePrepare").draw(v,w.TRIANGLES,a,l,d,ei.disabled,((V,H)=>{const ee=H.stride,re=h.H();return h.aP(re,0,h.X,-h.X,0,0,1),h.J(re,re,[0,-h.X,0]),{u_matrix:re,u_image:1,u_dimension:[ee,ee],u_zoom:V.overscaledZ,u_unpack:H.getUnpackVector()}})(e.tileID,I),null,s.id,p.rasterBoundsBuffer,p.quadTriangleIndexBuffer,p.rasterBoundsSegments),e.needsHillshadePrepare=!1}}function pl(p,e,s,a,l,d){const v=a.paint.get("raster-fade-duration");if(!d&&v>0){const w=J.now(),I=(w-p.timeAdded)/v,A=e?(w-e.timeAdded)/v:-1,C=s.getSource(),M=l.coveringZoomLevel({tileSize:C.tileSize,roundZoom:C.roundZoom}),O=!e||Math.abs(e.tileID.overscaledZ-M)>Math.abs(p.tileID.overscaledZ-M),V=O&&p.refreshedUponExpiration?1:h.ac(O?I:1-A,0,1);return p.refreshedUponExpiration&&I>=1&&(p.refreshedUponExpiration=!1),e?{opacity:1,mix:1-V}:{opacity:V,mix:0}}return{opacity:1,mix:0}}const Ht=new h.aM(1,0,0,1),la=new h.aM(0,1,0,1),ru=new h.aM(0,0,1,1),zc=new h.aM(1,0,1,1),go=new h.aM(0,1,1,1);function Dc(p,e,s,a){yo(p,0,e+s/2,p.transform.width,s,a)}function Lc(p,e,s,a){yo(p,e-s/2,0,s,p.transform.height,a)}function yo(p,e,s,a,l,d){const v=p.context,w=v.gl;w.enable(w.SCISSOR_TEST),w.scissor(e*p.pixelRatio,s*p.pixelRatio,a*p.pixelRatio,l*p.pixelRatio),v.clear({color:d}),w.disable(w.SCISSOR_TEST)}function su(p,e,s){const a=p.context,l=a.gl,d=s.posMatrix,v=p.useProgram("debug"),w=Ot.disabled,I=ui.disabled,A=p.colorModeForRenderPass(),C="$debug",M=p.style.map.terrain&&p.style.map.terrain.getTerrainData(s);a.activeTexture.set(l.TEXTURE0);const O=e.getTileByID(s.key).latestRawTileData,V=Math.floor((O&&O.byteLength||0)/1024),H=e.getTile(s).tileSize,ee=512/Math.min(H,512)*(s.overscaledZ/p.transform.zoom)*.5;let re=s.canonical.toString();s.overscaledZ!==s.canonical.z&&(re+=` => ${s.overscaledZ}`),function(se,ae){se.initDebugOverlayCanvas();const Y=se.debugOverlayCanvas,ue=se.context.gl,pe=se.debugOverlayCanvas.getContext("2d");pe.clearRect(0,0,Y.width,Y.height),pe.shadowColor="white",pe.shadowBlur=2,pe.lineWidth=1.5,pe.strokeStyle="white",pe.textBaseline="top",pe.font="bold 36px Open Sans, sans-serif",pe.fillText(ae,5,5),pe.strokeText(ae,5,5),se.debugOverlayTexture.update(Y),se.debugOverlayTexture.bind(ue.LINEAR,ue.CLAMP_TO_EDGE)}(p,`${re} ${V}kB`),v.draw(a,l.TRIANGLES,w,I,Pi.alphaBlended,ei.disabled,co(d,h.aM.transparent,ee),null,C,p.debugBuffer,p.quadTriangleIndexBuffer,p.debugSegments),v.draw(a,l.LINE_STRIP,w,I,A,ei.disabled,co(d,h.aM.red),M,C,p.debugBuffer,p.tileBorderIndexBuffer,p.debugSegments)}function ca(p,e,s){const a=p.context,l=a.gl,d=p.colorModeForRenderPass(),v=new Ot(l.LEQUAL,Ot.ReadWrite,p.depthRangeFor3D),w=p.useProgram("terrain"),I=e.getTerrainMesh();a.bindFramebuffer.set(null),a.viewport.set([0,0,p.width,p.height]);for(const A of s){const C=p.renderToTexture.getTexture(A),M=e.getTerrainData(A.tileID);a.activeTexture.set(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,C.texture);const O=p.transform.calculatePosMatrix(A.tileID.toUnwrapped()),V=e.getMeshFrameDelta(p.transform.zoom),H=p.transform.calculateFogMatrix(A.tileID.toUnwrapped()),ee=Ya(O,V,H,p.style.sky,p.transform.pitch);w.draw(a,l.TRIANGLES,v,ui.disabled,d,ei.backCCW,ee,M,"terrain",I.vertexBuffer,I.indexBuffer,I.segments)}}class xo{constructor(e,s,a){this.vertexBuffer=e,this.indexBuffer=s,this.segments=a}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}class ha{constructor(e,s){this.context=new iu(e),this.transform=s,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:h.an(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=pt.maxUnderzooming+pt.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Ja}resize(e,s,a){if(this.width=Math.floor(e*a),this.height=Math.floor(s*a),this.pixelRatio=a,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const l of this.style._order)this.style._layers[l].resize()}setup(){const e=this.context,s=new h.aX;s.emplaceBack(0,0),s.emplaceBack(h.X,0),s.emplaceBack(0,h.X),s.emplaceBack(h.X,h.X),this.tileExtentBuffer=e.createVertexBuffer(s,cn.members),this.tileExtentSegments=h.a0.simpleSegment(0,0,4,2);const a=new h.aX;a.emplaceBack(0,0),a.emplaceBack(h.X,0),a.emplaceBack(0,h.X),a.emplaceBack(h.X,h.X),this.debugBuffer=e.createVertexBuffer(a,cn.members),this.debugSegments=h.a0.simpleSegment(0,0,4,5);const l=new h.$;l.emplaceBack(0,0,0,0),l.emplaceBack(h.X,0,h.X,0),l.emplaceBack(0,h.X,0,h.X),l.emplaceBack(h.X,h.X,h.X,h.X),this.rasterBoundsBuffer=e.createVertexBuffer(l,es.members),this.rasterBoundsSegments=h.a0.simpleSegment(0,0,4,2);const d=new h.aX;d.emplaceBack(0,0),d.emplaceBack(1,0),d.emplaceBack(0,1),d.emplaceBack(1,1),this.viewportBuffer=e.createVertexBuffer(d,cn.members),this.viewportSegments=h.a0.simpleSegment(0,0,4,2);const v=new h.aZ;v.emplaceBack(0),v.emplaceBack(1),v.emplaceBack(3),v.emplaceBack(2),v.emplaceBack(0),this.tileBorderIndexBuffer=e.createIndexBuffer(v);const w=new h.aY;w.emplaceBack(0,1,2),w.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=e.createIndexBuffer(w);const I=this.context.gl;this.stencilClearMode=new ui({func:I.ALWAYS,mask:0},0,255,I.ZERO,I.ZERO,I.ZERO)}clearStencil(){const e=this.context,s=e.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const a=h.H();h.aP(a,0,this.width,this.height,0,0,1),h.K(a,a,[s.drawingBufferWidth,s.drawingBufferHeight,0]),this.useProgram("clippingMask").draw(e,s.TRIANGLES,Ot.disabled,this.stencilClearMode,Pi.disabled,ei.disabled,Sr(a),null,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(e,s){if(this.currentStencilSource===e.source||!e.isTileClipped()||!s||!s.length)return;this.currentStencilSource=e.source;const a=this.context,l=a.gl;this.nextStencilID+s.length>256&&this.clearStencil(),a.setColorMode(Pi.disabled),a.setDepthMode(Ot.disabled);const d=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const v of s){const w=this._tileClippingMaskIDs[v.key]=this.nextStencilID++,I=this.style.map.terrain&&this.style.map.terrain.getTerrainData(v);d.draw(a,l.TRIANGLES,Ot.disabled,new ui({func:l.ALWAYS,mask:0},w,255,l.KEEP,l.KEEP,l.REPLACE),Pi.disabled,ei.disabled,Sr(v.posMatrix),I,"$clipping",this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const e=this.nextStencilID++,s=this.context.gl;return new ui({func:s.NOTEQUAL,mask:255},e,255,s.KEEP,s.KEEP,s.REPLACE)}stencilModeForClipping(e){const s=this.context.gl;return new ui({func:s.EQUAL,mask:255},this._tileClippingMaskIDs[e.key],0,s.KEEP,s.KEEP,s.REPLACE)}stencilConfigForOverlap(e){const s=this.context.gl,a=e.sort((v,w)=>w.overscaledZ-v.overscaledZ),l=a[a.length-1].overscaledZ,d=a[0].overscaledZ-l+1;if(d>1){this.currentStencilSource=void 0,this.nextStencilID+d>256&&this.clearStencil();const v={};for(let w=0;w<d;w++)v[w+l]=new ui({func:s.GEQUAL,mask:255},w+this.nextStencilID,255,s.KEEP,s.KEEP,s.REPLACE);return this.nextStencilID+=d,[v,a]}return[{[l]:ui.disabled},a]}colorModeForRenderPass(){const e=this.context.gl;return this._showOverdrawInspector?new Pi([e.CONSTANT_COLOR,e.ONE],new h.aM(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Pi.unblended:Pi.alphaBlended}depthModeForSublayer(e,s,a){if(!this.opaquePassEnabledForLayer())return Ot.disabled;const l=1-((1+this.currentLayer)*this.numSublayers+e)*this.depthEpsilon;return new Ot(a||this.context.gl.LEQUAL,s,[l,l])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(e,s){this.style=e,this.options=s,this.lineAtlas=e.lineAtlas,this.imageManager=e.imageManager,this.glyphManager=e.glyphManager,this.symbolFadeChange=e.placement.symbolFadeChange(J.now()),this.imageManager.beginFrame();const a=this.style._order,l=this.style.sourceCaches,d={},v={},w={};for(const I in l){const A=l[I];A.used&&A.prepare(this.context),d[I]=A.getVisibleCoordinates(),v[I]=d[I].slice().reverse(),w[I]=A.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let I=0;I<a.length;I++)if(this.style._layers[a[I]].is3D()){this.opaquePassCutoff=I;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const I of a){const A=this.style._layers[I];if(!A.hasOffscreenPass()||A.isHidden(this.transform.zoom))continue;const C=v[A.source];(A.type==="custom"||C.length)&&this.renderLayer(this,l[A.source],A,C)}if(this.context.bindFramebuffer.set(null),this.context.clear({color:s.showOverdrawInspector?h.aM.black:h.aM.transparent,depth:1}),this.clearStencil(),this.style.sky&&function(I,A){const C=I.context,M=C.gl,O=((se,ae,Y)=>({u_sky_color:se.properties.get("sky-color"),u_horizon_color:se.properties.get("horizon-color"),u_horizon:(ae.height/2+ae.getHorizon())*Y,u_sky_horizon_blend:se.properties.get("sky-horizon-blend")*ae.height/2*Y}))(A,I.style.map.transform,I.pixelRatio),V=new Ot(M.LEQUAL,Ot.ReadWrite,[0,1]),H=ui.disabled,ee=I.colorModeForRenderPass(),re=I.useProgram("sky");if(!A.mesh){const se=new h.aX;se.emplaceBack(-1,-1),se.emplaceBack(1,-1),se.emplaceBack(1,1),se.emplaceBack(-1,1);const ae=new h.aY;ae.emplaceBack(0,1,2),ae.emplaceBack(0,2,3),A.mesh=new xo(C.createVertexBuffer(se,cn.members),C.createIndexBuffer(ae),h.a0.simpleSegment(0,0,se.length,ae.length))}re.draw(C,M.TRIANGLES,V,H,ee,ei.disabled,O,void 0,"sky",A.mesh.vertexBuffer,A.mesh.indexBuffer,A.mesh.segments)}(this,this.style.sky),this._showOverdrawInspector=s.showOverdrawInspector,this.depthRangeFor3D=[0,1-(e._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=a.length-1;this.currentLayer>=0;this.currentLayer--){const I=this.style._layers[a[this.currentLayer]],A=l[I.source],C=d[I.source];this._renderTileClippingMasks(I,C),this.renderLayer(this,A,I,C)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<a.length;this.currentLayer++){const I=this.style._layers[a[this.currentLayer]],A=l[I.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(I))continue;const C=(I.type==="symbol"?w:v)[I.source];this._renderTileClippingMasks(I,d[I.source]),this.renderLayer(this,A,I,C)}if(this.options.showTileBoundaries){const I=function(A,C){let M=null;const O=Object.values(A._layers).flatMap(re=>re.source&&!re.isHidden(C)?[A.sourceCaches[re.source]]:[]),V=O.filter(re=>re.getSource().type==="vector"),H=O.filter(re=>re.getSource().type!=="vector"),ee=re=>{(!M||M.getSource().maxzoom<re.getSource().maxzoom)&&(M=re)};return V.forEach(re=>ee(re)),M||H.forEach(re=>ee(re)),M}(this.style,this.transform.zoom);I&&function(A,C,M){for(let O=0;O<M.length;O++)su(A,C,M[O])}(this,I,I.getVisibleCoordinates())}this.options.showPadding&&function(I){const A=I.transform.padding;Dc(I,I.transform.height-(A.top||0),3,Ht),Dc(I,A.bottom||0,3,la),Lc(I,A.left||0,3,ru),Lc(I,I.transform.width-(A.right||0),3,zc);const C=I.transform.centerPoint;(function(M,O,V,H){yo(M,O-1,V-10,2,20,H),yo(M,O-10,V-1,20,2,H)})(I,C.x,I.transform.height-C.y,go)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(e){if(!this.style||!this.style.map||!this.style.map.terrain)return;const s=this.terrainFacilitator.matrix,a=this.transform.modelViewProjectionMatrix;let l=this.terrainFacilitator.dirty;l||(l=e?!h.a_(s,a):!h.a$(s,a)),l||(l=this.style.map.terrain.sourceCache.tilesAfterTime(this.terrainFacilitator.renderTime).length>0),l&&(h.b0(s,a),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(d,v){const w=d.context,I=w.gl,A=Pi.unblended,C=new Ot(I.LEQUAL,Ot.ReadWrite,[0,1]),M=v.getTerrainMesh(),O=v.sourceCache.getRenderableTiles(),V=d.useProgram("terrainDepth");w.bindFramebuffer.set(v.getFramebuffer("depth").framebuffer),w.viewport.set([0,0,d.width/devicePixelRatio,d.height/devicePixelRatio]),w.clear({color:h.aM.transparent,depth:1});for(const H of O){const ee=v.getTerrainData(H.tileID),re={u_matrix:d.transform.calculatePosMatrix(H.tileID.toUnwrapped()),u_ele_delta:v.getMeshFrameDelta(d.transform.zoom)};V.draw(w,I.TRIANGLES,C,ui.disabled,A,ei.backCCW,re,ee,"terrain",M.vertexBuffer,M.indexBuffer,M.segments)}w.bindFramebuffer.set(null),w.viewport.set([0,0,d.width,d.height])}(this,this.style.map.terrain),function(d,v){const w=d.context,I=w.gl,A=Pi.unblended,C=new Ot(I.LEQUAL,Ot.ReadWrite,[0,1]),M=v.getTerrainMesh(),O=v.getCoordsTexture(),V=v.sourceCache.getRenderableTiles(),H=d.useProgram("terrainCoords");w.bindFramebuffer.set(v.getFramebuffer("coords").framebuffer),w.viewport.set([0,0,d.width/devicePixelRatio,d.height/devicePixelRatio]),w.clear({color:h.aM.transparent,depth:1}),v.coordsIndex=[];for(const ee of V){const re=v.getTerrainData(ee.tileID);w.activeTexture.set(I.TEXTURE0),I.bindTexture(I.TEXTURE_2D,O.texture);const se={u_matrix:d.transform.calculatePosMatrix(ee.tileID.toUnwrapped()),u_terrain_coords_id:(255-v.coordsIndex.length)/255,u_texture:0,u_ele_delta:v.getMeshFrameDelta(d.transform.zoom)};H.draw(w,I.TRIANGLES,C,ui.disabled,A,ei.backCCW,se,re,"terrain",M.vertexBuffer,M.indexBuffer,M.segments),v.coordsIndex.push(ee.tileID.key)}w.bindFramebuffer.set(null),w.viewport.set([0,0,d.width,d.height])}(this,this.style.map.terrain))}renderLayer(e,s,a,l){if(!a.isHidden(this.transform.zoom)&&(a.type==="background"||a.type==="custom"||(l||[]).length))switch(this.id=a.id,a.type){case"symbol":(function(d,v,w,I,A){if(d.renderPass!=="translucent")return;const C=ui.disabled,M=d.colorModeForRenderPass();(w._unevaluatedLayout.hasValue("text-variable-anchor")||w._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(O,V,H,ee,re,se,ae,Y,ue){const pe=V.transform,ye=Qt(),Ce=re==="map",Re=se==="map";for(const qe of O){const Je=ee.getTile(qe),Ne=Je.getBucket(H);if(!Ne||!Ne.text||!Ne.text.segments.get().length)continue;const Be=h.ag(Ne.textSizeData,pe.zoom),rt=Et(Je,1,V.transform.zoom),It=Br(qe.posMatrix,Re,Ce,V.transform,rt),Ue=H.layout.get("icon-text-fit")!=="none"&&Ne.hasIconData();if(Be){const Ze=Math.pow(2,pe.zoom-Je.tileID.overscaledZ),bt=V.style.map.terrain?(Pt,$t)=>V.style.map.terrain.getElevation(qe,Pt,$t):null,yi=ye.translatePosition(pe,Je,ae,Y);Jr(Ne,Ce,Re,ue,pe,It,qe.posMatrix,Ze,Be,Ue,ye,yi,qe.toUnwrapped(),bt)}}}(I,d,w,v,w.layout.get("text-rotation-alignment"),w.layout.get("text-pitch-alignment"),w.paint.get("text-translate"),w.paint.get("text-translate-anchor"),A),w.paint.get("icon-opacity").constantOr(1)!==0&&ul(d,v,w,I,!1,w.paint.get("icon-translate"),w.paint.get("icon-translate-anchor"),w.layout.get("icon-rotation-alignment"),w.layout.get("icon-pitch-alignment"),w.layout.get("icon-keep-upright"),C,M),w.paint.get("text-opacity").constantOr(1)!==0&&ul(d,v,w,I,!0,w.paint.get("text-translate"),w.paint.get("text-translate-anchor"),w.layout.get("text-rotation-alignment"),w.layout.get("text-pitch-alignment"),w.layout.get("text-keep-upright"),C,M),v.map.showCollisionBoxes&&(fo(d,v,w,I,!0),fo(d,v,w,I,!1))})(e,s,a,l,this.style.placement.variableOffsets);break;case"circle":(function(d,v,w,I){if(d.renderPass!=="translucent")return;const A=w.paint.get("circle-opacity"),C=w.paint.get("circle-stroke-width"),M=w.paint.get("circle-stroke-opacity"),O=!w.layout.get("circle-sort-key").isConstant();if(A.constantOr(1)===0&&(C.constantOr(1)===0||M.constantOr(1)===0))return;const V=d.context,H=V.gl,ee=d.depthModeForSublayer(0,Ot.ReadOnly),re=ui.disabled,se=d.colorModeForRenderPass(),ae=[];for(let Y=0;Y<I.length;Y++){const ue=I[Y],pe=v.getTile(ue),ye=pe.getBucket(w);if(!ye)continue;const Ce=ye.programConfigurations.get(w.id),Re=d.useProgram("circle",Ce),qe=ye.layoutVertexBuffer,Je=ye.indexBuffer,Ne=d.style.map.terrain&&d.style.map.terrain.getTerrainData(ue),Be={programConfiguration:Ce,program:Re,layoutVertexBuffer:qe,indexBuffer:Je,uniformValues:Vh(d,ue,pe,w),terrainData:Ne};if(O){const rt=ye.segments.get();for(const It of rt)ae.push({segments:new h.a0([It]),sortKey:It.sortKey,state:Be})}else ae.push({segments:ye.segments,sortKey:0,state:Be})}O&&ae.sort((Y,ue)=>Y.sortKey-ue.sortKey);for(const Y of ae){const{programConfiguration:ue,program:pe,layoutVertexBuffer:ye,indexBuffer:Ce,uniformValues:Re,terrainData:qe}=Y.state;pe.draw(V,H.TRIANGLES,ee,re,se,ei.disabled,Re,qe,w.id,ye,Ce,Y.segments,w.paint,d.transform.zoom,ue)}})(e,s,a,l);break;case"heatmap":(function(d,v,w,I){if(w.paint.get("heatmap-opacity")===0)return;const A=d.context;if(d.style.map.terrain){for(const C of I){const M=v.getTile(C);v.hasRenderableParent(C)||(d.renderPass==="offscreen"?_n(d,M,w,C):d.renderPass==="translucent"&&aa(d,w,C))}A.viewport.set([0,0,d.width,d.height])}else d.renderPass==="offscreen"?function(C,M,O,V){const H=C.context,ee=H.gl,re=ui.disabled,se=new Pi([ee.ONE,ee.ONE],h.aM.transparent,[!0,!0,!0,!0]);(function(ae,Y,ue){const pe=ae.gl;ae.activeTexture.set(pe.TEXTURE1),ae.viewport.set([0,0,Y.width/4,Y.height/4]);let ye=ue.heatmapFbos.get(h.aU);ye?(pe.bindTexture(pe.TEXTURE_2D,ye.colorAttachment.get()),ae.bindFramebuffer.set(ye.framebuffer)):(ye=mo(ae,Y.width/4,Y.height/4),ue.heatmapFbos.set(h.aU,ye))})(H,C,O),H.clear({color:h.aM.transparent});for(let ae=0;ae<V.length;ae++){const Y=V[ae];if(M.hasRenderableParent(Y))continue;const ue=M.getTile(Y),pe=ue.getBucket(O);if(!pe)continue;const ye=pe.programConfigurations.get(O.id),Ce=C.useProgram("heatmap",ye),{zoom:Re}=C.transform;Ce.draw(H,ee.TRIANGLES,Ot.disabled,re,se,ei.disabled,Ir(Y.posMatrix,ue,Re,O.paint.get("heatmap-intensity")),null,O.id,pe.layoutVertexBuffer,pe.indexBuffer,pe.segments,O.paint,C.transform.zoom,ye)}H.viewport.set([0,0,C.width,C.height])}(d,v,w,I):d.renderPass==="translucent"&&function(C,M){const O=C.context,V=O.gl;O.setColorMode(C.colorModeForRenderPass());const H=M.heatmapFbos.get(h.aU);H&&(O.activeTexture.set(V.TEXTURE0),V.bindTexture(V.TEXTURE_2D,H.colorAttachment.get()),O.activeTexture.set(V.TEXTURE1),Nn(O,M).bind(V.LINEAR,V.CLAMP_TO_EDGE),C.useProgram("heatmapTexture").draw(O,V.TRIANGLES,Ot.disabled,ui.disabled,C.colorModeForRenderPass(),ei.disabled,Yo(C,M,0,1),null,M.id,C.viewportBuffer,C.quadTriangleIndexBuffer,C.viewportSegments,M.paint,C.transform.zoom))}(d,w)})(e,s,a,l);break;case"line":(function(d,v,w,I){if(d.renderPass!=="translucent")return;const A=w.paint.get("line-opacity"),C=w.paint.get("line-width");if(A.constantOr(1)===0||C.constantOr(1)===0)return;const M=d.depthModeForSublayer(0,Ot.ReadOnly),O=d.colorModeForRenderPass(),V=w.paint.get("line-dasharray"),H=w.paint.get("line-pattern"),ee=H.constantOr(1),re=w.paint.get("line-gradient"),se=w.getCrossfadeParameters(),ae=ee?"linePattern":V?"lineSDF":re?"lineGradient":"line",Y=d.context,ue=Y.gl;let pe=!0;for(const ye of I){const Ce=v.getTile(ye);if(ee&&!Ce.patternsLoaded())continue;const Re=Ce.getBucket(w);if(!Re)continue;const qe=Re.programConfigurations.get(w.id),Je=d.context.program.get(),Ne=d.useProgram(ae,qe),Be=pe||Ne.program!==Je,rt=d.style.map.terrain&&d.style.map.terrain.getTerrainData(ye),It=H.constantOr(null);if(It&&Ce.imageAtlas){const bt=Ce.imageAtlas,yi=bt.patternPositions[It.to.toString()],Pt=bt.patternPositions[It.from.toString()];yi&&Pt&&qe.setConstantPatternPositions(yi,Pt)}const Ue=rt?ye:null,Ze=ee?Fn(d,Ce,w,se,Ue):V?qh(d,Ce,w,V,se,Ue):re?pc(d,Ce,w,Re.lineClipsArray.length,Ue):ea(d,Ce,w,Ue);if(ee)Y.activeTexture.set(ue.TEXTURE0),Ce.imageAtlasTexture.bind(ue.LINEAR,ue.CLAMP_TO_EDGE),qe.updatePaintBuffers(se);else if(V&&(Be||d.lineAtlas.dirty))Y.activeTexture.set(ue.TEXTURE0),d.lineAtlas.bind(Y);else if(re){const bt=Re.gradients[w.id];let yi=bt.texture;if(w.gradientVersion!==bt.version){let Pt=256;if(w.stepInterpolant){const $t=v.getSource().maxzoom,xi=ye.canonical.z===$t?Math.ceil(1<<d.transform.maxZoom-ye.canonical.z):1;Pt=h.ac(h.aV(Re.maxLineLength/h.X*1024*xi),256,Y.maxTextureSize)}bt.gradient=h.aW({expression:w.gradientExpression(),evaluationKey:"lineProgress",resolution:Pt,image:bt.gradient||void 0,clips:Re.lineClipsArray}),bt.texture?bt.texture.update(bt.gradient):bt.texture=new Lt(Y,bt.gradient,ue.RGBA),bt.version=w.gradientVersion,yi=bt.texture}Y.activeTexture.set(ue.TEXTURE0),yi.bind(w.stepInterpolant?ue.NEAREST:ue.LINEAR,ue.CLAMP_TO_EDGE)}Ne.draw(Y,ue.TRIANGLES,M,d.stencilModeForClipping(ye),O,ei.disabled,Ze,rt,w.id,Re.layoutVertexBuffer,Re.indexBuffer,Re.segments,w.paint,d.transform.zoom,qe,Re.layoutVertexBuffer2),pe=!1}})(e,s,a,l);break;case"fill":(function(d,v,w,I){const A=w.paint.get("fill-color"),C=w.paint.get("fill-opacity");if(C.constantOr(1)===0)return;const M=d.colorModeForRenderPass(),O=w.paint.get("fill-pattern"),V=d.opaquePassEnabledForLayer()&&!O.constantOr(1)&&A.constantOr(h.aM.transparent).a===1&&C.constantOr(0)===1?"opaque":"translucent";if(d.renderPass===V){const H=d.depthModeForSublayer(1,d.renderPass==="opaque"?Ot.ReadWrite:Ot.ReadOnly);dl(d,v,w,I,H,M,!1)}if(d.renderPass==="translucent"&&w.paint.get("fill-antialias")){const H=d.depthModeForSublayer(w.getPaintProperty("fill-outline-color")?2:0,Ot.ReadOnly);dl(d,v,w,I,H,M,!0)}})(e,s,a,l);break;case"fill-extrusion":(function(d,v,w,I){const A=w.paint.get("fill-extrusion-opacity");if(A!==0&&d.renderPass==="translucent"){const C=new Ot(d.context.gl.LEQUAL,Ot.ReadWrite,d.depthRangeFor3D);if(A!==1||w.paint.get("fill-extrusion-pattern").constantOr(1))Ws(d,v,w,I,C,ui.disabled,Pi.disabled),Ws(d,v,w,I,C,d.stencilModeFor3D(),d.colorModeForRenderPass());else{const M=d.colorModeForRenderPass();Ws(d,v,w,I,C,ui.disabled,M)}}})(e,s,a,l);break;case"hillshade":(function(d,v,w,I){if(d.renderPass!=="offscreen"&&d.renderPass!=="translucent")return;const A=d.context,C=d.depthModeForSublayer(0,Ot.ReadOnly),M=d.colorModeForRenderPass(),[O,V]=d.renderPass==="translucent"?d.stencilConfigForOverlap(I):[{},I];for(const H of V){const ee=v.getTile(H);ee.needsHillshadePrepare!==void 0&&ee.needsHillshadePrepare&&d.renderPass==="offscreen"?Mc(d,ee,w,C,ui.disabled,M):d.renderPass==="translucent"&&$n(d,H,ee,w,C,O[H.overscaledZ],M)}A.viewport.set([0,0,d.width,d.height])})(e,s,a,l);break;case"raster":(function(d,v,w,I){if(d.renderPass!=="translucent"||w.paint.get("raster-opacity")===0||!I.length)return;const A=d.context,C=A.gl,M=v.getSource(),O=d.useProgram("raster"),V=d.colorModeForRenderPass(),[H,ee]=M instanceof vr?[{},I]:d.stencilConfigForOverlap(I),re=ee[ee.length-1].overscaledZ,se=!d.options.moving;for(const ae of ee){const Y=d.depthModeForSublayer(ae.overscaledZ-re,w.paint.get("raster-opacity")===1?Ot.ReadWrite:Ot.ReadOnly,C.LESS),ue=v.getTile(ae);ue.registerFadeDuration(w.paint.get("raster-fade-duration"));const pe=v.findLoadedParent(ae,0),ye=v.findLoadedSibling(ae),Ce=pl(ue,pe||ye||null,v,w,d.transform,d.style.map.terrain);let Re,qe;const Je=w.paint.get("raster-resampling")==="nearest"?C.NEAREST:C.LINEAR;A.activeTexture.set(C.TEXTURE0),ue.texture.bind(Je,C.CLAMP_TO_EDGE,C.LINEAR_MIPMAP_NEAREST),A.activeTexture.set(C.TEXTURE1),pe?(pe.texture.bind(Je,C.CLAMP_TO_EDGE,C.LINEAR_MIPMAP_NEAREST),Re=Math.pow(2,pe.tileID.overscaledZ-ue.tileID.overscaledZ),qe=[ue.tileID.canonical.x*Re%1,ue.tileID.canonical.y*Re%1]):ue.texture.bind(Je,C.CLAMP_TO_EDGE,C.LINEAR_MIPMAP_NEAREST),ue.texture.useMipmap&&A.extTextureFilterAnisotropic&&d.transform.pitch>20&&C.texParameterf(C.TEXTURE_2D,A.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,A.extTextureFilterAnisotropicMax);const Ne=d.style.map.terrain&&d.style.map.terrain.getTerrainData(ae),Be=Ne?ae:null,rt=Be?Be.posMatrix:d.transform.calculatePosMatrix(ae.toUnwrapped(),se),It=Gh(rt,qe||[0,0],Re||1,Ce,w);M instanceof vr?O.draw(A,C.TRIANGLES,Y,ui.disabled,V,ei.disabled,It,Ne,w.id,M.boundsBuffer,d.quadTriangleIndexBuffer,M.boundsSegments):O.draw(A,C.TRIANGLES,Y,H[ae.overscaledZ],V,ei.disabled,It,Ne,w.id,d.rasterBoundsBuffer,d.quadTriangleIndexBuffer,d.rasterBoundsSegments)}})(e,s,a,l);break;case"background":(function(d,v,w,I){const A=w.paint.get("background-color"),C=w.paint.get("background-opacity");if(C===0)return;const M=d.context,O=M.gl,V=d.transform,H=V.tileSize,ee=w.paint.get("background-pattern");if(d.isPatternMissing(ee))return;const re=!ee&&A.a===1&&C===1&&d.opaquePassEnabledForLayer()?"opaque":"translucent";if(d.renderPass!==re)return;const se=ui.disabled,ae=d.depthModeForSublayer(0,re==="opaque"?Ot.ReadWrite:Ot.ReadOnly),Y=d.colorModeForRenderPass(),ue=d.useProgram(ee?"backgroundPattern":"background"),pe=I||V.coveringTiles({tileSize:H,terrain:d.style.map.terrain});ee&&(M.activeTexture.set(O.TEXTURE0),d.imageManager.bind(d.context));const ye=w.getCrossfadeParameters();for(const Ce of pe){const Re=I?Ce.posMatrix:d.transform.calculatePosMatrix(Ce.toUnwrapped()),qe=ee?tl(Re,C,d,ee,{tileID:Ce,tileSize:H},ye):ta(Re,C,A),Je=d.style.map.terrain&&d.style.map.terrain.getTerrainData(Ce);ue.draw(M,O.TRIANGLES,ae,se,Y,ei.disabled,qe,Je,w.id,d.tileExtentBuffer,d.quadTriangleIndexBuffer,d.tileExtentSegments)}})(e,0,a,l);break;case"custom":(function(d,v,w){const I=d.context,A=w.implementation;if(d.renderPass==="offscreen"){const C=A.prerender;C&&(d.setCustomLayerDefaults(),I.setColorMode(d.colorModeForRenderPass()),C.call(A,I.gl,d.transform.customLayerMatrix()),I.setDirty(),d.setBaseState())}else if(d.renderPass==="translucent"){d.setCustomLayerDefaults(),I.setColorMode(d.colorModeForRenderPass()),I.setStencilMode(ui.disabled);const C=A.renderingMode==="3d"?new Ot(d.context.gl.LEQUAL,Ot.ReadWrite,d.depthRangeFor3D):d.depthModeForSublayer(0,Ot.ReadOnly);I.setDepthMode(C),A.render(I.gl,d.transform.customLayerMatrix(),{farZ:d.transform.farZ,nearZ:d.transform.nearZ,fov:d.transform._fov,modelViewProjectionMatrix:d.transform.modelViewProjectionMatrix,projectionMatrix:d.transform.projectionMatrix}),I.setDirty(),d.setBaseState(),I.bindFramebuffer.set(null)}})(e,0,a)}}translatePosMatrix(e,s,a,l,d){if(!a[0]&&!a[1])return e;const v=d?l==="map"?this.transform.angle:0:l==="viewport"?-this.transform.angle:0;if(v){const A=Math.sin(v),C=Math.cos(v);a=[a[0]*C-a[1]*A,a[0]*A+a[1]*C]}const w=[d?a[0]:Et(s,a[0],this.transform.zoom),d?a[1]:Et(s,a[1],this.transform.zoom),0],I=new Float32Array(16);return h.J(I,e,w),I}saveTileTexture(e){const s=this._tileTextures[e.size[0]];s?s.push(e):this._tileTextures[e.size[0]]=[e]}getTileTexture(e){const s=this._tileTextures[e];return s&&s.length>0?s.pop():null}isPatternMissing(e){if(!e)return!1;if(!e.from||!e.to)return!0;const s=this.imageManager.getPattern(e.from.toString()),a=this.imageManager.getPattern(e.to.toString());return!s||!a}useProgram(e,s){this.cache=this.cache||{};const a=e+(s?s.cacheKey:"")+(this._showOverdrawInspector?"/overdraw":"")+(this.style.map.terrain?"/terrain":"");return this.cache[a]||(this.cache[a]=new Qa(this.context,Hs[e],s,il[e],this._showOverdrawInspector,this.style.map.terrain)),this.cache[a]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const e=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(e.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new Lt(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:e,drawingBufferHeight:s}=this.context.gl;return this.width!==e||this.height!==s}}class vo{constructor(e,s){this.points=e,this.planes=s}static fromInvProjectionMatrix(e,s,a){const l=Math.pow(2,a),d=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(w=>{const I=1/(w=h.af([],w,e))[3]/s*l;return h.b1(w,w,[I,I,1/w[3],I])}),v=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(w=>{const I=function(O,V){var H=V[0],ee=V[1],re=V[2],se=H*H+ee*ee+re*re;return se>0&&(se=1/Math.sqrt(se)),O[0]=V[0]*se,O[1]=V[1]*se,O[2]=V[2]*se,O}([],function(O,V,H){var ee=V[0],re=V[1],se=V[2],ae=H[0],Y=H[1],ue=H[2];return O[0]=re*ue-se*Y,O[1]=se*ae-ee*ue,O[2]=ee*Y-re*ae,O}([],yt([],d[w[0]],d[w[1]]),yt([],d[w[2]],d[w[1]]))),A=-((C=I)[0]*(M=d[w[1]])[0]+C[1]*M[1]+C[2]*M[2]);var C,M;return I.concat(A)});return new vo(d,v)}}class Un{constructor(e,s){this.min=e,this.max=s,this.center=function(a,l,d){return a[0]=.5*l[0],a[1]=.5*l[1],a[2]=.5*l[2],a}([],function(a,l,d){return a[0]=l[0]+d[0],a[1]=l[1]+d[1],a[2]=l[2]+d[2],a}([],this.min,this.max))}quadrant(e){const s=[e%2==0,e<2],a=Yt(this.min),l=Yt(this.max);for(let d=0;d<s.length;d++)a[d]=s[d]?this.min[d]:this.center[d],l[d]=s[d]?this.center[d]:this.max[d];return l[2]=this.max[2],new Un(a,l)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}intersects(e){const s=[[this.min[0],this.min[1],this.min[2],1],[this.max[0],this.min[1],this.min[2],1],[this.max[0],this.max[1],this.min[2],1],[this.min[0],this.max[1],this.min[2],1],[this.min[0],this.min[1],this.max[2],1],[this.max[0],this.min[1],this.max[2],1],[this.max[0],this.max[1],this.max[2],1],[this.min[0],this.max[1],this.max[2],1]];let a=!0;for(let l=0;l<e.planes.length;l++){const d=e.planes[l];let v=0;for(let w=0;w<s.length;w++)h.b2(d,s[w])>=0&&v++;if(v===0)return 0;v!==s.length&&(a=!1)}if(a)return 2;for(let l=0;l<3;l++){let d=Number.MAX_VALUE,v=-Number.MAX_VALUE;for(let w=0;w<e.points.length;w++){const I=e.points[w][l]-this.min[l];d=Math.min(d,I),v=Math.max(v,I)}if(v<0||d>this.max[l]-this.min[l])return 0}return 1}}class bo{constructor(e=0,s=0,a=0,l=0){if(isNaN(e)||e<0||isNaN(s)||s<0||isNaN(a)||a<0||isNaN(l)||l<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=e,this.bottom=s,this.left=a,this.right=l}interpolate(e,s,a){return s.top!=null&&e.top!=null&&(this.top=h.y.number(e.top,s.top,a)),s.bottom!=null&&e.bottom!=null&&(this.bottom=h.y.number(e.bottom,s.bottom,a)),s.left!=null&&e.left!=null&&(this.left=h.y.number(e.left,s.left,a)),s.right!=null&&e.right!=null&&(this.right=h.y.number(e.right,s.right,a)),this}getCenter(e,s){const a=h.ac((this.left+e-this.right)/2,0,e),l=h.ac((this.top+s-this.bottom)/2,0,s);return new h.P(a,l)}equals(e){return this.top===e.top&&this.bottom===e.bottom&&this.left===e.left&&this.right===e.right}clone(){return new bo(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const wo=85.051129;class Vn{constructor(e,s,a,l,d){this.tileSize=512,this._renderWorldCopies=d===void 0||!!d,this._minZoom=e||0,this._maxZoom=s||22,this._minPitch=a??0,this._maxPitch=l??60,this.setMaxBounds(),this.width=0,this.height=0,this._center=new h.N(0,0),this._elevation=0,this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._unmodified=!0,this._edgeInsets=new bo,this._posMatrixCache={},this._alignedPosMatrixCache={},this._fogMatrixCache={},this.minElevationForCurrentTile=0}clone(){const e=new Vn(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return e.apply(this),e}apply(e){this.tileSize=e.tileSize,this.latRange=e.latRange,this.lngRange=e.lngRange,this.width=e.width,this.height=e.height,this._center=e._center,this._elevation=e._elevation,this.minElevationForCurrentTile=e.minElevationForCurrentTile,this.zoom=e.zoom,this.angle=e.angle,this._fov=e._fov,this._pitch=e._pitch,this._unmodified=e._unmodified,this._edgeInsets=e._edgeInsets.clone(),this._calcMatrices()}get minZoom(){return this._minZoom}set minZoom(e){this._minZoom!==e&&(this._minZoom=e,this.zoom=Math.max(this.zoom,e))}get maxZoom(){return this._maxZoom}set maxZoom(e){this._maxZoom!==e&&(this._maxZoom=e,this.zoom=Math.min(this.zoom,e))}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch!==e&&(this._minPitch=e,this.pitch=Math.max(this.pitch,e))}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch!==e&&(this._maxPitch=e,this.pitch=Math.min(this.pitch,e))}get renderWorldCopies(){return this._renderWorldCopies}set renderWorldCopies(e){e===void 0?e=!0:e===null&&(e=!1),this._renderWorldCopies=e}get worldSize(){return this.tileSize*this.scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new h.P(this.width,this.height)}get bearing(){return-this.angle/Math.PI*180}set bearing(e){const s=-h.b3(e,-180,180)*Math.PI/180;this.angle!==s&&(this._unmodified=!1,this.angle=s,this._calcMatrices(),this.rotationMatrix=function(){var a=new h.A(4);return h.A!=Float32Array&&(a[1]=0,a[2]=0),a[0]=1,a[3]=1,a}(),function(a,l,d){var v=l[0],w=l[1],I=l[2],A=l[3],C=Math.sin(d),M=Math.cos(d);a[0]=v*M+I*C,a[1]=w*M+A*C,a[2]=v*-C+I*M,a[3]=w*-C+A*M}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(e){const s=h.ac(e,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==s&&(this._unmodified=!1,this._pitch=s,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(e){e=Math.max(.01,Math.min(60,e)),this._fov!==e&&(this._unmodified=!1,this._fov=e/180*Math.PI,this._calcMatrices())}get zoom(){return this._zoom}set zoom(e){const s=Math.min(Math.max(e,this.minZoom),this.maxZoom);this._zoom!==s&&(this._unmodified=!1,this._zoom=s,this.tileZoom=Math.max(0,Math.floor(s)),this.scale=this.zoomScale(s),this._constrain(),this._calcMatrices())}get center(){return this._center}set center(e){e.lat===this._center.lat&&e.lng===this._center.lng||(this._unmodified=!1,this._center=e,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}set elevation(e){e!==this._elevation&&(this._elevation=e,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}set padding(e){this._edgeInsets.equals(e)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,e,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}isPaddingEqual(e){return this._edgeInsets.equals(e)}interpolatePadding(e,s,a){this._unmodified=!1,this._edgeInsets.interpolate(e,s,a),this._constrain(),this._calcMatrices()}coveringZoomLevel(e){const s=(e.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/e.tileSize));return Math.max(0,s)}getVisibleUnwrappedCoordinates(e){const s=[new h.b4(0,e)];if(this._renderWorldCopies){const a=this.pointCoordinate(new h.P(0,0)),l=this.pointCoordinate(new h.P(this.width,0)),d=this.pointCoordinate(new h.P(this.width,this.height)),v=this.pointCoordinate(new h.P(0,this.height)),w=Math.floor(Math.min(a.x,l.x,d.x,v.x)),I=Math.floor(Math.max(a.x,l.x,d.x,v.x)),A=1;for(let C=w-A;C<=I+A;C++)C!==0&&s.push(new h.b4(C,e))}return s}coveringTiles(e){var s,a;let l=this.coveringZoomLevel(e);const d=l;if(e.minzoom!==void 0&&l<e.minzoom)return[];e.maxzoom!==void 0&&l>e.maxzoom&&(l=e.maxzoom);const v=this.pointCoordinate(this.getCameraPoint()),w=h.Z.fromLngLat(this.center),I=Math.pow(2,l),A=[I*v.x,I*v.y,0],C=[I*w.x,I*w.y,0],M=vo.fromInvProjectionMatrix(this.invModelViewProjectionMatrix,this.worldSize,l);let O=e.minzoom||0;!e.terrain&&this.pitch<=60&&this._edgeInsets.top<.1&&(O=l);const V=e.terrain?2/Math.min(this.tileSize,e.tileSize)*this.tileSize:3,H=Y=>({aabb:new Un([Y*I,0,0],[(Y+1)*I,I,0]),zoom:0,x:0,y:0,wrap:Y,fullyVisible:!1}),ee=[],re=[],se=l,ae=e.reparseOverscaled?d:l;if(this._renderWorldCopies)for(let Y=1;Y<=3;Y++)ee.push(H(-Y)),ee.push(H(Y));for(ee.push(H(0));ee.length>0;){const Y=ee.pop(),ue=Y.x,pe=Y.y;let ye=Y.fullyVisible;if(!ye){const Ne=Y.aabb.intersects(M);if(Ne===0)continue;ye=Ne===2}const Ce=e.terrain?A:C,Re=Y.aabb.distanceX(Ce),qe=Y.aabb.distanceY(Ce),Je=Math.max(Math.abs(Re),Math.abs(qe));if(Y.zoom===se||Je>V+(1<<se-Y.zoom)-2&&Y.zoom>=O){const Ne=se-Y.zoom,Be=A[0]-.5-(ue<<Ne),rt=A[1]-.5-(pe<<Ne);re.push({tileID:new h.S(Y.zoom===se?ae:Y.zoom,Y.wrap,Y.zoom,ue,pe),distanceSq:ri([C[0]-.5-ue,C[1]-.5-pe]),tileDistanceToCamera:Math.sqrt(Be*Be+rt*rt)})}else for(let Ne=0;Ne<4;Ne++){const Be=(ue<<1)+Ne%2,rt=(pe<<1)+(Ne>>1),It=Y.zoom+1;let Ue=Y.aabb.quadrant(Ne);if(e.terrain){const Ze=new h.S(It,Y.wrap,It,Be,rt),bt=e.terrain.getMinMaxElevation(Ze),yi=(s=bt.minElevation)!==null&&s!==void 0?s:this.elevation,Pt=(a=bt.maxElevation)!==null&&a!==void 0?a:this.elevation;Ue=new Un([Ue.min[0],Ue.min[1],yi],[Ue.max[0],Ue.max[1],Pt])}ee.push({aabb:Ue,zoom:It,x:Be,y:rt,wrap:Y.wrap,fullyVisible:ye})}}return re.sort((Y,ue)=>Y.distanceSq-ue.distanceSq).map(Y=>Y.tileID)}resize(e,s){this.width=e,this.height=s,this.pixelsToGLUnits=[2/e,-2/s],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(e){return Math.pow(2,e)}scaleZoom(e){return Math.log(e)/Math.LN2}project(e){const s=h.ac(e.lat,-85.051129,wo);return new h.P(h.O(e.lng)*this.worldSize,h.Q(s)*this.worldSize)}unproject(e){return new h.Z(e.x/this.worldSize,e.y/this.worldSize).toLngLat()}get point(){return this.project(this.center)}getCameraPosition(){return{lngLat:this.pointLocation(this.getCameraPoint()),altitude:Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter+this.elevation}}recalculateZoom(e){const s=this.elevation,a=Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter,l=this.pointLocation(this.centerPoint,e),d=e.getElevationForLngLatZoom(l,this.tileZoom);if(!(this.elevation-d))return;const v=a+s-d,w=Math.cos(this._pitch)*this.cameraToCenterDistance/v/h.b5(1,l.lat),I=this.scaleZoom(w/this.tileSize);this._elevation=d,this._center=l,this.zoom=I}setLocationAtPoint(e,s){const a=this.pointCoordinate(s),l=this.pointCoordinate(this.centerPoint),d=this.locationCoordinate(e),v=new h.Z(d.x-(a.x-l.x),d.y-(a.y-l.y));this.center=this.coordinateLocation(v),this._renderWorldCopies&&(this.center=this.center.wrap())}locationPoint(e,s){return s?this.coordinatePoint(this.locationCoordinate(e),s.getElevationForLngLatZoom(e,this.tileZoom),this.pixelMatrix3D):this.coordinatePoint(this.locationCoordinate(e))}pointLocation(e,s){return this.coordinateLocation(this.pointCoordinate(e,s))}locationCoordinate(e){return h.Z.fromLngLat(e)}coordinateLocation(e){return e&&e.toLngLat()}pointCoordinate(e,s){if(s){const O=s.pointCoordinate(e);if(O!=null)return O}const a=[e.x,e.y,0,1],l=[e.x,e.y,1,1];h.af(a,a,this.pixelMatrixInverse),h.af(l,l,this.pixelMatrixInverse);const d=a[3],v=l[3],w=a[1]/d,I=l[1]/v,A=a[2]/d,C=l[2]/v,M=A===C?0:(0-A)/(C-A);return new h.Z(h.y.number(a[0]/d,l[0]/v,M)/this.worldSize,h.y.number(w,I,M)/this.worldSize)}coordinatePoint(e,s=0,a=this.pixelMatrix){const l=[e.x*this.worldSize,e.y*this.worldSize,s,1];return h.af(l,l,a),new h.P(l[0]/l[3],l[1]/l[3])}getBounds(){const e=Math.max(0,this.height/2-this.getHorizon());return new be().extend(this.pointLocation(new h.P(0,e))).extend(this.pointLocation(new h.P(this.width,e))).extend(this.pointLocation(new h.P(this.width,this.height))).extend(this.pointLocation(new h.P(0,this.height)))}getMaxBounds(){return this.latRange&&this.latRange.length===2&&this.lngRange&&this.lngRange.length===2?new be([this.lngRange[0],this.latRange[0]],[this.lngRange[1],this.latRange[1]]):null}getHorizon(){return Math.tan(Math.PI/2-this._pitch)*this.cameraToCenterDistance*.85}setMaxBounds(e){e?(this.lngRange=[e.getWest(),e.getEast()],this.latRange=[e.getSouth(),e.getNorth()],this._constrain()):(this.lngRange=null,this.latRange=[-85.051129,wo])}calculateTileMatrix(e){const s=e.canonical,a=this.worldSize/this.zoomScale(s.z),l=s.x+Math.pow(2,s.z)*e.wrap,d=h.an(new Float64Array(16));return h.J(d,d,[l*a,s.y*a,0]),h.K(d,d,[a/h.X,a/h.X,1]),d}calculatePosMatrix(e,s=!1){const a=e.key,l=s?this._alignedPosMatrixCache:this._posMatrixCache;if(l[a])return l[a];const d=this.calculateTileMatrix(e);return h.L(d,s?this.alignedModelViewProjectionMatrix:this.modelViewProjectionMatrix,d),l[a]=new Float32Array(d),l[a]}calculateFogMatrix(e){const s=e.key,a=this._fogMatrixCache;if(a[s])return a[s];const l=this.calculateTileMatrix(e);return h.L(l,this.fogMatrix,l),a[s]=new Float32Array(l),a[s]}customLayerMatrix(){return this.mercatorMatrix.slice()}getConstrained(e,s){s=h.ac(+s,this.minZoom,this.maxZoom);const a={center:new h.N(e.lng,e.lat),zoom:s};let l=this.lngRange;if(!this._renderWorldCopies&&l===null){const Y=179.9999999999;l=[-Y,Y]}const d=this.tileSize*this.zoomScale(a.zoom);let v=0,w=d,I=0,A=d,C=0,M=0;const{x:O,y:V}=this.size;if(this.latRange){const Y=this.latRange;v=h.Q(Y[1])*d,w=h.Q(Y[0])*d,w-v<V&&(C=V/(w-v))}l&&(I=h.b3(h.O(l[0])*d,0,d),A=h.b3(h.O(l[1])*d,0,d),A<I&&(A+=d),A-I<O&&(M=O/(A-I)));const{x:H,y:ee}=this.project.call({worldSize:d},e);let re,se;const ae=Math.max(M||0,C||0);if(ae){const Y=new h.P(M?(A+I)/2:H,C?(w+v)/2:ee);return a.center=this.unproject.call({worldSize:d},Y).wrap(),a.zoom+=this.scaleZoom(ae),a}if(this.latRange){const Y=V/2;ee-Y<v&&(se=v+Y),ee+Y>w&&(se=w-Y)}if(l){const Y=(I+A)/2;let ue=H;this._renderWorldCopies&&(ue=h.b3(H,Y-d/2,Y+d/2));const pe=O/2;ue-pe<I&&(re=I+pe),ue+pe>A&&(re=A-pe)}if(re!==void 0||se!==void 0){const Y=new h.P(re??H,se??ee);a.center=this.unproject.call({worldSize:d},Y).wrap()}return a}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const e=this._unmodified,{center:s,zoom:a}=this.getConstrained(this.center,this.zoom);this.center=s,this.zoom=a,this._unmodified=e,this._constraining=!1}_calcMatrices(){if(!this.height)return;const e=this.centerOffset,s=this.point.x,a=this.point.y;this.cameraToCenterDistance=.5/Math.tan(this._fov/2)*this.height,this._pixelPerMeter=h.b5(1,this.center.lat)*this.worldSize;let l=h.an(new Float64Array(16));h.K(l,l,[this.width/2,-this.height/2,1]),h.J(l,l,[1,-1,0]),this.labelPlaneMatrix=l,l=h.an(new Float64Array(16)),h.K(l,l,[1,-1,1]),h.J(l,l,[-1,-1,0]),h.K(l,l,[2/this.width,2/this.height,1]),this.glCoordMatrix=l;const d=this.cameraToCenterDistance+this._elevation*this._pixelPerMeter/Math.cos(this._pitch),v=Math.min(this.elevation,this.minElevationForCurrentTile),w=d-v*this._pixelPerMeter/Math.cos(this._pitch),I=v<0?w:d,A=Math.PI/2+this._pitch,C=this._fov*(.5+e.y/this.height),M=Math.sin(C)*I/Math.sin(h.ac(Math.PI-A-C,.01,Math.PI-.01)),O=this.getHorizon(),V=2*Math.atan(O/this.cameraToCenterDistance)*(.5+e.y/(2*O)),H=Math.sin(V)*I/Math.sin(h.ac(Math.PI-A-V,.01,Math.PI-.01)),ee=Math.min(M,H);this.farZ=1.01*(Math.cos(Math.PI/2-this._pitch)*ee+I),this.nearZ=this.height/50,l=new Float64Array(16),h.b6(l,this._fov,this.width/this.height,this.nearZ,this.farZ),l[8]=2*-e.x/this.width,l[9]=2*e.y/this.height,this.projectionMatrix=h.ae(l),h.K(l,l,[1,-1,1]),h.J(l,l,[0,0,-this.cameraToCenterDistance]),h.b7(l,l,this._pitch),h.ad(l,l,this.angle),h.J(l,l,[-s,-a,0]),this.mercatorMatrix=h.K([],l,[this.worldSize,this.worldSize,this.worldSize]),h.K(l,l,[1,1,this._pixelPerMeter]),this.pixelMatrix=h.L(new Float64Array(16),this.labelPlaneMatrix,l),h.J(l,l,[0,0,-this.elevation]),this.modelViewProjectionMatrix=l,this.invModelViewProjectionMatrix=h.as([],l),this.fogMatrix=new Float64Array(16),h.b6(this.fogMatrix,this._fov,this.width/this.height,d,this.farZ),this.fogMatrix[8]=2*-e.x/this.width,this.fogMatrix[9]=2*e.y/this.height,h.K(this.fogMatrix,this.fogMatrix,[1,-1,1]),h.J(this.fogMatrix,this.fogMatrix,[0,0,-this.cameraToCenterDistance]),h.b7(this.fogMatrix,this.fogMatrix,this._pitch),h.ad(this.fogMatrix,this.fogMatrix,this.angle),h.J(this.fogMatrix,this.fogMatrix,[-s,-a,0]),h.K(this.fogMatrix,this.fogMatrix,[1,1,this._pixelPerMeter]),h.J(this.fogMatrix,this.fogMatrix,[0,0,-this.elevation]),this.pixelMatrix3D=h.L(new Float64Array(16),this.labelPlaneMatrix,l);const re=this.width%2/2,se=this.height%2/2,ae=Math.cos(this.angle),Y=Math.sin(this.angle),ue=s-Math.round(s)+ae*re+Y*se,pe=a-Math.round(a)+ae*se+Y*re,ye=new Float64Array(l);if(h.J(ye,ye,[ue>.5?ue-1:ue,pe>.5?pe-1:pe,0]),this.alignedModelViewProjectionMatrix=ye,l=h.as(new Float64Array(16),this.pixelMatrix),!l)throw new Error("failed to invert matrix");this.pixelMatrixInverse=l,this._posMatrixCache={},this._alignedPosMatrixCache={},this._fogMatrixCache={}}maxPitchScaleFactor(){if(!this.pixelMatrixInverse)return 1;const e=this.pointCoordinate(new h.P(0,0)),s=[e.x*this.worldSize,e.y*this.worldSize,0,1];return h.af(s,s,this.pixelMatrix)[3]/this.cameraToCenterDistance}getCameraPoint(){const e=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new h.P(0,e))}getCameraQueryGeometry(e){const s=this.getCameraPoint();if(e.length===1)return[e[0],s];{let a=s.x,l=s.y,d=s.x,v=s.y;for(const w of e)a=Math.min(a,w.x),l=Math.min(l,w.y),d=Math.max(d,w.x),v=Math.max(v,w.y);return[new h.P(a,l),new h.P(d,l),new h.P(d,v),new h.P(a,v),new h.P(a,l)]}}lngLatToCameraDepth(e,s){const a=this.locationCoordinate(e),l=[a.x*this.worldSize,a.y*this.worldSize,s,1];return h.af(l,l,this.modelViewProjectionMatrix),l[2]/l[3]}}function ua(p,e){let s,a=!1,l=null,d=null;const v=()=>{l=null,a&&(p.apply(d,s),l=setTimeout(v,e),a=!1)};return(...w)=>(a=!0,d=this,s=w,l||v(),l)}class Rc{constructor(e){this._getCurrentHash=()=>{const s=window.location.hash.replace("#","");if(this._hashName){let a;return s.split("&").map(l=>l.split("=")).forEach(l=>{l[0]===this._hashName&&(a=l)}),(a&&a[1]||"").split("/")}return s.split("/")},this._onHashChange=()=>{const s=this._getCurrentHash();if(s.length>=3&&!s.some(a=>isNaN(a))){const a=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(s[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+s[2],+s[1]],zoom:+s[0],bearing:a,pitch:+(s[4]||0)}),!0}return!1},this._updateHashUnthrottled=()=>{const s=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,s)},this._removeHash=()=>{const s=this._getCurrentHash();if(s.length===0)return;const a=s.join("/");let l=a;l.split("&").length>0&&(l=l.split("&")[0]),this._hashName&&(l=`${this._hashName}=${a}`);let d=window.location.hash.replace(l,"");d.startsWith("#&")?d=d.slice(0,1)+d.slice(2):d==="#"&&(d="");let v=window.location.href.replace(/(#.+)?$/,d);v=v.replace("&&","&"),window.history.replaceState(window.history.state,null,v)},this._updateHash=ua(this._updateHashUnthrottled,300),this._hashName=e&&encodeURIComponent(e)}addTo(e){return this._map=e,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(e){const s=this._map.getCenter(),a=Math.round(100*this._map.getZoom())/100,l=Math.ceil((a*Math.LN2+Math.log(512/360/.5))/Math.LN10),d=Math.pow(10,l),v=Math.round(s.lng*d)/d,w=Math.round(s.lat*d)/d,I=this._map.getBearing(),A=this._map.getPitch();let C="";if(C+=e?`/${v}/${w}/${a}`:`${a}/${w}/${v}`,(I||A)&&(C+="/"+Math.round(10*I)/10),A&&(C+=`/${Math.round(A)}`),this._hashName){const M=this._hashName;let O=!1;const V=window.location.hash.slice(1).split("&").map(H=>{const ee=H.split("=")[0];return ee===M?(O=!0,`${ee}=${C}`):H}).filter(H=>H);return O||V.push(`${M}=${C}`),`#${V.join("&")}`}return`#${C}`}}const qn={linearity:.3,easing:h.b8(0,0,.3,1)},nu=h.e({deceleration:2500,maxSpeed:1400},qn),Oc=h.e({deceleration:20,maxSpeed:1400},qn),da=h.e({deceleration:1e3,maxSpeed:360},qn),fl=h.e({deceleration:1e3,maxSpeed:90},qn);class Fc{constructor(e){this._map=e,this.clear()}clear(){this._inertiaBuffer=[]}record(e){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:J.now(),settings:e})}_drainInertiaBuffer(){const e=this._inertiaBuffer,s=J.now();for(;e.length>0&&s-e[0].time>160;)e.shift()}_onMoveEnd(e){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const s={zoom:0,bearing:0,pitch:0,pan:new h.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:d}of this._inertiaBuffer)s.zoom+=d.zoomDelta||0,s.bearing+=d.bearingDelta||0,s.pitch+=d.pitchDelta||0,d.panDelta&&s.pan._add(d.panDelta),d.around&&(s.around=d.around),d.pinchAround&&(s.pinchAround=d.pinchAround);const a=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,l={};if(s.pan.mag()){const d=gn(s.pan.mag(),a,h.e({},nu,e||{}));l.offset=s.pan.mult(d.amount/s.pan.mag()),l.center=this._map.transform.center,So(l,d)}if(s.zoom){const d=gn(s.zoom,a,Oc);l.zoom=this._map.transform.zoom+d.amount,So(l,d)}if(s.bearing){const d=gn(s.bearing,a,da);l.bearing=this._map.transform.bearing+h.ac(d.amount,-179,179),So(l,d)}if(s.pitch){const d=gn(s.pitch,a,fl);l.pitch=this._map.transform.pitch+d.amount,So(l,d)}if(l.zoom||l.bearing){const d=s.pinchAround===void 0?s.around:s.pinchAround;l.around=d?this._map.unproject(d):this._map.getCenter()}return this.clear(),h.e(l,{noMoveStart:!0})}}function So(p,e){(!p.duration||p.duration<e.duration)&&(p.duration=e.duration,p.easing=e.easing)}function gn(p,e,s){const{maxSpeed:a,linearity:l,deceleration:d}=s,v=h.ac(p*l/(e/1e3),-a,a),w=Math.abs(v)/(d*l);return{easing:s.easing,duration:1e3*w,amount:v*(w/2)}}class pr extends h.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,s,a,l={}){const d=G.mousePos(s.getCanvas(),a),v=s.unproject(d);super(e,h.e({point:d,lngLat:v,originalEvent:a},l)),this._defaultPrevented=!1,this.target=s}}class Io extends h.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,s,a){const l=e==="touchend"?a.changedTouches:a.touches,d=G.touchPos(s.getCanvasContainer(),l),v=d.map(I=>s.unproject(I)),w=d.reduce((I,A,C,M)=>I.add(A.div(M.length)),new h.P(0,0));super(e,{points:d,point:w,lngLats:v,lngLat:s.unproject(w),originalEvent:a}),this._defaultPrevented=!1}}class ml extends h.k{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,s,a){super(e,{originalEvent:a}),this._defaultPrevented=!1}}class Ci{constructor(e,s){this._map=e,this._clickTolerance=s.clickTolerance}reset(){delete this._mousedownPos}wheel(e){return this._firePreventable(new ml(e.type,this._map,e))}mousedown(e,s){return this._mousedownPos=s,this._firePreventable(new pr(e.type,this._map,e))}mouseup(e){this._map.fire(new pr(e.type,this._map,e))}click(e,s){this._mousedownPos&&this._mousedownPos.dist(s)>=this._clickTolerance||this._map.fire(new pr(e.type,this._map,e))}dblclick(e){return this._firePreventable(new pr(e.type,this._map,e))}mouseover(e){this._map.fire(new pr(e.type,this._map,e))}mouseout(e){this._map.fire(new pr(e.type,this._map,e))}touchstart(e){return this._firePreventable(new Io(e.type,this._map,e))}touchmove(e){this._map.fire(new Io(e.type,this._map,e))}touchend(e){this._map.fire(new Io(e.type,this._map,e))}touchcancel(e){this._map.fire(new Io(e.type,this._map,e))}_firePreventable(e){if(this._map.fire(e),e.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class yn{constructor(e){this._map=e}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(e){this._map.fire(new pr(e.type,this._map,e))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new pr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(e){this._delayContextMenu?this._contextMenuEvent=e:this._ignoreContextMenu||this._map.fire(new pr(e.type,this._map,e)),this._map.listens("contextmenu")&&e.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ir{constructor(e){this._map=e}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(e){return this.transform.pointLocation(h.P.convert(e),this._map.terrain)}}class pa{constructor(e,s){this._map=e,this._tr=new ir(e),this._el=e.getCanvasContainer(),this._container=e.getContainer(),this._clickTolerance=s.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(e,s){this.isEnabled()&&e.shiftKey&&e.button===0&&(G.disableDrag(),this._startPos=this._lastPos=s,this._active=!0)}mousemoveWindow(e,s){if(!this._active)return;const a=s;if(this._lastPos.equals(a)||!this._box&&a.dist(this._startPos)<this._clickTolerance)return;const l=this._startPos;this._lastPos=a,this._box||(this._box=G.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",e));const d=Math.min(l.x,a.x),v=Math.max(l.x,a.x),w=Math.min(l.y,a.y),I=Math.max(l.y,a.y);G.setTransform(this._box,`translate(${d}px,${w}px)`),this._box.style.width=v-d+"px",this._box.style.height=I-w+"px"}mouseupWindow(e,s){if(!this._active||e.button!==0)return;const a=this._startPos,l=s;if(this.reset(),G.suppressClick(),a.x!==l.x||a.y!==l.y)return this._map.fire(new h.k("boxzoomend",{originalEvent:e})),{cameraAnimation:d=>d.fitScreenCoordinates(a,l,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",e)}keydown(e){this._active&&e.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",e))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(G.remove(this._box),this._box=null),G.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(e,s){return this._map.fire(new h.k(e,{originalEvent:s}))}}function To(p,e){if(p.length!==e.length)throw new Error(`The number of touches and points are not equal - touches ${p.length}, points ${e.length}`);const s={};for(let a=0;a<p.length;a++)s[p[a].identifier]=e[a];return s}class Bc{constructor(e){this.reset(),this.numTouches=e.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(e,s,a){(this.centroid||a.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=e.timeStamp),a.length===this.numTouches&&(this.centroid=function(l){const d=new h.P(0,0);for(const v of l)d._add(v);return d.div(l.length)}(s),this.touches=To(a,s)))}touchmove(e,s,a){if(this.aborted||!this.centroid)return;const l=To(a,s);for(const d in this.touches){const v=l[d];(!v||v.dist(this.touches[d])>30)&&(this.aborted=!0)}}touchend(e,s,a){if((!this.centroid||e.timeStamp-this.startTime>500)&&(this.aborted=!0),a.length===0){const l=!this.aborted&&this.centroid;if(this.reset(),l)return l}}}class Xs{constructor(e){this.singleTap=new Bc(e),this.numTaps=e.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(e,s,a){this.singleTap.touchstart(e,s,a)}touchmove(e,s,a){this.singleTap.touchmove(e,s,a)}touchend(e,s,a){const l=this.singleTap.touchend(e,s,a);if(l){const d=e.timeStamp-this.lastTime<500,v=!this.lastTap||this.lastTap.dist(l)<30;if(d&&v||this.reset(),this.count++,this.lastTime=e.timeStamp,this.lastTap=l,this.count===this.numTaps)return this.reset(),l}}}class ko{constructor(e){this._tr=new ir(e),this._zoomIn=new Xs({numTouches:1,numTaps:2}),this._zoomOut=new Xs({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(e,s,a){this._zoomIn.touchstart(e,s,a),this._zoomOut.touchstart(e,s,a)}touchmove(e,s,a){this._zoomIn.touchmove(e,s,a),this._zoomOut.touchmove(e,s,a)}touchend(e,s,a){const l=this._zoomIn.touchend(e,s,a),d=this._zoomOut.touchend(e,s,a),v=this._tr;return l?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:w=>w.easeTo({duration:300,zoom:v.zoom+1,around:v.unproject(l)},{originalEvent:e})}):d?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:w=>w.easeTo({duration:300,zoom:v.zoom-1,around:v.unproject(d)},{originalEvent:e})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class xn{constructor(e){this._enabled=!!e.enable,this._moveStateManager=e.moveStateManager,this._clickTolerance=e.clickTolerance||1,this._moveFunction=e.move,this._activateOnStart=!!e.activateOnStart,e.assignEvents(this),this.reset()}reset(e){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(e)}_move(...e){const s=this._moveFunction(...e);if(s.bearingDelta||s.pitchDelta||s.around||s.panDelta)return this._active=!0,s}dragStart(e,s){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(e)&&(this._moveStateManager.startMove(e),this._lastPoint=s.length?s[0]:s,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(e,s){if(!this.isEnabled())return;const a=this._lastPoint;if(!a)return;if(e.preventDefault(),!this._moveStateManager.isValidMoveEvent(e))return void this.reset(e);const l=s.length?s[0]:s;return!this._moved&&l.dist(a)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=l,this._move(a,l))}dragEnd(e){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(e)&&(this._moved&&G.suppressClick(),this.reset(e))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const jc={0:1,2:2};class fa{constructor(e){this._correctEvent=e.checkCorrectEvent}startMove(e){const s=G.mouseButton(e);this._eventButton=s}endMove(e){delete this._eventButton}isValidStartEvent(e){return this._correctEvent(e)}isValidMoveEvent(e){return!function(s,a){const l=jc[a];return s.buttons===void 0||(s.buttons&l)!==l}(e,this._eventButton)}isValidEndEvent(e){return G.mouseButton(e)===this._eventButton}}class _l{constructor(){this._firstTouch=void 0}_isOneFingerTouch(e){return e.targetTouches.length===1}_isSameTouchEvent(e){return e.targetTouches[0].identifier===this._firstTouch}startMove(e){this._firstTouch=e.targetTouches[0].identifier}endMove(e){delete this._firstTouch}isValidStartEvent(e){return this._isOneFingerTouch(e)}isValidMoveEvent(e){return this._isOneFingerTouch(e)&&this._isSameTouchEvent(e)}isValidEndEvent(e){return this._isOneFingerTouch(e)&&this._isSameTouchEvent(e)}}const ma=p=>{p.mousedown=p.dragStart,p.mousemoveWindow=p.dragMove,p.mouseup=p.dragEnd,p.contextmenu=e=>{e.preventDefault()}},gl=({enable:p,clickTolerance:e,bearingDegreesPerPixelMoved:s=.8})=>{const a=new fa({checkCorrectEvent:l=>G.mouseButton(l)===0&&l.ctrlKey||G.mouseButton(l)===2});return new xn({clickTolerance:e,move:(l,d)=>({bearingDelta:(d.x-l.x)*s}),moveStateManager:a,enable:p,assignEvents:ma})},Js=({enable:p,clickTolerance:e,pitchDegreesPerPixelMoved:s=-.5})=>{const a=new fa({checkCorrectEvent:l=>G.mouseButton(l)===0&&l.ctrlKey||G.mouseButton(l)===2});return new xn({clickTolerance:e,move:(l,d)=>({pitchDelta:(d.y-l.y)*s}),moveStateManager:a,enable:p,assignEvents:ma})};class Nc{constructor(e,s){this._clickTolerance=e.clickTolerance||1,this._map=s,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new h.P(0,0)}_shouldBePrevented(e){return e<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(e,s,a){return this._calculateTransform(e,s,a)}touchmove(e,s,a){if(this._active){if(!this._shouldBePrevented(a.length))return e.preventDefault(),this._calculateTransform(e,s,a);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",e)}}touchend(e,s,a){this._calculateTransform(e,s,a),this._active&&this._shouldBePrevented(a.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(e,s,a){a.length>0&&(this._active=!0);const l=To(a,s),d=new h.P(0,0),v=new h.P(0,0);let w=0;for(const A in l){const C=l[A],M=this._touches[A];M&&(d._add(C),v._add(C.sub(M)),w++,l[A]=C)}if(this._touches=l,this._shouldBePrevented(w)||!v.mag())return;const I=v.div(w);return this._sum._add(I),this._sum.mag()<this._clickTolerance?void 0:{around:d.div(w),panDelta:I}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class _a{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(e,s,a){this._firstTwoTouches||a.length<2||(this._firstTwoTouches=[a[0].identifier,a[1].identifier],this._start([s[0],s[1]]))}touchmove(e,s,a){if(!this._firstTwoTouches)return;e.preventDefault();const[l,d]=this._firstTwoTouches,v=Eo(a,s,l),w=Eo(a,s,d);if(!v||!w)return;const I=this._aroundCenter?null:v.add(w).div(2);return this._move([v,w],I,e)}touchend(e,s,a){if(!this._firstTwoTouches)return;const[l,d]=this._firstTwoTouches,v=Eo(a,s,l),w=Eo(a,s,d);v&&w||(this._active&&G.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(e){this._enabled=!0,this._aroundCenter=!!e&&e.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function Eo(p,e,s){for(let a=0;a<p.length;a++)if(p[a].identifier===s)return e[a]}function yl(p,e){return Math.log(p/e)/Math.LN2}class xl extends _a{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(e){this._startDistance=this._distance=e[0].dist(e[1])}_move(e,s){const a=this._distance;if(this._distance=e[0].dist(e[1]),this._active||!(Math.abs(yl(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:yl(this._distance,a),pinchAround:s}}}function vl(p,e){return 180*p.angleWith(e)/Math.PI}class bl extends _a{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(e){this._startVector=this._vector=e[0].sub(e[1]),this._minDiameter=e[0].dist(e[1])}_move(e,s,a){const l=this._vector;if(this._vector=e[0].sub(e[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:vl(this._vector,l),pinchAround:s}}_isBelowThreshold(e){this._minDiameter=Math.min(this._minDiameter,e.mag());const s=25/(Math.PI*this._minDiameter)*360,a=vl(e,this._startVector);return Math.abs(a)<s}}function vn(p){return Math.abs(p.y)>Math.abs(p.x)}class wl extends _a{constructor(e){super(),this._currentTouchCount=0,this._map=e}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(e,s,a){super.touchstart(e,s,a),this._currentTouchCount=a.length}_start(e){this._lastPoints=e,vn(e[0].sub(e[1]))&&(this._valid=!1)}_move(e,s,a){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const l=e[0].sub(this._lastPoints[0]),d=e[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(l,d,a.timeStamp),this._valid?(this._lastPoints=e,this._active=!0,{pitchDelta:(l.y+d.y)/2*-.5}):void 0}gestureBeginsVertically(e,s,a){if(this._valid!==void 0)return this._valid;const l=e.mag()>=2,d=s.mag()>=2;if(!l&&!d)return;if(!l||!d)return this._firstMove===void 0&&(this._firstMove=a),a-this._firstMove<100&&void 0;const v=e.y>0==s.y>0;return vn(e)&&vn(s)&&v}}const ns={panStep:100,bearingStep:15,pitchStep:10};class os{constructor(e){this._tr=new ir(e);const s=ns;this._panStep=s.panStep,this._bearingStep=s.bearingStep,this._pitchStep=s.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let s=0,a=0,l=0,d=0,v=0;switch(e.keyCode){case 61:case 107:case 171:case 187:s=1;break;case 189:case 109:case 173:s=-1;break;case 37:e.shiftKey?a=-1:(e.preventDefault(),d=-1);break;case 39:e.shiftKey?a=1:(e.preventDefault(),d=1);break;case 38:e.shiftKey?l=1:(e.preventDefault(),v=-1);break;case 40:e.shiftKey?l=-1:(e.preventDefault(),v=1);break;default:return}return this._rotationDisabled&&(a=0,l=0),{cameraAnimation:w=>{const I=this._tr;w.easeTo({duration:300,easeId:"keyboardHandler",easing:$c,zoom:s?Math.round(I.zoom)+s*(e.shiftKey?2:1):I.zoom,bearing:I.bearing+a*this._bearingStep,pitch:I.pitch+l*this._pitchStep,offset:[-d*this._panStep,-v*this._panStep],center:I.center},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function $c(p){return p*(2-p)}const as=4.000244140625;class bn{constructor(e,s){this._onTimeout=a=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(a)},this._map=e,this._tr=new ir(e),this._triggerRenderFrame=s,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222}setZoomRate(e){this._defaultZoomRate=e}setWheelZoomRate(e){this._wheelZoomRate=e}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(e){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!e&&e.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(e){return!!this._map.cooperativeGestures.isEnabled()&&!(e.ctrlKey||this._map.cooperativeGestures.isBypassed(e))}wheel(e){if(!this.isEnabled())return;if(this._shouldBePrevented(e))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",e);let s=e.deltaMode===WheelEvent.DOM_DELTA_LINE?40*e.deltaY:e.deltaY;const a=J.now(),l=a-(this._lastWheelEventTime||0);this._lastWheelEventTime=a,s!==0&&s%as==0?this._type="wheel":s!==0&&Math.abs(s)<4?this._type="trackpad":l>400?(this._type=null,this._lastValue=s,this._timeout=setTimeout(this._onTimeout,40,e)):this._type||(this._type=Math.abs(l*s)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,s+=this._lastValue)),e.shiftKey&&s&&(s/=4),this._type&&(this._lastWheelEvent=e,this._delta-=s,this._active||this._start(e)),e.preventDefault()}_start(e){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const s=G.mousePos(this._map.getCanvas(),e),a=this._tr;this._around=s.y>a.transform.height/2-a.transform.getHorizon()?h.N.convert(this._aroundCenter?a.center:a.unproject(s)):h.N.convert(a.center),this._aroundPoint=a.transform.locationPoint(this._around),this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const e=this._tr.transform;if(this._delta!==0){const I=this._type==="wheel"&&Math.abs(this._delta)>as?this._wheelZoomRate:this._defaultZoomRate;let A=2/(1+Math.exp(-Math.abs(this._delta*I)));this._delta<0&&A!==0&&(A=1/A);const C=typeof this._targetZoom=="number"?e.zoomScale(this._targetZoom):e.scale;this._targetZoom=Math.min(e.maxZoom,Math.max(e.minZoom,e.scaleZoom(C*A))),this._type==="wheel"&&(this._startZoom=e.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const s=typeof this._targetZoom=="number"?this._targetZoom:e.zoom,a=this._startZoom,l=this._easing;let d,v=!1;const w=J.now()-this._lastWheelEventTime;if(this._type==="wheel"&&a&&l&&w){const I=Math.min(w/200,1),A=l(I);d=h.y.number(a,s,A),I<1?this._frameId||(this._frameId=!0):v=!0}else d=s,v=!0;return this._active=!0,v&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200)),{noInertia:!0,needsRenderFrame:!v,zoomDelta:d-e.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(e){let s=h.b9;if(this._prevEase){const a=this._prevEase,l=(J.now()-a.start)/a.duration,d=a.easing(l+.01)-a.easing(l),v=.27/Math.sqrt(d*d+1e-4)*.01,w=Math.sqrt(.0729-v*v);s=h.b8(v,w,.25,1)}return this._prevEase={start:J.now(),duration:e,easing:s},s}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class Uc{constructor(e,s){this._clickZoom=e,this._tapZoom=s}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class ou{constructor(e){this._tr=new ir(e),this.reset()}reset(){this._active=!1}dblclick(e,s){return e.preventDefault(),{cameraAnimation:a=>{a.easeTo({duration:300,zoom:this._tr.zoom+(e.shiftKey?-1:1),around:this._tr.unproject(s)},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class au{constructor(){this._tap=new Xs({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(e,s,a){if(!this._swipePoint)if(this._tapTime){const l=s[0],d=e.timeStamp-this._tapTime<500,v=this._tapPoint.dist(l)<30;d&&v?a.length>0&&(this._swipePoint=l,this._swipeTouch=a[0].identifier):this.reset()}else this._tap.touchstart(e,s,a)}touchmove(e,s,a){if(this._tapTime){if(this._swipePoint){if(a[0].identifier!==this._swipeTouch)return;const l=s[0],d=l.y-this._swipePoint.y;return this._swipePoint=l,e.preventDefault(),this._active=!0,{zoomDelta:d/128}}}else this._tap.touchmove(e,s,a)}touchend(e,s,a){if(this._tapTime)this._swipePoint&&a.length===0&&this.reset();else{const l=this._tap.touchend(e,s,a);l&&(this._tapTime=e.timeStamp,this._tapPoint=l)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Vc{constructor(e,s,a){this._el=e,this._mousePan=s,this._touchPan=a}enable(e){this._inertiaOptions=e||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Sl{constructor(e,s,a){this._pitchWithRotate=e.pitchWithRotate,this._mouseRotate=s,this._mousePitch=a}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Gn{constructor(e,s,a,l){this._el=e,this._touchZoom=s,this._touchRotate=a,this._tapDragZoom=l,this._rotationDisabled=!1,this._enabled=!0}enable(e){this._touchZoom.enable(e),this._rotationDisabled||this._touchRotate.enable(e),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class ks{constructor(e,s){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=e,this._options=s,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const e=this._map.getCanvasContainer();e.classList.add("maplibregl-cooperative-gestures"),this._container=G.create("div","maplibregl-cooperative-gesture-screen",e);let s=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(s=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const a=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),l=document.createElement("div");l.className="maplibregl-desktop-message",l.textContent=s,this._container.appendChild(l);const d=document.createElement("div");d.className="maplibregl-mobile-message",d.textContent=a,this._container.appendChild(d),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(G.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(e){return e[this._bypassKey]}notifyGestureBlocked(e,s){this._enabled&&(this._map.fire(new h.k("cooperativegestureprevented",{gestureType:e,originalEvent:s})),this._container.classList.add("maplibregl-show"),setTimeout(()=>{this._container.classList.remove("maplibregl-show")},100))}}const Xe=p=>p.zoom||p.drag||p.pitch||p.rotate;class qc extends h.k{}function Ao(p){return p.panDelta&&p.panDelta.mag()||p.zoomDelta||p.bearingDelta||p.pitchDelta}class Gc{constructor(e,s){this.handleWindowEvent=l=>{this.handleEvent(l,`${l.type}Window`)},this.handleEvent=(l,d)=>{if(l.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const v=l.type==="renderFrame"?void 0:l,w={needsRenderFrame:!1},I={},A={},C=l.touches,M=C?this._getMapTouches(C):void 0,O=M?G.touchPos(this._map.getCanvas(),M):G.mousePos(this._map.getCanvas(),l);for(const{handlerName:ee,handler:re,allowed:se}of this._handlers){if(!re.isEnabled())continue;let ae;this._blockedByActive(A,se,ee)?re.reset():re[d||l.type]&&(ae=re[d||l.type](l,O,M),this.mergeHandlerResult(w,I,ae,ee,v),ae&&ae.needsRenderFrame&&this._triggerRenderFrame()),(ae||re.isActive())&&(A[ee]=re)}const V={};for(const ee in this._previousActiveHandlers)A[ee]||(V[ee]=v);this._previousActiveHandlers=A,(Object.keys(V).length||Ao(w))&&(this._changes.push([w,I,V]),this._triggerRenderFrame()),(Object.keys(A).length||Ao(w))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:H}=w;H&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],H(this._map))},this._map=e,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Fc(e),this._bearingSnap=s.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(s);const a=this._el;this._listeners=[[a,"touchstart",{passive:!0}],[a,"touchmove",{passive:!1}],[a,"touchend",void 0],[a,"touchcancel",void 0],[a,"mousedown",void 0],[a,"mousemove",void 0],[a,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[a,"mouseover",void 0],[a,"mouseout",void 0],[a,"dblclick",void 0],[a,"click",void 0],[a,"keydown",{capture:!1}],[a,"keyup",void 0],[a,"wheel",{passive:!1}],[a,"contextmenu",void 0],[window,"blur",void 0]];for(const[l,d,v]of this._listeners)G.addEventListener(l,d,l===document?this.handleWindowEvent:this.handleEvent,v)}destroy(){for(const[e,s,a]of this._listeners)G.removeEventListener(e,s,e===document?this.handleWindowEvent:this.handleEvent,a)}_addDefaultHandlers(e){const s=this._map,a=s.getCanvasContainer();this._add("mapEvent",new Ci(s,e));const l=s.boxZoom=new pa(s,e);this._add("boxZoom",l),e.interactive&&e.boxZoom&&l.enable();const d=s.cooperativeGestures=new ks(s,e.cooperativeGestures);this._add("cooperativeGestures",d),e.cooperativeGestures&&d.enable();const v=new ko(s),w=new ou(s);s.doubleClickZoom=new Uc(w,v),this._add("tapZoom",v),this._add("clickZoom",w),e.interactive&&e.doubleClickZoom&&s.doubleClickZoom.enable();const I=new au;this._add("tapDragZoom",I);const A=s.touchPitch=new wl(s);this._add("touchPitch",A),e.interactive&&e.touchPitch&&s.touchPitch.enable(e.touchPitch);const C=gl(e),M=Js(e);s.dragRotate=new Sl(e,C,M),this._add("mouseRotate",C,["mousePitch"]),this._add("mousePitch",M,["mouseRotate"]),e.interactive&&e.dragRotate&&s.dragRotate.enable();const O=(({enable:ae,clickTolerance:Y})=>{const ue=new fa({checkCorrectEvent:pe=>G.mouseButton(pe)===0&&!pe.ctrlKey});return new xn({clickTolerance:Y,move:(pe,ye)=>({around:ye,panDelta:ye.sub(pe)}),activateOnStart:!0,moveStateManager:ue,enable:ae,assignEvents:ma})})(e),V=new Nc(e,s);s.dragPan=new Vc(a,O,V),this._add("mousePan",O),this._add("touchPan",V,["touchZoom","touchRotate"]),e.interactive&&e.dragPan&&s.dragPan.enable(e.dragPan);const H=new bl,ee=new xl;s.touchZoomRotate=new Gn(a,ee,H,I),this._add("touchRotate",H,["touchPan","touchZoom"]),this._add("touchZoom",ee,["touchPan","touchRotate"]),e.interactive&&e.touchZoomRotate&&s.touchZoomRotate.enable(e.touchZoomRotate);const re=s.scrollZoom=new bn(s,()=>this._triggerRenderFrame());this._add("scrollZoom",re,["mousePan"]),e.interactive&&e.scrollZoom&&s.scrollZoom.enable(e.scrollZoom);const se=s.keyboard=new os(s);this._add("keyboard",se),e.interactive&&e.keyboard&&s.keyboard.enable(),this._add("blockableMapEvent",new yn(s))}_add(e,s,a){this._handlers.push({handlerName:e,handler:s,allowed:a}),this._handlersById[e]=s}stop(e){if(!this._updatingCamera){for(const{handler:s}of this._handlers)s.reset();this._inertia.clear(),this._fireEvents({},{},e),this._changes=[]}}isActive(){for(const{handler:e}of this._handlers)if(e.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Xe(this._eventsInProgress)||this.isZooming()}_blockedByActive(e,s,a){for(const l in e)if(l!==a&&(!s||s.indexOf(l)<0))return!0;return!1}_getMapTouches(e){const s=[];for(const a of e)this._el.contains(a.target)&&s.push(a);return s}mergeHandlerResult(e,s,a,l,d){if(!a)return;h.e(e,a);const v={handlerName:l,originalEvent:a.originalEvent||d};a.zoomDelta!==void 0&&(s.zoom=v),a.panDelta!==void 0&&(s.drag=v),a.pitchDelta!==void 0&&(s.pitch=v),a.bearingDelta!==void 0&&(s.rotate=v)}_applyChanges(){const e={},s={},a={};for(const[l,d,v]of this._changes)l.panDelta&&(e.panDelta=(e.panDelta||new h.P(0,0))._add(l.panDelta)),l.zoomDelta&&(e.zoomDelta=(e.zoomDelta||0)+l.zoomDelta),l.bearingDelta&&(e.bearingDelta=(e.bearingDelta||0)+l.bearingDelta),l.pitchDelta&&(e.pitchDelta=(e.pitchDelta||0)+l.pitchDelta),l.around!==void 0&&(e.around=l.around),l.pinchAround!==void 0&&(e.pinchAround=l.pinchAround),l.noInertia&&(e.noInertia=l.noInertia),h.e(s,d),h.e(a,v);this._updateMapTransform(e,s,a),this._changes=[]}_updateMapTransform(e,s,a){const l=this._map,d=l._getTransformForUpdate(),v=l.terrain;if(!(Ao(e)||v&&this._terrainMovement))return this._fireEvents(s,a,!0);let{panDelta:w,zoomDelta:I,bearingDelta:A,pitchDelta:C,around:M,pinchAround:O}=e;O!==void 0&&(M=O),l._stop(!0),M=M||l.transform.centerPoint;const V=d.pointLocation(w?M.sub(w):M);A&&(d.bearing+=A),C&&(d.pitch+=C),I&&(d.zoom+=I),v?this._terrainMovement||!s.drag&&!s.zoom?s.drag&&this._terrainMovement?d.center=d.pointLocation(d.centerPoint.sub(w)):d.setLocationAtPoint(V,M):(this._terrainMovement=!0,this._map._elevationFreeze=!0,d.setLocationAtPoint(V,M)):d.setLocationAtPoint(V,M),l._applyUpdatedTransform(d),this._map._update(),e.noInertia||this._inertia.record(e),this._fireEvents(s,a,!0)}_fireEvents(e,s,a){const l=Xe(this._eventsInProgress),d=Xe(e),v={};for(const M in e){const{originalEvent:O}=e[M];this._eventsInProgress[M]||(v[`${M}start`]=O),this._eventsInProgress[M]=e[M]}!l&&d&&this._fireEvent("movestart",d.originalEvent);for(const M in v)this._fireEvent(M,v[M]);d&&this._fireEvent("move",d.originalEvent);for(const M in e){const{originalEvent:O}=e[M];this._fireEvent(M,O)}const w={};let I;for(const M in this._eventsInProgress){const{handlerName:O,originalEvent:V}=this._eventsInProgress[M];this._handlersById[O].isActive()||(delete this._eventsInProgress[M],I=s[O]||V,w[`${M}end`]=I)}for(const M in w)this._fireEvent(M,w[M]);const A=Xe(this._eventsInProgress),C=(l||d)&&!A;if(C&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const M=this._map._getTransformForUpdate();M.recalculateZoom(this._map.terrain),this._map._applyUpdatedTransform(M)}if(a&&C){this._updatingCamera=!0;const M=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),O=V=>V!==0&&-this._bearingSnap<V&&V<this._bearingSnap;!M||!M.essential&&J.prefersReducedMotion?(this._map.fire(new h.k("moveend",{originalEvent:I})),O(this._map.getBearing())&&this._map.resetNorth()):(O(M.bearing||this._map.getBearing())&&(M.bearing=0),M.freezeElevation=!0,this._map.easeTo(M,{originalEvent:I})),this._updatingCamera=!1}}_fireEvent(e,s){this._map.fire(new h.k(e,s?{originalEvent:s}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(e=>{delete this._frameId,this.handleEvent(new qc("renderFrame",{timeStamp:e})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class Po extends h.E{constructor(e,s){super(),this._renderFrameCallback=()=>{const a=Math.min((J.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(a)),a<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=e,this._bearingSnap=s.bearingSnap,this.on("moveend",()=>{delete this._requestedCameraState})}getCenter(){return new h.N(this.transform.center.lng,this.transform.center.lat)}setCenter(e,s){return this.jumpTo({center:e},s)}panBy(e,s,a){return e=h.P.convert(e).mult(-1),this.panTo(this.transform.center,h.e({offset:e},s),a)}panTo(e,s,a){return this.easeTo(h.e({center:e},s),a)}getZoom(){return this.transform.zoom}setZoom(e,s){return this.jumpTo({zoom:e},s),this}zoomTo(e,s,a){return this.easeTo(h.e({zoom:e},s),a)}zoomIn(e,s){return this.zoomTo(this.getZoom()+1,e,s),this}zoomOut(e,s){return this.zoomTo(this.getZoom()-1,e,s),this}getBearing(){return this.transform.bearing}setBearing(e,s){return this.jumpTo({bearing:e},s),this}getPadding(){return this.transform.padding}setPadding(e,s){return this.jumpTo({padding:e},s),this}rotateTo(e,s,a){return this.easeTo(h.e({bearing:e},s),a)}resetNorth(e,s){return this.rotateTo(0,h.e({duration:1e3},e),s),this}resetNorthPitch(e,s){return this.easeTo(h.e({bearing:0,pitch:0,duration:1e3},e),s),this}snapToNorth(e,s){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(e,s):this}getPitch(){return this.transform.pitch}setPitch(e,s){return this.jumpTo({pitch:e},s),this}cameraForBounds(e,s){e=be.convert(e).adjustAntiMeridian();const a=s&&s.bearing||0;return this._cameraForBoxAndBearing(e.getNorthWest(),e.getSouthEast(),a,s)}_cameraForBoxAndBearing(e,s,a,l){const d={top:0,bottom:0,right:0,left:0};if(typeof(l=h.e({padding:d,offset:[0,0],maxZoom:this.transform.maxZoom},l)).padding=="number"){const Ne=l.padding;l.padding={top:Ne,bottom:Ne,right:Ne,left:Ne}}l.padding=h.e(d,l.padding);const v=this.transform,w=v.padding,I=new be(e,s),A=v.project(I.getNorthWest()),C=v.project(I.getNorthEast()),M=v.project(I.getSouthEast()),O=v.project(I.getSouthWest()),V=h.ba(-a),H=A.rotate(V),ee=C.rotate(V),re=M.rotate(V),se=O.rotate(V),ae=new h.P(Math.max(H.x,ee.x,se.x,re.x),Math.max(H.y,ee.y,se.y,re.y)),Y=new h.P(Math.min(H.x,ee.x,se.x,re.x),Math.min(H.y,ee.y,se.y,re.y)),ue=ae.sub(Y),pe=(v.width-(w.left+w.right+l.padding.left+l.padding.right))/ue.x,ye=(v.height-(w.top+w.bottom+l.padding.top+l.padding.bottom))/ue.y;if(ye<0||pe<0)return void h.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const Ce=Math.min(v.scaleZoom(v.scale*Math.min(pe,ye)),l.maxZoom),Re=h.P.convert(l.offset),qe=new h.P((l.padding.left-l.padding.right)/2,(l.padding.top-l.padding.bottom)/2).rotate(h.ba(a)),Je=Re.add(qe).mult(v.scale/v.zoomScale(Ce));return{center:v.unproject(A.add(M).div(2).sub(Je)),zoom:Ce,bearing:a}}fitBounds(e,s,a){return this._fitInternal(this.cameraForBounds(e,s),s,a)}fitScreenCoordinates(e,s,a,l,d){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.pointLocation(h.P.convert(e)),this.transform.pointLocation(h.P.convert(s)),a,l),l,d)}_fitInternal(e,s,a){return e?(delete(s=h.e(e,s)).padding,s.linear?this.easeTo(s,a):this.flyTo(s,a)):this}jumpTo(e,s){this.stop();const a=this._getTransformForUpdate();let l=!1,d=!1,v=!1;return"zoom"in e&&a.zoom!==+e.zoom&&(l=!0,a.zoom=+e.zoom),e.center!==void 0&&(a.center=h.N.convert(e.center)),"bearing"in e&&a.bearing!==+e.bearing&&(d=!0,a.bearing=+e.bearing),"pitch"in e&&a.pitch!==+e.pitch&&(v=!0,a.pitch=+e.pitch),e.padding==null||a.isPaddingEqual(e.padding)||(a.padding=e.padding),this._applyUpdatedTransform(a),this.fire(new h.k("movestart",s)).fire(new h.k("move",s)),l&&this.fire(new h.k("zoomstart",s)).fire(new h.k("zoom",s)).fire(new h.k("zoomend",s)),d&&this.fire(new h.k("rotatestart",s)).fire(new h.k("rotate",s)).fire(new h.k("rotateend",s)),v&&this.fire(new h.k("pitchstart",s)).fire(new h.k("pitch",s)).fire(new h.k("pitchend",s)),this.fire(new h.k("moveend",s))}calculateCameraOptionsFromTo(e,s,a,l=0){const d=h.Z.fromLngLat(e,s),v=h.Z.fromLngLat(a,l),w=v.x-d.x,I=v.y-d.y,A=v.z-d.z,C=Math.hypot(w,I,A);if(C===0)throw new Error("Can't calculate camera options with same From and To");const M=Math.hypot(w,I),O=this.transform.scaleZoom(this.transform.cameraToCenterDistance/C/this.transform.tileSize),V=180*Math.atan2(w,-I)/Math.PI;let H=180*Math.acos(M/C)/Math.PI;return H=A<0?90-H:90+H,{center:v.toLngLat(),zoom:O,pitch:H,bearing:V}}easeTo(e,s){var a;this._stop(!1,e.easeId),((e=h.e({offset:[0,0],duration:500,easing:h.b9},e)).animate===!1||!e.essential&&J.prefersReducedMotion)&&(e.duration=0);const l=this._getTransformForUpdate(),d=l.zoom,v=l.bearing,w=l.pitch,I=l.padding,A="bearing"in e?this._normalizeBearing(e.bearing,v):v,C="pitch"in e?+e.pitch:w,M="padding"in e?e.padding:l.padding,O=h.P.convert(e.offset);let V=l.centerPoint.add(O);const H=l.pointLocation(V),{center:ee,zoom:re}=l.getConstrained(h.N.convert(e.center||H),(a=e.zoom)!==null&&a!==void 0?a:d);this._normalizeCenter(ee,l);const se=l.project(H),ae=l.project(ee).sub(se),Y=l.zoomScale(re-d);let ue,pe;e.around&&(ue=h.N.convert(e.around),pe=l.locationPoint(ue));const ye={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=this._zooming||re!==d,this._rotating=this._rotating||v!==A,this._pitching=this._pitching||C!==w,this._padding=!l.isPaddingEqual(M),this._easeId=e.easeId,this._prepareEase(s,e.noMoveStart,ye),this.terrain&&this._prepareElevation(ee),this._ease(Ce=>{if(this._zooming&&(l.zoom=h.y.number(d,re,Ce)),this._rotating&&(l.bearing=h.y.number(v,A,Ce)),this._pitching&&(l.pitch=h.y.number(w,C,Ce)),this._padding&&(l.interpolatePadding(I,M,Ce),V=l.centerPoint.add(O)),this.terrain&&!e.freezeElevation&&this._updateElevation(Ce),ue)l.setLocationAtPoint(ue,pe);else{const Re=l.zoomScale(l.zoom-d),qe=re>d?Math.min(2,Y):Math.max(.5,Y),Je=Math.pow(qe,1-Ce),Ne=l.unproject(se.add(ae.mult(Ce*Je)).mult(Re));l.setLocationAtPoint(l.renderWorldCopies?Ne.wrap():Ne,V)}this._applyUpdatedTransform(l),this._fireMoveEvents(s)},Ce=>{this.terrain&&e.freezeElevation&&this._finalizeElevation(),this._afterEase(s,Ce)},e),this}_prepareEase(e,s,a={}){this._moving=!0,s||a.moving||this.fire(new h.k("movestart",e)),this._zooming&&!a.zooming&&this.fire(new h.k("zoomstart",e)),this._rotating&&!a.rotating&&this.fire(new h.k("rotatestart",e)),this._pitching&&!a.pitching&&this.fire(new h.k("pitchstart",e))}_prepareElevation(e){this._elevationCenter=e,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(e,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(e){this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);const s=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(e<1&&s!==this._elevationTarget){const a=this._elevationTarget-this._elevationStart;this._elevationStart+=e*(a-(s-(a*e+this._elevationStart))/(1-e)),this._elevationTarget=s}this.transform.elevation=h.y.number(this._elevationStart,this._elevationTarget,e)}_finalizeElevation(){this._elevationFreeze=!1,this.transform.recalculateZoom(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(e){const s=e.getCameraPosition(),a=this.terrain.getElevationForLngLatZoom(s.lngLat,e.zoom);if(s.altitude<a){const l=this.calculateCameraOptionsFromTo(s.lngLat,a,e.center,e.elevation);return{pitch:l.pitch,zoom:l.zoom}}return{}}_applyUpdatedTransform(e){const s=[];if(this.terrain&&s.push(l=>this._elevateCameraIfInsideTerrain(l)),this.transformCameraUpdate&&s.push(l=>this.transformCameraUpdate(l)),!s.length)return;const a=e.clone();for(const l of s){const d=a.clone(),{center:v,zoom:w,pitch:I,bearing:A,elevation:C}=l(d);v&&(d.center=v),w!==void 0&&(d.zoom=w),I!==void 0&&(d.pitch=I),A!==void 0&&(d.bearing=A),C!==void 0&&(d.elevation=C),a.apply(d)}this.transform.apply(a)}_fireMoveEvents(e){this.fire(new h.k("move",e)),this._zooming&&this.fire(new h.k("zoom",e)),this._rotating&&this.fire(new h.k("rotate",e)),this._pitching&&this.fire(new h.k("pitch",e))}_afterEase(e,s){if(this._easeId&&s&&this._easeId===s)return;delete this._easeId;const a=this._zooming,l=this._rotating,d=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,a&&this.fire(new h.k("zoomend",e)),l&&this.fire(new h.k("rotateend",e)),d&&this.fire(new h.k("pitchend",e)),this.fire(new h.k("moveend",e))}flyTo(e,s){var a;if(!e.essential&&J.prefersReducedMotion){const Ze=h.M(e,["center","zoom","bearing","pitch","around"]);return this.jumpTo(Ze,s)}this.stop(),e=h.e({offset:[0,0],speed:1.2,curve:1.42,easing:h.b9},e);const l=this._getTransformForUpdate(),d=l.zoom,v=l.bearing,w=l.pitch,I=l.padding,A="bearing"in e?this._normalizeBearing(e.bearing,v):v,C="pitch"in e?+e.pitch:w,M="padding"in e?e.padding:l.padding,O=h.P.convert(e.offset);let V=l.centerPoint.add(O);const H=l.pointLocation(V),{center:ee,zoom:re}=l.getConstrained(h.N.convert(e.center||H),(a=e.zoom)!==null&&a!==void 0?a:d);this._normalizeCenter(ee,l);const se=l.zoomScale(re-d),ae=l.project(H),Y=l.project(ee).sub(ae);let ue=e.curve;const pe=Math.max(l.width,l.height),ye=pe/se,Ce=Y.mag();if("minZoom"in e){const Ze=h.ac(Math.min(e.minZoom,d,re),l.minZoom,l.maxZoom),bt=pe/l.zoomScale(Ze-d);ue=Math.sqrt(bt/Ce*2)}const Re=ue*ue;function qe(Ze){const bt=(ye*ye-pe*pe+(Ze?-1:1)*Re*Re*Ce*Ce)/(2*(Ze?ye:pe)*Re*Ce);return Math.log(Math.sqrt(bt*bt+1)-bt)}function Je(Ze){return(Math.exp(Ze)-Math.exp(-Ze))/2}function Ne(Ze){return(Math.exp(Ze)+Math.exp(-Ze))/2}const Be=qe(!1);let rt=function(Ze){return Ne(Be)/Ne(Be+ue*Ze)},It=function(Ze){return pe*((Ne(Be)*(Je(bt=Be+ue*Ze)/Ne(bt))-Je(Be))/Re)/Ce;var bt},Ue=(qe(!0)-Be)/ue;if(Math.abs(Ce)<1e-6||!isFinite(Ue)){if(Math.abs(pe-ye)<1e-6)return this.easeTo(e,s);const Ze=ye<pe?-1:1;Ue=Math.abs(Math.log(ye/pe))/ue,It=()=>0,rt=bt=>Math.exp(Ze*ue*bt)}return e.duration="duration"in e?+e.duration:1e3*Ue/("screenSpeed"in e?+e.screenSpeed/ue:+e.speed),e.maxDuration&&e.duration>e.maxDuration&&(e.duration=0),this._zooming=!0,this._rotating=v!==A,this._pitching=C!==w,this._padding=!l.isPaddingEqual(M),this._prepareEase(s,!1),this.terrain&&this._prepareElevation(ee),this._ease(Ze=>{const bt=Ze*Ue,yi=1/rt(bt);l.zoom=Ze===1?re:d+l.scaleZoom(yi),this._rotating&&(l.bearing=h.y.number(v,A,Ze)),this._pitching&&(l.pitch=h.y.number(w,C,Ze)),this._padding&&(l.interpolatePadding(I,M,Ze),V=l.centerPoint.add(O)),this.terrain&&!e.freezeElevation&&this._updateElevation(Ze);const Pt=Ze===1?ee:l.unproject(ae.add(Y.mult(It(bt))).mult(yi));l.setLocationAtPoint(l.renderWorldCopies?Pt.wrap():Pt,V),this._applyUpdatedTransform(l),this._fireMoveEvents(s)},()=>{this.terrain&&e.freezeElevation&&this._finalizeElevation(),this._afterEase(s)},e),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(e,s){var a;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const l=this._onEaseEnd;delete this._onEaseEnd,l.call(this,s)}return e||(a=this.handlers)===null||a===void 0||a.stop(!1),this}_ease(e,s,a){a.animate===!1||a.duration===0?(e(1),s()):(this._easeStart=J.now(),this._easeOptions=a,this._onEaseFrame=e,this._onEaseEnd=s,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(e,s){e=h.b3(e,-180,180);const a=Math.abs(e-s);return Math.abs(e-360-s)<a&&(e-=360),Math.abs(e+360-s)<a&&(e+=360),e}_normalizeCenter(e,s){if(!s.renderWorldCopies||s.lngRange)return;const a=e.lng-s.center.lng;e.lng+=a>180?-360:a<-180?360:0}queryTerrainElevation(e){return this.terrain?this.terrain.getElevationForLngLatZoom(h.N.convert(e),this.transform.tileZoom)-this.transform.elevation:null}}const Hn={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class Il{constructor(e=Hn){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=s=>{!s||s.sourceDataType!=="metadata"&&s.sourceDataType!=="visibility"&&s.dataType!=="style"&&s.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=e}getDefaultPosition(){return"bottom-right"}onAdd(e){return this._map=e,this._compact=this.options.compact,this._container=G.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=G.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=G.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){G.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(e,s){const a=this._map._getUIString(`AttributionControl.${s}`);e.title=a,e.setAttribute("aria-label",a)}_updateAttributions(){if(!this._map.style)return;let e=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?e=e.concat(this.options.customAttribution.map(l=>typeof l!="string"?"":l)):typeof this.options.customAttribution=="string"&&e.push(this.options.customAttribution)),this._map.style.stylesheet){const l=this._map.style.stylesheet;this.styleOwner=l.owner,this.styleId=l.id}const s=this._map.style.sourceCaches;for(const l in s){const d=s[l];if(d.used||d.usedForTerrain){const v=d.getSource();v.attribution&&e.indexOf(v.attribution)<0&&e.push(v.attribution)}}e=e.filter(l=>String(l).trim()),e.sort((l,d)=>l.length-d.length),e=e.filter((l,d)=>{for(let v=d+1;v<e.length;v++)if(e[v].indexOf(l)>=0)return!1;return!0});const a=e.join(" | ");a!==this._attribHTML&&(this._attribHTML=a,e.length?(this._innerContainer.innerHTML=a,this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class Nt{constructor(e={}){this._updateCompact=()=>{const s=this._container.children;if(s.length){const a=s[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&a.classList.add("maplibregl-compact"):a.classList.remove("maplibregl-compact")}},this.options=e}getDefaultPosition(){return"bottom-left"}onAdd(e){this._map=e,this._compact=this.options&&this.options.compact,this._container=G.create("div","maplibregl-ctrl");const s=G.create("a","maplibregl-ctrl-logo");return s.target="_blank",s.rel="noopener nofollow",s.href="https://maplibre.org/",s.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),s.setAttribute("rel","noopener nofollow"),this._container.appendChild(s),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){G.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class Tl{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(e){const s=++this._id;return this._queue.push({callback:e,id:s,cancelled:!1}),s}remove(e){const s=this._currentlyRunning,a=s?this._queue.concat(s):this._queue;for(const l of a)if(l.id===e)return void(l.cancelled=!0)}run(e=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const s=this._currentlyRunning=this._queue;this._queue=[];for(const a of s)if(!a.cancelled&&(a.callback(e),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var lu=h.Y([{name:"a_pos3d",type:"Int16",components:3}]);class kl extends h.E{constructor(e){super(),this.sourceCache=e,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.deltaZoom=1,e.usedForTerrain=!0,e.tileSize=this.tileSize*2**this.deltaZoom}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(e,s){this.sourceCache.update(e,s),this._renderableTilesKeys=[];const a={};for(const l of e.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:s}))a[l.key]=!0,this._renderableTilesKeys.push(l.key),this._tiles[l.key]||(l.posMatrix=new Float64Array(16),h.aP(l.posMatrix,0,h.X,0,h.X,0,1),this._tiles[l.key]=new ts(l,this.tileSize));for(const l in this._tiles)a[l]||delete this._tiles[l]}freeRtt(e){for(const s in this._tiles){const a=this._tiles[s];(!e||a.tileID.equals(e)||a.tileID.isChildOf(e)||e.isChildOf(a.tileID))&&(a.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map(e=>this.getTileByID(e))}getTileByID(e){return this._tiles[e]}getTerrainCoords(e){const s={};for(const a of this._renderableTilesKeys){const l=this._tiles[a].tileID;if(l.canonical.equals(e.canonical)){const d=e.clone();d.posMatrix=new Float64Array(16),h.aP(d.posMatrix,0,h.X,0,h.X,0,1),s[a]=d}else if(l.canonical.isChildOf(e.canonical)){const d=e.clone();d.posMatrix=new Float64Array(16);const v=l.canonical.z-e.canonical.z,w=l.canonical.x-(l.canonical.x>>v<<v),I=l.canonical.y-(l.canonical.y>>v<<v),A=h.X>>v;h.aP(d.posMatrix,0,A,0,A,0,1),h.J(d.posMatrix,d.posMatrix,[-w*A,-I*A,0]),s[a]=d}else if(e.canonical.isChildOf(l.canonical)){const d=e.clone();d.posMatrix=new Float64Array(16);const v=e.canonical.z-l.canonical.z,w=e.canonical.x-(e.canonical.x>>v<<v),I=e.canonical.y-(e.canonical.y>>v<<v),A=h.X>>v;h.aP(d.posMatrix,0,h.X,0,h.X,0,1),h.J(d.posMatrix,d.posMatrix,[w*A,I*A,0]),h.K(d.posMatrix,d.posMatrix,[1/2**v,1/2**v,0]),s[a]=d}}return s}getSourceTile(e,s){const a=this.sourceCache._source;let l=e.overscaledZ-this.deltaZoom;if(l>a.maxzoom&&(l=a.maxzoom),l<a.minzoom)return null;this._sourceTileCache[e.key]||(this._sourceTileCache[e.key]=e.scaledTo(l).key);let d=this.sourceCache.getTileByID(this._sourceTileCache[e.key]);if((!d||!d.dem)&&s)for(;l>=a.minzoom&&(!d||!d.dem);)d=this.sourceCache.getTileByID(e.scaledTo(l--).key);return d}tilesAfterTime(e=Date.now()){return Object.values(this._tiles).filter(s=>s.timeAdded>=e)}}class cu{constructor(e,s,a){this.painter=e,this.sourceCache=new kl(s),this.options=a,this.exaggeration=typeof a.exaggeration=="number"?a.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(e,s,a,l=h.X){var d;if(!(s>=0&&s<l&&a>=0&&a<l))return 0;const v=this.getTerrainData(e),w=(d=v.tile)===null||d===void 0?void 0:d.dem;if(!w)return 0;const I=function(H,ee,re){var se=ee[0],ae=ee[1];return H[0]=re[0]*se+re[4]*ae+re[12],H[1]=re[1]*se+re[5]*ae+re[13],H}([],[s/l*h.X,a/l*h.X],v.u_terrain_matrix),A=[I[0]*w.dim,I[1]*w.dim],C=Math.floor(A[0]),M=Math.floor(A[1]),O=A[0]-C,V=A[1]-M;return w.get(C,M)*(1-O)*(1-V)+w.get(C+1,M)*O*(1-V)+w.get(C,M+1)*(1-O)*V+w.get(C+1,M+1)*O*V}getElevationForLngLatZoom(e,s){if(!h.bb(s,e.wrap()))return 0;const{tileID:a,mercatorX:l,mercatorY:d}=this._getOverscaledTileIDFromLngLatZoom(e,s);return this.getElevation(a,l%h.X,d%h.X,h.X)}getElevation(e,s,a,l=h.X){return this.getDEMElevation(e,s,a,l)*this.exaggeration}getTerrainData(e){if(!this._emptyDemTexture){const l=this.painter.context,d=new h.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new Lt(l,d,l.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new Lt(l,new h.R({width:1,height:1}),l.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(l.gl.NEAREST,l.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=h.an([])}const s=this.sourceCache.getSourceTile(e,!0);if(s&&s.dem&&(!s.demTexture||s.needsTerrainPrepare)){const l=this.painter.context;s.demTexture=this.painter.getTileTexture(s.dem.stride),s.demTexture?s.demTexture.update(s.dem.getPixels(),{premultiply:!1}):s.demTexture=new Lt(l,s.dem.getPixels(),l.gl.RGBA,{premultiply:!1}),s.demTexture.bind(l.gl.NEAREST,l.gl.CLAMP_TO_EDGE),s.needsTerrainPrepare=!1}const a=s&&s+s.tileID.key+e.key;if(a&&!this._demMatrixCache[a]){const l=this.sourceCache.sourceCache._source.maxzoom;let d=e.canonical.z-s.tileID.canonical.z;e.overscaledZ>e.canonical.z&&(e.canonical.z>=l?d=e.canonical.z-l:h.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const v=e.canonical.x-(e.canonical.x>>d<<d),w=e.canonical.y-(e.canonical.y>>d<<d),I=h.bc(new Float64Array(16),[1/(h.X<<d),1/(h.X<<d),0]);h.J(I,I,[v*h.X,w*h.X,0]),this._demMatrixCache[e.key]={matrix:I,coord:e}}return{u_depth:2,u_terrain:3,u_terrain_dim:s&&s.dem&&s.dem.dim||1,u_terrain_matrix:a?this._demMatrixCache[e.key].matrix:this._emptyDemMatrix,u_terrain_unpack:s&&s.dem&&s.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(s&&s.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:s}}getFramebuffer(e){const s=this.painter,a=s.width/devicePixelRatio,l=s.height/devicePixelRatio;return!this._fbo||this._fbo.width===a&&this._fbo.height===l||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new Lt(s.context,{width:a,height:l,data:null},s.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(s.context.gl.NEAREST,s.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new Lt(s.context,{width:a,height:l,data:null},s.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(s.context.gl.NEAREST,s.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=s.context.createFramebuffer(a,l,!0,!1),this._fbo.depthAttachment.set(s.context.createRenderbuffer(s.context.gl.DEPTH_COMPONENT16,a,l))),this._fbo.colorAttachment.set(e==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const e=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const s=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let d=0,v=0;d<this._coordsTextureSize;d++)for(let w=0;w<this._coordsTextureSize;w++,v+=4)s[v+0]=255&w,s[v+1]=255&d,s[v+2]=w>>8<<4|d>>8,s[v+3]=0;const a=new h.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(s.buffer)),l=new Lt(e,a,e.gl.RGBA,{premultiply:!1});return l.bind(e.gl.NEAREST,e.gl.CLAMP_TO_EDGE),this._coordsTexture=l,l}pointCoordinate(e){this.painter.maybeDrawDepthAndCoords(!0);const s=new Uint8Array(4),a=this.painter.context,l=a.gl,d=Math.round(e.x*this.painter.pixelRatio/devicePixelRatio),v=Math.round(e.y*this.painter.pixelRatio/devicePixelRatio),w=Math.round(this.painter.height/devicePixelRatio);a.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),l.readPixels(d,w-v-1,1,1,l.RGBA,l.UNSIGNED_BYTE,s),a.bindFramebuffer.set(null);const I=s[0]+(s[2]>>4<<8),A=s[1]+((15&s[2])<<8),C=this.coordsIndex[255-s[3]],M=C&&this.sourceCache.getTileByID(C);if(!M)return null;const O=this._coordsTextureSize,V=(1<<M.tileID.canonical.z)*O;return new h.Z((M.tileID.canonical.x*O+I)/V+M.tileID.wrap,(M.tileID.canonical.y*O+A)/V,this.getElevation(M.tileID,I,A,O))}depthAtPoint(e){const s=new Uint8Array(4),a=this.painter.context,l=a.gl;return a.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),l.readPixels(e.x,this.painter.height/devicePixelRatio-e.y-1,1,1,l.RGBA,l.UNSIGNED_BYTE,s),a.bindFramebuffer.set(null),(s[0]/16777216+s[1]/65536+s[2]/256+s[3])/256}getTerrainMesh(){if(this._mesh)return this._mesh;const e=this.painter.context,s=new h.bd,a=new h.aY,l=this.meshSize,d=h.X/l,v=l*l;for(let M=0;M<=l;M++)for(let O=0;O<=l;O++)s.emplaceBack(O*d,M*d,0);for(let M=0;M<v;M+=l+1)for(let O=0;O<l;O++)a.emplaceBack(O+M,l+O+M+1,l+O+M+2),a.emplaceBack(O+M,l+O+M+2,O+M+1);const w=s.length,I=w+2*(l+1);for(const M of[0,1])for(let O=0;O<=l;O++)for(const V of[0,1])s.emplaceBack(O*d,M*h.X,V);for(let M=0;M<2*l;M+=2)a.emplaceBack(I+M,I+M+1,I+M+3),a.emplaceBack(I+M,I+M+3,I+M+2),a.emplaceBack(w+M,w+M+3,w+M+1),a.emplaceBack(w+M,w+M+2,w+M+3);const A=s.length,C=A+2*(l+1);for(const M of[0,1])for(let O=0;O<=l;O++)for(const V of[0,1])s.emplaceBack(M*h.X,O*d,V);for(let M=0;M<2*l;M+=2)a.emplaceBack(A+M,A+M+1,A+M+3),a.emplaceBack(A+M,A+M+3,A+M+2),a.emplaceBack(C+M,C+M+3,C+M+1),a.emplaceBack(C+M,C+M+2,C+M+3);return this._mesh=new xo(e.createVertexBuffer(s,lu.members),e.createIndexBuffer(a),h.a0.simpleSegment(0,0,s.length,a.length)),this._mesh}getMeshFrameDelta(e){return 2*Math.PI*h.be/Math.pow(2,e)/5}getMinTileElevationForLngLatZoom(e,s){var a;const{tileID:l}=this._getOverscaledTileIDFromLngLatZoom(e,s);return(a=this.getMinMaxElevation(l).minElevation)!==null&&a!==void 0?a:0}getMinMaxElevation(e){const s=this.getTerrainData(e).tile,a={minElevation:null,maxElevation:null};return s&&s.dem&&(a.minElevation=s.dem.min*this.exaggeration,a.maxElevation=s.dem.max*this.exaggeration),a}_getOverscaledTileIDFromLngLatZoom(e,s){const a=h.Z.fromLngLat(e.wrap()),l=(1<<s)*h.X,d=a.x*l,v=a.y*l,w=Math.floor(d/h.X),I=Math.floor(v/h.X);return{tileID:new h.S(s,0,s,w,I),mercatorX:d,mercatorY:v}}}class hu{constructor(e,s,a){this._context=e,this._size=s,this._tileSize=a,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const e of this._objects)e.texture.destroy(),e.fbo.destroy()}_createObject(e){const s=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),a=new Lt(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return a.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),s.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),s.colorAttachment.set(a.texture),{id:e,fbo:s,texture:a,stamp:-1,inUse:!1}}getObjectForId(e){return this._objects[e]}useObject(e){e.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter(s=>e.id!==s),this._recentlyUsed.push(e.id)}stampObject(e){e.stamp=++this._stamp}getOrCreateFreeObject(){for(const s of this._recentlyUsed)if(!this._objects[s].inUse)return this._objects[s];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const e=this._createObject(this._objects.length);return this._objects.push(e),e}freeObject(e){e.inUse=!1}freeAllObjects(){for(const e of this._objects)this.freeObject(e)}isFull(){return!(this._objects.length<this._size)&&this._objects.some(e=>!e.inUse)===!1}}const wn={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0};class El{constructor(e,s){this.painter=e,this.terrain=s,this.pool=new hu(e.context,30,s.sourceCache.tileSize*s.qualityFactor)}destruct(){this.pool.destruct()}getTexture(e){return this.pool.getObjectForId(e.rtt[this._stacks.length-1].id).texture}prepareForRender(e,s){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=e._order.filter(a=>!e._layers[a].isHidden(s)),this._coordsDescendingInv={};for(const a in e.sourceCaches){this._coordsDescendingInv[a]={};const l=e.sourceCaches[a].getVisibleCoordinates();for(const d of l){const v=this.terrain.sourceCache.getTerrainCoords(d);for(const w in v)this._coordsDescendingInv[a][w]||(this._coordsDescendingInv[a][w]=[]),this._coordsDescendingInv[a][w].push(v[w])}}this._coordsDescendingInvStr={};for(const a of e._order){const l=e._layers[a],d=l.source;if(wn[l.type]&&!this._coordsDescendingInvStr[d]){this._coordsDescendingInvStr[d]={};for(const v in this._coordsDescendingInv[d])this._coordsDescendingInvStr[d][v]=this._coordsDescendingInv[d][v].map(w=>w.key).sort().join()}}for(const a of this._renderableTiles)for(const l in this._coordsDescendingInvStr){const d=this._coordsDescendingInvStr[l][a.tileID.key];d&&d!==a.rttCoords[l]&&(a.rtt=[])}}renderLayer(e){if(e.isHidden(this.painter.transform.zoom))return!1;const s=e.type,a=this.painter,l=this._renderableLayerIds[this._renderableLayerIds.length-1]===e.id;if(wn[s]&&(this._prevType&&wn[this._prevType]||this._stacks.push([]),this._prevType=s,this._stacks[this._stacks.length-1].push(e.id),!l))return!0;if(wn[this._prevType]||wn[s]&&l){this._prevType=s;const d=this._stacks.length-1,v=this._stacks[d]||[];for(const w of this._renderableTiles){if(this.pool.isFull()&&(ca(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(w),w.rtt[d]){const A=this.pool.getObjectForId(w.rtt[d].id);if(A.stamp===w.rtt[d].stamp){this.pool.useObject(A);continue}}const I=this.pool.getOrCreateFreeObject();this.pool.useObject(I),this.pool.stampObject(I),w.rtt[d]={id:I.id,stamp:I.stamp},a.context.bindFramebuffer.set(I.fbo.framebuffer),a.context.clear({color:h.aM.transparent,stencil:0}),a.currentStencilSource=void 0;for(let A=0;A<v.length;A++){const C=a.style._layers[v[A]],M=C.source?this._coordsDescendingInv[C.source][w.tileID.key]:[w.tileID];a.context.viewport.set([0,0,I.fbo.width,I.fbo.height]),a._renderTileClippingMasks(C,M),a.renderLayer(a,a.style.sourceCaches[C.source],C,M),C.source&&(w.rttCoords[C.source]=this._coordsDescendingInvStr[C.source][w.tileID.key])}}return ca(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects(),wn[s]}return!1}}const Hc={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use ⌘ + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},uu=N,Zc={hash:!1,interactive:!0,bearingSnap:7,attributionControl:Hn,maplibreLogo:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,refreshExpiredTiles:!0,scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],zoom:0,bearing:0,pitch:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:h.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0},Wc=p=>{p.touchstart=p.dragStart,p.touchmoveWindow=p.dragMove,p.touchend=p.dragEnd},du={showCompass:!0,showZoom:!0,visualizePitch:!1};class Sn{constructor(e,s,a=!1){this.mousedown=v=>{this.startMouse(h.e({},v,{ctrlKey:!0,preventDefault:()=>v.preventDefault()}),G.mousePos(this.element,v)),G.addEventListener(window,"mousemove",this.mousemove),G.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=v=>{this.moveMouse(v,G.mousePos(this.element,v))},this.mouseup=v=>{this.mouseRotate.dragEnd(v),this.mousePitch&&this.mousePitch.dragEnd(v),this.offTemp()},this.touchstart=v=>{v.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=G.touchPos(this.element,v.targetTouches)[0],this.startTouch(v,this._startPos),G.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),G.addEventListener(window,"touchend",this.touchend))},this.touchmove=v=>{v.targetTouches.length!==1?this.reset():(this._lastPos=G.touchPos(this.element,v.targetTouches)[0],this.moveTouch(v,this._lastPos))},this.touchend=v=>{v.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),this.touchRotate.reset(),this.touchPitch&&this.touchPitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10;const l=e.dragRotate._mouseRotate.getClickTolerance(),d=e.dragRotate._mousePitch.getClickTolerance();this.element=s,this.mouseRotate=gl({clickTolerance:l,enable:!0}),this.touchRotate=(({enable:v,clickTolerance:w,bearingDegreesPerPixelMoved:I=.8})=>{const A=new _l;return new xn({clickTolerance:w,move:(C,M)=>({bearingDelta:(M.x-C.x)*I}),moveStateManager:A,enable:v,assignEvents:Wc})})({clickTolerance:l,enable:!0}),this.map=e,a&&(this.mousePitch=Js({clickTolerance:d,enable:!0}),this.touchPitch=(({enable:v,clickTolerance:w,pitchDegreesPerPixelMoved:I=-.5})=>{const A=new _l;return new xn({clickTolerance:w,move:(C,M)=>({pitchDelta:(M.y-C.y)*I}),moveStateManager:A,enable:v,assignEvents:Wc})})({clickTolerance:d,enable:!0})),G.addEventListener(s,"mousedown",this.mousedown),G.addEventListener(s,"touchstart",this.touchstart,{passive:!1}),G.addEventListener(s,"touchcancel",this.reset)}startMouse(e,s){this.mouseRotate.dragStart(e,s),this.mousePitch&&this.mousePitch.dragStart(e,s),G.disableDrag()}startTouch(e,s){this.touchRotate.dragStart(e,s),this.touchPitch&&this.touchPitch.dragStart(e,s),G.disableDrag()}moveMouse(e,s){const a=this.map,{bearingDelta:l}=this.mouseRotate.dragMove(e,s)||{};if(l&&a.setBearing(a.getBearing()+l),this.mousePitch){const{pitchDelta:d}=this.mousePitch.dragMove(e,s)||{};d&&a.setPitch(a.getPitch()+d)}}moveTouch(e,s){const a=this.map,{bearingDelta:l}=this.touchRotate.dragMove(e,s)||{};if(l&&a.setBearing(a.getBearing()+l),this.touchPitch){const{pitchDelta:d}=this.touchPitch.dragMove(e,s)||{};d&&a.setPitch(a.getPitch()+d)}}off(){const e=this.element;G.removeEventListener(e,"mousedown",this.mousedown),G.removeEventListener(e,"touchstart",this.touchstart,{passive:!1}),G.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),G.removeEventListener(window,"touchend",this.touchend),G.removeEventListener(e,"touchcancel",this.reset),this.offTemp()}offTemp(){G.enableDrag(),G.removeEventListener(window,"mousemove",this.mousemove),G.removeEventListener(window,"mouseup",this.mouseup),G.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),G.removeEventListener(window,"touchend",this.touchend)}}let ti;function Co(p,e,s){const a=new h.N(p.lng,p.lat);if(p=new h.N(p.lng,p.lat),e){const l=new h.N(p.lng-360,p.lat),d=new h.N(p.lng+360,p.lat),v=s.locationPoint(p).distSqr(e);s.locationPoint(l).distSqr(e)<v?p=l:s.locationPoint(d).distSqr(e)<v&&(p=d)}for(;Math.abs(p.lng-s.center.lng)>180;){const l=s.locationPoint(p);if(l.x>=0&&l.y>=0&&l.x<=s.width&&l.y<=s.height)break;p.lng>s.center.lng?p.lng-=360:p.lng+=360}return p.lng!==a.lng&&s.locationPoint(p).y>s.height/2-s.getHorizon()?p:a}const Mo={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function Al(p,e,s){const a=p.classList;for(const l in Mo)a.remove(`maplibregl-${s}-anchor-${l}`);a.add(`maplibregl-${s}-anchor-${e}`)}class ga extends h.E{constructor(e){if(super(),this._onKeyPress=s=>{const a=s.code,l=s.charCode||s.keyCode;a!=="Space"&&a!=="Enter"&&l!==32&&l!==13||this.togglePopup()},this._onMapClick=s=>{const a=s.originalEvent.target,l=this._element;this._popup&&(a===l||l.contains(a))&&this.togglePopup()},this._update=s=>{var a;if(!this._map)return;const l=this._map.loaded()&&!this._map.isMoving();((s==null?void 0:s.type)==="terrain"||(s==null?void 0:s.type)==="render"&&!l)&&this._map.once("render",this._update),this._lngLat=this._map.transform.renderWorldCopies?Co(this._lngLat,this._flatPos,this._map.transform):(a=this._lngLat)===null||a===void 0?void 0:a.wrap(),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationPoint(this._lngLat)._add(this._offset));let d="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?d=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(d=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let v="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?v="rotateX(0deg)":this._pitchAlignment==="map"&&(v=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||s&&s.type!=="moveend"||(this._pos=this._pos.round()),G.setTransform(this._element,`${Mo[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${v} ${d}`),J.frameAsync(new AbortController).then(()=>{this._updateOpacity(s&&s.type==="moveend")}).catch(()=>{})},this._onMove=s=>{if(!this._isDragging){const a=this._clickTolerance||this._map._clickTolerance;this._isDragging=s.point.dist(this._pointerdownPos)>=a}this._isDragging&&(this._pos=s.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new h.k("dragstart"))),this.fire(new h.k("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new h.k("dragend")),this._state="inactive"},this._addDragHandler=s=>{this._element.contains(s.originalEvent.target)&&(s.preventDefault(),this._positionDelta=s.point.sub(this._pos).add(this._offset),this._pointerdownPos=s.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=e&&e.anchor||"center",this._color=e&&e.color||"#3FB1CE",this._scale=e&&e.scale||1,this._draggable=e&&e.draggable||!1,this._clickTolerance=e&&e.clickTolerance||0,this._subpixelPositioning=e&&e.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=e&&e.rotation||0,this._rotationAlignment=e&&e.rotationAlignment||"auto",this._pitchAlignment=e&&e.pitchAlignment&&e.pitchAlignment!=="auto"?e.pitchAlignment:this._rotationAlignment,this.setOpacity(),this.setOpacity(e==null?void 0:e.opacity,e==null?void 0:e.opacityWhenCovered),e&&e.element)this._element=e.element,this._offset=h.P.convert(e&&e.offset||[0,0]);else{this._defaultMarker=!0,this._element=G.create("div");const s=G.createNS("http://www.w3.org/2000/svg","svg"),a=41,l=27;s.setAttributeNS(null,"display","block"),s.setAttributeNS(null,"height",`${a}px`),s.setAttributeNS(null,"width",`${l}px`),s.setAttributeNS(null,"viewBox",`0 0 ${l} ${a}`);const d=G.createNS("http://www.w3.org/2000/svg","g");d.setAttributeNS(null,"stroke","none"),d.setAttributeNS(null,"stroke-width","1"),d.setAttributeNS(null,"fill","none"),d.setAttributeNS(null,"fill-rule","evenodd");const v=G.createNS("http://www.w3.org/2000/svg","g");v.setAttributeNS(null,"fill-rule","nonzero");const w=G.createNS("http://www.w3.org/2000/svg","g");w.setAttributeNS(null,"transform","translate(3.0, 29.0)"),w.setAttributeNS(null,"fill","#000000");const I=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const se of I){const ae=G.createNS("http://www.w3.org/2000/svg","ellipse");ae.setAttributeNS(null,"opacity","0.04"),ae.setAttributeNS(null,"cx","10.5"),ae.setAttributeNS(null,"cy","5.80029008"),ae.setAttributeNS(null,"rx",se.rx),ae.setAttributeNS(null,"ry",se.ry),w.appendChild(ae)}const A=G.createNS("http://www.w3.org/2000/svg","g");A.setAttributeNS(null,"fill",this._color);const C=G.createNS("http://www.w3.org/2000/svg","path");C.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),A.appendChild(C);const M=G.createNS("http://www.w3.org/2000/svg","g");M.setAttributeNS(null,"opacity","0.25"),M.setAttributeNS(null,"fill","#000000");const O=G.createNS("http://www.w3.org/2000/svg","path");O.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),M.appendChild(O);const V=G.createNS("http://www.w3.org/2000/svg","g");V.setAttributeNS(null,"transform","translate(6.0, 7.0)"),V.setAttributeNS(null,"fill","#FFFFFF");const H=G.createNS("http://www.w3.org/2000/svg","g");H.setAttributeNS(null,"transform","translate(8.0, 8.0)");const ee=G.createNS("http://www.w3.org/2000/svg","circle");ee.setAttributeNS(null,"fill","#000000"),ee.setAttributeNS(null,"opacity","0.25"),ee.setAttributeNS(null,"cx","5.5"),ee.setAttributeNS(null,"cy","5.5"),ee.setAttributeNS(null,"r","5.4999962");const re=G.createNS("http://www.w3.org/2000/svg","circle");re.setAttributeNS(null,"fill","#FFFFFF"),re.setAttributeNS(null,"cx","5.5"),re.setAttributeNS(null,"cy","5.5"),re.setAttributeNS(null,"r","5.4999962"),H.appendChild(ee),H.appendChild(re),v.appendChild(w),v.appendChild(A),v.appendChild(M),v.appendChild(V),v.appendChild(H),s.appendChild(v),s.setAttributeNS(null,"height",a*this._scale+"px"),s.setAttributeNS(null,"width",l*this._scale+"px"),this._element.appendChild(s),this._offset=h.P.convert(e&&e.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",s=>{s.preventDefault()}),this._element.addEventListener("mousedown",s=>{s.preventDefault()}),Al(this._element,this._anchor,"marker"),e&&e.className)for(const s of e.className.split(" "))this._element.classList.add(s);this._popup=null}addTo(e){return this.remove(),this._map=e,this._element.setAttribute("aria-label",e._getUIString("Marker.Title")),e.getCanvasContainer().appendChild(this._element),e.on("move",this._update),e.on("moveend",this._update),e.on("terrain",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),G.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(e){return this._lngLat=h.N.convert(e),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(e){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),e){if(!("offset"in e.options)){const l=Math.abs(13.5)/Math.SQRT2;e.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[l,-1*(38.1-13.5+l)],"bottom-right":[-l,-1*(38.1-13.5+l)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=e,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(e){return this._subpixelPositioning=e,this}getPopup(){return this._popup}togglePopup(){const e=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:e?(e.isOpen()?e.remove():(e.setLngLat(this._lngLat),e.addTo(this._map)),this):this}_updateOpacity(e=!1){var s,a;if(!(!((s=this._map)===null||s===void 0)&&s.terrain))return void(this._element.style.opacity!==this._opacity&&(this._element.style.opacity=this._opacity));if(e)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout(()=>{this._opacityTimeout=null},100)}const l=this._map,d=l.terrain.depthAtPoint(this._pos),v=l.terrain.getElevationForLngLatZoom(this._lngLat,l.transform.tileZoom);if(l.transform.lngLatToCameraDepth(this._lngLat,v)-d<.006)return void(this._element.style.opacity=this._opacity);const w=-this._offset.y/l.transform._pixelPerMeter,I=Math.sin(l.getPitch()*Math.PI/180)*w,A=l.terrain.depthAtPoint(new h.P(this._pos.x,this._pos.y-this._offset.y)),C=l.transform.lngLatToCameraDepth(this._lngLat,v+I)-A>.006;!((a=this._popup)===null||a===void 0)&&a.isOpen()&&C&&this._popup.remove(),this._element.style.opacity=C?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(e){return this._offset=h.P.convert(e),this._update(),this}addClassName(e){this._element.classList.add(e)}removeClassName(e){this._element.classList.remove(e)}toggleClassName(e){return this._element.classList.toggle(e)}setDraggable(e){return this._draggable=!!e,this._map&&(e?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(e){return this._rotation=e||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(e){return this._rotationAlignment=e||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(e){return this._pitchAlignment=e&&e!=="auto"?e:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(e,s){return e===void 0&&s===void 0&&(this._opacity="1",this._opacityWhenCovered="0.2"),e!==void 0&&(this._opacity=e),s!==void 0&&(this._opacityWhenCovered=s),this._map&&this._updateOpacity(!0),this}}const Xc={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let ya=0,Tr=!1;const xa={maxWidth:100,unit:"metric"};function lt(p,e,s){const a=s&&s.maxWidth||100,l=p._container.clientHeight/2,d=p.unproject([0,l]),v=p.unproject([a,l]),w=d.distanceTo(v);if(s&&s.unit==="imperial"){const I=3.2808*w;I>5280?dt(e,a,I/5280,p._getUIString("ScaleControl.Miles")):dt(e,a,I,p._getUIString("ScaleControl.Feet"))}else s&&s.unit==="nautical"?dt(e,a,w/1852,p._getUIString("ScaleControl.NauticalMiles")):w>=1e3?dt(e,a,w/1e3,p._getUIString("ScaleControl.Kilometers")):dt(e,a,w,p._getUIString("ScaleControl.Meters"))}function dt(p,e,s,a){const l=function(d){const v=Math.pow(10,`${Math.floor(d)}`.length-1);let w=d/v;return w=w>=10?10:w>=5?5:w>=3?3:w>=2?2:w>=1?1:function(I){const A=Math.pow(10,Math.ceil(-Math.log(I)/Math.LN10));return Math.round(I*A)/A}(w),v*w}(s);p.style.width=e*(l/s)+"px",p.innerHTML=`${l}&nbsp;${a}`}const va={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1},Pl=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function ba(p){if(p){if(typeof p=="number"){const e=Math.round(Math.abs(p)/Math.SQRT2);return{center:new h.P(0,0),top:new h.P(0,p),"top-left":new h.P(e,e),"top-right":new h.P(-e,e),bottom:new h.P(0,-p),"bottom-left":new h.P(e,-e),"bottom-right":new h.P(-e,-e),left:new h.P(p,0),right:new h.P(-p,0)}}if(p instanceof h.P||Array.isArray(p)){const e=h.P.convert(p);return{center:e,top:e,"top-left":e,"top-right":e,bottom:e,"bottom-left":e,"bottom-right":e,left:e,right:e}}return{center:h.P.convert(p.center||[0,0]),top:h.P.convert(p.top||[0,0]),"top-left":h.P.convert(p["top-left"]||[0,0]),"top-right":h.P.convert(p["top-right"]||[0,0]),bottom:h.P.convert(p.bottom||[0,0]),"bottom-left":h.P.convert(p["bottom-left"]||[0,0]),"bottom-right":h.P.convert(p["bottom-right"]||[0,0]),left:h.P.convert(p.left||[0,0]),right:h.P.convert(p.right||[0,0])}}return ba(new h.P(0,0))}const kr=N;S.AJAXError=h.bh,S.Evented=h.E,S.LngLat=h.N,S.MercatorCoordinate=h.Z,S.Point=h.P,S.addProtocol=h.bi,S.config=h.a,S.removeProtocol=h.bj,S.AttributionControl=Il,S.BoxZoomHandler=pa,S.CanvasSource=br,S.CooperativeGesturesHandler=ks,S.DoubleClickZoomHandler=Uc,S.DragPanHandler=Vc,S.DragRotateHandler=Sl,S.EdgeInsets=bo,S.FullscreenControl=class extends h.E{constructor(p={}){super(),this._onFullscreenChange=()=>{var e;let s=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((e=s==null?void 0:s.shadowRoot)===null||e===void 0)&&e.fullscreenElement;)s=s.shadowRoot.fullscreenElement;s===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,p&&p.container&&(p.container instanceof HTMLElement?this._container=p.container:h.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(p){return this._map=p,this._container||(this._container=this._map.getContainer()),this._controlContainer=G.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){G.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const p=this._fullscreenButton=G.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);G.create("span","maplibregl-ctrl-icon",p).setAttribute("aria-hidden","true"),p.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const p=this._getTitle();this._fullscreenButton.setAttribute("aria-label",p),this._fullscreenButton.title=p}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new h.k("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new h.k("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},S.GeoJSONSource=Qr,S.GeolocateControl=class extends h.E{constructor(p){super(),this._onSuccess=e=>{if(this._map){if(this._isOutOfMapMaxBounds(e))return this._setErrorState(),this.fire(new h.k("outofmaxbounds",e)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=e,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(e),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(e),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new h.k("geolocate",e)),this._finish()}},this._updateCamera=e=>{const s=new h.N(e.coords.longitude,e.coords.latitude),a=e.coords.accuracy,l=this._map.getBearing(),d=h.e({bearing:l},this.options.fitBoundsOptions),v=be.fromLngLat(s,a);this._map.fitBounds(v,d,{geolocateSource:!0})},this._updateMarker=e=>{if(e){const s=new h.N(e.coords.longitude,e.coords.latitude);this._accuracyCircleMarker.setLngLat(s).addTo(this._map),this._userLocationDotMarker.setLngLat(s).addTo(this._map),this._accuracy=e.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=e=>{if(this._map){if(this.options.trackUserLocation)if(e.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const s=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=s,this._geolocateButton.setAttribute("aria-label",s),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(e.code===3&&Tr)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new h.k("error",e)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",e=>e.preventDefault()),this._geolocateButton=G.create("button","maplibregl-ctrl-geolocate",this._container),G.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=e=>{if(this._map){if(e===!1){h.w("Geolocation support is not available so the GeolocateControl will be disabled.");const s=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=s,this._geolocateButton.setAttribute("aria-label",s)}else{const s=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=s,this._geolocateButton.setAttribute("aria-label",s)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=G.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new ga({element:this._dotElement}),this._circleElement=G.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ga({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",()=>this.trigger()),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",s=>{s.geolocateSource||this._watchState!=="ACTIVE_LOCK"||s.originalEvent&&s.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new h.k("trackuserlocationend")),this.fire(new h.k("userlocationlostfocus")))})}},this.options=h.e({},Xc,p)}onAdd(p){return this._map=p,this._container=G.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),function(){return h._(this,arguments,void 0,function*(e=!1){if(ti!==void 0&&!e)return ti;if(window.navigator.permissions===void 0)return ti=!!window.navigator.geolocation,ti;try{ti=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{ti=!!window.navigator.geolocation}return ti})}().then(e=>this._finishSetupUI(e)),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),G.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,ya=0,Tr=!1}_isOutOfMapMaxBounds(p){const e=this._map.getMaxBounds(),s=p.coords;return e&&(s.longitude<e.getWest()||s.longitude>e.getEast()||s.latitude<e.getSouth()||s.latitude>e.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const p=this._map.getBounds(),e=p.getSouthEast(),s=p.getNorthEast(),a=e.distanceTo(s),l=Math.ceil(this._accuracy/(a/this._map._container.clientHeight)*2);this._circleElement.style.width=`${l}px`,this._circleElement.style.height=`${l}px`}trigger(){if(!this._setup)return h.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new h.k("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":ya--,Tr=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new h.k("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new h.k("trackuserlocationstart")),this.fire(new h.k("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let p;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),ya++,ya>1?(p={maximumAge:6e5,timeout:0},Tr=!0):(p=this.options.positionOptions,Tr=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,p)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},S.Hash=Rc,S.ImageSource=vr,S.KeyboardHandler=os,S.LngLatBounds=be,S.LogoControl=Nt,S.Map=class extends Po{constructor(p){h.bf.mark(h.bg.create);const e=Object.assign(Object.assign({},Zc),p);if(e.minZoom!=null&&e.maxZoom!=null&&e.minZoom>e.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(e.minPitch!=null&&e.maxPitch!=null&&e.minPitch>e.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(e.minPitch!=null&&e.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(e.maxPitch!=null&&e.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new Vn(e.minZoom,e.maxZoom,e.minPitch,e.maxPitch,e.renderWorldCopies),{bearingSnap:e.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new Tl,this._controls=[],this._mapId=h.a4(),this._contextLost=s=>{s.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new h.k("webglcontextlost",{originalEvent:s}))},this._contextRestored=s=>{this._setupPainter(),this.resize(),this._update(),this.fire(new h.k("webglcontextrestored",{originalEvent:s}))},this._onMapScroll=s=>{if(s.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=e.interactive,this._maxTileCacheSize=e.maxTileCacheSize,this._maxTileCacheZoomLevels=e.maxTileCacheZoomLevels,this._failIfMajorPerformanceCaveat=e.failIfMajorPerformanceCaveat===!0,this._preserveDrawingBuffer=e.preserveDrawingBuffer===!0,this._antialias=e.antialias===!0,this._trackResize=e.trackResize===!0,this._bearingSnap=e.bearingSnap,this._refreshExpiredTiles=e.refreshExpiredTiles===!0,this._fadeDuration=e.fadeDuration,this._crossSourceCollisions=e.crossSourceCollisions===!0,this._collectResourceTiming=e.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},Hc),e.locale),this._clickTolerance=e.clickTolerance,this._overridePixelRatio=e.pixelRatio,this._maxCanvasSize=e.maxCanvasSize,this.transformCameraUpdate=e.transformCameraUpdate,this.cancelPendingTileRequestsWhileZooming=e.cancelPendingTileRequestsWhileZooming===!0,this._imageQueueHandle=Ct.addThrottleControl(()=>this.isMoving()),this._requestManager=new Li(e.transformRequest),typeof e.container=="string"){if(this._container=document.getElementById(e.container),!this._container)throw new Error(`Container '${e.container}' not found.`)}else{if(!(e.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=e.container}if(e.maxBounds&&this.setMaxBounds(e.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",()=>this._update(!1)).on("moveend",()=>this._update(!1)).on("zoom",()=>this._update(!0)).on("terrain",()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)}).once("idle",()=>{this._idleTriggered=!0}),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let s=!1;const a=ua(l=>{this._trackResize&&!this._removed&&(this.resize(l),this.redraw())},50);this._resizeObserver=new ResizeObserver(l=>{s?a(l):s=!0}),this._resizeObserver.observe(this._container)}this.handlers=new Gc(this,e),this._hash=e.hash&&new Rc(typeof e.hash=="string"&&e.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:e.center,zoom:e.zoom,bearing:e.bearing,pitch:e.pitch}),e.bounds&&(this.resize(),this.fitBounds(e.bounds,h.e({},e.fitBoundsOptions,{duration:0})))),this.resize(),this._localIdeographFontFamily=e.localIdeographFontFamily,this._validateStyle=e.validateStyle,e.style&&this.setStyle(e.style,{localIdeographFontFamily:e.localIdeographFontFamily}),e.attributionControl&&this.addControl(new Il(typeof e.attributionControl=="boolean"?void 0:e.attributionControl)),e.maplibreLogo&&this.addControl(new Nt,e.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",s=>{this._update(s.dataType==="style"),this.fire(new h.k(`${s.dataType}data`,s))}),this.on("dataloading",s=>{this.fire(new h.k(`${s.dataType}dataloading`,s))}),this.on("dataabort",s=>{this.fire(new h.k("sourcedataabort",s))})}_getMapId(){return this._mapId}addControl(p,e){if(e===void 0&&(e=p.getDefaultPosition?p.getDefaultPosition():"top-right"),!p||!p.onAdd)return this.fire(new h.j(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const s=p.onAdd(this);this._controls.push(p);const a=this._controlPositions[e];return e.indexOf("bottom")!==-1?a.insertBefore(s,a.firstChild):a.appendChild(s),this}removeControl(p){if(!p||!p.onRemove)return this.fire(new h.j(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const e=this._controls.indexOf(p);return e>-1&&this._controls.splice(e,1),p.onRemove(this),this}hasControl(p){return this._controls.indexOf(p)>-1}calculateCameraOptionsFromTo(p,e,s,a){return a==null&&this.terrain&&(a=this.terrain.getElevationForLngLatZoom(s,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(p,e,s,a)}resize(p){var e;const s=this._containerDimensions(),a=s[0],l=s[1],d=this._getClampedPixelRatio(a,l);if(this._resizeCanvas(a,l,d),this.painter.resize(a,l,d),this.painter.overLimit()){const w=this.painter.context.gl;this._maxCanvasSize=[w.drawingBufferWidth,w.drawingBufferHeight];const I=this._getClampedPixelRatio(a,l);this._resizeCanvas(a,l,I),this.painter.resize(a,l,I)}this.transform.resize(a,l),(e=this._requestedCameraState)===null||e===void 0||e.resize(a,l);const v=!this._moving;return v&&(this.stop(),this.fire(new h.k("movestart",p)).fire(new h.k("move",p))),this.fire(new h.k("resize",p)),v&&this.fire(new h.k("moveend",p)),this}_getClampedPixelRatio(p,e){const{0:s,1:a}=this._maxCanvasSize,l=this.getPixelRatio(),d=p*l,v=e*l;return Math.min(d>s?s/d:1,v>a?a/v:1)*l}getPixelRatio(){var p;return(p=this._overridePixelRatio)!==null&&p!==void 0?p:devicePixelRatio}setPixelRatio(p){this._overridePixelRatio=p,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(p){return this.transform.setMaxBounds(be.convert(p)),this._update()}setMinZoom(p){if((p=p??-2)>=-2&&p<=this.transform.maxZoom)return this.transform.minZoom=p,this._update(),this.getZoom()<p&&this.setZoom(p),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(p){if((p=p??22)>=this.transform.minZoom)return this.transform.maxZoom=p,this._update(),this.getZoom()>p&&this.setZoom(p),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(p){if((p=p??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(p>=0&&p<=this.transform.maxPitch)return this.transform.minPitch=p,this._update(),this.getPitch()<p&&this.setPitch(p),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(p){if((p=p??60)>85)throw new Error("maxPitch must be less than or equal to 85");if(p>=this.transform.minPitch)return this.transform.maxPitch=p,this._update(),this.getPitch()>p&&this.setPitch(p),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(p){return this.transform.renderWorldCopies=p,this._update()}project(p){return this.transform.locationPoint(h.N.convert(p),this.style&&this.terrain)}unproject(p){return this.transform.pointLocation(h.P.convert(p),this.terrain)}isMoving(){var p;return this._moving||((p=this.handlers)===null||p===void 0?void 0:p.isMoving())}isZooming(){var p;return this._zooming||((p=this.handlers)===null||p===void 0?void 0:p.isZooming())}isRotating(){var p;return this._rotating||((p=this.handlers)===null||p===void 0?void 0:p.isRotating())}_createDelegatedListener(p,e,s){if(p==="mouseenter"||p==="mouseover"){let a=!1;return{layers:e,listener:s,delegates:{mousemove:d=>{const v=e.filter(I=>this.getLayer(I)),w=v.length!==0?this.queryRenderedFeatures(d.point,{layers:v}):[];w.length?a||(a=!0,s.call(this,new pr(p,this,d.originalEvent,{features:w}))):a=!1},mouseout:()=>{a=!1}}}}if(p==="mouseleave"||p==="mouseout"){let a=!1;return{layers:e,listener:s,delegates:{mousemove:v=>{const w=e.filter(I=>this.getLayer(I));(w.length!==0?this.queryRenderedFeatures(v.point,{layers:w}):[]).length?a=!0:a&&(a=!1,s.call(this,new pr(p,this,v.originalEvent)))},mouseout:v=>{a&&(a=!1,s.call(this,new pr(p,this,v.originalEvent)))}}}}{const a=l=>{const d=e.filter(w=>this.getLayer(w)),v=d.length!==0?this.queryRenderedFeatures(l.point,{layers:d}):[];v.length&&(l.features=v,s.call(this,l),delete l.features)};return{layers:e,listener:s,delegates:{[p]:a}}}}_saveDelegatedListener(p,e){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[p]=this._delegatedListeners[p]||[],this._delegatedListeners[p].push(e)}_removeDelegatedListener(p,e,s){if(!this._delegatedListeners||!this._delegatedListeners[p])return;const a=this._delegatedListeners[p];for(let l=0;l<a.length;l++){const d=a[l];if(d.listener===s&&d.layers.length===e.length&&d.layers.every(v=>e.includes(v))){for(const v in d.delegates)this.off(v,d.delegates[v]);return void a.splice(l,1)}}}on(p,e,s){if(s===void 0)return super.on(p,e);const a=this._createDelegatedListener(p,typeof e=="string"?[e]:e,s);this._saveDelegatedListener(p,a);for(const l in a.delegates)this.on(l,a.delegates[l]);return this}once(p,e,s){if(s===void 0)return super.once(p,e);const a=typeof e=="string"?[e]:e,l=this._createDelegatedListener(p,a,s);for(const d in l.delegates){const v=l.delegates[d];l.delegates[d]=(...w)=>{this._removeDelegatedListener(p,a,s),v(...w)}}this._saveDelegatedListener(p,l);for(const d in l.delegates)this.once(d,l.delegates[d]);return this}off(p,e,s){return s===void 0?super.off(p,e):(this._removeDelegatedListener(p,typeof e=="string"?[e]:e,s),this)}queryRenderedFeatures(p,e){if(!this.style)return[];let s;const a=p instanceof h.P||Array.isArray(p),l=a?p:[[0,0],[this.transform.width,this.transform.height]];if(e=e||(a?{}:p)||{},l instanceof h.P||typeof l[0]=="number")s=[h.P.convert(l)];else{const d=h.P.convert(l[0]),v=h.P.convert(l[1]);s=[d,new h.P(v.x,d.y),v,new h.P(d.x,v.y),d]}return this.style.queryRenderedFeatures(s,e,this.transform)}querySourceFeatures(p,e){return this.style.querySourceFeatures(p,e)}setStyle(p,e){return(e=h.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},e)).diff!==!1&&e.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&p?(this._diffStyle(p,e),this):(this._localIdeographFontFamily=e.localIdeographFontFamily,this._updateStyle(p,e))}setTransformRequest(p){return this._requestManager.setTransformRequest(p),this}_getUIString(p){const e=this._locale[p];if(e==null)throw new Error(`Missing UI string '${p}'`);return e}_updateStyle(p,e){if(e.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",()=>this._updateStyle(p,e));const s=this.style&&e.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!p)),p?(this.style=new Xo(this,e||{}),this.style.setEventedParent(this,{style:this.style}),typeof p=="string"?this.style.loadURL(p,e,s):this.style.loadJSON(p,e,s),this):(delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new Xo(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(p,e){if(typeof p=="string"){const s=this._requestManager.transformRequest(p,"Style");h.h(s,new AbortController).then(a=>{this._updateDiff(a.data,e)}).catch(a=>{a&&this.fire(new h.j(a))})}else typeof p=="object"&&this._updateDiff(p,e)}_updateDiff(p,e){try{this.style.setState(p,e)&&this._update(!0)}catch(s){h.w(`Unable to perform style diff: ${s.message||s.error||s}.  Rebuilding the style from scratch.`),this._updateStyle(p,e)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():h.w("There is no style added to the map.")}addSource(p,e){return this._lazyInitEmptyStyle(),this.style.addSource(p,e),this._update(!0)}isSourceLoaded(p){const e=this.style&&this.style.sourceCaches[p];if(e!==void 0)return e.loaded();this.fire(new h.j(new Error(`There is no source with ID '${p}'`)))}setTerrain(p){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),p){const e=this.style.sourceCaches[p.source];if(!e)throw new Error(`cannot load terrain, because there exists no source with ID: ${p.source}`);this.terrain===null&&e.reload();for(const s in this.style._layers){const a=this.style._layers[s];a.type==="hillshade"&&a.source===p.source&&h.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new cu(this.painter,e,p),this.painter.renderToTexture=new El(this.painter,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._terrainDataCallback=s=>{s.dataType==="style"?this.terrain.sourceCache.freeRtt():s.dataType==="source"&&s.tile&&(s.sourceId!==p.source||this._elevationFreeze||(this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.terrain.sourceCache.freeRtt(s.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.minElevationForCurrentTile=0,this.transform.elevation=0;return this.fire(new h.k("terrain",{terrain:p})),this}getTerrain(){var p,e;return(e=(p=this.terrain)===null||p===void 0?void 0:p.options)!==null&&e!==void 0?e:null}areTilesLoaded(){const p=this.style&&this.style.sourceCaches;for(const e in p){const s=p[e]._tiles;for(const a in s){const l=s[a];if(l.state!=="loaded"&&l.state!=="errored")return!1}}return!0}removeSource(p){return this.style.removeSource(p),this._update(!0)}getSource(p){return this.style.getSource(p)}addImage(p,e,s={}){const{pixelRatio:a=1,sdf:l=!1,stretchX:d,stretchY:v,content:w,textFitWidth:I,textFitHeight:A}=s;if(this._lazyInitEmptyStyle(),!(e instanceof HTMLImageElement||h.b(e))){if(e.width===void 0||e.height===void 0)return this.fire(new h.j(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:C,height:M,data:O}=e,V=e;return this.style.addImage(p,{data:new h.R({width:C,height:M},new Uint8Array(O)),pixelRatio:a,stretchX:d,stretchY:v,content:w,textFitWidth:I,textFitHeight:A,sdf:l,version:0,userImage:V}),V.onAdd&&V.onAdd(this,p),this}}{const{width:C,height:M,data:O}=J.getImageData(e);this.style.addImage(p,{data:new h.R({width:C,height:M},O),pixelRatio:a,stretchX:d,stretchY:v,content:w,textFitWidth:I,textFitHeight:A,sdf:l,version:0})}}updateImage(p,e){const s=this.style.getImage(p);if(!s)return this.fire(new h.j(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const a=e instanceof HTMLImageElement||h.b(e)?J.getImageData(e):e,{width:l,height:d,data:v}=a;if(l===void 0||d===void 0)return this.fire(new h.j(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(l!==s.data.width||d!==s.data.height)return this.fire(new h.j(new Error("The width and height of the updated image must be that same as the previous version of the image")));const w=!(e instanceof HTMLImageElement||h.b(e));return s.data.replace(v,w),this.style.updateImage(p,s),this}getImage(p){return this.style.getImage(p)}hasImage(p){return p?!!this.style.getImage(p):(this.fire(new h.j(new Error("Missing required image id"))),!1)}removeImage(p){this.style.removeImage(p)}loadImage(p){return Ct.getImage(this._requestManager.transformRequest(p,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(p,e){return this._lazyInitEmptyStyle(),this.style.addLayer(p,e),this._update(!0)}moveLayer(p,e){return this.style.moveLayer(p,e),this._update(!0)}removeLayer(p){return this.style.removeLayer(p),this._update(!0)}getLayer(p){return this.style.getLayer(p)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(p,e,s){return this.style.setLayerZoomRange(p,e,s),this._update(!0)}setFilter(p,e,s={}){return this.style.setFilter(p,e,s),this._update(!0)}getFilter(p){return this.style.getFilter(p)}setPaintProperty(p,e,s,a={}){return this.style.setPaintProperty(p,e,s,a),this._update(!0)}getPaintProperty(p,e){return this.style.getPaintProperty(p,e)}setLayoutProperty(p,e,s,a={}){return this.style.setLayoutProperty(p,e,s,a),this._update(!0)}getLayoutProperty(p,e){return this.style.getLayoutProperty(p,e)}setGlyphs(p,e={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(p,e),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(p,e,s={}){return this._lazyInitEmptyStyle(),this.style.addSprite(p,e,s,a=>{a||this._update(!0)}),this}removeSprite(p){return this._lazyInitEmptyStyle(),this.style.removeSprite(p),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(p,e={}){return this._lazyInitEmptyStyle(),this.style.setSprite(p,e,s=>{s||this._update(!0)}),this}setLight(p,e={}){return this._lazyInitEmptyStyle(),this.style.setLight(p,e),this._update(!0)}getLight(){return this.style.getLight()}setSky(p){return this._lazyInitEmptyStyle(),this.style.setSky(p),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(p,e){return this.style.setFeatureState(p,e),this._update()}removeFeatureState(p,e){return this.style.removeFeatureState(p,e),this._update()}getFeatureState(p){return this.style.getFeatureState(p)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let p=0,e=0;return this._container&&(p=this._container.clientWidth||400,e=this._container.clientHeight||300),[p,e]}_setupContainer(){const p=this._container;p.classList.add("maplibregl-map");const e=this._canvasContainer=G.create("div","maplibregl-canvas-container",p);this._interactive&&e.classList.add("maplibregl-interactive"),this._canvas=G.create("canvas","maplibregl-canvas",e),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const s=this._containerDimensions(),a=this._getClampedPixelRatio(s[0],s[1]);this._resizeCanvas(s[0],s[1],a);const l=this._controlContainer=G.create("div","maplibregl-control-container",p),d=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(v=>{d[v]=G.create("div",`maplibregl-ctrl-${v} `,l)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(p,e,s){this._canvas.width=Math.floor(s*p),this._canvas.height=Math.floor(s*e),this._canvas.style.width=`${p}px`,this._canvas.style.height=`${e}px`}_setupPainter(){const p={alpha:!0,stencil:!0,depth:!0,failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1};let e=null;this._canvas.addEventListener("webglcontextcreationerror",a=>{e={requestedAttributes:p},a&&(e.statusMessage=a.statusMessage,e.type=a.type)},{once:!0});const s=this._canvas.getContext("webgl2",p)||this._canvas.getContext("webgl",p);if(!s){const a="Failed to initialize WebGL";throw e?(e.message=a,new Error(JSON.stringify(e))):new Error(a)}this.painter=new ha(s,this.transform),ve.testSupport(s)}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(p){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||p,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(p){return this._update(),this._renderTaskQueue.add(p)}_cancelRenderFrame(p){this._renderTaskQueue.remove(p)}_render(p){const e=this._idleTriggered?this._fadeDuration:0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(p),this._removed)return;let s=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const l=this.transform.zoom,d=J.now();this.style.zoomHistory.update(l,d);const v=new h.z(l,{now:d,fadeDuration:e,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),w=v.crossFadingFactor();w===1&&w===this._crossFadingFactor||(s=!0,this._crossFadingFactor=w),this.style.update(v)}this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._elevationFreeze||(this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.minElevationForCurrentTile=0,this.transform.elevation=0),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,e,this._crossSourceCollisions),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:e,showPadding:this.showPadding}),this.fire(new h.k("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,h.bf.mark(h.bg.load),this.fire(new h.k("load"))),this.style&&(this.style.hasTransitions()||s)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const a=this._sourcesDirty||this._styleDirty||this._placementDirty;return a||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new h.k("idle")),!this._loaded||this._fullyLoaded||a||(this._fullyLoaded=!0,h.bf.mark(h.bg.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var p;this._hash&&this._hash.remove();for(const s of this._controls)s.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),Ct.removeThrottleControl(this._imageQueueHandle),(p=this._resizeObserver)===null||p===void 0||p.disconnect();const e=this.painter.context.gl.getExtension("WEBGL_lose_context");e!=null&&e.loseContext&&e.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),G.remove(this._canvasContainer),G.remove(this._controlContainer),this._container.classList.remove("maplibregl-map"),h.bf.clearMetrics(),this._removed=!0,this.fire(new h.k("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,J.frameAsync(this._frameRequest).then(p=>{h.bf.frame(p),this._frameRequest=null,this._render(p)}).catch(()=>{}))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(p){this._showTileBoundaries!==p&&(this._showTileBoundaries=p,this._update())}get showPadding(){return!!this._showPadding}set showPadding(p){this._showPadding!==p&&(this._showPadding=p,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(p){this._showCollisionBoxes!==p&&(this._showCollisionBoxes=p,p?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(p){this._showOverdrawInspector!==p&&(this._showOverdrawInspector=p,this._update())}get repaint(){return!!this._repaint}set repaint(p){this._repaint!==p&&(this._repaint=p,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(p){this._vertices=p,this._update()}get version(){return uu}getCameraTargetElevation(){return this.transform.elevation}},S.MapMouseEvent=pr,S.MapTouchEvent=Io,S.MapWheelEvent=ml,S.Marker=ga,S.NavigationControl=class{constructor(p){this._updateZoomButtons=()=>{const e=this._map.getZoom(),s=e===this._map.getMaxZoom(),a=e===this._map.getMinZoom();this._zoomInButton.disabled=s,this._zoomOutButton.disabled=a,this._zoomInButton.setAttribute("aria-disabled",s.toString()),this._zoomOutButton.setAttribute("aria-disabled",a.toString())},this._rotateCompassArrow=()=>{const e=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._compassIcon.style.transform=e},this._setButtonTitle=(e,s)=>{const a=this._map._getUIString(`NavigationControl.${s}`);e.title=a,e.setAttribute("aria-label",a)},this.options=h.e({},du,p),this._container=G.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",e=>e.preventDefault()),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",e=>this._map.zoomIn({},{originalEvent:e})),G.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",e=>this._map.zoomOut({},{originalEvent:e})),G.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",e=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:e}):this._map.resetNorth({},{originalEvent:e})}),this._compassIcon=G.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(p){return this._map=p,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Sn(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){G.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(p,e){const s=G.create("button",p,this._container);return s.type="button",s.addEventListener("click",e),s}},S.Popup=class extends h.E{constructor(p){super(),this.remove=()=>(this._content&&G.remove(this._content),this._container&&(G.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new h.k("close"))),this),this._onMouseUp=e=>{this._update(e.point)},this._onMouseMove=e=>{this._update(e.point)},this._onDrag=e=>{this._update(e.point)},this._update=e=>{var s;if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=G.create("div","maplibregl-popup",this._map.getContainer()),this._tip=G.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const w of this.options.className.split(" "))this._container.classList.add(w);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=this._map.transform.renderWorldCopies&&!this._trackPointer?Co(this._lngLat,this._flatPos,this._map.transform):(s=this._lngLat)===null||s===void 0?void 0:s.wrap(),this._trackPointer&&!e)return;const a=this._flatPos=this._pos=this._trackPointer&&e?e:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&e?e:this._map.transform.locationPoint(this._lngLat));let l=this.options.anchor;const d=ba(this.options.offset);if(!l){const w=this._container.offsetWidth,I=this._container.offsetHeight;let A;A=a.y+d.bottom.y<I?["top"]:a.y>this._map.transform.height-I?["bottom"]:[],a.x<w/2?A.push("left"):a.x>this._map.transform.width-w/2&&A.push("right"),l=A.length===0?"bottom":A.join("-")}let v=a.add(d[l]);this.options.subpixelPositioning||(v=v.round()),G.setTransform(this._container,`${Mo[l]} translate(${v.x}px,${v.y}px)`),Al(this._container,l,"popup")},this._onClose=()=>{this.remove()},this.options=h.e(Object.create(va),p)}addTo(p){return this._map&&this.remove(),this._map=p,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new h.k("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(p){return this._lngLat=h.N.convert(p),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(p){return this.setDOMContent(document.createTextNode(p))}setHTML(p){const e=document.createDocumentFragment(),s=document.createElement("body");let a;for(s.innerHTML=p;a=s.firstChild,a;)e.appendChild(a);return this.setDOMContent(e)}getMaxWidth(){var p;return(p=this._container)===null||p===void 0?void 0:p.style.maxWidth}setMaxWidth(p){return this.options.maxWidth=p,this._update(),this}setDOMContent(p){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=G.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(p),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(p){return this._container&&this._container.classList.add(p),this}removeClassName(p){return this._container&&this._container.classList.remove(p),this}setOffset(p){return this.options.offset=p,this._update(),this}toggleClassName(p){if(this._container)return this._container.classList.toggle(p)}setSubpixelPositioning(p){this.options.subpixelPositioning=p}_createCloseButton(){this.options.closeButton&&(this._closeButton=G.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const p=this._container.querySelector(Pl);p&&p.focus()}},S.RasterDEMTileSource=Si,S.RasterTileSource=Gt,S.ScaleControl=class{constructor(p){this._onMove=()=>{lt(this._map,this._container,this.options)},this.setUnit=e=>{this.options.unit=e,lt(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},xa),p)}getDefaultPosition(){return"bottom-left"}onAdd(p){return this._map=p,this._container=G.create("div","maplibregl-ctrl maplibregl-ctrl-scale",p.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){G.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},S.ScrollZoomHandler=bn,S.Style=Xo,S.TerrainControl=class{constructor(p){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=p}onAdd(p){return this._map=p,this._container=G.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=G.create("button","maplibregl-ctrl-terrain",this._container),G.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){G.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},S.TwoFingersTouchPitchHandler=wl,S.TwoFingersTouchRotateHandler=bl,S.TwoFingersTouchZoomHandler=xl,S.TwoFingersTouchZoomRotateHandler=Gn,S.VectorTileSource=on,S.VideoSource=Ki,S.addSourceType=(p,e)=>h._(void 0,void 0,void 0,function*(){if(ln(p))throw new Error(`A source type called "${p}" already exists.`);((s,a)=>{an[s]=a})(p,e)}),S.clearPrewarmedResources=function(){const p=wi;p&&(p.isPreloaded()&&p.numActive()===1?(p.release(Yr),wi=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},S.getMaxParallelImageRequests=function(){return h.a.MAX_PARALLEL_IMAGE_REQUESTS},S.getRTLTextPluginStatus=function(){return Wr().getRTLTextPluginStatus()},S.getVersion=function(){return kr},S.getWorkerCount=function(){return Lr.workerCount},S.getWorkerUrl=function(){return h.a.WORKER_URL},S.importScriptInWorkers=function(p){return Gs().broadcast("IS",p)},S.prewarm=function(){Mt().acquire(Yr)},S.setMaxParallelImageRequests=function(p){h.a.MAX_PARALLEL_IMAGE_REQUESTS=p},S.setRTLTextPlugin=function(p,e){return Wr().setRTLTextPlugin(p,e)},S.setWorkerCount=function(p){Lr.workerCount=p},S.setWorkerUrl=function(p){h.a.WORKER_URL=p}});var k=u;return k})}(Eh)),Eh.exports}var wh=Tx();const em="rgb(170, 0, 0)",hd="#aaa";class kx{constructor(n,u,_,x){U(this,"width");U(this,"height");U(this,"data");U(this,"map");U(this,"focused");U(this,"route");U(this,"heading");U(this,"rendered",!1);U(this,"context");this.map=n,this.focused=u,this.route=_,this.heading=x,u?(this.width=100,this.height=100):(this.width=80,this.height=80),this.data=new Uint8ClampedArray(this.width*this.height*4)}onAdd(){const n=document.createElement("canvas");n.width=this.width,n.height=this.height,this.context=n.getContext("2d")||void 0}render(){if(this.rendered||!this.context)return!1;const n=this.width/2*.6,{context:u}=this;if(u.save(),u.fillStyle="#fff",u.clearRect(0,0,this.width,this.height),u.translate(this.width/2,this.height/2),this.focused){u.rotate(this.heading*Math.PI/180);const _=6;u.beginPath(),u.moveTo(0,-this.height/2+_),u.lineTo(35-_,35-_),u.lineTo(0,25-_),u.lineTo(-35+_,35-_),u.closePath(),u.lineWidth=_,u.strokeStyle=hd,u.stroke(),u.fillStyle=em,u.fill(),u.rotate(-this.heading*Math.PI/180)}else{if(typeof this.heading<"u"&&this.heading!==null){u.rotate(this.heading*Math.PI/180),u.beginPath(),u.fillStyle=hd;const _=15,x=18;u.moveTo(0,0-n-_),u.lineTo(0-x/2,0-n),u.lineTo(0+x/2,0-n),u.closePath(),u.fill("evenodd"),u.rotate(-this.heading*Math.PI/180)}u.beginPath(),u.arc(0,0,n,0,2*Math.PI),u.lineWidth=4,u.strokeStyle=hd,u.fillStyle=em,u.fill("evenodd"),u.stroke()}return u.fillStyle="#eee",u.font="20px Arial",u.textAlign="center",u.textBaseline="middle",u.fillText(this.route,0,0),u.restore(),this.data=u.getImageData(0,0,this.width,this.height).data,this.rendered=!0,!0}}const Ex=qs({__name:"Map",props:{selectedMarker:{default:()=>({})},mapMovedManually:{type:Boolean}},emits:["markerClick","update:mapMovedManually"],setup(g,{emit:n}){const u=g,_=n;let x,k=!0;const S=_i({get:()=>u.mapMovedManually,set:De=>_("update:mapMovedManually",De)}),h=Kg(),N=Gi({east:0,west:0,north:0,south:0}),{stops:q,unsubscribe:ne}=Mn.useStops(N),{vehicles:J,unsubscribe:G}=Mn.useVehicles(N),ve=_i(()=>Object.values(J.value).map(De=>{let Ut=De.type,ni=`${De.type}-selected`;if(De.type==="bus"){const oi={kind:"vehicle",type:De.type,name:De.name.split(" ")[0],focused:!1,heading:De.location.heading};Ut=JSON.stringify(oi),ni=JSON.stringify({...oi,focused:!0})}return{type:"Feature",properties:{kind:"vehicle",type:De.type,name:De.name,id:De.id,number:De.name.split(" ")[0],to:De.name.split(" ").slice(1).join(" "),iconName:Ut,iconNameFocused:ni,iconSize:De.type==="bus"?1.2:.8},geometry:{type:"Point",coordinates:[De.location.longitude/36e5,De.location.latitude/36e5]}}})),Ee=_i(()=>Object.values(q.value).map(De=>({type:"Feature",properties:{kind:"stop",type:De.type,name:De.name,id:De.id,iconName:De.type,iconNameFocused:`${De.type}-selected`},geometry:{type:"Point",coordinates:[De.location.longitude/36e5,De.location.latitude/36e5]}}))),$e=Uo(u,"selectedMarker"),{vehicle:_t,unsubscribe:Tt}=Mn.useVehicle(_i(()=>$e.value.id)),{trip:xt,unsubscribe:Ct}=Mn.useTrip(_i(()=>{var De;return(De=_t.value)==null?void 0:De.tripId})),Li=_i(()=>{var De,Ut;return((De=_t.value)==null?void 0:De.type)==="bus"&&((Ut=xt.value)!=null&&Ut.path)?[{type:"Feature",properties:{type:"trip"},geometry:{type:"LineString",coordinates:xt.value.path.map(ni=>[ni.longitude/36e5,ni.latitude/36e5])}}]:[]}),Yt=_i(()=>({type:"FeatureCollection",features:[...ve.value,...Ee.value,...Li.value]})),Vt=_i(()=>{var De,Ut;return{id:"stops",type:"symbol",source:"geojson",filter:["==","kind","stop"],paint:{"icon-opacity":["match",["get","number"],((De=_t.value)==null?void 0:De.name.split(" ")[0])??"",1,$e.value.type==="bus"?.3:1]},layout:{"icon-image":["match",["get","id"],$e.value.id||"",["get","iconNameFocused"],["get","iconName"]],"icon-size":.4,"icon-rotation-alignment":"map","icon-allow-overlap":!0,"symbol-sort-key":["match",["get","number"],((Ut=_t.value)==null?void 0:Ut.name.split(" ")[0])??"",2,1]}}}),yt=_i(()=>{var De,Ut;return{id:"vehicles",type:"symbol",source:"geojson",paint:{"icon-opacity":["match",["get","number"],((De=_t.value)==null?void 0:De.name.split(" ")[0])??"",1,$e.value.type==="bus"?.3:1]},filter:["==","kind","vehicle"],layout:{"icon-image":["match",["get","id"],$e.value.id||"",["get","iconNameFocused"],["get","iconName"]],"icon-size":["get","iconSize"],"icon-rotation-alignment":"map","icon-allow-overlap":!0,"symbol-sort-key":["match",["get","number"],((Ut=_t.value)==null?void 0:Ut.name.split(" ")[0])??"",2,1]}}}),ri=_i(()=>({id:"trips",type:"line",source:"geojson",filter:["==","type","trip"],paint:{"line-width":3,"line-color":"rgb(170, 0, 0)"}})),Bt=Gi(null),{width:ji,height:Lt}=Yg(Bt);function kt(De){x&&x.flyTo({center:De,padding:{left:ji.value>=768?320:0,bottom:ji.value>=768?0:Lt.value*(2/3)}})}Qg(async()=>{const{lastLocation:De}=dm();x=new wh.Map({container:"map",style:h.value==="dark"?Pf:Cf,minZoom:5,maxZoom:18,center:De.value.center,zoom:De.value.zoom,pitch:De.value.pitch,bearing:De.value.bearing,maxBounds:[5,46,15,57],attributionControl:!1});const Ut=new wh.AttributionControl({compact:!0});x.addControl(Ut,"bottom-left");const ni=new wh.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});x.addControl(ni,"bottom-right"),x.addControl(new wh.NavigationControl({}),"bottom-right"),navigator.permissions&&(await navigator.permissions.query({name:"geolocation"})).state==="granted"&&ni.trigger(),x.on("styleimagemissing",Ni=>{if(Ni.id[0]!=="{")return;const si=JSON.parse(Ni.id);si.kind==="vehicle"&&si.type==="bus"&&x.addImage(Ni.id,new kx(x,si.focused,si.name,si.heading),{pixelRatio:2})});async function oi(Ni,si){const gi=await x.loadImage(si);x.addImage(Ni,gi.data,{pixelRatio:2})}async function ws(){await oi("bus-stop","/icons/stop-bus.png"),await oi("bus-stop-selected","/icons/stop-bus-selected.png"),await oi("bike-stop","/icons/stop-bike.png"),await oi("bike-stop-selected","/icons/stop-bike-selected.png"),await oi("tram-stop","/icons/stop-tram.png"),await oi("tram-stop-selected","/icons/stop-tram-selected.png"),await oi("train-stop","/icons/stop-train.png"),await oi("train-stop-selected","/icons/stop-train-selected.png"),await oi("ferry-stop","/icons/stop-ferry.png"),await oi("ferry-stop-selected","/icons/stop-ferry-selected.png"),await oi("escooter","/icons/vehicle-escooter.png"),await oi("escooter-selected","/icons/vehicle-escooter-selected.png")}x.on("load",()=>{ws(),x.addSource("geojson",{type:"geojson",data:Object.freeze(Yt.value)}),x.addLayer(Vt.value),x.addLayer(ri.value),x.addLayer(yt.value),k=!1}),x.on("mouseenter","vehicles",()=>{x.getCanvas().style.cursor="pointer"}),x.on("mouseleave","vehicles",()=>{x.getCanvas().style.cursor=""}),x.on("mouseenter","stops",()=>{x.getCanvas().style.cursor="pointer"}),x.on("mouseleave","stops",()=>{x.getCanvas().style.cursor=""}),x.on("click",Ni=>{const si=x.queryRenderedFeatures(Ni.point,{layers:["stops","vehicles"]});if(si.length===0){_("markerClick");return}const gi=si[0];gi.properties.id!==$e.value.id&&(S.value=!1,_("markerClick",{type:gi.properties.type,id:gi.properties.id}))}),x.on("drag",()=>{S.value=!0}),x.on("move",()=>{De.value={center:x.getCenter(),zoom:x.getZoom(),pitch:x.getPitch(),bearing:x.getBearing()},N.value={north:x.getBounds().getNorth(),east:x.getBounds().getEast(),south:x.getBounds().getSouth(),west:x.getBounds().getWest()}})}),um(async()=>{await ne(),await G(),await Tt(),await Ct()}),io(h,()=>{h.value==="dark"?x.setStyle(Pf):x.setStyle(Cf),window.location.reload()}),io(Yt,()=>{if(!x)return;const De=x.getSource("geojson");(ni=>(ni==null?void 0:ni.type)==="geojson")(De)&&De.setData(Object.freeze(Yt.value))}),io(Vt,()=>{!x||k||(Vt.value.layout&&Object.keys(Vt.value.layout).forEach(De=>{Vt.value.layout&&x.setLayoutProperty("stops",De,Vt.value.layout[De])}),Vt.value.paint&&Object.keys(Vt.value.paint).forEach(De=>{Vt.value.paint&&x.setPaintProperty("stops",De,Vt.value.paint[De])}))}),io(yt,()=>{!x||k||(yt.value.layout&&Object.keys(yt.value.layout).forEach(De=>{yt.value.layout&&x.setLayoutProperty("vehicles",De,yt.value.layout[De])}),yt.value.paint&&Object.keys(yt.value.paint).forEach(De=>{yt.value.paint&&x.setPaintProperty("vehicles",De,yt.value.paint[De])}))});const pi=_i(()=>{const De=$e.value;if(De)return Yt.value.features.find(Ut=>Ut.properties.id===De.id)});return io(pi,(De,Ut)=>{var ni;!x||!De||De.properties.id===(Ut==null?void 0:Ut.properties.id)||kt((ni=De.geometry)==null?void 0:ni.coordinates)}),(De,Ut)=>(Le(),mt("div",{id:"map",ref_key:"mapElement",ref:Bt,class:"w-full h-full"},null,512))}}),Ax=Cd(Ex,[["__scopeId","data-v-0ac17b1b"]]),Px={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function Cx(g,n){return Le(),mt("svg",Px,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M18 8H8c-1.1 0-2 .9-2 2v6a2 2 0 0 0 2 2h10c1.11 0 2-.89 2-2v-6a2 2 0 0 0-2-2m-4 8H8v-2h6zm4-4H8v-2h10zm4-6H4v16H2V2h2v2h18z"},null,-1)]))}const Nd=Ti({name:"mdi-sign-real-estate",render:Cx}),$d="kiel-live-favorites-v1",Fm="favoriteStops",tm=localStorage.getItem(Fm);if(tm!==null){const g=JSON.parse(tm);localStorage.setItem($d,JSON.stringify(g.map(n=>({id:`kvg-${n.id}`,name:n.name,type:"bus-stop"})))),localStorage.removeItem(Fm)}const im=Gi(JSON.parse(localStorage.getItem($d)??"[]")),no=_i({get(){return im.value},set(g){im.value=g,localStorage.setItem($d,JSON.stringify(g))}}),{track:Bm}=sy();function Mx({id:g,name:n,type:u}){no.value=[...no.value,{id:g,name:n,type:u}],Bm("favorite:add",{favorites:no.value.length})}function zx(g){no.value=no.value.filter(n=>n.id!==g.id),Bm("favorite:remove",{favorites:no.value.length})}function Dx(g){return no.value.some(n=>n.id===g.id)}function jm(){return{favorites:no,addFavorite:Mx,removeFavorite:zx,isFavorite:Dx}}const Lx={class:"flex flex-col min-h-0 flex-grow"},Rx={class:"flex pb-2 mb-2 border-b-1 dark:border-dark-100 space-x-2 items-center"},Ox={class:"text-lg"},Fx={key:0,class:"m-auto max-w-52 text-center text-xl"},Bx={class:"flex flex-col overflow-y-auto"},jx={class:""},Nx=qs({__name:"FavoritesPopup",setup(g){const{t:n}=Go(),{favorites:u}=jm();return(_,x)=>{const k=pm,S=Nd,h=lc("router-link");return Le(),mt("div",Lx,[Qe("div",Rx,[Vi(k),Qe("h1",Ox,hi(st(n)("favorites")),1)]),st(u).length===0?(Le(),mt("div",Fx,[Qe("p",null,hi(st(n)("add_favorites")),1)])):zi("",!0),Qe("div",Bx,[(Le(!0),mt($s,null,Vo(st(u),N=>(Le(),Ft(h,{key:N.id,to:{name:"map-marker",params:{markerType:N.type,markerId:N.id}},class:"flex py-2 not-last:border-b-1 dark:border-dark-300"},{default:tr(()=>[N.type==="bus-stop"?(Le(),Ft(S,{key:0,class:"mr-2"})):zi("",!0),Qe("div",jx,hi(N.name),1)]),_:2},1032,["to"]))),128))])])}}}),$x={viewBox:"0 0 512 512",width:"1.2em",height:"1.2em"};function Ux(g,n){return Le(),mt("svg",$x,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M288 39.056v16.659c0 10.804 7.281 20.159 17.686 23.066C383.204 100.434 440 171.518 440 256c0 101.689-82.295 184-184 184c-101.689 0-184-82.295-184-184c0-84.47 56.786-155.564 134.312-177.219C216.719 75.874 224 66.517 224 55.712V39.064c0-15.709-14.834-27.153-30.046-23.234C86.603 43.482 7.394 141.206 8.003 257.332c.72 137.052 111.477 246.956 248.531 246.667C393.255 503.711 504 392.788 504 256c0-115.633-79.14-212.779-186.211-240.236C302.678 11.889 288 23.456 288 39.056"},null,-1)]))}const Nm=Ti({name:"fa-solid-circle-notch",render:Ux}),Vx={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function qx(g,n){return Le(),mt("svg",Vx,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"m18.18 10l-1.7-4.68A2.01 2.01 0 0 0 14.6 4H12v2h2.6l1.46 4h-4.81l-.36-1H12V7H7v2h1.75l1.82 5H9.9c-.44-2.23-2.31-3.88-4.65-3.99C2.45 9.87 0 12.2 0 15s2.2 5 5 5c2.46 0 4.45-1.69 4.9-4h4.2c.44 2.23 2.31 3.88 4.65 3.99c2.8.13 5.25-2.19 5.25-5c0-2.8-2.2-5-5-5h-.82zM7.82 16c-.4 1.17-1.49 2-2.82 2c-1.68 0-3-1.32-3-3s1.32-3 3-3c1.33 0 2.42.83 2.82 2H5v2zm6.28-2h-1.4l-.73-2H15c-.44.58-.76 1.25-.9 2m4.9 4c-1.68 0-3-1.32-3-3c0-.93.41-1.73 1.05-2.28l.96 2.64l1.88-.68l-.97-2.67c.03 0 .06-.01.09-.01c1.68 0 3 1.32 3 3s-1.33 3-3.01 3"},null,-1)]))}const $m=Ti({name:"ic-outline-pedal-bike",render:qx}),Gx={viewBox:"0 0 416 512",width:"0.99em",height:"1.2em"};function Hx(g,n){return Le(),mt("svg",Gx,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M272 96c26.51 0 48-21.49 48-48S298.51 0 272 0s-48 21.49-48 48s21.49 48 48 48M113.69 317.47l-14.8 34.52H32c-17.67 0-32 14.33-32 32s14.33 32 32 32h77.45c19.25 0 36.58-11.44 44.11-29.09l8.79-20.52l-10.67-6.3c-17.32-10.23-30.06-25.37-37.99-42.61M384 223.99h-44.03l-26.06-53.25c-12.5-25.55-35.45-44.23-61.78-50.94l-71.08-21.14c-28.3-6.8-57.77-.55-80.84 17.14l-39.67 30.41c-14.03 10.75-16.69 30.83-5.92 44.86s30.84 16.66 44.86 5.92l39.69-30.41c7.67-5.89 17.44-8 25.27-6.14l14.7 4.37l-37.46 87.39c-12.62 29.48-1.31 64.01 26.3 80.31l84.98 50.17l-27.47 87.73c-5.28 16.86 4.11 34.81 20.97 40.09c3.19 1 6.41 1.48 9.58 1.48c13.61 0 26.23-8.77 30.52-22.45l31.64-101.06c5.91-20.77-2.89-43.08-21.64-54.39l-61.24-36.14l31.31-78.28l20.27 41.43c8 16.34 24.92 26.89 43.11 26.89H384c17.67 0 32-14.33 32-32s-14.33-31.99-32-31.99"},null,-1)]))}const Zx=Ti({name:"fa-solid-running",render:Hx}),Wx={viewBox:"0 0 448 512",width:"1.06em",height:"1.2em"};function Xx(g,n){return Le(),mt("svg",Wx,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M408.781 128.007C386.356 127.578 368 146.36 368 168.79V256h-8V79.79c0-22.43-18.356-41.212-40.781-40.783C297.488 39.423 280 57.169 280 79v177h-8V40.79C272 18.36 253.644-.422 231.219.007C209.488.423 192 18.169 192 40v216h-8V80.79c0-22.43-18.356-41.212-40.781-40.783C121.488 40.423 104 58.169 104 80v235.992l-31.648-43.519c-12.993-17.866-38.009-21.817-55.877-8.823c-17.865 12.994-21.815 38.01-8.822 55.877l125.601 172.705A48 48 0 0 0 172.073 512h197.59c22.274 0 41.622-15.324 46.724-37.006l26.508-112.66a192 192 0 0 0 5.104-43.975V168c.001-21.831-17.487-39.577-39.218-39.993"},null,-1)]))}const Jx=Ti({name:"fa-solid-hand-paper",render:Xx}),Kx={viewBox:"0 0 512 512",width:"1.2em",height:"1.2em"};function Yx(g,n){return Le(),mt("svg",Kx,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M256 8C119 8 8 119 8 256s111 248 248 248s248-111 248-248S393 8 256 8m92.49 313l-20 25a16 16 0 0 1-22.49 2.5l-67-49.72a40 40 0 0 1-15-31.23V112a16 16 0 0 1 16-16h32a16 16 0 0 1 16 16v144l58 42.5a16 16 0 0 1 2.49 22.5"},null,-1)]))}const Qx=Ti({name:"fa-solid-clock",render:Yx}),e1={viewBox:"0 0 32 32",width:"1.2em",height:"1.2em"};function t1(g,n){return Le(),mt("svg",e1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M30 25H2v2h2v2h2v-2h5v2h2v-2h5v2h2v-2h5v2h2v-2h3zM8 16H2v-2h6v-2H2v-2h6a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2"},null,-1),Qe("path",{fill:"currentColor",d:"m28.55 14.23l-8.58-7.864A8.98 8.98 0 0 0 13.888 4H2v2h10v4a2 2 0 0 0 2 2h9.157l4.041 3.705A2.472 2.472 0 0 1 25.528 20H2v2h23.527a4.473 4.473 0 0 0 3.023-7.77M14 10V6.005a6.98 6.98 0 0 1 4.618 1.835L20.975 10Z"},null,-1)]))}const i1=Ti({name:"carbon-train-profile",render:t1}),r1={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function s1(g,n){return Le(),mt("svg",r1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M19 16.94V8.5c0-2.79-2.61-3.4-6-3.5l.75-1.5H17V2H7v1.5h4.75L11 5c-3.14.11-6 .73-6 3.5v8.44c0 1.45 1.19 2.66 2.59 2.97L6 21.5v.5h2.23l2-2H14l2 2h2v-.5L16.5 20h-.08c1.69 0 2.58-1.37 2.58-3.06m-7 1.56a1.5 1.5 0 0 1-1.5-1.5a1.5 1.5 0 0 1 1.5-1.5a1.5 1.5 0 0 1 1.5 1.5a1.5 1.5 0 0 1-1.5 1.5m5-4.5H7V9h10z"},null,-1)]))}const n1=Ti({name:"mdi-tram",render:s1}),o1={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function a1(g,n){return Le(),mt("svg",o1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M18 11H6V6h12m-1.5 11a1.5 1.5 0 0 1-1.5-1.5a1.5 1.5 0 0 1 1.5-1.5a1.5 1.5 0 0 1 1.5 1.5a1.5 1.5 0 0 1-1.5 1.5m-9 0A1.5 1.5 0 0 1 6 15.5A1.5 1.5 0 0 1 7.5 14A1.5 1.5 0 0 1 9 15.5A1.5 1.5 0 0 1 7.5 17M4 16c0 .88.39 1.67 1 2.22V20a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-1h8v1a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4z"},null,-1)]))}const l1=Ti({name:"mdi-bus",render:a1}),c1={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function h1(g,n){return Le(),mt("svg",c1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M13 14h-2V9h2m0 9h-2v-2h2M1 21h22L12 2z"},null,-1)]))}const u1=Ti({name:"mdi-alert",render:h1}),d1={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function p1(g,n){return Le(),mt("svg",d1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M8 5v14l11-7z"},null,-1)]))}const f1=Ti({name:"ic-baseline-play-arrow",render:p1}),m1={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function _1(g,n){return Le(),mt("svg",m1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"m21.41 10.59l-7.99-8c-.78-.78-2.05-.78-2.83 0l-8.01 8c-.78.78-.78 2.05 0 2.83l8.01 8c.78.78 2.05.78 2.83 0l7.99-8c.79-.79.79-2.05 0-2.83M13.5 14.5V12H10v3H8v-4c0-.55.45-1 1-1h4.5V7.5L17 11z"},null,-1)]))}const g1=Ti({name:"ic-baseline-directions",render:_1}),y1={key:0,class:"flex mt-2 overflow-x-auto"},x1={class:"inline-flex w-min gap-2 pb-4"},v1={key:2},Um=qs({__name:"Actions",props:{actions:{required:!0},actionsModifiers:{}},emits:["update:actions"],setup(g){const{t:n}=Go(),u=fm(g,"actions"),{checkFeatureFlag:_}=ny();return(x,k)=>{const S=g1,h=f1;return u.value.length>0&&st(_)("vehicle_stop_actions").value?(Le(),mt("div",y1,[Qe("div",x1,[(Le(!0),mt($s,null,Vo(u.value,N=>(Le(),Ft(Na,{key:N.url,href:N.url,rounded:"",class:"gap-2 flex-shrink-0 px-4 py-2"},{default:tr(()=>[N.type==="navigate-to"?(Le(),mt($s,{key:0},[Vi(S),Qe("span",null,hi(st(n)("navigate_to")),1)],64)):N.type==="rent"?(Le(),mt($s,{key:1},[Vi(h),Qe("span",null,hi(st(n)("rent_vehicle")),1)],64)):(Le(),mt("span",v1,hi(N.name),1))]),_:2},1032,["href"]))),128))])])):zi("",!0)}}}),b1={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function w1(g,n){return Le(),mt("svg",b1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M243 96a20.33 20.33 0 0 0-17.74-14l-56.59-4.57l-21.84-52.81a20.36 20.36 0 0 0-37.66 0L87.35 77.44L30.76 82a20.45 20.45 0 0 0-11.66 35.88l43.18 37.24l-13.2 55.7A20.37 20.37 0 0 0 79.57 233L128 203.19L176.43 233a20.39 20.39 0 0 0 30.49-22.15l-13.2-55.7l43.18-37.24A20.43 20.43 0 0 0 243 96m-70.47 45.7a12 12 0 0 0-3.84 11.86L181.58 208l-47.29-29.08a12 12 0 0 0-12.58 0L74.42 208l12.89-54.4a12 12 0 0 0-3.84-11.86l-42.27-36.5l55.4-4.47a12 12 0 0 0 10.13-7.38L128 41.89l21.27 51.5a12 12 0 0 0 10.13 7.38l55.4 4.47Z"},null,-1)]))}const S1=Ti({name:"ph-star-bold",render:w1}),I1={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function T1(g,n){return Le(),mt("svg",I1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M6 6h12v3.96L12 8L6 9.96M3.94 19H4c1.6 0 3-.88 4-2c1 1.12 2.4 2 4 2s3-.88 4-2c1 1.12 2.4 2 4 2h.05l1.9-6.69c.08-.25.05-.53-.06-.77c-.13-.24-.34-.42-.6-.5L20 10.62V6a2 2 0 0 0-2-2h-3V1H9v3H6a2 2 0 0 0-2 2v4.62l-1.29.42c-.26.08-.47.26-.6.5c-.11.24-.14.52-.06.77M20 21c-1.39 0-2.78-.47-4-1.33c-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.37 0 2.74-.35 4-1c2.5 1.3 5.5 1.3 8 0c1.26.65 2.62 1 4 1h2v-2z"},null,-1)]))}const Vm=Ti({name:"mdi-ferry",render:T1}),k1={viewBox:"0 0 1216 1312",width:"1.12em",height:"1.2em"};function E1(g,n){return Le(),mt("svg",k1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M1202 1066q0 40-28 68l-136 136q-28 28-68 28t-68-28L608 976l-294 294q-28 28-68 28t-68-28L42 1134q-28-28-28-68t28-68l294-294L42 410q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294l294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68L880 704l294 294q28 28 28 68"},null,-1)]))}const A1=Ti({name:"fa-close",render:E1}),P1={viewBox:"0 0 512 512",width:"1.2em",height:"1.2em"};function C1(g,n){return Le(),mt("svg",P1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M256 8C119.034 8 8 119.033 8 256s111.034 248 248 248s248-111.034 248-248S392.967 8 256 8m130.108 117.892c65.448 65.448 70 165.481 20.677 235.637L150.47 105.216c70.204-49.356 170.226-44.735 235.638 20.676M125.892 386.108c-65.448-65.448-70-165.481-20.677-235.637L361.53 406.784c-70.203 49.356-170.226 44.736-235.638-20.676"},null,-1)]))}const M1=Ti({name:"fa-solid-ban",render:C1}),z1={class:"flex flex-col items-center flex-grow"},D1={class:"flex flex-col items-center my-2 text-lg"},Oh=qs({__name:"NoData",setup(g){const{t:n}=Go();return(u,_)=>{const x=M1,k=A1;return Le(),mt("div",z1,[Vi(x,{class:"text-3xl mt-auto"}),Qe("div",D1,[lm(u.$slots,"default")]),Vi(Na,{class:"mt-auto mb-4",to:{name:"home"},replace:""},{default:tr(()=>[Vi(k,{class:"mr-2"}),Qe("span",null,hi(st(n)("close")),1)]),_:1})])}}}),L1={key:0,class:"flex flex-col min-h-0 flex-grow"},R1={class:"flex flex-row pb-2 mb-2 border-b-1 dark:border-dark-100 items-center"},O1={class:"text-lg ml-2"},F1={class:"flex flex-col flex-grow overflow-y-auto"},B1={key:0,class:"bg-red-300 dark:bg-red-800 bg-opacity-50 dark:bg-opacity-50 p-2 mb-2 rounded-md"},j1={class:"flex items-center border-b-1 border-gray-500 dark:border-gray-300 mb-2"},N1={class:"font-bold"},$1={class:"flex flex-row items-center"},U1={class:"mr-2"},V1={class:"flex-grow"},q1={class:"ml-2 flex items-center"},G1={class:"flex flex-row gap-1 text-gray-500 dark:text-gray-400 text-xs"},H1={class:"ml-auto"},Z1={class:"flex flex-row"},W1={class:"mr-2"},X1=qs({__name:"StopPopup",props:{marker:{}},setup(g){const n=g,{addFavorite:u,removeFavorite:_,isFavorite:x}=jm(),{t:k}=Go(),S=Uo(n,"marker"),{stop:h,unsubscribe:N}=Mn.useStop(_i(()=>n.marker.id)),q=J=>{if(J.eta===0)return null;const G=Math.round(J.eta/60);return J.state==="stopping"?k("stopping"):G<1?k("immediately"):k("minutes",{minutes:G})},ne=_i(()=>{var J;return(J=h.value)!=null&&J.arrivals?h.value.arrivals.toSorted((G,ve)=>G.eta===0||ve.eta===0?G.planned.localeCompare(ve.planned):G.eta-ve.eta).map(G=>({...G,nextStopName:void 0,eta:q(G)})):null});return um(async()=>{await N()}),(J,G)=>{const ve=Vm,Ee=Nd,$e=pm,_t=S1,Tt=Um,xt=u1,Ct=l1,Li=n1,Yt=i1,Vt=Qx,yt=Jx,ri=Zx,Bt=lc("router-link"),ji=$m,Lt=Nm;return st(h)?(Le(),mt("div",L1,[Qe("div",R1,[st(h).type==="ferry-stop"?(Le(),Ft(ve,{key:0})):(Le(),Ft(Ee,{key:1})),Qe("h1",O1,hi(st(h).name),1),st(x)(st(h))?(Le(),Ft(Na,{key:2,class:"text-yellow-300 ml-auto border-0",title:st(k)("remove_favorite"),onClick:G[0]||(G[0]=kt=>st(_)(st(h)))},{default:tr(()=>[Vi($e)]),_:1},8,["title"])):(Le(),Ft(Na,{key:3,class:"ml-auto border-0",title:st(k)("add_favorite"),onClick:G[1]||(G[1]=kt=>st(u)(st(h)))},{default:tr(()=>[Vi(_t)]),_:1},8,["title"]))]),Vi(Tt,{actions:st(h).actions??[]},null,8,["actions"]),Qe("div",F1,[st(h).alerts&&st(h).alerts.length>=1?(Le(),mt("div",B1,[Qe("div",j1,[Vi(xt,{class:"mr-2"}),Qe("span",N1,hi(st(k)("alerts")),1)]),Qe("ul",null,[(Le(!0),mt($s,null,Vo(st(h).alerts,(kt,pi)=>(Le(),mt("li",{key:pi,class:"items-center ml-5 list-outside list-disc"},hi(kt),1))),128))])])):zi("",!0),(Le(!0),mt($s,null,Vo(ne.value,kt=>(Le(),Ft(Bt,{key:kt.tripId,class:"flex flex-col py-2 w-full not-last:border-b-1 dark:border-dark-300",to:{name:"map-marker",params:{markerType:st(h).type.replace("-stop",""),markerId:kt.vehicleId}}},{default:tr(()=>[Qe("div",$1,[kt.type==="bus"?(Le(),Ft(Ct,{key:0,class:"mr-2 w-6 h-6"})):kt.type==="ferry"?(Le(),Ft(ve,{key:1,class:"mr-2"})):kt.type==="tram"?(Le(),Ft(Li,{key:2,class:"mr-2 w-6 h-6"})):kt.type==="train"?(Le(),Ft(Yt,{key:3,class:"mr-2"})):zi("",!0),Qe("span",U1,hi(kt.routeName),1),Qe("span",V1,hi(kt.direction),1),Qe("span",null,hi(kt.eta??kt.planned),1),Qe("div",q1,[kt.state==="planned"?(Le(),Ft(Vt,{key:0})):zi("",!0),kt.state==="stopping"?(Le(),Ft(yt,{key:1})):zi("",!0),kt.state==="predicted"?(Le(),Ft(ri,{key:2})):zi("",!0)])]),Qe("div",G1,[kt.nextStopName?(Le(),mt($s,{key:0},[Qe("span",null,hi(st(k)("next_stop")),1),Qe("span",null,hi(kt.nextStopName),1)],64)):zi("",!0),Qe("span",H1,hi(kt.platform),1)])]),_:2},1032,["to"]))),128)),(Le(!0),mt($s,null,Vo(st(h).vehicles,kt=>(Le(),Ft(Bt,{key:kt.id,class:"flex flex-col py-2 w-full not-last:border-b-1 dark:border-dark-300",to:{name:"map-marker",params:{markerType:kt.type,markerId:kt.id}}},{default:tr(()=>[Qe("div",Z1,[kt.type==="bike"?(Le(),Ft(ji,{key:0,class:"mr-2"})):kt.type==="ferry"?(Le(),Ft(ve,{key:1,class:"mr-2"})):zi("",!0),Qe("span",W1,hi(kt.name),1)])]),_:2},1032,["to"]))),128)),ne.value&&ne.value.length===0?(Le(),Ft(Oh,{key:1},{default:tr(()=>[Ah(hi(st(k)("no_bus_wants_to_stop_here_right_now")),1)]),_:1})):zi("",!0),ne.value===null&&st(h).vehicles===null?(Le(),Ft(Lt,{key:2,class:"m-auto text-3xl animate-spin"})):zi("",!0)])])):(Le(),Ft(Oh,{key:1},{default:tr(()=>[Ah(hi(st(k)("this_stop_probably_does_not_exist"))+" ",1),st(x)(S.value)?(Le(),Ft(Na,{key:0,class:"mt-2",onClick:G[2]||(G[2]=()=>{st(_)(S.value),J.$router.replace({name:"home"})})},{default:tr(()=>[Vi($e,{class:"mr-2 text-yellow-300"}),Qe("span",null,hi(st(k)("remove_favorite")),1)]),_:1})):zi("",!0)]),_:1}))}}}),J1={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function K1(g,n){return Le(),mt("svg",J1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M19 5c0-1.1-.9-2-2-2h-3v2h3v2.65L13.52 12H10V7H6c-2.21 0-4 1.79-4 4v3h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4.48L19 8.35zM7 15c-.55 0-1-.45-1-1h2c0 .55-.45 1-1 1"},null,-1),Qe("path",{fill:"currentColor",d:"M5 4h5v2H5zm14 7c-1.66 0-3 1.34-3 3s1.34 3 3 3s3-1.34 3-3s-1.34-3-3-3m0 4c-.55 0-1-.45-1-1s.45-1 1-1s1 .45 1 1s-.45 1-1 1M7 20h4v-2l6 3h-4v2z"},null,-1)]))}const Y1=Ti({name:"ic-baseline-electric-moped",render:K1}),Q1={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function ev(g,n){return Le(),mt("svg",Q1,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M19 7c0-1.1-.9-2-2-2h-3v2h3v2.65L13.52 14H10V9H6c-2.21 0-4 1.79-4 4v3h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4.48L19 10.35zM7 17c-.55 0-1-.45-1-1h2c0 .55-.45 1-1 1"},null,-1),Qe("path",{fill:"currentColor",d:"M5 6h5v2H5zm14 7c-1.66 0-3 1.34-3 3s1.34 3 3 3s3-1.34 3-3s-1.34-3-3-3m0 4c-.55 0-1-.45-1-1s.45-1 1-1s1 .45 1 1s-.45 1-1 1"},null,-1)]))}const tv=Ti({name:"ic-baseline-moped",render:ev}),iv={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function rv(g,n){return Le(),mt("svg",iv,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M19 16.94V8.5c0-2.79-2.61-3.4-6.01-3.49l.76-1.51H17V2H7v1.5h4.75l-.76 1.52C7.86 5.11 5 5.73 5 8.5v8.44c0 1.45 1.19 2.66 2.59 2.97L6 21.5v.5h2.23l2-2H14l2 2h2v-.5L16.5 20h-.08c1.69 0 2.58-1.37 2.58-3.06m-7 1.56c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5s1.5.67 1.5 1.5s-.67 1.5-1.5 1.5m5-4.5H7V9h10z"},null,-1)]))}const sv=Ti({name:"ic-baseline-tram",render:rv}),nv={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function ov(g,n){return Le(),mt("svg",nv,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M17.8 2.8C16 2.09 13.86 2 12 2s-4 .09-5.8.8C3.53 3.84 2 6.05 2 8.86V22h20V8.86c0-2.81-1.53-5.02-4.2-6.06M9.17 20l1.5-1.5h2.66l1.5 1.5zm-2.16-6V9h10v5zm9.49 2c0 .55-.45 1-1 1s-1-.45-1-1s.45-1 1-1s1 .45 1 1m-8-1c.55 0 1 .45 1 1s-.45 1-1 1s-1-.45-1-1s.45-1 1-1M20 20h-3.5v-.38l-1.15-1.16A2.98 2.98 0 0 0 18 15.5V9c0-2.63-3-3-6-3s-6 .37-6 3v6.5c0 1.54 1.16 2.79 2.65 2.96L7.5 19.62V20H4V8.86c0-2 1.01-3.45 2.93-4.2C8.41 4.08 10.32 4 12 4s3.59.08 5.07.66c1.92.75 2.93 2.2 2.93 4.2z"},null,-1)]))}const av=Ti({name:"ic-outline-subway",render:ov}),lv={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function cv(g,n){return Le(),mt("svg",lv,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M12 2c-4 0-8 .5-8 4v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2.23l2-2H14l2 2h2v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-3.58-4-8-4M7.5 17c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17m3.5-7H6V6h5zm2 0V6h5v4zm3.5 7c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5s1.5.67 1.5 1.5s-.67 1.5-1.5 1.5"},null,-1)]))}const hv=Ti({name:"ic-baseline-train",render:cv}),uv={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function dv(g,n){return Le(),mt("svg",uv,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M7.82 16H15v-1c0-2.21 1.79-4 4-4h.74l-1.9-8.44A2.01 2.01 0 0 0 15.89 1H12v2h3.89l1.4 6.25h-.01A6.01 6.01 0 0 0 13.09 14H7.82a2.996 2.996 0 0 0-3.42-1.94c-1.18.23-2.13 1.2-2.35 2.38A3.002 3.002 0 0 0 5 18c1.3 0 2.4-.84 2.82-2M5 16c-.55 0-1-.45-1-1s.45-1 1-1s1 .45 1 1s-.45 1-1 1"},null,-1),Qe("path",{fill:"currentColor",d:"M19 12c-1.66 0-3 1.34-3 3s1.34 3 3 3s3-1.34 3-3s-1.34-3-3-3m0 4c-.55 0-1-.45-1-1s.45-1 1-1s1 .45 1 1s-.45 1-1 1m-8 4H7l6 3v-2h4l-6-3z"},null,-1)]))}const pv=Ti({name:"ic-twotone-electric-scooter",render:dv}),fv={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function mv(g,n){return Le(),mt("svg",fv,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16m11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5s1.5.67 1.5 1.5s-.67 1.5-1.5 1.5M5 11l1.5-4.5h11L19 11z"},null,-1)]))}const _v=Ti({name:"ic-baseline-directions-car",render:mv}),gv={viewBox:"0 0 1536 1792",width:"1.04em",height:"1.2em"};function yv(g,n){return Le(),mt("svg",gv,n[0]||(n[0]=[Qe("path",{fill:"currentColor",d:"M384 1216q0-53-37.5-90.5T256 1088t-90.5 37.5T128 1216t37.5 90.5T256 1344t90.5-37.5T384 1216m1024 0q0-53-37.5-90.5T1280 1088t-90.5 37.5t-37.5 90.5t37.5 90.5t90.5 37.5t90.5-37.5t37.5-90.5m-46-396l-72-384q-5-23-22.5-37.5T1227 384H309q-23 0-40.5 14.5T246 436l-72 384q-5 30 14 53t49 23h1062q30 0 49-23t14-53m-226-612q0-20-14-34t-34-14H448q-20 0-34 14t-14 34t14 34t34 14h640q20 0 34-14t14-34m400 725v603h-128v128q0 53-37.5 90.5T1280 1792t-90.5-37.5t-37.5-90.5v-128H384v128q0 53-37.5 90.5T256 1792t-90.5-37.5T128 1664v-128H0V933q0-112 25-223l103-454q9-78 97.5-137t230-89T768 0t312.5 30t230 89t97.5 137l105 454q23 102 23 223"},null,-1)]))}const xv=Ti({name:"fa-bus",render:yv}),vv={key:0,class:"flex flex-col min-h-0 flex-grow"},bv={class:"border-b-1 dark:border-dark-100 mb-2"},wv={class:"flex pb-2 space-x-2 items-center"},Sv={class:"text-lg"},Iv={key:0,class:"overflow-y-auto"},Tv={class:"w-14 min-w-12"},kv={key:1,class:"rounded-full h-4 w-4 flex items-center justify-center bg-gray-800 dark:bg-gray-300"},Ev={class:"w-full"},Av=["innerHTML"],Pv=qs({__name:"VehiclePopup",props:{marker:{}},setup(g){const n=g,{t:u}=Go(),_=Uo(n,"marker"),{vehicle:x,unsubscribe:k}=Mn.useVehicle(_i(()=>_.value.id)),{trip:S,unsubscribe:h}=Mn.useTrip(_i(()=>{var q;return(q=x.value)==null?void 0:q.tripId})),N=_i(()=>{var q;return(q=x.value)!=null&&q.description?ey(x.value.description.trim()):null});return ty(async()=>{await k(),await h()}),(q,ne)=>{var Vt;const J=xv,G=$m,ve=_v,Ee=pv,$e=hv,_t=av,Tt=sv,xt=tv,Ct=Y1,Li=lc("router-link"),Yt=Nm;return st(x)?(Le(),mt("div",vv,[Qe("header",bv,[Qe("div",wv,[st(x).type==="bus"?(Le(),Ft(J,{key:0})):st(x).type==="bike"?(Le(),Ft(G,{key:1})):st(x).type==="car"?(Le(),Ft(ve,{key:2})):st(x).type==="e-scooter"?(Le(),Ft(Ee,{key:3})):st(x).type==="ferry"?(Le(),Ft(Ee,{key:4})):st(x).type==="train"?(Le(),Ft($e,{key:5})):st(x).type==="subway"?(Le(),Ft(_t,{key:6})):st(x).type==="tram"?(Le(),Ft(Tt,{key:7})):st(x).type==="moped"?(Le(),Ft(xt,{key:8})):st(x).type==="e-moped"?(Le(),Ft(Ct,{key:9})):zi("",!0),Qe("h1",Sv,hi(st(x).name),1)]),Vi(Um,{actions:st(x).actions??[]},null,8,["actions"])]),st(S)?(Le(),mt($s,{key:0},[(Vt=st(S).arrivals)!=null&&Vt.length?(Le(),mt("div",Iv,[(Le(!0),mt($s,null,Vo(st(S).arrivals,(yt,ri)=>(Le(),Ft(Li,{key:yt.id,to:{name:"map-marker",params:{markerType:`${st(x).type}-stop`,markerId:yt.id}},class:Ih(["flex w-full items-center",{"text-gray-500 dark:text-gray-400":yt.state==="departed","mt-6":ri===0&&yt.state==="predicted"}])},{default:tr(()=>{var Bt;return[Qe("span",Tv,hi(yt.planned),1),Qe("div",{class:Ih(["marker relative flex justify-center items-center mx-4 h-12 w-8 min-w-4 after:absolute after:top-0 after:h-full after:bg-gray-800 after:dark:bg-gray-300",{"after:bg-gray-500 after:dark:bg-gray-400":yt.state==="departed"}])},[yt.state!=="departed"&&(st(S).arrivals[ri-1]===void 0||st(S).arrivals[ri-1].state==="departed")?(Le(),mt("div",{key:0,class:Ih(["vehicle before:h-4 before:w-4 before:bg-red-700 before:rounded-full",{driving:yt.state==="predicted"}])},ne[0]||(ne[0]=[Qe("div",{class:"pulsating border-3 border-red-700 border-solid rounded-full"},null,-1)]),2)):zi("",!0),yt.state!=="departed"&&((Bt=st(S).arrivals[ri-1])==null?void 0:Bt.state)!=="departed"||yt.state==="predicted"?(Le(),mt("div",kv)):zi("",!0)],2),Qe("span",Ev,hi(yt.name),1)]}),_:2},1032,["to","class"]))),128))])):(Le(),Ft(Oh,{key:1},{default:tr(()=>[Ah(hi(st(u)("trip_expired")),1)]),_:1}))],64)):st(x).tripId!==""?(Le(),Ft(Yt,{key:1,class:"mx-auto mt-4 text-3xl animate-spin"})):zi("",!0),N.value?(Le(),mt("span",{key:2,class:"prose",innerHTML:N.value},null,8,Av)):zi("",!0)])):(Le(),Ft(Oh,{key:1},{default:tr(()=>[Ah(hi(st(u)("trip_does_not_exist")),1)]),_:1}))}}}),Cv=Cd(Pv,[["__scopeId","data-v-8a4d75f0"]]),Mv=qs({__name:"MarkerPopup",props:{marker:{}},setup(g){return(n,u)=>n.marker.type.endsWith("-stop")?(Le(),Ft(X1,{key:0,marker:n.marker},null,8,["marker"])):(Le(),Ft(Cv,{key:1,marker:n.marker},null,8,["marker"]))}});function Ln(g){return Array.isArray?Array.isArray(g):Hm(g)==="[object Array]"}const zv=1/0;function Dv(g){if(typeof g=="string")return g;let n=g+"";return n=="0"&&1/g==-zv?"-0":n}function Lv(g){return g==null?"":Dv(g)}function sn(g){return typeof g=="string"}function qm(g){return typeof g=="number"}function Rv(g){return g===!0||g===!1||Ov(g)&&Hm(g)=="[object Boolean]"}function Gm(g){return typeof g=="object"}function Ov(g){return Gm(g)&&g!==null}function ys(g){return g!=null}function ud(g){return!g.trim().length}function Hm(g){return g==null?g===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(g)}const Fv="Incorrect 'index' type",Bv=g=>`Invalid value for key ${g}`,jv=g=>`Pattern length exceeds max of ${g}.`,Nv=g=>`Missing ${g} property in key`,$v=g=>`Property 'weight' in key '${g}' must be a positive integer`,rm=Object.prototype.hasOwnProperty;class Uv{constructor(n){this._keys=[],this._keyMap={};let u=0;n.forEach(_=>{let x=Zm(_);this._keys.push(x),this._keyMap[x.id]=x,u+=x.weight}),this._keys.forEach(_=>{_.weight/=u})}get(n){return this._keyMap[n]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function Zm(g){let n=null,u=null,_=null,x=1,k=null;if(sn(g)||Ln(g))_=g,n=sm(g),u=Id(g);else{if(!rm.call(g,"name"))throw new Error(Nv("name"));const S=g.name;if(_=S,rm.call(g,"weight")&&(x=g.weight,x<=0))throw new Error($v(S));n=sm(S),u=Id(S),k=g.getFn}return{path:n,id:u,weight:x,src:_,getFn:k}}function sm(g){return Ln(g)?g:g.split(".")}function Id(g){return Ln(g)?g.join("."):g}function Vv(g,n){let u=[],_=!1;const x=(k,S,h)=>{if(ys(k))if(!S[h])u.push(k);else{let N=S[h];const q=k[N];if(!ys(q))return;if(h===S.length-1&&(sn(q)||qm(q)||Rv(q)))u.push(Lv(q));else if(Ln(q)){_=!0;for(let ne=0,J=q.length;ne<J;ne+=1)x(q[ne],S,h+1)}else S.length&&x(q,S,h+1)}};return x(g,sn(n)?n.split("."):n,0),_?u:u[0]}const qv={includeMatches:!1,findAllMatches:!1,minMatchCharLength:1},Gv={isCaseSensitive:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(g,n)=>g.score===n.score?g.idx<n.idx?-1:1:g.score<n.score?-1:1},Hv={location:0,threshold:.6,distance:100},Zv={useExtendedSearch:!1,getFn:Vv,ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1};var Dt={...Gv,...qv,...Hv,...Zv};const Wv=/[^ ]+/g;function Xv(g=1,n=3){const u=new Map,_=Math.pow(10,n);return{get(x){const k=x.match(Wv).length;if(u.has(k))return u.get(k);const S=1/Math.pow(k,.5*g),h=parseFloat(Math.round(S*_)/_);return u.set(k,h),h},clear(){u.clear()}}}class Ud{constructor({getFn:n=Dt.getFn,fieldNormWeight:u=Dt.fieldNormWeight}={}){this.norm=Xv(u,3),this.getFn=n,this.isCreated=!1,this.setIndexRecords()}setSources(n=[]){this.docs=n}setIndexRecords(n=[]){this.records=n}setKeys(n=[]){this.keys=n,this._keysMap={},n.forEach((u,_)=>{this._keysMap[u.id]=_})}create(){this.isCreated||!this.docs.length||(this.isCreated=!0,sn(this.docs[0])?this.docs.forEach((n,u)=>{this._addString(n,u)}):this.docs.forEach((n,u)=>{this._addObject(n,u)}),this.norm.clear())}add(n){const u=this.size();sn(n)?this._addString(n,u):this._addObject(n,u)}removeAt(n){this.records.splice(n,1);for(let u=n,_=this.size();u<_;u+=1)this.records[u].i-=1}getValueForItemAtKeyId(n,u){return n[this._keysMap[u]]}size(){return this.records.length}_addString(n,u){if(!ys(n)||ud(n))return;let _={v:n,i:u,n:this.norm.get(n)};this.records.push(_)}_addObject(n,u){let _={i:u,$:{}};this.keys.forEach((x,k)=>{let S=x.getFn?x.getFn(n):this.getFn(n,x.path);if(ys(S)){if(Ln(S)){let h=[];const N=[{nestedArrIndex:-1,value:S}];for(;N.length;){const{nestedArrIndex:q,value:ne}=N.pop();if(ys(ne))if(sn(ne)&&!ud(ne)){let J={v:ne,i:q,n:this.norm.get(ne)};h.push(J)}else Ln(ne)&&ne.forEach((J,G)=>{N.push({nestedArrIndex:G,value:J})})}_.$[k]=h}else if(sn(S)&&!ud(S)){let h={v:S,n:this.norm.get(S)};_.$[k]=h}}}),this.records.push(_)}toJSON(){return{keys:this.keys,records:this.records}}}function Wm(g,n,{getFn:u=Dt.getFn,fieldNormWeight:_=Dt.fieldNormWeight}={}){const x=new Ud({getFn:u,fieldNormWeight:_});return x.setKeys(g.map(Zm)),x.setSources(n),x.create(),x}function Jv(g,{getFn:n=Dt.getFn,fieldNormWeight:u=Dt.fieldNormWeight}={}){const{keys:_,records:x}=g,k=new Ud({getFn:n,fieldNormWeight:u});return k.setKeys(_),k.setIndexRecords(x),k}function Sh(g,{errors:n=0,currentLocation:u=0,expectedLocation:_=0,distance:x=Dt.distance,ignoreLocation:k=Dt.ignoreLocation}={}){const S=n/g.length;if(k)return S;const h=Math.abs(_-u);return x?S+h/x:h?1:S}function Kv(g=[],n=Dt.minMatchCharLength){let u=[],_=-1,x=-1,k=0;for(let S=g.length;k<S;k+=1){let h=g[k];h&&_===-1?_=k:!h&&_!==-1&&(x=k-1,x-_+1>=n&&u.push([_,x]),_=-1)}return g[k-1]&&k-_>=n&&u.push([_,k-1]),u}const $o=32;function Yv(g,n,u,{location:_=Dt.location,distance:x=Dt.distance,threshold:k=Dt.threshold,findAllMatches:S=Dt.findAllMatches,minMatchCharLength:h=Dt.minMatchCharLength,includeMatches:N=Dt.includeMatches,ignoreLocation:q=Dt.ignoreLocation}={}){if(n.length>$o)throw new Error(jv($o));const ne=n.length,J=g.length,G=Math.max(0,Math.min(_,J));let ve=k,Ee=G;const $e=h>1||N,_t=$e?Array(J):[];let Tt;for(;(Tt=g.indexOf(n,Ee))>-1;){let yt=Sh(n,{currentLocation:Tt,expectedLocation:G,distance:x,ignoreLocation:q});if(ve=Math.min(yt,ve),Ee=Tt+ne,$e){let ri=0;for(;ri<ne;)_t[Tt+ri]=1,ri+=1}}Ee=-1;let xt=[],Ct=1,Li=ne+J;const Yt=1<<ne-1;for(let yt=0;yt<ne;yt+=1){let ri=0,Bt=Li;for(;ri<Bt;)Sh(n,{errors:yt,currentLocation:G+Bt,expectedLocation:G,distance:x,ignoreLocation:q})<=ve?ri=Bt:Li=Bt,Bt=Math.floor((Li-ri)/2+ri);Li=Bt;let ji=Math.max(1,G-Bt+1),Lt=S?J:Math.min(G+Bt,J)+ne,kt=Array(Lt+2);kt[Lt+1]=(1<<yt)-1;for(let De=Lt;De>=ji;De-=1){let Ut=De-1,ni=u[g.charAt(Ut)];if($e&&(_t[Ut]=+!!ni),kt[De]=(kt[De+1]<<1|1)&ni,yt&&(kt[De]|=(xt[De+1]|xt[De])<<1|1|xt[De+1]),kt[De]&Yt&&(Ct=Sh(n,{errors:yt,currentLocation:Ut,expectedLocation:G,distance:x,ignoreLocation:q}),Ct<=ve)){if(ve=Ct,Ee=Ut,Ee<=G)break;ji=Math.max(1,2*G-Ee)}}if(Sh(n,{errors:yt+1,currentLocation:G,expectedLocation:G,distance:x,ignoreLocation:q})>ve)break;xt=kt}const Vt={isMatch:Ee>=0,score:Math.max(.001,Ct)};if($e){const yt=Kv(_t,h);yt.length?N&&(Vt.indices=yt):Vt.isMatch=!1}return Vt}function Qv(g){let n={};for(let u=0,_=g.length;u<_;u+=1){const x=g.charAt(u);n[x]=(n[x]||0)|1<<_-u-1}return n}class Xm{constructor(n,{location:u=Dt.location,threshold:_=Dt.threshold,distance:x=Dt.distance,includeMatches:k=Dt.includeMatches,findAllMatches:S=Dt.findAllMatches,minMatchCharLength:h=Dt.minMatchCharLength,isCaseSensitive:N=Dt.isCaseSensitive,ignoreLocation:q=Dt.ignoreLocation}={}){if(this.options={location:u,threshold:_,distance:x,includeMatches:k,findAllMatches:S,minMatchCharLength:h,isCaseSensitive:N,ignoreLocation:q},this.pattern=N?n:n.toLowerCase(),this.chunks=[],!this.pattern.length)return;const ne=(G,ve)=>{this.chunks.push({pattern:G,alphabet:Qv(G),startIndex:ve})},J=this.pattern.length;if(J>$o){let G=0;const ve=J%$o,Ee=J-ve;for(;G<Ee;)ne(this.pattern.substr(G,$o),G),G+=$o;if(ve){const $e=J-$o;ne(this.pattern.substr($e),$e)}}else ne(this.pattern,0)}searchIn(n){const{isCaseSensitive:u,includeMatches:_}=this.options;if(u||(n=n.toLowerCase()),this.pattern===n){let Ee={isMatch:!0,score:0};return _&&(Ee.indices=[[0,n.length-1]]),Ee}const{location:x,distance:k,threshold:S,findAllMatches:h,minMatchCharLength:N,ignoreLocation:q}=this.options;let ne=[],J=0,G=!1;this.chunks.forEach(({pattern:Ee,alphabet:$e,startIndex:_t})=>{const{isMatch:Tt,score:xt,indices:Ct}=Yv(n,Ee,$e,{location:x+_t,distance:k,threshold:S,findAllMatches:h,minMatchCharLength:N,includeMatches:_,ignoreLocation:q});Tt&&(G=!0),J+=xt,Tt&&Ct&&(ne=[...ne,...Ct])});let ve={isMatch:G,score:G?J/this.chunks.length:1};return G&&_&&(ve.indices=ne),ve}}class ao{constructor(n){this.pattern=n}static isMultiMatch(n){return nm(n,this.multiRegex)}static isSingleMatch(n){return nm(n,this.singleRegex)}search(){}}function nm(g,n){const u=g.match(n);return u?u[1]:null}class eb extends ao{constructor(n){super(n)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(n){const u=n===this.pattern;return{isMatch:u,score:u?0:1,indices:[0,this.pattern.length-1]}}}class tb extends ao{constructor(n){super(n)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(n){const _=n.indexOf(this.pattern)===-1;return{isMatch:_,score:_?0:1,indices:[0,n.length-1]}}}class ib extends ao{constructor(n){super(n)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(n){const u=n.startsWith(this.pattern);return{isMatch:u,score:u?0:1,indices:[0,this.pattern.length-1]}}}class rb extends ao{constructor(n){super(n)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(n){const u=!n.startsWith(this.pattern);return{isMatch:u,score:u?0:1,indices:[0,n.length-1]}}}class sb extends ao{constructor(n){super(n)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(n){const u=n.endsWith(this.pattern);return{isMatch:u,score:u?0:1,indices:[n.length-this.pattern.length,n.length-1]}}}class nb extends ao{constructor(n){super(n)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(n){const u=!n.endsWith(this.pattern);return{isMatch:u,score:u?0:1,indices:[0,n.length-1]}}}class Jm extends ao{constructor(n,{location:u=Dt.location,threshold:_=Dt.threshold,distance:x=Dt.distance,includeMatches:k=Dt.includeMatches,findAllMatches:S=Dt.findAllMatches,minMatchCharLength:h=Dt.minMatchCharLength,isCaseSensitive:N=Dt.isCaseSensitive,ignoreLocation:q=Dt.ignoreLocation}={}){super(n),this._bitapSearch=new Xm(n,{location:u,threshold:_,distance:x,includeMatches:k,findAllMatches:S,minMatchCharLength:h,isCaseSensitive:N,ignoreLocation:q})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(n){return this._bitapSearch.searchIn(n)}}class Km extends ao{constructor(n){super(n)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(n){let u=0,_;const x=[],k=this.pattern.length;for(;(_=n.indexOf(this.pattern,u))>-1;)u=_+k,x.push([_,u-1]);const S=!!x.length;return{isMatch:S,score:S?0:1,indices:x}}}const Td=[eb,Km,ib,rb,nb,sb,tb,Jm],om=Td.length,ob=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/,ab="|";function lb(g,n={}){return g.split(ab).map(u=>{let _=u.trim().split(ob).filter(k=>k&&!!k.trim()),x=[];for(let k=0,S=_.length;k<S;k+=1){const h=_[k];let N=!1,q=-1;for(;!N&&++q<om;){const ne=Td[q];let J=ne.isMultiMatch(h);J&&(x.push(new ne(J,n)),N=!0)}if(!N)for(q=-1;++q<om;){const ne=Td[q];let J=ne.isSingleMatch(h);if(J){x.push(new ne(J,n));break}}}return x})}const cb=new Set([Jm.type,Km.type]);class hb{constructor(n,{isCaseSensitive:u=Dt.isCaseSensitive,includeMatches:_=Dt.includeMatches,minMatchCharLength:x=Dt.minMatchCharLength,ignoreLocation:k=Dt.ignoreLocation,findAllMatches:S=Dt.findAllMatches,location:h=Dt.location,threshold:N=Dt.threshold,distance:q=Dt.distance}={}){this.query=null,this.options={isCaseSensitive:u,includeMatches:_,minMatchCharLength:x,findAllMatches:S,ignoreLocation:k,location:h,threshold:N,distance:q},this.pattern=u?n:n.toLowerCase(),this.query=lb(this.pattern,this.options)}static condition(n,u){return u.useExtendedSearch}searchIn(n){const u=this.query;if(!u)return{isMatch:!1,score:1};const{includeMatches:_,isCaseSensitive:x}=this.options;n=x?n:n.toLowerCase();let k=0,S=[],h=0;for(let N=0,q=u.length;N<q;N+=1){const ne=u[N];S.length=0,k=0;for(let J=0,G=ne.length;J<G;J+=1){const ve=ne[J],{isMatch:Ee,indices:$e,score:_t}=ve.search(n);if(Ee){if(k+=1,h+=_t,_){const Tt=ve.constructor.type;cb.has(Tt)?S=[...S,...$e]:S.push($e)}}else{h=0,k=0,S.length=0;break}}if(k){let J={isMatch:!0,score:h/k};return _&&(J.indices=S),J}}return{isMatch:!1,score:1}}}const kd=[];function ub(...g){kd.push(...g)}function Ed(g,n){for(let u=0,_=kd.length;u<_;u+=1){let x=kd[u];if(x.condition(g,n))return new x(g,n)}return new Xm(g,n)}const Fh={AND:"$and",OR:"$or"},Ad={PATH:"$path",PATTERN:"$val"},Pd=g=>!!(g[Fh.AND]||g[Fh.OR]),db=g=>!!g[Ad.PATH],pb=g=>!Ln(g)&&Gm(g)&&!Pd(g),am=g=>({[Fh.AND]:Object.keys(g).map(n=>({[n]:g[n]}))});function Ym(g,n,{auto:u=!0}={}){const _=x=>{let k=Object.keys(x);const S=db(x);if(!S&&k.length>1&&!Pd(x))return _(am(x));if(pb(x)){const N=S?x[Ad.PATH]:k[0],q=S?x[Ad.PATTERN]:x[N];if(!sn(q))throw new Error(Bv(N));const ne={keyId:Id(N),pattern:q};return u&&(ne.searcher=Ed(q,n)),ne}let h={children:[],operator:k[0]};return k.forEach(N=>{const q=x[N];Ln(q)&&q.forEach(ne=>{h.children.push(_(ne))})}),h};return Pd(g)||(g=am(g)),_(g)}function fb(g,{ignoreFieldNorm:n=Dt.ignoreFieldNorm}){g.forEach(u=>{let _=1;u.matches.forEach(({key:x,norm:k,score:S})=>{const h=x?x.weight:null;_*=Math.pow(S===0&&h?Number.EPSILON:S,(h||1)*(n?1:k))}),u.score=_})}function mb(g,n){const u=g.matches;n.matches=[],ys(u)&&u.forEach(_=>{if(!ys(_.indices)||!_.indices.length)return;const{indices:x,value:k}=_;let S={indices:x,value:k};_.key&&(S.key=_.key.src),_.idx>-1&&(S.refIndex=_.idx),n.matches.push(S)})}function _b(g,n){n.score=g.score}function gb(g,n,{includeMatches:u=Dt.includeMatches,includeScore:_=Dt.includeScore}={}){const x=[];return u&&x.push(mb),_&&x.push(_b),g.map(k=>{const{idx:S}=k,h={item:n[S],refIndex:S};return x.length&&x.forEach(N=>{N(k,h)}),h})}class Xa{constructor(n,u={},_){this.options={...Dt,...u},this.options.useExtendedSearch,this._keyStore=new Uv(this.options.keys),this.setCollection(n,_)}setCollection(n,u){if(this._docs=n,u&&!(u instanceof Ud))throw new Error(Fv);this._myIndex=u||Wm(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(n){ys(n)&&(this._docs.push(n),this._myIndex.add(n))}remove(n=()=>!1){const u=[];for(let _=0,x=this._docs.length;_<x;_+=1){const k=this._docs[_];n(k,_)&&(this.removeAt(_),_-=1,x-=1,u.push(k))}return u}removeAt(n){this._docs.splice(n,1),this._myIndex.removeAt(n)}getIndex(){return this._myIndex}search(n,{limit:u=-1}={}){const{includeMatches:_,includeScore:x,shouldSort:k,sortFn:S,ignoreFieldNorm:h}=this.options;let N=sn(n)?sn(this._docs[0])?this._searchStringList(n):this._searchObjectList(n):this._searchLogical(n);return fb(N,{ignoreFieldNorm:h}),k&&N.sort(S),qm(u)&&u>-1&&(N=N.slice(0,u)),gb(N,this._docs,{includeMatches:_,includeScore:x})}_searchStringList(n){const u=Ed(n,this.options),{records:_}=this._myIndex,x=[];return _.forEach(({v:k,i:S,n:h})=>{if(!ys(k))return;const{isMatch:N,score:q,indices:ne}=u.searchIn(k);N&&x.push({item:k,idx:S,matches:[{score:q,value:k,norm:h,indices:ne}]})}),x}_searchLogical(n){const u=Ym(n,this.options),_=(h,N,q)=>{if(!h.children){const{keyId:J,searcher:G}=h,ve=this._findMatches({key:this._keyStore.get(J),value:this._myIndex.getValueForItemAtKeyId(N,J),searcher:G});return ve&&ve.length?[{idx:q,item:N,matches:ve}]:[]}const ne=[];for(let J=0,G=h.children.length;J<G;J+=1){const ve=h.children[J],Ee=_(ve,N,q);if(Ee.length)ne.push(...Ee);else if(h.operator===Fh.AND)return[]}return ne},x=this._myIndex.records,k={},S=[];return x.forEach(({$:h,i:N})=>{if(ys(h)){let q=_(u,h,N);q.length&&(k[N]||(k[N]={idx:N,item:h,matches:[]},S.push(k[N])),q.forEach(({matches:ne})=>{k[N].matches.push(...ne)}))}}),S}_searchObjectList(n){const u=Ed(n,this.options),{keys:_,records:x}=this._myIndex,k=[];return x.forEach(({$:S,i:h})=>{if(!ys(S))return;let N=[];_.forEach((q,ne)=>{N.push(...this._findMatches({key:q,value:S[ne],searcher:u}))}),N.length&&k.push({idx:h,item:S,matches:N})}),k}_findMatches({key:n,value:u,searcher:_}){if(!ys(u))return[];let x=[];if(Ln(u))u.forEach(({v:k,i:S,n:h})=>{if(!ys(k))return;const{isMatch:N,score:q,indices:ne}=_.searchIn(k);N&&x.push({score:q,key:n,value:k,idx:S,norm:h,indices:ne})});else{const{v:k,n:S}=u,{isMatch:h,score:N,indices:q}=_.searchIn(k);h&&x.push({score:N,key:n,value:k,norm:S,indices:q})}return x}}Xa.version="7.0.0";Xa.createIndex=Wm;Xa.parseIndex=Jv;Xa.config=Dt;Xa.parseQuery=Ym;ub(hb);const yb={class:"flex flex-col min-h-0 flex-grow"},xb={class:"flex pb-2 mb-2 border-b-1 dark:border-dark-100 space-x-2 items-center"},vb={class:"text-lg"},bb={key:0,class:"m-auto max-w-52 text-center text-xl"},wb={key:1,class:"m-auto max-w-52 text-center text-xl"},Sb={class:"flex flex-col overflow-y-auto"},Ib={class:""},Tb=qs({__name:"SearchPopup",props:{searchInput:{default:""},searchInputModifiers:{}},emits:["update:searchInput"],setup(g){const n=fm(g,"searchInput"),{t:u}=Go(),_=Gi({east:0,west:0,north:0,south:0}),{stops:x}=Mn.useStops(_),k=_i(()=>[...Object.values(x.value)]),S=_i(()=>new Xa(k.value,{includeScore:!0,keys:["name"],threshold:.4})),h=_i(()=>n.value===""||n.value.length<3?[]:S.value.search(n.value).slice(0,20));return(N,q)=>{const ne=iy,J=Nd,G=Vm,ve=lc("router-link");return Le(),mt("div",yb,[Qe("div",xb,[Vi(ne),Qe("h1",vb,hi(st(u)("search_result")),1)]),h.value.length===0&&n.value.length<3?(Le(),mt("div",bb,[Qe("p",null,hi(st(u)("search_stop_vehicle")),1)])):h.value.length===0&&n.value.length>=3?(Le(),mt("div",wb,[Qe("p",null,hi(st(u)("no_entry")),1)])):zi("",!0),Qe("div",Sb,[(Le(!0),mt($s,null,Vo(h.value,Ee=>(Le(),Ft(ve,{key:Ee.refIndex,to:{name:"map-marker",params:{markerType:Ee.item.type,markerId:Ee.item.id}},class:"flex py-2 not-last:border-b-1 dark:border-dark-300 max-w-full",onClick:q[0]||(q[0]=$e=>n.value="")},{default:tr(()=>[Ee.item.type==="bus-stop"?(Le(),Ft(J,{key:0,class:"mr-2"})):Ee.item.type==="ferry-stop"?(Le(),Ft(G,{key:1,class:"mr-2"})):zi("",!0),Qe("div",Ib,hi(Ee.item.name),1)]),_:2},1032,["to"]))),128))])])}}}),kb={class:"relative h-full w-full items-center justify-center overflow-hidden"},Db=qs({__name:"Home",setup(g){const{liteMode:n}=dm(),u=cm(),_=hm(),x=_i({get(){if(u.name==="map-marker")return{type:u.params.markerType,id:u.params.markerId}},set(N){if(!N){_.replace({name:"home"});return}_.replace({name:"map-marker",params:{markerType:N.type,markerId:N.id}})}}),k=Gi(""),S=Gi(!1),h=_i(()=>n.value?"1":u.name==="search"||u.name==="favorites"||S.value?"1/2":"3/4");return(N,q)=>(Le(),mt("div",kb,[Vi(Sx,{"search-input":k.value,"onUpdate:searchInput":q[0]||(q[0]=ne=>k.value=ne)},null,8,["search-input"]),Vi(id,{"is-open":!!x.value,"disable-resize":st(n),size:h.value,onClose:q[1]||(q[1]=ne=>x.value=void 0)},{default:tr(()=>[x.value?(Le(),Ft(Mv,{key:0,marker:x.value},null,8,["marker"])):zi("",!0)]),_:1},8,["is-open","disable-resize","size"]),Vi(id,{"is-open":N.$route.name==="search","disable-resize":st(n),size:h.value,onClose:q[3]||(q[3]=ne=>N.$router.replace({name:"home"}))},{default:tr(()=>[Vi(Tb,{"search-input":k.value,"onUpdate:searchInput":q[2]||(q[2]=ne=>k.value=ne)},null,8,["search-input"])]),_:1},8,["is-open","disable-resize","size"]),Vi(id,{"is-open":N.$route.name==="favorites","disable-resize":st(n),size:h.value,onClose:q[4]||(q[4]=ne=>N.$router.replace({name:"home"}))},{default:tr(()=>[Vi(Nx)]),_:1},8,["is-open","disable-resize","size"]),st(n)?zi("",!0):(Le(),Ft(Ax,{key:0,"map-moved-manually":S.value,"onUpdate:mapMovedManually":q[5]||(q[5]=ne=>S.value=ne),"selected-marker":x.value,onMarkerClick:q[6]||(q[6]=ne=>x.value=ne)},null,8,["map-moved-manually","selected-marker"]))]))}});export{Db as default};
//# sourceMappingURL=Home-NgBe9E8J.js.map
