import{d as Hs,o as F_,w as L_,v as O_,t as Zl,a as We,c as It,n as Wx,b as cd,r as wi,e as Tr,f as yt,g as _u,_ as Pd,u as Xx,h as Ot,i as _t,j as Cf,k as Ii,l as Nr,T as Yx,m as Jx,p as ri,q as Kx,s as Ro,x as Qx,y as za,z as Li,A as Eu,B as ev,C as _r,D as Nl,E as B_,F as j_,G as tv,H as rv,I as iv,J as sv,K as Qg,L as e_,M as nv,N as N_,O as V_,P as on,Q as ka,R as $_,S as pd,U as ov,V as av}from"./index-CtVhMCYv.js";import{_ as lv}from"./logo-DBgTG2k7.js";import{u as cv}from"./useTrack-U4hIV2-U.js";import{u as uv}from"./useFeatureFlags-JUtXhQfd.js";const hv=["title"],dv=Hs({__name:"BottomSheet",props:{isOpen:{type:Boolean},size:{}},emits:["close"],setup(v,{emit:c}){const g=v,x=c,E=wi(!1),k=wi(),S=Zl(g,"isOpen"),l=Zl(g,"size"),$=Tr(()=>{if(l.value==="1")return"full";if(!S.value)return"closed";if(E.value){if(k.value===void 0)return"closed";const ze=k.value/window.innerHeight;return l.value==="1/2"&&ze>.6||l.value==="3/4"&&ze>.85?"maximizing":l.value==="1/2"&&ze<.4||l.value==="3/4"&&ze<.65?"closing":"defaulting"}return k.value===0?"closed":k.value===window.innerHeight?"full":"default"});function oe(ze){E.value=!0,k.value=window.innerHeight-ze.clientY,window.addEventListener("pointermove",me),window.addEventListener("pointerup",ye),window.addEventListener("pointercancel",ye)}function me(ze){E.value&&(k.value=window.innerHeight-ze.clientY)}function we(){window.removeEventListener("pointermove",me),window.removeEventListener("pointerup",ye),window.removeEventListener("pointercancel",ye)}function ye(){E.value&&($.value==="maximizing"?k.value=window.innerHeight:$.value==="closing"?(k.value=void 0,x("close")):$.value==="defaulting"&&(k.value=void 0),E.value=!1,we())}return F_(()=>{we()}),(ze,Ke)=>L_((We(),It("div",{class:cd(["shadow-top absolute right-0 bottom-0 left-0 z-10 flex w-full flex-col rounded-t-2xl bg-white px-4 pt-2 pb-0 transition dark:border-neutral-950 dark:bg-neutral-800 dark:text-gray-300",{"max-h-0 overflow-hidden":$.value==="closed","max-h-[calc(100%-var(--safe-area-top)-var(--app-bar-space))]":$.value!=="closed","h-full shadow-none":$.value==="full","h-1/2":l.value==="1/2"&&$.value==="default","h-3/4":l.value==="3/4"&&$.value==="default","rounded-none":$.value==="full","opacity-80":$.value==="closing",fade:!E.value}]),style:Wx({height:S.value?k.value===void 0?void 0:`${k.value}px`:0})},[yt("button",{type:"button",class:"-mt-4 w-full touch-none pt-4 pb-4",title:ze.$t("drag_to_resize"),onPointerdown:oe},[...Ke[0]||(Ke[0]=[yt("div",{class:"mx-auto h-1.5 w-12 shrink-0 rounded-full bg-gray-500"},null,-1)])],40,hv),_u(ze.$slots,"default",{},void 0,!0)],6)),[[O_,S.value]])}}),pv=Pd(dv,[["__scopeId","data-v-c0181e19"]]),fv={key:0,class:"z-10 mx-auto mt-[calc(var(--safe-area-top)+var(--app-bar-space))] flex h-[calc(100%-var(--safe-area-top)-var(--app-bar-space))] w-full max-w-4xl flex-col bg-white px-4 py-2 dark:bg-neutral-800 dark:text-gray-300"},mv={key:0,class:"shadow-right absolute top-0 bottom-0 left-0 z-10 flex w-80 flex-col bg-white px-4 py-2 dark:bg-neutral-800 dark:text-gray-300"},gv=Hs({__name:"DetailsPopup",props:{isOpen:{type:Boolean},size:{}},emits:["close"],setup(v){const{liteMode:c}=Cf(),x=Xx(Jx).greater("md");return(E,k)=>_t(c)?L_((We(),It("div",fv,[_u(E.$slots,"default",{},void 0,!0)],512)),[[O_,v.isOpen]]):_t(x)?(We(),Ot(Yx,{key:1,name:"fade"},{default:Ii(()=>[v.isOpen?(We(),It("div",mv,[_u(E.$slots,"default",{},void 0,!0)])):Nr("",!0)]),_:3})):(We(),Ot(pv,{key:2,"is-open":v.isOpen,size:v.size,onClose:k[0]||(k[0]=S=>E.$emit("close"))},{default:Ii(()=>[_u(E.$slots,"default",{},void 0,!0)]),_:3},8,["is-open","size"]))}}),_v=Pd(gv,[["__scopeId","data-v-57a075af"]]),yv={viewBox:"0 0 32 32",width:"1.2em",height:"1.2em"};function xv(v,c){return We(),It("svg",yv,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M23.5 22H23v-2h.5a4.5 4.5 0 0 0 .36-9H23l-.1-.82a7 7 0 0 0-13.88 0L9 11h-.86a4.5 4.5 0 0 0 .36 9H9v2h-.5A6.5 6.5 0 0 1 7.2 9.14a9 9 0 0 1 17.6 0A6.5 6.5 0 0 1 23.5 22"},null,-1),yt("path",{fill:"currentColor",d:"M17 26.17V14h-2v12.17l-2.59-2.58L11 25l5 5l5-5l-1.41-1.41z"},null,-1)])])}const vv=ri({name:"carbon-cloud-download",render:xv}),bv={viewBox:"0 0 32 32",width:"1.2em",height:"1.2em"};function wv(v,c){return We(),It("svg",bv,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M24.8 12.136a8.9 8.9 0 0 0-.979-2.543L30 3.414L28.587 2L2 28.587L3.414 30l5-5H23.5a6.497 6.497 0 0 0 1.3-12.864M23.5 23H10.414l11.928-11.928a6.9 6.9 0 0 1 .6 2.071l.099.812l.815.064A4.498 4.498 0 0 1 23.5 23m-19.204.449l1.432-1.431a4.477 4.477 0 0 1 2.416-7.999l.816-.064l.099-.812a6.987 6.987 0 0 1 10.63-5.086l1.443-1.443A8.986 8.986 0 0 0 7.2 12.136A6.49 6.49 0 0 0 4.296 23.45"},null,-1)])])}const Tv=ri({name:"carbon-cloud-offline",render:wv});function Sv(v={}){const{immediate:c=!1,onNeedRefresh:g,onOfflineReady:x,onRegistered:E,onRegisteredSW:k,onRegisterError:S}=v;let l,$,oe;const me=async(ye=!0)=>{await $,oe?.()};async function we(){if("serviceWorker"in navigator){if(l=await Kx(async()=>{const{Workbox:ye}=await import("./workbox-window.prod.es5-BIl4cyR9.js");return{Workbox:ye}},[]).then(({Workbox:ye})=>new ye("/sw.js",{scope:"/",type:"classic"})).catch(ye=>{S?.(ye)}),!l)return;oe=()=>{l?.messageSkipWaiting()};{let ye=!1;const ze=()=>{ye=!0,l?.addEventListener("controlling",Ke=>{Ke.isUpdate&&window.location.reload()}),g?.()};l.addEventListener("installed",Ke=>{typeof Ke.isUpdate>"u"?typeof Ke.isExternal<"u"&&Ke.isExternal?ze():!ye&&x?.():Ke.isUpdate||x?.()}),l.addEventListener("waiting",ze)}l.register({immediate:c}).then(ye=>{k?k("/sw.js",ye):E?.(ye)}).catch(ye=>{S?.(ye)})}}return $=we(),me}function Pv(v={}){const{immediate:c=!0,onNeedRefresh:g,onOfflineReady:x,onRegistered:E,onRegisteredSW:k,onRegisterError:S}=v,l=wi(!1),$=wi(!1);return{updateServiceWorker:Sv({immediate:c,onNeedRefresh(){l.value=!0,g?.()},onOfflineReady(){$.value=!0,x?.()},onRegistered:E,onRegisteredSW:k,onRegisterError:S}),offlineReady:$,needRefresh:l}}function to(v){return Array.isArray?Array.isArray(v):G_(v)==="[object Array]"}function Ev(v){if(typeof v=="string")return v;let c=v+"";return c=="0"&&1/v==-1/0?"-0":c}function Mv(v){return v==null?"":Ev(v)}function In(v){return typeof v=="string"}function U_(v){return typeof v=="number"}function Iv(v){return v===!0||v===!1||Av(v)&&G_(v)=="[object Boolean]"}function q_(v){return typeof v=="object"}function Av(v){return q_(v)&&v!==null}function zs(v){return v!=null}function ef(v){return!v.trim().length}function G_(v){return v==null?v===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(v)}const Cv="Incorrect 'index' type",kv=v=>`Invalid value for key ${v}`,Dv=v=>`Pattern length exceeds max of ${v}.`,zv=v=>`Missing ${v} property in key`,Rv=v=>`Property 'weight' in key '${v}' must be a positive integer`,t_=Object.prototype.hasOwnProperty;class Fv{constructor(c){this._keys=[],this._keyMap={};let g=0;c.forEach(x=>{let E=Z_(x);this._keys.push(E),this._keyMap[E.id]=E,g+=E.weight}),this._keys.forEach(x=>{x.weight/=g})}get(c){return this._keyMap[c]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function Z_(v){let c=null,g=null,x=null,E=1,k=null;if(In(v)||to(v))x=v,c=r_(v),g=uf(v);else{if(!t_.call(v,"name"))throw new Error(zv("name"));const S=v.name;if(x=S,t_.call(v,"weight")&&(E=v.weight,E<=0))throw new Error(Rv(S));c=r_(S),g=uf(S),k=v.getFn}return{path:c,id:g,weight:E,src:x,getFn:k}}function r_(v){return to(v)?v:v.split(".")}function uf(v){return to(v)?v.join("."):v}function Lv(v,c){let g=[],x=!1;const E=(k,S,l)=>{if(zs(k))if(!S[l])g.push(k);else{let $=S[l];const oe=k[$];if(!zs(oe))return;if(l===S.length-1&&(In(oe)||U_(oe)||Iv(oe)))g.push(Mv(oe));else if(to(oe)){x=!0;for(let me=0,we=oe.length;me<we;me+=1)E(oe[me],S,l+1)}else S.length&&E(oe,S,l+1)}};return E(v,In(c)?c.split("."):c,0),x?g:g[0]}const Ov={includeMatches:!1,findAllMatches:!1,minMatchCharLength:1},Bv={isCaseSensitive:!1,ignoreDiacritics:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(v,c)=>v.score===c.score?v.idx<c.idx?-1:1:v.score<c.score?-1:1},jv={location:0,threshold:.6,distance:100},Nv={useExtendedSearch:!1,getFn:Lv,ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1};var Bt={...Bv,...Ov,...jv,...Nv};const Vv=/[^ ]+/g;function $v(v=1,c=3){const g=new Map,x=Math.pow(10,c);return{get(E){const k=E.match(Vv).length;if(g.has(k))return g.get(k);const S=1/Math.pow(k,.5*v),l=parseFloat(Math.round(S*x)/x);return g.set(k,l),l},clear(){g.clear()}}}class kf{constructor({getFn:c=Bt.getFn,fieldNormWeight:g=Bt.fieldNormWeight}={}){this.norm=$v(g,3),this.getFn=c,this.isCreated=!1,this.setIndexRecords()}setSources(c=[]){this.docs=c}setIndexRecords(c=[]){this.records=c}setKeys(c=[]){this.keys=c,this._keysMap={},c.forEach((g,x)=>{this._keysMap[g.id]=x})}create(){this.isCreated||!this.docs.length||(this.isCreated=!0,In(this.docs[0])?this.docs.forEach((c,g)=>{this._addString(c,g)}):this.docs.forEach((c,g)=>{this._addObject(c,g)}),this.norm.clear())}add(c){const g=this.size();In(c)?this._addString(c,g):this._addObject(c,g)}removeAt(c){this.records.splice(c,1);for(let g=c,x=this.size();g<x;g+=1)this.records[g].i-=1}getValueForItemAtKeyId(c,g){return c[this._keysMap[g]]}size(){return this.records.length}_addString(c,g){if(!zs(c)||ef(c))return;let x={v:c,i:g,n:this.norm.get(c)};this.records.push(x)}_addObject(c,g){let x={i:g,$:{}};this.keys.forEach((E,k)=>{let S=E.getFn?E.getFn(c):this.getFn(c,E.path);if(zs(S)){if(to(S)){let l=[];const $=[{nestedArrIndex:-1,value:S}];for(;$.length;){const{nestedArrIndex:oe,value:me}=$.pop();if(zs(me))if(In(me)&&!ef(me)){let we={v:me,i:oe,n:this.norm.get(me)};l.push(we)}else to(me)&&me.forEach((we,ye)=>{$.push({nestedArrIndex:ye,value:we})})}x.$[k]=l}else if(In(S)&&!ef(S)){let l={v:S,n:this.norm.get(S)};x.$[k]=l}}}),this.records.push(x)}toJSON(){return{keys:this.keys,records:this.records}}}function H_(v,c,{getFn:g=Bt.getFn,fieldNormWeight:x=Bt.fieldNormWeight}={}){const E=new kf({getFn:g,fieldNormWeight:x});return E.setKeys(v.map(Z_)),E.setSources(c),E.create(),E}function Uv(v,{getFn:c=Bt.getFn,fieldNormWeight:g=Bt.fieldNormWeight}={}){const{keys:x,records:E}=v,k=new kf({getFn:c,fieldNormWeight:g});return k.setKeys(x),k.setIndexRecords(E),k}function id(v,{errors:c=0,currentLocation:g=0,expectedLocation:x=0,distance:E=Bt.distance,ignoreLocation:k=Bt.ignoreLocation}={}){const S=c/v.length;if(k)return S;const l=Math.abs(x-g);return E?S+l/E:l?1:S}function qv(v=[],c=Bt.minMatchCharLength){let g=[],x=-1,E=-1,k=0;for(let S=v.length;k<S;k+=1){let l=v[k];l&&x===-1?x=k:!l&&x!==-1&&(E=k-1,E-x+1>=c&&g.push([x,E]),x=-1)}return v[k-1]&&k-x>=c&&g.push([x,k-1]),g}const Ca=32;function Gv(v,c,g,{location:x=Bt.location,distance:E=Bt.distance,threshold:k=Bt.threshold,findAllMatches:S=Bt.findAllMatches,minMatchCharLength:l=Bt.minMatchCharLength,includeMatches:$=Bt.includeMatches,ignoreLocation:oe=Bt.ignoreLocation}={}){if(c.length>Ca)throw new Error(Dv(Ca));const me=c.length,we=v.length,ye=Math.max(0,Math.min(x,we));let ze=k,Ke=ye;const ot=l>1||$,ge=ot?Array(we):[];let Pt;for(;(Pt=v.indexOf(c,Ke))>-1;){let Ye=id(c,{currentLocation:Pt,expectedLocation:ye,distance:E,ignoreLocation:oe});if(ze=Math.min(Ye,ze),Ke=Pt+me,ot){let He=0;for(;He<me;)ge[Pt+He]=1,He+=1}}Ke=-1;let xt=[],At=1,Qt=me+we;const Fe=1<<me-1;for(let Ye=0;Ye<me;Ye+=1){let He=0,Ge=Qt;for(;He<Ge;)id(c,{errors:Ye,currentLocation:ye+Ge,expectedLocation:ye,distance:E,ignoreLocation:oe})<=ze?He=Ge:Qt=Ge,Ge=Math.floor((Qt-He)/2+He);Qt=Ge;let pt=Math.max(1,ye-Ge+1),vt=S?we:Math.min(ye+Ge,we)+me,Qe=Array(vt+2);Qe[vt+1]=(1<<Ye)-1;for(let Ht=vt;Ht>=pt;Ht-=1){let rt=Ht-1,Jt=g[v.charAt(rt)];if(ot&&(ge[rt]=+!!Jt),Qe[Ht]=(Qe[Ht+1]<<1|1)&Jt,Ye&&(Qe[Ht]|=(xt[Ht+1]|xt[Ht])<<1|1|xt[Ht+1]),Qe[Ht]&Fe&&(At=id(c,{errors:Ye,currentLocation:rt,expectedLocation:ye,distance:E,ignoreLocation:oe}),At<=ze)){if(ze=At,Ke=rt,Ke<=ye)break;pt=Math.max(1,2*ye-Ke)}}if(id(c,{errors:Ye+1,currentLocation:ye,expectedLocation:ye,distance:E,ignoreLocation:oe})>ze)break;xt=Qe}const st={isMatch:Ke>=0,score:Math.max(.001,At)};if(ot){const Ye=qv(ge,l);Ye.length?$&&(st.indices=Ye):st.isMatch=!1}return st}function Zv(v){let c={};for(let g=0,x=v.length;g<x;g+=1){const E=v.charAt(g);c[E]=(c[E]||0)|1<<x-g-1}return c}const fd=String.prototype.normalize?(v=>v.normalize("NFD").replace(/[\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08D3-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C04\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DF9\u1DFB-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F]/g,"")):(v=>v);class W_{constructor(c,{location:g=Bt.location,threshold:x=Bt.threshold,distance:E=Bt.distance,includeMatches:k=Bt.includeMatches,findAllMatches:S=Bt.findAllMatches,minMatchCharLength:l=Bt.minMatchCharLength,isCaseSensitive:$=Bt.isCaseSensitive,ignoreDiacritics:oe=Bt.ignoreDiacritics,ignoreLocation:me=Bt.ignoreLocation}={}){if(this.options={location:g,threshold:x,distance:E,includeMatches:k,findAllMatches:S,minMatchCharLength:l,isCaseSensitive:$,ignoreDiacritics:oe,ignoreLocation:me},c=$?c:c.toLowerCase(),c=oe?fd(c):c,this.pattern=c,this.chunks=[],!this.pattern.length)return;const we=(ze,Ke)=>{this.chunks.push({pattern:ze,alphabet:Zv(ze),startIndex:Ke})},ye=this.pattern.length;if(ye>Ca){let ze=0;const Ke=ye%Ca,ot=ye-Ke;for(;ze<ot;)we(this.pattern.substr(ze,Ca),ze),ze+=Ca;if(Ke){const ge=ye-Ca;we(this.pattern.substr(ge),ge)}}else we(this.pattern,0)}searchIn(c){const{isCaseSensitive:g,ignoreDiacritics:x,includeMatches:E}=this.options;if(c=g?c:c.toLowerCase(),c=x?fd(c):c,this.pattern===c){let ot={isMatch:!0,score:0};return E&&(ot.indices=[[0,c.length-1]]),ot}const{location:k,distance:S,threshold:l,findAllMatches:$,minMatchCharLength:oe,ignoreLocation:me}=this.options;let we=[],ye=0,ze=!1;this.chunks.forEach(({pattern:ot,alphabet:ge,startIndex:Pt})=>{const{isMatch:xt,score:At,indices:Qt}=Gv(c,ot,ge,{location:k+Pt,distance:S,threshold:l,findAllMatches:$,minMatchCharLength:oe,includeMatches:E,ignoreLocation:me});xt&&(ze=!0),ye+=At,xt&&Qt&&(we=[...we,...Qt])});let Ke={isMatch:ze,score:ze?ye/this.chunks.length:1};return ze&&E&&(Ke.indices=we),Ke}}class No{constructor(c){this.pattern=c}static isMultiMatch(c){return i_(c,this.multiRegex)}static isSingleMatch(c){return i_(c,this.singleRegex)}search(){}}function i_(v,c){const g=v.match(c);return g?g[1]:null}class Hv extends No{constructor(c){super(c)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(c){const g=c===this.pattern;return{isMatch:g,score:g?0:1,indices:[0,this.pattern.length-1]}}}class Wv extends No{constructor(c){super(c)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(c){const x=c.indexOf(this.pattern)===-1;return{isMatch:x,score:x?0:1,indices:[0,c.length-1]}}}class Xv extends No{constructor(c){super(c)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(c){const g=c.startsWith(this.pattern);return{isMatch:g,score:g?0:1,indices:[0,this.pattern.length-1]}}}class Yv extends No{constructor(c){super(c)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(c){const g=!c.startsWith(this.pattern);return{isMatch:g,score:g?0:1,indices:[0,c.length-1]}}}class Jv extends No{constructor(c){super(c)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(c){const g=c.endsWith(this.pattern);return{isMatch:g,score:g?0:1,indices:[c.length-this.pattern.length,c.length-1]}}}class Kv extends No{constructor(c){super(c)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(c){const g=!c.endsWith(this.pattern);return{isMatch:g,score:g?0:1,indices:[0,c.length-1]}}}class X_ extends No{constructor(c,{location:g=Bt.location,threshold:x=Bt.threshold,distance:E=Bt.distance,includeMatches:k=Bt.includeMatches,findAllMatches:S=Bt.findAllMatches,minMatchCharLength:l=Bt.minMatchCharLength,isCaseSensitive:$=Bt.isCaseSensitive,ignoreDiacritics:oe=Bt.ignoreDiacritics,ignoreLocation:me=Bt.ignoreLocation}={}){super(c),this._bitapSearch=new W_(c,{location:g,threshold:x,distance:E,includeMatches:k,findAllMatches:S,minMatchCharLength:l,isCaseSensitive:$,ignoreDiacritics:oe,ignoreLocation:me})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(c){return this._bitapSearch.searchIn(c)}}class Y_ extends No{constructor(c){super(c)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(c){let g=0,x;const E=[],k=this.pattern.length;for(;(x=c.indexOf(this.pattern,g))>-1;)g=x+k,E.push([x,g-1]);const S=!!E.length;return{isMatch:S,score:S?0:1,indices:E}}}const hf=[Hv,Y_,Xv,Yv,Kv,Jv,Wv,X_],s_=hf.length,Qv=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/,eb="|";function tb(v,c={}){return v.split(eb).map(g=>{let x=g.trim().split(Qv).filter(k=>k&&!!k.trim()),E=[];for(let k=0,S=x.length;k<S;k+=1){const l=x[k];let $=!1,oe=-1;for(;!$&&++oe<s_;){const me=hf[oe];let we=me.isMultiMatch(l);we&&(E.push(new me(we,c)),$=!0)}if(!$)for(oe=-1;++oe<s_;){const me=hf[oe];let we=me.isSingleMatch(l);if(we){E.push(new me(we,c));break}}}return E})}const rb=new Set([X_.type,Y_.type]);class ib{constructor(c,{isCaseSensitive:g=Bt.isCaseSensitive,ignoreDiacritics:x=Bt.ignoreDiacritics,includeMatches:E=Bt.includeMatches,minMatchCharLength:k=Bt.minMatchCharLength,ignoreLocation:S=Bt.ignoreLocation,findAllMatches:l=Bt.findAllMatches,location:$=Bt.location,threshold:oe=Bt.threshold,distance:me=Bt.distance}={}){this.query=null,this.options={isCaseSensitive:g,ignoreDiacritics:x,includeMatches:E,minMatchCharLength:k,findAllMatches:l,ignoreLocation:S,location:$,threshold:oe,distance:me},c=g?c:c.toLowerCase(),c=x?fd(c):c,this.pattern=c,this.query=tb(this.pattern,this.options)}static condition(c,g){return g.useExtendedSearch}searchIn(c){const g=this.query;if(!g)return{isMatch:!1,score:1};const{includeMatches:x,isCaseSensitive:E,ignoreDiacritics:k}=this.options;c=E?c:c.toLowerCase(),c=k?fd(c):c;let S=0,l=[],$=0;for(let oe=0,me=g.length;oe<me;oe+=1){const we=g[oe];l.length=0,S=0;for(let ye=0,ze=we.length;ye<ze;ye+=1){const Ke=we[ye],{isMatch:ot,indices:ge,score:Pt}=Ke.search(c);if(ot){if(S+=1,$+=Pt,x){const xt=Ke.constructor.type;rb.has(xt)?l=[...l,...ge]:l.push(ge)}}else{$=0,S=0,l.length=0;break}}if(S){let ye={isMatch:!0,score:$/S};return x&&(ye.indices=l),ye}}return{isMatch:!1,score:1}}}const df=[];function sb(...v){df.push(...v)}function pf(v,c){for(let g=0,x=df.length;g<x;g+=1){let E=df[g];if(E.condition(v,c))return new E(v,c)}return new W_(v,c)}const md={AND:"$and",OR:"$or"},ff={PATH:"$path",PATTERN:"$val"},mf=v=>!!(v[md.AND]||v[md.OR]),nb=v=>!!v[ff.PATH],ob=v=>!to(v)&&q_(v)&&!mf(v),n_=v=>({[md.AND]:Object.keys(v).map(c=>({[c]:v[c]}))});function J_(v,c,{auto:g=!0}={}){const x=E=>{let k=Object.keys(E);const S=nb(E);if(!S&&k.length>1&&!mf(E))return x(n_(E));if(ob(E)){const $=S?E[ff.PATH]:k[0],oe=S?E[ff.PATTERN]:E[$];if(!In(oe))throw new Error(kv($));const me={keyId:uf($),pattern:oe};return g&&(me.searcher=pf(oe,c)),me}let l={children:[],operator:k[0]};return k.forEach($=>{const oe=E[$];to(oe)&&oe.forEach(me=>{l.children.push(x(me))})}),l};return mf(v)||(v=n_(v)),x(v)}function ab(v,{ignoreFieldNorm:c=Bt.ignoreFieldNorm}){v.forEach(g=>{let x=1;g.matches.forEach(({key:E,norm:k,score:S})=>{const l=E?E.weight:null;x*=Math.pow(S===0&&l?Number.EPSILON:S,(l||1)*(c?1:k))}),g.score=x})}function lb(v,c){const g=v.matches;c.matches=[],zs(g)&&g.forEach(x=>{if(!zs(x.indices)||!x.indices.length)return;const{indices:E,value:k}=x;let S={indices:E,value:k};x.key&&(S.key=x.key.src),x.idx>-1&&(S.refIndex=x.idx),c.matches.push(S)})}function cb(v,c){c.score=v.score}function ub(v,c,{includeMatches:g=Bt.includeMatches,includeScore:x=Bt.includeScore}={}){const E=[];return g&&E.push(lb),x&&E.push(cb),v.map(k=>{const{idx:S}=k,l={item:c[S],refIndex:S};return E.length&&E.forEach($=>{$(k,l)}),l})}class Yl{constructor(c,g={},x){this.options={...Bt,...g},this.options.useExtendedSearch,this._keyStore=new Fv(this.options.keys),this.setCollection(c,x)}setCollection(c,g){if(this._docs=c,g&&!(g instanceof kf))throw new Error(Cv);this._myIndex=g||H_(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(c){zs(c)&&(this._docs.push(c),this._myIndex.add(c))}remove(c=()=>!1){const g=[];for(let x=0,E=this._docs.length;x<E;x+=1){const k=this._docs[x];c(k,x)&&(this.removeAt(x),x-=1,E-=1,g.push(k))}return g}removeAt(c){this._docs.splice(c,1),this._myIndex.removeAt(c)}getIndex(){return this._myIndex}search(c,{limit:g=-1}={}){const{includeMatches:x,includeScore:E,shouldSort:k,sortFn:S,ignoreFieldNorm:l}=this.options;let $=In(c)?In(this._docs[0])?this._searchStringList(c):this._searchObjectList(c):this._searchLogical(c);return ab($,{ignoreFieldNorm:l}),k&&$.sort(S),U_(g)&&g>-1&&($=$.slice(0,g)),ub($,this._docs,{includeMatches:x,includeScore:E})}_searchStringList(c){const g=pf(c,this.options),{records:x}=this._myIndex,E=[];return x.forEach(({v:k,i:S,n:l})=>{if(!zs(k))return;const{isMatch:$,score:oe,indices:me}=g.searchIn(k);$&&E.push({item:k,idx:S,matches:[{score:oe,value:k,norm:l,indices:me}]})}),E}_searchLogical(c){const g=J_(c,this.options),x=(l,$,oe)=>{if(!l.children){const{keyId:we,searcher:ye}=l,ze=this._findMatches({key:this._keyStore.get(we),value:this._myIndex.getValueForItemAtKeyId($,we),searcher:ye});return ze&&ze.length?[{idx:oe,item:$,matches:ze}]:[]}const me=[];for(let we=0,ye=l.children.length;we<ye;we+=1){const ze=l.children[we],Ke=x(ze,$,oe);if(Ke.length)me.push(...Ke);else if(l.operator===md.AND)return[]}return me},E=this._myIndex.records,k={},S=[];return E.forEach(({$:l,i:$})=>{if(zs(l)){let oe=x(g,l,$);oe.length&&(k[$]||(k[$]={idx:$,item:l,matches:[]},S.push(k[$])),oe.forEach(({matches:me})=>{k[$].matches.push(...me)}))}}),S}_searchObjectList(c){const g=pf(c,this.options),{keys:x,records:E}=this._myIndex,k=[];return E.forEach(({$:S,i:l})=>{if(!zs(S))return;let $=[];x.forEach((oe,me)=>{$.push(...this._findMatches({key:oe,value:S[me],searcher:g}))}),$.length&&k.push({idx:l,item:S,matches:$})}),k}_findMatches({key:c,value:g,searcher:x}){if(!zs(g))return[];let E=[];if(to(g))g.forEach(({v:k,i:S,n:l})=>{if(!zs(k))return;const{isMatch:$,score:oe,indices:me}=x.searchIn(k);$&&E.push({score:oe,key:c,value:k,idx:S,norm:l,indices:me})});else{const{v:k,n:S}=g,{isMatch:l,score:$,indices:oe}=x.searchIn(k);l&&E.push({score:$,key:c,value:k,norm:S,indices:oe})}return E}}Yl.version="7.1.0";Yl.createIndex=H_;Yl.parseIndex=Uv;Yl.config=Bt;Yl.parseQuery=J_;sb(ib);const Ls=new Uint8Array(0),Ra=new TextEncoder,Rs=new TextDecoder;function hb(...v){let c=0;for(let E=0;E<v.length;E++)c+=v[E].length;const g=new Uint8Array(c);let x=0;for(let E=0;E<v.length;E++)g.set(v[E],x),x+=v[E].length;return g}function yu(...v){const c=[];for(let g=0;g<v.length;g++)c.push(Ra.encode(v[g]));return c.length===0?Ls:c.length===1?c[0]:hb(...c)}function o_(v){return!v||v.length===0?"":Rs.decode(v)}const a_="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",l_=36,db=0xcfd41b9100000,c_=33,pb=333,u_=22;function fb(v){for(let c=0;c<v.length;c++)v[c]=Math.floor(Math.random()*255)}function mb(v){globalThis?.crypto?.getRandomValues?globalThis.crypto.getRandomValues(v):fb(v)}class gb{buf;seq;inc;inited;constructor(){this.buf=new Uint8Array(u_),this.inited=!1}init(){this.inited=!0,this.setPre(),this.initSeqAndInc(),this.fillSeq()}initSeqAndInc(){this.seq=Math.floor(Math.random()*db),this.inc=Math.floor(Math.random()*(pb-c_)+c_)}setPre(){const c=new Uint8Array(12);mb(c);for(let g=0;g<12;g++){const x=c[g]%36;this.buf[g]=a_.charCodeAt(x)}}fillSeq(){let c=this.seq;for(let g=u_-1;g>=12;g--)this.buf[g]=a_.charCodeAt(c%l_),c=Math.floor(c/l_)}next(){return this.inited||this.init(),this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),String.fromCharCode.apply(String,this.buf)}reset(){this.init()}}const Bo=new gb;var nn;(function(v){v.Disconnect="disconnect",v.Reconnect="reconnect",v.Update="update",v.LDM="ldm",v.Error="error"})(nn||(nn={}));var Vl;(function(v){v.Reconnecting="reconnecting",v.PingTimer="pingTimer",v.StaleConnection="staleConnection",v.ClientInitiatedReconnect="client initiated reconnect"})(Vl||(Vl={}));var ct;(function(v){v.ApiError="BAD API",v.BadAuthentication="BAD_AUTHENTICATION",v.BadCreds="BAD_CREDS",v.BadHeader="BAD_HEADER",v.BadJson="BAD_JSON",v.BadPayload="BAD_PAYLOAD",v.BadSubject="BAD_SUBJECT",v.Cancelled="CANCELLED",v.ConnectionClosed="CONNECTION_CLOSED",v.ConnectionDraining="CONNECTION_DRAINING",v.ConnectionRefused="CONNECTION_REFUSED",v.ConnectionTimeout="CONNECTION_TIMEOUT",v.Disconnect="DISCONNECT",v.InvalidOption="INVALID_OPTION",v.InvalidPayload="INVALID_PAYLOAD",v.MaxPayloadExceeded="MAX_PAYLOAD_EXCEEDED",v.NoResponders="503",v.NotFunction="NOT_FUNC",v.RequestError="REQUEST_ERROR",v.ServerOptionNotAvailable="SERVER_OPT_NA",v.SubClosed="SUB_CLOSED",v.SubDraining="SUB_DRAINING",v.Timeout="TIMEOUT",v.Tls="TLS",v.Unknown="UNKNOWN_ERROR",v.WssRequired="WSS_REQUIRED",v.JetStreamInvalidAck="JESTREAM_INVALID_ACK",v.JetStream404NoMessages="404",v.JetStream408RequestTimeout="408",v.JetStream409MaxAckPendingExceeded="409",v.JetStream409="409",v.JetStreamNotEnabled="503",v.JetStreamIdleHeartBeat="IDLE_HEARTBEAT",v.AuthorizationViolation="AUTHORIZATION_VIOLATION",v.AuthenticationExpired="AUTHENTICATION_EXPIRED",v.ProtocolError="NATS_PROTOCOL_ERR",v.PermissionsViolation="PERMISSIONS_VIOLATION",v.AuthenticationTimeout="AUTHENTICATION_TIMEOUT",v.AccountExpired="ACCOUNT_EXPIRED"})(ct||(ct={}));function _b(v){return typeof v.code=="string"}class K_{messages;constructor(){this.messages=new Map,this.messages.set(ct.InvalidPayload,"Invalid payload type - payloads can be 'binary', 'string', or 'json'"),this.messages.set(ct.BadJson,"Bad JSON"),this.messages.set(ct.WssRequired,"TLS is required, therefore a secure websocket connection is also required")}static getMessage(c){return yb.getMessage(c)}getMessage(c){return this.messages.get(c)||c}}const yb=new K_;class St extends Error{name;message;code;permissionContext;chainedError;api_error;constructor(c,g,x){super(c),this.name="NatsError",this.message=c,this.code=g,this.chainedError=x}static errorForCode(c,g){const x=K_.getMessage(c);return new St(x,c,g)}isAuthError(){return this.code===ct.AuthenticationExpired||this.code===ct.AuthorizationViolation||this.code===ct.AccountExpired}isAuthTimeout(){return this.code===ct.AuthenticationTimeout}isPermissionError(){return this.code===ct.PermissionsViolation}isProtocolError(){return this.code===ct.ProtocolError}isJetStreamError(){return this.api_error!==void 0}jsError(){return this.api_error?this.api_error:null}}var ks;(function(v){v[v.Exact=0]="Exact",v[v.CanonicalMIME=1]="CanonicalMIME",v[v.IgnoreCase=2]="IgnoreCase"})(ks||(ks={}));var an;(function(v){v.Timer="timer",v.Count="count",v.JitterTimer="jitterTimer",v.SentinelMsg="sentinelMsg"})(an||(an={}));var xu;(function(v){v.STATS="io.nats.micro.v1.stats_response",v.INFO="io.nats.micro.v1.info_response",v.PING="io.nats.micro.v1.ping_response"})(xu||(xu={}));const gd="Nats-Service-Error",_d="Nats-Service-Error-Code";class yd extends Error{code;constructor(c,g){super(g),this.code=c}static isServiceError(c){return yd.toServiceError(c)!==null}static toServiceError(c){const g=c?.headers?.get(_d)||"";if(g!==""){const x=parseInt(g)||400,E=c?.headers?.get(gd)||"";return new yd(x,E.length?E:g)}return null}}function An(v=""){if(v=v||"_INBOX",typeof v!="string")throw new Error("prefix must be a string");return v.split(".").forEach(c=>{if(c==="*"||c===">")throw new Error(`inbox prefixes cannot have wildcards '${v}'`)}),`${v}.${Bo.next()}`}const gf="127.0.0.1";var Fo;(function(v){v.PING="PING",v.STATS="STATS",v.INFO="INFO"})(Fo||(Fo={}));function Ed(v,...c){for(let g=0;g<c.length;g++){const x=c[g];Object.keys(x).forEach(function(E){v[E]=x[E]})}return v}function sd(v){return Rs.decode(v).replace(/\n/g,"␊").replace(/\r/g,"␍")}function Hl(v,c=!0){const g=c?St.errorForCode(ct.Timeout):null;let x,E;const k=new Promise((S,l)=>{x={cancel:()=>{E&&clearTimeout(E)}},E=setTimeout(()=>{l(g===null?St.errorForCode(ct.Timeout):g)},v)});return Object.assign(k,x)}function Jl(v=0){let c;const g=new Promise(x=>{const E=setTimeout(()=>{x()},v);c={cancel:()=>{E&&clearTimeout(E)}}});return Object.assign(g,c)}function ti(){let v={};const c=new Promise((g,x)=>{v={resolve:g,reject:x}});return Object.assign(c,v)}function Q_(v){for(let c=v.length-1;c>0;c--){const g=Math.floor(Math.random()*(c+1));[v[c],v[g]]=[v[g],v[c]]}return v}function xb(v){return v===0?0:Math.floor(v/2+Math.random()*v)}function Df(v=[0,250,250,500,500,3e3,5e3]){Array.isArray(v)||(v=[0,250,250,500,500,3e3,5e3]);const c=v.length-1;return{backoff(g){return xb(g>c?v[c]:v[g])}}}function ei(v){return v*1e6}function zf(v){return Math.floor(v/1e6)}function h_(v){let x=!0;const E=new Array(v.length);for(let k=0;k<v.length;k++){let S=v.charCodeAt(k);if(S===58||S<33||S>126)throw new St(`'${v[k]}' is not a valid character for a header key`,ct.BadHeader);x&&97<=S&&S<=122?S-=32:!x&&65<=S&&S<=90&&(S+=32),E[k]=S,x=S==45}return String.fromCharCode(...E)}function ro(v=0,c=""){if(v===0&&c!==""||v>0&&c==="")throw new Error("setting status requires both code and description");return new Lo(v,c)}const tf="NATS/1.0";class Lo{_code;headers;_description;constructor(c=0,g=""){this._code=c,this._description=g,this.headers=new Map}[Symbol.iterator](){return this.headers.entries()}size(){return this.headers.size}equals(c){if(c&&this.headers.size===c.headers.size&&this._code===c._code){for(const[g,x]of this.headers){const E=c.values(g);if(x.length!==E.length)return!1;const k=[...x].sort(),S=[...E].sort();for(let l=0;l<k.length;l++)if(k[l]!==S[l])return!1}return!0}return!1}static decode(c){const g=new Lo,E=Rs.decode(c).split(`\r
`),k=E[0];if(k!==tf){let S=k.replace(tf,"").trim();if(S.length>0){g._code=parseInt(S,10),isNaN(g._code)&&(g._code=0);const l=g._code.toString();S=S.replace(l,""),g._description=S.trim()}}return E.length>=1&&E.slice(1).map(S=>{if(S){const l=S.indexOf(":");if(l>-1){const $=S.slice(0,l),oe=S.slice(l+1).trim();g.append($,oe)}}}),g}toString(){if(this.headers.size===0&&this._code===0)return"";let c=tf;this._code>0&&this._description!==""&&(c+=` ${this._code} ${this._description}`);for(const[g,x]of this.headers)for(let E=0;E<x.length;E++)c=`${c}\r
${g}: ${x[E]}`;return`${c}\r
\r
`}encode(){return Ra.encode(this.toString())}static validHeaderValue(c){if(/[\r\n]/.test(c))throw new St("invalid header value - \\r and \\n are not allowed.",ct.BadHeader);return c.trim()}keys(){const c=[];for(const g of this.headers.keys())c.push(g);return c}findKeys(c,g=ks.Exact){const x=this.keys();switch(g){case ks.Exact:return x.filter(E=>E===c);case ks.CanonicalMIME:return c=h_(c),x.filter(E=>E===c);default:{const E=c.toLowerCase();return x.filter(k=>E===k.toLowerCase())}}}get(c,g=ks.Exact){const x=this.findKeys(c,g);if(x.length){const E=this.headers.get(x[0]);if(E)return Array.isArray(E)?E[0]:E}return""}last(c,g=ks.Exact){const x=this.findKeys(c,g);if(x.length){const E=this.headers.get(x[0]);if(E)return Array.isArray(E)?E[E.length-1]:E}return""}has(c,g=ks.Exact){return this.findKeys(c,g).length>0}set(c,g,x=ks.Exact){this.delete(c,x),this.append(c,g,x)}append(c,g,x=ks.Exact){const E=h_(c);x===ks.CanonicalMIME&&(c=E);const k=this.findKeys(c,x);c=k.length>0?k[0]:c;const S=Lo.validHeaderValue(g);let l=this.headers.get(c);l||(l=[],this.headers.set(c,l)),l.push(S)}values(c,g=ks.Exact){const x=[];return this.findKeys(c,g).forEach(k=>{const S=this.headers.get(k);S&&x.push(...S)}),x}delete(c,g=ks.Exact){this.findKeys(c,g).forEach(E=>{this.headers.delete(E)})}get hasError(){return this._code>=300}get status(){return`${this._code} ${this._description}`.trim()}toRecord(){const c={};return this.keys().forEach(g=>{c[g]=this.values(g)}),c}get code(){return this._code}get description(){return this._description}static fromRecord(c){const g=new Lo;for(const x in c)g.headers.set(x,c[x]);return g}}function _f(){return{encode(v){return Ra.encode(v)},decode(v){return Rs.decode(v)}}}function ln(v){return{encode(c){try{return c===void 0&&(c=null),Ra.encode(JSON.stringify(c))}catch(g){throw St.errorForCode(ct.BadJson,g)}},decode(c){try{return JSON.parse(Rs.decode(c),v)}catch(g){throw St.errorForCode(ct.BadJson,g)}}}}function ey(v){return v&&v.data.length===0&&v.headers?.code===503?St.errorForCode(ct.NoResponders):null}class ty{_headers;_msg;_rdata;_reply;_subject;publisher;static jc;constructor(c,g,x){this._msg=c,this._rdata=g,this.publisher=x}get subject(){return this._subject?this._subject:(this._subject=Rs.decode(this._msg.subject),this._subject)}get reply(){return this._reply?this._reply:(this._reply=Rs.decode(this._msg.reply),this._reply)}get sid(){return this._msg.sid}get headers(){if(this._msg.hdr>-1&&!this._headers){const c=this._rdata.subarray(0,this._msg.hdr);this._headers=Lo.decode(c)}return this._headers}get data(){return this._rdata?this._msg.hdr>-1?this._rdata.subarray(this._msg.hdr):this._rdata:new Uint8Array(0)}respond(c=Ls,g){return this.reply?(this.publisher.publish(this.reply,c,g),!0):!1}size(){const c=this._msg.subject.length,g=this._msg.reply?.length||0,x=this._msg.size===-1?0:this._msg.size;return c+g+x}json(c){return ln(c).decode(this.data)}string(){return Rs.decode(this.data)}requestInfo(){const c=this.headers?.get("Nats-Request-Info");return c?JSON.parse(c,function(g,x){return(g==="start"||g==="stop")&&x!==""?new Date(Date.parse(x)):x}):null}}function $l(v){return Md("durable",v)}function as(v){return Md("stream",v)}function Md(v,c=""){if(c==="")throw Error(`${v} name required`);return[".","*",">","/","\\"," ","	",`
`,"\r"].forEach(x=>{if(c.indexOf(x)!==-1){switch(x){case`
`:x="\\n";break;case"\r":x="\\r";break;case"	":x="\\t";break}throw Error(`invalid ${v} name - ${v} name cannot contain '${x}'`)}}),""}function mu(v,c=""){if(c==="")throw Error(`${v} name required`);const g=vb(c);if(g.length)throw new Error(`invalid ${v} name - ${v} name ${g}`)}function vb(v=""){if(v==="")throw Error("name required");const c=/^[-\w]+$/g;if(v.match(c)===null){for(const x of v.split(""))if(x.match(c)===null)return`cannot contain '${x}'`}return""}function yf(v){if(v.data.length>0)return!1;const c=v.headers;return c?c.code>=100&&c.code<200:!1}function xf(v){return yf(v)&&v.headers?.description==="Idle Heartbeat"}function bb(v,c,g){const x=ro(v,c),E={hdr:1,sid:0,size:0},k=new ty(E,Ls,{});return k._headers=x,k._subject=g,k}function Ul(v){if(v.data.length!==0)return null;const c=v.headers;return c?ry(c.code,c.description):null}var Zs;(function(v){v.MaxBatchExceeded="exceeded maxrequestbatch of",v.MaxExpiresExceeded="exceeded maxrequestexpires of",v.MaxBytesExceeded="exceeded maxrequestmaxbytes of",v.MaxMessageSizeExceeded="message size exceeds maxbytes",v.PushConsumer="consumer is push based",v.MaxWaitingExceeded="exceeded maxwaiting",v.IdleHeartbeatMissed="idle heartbeats missed",v.ConsumerDeleted="consumer deleted"})(Zs||(Zs={}));function wb(v){return v.code!==ct.JetStream409?!1:[Zs.MaxBatchExceeded,Zs.MaxExpiresExceeded,Zs.MaxBytesExceeded,Zs.MaxMessageSizeExceeded,Zs.PushConsumer,Zs.IdleHeartbeatMissed,Zs.ConsumerDeleted].find(g=>v.message.indexOf(g)!==-1)!==void 0}function ry(v,c=""){if(v<300)return null;switch(c=c.toLowerCase(),v){case 404:return new St(c,ct.JetStream404NoMessages);case 408:return new St(c,ct.JetStream408RequestTimeout);case 409:{const g=c.startsWith(Zs.IdleHeartbeatMissed)?ct.JetStreamIdleHeartBeat:ct.JetStream409;return new St(c,g)}case 503:return St.errorForCode(ct.JetStreamNotEnabled,new Error(c));default:return c===""&&(c=ct.Unknown),new St(c,`${v}`)}}class Oi{inflight;processed;received;noIterator;iterClosed;done;signal;yields;filtered;pendingFiltered;ingestionFilterFn;protocolFilterFn;dispatchedFn;ctx;_data;err;time;yielding;constructor(){this.inflight=0,this.filtered=0,this.pendingFiltered=0,this.processed=0,this.received=0,this.noIterator=!1,this.done=!1,this.signal=ti(),this.yields=[],this.iterClosed=ti(),this.time=0,this.yielding=!1}[Symbol.asyncIterator](){return this.iterate()}push(c){if(this.done)return;if(typeof c=="function"){this.yields.push(c),this.signal.resolve();return}const{ingest:g,protocol:x}=this.ingestionFilterFn?this.ingestionFilterFn(c,this.ctx||this):{ingest:!0,protocol:!1};g&&(x&&(this.filtered++,this.pendingFiltered++),this.yields.push(c),this.signal.resolve())}async*iterate(){if(this.noIterator)throw new St("unsupported iterator",ct.ApiError);if(this.yielding)throw new St("already yielding",ct.ApiError);this.yielding=!0;try{for(;;){if(this.yields.length===0&&await this.signal,this.err)throw this.err;const c=this.yields;this.inflight=c.length,this.yields=[];for(let g=0;g<c.length;g++){if(typeof c[g]=="function"){const E=c[g];try{E()}catch(k){throw k}if(this.err)throw this.err;continue}if(this.protocolFilterFn?this.protocolFilterFn(c[g]):!0){this.processed++;const E=Date.now();yield c[g],this.time=Date.now()-E,this.dispatchedFn&&c[g]&&this.dispatchedFn(c[g])}else this.pendingFiltered--;this.inflight--}if(this.done)break;this.yields.length===0&&(c.length=0,this.yields=c,this.signal=ti())}}finally{this.stop()}}stop(c){this.done||(this.err=c,this.done=!0,this.signal.resolve(),this.iterClosed.resolve(c))}getProcessed(){return this.noIterator?this.received:this.processed}getPending(){return this.yields.length+this.inflight-this.pendingFiltered}getReceived(){return this.received-this.filtered}}class Rf{interval;maxOut;cancelAfter;timer;autoCancelTimer;last;missed;count;callback;constructor(c,g,x={maxOut:2}){this.interval=c,this.maxOut=x?.maxOut||2,this.cancelAfter=x?.cancelAfter||0,this.last=Date.now(),this.missed=0,this.count=0,this.callback=g,this._schedule()}cancel(){this.autoCancelTimer&&clearTimeout(this.autoCancelTimer),this.timer&&clearInterval(this.timer),this.timer=0,this.autoCancelTimer=0,this.missed=0}work(){this.last=Date.now(),this.missed=0}_change(c,g=0,x=2){this.interval=c,this.maxOut=x,this.cancelAfter=g,this.restart()}restart(){this.cancel(),this._schedule()}_schedule(){this.cancelAfter>0&&(this.autoCancelTimer=setTimeout(()=>{this.cancel()},this.cancelAfter)),this.timer=setInterval(()=>{if(this.count++,Date.now()-this.last>this.interval&&this.missed++,this.missed>=this.maxOut)try{this.callback(this.missed)===!0&&this.cancel()}catch(c){console.log(c)}},this.interval)}}var vf;(function(v){v.Limits="limits",v.Interest="interest",v.Workqueue="workqueue"})(vf||(vf={}));var wu;(function(v){v.Old="old",v.New="new"})(wu||(wu={}));var bf;(function(v){v.File="file",v.Memory="memory"})(bf||(bf={}));var pi;(function(v){v.All="all",v.Last="last",v.New="new",v.StartSequence="by_start_sequence",v.StartTime="by_start_time",v.LastPerSubject="last_per_subject"})(pi||(pi={}));var Fi;(function(v){v.None="none",v.All="all",v.Explicit="explicit",v.NotSet=""})(Fi||(Fi={}));var Wl;(function(v){v.Instant="instant",v.Original="original"})(Wl||(Wl={}));var jo;(function(v){v.None="none",v.S2="s2"})(jo||(jo={}));var xd;(function(v){v.CreateOrUpdate="",v.Update="update",v.Create="create"})(xd||(xd={}));function Tb(v,c={}){return Object.assign({name:v,deliver_policy:pi.All,ack_policy:Fi.Explicit,ack_wait:ei(30*1e3),replay_policy:Wl.Instant},c)}var d_;(function(v){v.API="api_audit",v.StreamAction="stream_action",v.ConsumerAction="consumer_action",v.SnapshotCreate="snapshot_create",v.SnapshotComplete="snapshot_complete",v.RestoreCreate="restore_create",v.RestoreComplete="restore_complete",v.MaxDeliver="max_deliver",v.Terminated="terminated",v.Ack="consumer_ack",v.StreamLeaderElected="stream_leader_elected",v.StreamQuorumLost="stream_quorum_lost",v.ConsumerLeaderElected="consumer_leader_elected",v.ConsumerQuorumLost="consumer_quorum_lost"})(d_||(d_={}));var cs;(function(v){v.StreamSourceHdr="Nats-Stream-Source",v.LastConsumerSeqHdr="Nats-Last-Consumer",v.LastStreamSeqHdr="Nats-Last-Stream",v.ConsumerStalledHdr="Nats-Consumer-Stalled",v.MessageSizeHdr="Nats-Msg-Size",v.RollupHdr="Nats-Rollup",v.RollupValueSubject="sub",v.RollupValueAll="all",v.PendingMessagesHdr="Nats-Pending-Messages",v.PendingBytesHdr="Nats-Pending-Bytes"})(cs||(cs={}));var sn;(function(v){v.LastValue="",v.AllHistory="history",v.UpdatesOnly="updates"})(sn||(sn={}));var jl;(function(v){v.Stream="Nats-Stream",v.Sequence="Nats-Sequence",v.TimeStamp="Nats-Time-Stamp",v.Subject="Nats-Subject"})(jl||(jl={}));var p_;(function(v){v.Stream="Nats-Stream",v.Subject="Nats-Subject",v.Sequence="Nats-Sequence",v.LastSequence="Nats-Last-Sequence",v.Size="Nats-Msg-Size"})(p_||(p_={}));const Ds="KV_";class Sb{config;ordered;mack;stream;callbackFn;max;qname;isBind;filters;constructor(c){this.stream="",this.mack=!1,this.ordered=!1,this.config=Tb("",c||{})}getOpts(){const c={};if(c.config=Object.assign({},this.config),c.config.filter_subject&&(this.filterSubject(c.config.filter_subject),c.config.filter_subject=void 0),c.config.filter_subjects&&(c.config.filter_subjects?.forEach(g=>{this.filterSubject(g)}),c.config.filter_subjects=void 0),c.mack=this.mack,c.stream=this.stream,c.callbackFn=this.callbackFn,c.max=this.max,c.queue=this.qname,c.ordered=this.ordered,c.config.ack_policy=c.ordered?Fi.None:c.config.ack_policy,c.isBind=c.isBind||!1,this.filters)switch(this.filters.length){case 0:break;case 1:c.config.filter_subject=this.filters[0];break;default:c.config.filter_subjects=this.filters}return c}description(c){return this.config.description=c,this}deliverTo(c){return this.config.deliver_subject=c,this}durable(c){return $l(c),this.config.durable_name=c,this}startSequence(c){if(c<=0)throw new Error("sequence must be greater than 0");return this.config.deliver_policy=pi.StartSequence,this.config.opt_start_seq=c,this}startTime(c){return this.config.deliver_policy=pi.StartTime,this.config.opt_start_time=c.toISOString(),this}deliverAll(){return this.config.deliver_policy=pi.All,this}deliverLastPerSubject(){return this.config.deliver_policy=pi.LastPerSubject,this}deliverLast(){return this.config.deliver_policy=pi.Last,this}deliverNew(){return this.config.deliver_policy=pi.New,this}startAtTimeDelta(c){return this.startTime(new Date(Date.now()-c)),this}headersOnly(){return this.config.headers_only=!0,this}ackNone(){return this.config.ack_policy=Fi.None,this}ackAll(){return this.config.ack_policy=Fi.All,this}ackExplicit(){return this.config.ack_policy=Fi.Explicit,this}ackWait(c){return this.config.ack_wait=ei(c),this}maxDeliver(c){return this.config.max_deliver=c,this}filterSubject(c){return this.filters=this.filters||[],this.filters.push(c),this}replayInstantly(){return this.config.replay_policy=Wl.Instant,this}replayOriginal(){return this.config.replay_policy=Wl.Original,this}sample(c){if(c=Math.trunc(c),c<0||c>100)throw new Error("value must be between 0-100");return this.config.sample_freq=`${c}%`,this}limit(c){return this.config.rate_limit_bps=c,this}maxWaiting(c){return this.config.max_waiting=c,this}maxAckPending(c){return this.config.max_ack_pending=c,this}idleHeartbeat(c){return this.config.idle_heartbeat=ei(c),this}flowControl(){return this.config.flow_control=!0,this}deliverGroup(c){return this.queue(c),this}manualAck(){return this.mack=!0,this}maxMessages(c){return this.max=c,this}callback(c){return this.callbackFn=c,this}queue(c){return this.qname=c,this.config.deliver_group=c,this}orderedConsumer(){return this.ordered=!0,this}bind(c,g){return this.stream=c,this.config.durable_name=g,this.isBind=!0,this}bindStream(c){return this.stream=c,this}inactiveEphemeralThreshold(c){return this.config.inactive_threshold=ei(c),this}maxPullBatch(c){return this.config.max_batch=c,this}maxPullRequestExpires(c){return this.config.max_expires=ei(c),this}memory(){return this.config.mem_storage=!0,this}numReplicas(c){return this.config.num_replicas=c,this}consumerName(c){return this.config.name=c,this}}function eo(v){return new Sb(v)}function f_(v){return typeof v.getOpts=="function"}class Pb{static encode(c){if(typeof c=="string")return btoa(c);const g=Array.from(c);return btoa(String.fromCharCode(...g))}static decode(c,g=!1){const x=atob(c);return g?Uint8Array.from(x,E=>E.charCodeAt(0)):x}}class ql{static encode(c){return ql.toB64URLEncoding(Pb.encode(c))}static decode(c,g=!1){return ql.decode(ql.fromB64URLEncoding(c),g)}static toB64URLEncoding(c){return c.replace(/\+/g,"-").replace(/\//g,"_")}static fromB64URLEncoding(c){return c.replace(/_/g,"/").replace(/-/g,"+")}}class Xl{buffers;byteLength;constructor(){this.buffers=[],this.byteLength=0}static concat(...c){let g=0;for(let k=0;k<c.length;k++)g+=c[k].length;const x=new Uint8Array(g);let E=0;for(let k=0;k<c.length;k++)x.set(c[k],E),E+=c[k].length;return x}static fromAscii(c){return c||(c=""),Ra.encode(c)}static toAscii(c){return Rs.decode(c)}reset(){this.buffers.length=0,this.byteLength=0}pack(){if(this.buffers.length>1){const c=new Uint8Array(this.byteLength);let g=0;for(let x=0;x<this.buffers.length;x++)c.set(this.buffers[x],g),g+=this.buffers[x].length;this.buffers.length=0,this.buffers.push(c)}}shift(){if(this.buffers.length){const c=this.buffers.shift();if(c)return this.byteLength-=c.length,c}return new Uint8Array(0)}drain(c){if(this.buffers.length){this.pack();const g=this.buffers.pop();if(g){const x=this.byteLength;(c===void 0||c>x)&&(c=x);const E=g.subarray(0,c);return x>c&&this.buffers.push(g.subarray(c)),this.byteLength=x-c,E}}return new Uint8Array(0)}fill(c,...g){c&&(this.buffers.push(c),this.byteLength+=c.length);for(let x=0;x<g.length;x++)g[x]&&g[x].length&&(this.buffers.push(g[x]),this.byteLength+=g[x].length)}peek(){return this.buffers.length?(this.pack(),this.buffers[0]):new Uint8Array(0)}size(){return this.byteLength}length(){return this.buffers.length}}function Eb(v,c){return c.forEach(function(g){g&&typeof g!="string"&&!Array.isArray(g)&&Object.keys(g).forEach(function(x){if(x!=="default"&&!(x in v)){var E=Object.getOwnPropertyDescriptor(g,x);Object.defineProperty(v,x,E.get?E:{enumerable:!0,get:function(){return g[x]}})}})}),Object.freeze(v)}var Mb=typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{},pu=Mb.performance||{};pu.now||pu.mozNow||pu.msNow||pu.oNow||pu.webkitNow;var m_={versions:{}},Ib=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ab(v){if(v.__esModule)return v;var c=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(v).forEach(function(g){var x=Object.getOwnPropertyDescriptor(v,g);Object.defineProperty(c,g,x.get?x:{enumerable:!0,get:function(){return v[g]}})}),c}var rf,Id={exports:{}},g_={},__=Ab(Eb({__proto__:null,default:g_},[g_]));rf=Id,(function(){var v="input is invalid type",c=typeof window=="object",g=c?window:{};g.JS_SHA256_NO_WINDOW&&(c=!1);var x=!c&&typeof self=="object",E=!g.JS_SHA256_NO_NODE_JS&&m_.versions&&m_.versions.node;E?g=Ib:x&&(g=self);var k=!g.JS_SHA256_NO_COMMON_JS&&rf.exports,S=!g.JS_SHA256_NO_ARRAY_BUFFER&&typeof ArrayBuffer<"u",l="0123456789abcdef".split(""),$=[-2147483648,8388608,32768,128],oe=[24,16,8,0],me=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],we=["hex","array","digest","arrayBuffer"],ye=[];!g.JS_SHA256_NO_NODE_JS&&Array.isArray||(Array.isArray=function(Fe){return Object.prototype.toString.call(Fe)==="[object Array]"}),!S||!g.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(Fe){return typeof Fe=="object"&&Fe.buffer&&Fe.buffer.constructor===ArrayBuffer});var ze=function(Fe,st){return function(Ye){return new xt(st,!0).update(Ye)[Fe]()}},Ke=function(Fe){var st=ze("hex",Fe);E&&(st=ot(st,Fe)),st.create=function(){return new xt(Fe)},st.update=function(Ge){return st.create().update(Ge)};for(var Ye=0;Ye<we.length;++Ye){var He=we[Ye];st[He]=ze(He,Fe)}return st},ot=function(Fe,st){var Ye,He=__,Ge=__.Buffer,pt=st?"sha224":"sha256";return Ye=Ge.from&&!g.JS_SHA256_NO_BUFFER_FROM?Ge.from:function(vt){return new Ge(vt)},function(vt){if(typeof vt=="string")return He.createHash(pt).update(vt,"utf8").digest("hex");if(vt==null)throw new Error(v);return vt.constructor===ArrayBuffer&&(vt=new Uint8Array(vt)),Array.isArray(vt)||ArrayBuffer.isView(vt)||vt.constructor===Ge?He.createHash(pt).update(Ye(vt)).digest("hex"):Fe(vt)}},ge=function(Fe,st){return function(Ye,He){return new At(Ye,st,!0).update(He)[Fe]()}},Pt=function(Fe){var st=ge("hex",Fe);st.create=function(Ge){return new At(Ge,Fe)},st.update=function(Ge,pt){return st.create(Ge).update(pt)};for(var Ye=0;Ye<we.length;++Ye){var He=we[Ye];st[He]=ge(He,Fe)}return st};function xt(Fe,st){st?(ye[0]=ye[16]=ye[1]=ye[2]=ye[3]=ye[4]=ye[5]=ye[6]=ye[7]=ye[8]=ye[9]=ye[10]=ye[11]=ye[12]=ye[13]=ye[14]=ye[15]=0,this.blocks=ye):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Fe?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=Fe}function At(Fe,st,Ye){var He,Ge=typeof Fe;if(Ge==="string"){var pt,vt=[],Qe=Fe.length,Zt=0;for(He=0;He<Qe;++He)(pt=Fe.charCodeAt(He))<128?vt[Zt++]=pt:pt<2048?(vt[Zt++]=192|pt>>>6,vt[Zt++]=128|63&pt):pt<55296||pt>=57344?(vt[Zt++]=224|pt>>>12,vt[Zt++]=128|pt>>>6&63,vt[Zt++]=128|63&pt):(pt=65536+((1023&pt)<<10|1023&Fe.charCodeAt(++He)),vt[Zt++]=240|pt>>>18,vt[Zt++]=128|pt>>>12&63,vt[Zt++]=128|pt>>>6&63,vt[Zt++]=128|63&pt);Fe=vt}else{if(Ge!=="object")throw new Error(v);if(Fe===null)throw new Error(v);if(S&&Fe.constructor===ArrayBuffer)Fe=new Uint8Array(Fe);else if(!(Array.isArray(Fe)||S&&ArrayBuffer.isView(Fe)))throw new Error(v)}Fe.length>64&&(Fe=new xt(st,!0).update(Fe).array());var Ht=[],rt=[];for(He=0;He<64;++He){var Jt=Fe[He]||0;Ht[He]=92^Jt,rt[He]=54^Jt}xt.call(this,st,Ye),this.update(rt),this.oKeyPad=Ht,this.inner=!0,this.sharedMemory=Ye}xt.prototype.update=function(Fe){if(!this.finalized){var st,Ye=typeof Fe;if(Ye!=="string"){if(Ye!=="object")throw new Error(v);if(Fe===null)throw new Error(v);if(S&&Fe.constructor===ArrayBuffer)Fe=new Uint8Array(Fe);else if(!(Array.isArray(Fe)||S&&ArrayBuffer.isView(Fe)))throw new Error(v);st=!0}for(var He,Ge,pt=0,vt=Fe.length,Qe=this.blocks;pt<vt;){if(this.hashed&&(this.hashed=!1,Qe[0]=this.block,this.block=Qe[16]=Qe[1]=Qe[2]=Qe[3]=Qe[4]=Qe[5]=Qe[6]=Qe[7]=Qe[8]=Qe[9]=Qe[10]=Qe[11]=Qe[12]=Qe[13]=Qe[14]=Qe[15]=0),st)for(Ge=this.start;pt<vt&&Ge<64;++pt)Qe[Ge>>>2]|=Fe[pt]<<oe[3&Ge++];else for(Ge=this.start;pt<vt&&Ge<64;++pt)(He=Fe.charCodeAt(pt))<128?Qe[Ge>>>2]|=He<<oe[3&Ge++]:He<2048?(Qe[Ge>>>2]|=(192|He>>>6)<<oe[3&Ge++],Qe[Ge>>>2]|=(128|63&He)<<oe[3&Ge++]):He<55296||He>=57344?(Qe[Ge>>>2]|=(224|He>>>12)<<oe[3&Ge++],Qe[Ge>>>2]|=(128|He>>>6&63)<<oe[3&Ge++],Qe[Ge>>>2]|=(128|63&He)<<oe[3&Ge++]):(He=65536+((1023&He)<<10|1023&Fe.charCodeAt(++pt)),Qe[Ge>>>2]|=(240|He>>>18)<<oe[3&Ge++],Qe[Ge>>>2]|=(128|He>>>12&63)<<oe[3&Ge++],Qe[Ge>>>2]|=(128|He>>>6&63)<<oe[3&Ge++],Qe[Ge>>>2]|=(128|63&He)<<oe[3&Ge++]);this.lastByteIndex=Ge,this.bytes+=Ge-this.start,Ge>=64?(this.block=Qe[16],this.start=Ge-64,this.hash(),this.hashed=!0):this.start=Ge}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},xt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var Fe=this.blocks,st=this.lastByteIndex;Fe[16]=this.block,Fe[st>>>2]|=$[3&st],this.block=Fe[16],st>=56&&(this.hashed||this.hash(),Fe[0]=this.block,Fe[16]=Fe[1]=Fe[2]=Fe[3]=Fe[4]=Fe[5]=Fe[6]=Fe[7]=Fe[8]=Fe[9]=Fe[10]=Fe[11]=Fe[12]=Fe[13]=Fe[14]=Fe[15]=0),Fe[14]=this.hBytes<<3|this.bytes>>>29,Fe[15]=this.bytes<<3,this.hash()}},xt.prototype.hash=function(){var Fe,st,Ye,He,Ge,pt,vt,Qe,Zt,Ht=this.h0,rt=this.h1,Jt=this.h2,Wt=this.h3,Xt=this.h4,Ct=this.h5,Kt=this.h6,Nt=this.h7,hr=this.blocks;for(Fe=16;Fe<64;++Fe)st=((Ge=hr[Fe-15])>>>7|Ge<<25)^(Ge>>>18|Ge<<14)^Ge>>>3,Ye=((Ge=hr[Fe-2])>>>17|Ge<<15)^(Ge>>>19|Ge<<13)^Ge>>>10,hr[Fe]=hr[Fe-16]+st+hr[Fe-7]+Ye|0;for(Zt=rt&Jt,Fe=0;Fe<64;Fe+=4)this.first?(this.is224?(pt=300032,Nt=(Ge=hr[0]-1413257819)-150054599|0,Wt=Ge+24177077|0):(pt=704751109,Nt=(Ge=hr[0]-210244248)-1521486534|0,Wt=Ge+143694565|0),this.first=!1):(st=(Ht>>>2|Ht<<30)^(Ht>>>13|Ht<<19)^(Ht>>>22|Ht<<10),He=(pt=Ht&rt)^Ht&Jt^Zt,Nt=Wt+(Ge=Nt+(Ye=(Xt>>>6|Xt<<26)^(Xt>>>11|Xt<<21)^(Xt>>>25|Xt<<7))+(Xt&Ct^~Xt&Kt)+me[Fe]+hr[Fe])|0,Wt=Ge+(st+He)|0),st=(Wt>>>2|Wt<<30)^(Wt>>>13|Wt<<19)^(Wt>>>22|Wt<<10),He=(vt=Wt&Ht)^Wt&rt^pt,Kt=Jt+(Ge=Kt+(Ye=(Nt>>>6|Nt<<26)^(Nt>>>11|Nt<<21)^(Nt>>>25|Nt<<7))+(Nt&Xt^~Nt&Ct)+me[Fe+1]+hr[Fe+1])|0,st=((Jt=Ge+(st+He)|0)>>>2|Jt<<30)^(Jt>>>13|Jt<<19)^(Jt>>>22|Jt<<10),He=(Qe=Jt&Wt)^Jt&Ht^vt,Ct=rt+(Ge=Ct+(Ye=(Kt>>>6|Kt<<26)^(Kt>>>11|Kt<<21)^(Kt>>>25|Kt<<7))+(Kt&Nt^~Kt&Xt)+me[Fe+2]+hr[Fe+2])|0,st=((rt=Ge+(st+He)|0)>>>2|rt<<30)^(rt>>>13|rt<<19)^(rt>>>22|rt<<10),He=(Zt=rt&Jt)^rt&Wt^Qe,Xt=Ht+(Ge=Xt+(Ye=(Ct>>>6|Ct<<26)^(Ct>>>11|Ct<<21)^(Ct>>>25|Ct<<7))+(Ct&Kt^~Ct&Nt)+me[Fe+3]+hr[Fe+3])|0,Ht=Ge+(st+He)|0,this.chromeBugWorkAround=!0;this.h0=this.h0+Ht|0,this.h1=this.h1+rt|0,this.h2=this.h2+Jt|0,this.h3=this.h3+Wt|0,this.h4=this.h4+Xt|0,this.h5=this.h5+Ct|0,this.h6=this.h6+Kt|0,this.h7=this.h7+Nt|0},xt.prototype.hex=function(){this.finalize();var Fe=this.h0,st=this.h1,Ye=this.h2,He=this.h3,Ge=this.h4,pt=this.h5,vt=this.h6,Qe=this.h7,Zt=l[Fe>>>28&15]+l[Fe>>>24&15]+l[Fe>>>20&15]+l[Fe>>>16&15]+l[Fe>>>12&15]+l[Fe>>>8&15]+l[Fe>>>4&15]+l[15&Fe]+l[st>>>28&15]+l[st>>>24&15]+l[st>>>20&15]+l[st>>>16&15]+l[st>>>12&15]+l[st>>>8&15]+l[st>>>4&15]+l[15&st]+l[Ye>>>28&15]+l[Ye>>>24&15]+l[Ye>>>20&15]+l[Ye>>>16&15]+l[Ye>>>12&15]+l[Ye>>>8&15]+l[Ye>>>4&15]+l[15&Ye]+l[He>>>28&15]+l[He>>>24&15]+l[He>>>20&15]+l[He>>>16&15]+l[He>>>12&15]+l[He>>>8&15]+l[He>>>4&15]+l[15&He]+l[Ge>>>28&15]+l[Ge>>>24&15]+l[Ge>>>20&15]+l[Ge>>>16&15]+l[Ge>>>12&15]+l[Ge>>>8&15]+l[Ge>>>4&15]+l[15&Ge]+l[pt>>>28&15]+l[pt>>>24&15]+l[pt>>>20&15]+l[pt>>>16&15]+l[pt>>>12&15]+l[pt>>>8&15]+l[pt>>>4&15]+l[15&pt]+l[vt>>>28&15]+l[vt>>>24&15]+l[vt>>>20&15]+l[vt>>>16&15]+l[vt>>>12&15]+l[vt>>>8&15]+l[vt>>>4&15]+l[15&vt];return this.is224||(Zt+=l[Qe>>>28&15]+l[Qe>>>24&15]+l[Qe>>>20&15]+l[Qe>>>16&15]+l[Qe>>>12&15]+l[Qe>>>8&15]+l[Qe>>>4&15]+l[15&Qe]),Zt},xt.prototype.toString=xt.prototype.hex,xt.prototype.digest=function(){this.finalize();var Fe=this.h0,st=this.h1,Ye=this.h2,He=this.h3,Ge=this.h4,pt=this.h5,vt=this.h6,Qe=this.h7,Zt=[Fe>>>24&255,Fe>>>16&255,Fe>>>8&255,255&Fe,st>>>24&255,st>>>16&255,st>>>8&255,255&st,Ye>>>24&255,Ye>>>16&255,Ye>>>8&255,255&Ye,He>>>24&255,He>>>16&255,He>>>8&255,255&He,Ge>>>24&255,Ge>>>16&255,Ge>>>8&255,255&Ge,pt>>>24&255,pt>>>16&255,pt>>>8&255,255&pt,vt>>>24&255,vt>>>16&255,vt>>>8&255,255&vt];return this.is224||Zt.push(Qe>>>24&255,Qe>>>16&255,Qe>>>8&255,255&Qe),Zt},xt.prototype.array=xt.prototype.digest,xt.prototype.arrayBuffer=function(){this.finalize();var Fe=new ArrayBuffer(this.is224?28:32),st=new DataView(Fe);return st.setUint32(0,this.h0),st.setUint32(4,this.h1),st.setUint32(8,this.h2),st.setUint32(12,this.h3),st.setUint32(16,this.h4),st.setUint32(20,this.h5),st.setUint32(24,this.h6),this.is224||st.setUint32(28,this.h7),Fe},At.prototype=new xt,At.prototype.finalize=function(){if(xt.prototype.finalize.call(this),this.inner){this.inner=!1;var Fe=this.array();xt.call(this,this.is224,this.sharedMemory),this.update(this.oKeyPad),this.update(Fe),xt.prototype.finalize.call(this)}};var Qt=Ke();Qt.sha256=Qt,Qt.sha224=Ke(!0),Qt.sha256.hmac=Pt(),Qt.sha224.hmac=Pt(!0),k?rf.exports=Qt:(g.sha256=Qt.sha256,g.sha224=Qt.sha224)})();Id.exports;Id.exports.sha224;var y_=Id.exports.sha256;function wf(v){return Fb(v)}function Cb(v){if(!/^[0-9A-Fa-f]+$/.test(v))return!1;const g=/^[0-9A-F]+$/.test(v),x=/^[0-9a-f]+$/.test(v);return g||x?v.length%2===0:!1}function kb(v){return/^[A-Za-z0-9\-_]*(={0,2})?$/.test(v)||/^[A-Za-z0-9+/]*(={0,2})?$/.test(v)}function Db(v){return Cb(v)?"hex":kb(v)?"b64":""}function zb(v){if(v.length%2!==0)throw new Error("hex string must have an even length");const c=new Uint8Array(v.length/2);for(let g=0;g<v.length;g+=2)c[g/2]=parseInt(v.substring(g,g+2),16);return c}function Rb(v){v=v.replace(/-/g,"+"),v=v.replace(/_/g,"/");const c=atob(v);return Uint8Array.from(c,g=>g.charCodeAt(0))}function Fb(v){switch(Db(v)){case"hex":return zb(v);case"b64":return Rb(v)}return null}function Lb(v,c){const g=typeof v=="string"?wf(v):v,x=typeof c=="string"?wf(c):c;if(g===null||x===null||g.length!==x.length)return!1;for(let E=0;E<g.length;E++)if(g[E]!==x[E])return!1;return!0}class iy{token;received;ctx;requestSubject;mux;constructor(c,g,x=!0){this.mux=c,this.requestSubject=g,this.received=0,this.token=Bo.next(),x&&(this.ctx=new Error)}}class Ob extends iy{callback;done;timer;max;opts;constructor(c,g,x={maxWait:1e3}){if(super(c,g),this.opts=x,typeof this.opts.callback!="function")throw new Error("callback is required");this.callback=this.opts.callback,this.max=typeof x.maxMessages=="number"&&x.maxMessages>0?x.maxMessages:-1,this.done=ti(),this.done.then(()=>{this.callback(null,null)}),this.timer=setTimeout(()=>{this.cancel()},x.maxWait)}cancel(c){c&&this.callback(c,null),clearTimeout(this.timer),this.mux.cancel(this),this.done.resolve()}resolver(c,g){c?(this.ctx&&(c.stack+=`

${this.ctx.stack}`),this.cancel(c)):(this.callback(null,g),this.opts.strategy===an.Count&&(this.max--,this.max===0&&this.cancel()),this.opts.strategy===an.JitterTimer&&(clearTimeout(this.timer),this.timer=setTimeout(()=>{this.cancel()},this.opts.jitter||300)),this.opts.strategy===an.SentinelMsg&&g&&g.data.length===0&&this.cancel())}}class sy extends iy{deferred;timer;constructor(c,g,x={timeout:1e3},E=!0){super(c,g,E),this.deferred=ti(),this.timer=Hl(x.timeout,E)}resolver(c,g){this.timer&&this.timer.cancel(),c?(this.ctx&&(c.stack+=`

${this.ctx.stack}`),this.deferred.reject(c)):this.deferred.resolve(g),this.cancel()}cancel(c){this.timer&&this.timer.cancel(),this.mux.cancel(this),this.deferred.reject(c||St.errorForCode(ct.Cancelled))}}const Bb="$JS.API";function jb(v){return v=v||{},v.domain&&(v.apiPrefix=`$JS.${v.domain}.API`,delete v.domain),Ed({apiPrefix:Bb,timeout:5e3},v)}class Mu{nc;opts;prefix;timeout;jc;constructor(c,g){this.nc=c,this.opts=jb(g),this._parseOpts(),this.prefix=this.opts.apiPrefix,this.timeout=this.opts.timeout,this.jc=ln()}getOptions(){return Object.assign({},this.opts)}_parseOpts(){let c=this.opts.apiPrefix;if(!c||c.length===0)throw new Error("invalid empty prefix");c[c.length-1]==="."&&(c=c.substr(0,c.length-1)),this.opts.apiPrefix=c}async _request(c,g=null,x){x=x||{},x.timeout=this.timeout;let E=Ls;g&&(E=this.jc.encode(g));let{retries:k}=x;k=k||1,k=k===-1?Number.MAX_SAFE_INTEGER:k;const S=Df();for(let l=0;l<k;l++)try{const $=await this.nc.request(c,E,x);return this.parseJsResponse($)}catch($){const oe=$;if((oe.code==="503"||oe.code===ct.Timeout)&&l+1<k)await Jl(S.backoff(l));else throw $}}async findStream(c){const g={subject:c},E=await this._request(`${this.prefix}.STREAM.NAMES`,g);if(!E.streams||E.streams.length!==1)throw new Error("no stream matches subject");return E.streams[0]}getConnection(){return this.nc}parseJsResponse(c){const g=this.jc.decode(c.data),x=g;if(x.error){const E=ry(x.error.code,x.error.description);if(E!==null)throw E.api_error=x.error,E}return g}}class gu{err;offset;pageInfo;subject;jsm;filter;payload;constructor(c,g,x,E){if(!c)throw new Error("subject is required");this.subject=c,this.jsm=x,this.offset=0,this.pageInfo={},this.filter=g,this.payload=E||{}}async next(){if(this.err)return[];if(this.pageInfo&&this.offset>=this.pageInfo.total)return[];const c={offset:this.offset};this.payload&&Object.assign(c,this.payload);try{const g=await this.jsm._request(this.subject,c,{timeout:this.jsm.timeout});this.pageInfo=g;const x=this.countResponse(g);return x===0?[]:(this.offset+=x,this.filter(g))}catch(g){throw this.err=g,g}}countResponse(c){switch(c?.type){case"io.nats.jetstream.api.v1.stream_names_response":case"io.nats.jetstream.api.v1.stream_list_response":return c.streams?.length||0;case"io.nats.jetstream.api.v1.consumer_list_response":return c.consumers?.length||0;default:return console.error(`jslister.ts: unknown API response for paged output: ${c?.type}`),c.streams?.length||0}return 0}async*[Symbol.asyncIterator](){let c=await this.next();for(;c.length>0;){for(const g of c)yield g;c=await this.next()}}}function Da(v=""){const c=v.match(/(\d+).(\d+).(\d+)/);if(c)return{major:parseInt(c[1]),minor:parseInt(c[2]),micro:parseInt(c[3])};throw new Error(`'${v}' is not a semver value`)}function Tf(v,c){return v.major<c.major?-1:v.major>c.major?1:v.minor<c.minor?-1:v.minor>c.minor?1:v.micro<c.micro?-1:v.micro>c.micro?1:0}var fr;(function(v){v.JS_KV="js_kv",v.JS_OBJECTSTORE="js_objectstore",v.JS_PULL_MAX_BYTES="js_pull_max_bytes",v.JS_NEW_CONSUMER_CREATE_API="js_new_consumer_create",v.JS_ALLOW_DIRECT="js_allow_direct",v.JS_MULTIPLE_CONSUMER_FILTER="js_multiple_consumer_filter",v.JS_SIMPLIFICATION="js_simplification",v.JS_STREAM_CONSUMER_METADATA="js_stream_consumer_metadata",v.JS_CONSUMER_FILTER_SUBJECTS="js_consumer_filter_subjects",v.JS_STREAM_FIRST_SEQ="js_stream_first_seq",v.JS_STREAM_SUBJECT_TRANSFORM="js_stream_subject_transform",v.JS_STREAM_SOURCE_SUBJECT_TRANSFORM="js_stream_source_subject_transform",v.JS_STREAM_COMPRESSION="js_stream_compression",v.JS_DEFAULT_CONSUMER_LIMITS="js_default_consumer_limits",v.JS_BATCH_DIRECT_GET="js_batch_direct_get"})(fr||(fr={}));class Nb{server;features;disabled;constructor(c){this.features=new Map,this.disabled=[],this.update(c)}resetDisabled(){this.disabled.length=0,this.update(this.server)}disable(c){this.disabled.push(c),this.update(this.server)}isDisabled(c){return this.disabled.indexOf(c)!==-1}update(c){typeof c=="string"&&(c=Da(c)),this.server=c,this.set(fr.JS_KV,"2.6.2"),this.set(fr.JS_OBJECTSTORE,"2.6.3"),this.set(fr.JS_PULL_MAX_BYTES,"2.8.3"),this.set(fr.JS_NEW_CONSUMER_CREATE_API,"2.9.0"),this.set(fr.JS_ALLOW_DIRECT,"2.9.0"),this.set(fr.JS_MULTIPLE_CONSUMER_FILTER,"2.10.0"),this.set(fr.JS_SIMPLIFICATION,"2.9.4"),this.set(fr.JS_STREAM_CONSUMER_METADATA,"2.10.0"),this.set(fr.JS_CONSUMER_FILTER_SUBJECTS,"2.10.0"),this.set(fr.JS_STREAM_FIRST_SEQ,"2.10.0"),this.set(fr.JS_STREAM_SUBJECT_TRANSFORM,"2.10.0"),this.set(fr.JS_STREAM_SOURCE_SUBJECT_TRANSFORM,"2.10.0"),this.set(fr.JS_STREAM_COMPRESSION,"2.10.0"),this.set(fr.JS_DEFAULT_CONSUMER_LIMITS,"2.10.0"),this.set(fr.JS_BATCH_DIRECT_GET,"2.11.0"),this.disabled.forEach(g=>{this.features.delete(g)})}set(c,g){this.features.set(c,{min:g,ok:Tf(this.server,Da(g))>=0})}get(c){return this.features.get(c)||{min:"unknown",ok:!1}}supports(c){return this.get(c)?.ok||!1}require(c){return typeof c=="string"&&(c=Da(c)),Tf(this.server,c)>=0}}class vd extends Mu{constructor(c,g){super(c,g)}async add(c,g,x=xd.Create){if(as(c),g.deliver_group&&g.flow_control)throw new Error("jetstream flow control is not supported with queue groups");if(g.deliver_group&&g.idle_heartbeat)throw new Error("jetstream idle heartbeat is not supported with queue groups");const E={};E.config=g,E.stream_name=c,E.action=x,E.config.durable_name&&$l(E.config.durable_name);const k=this.nc;let{min:S,ok:l}=k.features.get(fr.JS_NEW_CONSUMER_CREATE_API);const $=g.name===""?void 0:g.name;if($&&!l)throw new Error(`consumer 'name' requires server ${S}`);if($)try{Md("name",$)}catch(ye){const ze=ye.message,Ke=ze.indexOf("cannot contain");throw Ke!==-1?new Error(`consumer 'name' ${ze.substring(Ke)}`):ye}let oe,me="";if(Array.isArray(g.filter_subjects)){const{min:ye,ok:ze}=k.features.get(fr.JS_MULTIPLE_CONSUMER_FILTER);if(!ze)throw new Error(`consumer 'filter_subjects' requires server ${ye}`);l=!1}if(g.metadata){const{min:ye,ok:ze}=k.features.get(fr.JS_STREAM_CONSUMER_METADATA);if(!ze)throw new Error(`consumer 'metadata' requires server ${ye}`)}if(l&&(me=g.name??g.durable_name??""),me!==""){let ye=g.filter_subject??void 0;ye===">"&&(ye=void 0),oe=ye!==void 0?`${this.prefix}.CONSUMER.CREATE.${c}.${me}.${ye}`:`${this.prefix}.CONSUMER.CREATE.${c}.${me}`}else oe=g.durable_name?`${this.prefix}.CONSUMER.DURABLE.CREATE.${c}.${g.durable_name}`:`${this.prefix}.CONSUMER.CREATE.${c}`;return await this._request(oe,E)}async update(c,g,x){const E=await this.info(c,g),k=x;return this.add(c,Object.assign(E.config,k),xd.Update)}async info(c,g){return as(c),$l(g),await this._request(`${this.prefix}.CONSUMER.INFO.${c}.${g}`)}async delete(c,g){return as(c),$l(g),(await this._request(`${this.prefix}.CONSUMER.DELETE.${c}.${g}`)).success}list(c){as(c);const g=E=>E.consumers,x=`${this.prefix}.CONSUMER.LIST.${c}`;return new gu(x,g,this)}pause(c,g,x){const E=`${this.prefix}.CONSUMER.PAUSE.${c}.${g}`,k={pause_until:x.toISOString()};return this._request(E,k)}resume(c,g){return this.pause(c,g,new Date(0))}}function Bl(v,c,g=!1){if(g===!0&&!v)throw St.errorForCode(ct.ApiError,new Error(`${c} is not a function`));if(v&&typeof v!="function")throw St.errorForCode(ct.ApiError,new Error(`${c} is not a function`))}class Vb extends Oi{sub;adapter;subIterDone;constructor(c,g,x){super(),Bl(x.adapter,"adapter",!0),this.adapter=x.adapter,x.callback&&Bl(x.callback,"callback"),this.noIterator=typeof x.callback=="function",x.ingestionFilterFn&&(Bl(x.ingestionFilterFn,"ingestionFilterFn"),this.ingestionFilterFn=x.ingestionFilterFn),x.protocolFilterFn&&(Bl(x.protocolFilterFn,"protocolFilterFn"),this.protocolFilterFn=x.protocolFilterFn),x.dispatchedFn&&(Bl(x.dispatchedFn,"dispatchedFn"),this.dispatchedFn=x.dispatchedFn),x.cleanupFn&&Bl(x.cleanupFn,"cleanupFn");let E=(oe,me)=>{this.callback(oe,me)};if(x.callback){const oe=x.callback;E=(me,we)=>{const[ye,ze]=this.adapter(me,we);if(ye){oe(ye,null);return}const{ingest:Ke}=this.ingestionFilterFn?this.ingestionFilterFn(ze,this):{ingest:!0};Ke&&(!this.protocolFilterFn||this.protocolFilterFn(ze))&&(oe(ye,ze),this.dispatchedFn&&ze&&this.dispatchedFn(ze))}}const{max:k,queue:S,timeout:l}=x,$={queue:S,timeout:l,callback:E};k&&k>0&&($.max=k),this.sub=c.subscribe(g,$),x.cleanupFn&&(this.sub.cleanupFn=x.cleanupFn),this.noIterator||this.iterClosed.then(()=>{this.unsubscribe()}),this.subIterDone=ti(),Promise.all([this.sub.closed,this.iterClosed]).then(()=>{this.subIterDone.resolve()}).catch(()=>{this.subIterDone.resolve()}),(async oe=>{await oe.closed,this.stop()})(this.sub).then().catch()}unsubscribe(c){this.sub.unsubscribe(c)}drain(){return this.sub.drain()}isDraining(){return this.sub.isDraining()}isClosed(){return this.sub.isClosed()}callback(c,g){this.sub.cancelTimeout();const[x,E]=this.adapter(c,g);x&&this.stop(x),E&&this.push(E)}getSubject(){return this.sub.getSubject()}getReceived(){return this.sub.getReceived()}getProcessed(){return this.sub.getProcessed()}getPending(){return this.sub.getPending()}getID(){return this.sub.getID()}getMax(){return this.sub.getMax()}get closed(){return this.sub.closed}}let Fs;function $b(v){Fs=v}function ny(){return Fs!==void 0&&Fs.defaultPort!==void 0?Fs.defaultPort:4222}function sf(){return Fs!==void 0&&Fs.urlParseFn?Fs.urlParseFn:void 0}function Ub(){if(!Fs||typeof Fs.factory!="function")throw new Error("transport fn is not set");return Fs.factory()}function Sf(){return Fs!==void 0&&Fs.dnsResolveFn?Fs.dnsResolveFn:void 0}const ud=`\r
`,bd=Xl.fromAscii(ud),qb=new Uint8Array(bd)[0],Gb=new Uint8Array(bd)[1];function Zb(v){for(let c=0;c<v.length;c++){const g=c+1;if(v.byteLength>g&&v[c]===qb&&v[g]===Gb)return g+1}return 0}function Hb(v){const c=Zb(v);if(c>0){const x=new Uint8Array(v).slice(0,c);return Rs.decode(x)}return""}const Wb=4,oy=48,Xb=65,Yb=97;function Jb(v,c,g,x){const E=new Uint8Array(16);return[0,0,0,0,0,0,0,0,0,0,255,255].forEach((S,l)=>{E[l]=S}),E[12]=v,E[13]=c,E[14]=g,E[15]=x,E}function Pf(v){return Kb(v)!==void 0}function Kb(v){for(let c=0;c<v.length;c++)switch(v[c]){case".":return ay(v);case":":return Qb(v)}}function ay(v){const c=new Uint8Array(4);for(let g=0;g<4;g++){if(v.length===0)return;if(g>0){if(v[0]!==".")return;v=v.substring(1)}const{n:x,c:E,ok:k}=e1(v);if(!k||x>255)return;v=v.substring(E),c[g]=x}return Jb(c[0],c[1],c[2],c[3])}function Qb(v){const c=new Uint8Array(16);let g=-1;if(v.length>=2&&v[0]===":"&&v[1]===":"&&(g=0,v=v.substring(2),v.length===0))return c;let x=0;for(;x<16;){const{n:E,c:k,ok:S}=t1(v);if(!S||E>65535)return;if(k<v.length&&v[k]==="."){if(g<0&&x!=12||x+4>16)return;const l=ay(v);if(l===void 0)return;c[x]=l[12],c[x+1]=l[13],c[x+2]=l[14],c[x+3]=l[15],v="",x+=Wb;break}if(c[x]=E>>8,c[x+1]=E,x+=2,v=v.substring(k),v.length===0)break;if(v[0]!==":"||v.length==1)return;if(v=v.substring(1),v[0]===":"){if(g>=0)return;if(g=x,v=v.substring(1),v.length===0)break}}if(v.length===0){if(x<16){if(g<0)return;const E=16-x;for(let k=x-1;k>=g;k--)c[k+E]=c[k];for(let k=g+E-1;k>=g;k--)c[k]=0}else if(g>=0)return;return c}}function e1(v){let c=0,g=0;for(c=0;c<v.length&&48<=v.charCodeAt(c)&&v.charCodeAt(c)<=57;c++)if(g=g*10+(v.charCodeAt(c)-oy),g>=16777215)return{n:16777215,c,ok:!1};return c===0?{n:0,c:0,ok:!1}:{n:g,c,ok:!0}}function t1(v){let c=0,g=0;for(g=0;g<v.length;g++){if(48<=v.charCodeAt(g)&&v.charCodeAt(g)<=57)c*=16,c+=v.charCodeAt(g)-oy;else if(97<=v.charCodeAt(g)&&v.charCodeAt(g)<=102)c*=16,c+=v.charCodeAt(g)-Yb+10;else if(65<=v.charCodeAt(g)&&v.charCodeAt(g)<=70)c*=16,c+=v.charCodeAt(g)-Xb+10;else break;if(c>=16777215)return{n:0,c:g,ok:!1}}return g===0?{n:0,c:g,ok:!1}:{n:c,c:g,ok:!0}}function r1(v){return v.indexOf("[")!==-1||v.indexOf("::")!==-1?!1:v.indexOf(".")!==-1||v.split(":").length<=2}function Ef(v){return!r1(v)}function i1(v){const c="::FFFF:",g=v.toUpperCase().indexOf(c);if(g!==-1&&v.indexOf(".")!==-1){let x=v.substring(g+c.length);return x=x.replace("[",""),x.replace("]","")}return v}function s1(v){v=v.trim(),v.match(/^(.*:\/\/)(.*)/m)&&(v=v.replace(/^(.*:\/\/)(.*)/gm,"$2")),v=i1(v),Ef(v)&&v.indexOf("[")===-1&&(v=`[${v}]`);const c=Ef(v)?v.match(/(]:)(\d+)/):v.match(/(:)(\d+)/),g=c&&c.length===3&&c[1]&&c[2]?parseInt(c[2]):4222,x=g===80?"https":"http",E=new URL(`${x}://${v}`);E.port=`${g}`;let k=E.hostname;return k.charAt(0)==="["&&(k=k.substring(1,k.length-1)),{listen:E.host,hostname:k,port:g}}class vu{src;listen;hostname;port;didConnect;reconnects;lastConnect;gossiped;tlsName;resolves;constructor(c,g=!1){this.src=c,this.tlsName="";const x=s1(c);this.listen=x.listen,this.hostname=x.hostname,this.port=x.port,this.didConnect=!1,this.reconnects=0,this.lastConnect=0,this.gossiped=g}toString(){return this.listen}async resolve(c){if(!c.fn||c.resolve===!1)return[this];const g=[];if(Pf(this.hostname))return[this];{const x=await c.fn(this.hostname);c.debug&&console.log(`resolve ${this.hostname} = ${x.join(",")}`);for(const E of x){const k=this.port===80?"https":"http",S=new URL(`${k}://${Ef(E)?"["+E+"]":E}`);S.port=`${this.port}`;const l=new vu(S.host,!1);l.tlsName=this.hostname,g.push(l)}}return c.randomize&&Q_(g),this.resolves=g,g}}class n1{firstSelect;servers;currentServer;tlsName;randomize;constructor(c=[],g={}){this.firstSelect=!0,this.servers=[],this.tlsName="",this.randomize=g.randomize||!1;const x=sf();c&&(c.forEach(E=>{E=x?x(E):E,this.servers.push(new vu(E))}),this.randomize&&(this.servers=Q_(this.servers))),this.servers.length===0&&this.addServer(`${gf}:${ny()}`,!1),this.currentServer=this.servers[0]}clear(){this.servers.length=0}updateTLSName(){const c=this.getCurrentServer();Pf(c.hostname)||(this.tlsName=c.hostname,this.servers.forEach(g=>{g.gossiped&&(g.tlsName=this.tlsName)}))}getCurrentServer(){return this.currentServer}addServer(c,g=!1){const x=sf();c=x?x(c):c;const E=new vu(c,g);Pf(E.hostname)&&(E.tlsName=this.tlsName),this.servers.push(E)}selectServer(){if(this.firstSelect)return this.firstSelect=!1,this.currentServer;const c=this.servers.shift();return c&&(this.servers.push(c),this.currentServer=c),c}removeCurrentServer(){this.removeServer(this.currentServer)}removeServer(c){if(c){const g=this.servers.indexOf(c);this.servers.splice(g,1)}}length(){return this.servers.length}next(){return this.servers.length?this.servers[0]:void 0}getServers(){return this.servers}update(c,g){const x=[];let E=[];const k=sf(),S=new Map;c.connect_urls&&c.connect_urls.length>0&&c.connect_urls.forEach($=>{$=k?k($,g):$;const oe=new vu($,!0);S.set($,oe)});const l=[];return this.servers.forEach(($,oe)=>{const me=$.listen;$.gossiped&&this.currentServer.listen!==me&&S.get(me)===void 0&&l.push(oe),S.delete(me)}),l.reverse(),l.forEach($=>{const oe=this.servers.splice($,1);E=E.concat(oe[0].listen)}),S.forEach(($,oe)=>{this.servers.push($),x.push(oe)}),{added:x,deleted:E}}}class o1{baseInbox;reqs;constructor(){this.reqs=new Map}size(){return this.reqs.size}init(c){return this.baseInbox=`${An(c)}.`,this.baseInbox}add(c){isNaN(c.received)||(c.received=0),this.reqs.set(c.token,c)}get(c){return this.reqs.get(c)}cancel(c){this.reqs.delete(c.token)}getToken(c){const g=c.subject||"";return g.indexOf(this.baseInbox)===0?g.substring(this.baseInbox.length):null}all(){return Array.from(this.reqs.values())}handleError(c,g){if(g&&g.permissionContext){if(c)return this.all().forEach(E=>{E.resolver(g,{})}),!0;const x=g.permissionContext;if(x.operation==="publish"){const E=this.all().find(k=>k.requestSubject===x.subject);if(E)return E.resolver(g,{}),!0}}return!1}dispatcher(){return(c,g)=>{const x=this.getToken(g);if(x){const E=this.get(x);E&&(c===null&&g.headers&&(c=ey(g)),E.resolver(c,g))}}}close(){const c=St.errorForCode(ct.Timeout);this.reqs.forEach(g=>{g.resolver(c,{})})}}class a1{ph;interval;maxOut;timer;pendings;constructor(c,g,x){this.ph=c,this.interval=g,this.maxOut=x,this.pendings=[]}start(){this.cancel(),this._schedule()}cancel(c){this.timer&&(clearTimeout(this.timer),this.timer=void 0),this._reset(),c&&this.ph.disconnect()}_schedule(){this.timer=setTimeout(()=>{if(this.ph.dispatchStatus({type:Vl.PingTimer,data:`${this.pendings.length+1}`}),this.pendings.length===this.maxOut){this.cancel(!0);return}const c=ti();this.ph.flush(c).then(()=>{this._reset()}).catch(()=>{this.cancel()}),this.pendings.push(c),this._schedule()},this.interval)}_reset(){this.pendings=this.pendings.filter(c=>(c.resolve(),!1))}}class l1 extends Error{constructor(c){super(c),this.name="AssertionError"}}function c1(v,c="Assertion failed."){if(!v)throw new l1(c)}const x_=32*1024,nf=2**32-2;function nd(v,c,g=0){const x=c.byteLength-g;return v.byteLength>x&&(v=v.subarray(0,x)),c.set(v,g),v.byteLength}class of{_buf;_off;constructor(c){if(this._off=0,c==null){this._buf=new Uint8Array(0);return}this._buf=new Uint8Array(c)}bytes(c={copy:!0}){return c.copy===!1?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(c){if(c===0){this.reset();return}if(c<0||c>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+c)}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(c){const g=this._buf.byteLength;return c<=this.capacity-g?(this._reslice(g+c),g):-1}_reslice(c){c1(c<=this._buf.buffer.byteLength),this._buf=new Uint8Array(this._buf.buffer,0,c)}readByte(){const c=new Uint8Array(1);return this.read(c)?c[0]:null}read(c){if(this.empty())return this.reset(),c.byteLength===0?0:null;const g=nd(this._buf.subarray(this._off),c);return this._off+=g,g}writeByte(c){return this.write(Uint8Array.of(c))}writeString(c){return this.write(Ra.encode(c))}write(c){const g=this._grow(c.byteLength);return nd(c,this._buf,g)}_grow(c){const g=this.length;g===0&&this._off!==0&&this.reset();const x=this._tryGrowByReslice(c);if(x>=0)return x;const E=this.capacity;if(c<=Math.floor(E/2)-g)nd(this._buf.subarray(this._off),this._buf);else{if(E+c>nf)throw new Error("The buffer cannot be grown beyond the maximum size.");{const k=new Uint8Array(Math.min(2*E+c,nf));nd(this._buf.subarray(this._off),k),this._buf=k}}return this._off=0,this._reslice(Math.min(g+c,nf)),g}grow(c){if(c<0)throw Error("Buffer._grow: negative count");const g=this._grow(c);this._reslice(g)}readFrom(c){let g=0;const x=new Uint8Array(x_);for(;;){const E=this.capacity-this.length<x_,k=E?x:new Uint8Array(this._buf.buffer,this.length),S=c.read(k);if(S===null)return g;E?this.write(k.subarray(0,S)):this._reslice(this.length+S),g+=S}}}var ls;(function(v){v[v.OK=0]="OK",v[v.ERR=1]="ERR",v[v.MSG=2]="MSG",v[v.INFO=3]="INFO",v[v.PING=4]="PING",v[v.PONG=5]="PONG"})(ls||(ls={}));function v_(){const v={};return v.sid=-1,v.hdr=-1,v.size=-1,v}const u1=48;class b_{dispatcher;state;as;drop;hdr;ma;argBuf;msgBuf;constructor(c){this.dispatcher=c,this.state=mt.OP_START,this.as=0,this.drop=0,this.hdr=0}parse(c){let g;for(g=0;g<c.length;g++){const x=c[g];switch(this.state){case mt.OP_START:switch(x){case gt.M:case gt.m:this.state=mt.OP_M,this.hdr=-1,this.ma=v_();break;case gt.H:case gt.h:this.state=mt.OP_H,this.hdr=0,this.ma=v_();break;case gt.P:case gt.p:this.state=mt.OP_P;break;case gt.PLUS:this.state=mt.OP_PLUS;break;case gt.MINUS:this.state=mt.OP_MINUS;break;case gt.I:case gt.i:this.state=mt.OP_I;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_H:switch(x){case gt.M:case gt.m:this.state=mt.OP_M;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_M:switch(x){case gt.S:case gt.s:this.state=mt.OP_MS;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_MS:switch(x){case gt.G:case gt.g:this.state=mt.OP_MSG;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_MSG:switch(x){case gt.SPACE:case gt.TAB:this.state=mt.OP_MSG_SPC;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_MSG_SPC:switch(x){case gt.SPACE:case gt.TAB:continue;default:this.state=mt.MSG_ARG,this.as=g}break;case mt.MSG_ARG:switch(x){case gt.CR:this.drop=1;break;case gt.NL:{const E=this.argBuf?this.argBuf.bytes():c.subarray(this.as,g-this.drop);this.processMsgArgs(E),this.drop=0,this.as=g+1,this.state=mt.MSG_PAYLOAD,g=this.as+this.ma.size-1;break}default:this.argBuf&&this.argBuf.writeByte(x)}break;case mt.MSG_PAYLOAD:if(this.msgBuf)if(this.msgBuf.length>=this.ma.size){const E=this.msgBuf.bytes({copy:!1});this.dispatcher.push({kind:ls.MSG,msg:this.ma,data:E}),this.argBuf=void 0,this.msgBuf=void 0,this.state=mt.MSG_END}else{let E=this.ma.size-this.msgBuf.length;const k=c.length-g;k<E&&(E=k),E>0?(this.msgBuf.write(c.subarray(g,g+E)),g=g+E-1):this.msgBuf.writeByte(x)}else g-this.as>=this.ma.size&&(this.dispatcher.push({kind:ls.MSG,msg:this.ma,data:c.subarray(this.as,g)}),this.argBuf=void 0,this.msgBuf=void 0,this.state=mt.MSG_END);break;case mt.MSG_END:if(x===gt.NL)this.drop=0,this.as=g+1,this.state=mt.OP_START;else continue;break;case mt.OP_PLUS:switch(x){case gt.O:case gt.o:this.state=mt.OP_PLUS_O;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_PLUS_O:switch(x){case gt.K:case gt.k:this.state=mt.OP_PLUS_OK;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_PLUS_OK:x===gt.NL&&(this.dispatcher.push({kind:ls.OK}),this.drop=0,this.state=mt.OP_START);break;case mt.OP_MINUS:switch(x){case gt.E:case gt.e:this.state=mt.OP_MINUS_E;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_MINUS_E:switch(x){case gt.R:case gt.r:this.state=mt.OP_MINUS_ER;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_MINUS_ER:switch(x){case gt.R:case gt.r:this.state=mt.OP_MINUS_ERR;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_MINUS_ERR:switch(x){case gt.SPACE:case gt.TAB:this.state=mt.OP_MINUS_ERR_SPC;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_MINUS_ERR_SPC:switch(x){case gt.SPACE:case gt.TAB:continue;default:this.state=mt.MINUS_ERR_ARG,this.as=g}break;case mt.MINUS_ERR_ARG:switch(x){case gt.CR:this.drop=1;break;case gt.NL:{let E;this.argBuf?(E=this.argBuf.bytes(),this.argBuf=void 0):E=c.subarray(this.as,g-this.drop),this.dispatcher.push({kind:ls.ERR,data:E}),this.drop=0,this.as=g+1,this.state=mt.OP_START;break}default:this.argBuf&&this.argBuf.write(Uint8Array.of(x))}break;case mt.OP_P:switch(x){case gt.I:case gt.i:this.state=mt.OP_PI;break;case gt.O:case gt.o:this.state=mt.OP_PO;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_PO:switch(x){case gt.N:case gt.n:this.state=mt.OP_PON;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_PON:switch(x){case gt.G:case gt.g:this.state=mt.OP_PONG;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_PONG:x===gt.NL&&(this.dispatcher.push({kind:ls.PONG}),this.drop=0,this.state=mt.OP_START);break;case mt.OP_PI:switch(x){case gt.N:case gt.n:this.state=mt.OP_PIN;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_PIN:switch(x){case gt.G:case gt.g:this.state=mt.OP_PING;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_PING:x===gt.NL&&(this.dispatcher.push({kind:ls.PING}),this.drop=0,this.state=mt.OP_START);break;case mt.OP_I:switch(x){case gt.N:case gt.n:this.state=mt.OP_IN;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_IN:switch(x){case gt.F:case gt.f:this.state=mt.OP_INF;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_INF:switch(x){case gt.O:case gt.o:this.state=mt.OP_INFO;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_INFO:switch(x){case gt.SPACE:case gt.TAB:this.state=mt.OP_INFO_SPC;break;default:throw this.fail(c.subarray(g))}break;case mt.OP_INFO_SPC:switch(x){case gt.SPACE:case gt.TAB:continue;default:this.state=mt.INFO_ARG,this.as=g}break;case mt.INFO_ARG:switch(x){case gt.CR:this.drop=1;break;case gt.NL:{let E;this.argBuf?(E=this.argBuf.bytes(),this.argBuf=void 0):E=c.subarray(this.as,g-this.drop),this.dispatcher.push({kind:ls.INFO,data:E}),this.drop=0,this.as=g+1,this.state=mt.OP_START;break}default:this.argBuf&&this.argBuf.writeByte(x)}break;default:throw this.fail(c.subarray(g))}}(this.state===mt.MSG_ARG||this.state===mt.MINUS_ERR_ARG||this.state===mt.INFO_ARG)&&!this.argBuf&&(this.argBuf=new of(c.subarray(this.as,g-this.drop))),this.state===mt.MSG_PAYLOAD&&!this.msgBuf&&(this.argBuf||this.cloneMsgArg(),this.msgBuf=new of(c.subarray(this.as)))}cloneMsgArg(){const c=this.ma.subject.length,g=this.ma.reply?this.ma.reply.length:0,x=new Uint8Array(c+g);x.set(this.ma.subject),this.ma.reply&&x.set(this.ma.reply,c),this.argBuf=new of(x),this.ma.subject=x.subarray(0,c),this.ma.reply&&(this.ma.reply=x.subarray(c))}processMsgArgs(c){if(this.hdr>=0)return this.processHeaderMsgArgs(c);const g=[];let x=-1;for(let E=0;E<c.length;E++)switch(c[E]){case gt.SPACE:case gt.TAB:case gt.CR:case gt.NL:x>=0&&(g.push(c.subarray(x,E)),x=-1);break;default:x<0&&(x=E)}switch(x>=0&&g.push(c.subarray(x)),g.length){case 3:this.ma.subject=g[0],this.ma.sid=this.protoParseInt(g[1]),this.ma.reply=void 0,this.ma.size=this.protoParseInt(g[2]);break;case 4:this.ma.subject=g[0],this.ma.sid=this.protoParseInt(g[1]),this.ma.reply=g[2],this.ma.size=this.protoParseInt(g[3]);break;default:throw this.fail(c,"processMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(c,"processMsgArgs Bad or Missing Sid Error");if(this.ma.size<0)throw this.fail(c,"processMsgArgs Bad or Missing Size Error")}fail(c,g=""){return g?g=`${g} [${this.state}]`:g=`parse error [${this.state}]`,new Error(`${g}: ${Rs.decode(c)}`)}processHeaderMsgArgs(c){const g=[];let x=-1;for(let E=0;E<c.length;E++)switch(c[E]){case gt.SPACE:case gt.TAB:case gt.CR:case gt.NL:x>=0&&(g.push(c.subarray(x,E)),x=-1);break;default:x<0&&(x=E)}switch(x>=0&&g.push(c.subarray(x)),g.length){case 4:this.ma.subject=g[0],this.ma.sid=this.protoParseInt(g[1]),this.ma.reply=void 0,this.ma.hdr=this.protoParseInt(g[2]),this.ma.size=this.protoParseInt(g[3]);break;case 5:this.ma.subject=g[0],this.ma.sid=this.protoParseInt(g[1]),this.ma.reply=g[2],this.ma.hdr=this.protoParseInt(g[3]),this.ma.size=this.protoParseInt(g[4]);break;default:throw this.fail(c,"processHeaderMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(c,"processHeaderMsgArgs Bad or Missing Sid Error");if(this.ma.hdr<0||this.ma.hdr>this.ma.size)throw this.fail(c,"processHeaderMsgArgs Bad or Missing Header Size Error");if(this.ma.size<0)throw this.fail(c,"processHeaderMsgArgs Bad or Missing Size Error")}protoParseInt(c){if(c.length===0)return-1;let g=0;for(let x=0;x<c.length;x++){if(c[x]<48||c[x]>57)return-1;g=g*10+(c[x]-u1)}return g}}var mt;(function(v){v[v.OP_START=0]="OP_START",v[v.OP_PLUS=1]="OP_PLUS",v[v.OP_PLUS_O=2]="OP_PLUS_O",v[v.OP_PLUS_OK=3]="OP_PLUS_OK",v[v.OP_MINUS=4]="OP_MINUS",v[v.OP_MINUS_E=5]="OP_MINUS_E",v[v.OP_MINUS_ER=6]="OP_MINUS_ER",v[v.OP_MINUS_ERR=7]="OP_MINUS_ERR",v[v.OP_MINUS_ERR_SPC=8]="OP_MINUS_ERR_SPC",v[v.MINUS_ERR_ARG=9]="MINUS_ERR_ARG",v[v.OP_M=10]="OP_M",v[v.OP_MS=11]="OP_MS",v[v.OP_MSG=12]="OP_MSG",v[v.OP_MSG_SPC=13]="OP_MSG_SPC",v[v.MSG_ARG=14]="MSG_ARG",v[v.MSG_PAYLOAD=15]="MSG_PAYLOAD",v[v.MSG_END=16]="MSG_END",v[v.OP_H=17]="OP_H",v[v.OP_P=18]="OP_P",v[v.OP_PI=19]="OP_PI",v[v.OP_PIN=20]="OP_PIN",v[v.OP_PING=21]="OP_PING",v[v.OP_PO=22]="OP_PO",v[v.OP_PON=23]="OP_PON",v[v.OP_PONG=24]="OP_PONG",v[v.OP_I=25]="OP_I",v[v.OP_IN=26]="OP_IN",v[v.OP_INF=27]="OP_INF",v[v.OP_INFO=28]="OP_INFO",v[v.OP_INFO_SPC=29]="OP_INFO_SPC",v[v.INFO_ARG=30]="INFO_ARG"})(mt||(mt={}));var gt;(function(v){v[v.CR=13]="CR",v[v.E=69]="E",v[v.e=101]="e",v[v.F=70]="F",v[v.f=102]="f",v[v.G=71]="G",v[v.g=103]="g",v[v.H=72]="H",v[v.h=104]="h",v[v.I=73]="I",v[v.i=105]="i",v[v.K=75]="K",v[v.k=107]="k",v[v.M=77]="M",v[v.m=109]="m",v[v.MINUS=45]="MINUS",v[v.N=78]="N",v[v.n=110]="n",v[v.NL=10]="NL",v[v.O=79]="O",v[v.o=111]="o",v[v.P=80]="P",v[v.p=112]="p",v[v.PLUS=43]="PLUS",v[v.R=82]="R",v[v.r=114]="r",v[v.S=83]="S",v[v.s=115]="s",v[v.SPACE=32]="SPACE",v[v.TAB=9]="TAB"})(gt||(gt={}));(function(v){var c=function(G,K){this.hi=G|0,this.lo=K|0},g=function(G){var K,J=new Float64Array(16);if(G)for(K=0;K<G.length;K++)J[K]=G[K];return J},x=function(){throw new Error("no PRNG")},E=new Uint8Array(16),k=new Uint8Array(32);k[0]=9;var S=g(),l=g([1]),$=g([56129,1]),oe=g([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),me=g([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),we=g([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),ye=g([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),ze=g([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function Ke(G,K){return G<<K|G>>>32-K}function ot(G,K){var J=G[K+3]&255;return J=J<<8|G[K+2]&255,J=J<<8|G[K+1]&255,J<<8|G[K+0]&255}function ge(G,K){var J=G[K]<<24|G[K+1]<<16|G[K+2]<<8|G[K+3],se=G[K+4]<<24|G[K+5]<<16|G[K+6]<<8|G[K+7];return new c(J,se)}function Pt(G,K,J){var se;for(se=0;se<4;se++)G[K+se]=J&255,J>>>=8}function xt(G,K,J){G[K]=J.hi>>24&255,G[K+1]=J.hi>>16&255,G[K+2]=J.hi>>8&255,G[K+3]=J.hi&255,G[K+4]=J.lo>>24&255,G[K+5]=J.lo>>16&255,G[K+6]=J.lo>>8&255,G[K+7]=J.lo&255}function At(G,K,J,se,fe){var xe,je=0;for(xe=0;xe<fe;xe++)je|=G[K+xe]^J[se+xe];return(1&je-1>>>8)-1}function Qt(G,K,J,se){return At(G,K,J,se,16)}function Fe(G,K,J,se){return At(G,K,J,se,32)}function st(G,K,J,se,fe){var xe=new Uint32Array(16),je=new Uint32Array(16),Be=new Uint32Array(16),ke=new Uint32Array(4),Ve,wt,$t;for(Ve=0;Ve<4;Ve++)je[5*Ve]=ot(se,4*Ve),je[1+Ve]=ot(J,4*Ve),je[6+Ve]=ot(K,4*Ve),je[11+Ve]=ot(J,16+4*Ve);for(Ve=0;Ve<16;Ve++)Be[Ve]=je[Ve];for(Ve=0;Ve<20;Ve++){for(wt=0;wt<4;wt++){for($t=0;$t<4;$t++)ke[$t]=je[(5*wt+4*$t)%16];for(ke[1]^=Ke(ke[0]+ke[3]|0,7),ke[2]^=Ke(ke[1]+ke[0]|0,9),ke[3]^=Ke(ke[2]+ke[1]|0,13),ke[0]^=Ke(ke[3]+ke[2]|0,18),$t=0;$t<4;$t++)xe[4*wt+(wt+$t)%4]=ke[$t]}for($t=0;$t<16;$t++)je[$t]=xe[$t]}if(fe){for(Ve=0;Ve<16;Ve++)je[Ve]=je[Ve]+Be[Ve]|0;for(Ve=0;Ve<4;Ve++)je[5*Ve]=je[5*Ve]-ot(se,4*Ve)|0,je[6+Ve]=je[6+Ve]-ot(K,4*Ve)|0;for(Ve=0;Ve<4;Ve++)Pt(G,4*Ve,je[5*Ve]),Pt(G,16+4*Ve,je[6+Ve])}else for(Ve=0;Ve<16;Ve++)Pt(G,4*Ve,je[Ve]+Be[Ve]|0)}function Ye(G,K,J,se){return st(G,K,J,se,!1),0}function He(G,K,J,se){return st(G,K,J,se,!0),0}var Ge=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function pt(G,K,J,se,fe,xe,je){var Be=new Uint8Array(16),ke=new Uint8Array(64),Ve,wt;if(!fe)return 0;for(wt=0;wt<16;wt++)Be[wt]=0;for(wt=0;wt<8;wt++)Be[wt]=xe[wt];for(;fe>=64;){for(Ye(ke,Be,je,Ge),wt=0;wt<64;wt++)G[K+wt]=(J?J[se+wt]:0)^ke[wt];for(Ve=1,wt=8;wt<16;wt++)Ve=Ve+(Be[wt]&255)|0,Be[wt]=Ve&255,Ve>>>=8;fe-=64,K+=64,J&&(se+=64)}if(fe>0)for(Ye(ke,Be,je,Ge),wt=0;wt<fe;wt++)G[K+wt]=(J?J[se+wt]:0)^ke[wt];return 0}function vt(G,K,J,se,fe){return pt(G,K,null,0,J,se,fe)}function Qe(G,K,J,se,fe){var xe=new Uint8Array(32);return He(xe,se,fe,Ge),vt(G,K,J,se.subarray(16),xe)}function Zt(G,K,J,se,fe,xe,je){var Be=new Uint8Array(32);return He(Be,xe,je,Ge),pt(G,K,J,se,fe,xe.subarray(16),Be)}function Ht(G,K){var J,se=0;for(J=0;J<17;J++)se=se+(G[J]+K[J]|0)|0,G[J]=se&255,se>>>=8}var rt=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]);function Jt(G,K,J,se,fe,xe){var je,Be,ke,Ve,wt=new Uint32Array(17),$t=new Uint32Array(17),sr=new Uint32Array(17),Xi=new Uint32Array(17),Yi=new Uint32Array(17);for(ke=0;ke<17;ke++)$t[ke]=sr[ke]=0;for(ke=0;ke<16;ke++)$t[ke]=xe[ke];for($t[3]&=15,$t[4]&=252,$t[7]&=15,$t[8]&=252,$t[11]&=15,$t[12]&=252,$t[15]&=15;fe>0;){for(ke=0;ke<17;ke++)Xi[ke]=0;for(ke=0;ke<16&&ke<fe;++ke)Xi[ke]=J[se+ke];for(Xi[ke]=1,se+=ke,fe-=ke,Ht(sr,Xi),Be=0;Be<17;Be++)for(wt[Be]=0,ke=0;ke<17;ke++)wt[Be]=wt[Be]+sr[ke]*(ke<=Be?$t[Be-ke]:320*$t[Be+17-ke]|0)|0|0;for(Be=0;Be<17;Be++)sr[Be]=wt[Be];for(Ve=0,ke=0;ke<16;ke++)Ve=Ve+sr[ke]|0,sr[ke]=Ve&255,Ve>>>=8;for(Ve=Ve+sr[16]|0,sr[16]=Ve&3,Ve=5*(Ve>>>2)|0,ke=0;ke<16;ke++)Ve=Ve+sr[ke]|0,sr[ke]=Ve&255,Ve>>>=8;Ve=Ve+sr[16]|0,sr[16]=Ve}for(ke=0;ke<17;ke++)Yi[ke]=sr[ke];for(Ht(sr,rt),je=-(sr[16]>>>7)|0,ke=0;ke<17;ke++)sr[ke]^=je&(Yi[ke]^sr[ke]);for(ke=0;ke<16;ke++)Xi[ke]=xe[ke+16];for(Xi[16]=0,Ht(sr,Xi),ke=0;ke<16;ke++)G[K+ke]=sr[ke];return 0}function Wt(G,K,J,se,fe,xe){var je=new Uint8Array(16);return Jt(je,0,J,se,fe,xe),Qt(G,K,je,0)}function Xt(G,K,J,se,fe){var xe;if(J<32)return-1;for(Zt(G,0,K,0,J,se,fe),Jt(G,16,G,32,J-32,G),xe=0;xe<16;xe++)G[xe]=0;return 0}function Ct(G,K,J,se,fe){var xe,je=new Uint8Array(32);if(J<32||(Qe(je,0,32,se,fe),Wt(K,16,K,32,J-32,je)!==0))return-1;for(Zt(G,0,K,0,J,se,fe),xe=0;xe<32;xe++)G[xe]=0;return 0}function Kt(G,K){var J;for(J=0;J<16;J++)G[J]=K[J]|0}function Nt(G){var K,J;for(J=0;J<16;J++)G[J]+=65536,K=Math.floor(G[J]/65536),G[(J+1)*(J<15?1:0)]+=K-1+37*(K-1)*(J===15?1:0),G[J]-=K*65536}function hr(G,K,J){for(var se,fe=~(J-1),xe=0;xe<16;xe++)se=fe&(G[xe]^K[xe]),G[xe]^=se,K[xe]^=se}function us(G,K){var J,se,fe,xe=g(),je=g();for(J=0;J<16;J++)je[J]=K[J];for(Nt(je),Nt(je),Nt(je),se=0;se<2;se++){for(xe[0]=je[0]-65517,J=1;J<15;J++)xe[J]=je[J]-65535-(xe[J-1]>>16&1),xe[J-1]&=65535;xe[15]=je[15]-32767-(xe[14]>>16&1),fe=xe[15]>>16&1,xe[14]&=65535,hr(je,xe,1-fe)}for(J=0;J<16;J++)G[2*J]=je[J]&255,G[2*J+1]=je[J]>>8}function Os(G,K){var J=new Uint8Array(32),se=new Uint8Array(32);return us(J,G),us(se,K),Fe(J,0,se,0)}function ci(G){var K=new Uint8Array(32);return us(K,G),K[0]&1}function Bi(G,K){var J;for(J=0;J<16;J++)G[J]=K[2*J]+(K[2*J+1]<<8);G[15]&=32767}function ii(G,K,J){var se;for(se=0;se<16;se++)G[se]=K[se]+J[se]|0}function Sr(G,K,J){var se;for(se=0;se<16;se++)G[se]=K[se]-J[se]|0}function Vt(G,K,J){var se,fe,xe=new Float64Array(31);for(se=0;se<31;se++)xe[se]=0;for(se=0;se<16;se++)for(fe=0;fe<16;fe++)xe[se+fe]+=K[se]*J[fe];for(se=0;se<15;se++)xe[se]+=38*xe[se+16];for(se=0;se<16;se++)G[se]=xe[se];Nt(G),Nt(G)}function Lr(G,K){Vt(G,K,K)}function cn(G,K){var J=g(),se;for(se=0;se<16;se++)J[se]=K[se];for(se=253;se>=0;se--)Lr(J,J),se!==2&&se!==4&&Vt(J,J,K);for(se=0;se<16;se++)G[se]=J[se]}function Zi(G,K){var J=g(),se;for(se=0;se<16;se++)J[se]=K[se];for(se=250;se>=0;se--)Lr(J,J),se!==1&&Vt(J,J,K);for(se=0;se<16;se++)G[se]=J[se]}function Bs(G,K,J){var se=new Uint8Array(32),fe=new Float64Array(80),xe,je,Be=g(),ke=g(),Ve=g(),wt=g(),$t=g(),sr=g();for(je=0;je<31;je++)se[je]=K[je];for(se[31]=K[31]&127|64,se[0]&=248,Bi(fe,J),je=0;je<16;je++)ke[je]=fe[je],wt[je]=Be[je]=Ve[je]=0;for(Be[0]=wt[0]=1,je=254;je>=0;--je)xe=se[je>>>3]>>>(je&7)&1,hr(Be,ke,xe),hr(Ve,wt,xe),ii($t,Be,Ve),Sr(Be,Be,Ve),ii(Ve,ke,wt),Sr(ke,ke,wt),Lr(wt,$t),Lr(sr,Be),Vt(Be,Ve,Be),Vt(Ve,ke,$t),ii($t,Be,Ve),Sr(Be,Be,Ve),Lr(ke,Be),Sr(Ve,wt,sr),Vt(Be,Ve,$),ii(Be,Be,wt),Vt(Ve,Ve,Be),Vt(Be,wt,sr),Vt(wt,ke,fe),Lr(ke,$t),hr(Be,ke,xe),hr(Ve,wt,xe);for(je=0;je<16;je++)fe[je+16]=Be[je],fe[je+32]=Ve[je],fe[je+48]=ke[je],fe[je+64]=wt[je];var Xi=fe.subarray(32),Yi=fe.subarray(16);return cn(Xi,Xi),Vt(Yi,Yi,Xi),us(G,Yi),0}function Vr(G,K){return Bs(G,K,k)}function ji(G,K){return x(K,32),Vr(G,K)}function Ni(G,K,J){var se=new Uint8Array(32);return Bs(se,J,K),He(G,E,se,Ge)}var Mr=Xt,js=Ct;function Ws(G,K,J,se,fe,xe){var je=new Uint8Array(32);return Ni(je,fe,xe),Mr(G,K,J,se,je)}function un(G,K,J,se,fe,xe){var je=new Uint8Array(32);return Ni(je,fe,xe),js(G,K,J,se,je)}function Hi(){var G=0,K=0,J=0,se=0,fe=65535,xe,je,Be;for(Be=0;Be<arguments.length;Be++)xe=arguments[Be].lo,je=arguments[Be].hi,G+=xe&fe,K+=xe>>>16,J+=je&fe,se+=je>>>16;return K+=G>>>16,J+=K>>>16,se+=J>>>16,new c(J&fe|se<<16,G&fe|K<<16)}function Wi(G,K){return new c(G.hi>>>K,G.lo>>>K|G.hi<<32-K)}function _s(){var G=0,K=0,J;for(J=0;J<arguments.length;J++)G^=arguments[J].lo,K^=arguments[J].hi;return new c(K,G)}function Ti(G,K){var J,se,fe=32-K;return K<32?(J=G.hi>>>K|G.lo<<fe,se=G.lo>>>K|G.hi<<fe):K<64&&(J=G.lo>>>K|G.hi<<fe,se=G.hi>>>K|G.lo<<fe),new c(J,se)}function Ai(G,K,J){var se=G.hi&K.hi^~G.hi&J.hi,fe=G.lo&K.lo^~G.lo&J.lo;return new c(se,fe)}function ve(G,K,J){var se=G.hi&K.hi^G.hi&J.hi^K.hi&J.hi,fe=G.lo&K.lo^G.lo&J.lo^K.lo&J.lo;return new c(se,fe)}function N(G){return _s(Ti(G,28),Ti(G,34),Ti(G,39))}function j(G){return _s(Ti(G,14),Ti(G,18),Ti(G,41))}function Z(G){return _s(Ti(G,1),Ti(G,8),Wi(G,7))}function ce(G){return _s(Ti(G,19),Ti(G,61),Wi(G,6))}var he=[new c(1116352408,3609767458),new c(1899447441,602891725),new c(3049323471,3964484399),new c(3921009573,2173295548),new c(961987163,4081628472),new c(1508970993,3053834265),new c(2453635748,2937671579),new c(2870763221,3664609560),new c(3624381080,2734883394),new c(310598401,1164996542),new c(607225278,1323610764),new c(1426881987,3590304994),new c(1925078388,4068182383),new c(2162078206,991336113),new c(2614888103,633803317),new c(3248222580,3479774868),new c(3835390401,2666613458),new c(4022224774,944711139),new c(264347078,2341262773),new c(604807628,2007800933),new c(770255983,1495990901),new c(1249150122,1856431235),new c(1555081692,3175218132),new c(1996064986,2198950837),new c(2554220882,3999719339),new c(2821834349,766784016),new c(2952996808,2566594879),new c(3210313671,3203337956),new c(3336571891,1034457026),new c(3584528711,2466948901),new c(113926993,3758326383),new c(338241895,168717936),new c(666307205,1188179964),new c(773529912,1546045734),new c(1294757372,1522805485),new c(1396182291,2643833823),new c(1695183700,2343527390),new c(1986661051,1014477480),new c(2177026350,1206759142),new c(2456956037,344077627),new c(2730485921,1290863460),new c(2820302411,3158454273),new c(3259730800,3505952657),new c(3345764771,106217008),new c(3516065817,3606008344),new c(3600352804,1432725776),new c(4094571909,1467031594),new c(275423344,851169720),new c(430227734,3100823752),new c(506948616,1363258195),new c(659060556,3750685593),new c(883997877,3785050280),new c(958139571,3318307427),new c(1322822218,3812723403),new c(1537002063,2003034995),new c(1747873779,3602036899),new c(1955562222,1575990012),new c(2024104815,1125592928),new c(2227730452,2716904306),new c(2361852424,442776044),new c(2428436474,593698344),new c(2756734187,3733110249),new c(3204031479,2999351573),new c(3329325298,3815920427),new c(3391569614,3928383900),new c(3515267271,566280711),new c(3940187606,3454069534),new c(4118630271,4000239992),new c(116418474,1914138554),new c(174292421,2731055270),new c(289380356,3203993006),new c(460393269,320620315),new c(685471733,587496836),new c(852142971,1086792851),new c(1017036298,365543100),new c(1126000580,2618297676),new c(1288033470,3409855158),new c(1501505948,4234509866),new c(1607167915,987167468),new c(1816402316,1246189591)];function Te(G,K,J){var se=[],fe=[],xe=[],je=[],Be,ke,Ve;for(ke=0;ke<8;ke++)se[ke]=xe[ke]=ge(G,8*ke);for(var wt=0;J>=128;){for(ke=0;ke<16;ke++)je[ke]=ge(K,8*ke+wt);for(ke=0;ke<80;ke++){for(Ve=0;Ve<8;Ve++)fe[Ve]=xe[Ve];for(Be=Hi(xe[7],j(xe[4]),Ai(xe[4],xe[5],xe[6]),he[ke],je[ke%16]),fe[7]=Hi(Be,N(xe[0]),ve(xe[0],xe[1],xe[2])),fe[3]=Hi(fe[3],Be),Ve=0;Ve<8;Ve++)xe[(Ve+1)%8]=fe[Ve];if(ke%16===15)for(Ve=0;Ve<16;Ve++)je[Ve]=Hi(je[Ve],je[(Ve+9)%16],Z(je[(Ve+1)%16]),ce(je[(Ve+14)%16]))}for(ke=0;ke<8;ke++)xe[ke]=Hi(xe[ke],se[ke]),se[ke]=xe[ke];wt+=128,J-=128}for(ke=0;ke<8;ke++)xt(G,8*ke,se[ke]);return J}var _e=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]);function de(G,K,J){var se=new Uint8Array(64),fe=new Uint8Array(256),xe,je=J;for(xe=0;xe<64;xe++)se[xe]=_e[xe];for(Te(se,K,J),J%=128,xe=0;xe<256;xe++)fe[xe]=0;for(xe=0;xe<J;xe++)fe[xe]=K[je-J+xe];for(fe[J]=128,J=256-128*(J<112?1:0),fe[J-9]=0,xt(fe,J-8,new c(je/536870912|0,je<<3)),Te(se,fe,J),xe=0;xe<64;xe++)G[xe]=se[xe];return 0}function Ee(G,K){var J=g(),se=g(),fe=g(),xe=g(),je=g(),Be=g(),ke=g(),Ve=g(),wt=g();Sr(J,G[1],G[0]),Sr(wt,K[1],K[0]),Vt(J,J,wt),ii(se,G[0],G[1]),ii(wt,K[0],K[1]),Vt(se,se,wt),Vt(fe,G[3],K[3]),Vt(fe,fe,me),Vt(xe,G[2],K[2]),ii(xe,xe,xe),Sr(je,se,J),Sr(Be,xe,fe),ii(ke,xe,fe),ii(Ve,se,J),Vt(G[0],je,Be),Vt(G[1],Ve,ke),Vt(G[2],ke,Be),Vt(G[3],je,Ve)}function Ue(G,K,J){var se;for(se=0;se<4;se++)hr(G[se],K[se],J)}function Oe(G,K){var J=g(),se=g(),fe=g();cn(fe,K[2]),Vt(J,K[0],fe),Vt(se,K[1],fe),us(G,se),G[31]^=ci(J)<<7}function at(G,K,J){var se,fe;for(Kt(G[0],S),Kt(G[1],l),Kt(G[2],l),Kt(G[3],S),fe=255;fe>=0;--fe)se=J[fe/8|0]>>(fe&7)&1,Ue(G,K,se),Ee(K,G),Ee(G,G),Ue(G,K,se)}function ft(G,K){var J=[g(),g(),g(),g()];Kt(J[0],we),Kt(J[1],ye),Kt(J[2],l),Vt(J[3],we,ye),at(G,J,K)}function kt(G,K,J){var se=new Uint8Array(64),fe=[g(),g(),g(),g()],xe;for(J||x(K,32),de(se,K,32),se[0]&=248,se[31]&=127,se[31]|=64,ft(fe,se),Oe(G,fe),xe=0;xe<32;xe++)K[xe+32]=G[xe];return 0}var nr=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function er(G,K){var J,se,fe,xe;for(se=63;se>=32;--se){for(J=0,fe=se-32,xe=se-12;fe<xe;++fe)K[fe]+=J-16*K[se]*nr[fe-(se-32)],J=Math.floor((K[fe]+128)/256),K[fe]-=J*256;K[fe]+=J,K[se]=0}for(J=0,fe=0;fe<32;fe++)K[fe]+=J-(K[31]>>4)*nr[fe],J=K[fe]>>8,K[fe]&=255;for(fe=0;fe<32;fe++)K[fe]-=J*nr[fe];for(se=0;se<32;se++)K[se+1]+=K[se]>>8,G[se]=K[se]&255}function Se(G){var K=new Float64Array(64),J;for(J=0;J<64;J++)K[J]=G[J];for(J=0;J<64;J++)G[J]=0;er(G,K)}function dr(G,K,J,se){var fe=new Uint8Array(64),xe=new Uint8Array(64),je=new Uint8Array(64),Be,ke,Ve=new Float64Array(64),wt=[g(),g(),g(),g()];de(fe,se,32),fe[0]&=248,fe[31]&=127,fe[31]|=64;var $t=J+64;for(Be=0;Be<J;Be++)G[64+Be]=K[Be];for(Be=0;Be<32;Be++)G[32+Be]=fe[32+Be];for(de(je,G.subarray(32),J+32),Se(je),ft(wt,je),Oe(G,wt),Be=32;Be<64;Be++)G[Be]=se[Be];for(de(xe,G,J+64),Se(xe),Be=0;Be<64;Be++)Ve[Be]=0;for(Be=0;Be<32;Be++)Ve[Be]=je[Be];for(Be=0;Be<32;Be++)for(ke=0;ke<32;ke++)Ve[Be+ke]+=xe[Be]*fe[ke];return er(G.subarray(32),Ve),$t}function ui(G,K){var J=g(),se=g(),fe=g(),xe=g(),je=g(),Be=g(),ke=g();return Kt(G[2],l),Bi(G[1],K),Lr(fe,G[1]),Vt(xe,fe,oe),Sr(fe,fe,G[2]),ii(xe,G[2],xe),Lr(je,xe),Lr(Be,je),Vt(ke,Be,je),Vt(J,ke,fe),Vt(J,J,xe),Zi(J,J),Vt(J,J,fe),Vt(J,J,xe),Vt(J,J,xe),Vt(G[0],J,xe),Lr(se,G[0]),Vt(se,se,xe),Os(se,fe)&&Vt(G[0],G[0],ze),Lr(se,G[0]),Vt(se,se,xe),Os(se,fe)?-1:(ci(G[0])===K[31]>>7&&Sr(G[0],S,G[0]),Vt(G[3],G[0],G[1]),0)}function Dt(G,K,J,se){var fe,xe=new Uint8Array(32),je=new Uint8Array(64),Be=[g(),g(),g(),g()],ke=[g(),g(),g(),g()];if(J<64||ui(ke,se))return-1;for(fe=0;fe<J;fe++)G[fe]=K[fe];for(fe=0;fe<32;fe++)G[fe+32]=se[fe];if(de(je,G,J),Se(je),at(Be,ke,je),ft(ke,K.subarray(32)),Ee(Be,ke),Oe(xe,Be),J-=64,Fe(K,0,xe,0)){for(fe=0;fe<J;fe++)G[fe]=0;return-1}for(fe=0;fe<J;fe++)G[fe]=K[fe+64];return J}var or=32,Hr=24,cr=32,mr=16,ar=32,Cr=32,ys=32,xs=32,Ze=32,fi=Hr,Si=cr,io=mr,Wr=64,et=32,Rt=64,Lt=32,Pi=64;v.lowlevel={crypto_core_hsalsa20:He,crypto_stream_xor:Zt,crypto_stream:Qe,crypto_stream_salsa20_xor:pt,crypto_stream_salsa20:vt,crypto_onetimeauth:Jt,crypto_onetimeauth_verify:Wt,crypto_verify_16:Qt,crypto_verify_32:Fe,crypto_secretbox:Xt,crypto_secretbox_open:Ct,crypto_scalarmult:Bs,crypto_scalarmult_base:Vr,crypto_box_beforenm:Ni,crypto_box_afternm:Mr,crypto_box:Ws,crypto_box_open:un,crypto_box_keypair:ji,crypto_hash:de,crypto_sign:dr,crypto_sign_keypair:kt,crypto_sign_open:Dt,crypto_secretbox_KEYBYTES:or,crypto_secretbox_NONCEBYTES:Hr,crypto_secretbox_ZEROBYTES:cr,crypto_secretbox_BOXZEROBYTES:mr,crypto_scalarmult_BYTES:ar,crypto_scalarmult_SCALARBYTES:Cr,crypto_box_PUBLICKEYBYTES:ys,crypto_box_SECRETKEYBYTES:xs,crypto_box_BEFORENMBYTES:Ze,crypto_box_NONCEBYTES:fi,crypto_box_ZEROBYTES:Si,crypto_box_BOXZEROBYTES:io,crypto_sign_BYTES:Wr,crypto_sign_PUBLICKEYBYTES:et,crypto_sign_SECRETKEYBYTES:Rt,crypto_sign_SEEDBYTES:Lt,crypto_hash_BYTES:Pi,gf:g,D:oe,L:nr,pack25519:us,unpack25519:Bi,M:Vt,A:ii,S:Lr,Z:Sr,pow2523:Zi,add:Ee,set25519:Kt,modL:er,scalarmult:at,scalarbase:ft};function Cn(G,K){if(G.length!==or)throw new Error("bad key size");if(K.length!==Hr)throw new Error("bad nonce size")}function vs(G,K){if(G.length!==ys)throw new Error("bad public key size");if(K.length!==xs)throw new Error("bad secret key size")}function Mt(){for(var G=0;G<arguments.length;G++)if(!(arguments[G]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function hn(G){for(var K=0;K<G.length;K++)G[K]=0}v.randomBytes=function(G){var K=new Uint8Array(G);return x(K,G),K},v.secretbox=function(G,K,J){Mt(G,K,J),Cn(J,K);for(var se=new Uint8Array(cr+G.length),fe=new Uint8Array(se.length),xe=0;xe<G.length;xe++)se[xe+cr]=G[xe];return Xt(fe,se,se.length,K,J),fe.subarray(mr)},v.secretbox.open=function(G,K,J){Mt(G,K,J),Cn(J,K);for(var se=new Uint8Array(mr+G.length),fe=new Uint8Array(se.length),xe=0;xe<G.length;xe++)se[xe+mr]=G[xe];return se.length<32||Ct(fe,se,se.length,K,J)!==0?null:fe.subarray(cr)},v.secretbox.keyLength=or,v.secretbox.nonceLength=Hr,v.secretbox.overheadLength=mr,v.scalarMult=function(G,K){if(Mt(G,K),G.length!==Cr)throw new Error("bad n size");if(K.length!==ar)throw new Error("bad p size");var J=new Uint8Array(ar);return Bs(J,G,K),J},v.scalarMult.base=function(G){if(Mt(G),G.length!==Cr)throw new Error("bad n size");var K=new Uint8Array(ar);return Vr(K,G),K},v.scalarMult.scalarLength=Cr,v.scalarMult.groupElementLength=ar,v.box=function(G,K,J,se){var fe=v.box.before(J,se);return v.secretbox(G,K,fe)},v.box.before=function(G,K){Mt(G,K),vs(G,K);var J=new Uint8Array(Ze);return Ni(J,G,K),J},v.box.after=v.secretbox,v.box.open=function(G,K,J,se){var fe=v.box.before(J,se);return v.secretbox.open(G,K,fe)},v.box.open.after=v.secretbox.open,v.box.keyPair=function(){var G=new Uint8Array(ys),K=new Uint8Array(xs);return ji(G,K),{publicKey:G,secretKey:K}},v.box.keyPair.fromSecretKey=function(G){if(Mt(G),G.length!==xs)throw new Error("bad secret key size");var K=new Uint8Array(ys);return Vr(K,G),{publicKey:K,secretKey:new Uint8Array(G)}},v.box.publicKeyLength=ys,v.box.secretKeyLength=xs,v.box.sharedKeyLength=Ze,v.box.nonceLength=fi,v.box.overheadLength=v.secretbox.overheadLength,v.sign=function(G,K){if(Mt(G,K),K.length!==Rt)throw new Error("bad secret key size");var J=new Uint8Array(Wr+G.length);return dr(J,G,G.length,K),J},v.sign.open=function(G,K){if(Mt(G,K),K.length!==et)throw new Error("bad public key size");var J=new Uint8Array(G.length),se=Dt(J,G,G.length,K);if(se<0)return null;for(var fe=new Uint8Array(se),xe=0;xe<fe.length;xe++)fe[xe]=J[xe];return fe},v.sign.detached=function(G,K){for(var J=v.sign(G,K),se=new Uint8Array(Wr),fe=0;fe<se.length;fe++)se[fe]=J[fe];return se},v.sign.detached.verify=function(G,K,J){if(Mt(G,K,J),K.length!==Wr)throw new Error("bad signature size");if(J.length!==et)throw new Error("bad public key size");var se=new Uint8Array(Wr+G.length),fe=new Uint8Array(Wr+G.length),xe;for(xe=0;xe<Wr;xe++)se[xe]=K[xe];for(xe=0;xe<G.length;xe++)se[xe+Wr]=G[xe];return Dt(fe,se,se.length,J)>=0},v.sign.keyPair=function(){var G=new Uint8Array(et),K=new Uint8Array(Rt);return kt(G,K),{publicKey:G,secretKey:K}},v.sign.keyPair.fromSecretKey=function(G){if(Mt(G),G.length!==Rt)throw new Error("bad secret key size");for(var K=new Uint8Array(et),J=0;J<K.length;J++)K[J]=G[32+J];return{publicKey:K,secretKey:new Uint8Array(G)}},v.sign.keyPair.fromSeed=function(G){if(Mt(G),G.length!==Lt)throw new Error("bad seed size");for(var K=new Uint8Array(et),J=new Uint8Array(Rt),se=0;se<32;se++)J[se]=G[se];return kt(K,J,!0),{publicKey:K,secretKey:J}},v.sign.publicKeyLength=et,v.sign.secretKeyLength=Rt,v.sign.seedLength=Lt,v.sign.signatureLength=Wr,v.hash=function(G){Mt(G);var K=new Uint8Array(Pi);return de(K,G,G.length),K},v.hash.hashLength=Pi,v.verify=function(G,K){return Mt(G,K),G.length===0||K.length===0||G.length!==K.length?!1:At(G,0,K,0,G.length)===0},v.setPRNG=function(G){x=G},(function(){var G=typeof globalThis<"u"?globalThis.crypto||globalThis.msCrypto:null;if(G&&G.getRandomValues){var K=65536;v.setPRNG(function(J,se){var fe,xe=new Uint8Array(se);for(fe=0;fe<se;fe+=K)G.getRandomValues(xe.subarray(fe,fe+Math.min(se-fe,K)));for(fe=0;fe<se;fe++)J[fe]=xe[fe];hn(xe)})}else typeof require<"u"&&(G=require("crypto"),G&&G.randomBytes&&v.setPRNG(function(J,se){var fe,xe=G.randomBytes(se);for(fe=0;fe<se;fe++)J[fe]=xe[fe];hn(xe)}))})()})(typeof module<"u"&&module.exports?module.exports:globalThis.nacl=globalThis.nacl||{});const od=typeof module<"u"&&module.exports?module.exports:globalThis.nacl;od.sign.keyPair.fromSeed,od.sign.detached,od.sign.detached.verify,od.randomBytes;var w_;(function(v){v.InvalidPrefixByte="nkeys: invalid prefix byte",v.InvalidKey="nkeys: invalid key",v.InvalidPublicKey="nkeys: invalid public key",v.InvalidSeedLen="nkeys: invalid seed length",v.InvalidSeed="nkeys: invalid seed",v.InvalidEncoding="nkeys: invalid encoded key",v.InvalidSignature="nkeys: signature verification failed",v.CannotSign="nkeys: cannot sign, no private key available",v.PublicKeyOnly="nkeys: no seed or private key available",v.InvalidChecksum="nkeys: invalid checksum",v.SerializationError="nkeys: serialization error",v.ApiError="nkeys: api error",v.ClearedPair="nkeys: pair is cleared"})(w_||(w_={}));var T_;(function(v){v[v.Seed=144]="Seed",v[v.Private=120]="Private",v[v.Operator=112]="Operator",v[v.Server=104]="Server",v[v.Cluster=16]="Cluster",v[v.Account=0]="Account",v[v.User=160]="User"})(T_||(T_={}));function h1(v){return c=>{let g={};return v.forEach(x=>{const E=x(c)||{};g=Object.assign(g,E)}),g}}function d1(){return()=>{}}function p1(v,c){return()=>{const g=typeof v=="function"?v():v,x=typeof c=="function"?c():c;return{user:g,pass:x}}}function f1(v){return()=>({auth_token:typeof v=="function"?v():v})}const ly=120*1e3,m1=2,cy=2*1e3;function g1(){return{maxPingOut:2,maxReconnectAttempts:10,noRandomize:!1,pedantic:!1,pingInterval:ly,reconnect:!0,reconnectJitter:100,reconnectJitterTLS:1e3,reconnectTimeWait:cy,tls:void 0,verbose:!1,waitOnFirstConnect:!1,ignoreAuthErrorAbort:!1}}function _1(v){const c=[];return typeof v.authenticator=="function"&&c.push(v.authenticator),Array.isArray(v.authenticator)&&c.push(...v.authenticator),v.token&&c.push(f1(v.token)),v.user&&c.push(p1(v.user,v.pass)),c.length===0?d1():h1(c)}function y1(v){const c=`${gf}:${ny()}`;if(v=v||{servers:[c]},v.servers=v.servers||[],typeof v.servers=="string"&&(v.servers=[v.servers]),v.servers.length>0&&v.port)throw new St("port and servers options are mutually exclusive",ct.InvalidOption);v.servers.length===0&&v.port&&(v.servers=[`${gf}:${v.port}`]),v.servers&&v.servers.length===0&&(v.servers=[c]);const g=Ed(g1(),v);if(g.authenticator=_1(g),["reconnectDelayHandler","authenticator"].forEach(x=>{if(g[x]&&typeof g[x]!="function")throw new St(`${x} option should be a function`,ct.NotFunction)}),g.reconnectDelayHandler||(g.reconnectDelayHandler=()=>{let x=g.tls?g.reconnectJitterTLS:g.reconnectJitter;return x&&(x++,x=Math.floor(Math.random()*x)),g.reconnectTimeWait+x}),g.inboxPrefix)try{An(g.inboxPrefix)}catch(x){throw new St(x.message,ct.ApiError)}if(g.resolve===void 0&&(g.resolve=typeof Sf()=="function"),g.resolve&&typeof Sf()!="function")throw new St("'resolve' is not supported on this client",ct.InvalidOption);return g}function x1(v,c){const{proto:g,tls_required:x,tls_available:E}=v;if((g===void 0||g<1)&&c.noEcho)throw new St("noEcho",ct.ServerOptionNotAvailable);const k=x||E||!1;if(c.tls&&!k)throw new St("tls",ct.ServerOptionNotAvailable)}const v1=1024*32,b1=/^INFO\s+([^\r\n]+)\r\n/i,w1=yu(`PONG\r
`),S_=yu(`PING\r
`);class T1{echo;no_responders;protocol;verbose;pedantic;jwt;nkey;sig;user;pass;auth_token;tls_required;name;lang;version;headers;constructor(c,g,x){this.protocol=1,this.version=c.version,this.lang=c.lang,this.echo=g.noEcho?!1:void 0,this.verbose=g.verbose,this.pedantic=g.pedantic,this.tls_required=g.tls?!0:void 0,this.name=g.name;const E=(g&&typeof g.authenticator=="function"?g.authenticator(x):{})||{};Ed(this,E)}}class uy extends Oi{sid;queue;draining;max;subject;drained;protocol;timer;info;cleanupFn;closed;requestSubject;constructor(c,g,x={}){super(),Ed(this,x),this.protocol=c,this.subject=g,this.draining=!1,this.noIterator=typeof x.callback=="function",this.closed=ti();const E=!c.options?.noAsyncTraces;x.timeout&&(this.timer=Hl(x.timeout,E),this.timer.then(()=>{this.timer=void 0}).catch(k=>{this.stop(k),this.noIterator&&this.callback(k,{})})),this.noIterator||this.iterClosed.then(()=>{this.closed.resolve(),this.unsubscribe()})}setPrePostHandlers(c){if(this.noIterator){const g=this.callback,x=c.ingestionFilterFn?c.ingestionFilterFn:()=>({ingest:!0,protocol:!1}),E=c.protocolFilterFn?c.protocolFilterFn:()=>!0,k=c.dispatchedFn?c.dispatchedFn:()=>{};this.callback=(S,l)=>{const{ingest:$}=x(l);$&&E(l)&&(g(S,l),k(l))}}else this.protocolFilterFn=c.protocolFilterFn,this.dispatchedFn=c.dispatchedFn}callback(c,g){this.cancelTimeout(),c?this.stop(c):this.push(g)}close(){if(!this.isClosed()){this.cancelTimeout();const c=()=>{if(this.stop(),this.cleanupFn)try{this.cleanupFn(this,this.info)}catch{}this.closed.resolve()};this.noIterator?c():this.push(c)}}unsubscribe(c){this.protocol.unsubscribe(this,c)}cancelTimeout(){this.timer&&(this.timer.cancel(),this.timer=void 0)}drain(){return this.protocol.isClosed()?Promise.reject(St.errorForCode(ct.ConnectionClosed)):this.isClosed()?Promise.reject(St.errorForCode(ct.SubClosed)):(this.drained||(this.draining=!0,this.protocol.unsub(this),this.drained=this.protocol.flush(ti()).then(()=>{this.protocol.subscriptions.cancel(this)}).catch(()=>{this.protocol.subscriptions.cancel(this)})),this.drained)}isDraining(){return this.draining}isClosed(){return this.done}getSubject(){return this.subject}getMax(){return this.max}getID(){return this.sid}}class S1{mux;subs;sidCounter;constructor(){this.sidCounter=0,this.mux=null,this.subs=new Map}size(){return this.subs.size}add(c){return this.sidCounter++,c.sid=this.sidCounter,this.subs.set(c.sid,c),c}setMux(c){return this.mux=c,c}getMux(){return this.mux}get(c){return this.subs.get(c)}resub(c){return this.sidCounter++,this.subs.delete(c.sid),c.sid=this.sidCounter,this.subs.set(c.sid,c),c}all(){return Array.from(this.subs.values())}cancel(c){c&&(c.close(),this.subs.delete(c.sid))}handleError(c){if(c&&c.permissionContext){const g=c.permissionContext,x=this.all();let E;if(g.operation==="subscription"&&(E=x.find(k=>k.subject===g.subject&&k.queue===g.queue)),g.operation==="publish"&&(E=x.find(k=>k.requestSubject===g.subject)),E)return E.callback(c,{}),E.close(),this.subs.delete(E.sid),E!==this.mux}return!1}close(){this.subs.forEach(c=>{c.close()})}}class wd{connected;connectedOnce;infoReceived;info;muxSubscriptions;options;outbound;pongs;subscriptions;transport;noMorePublishing;connectError;publisher;_closed;closed;listeners;heartbeats;parser;outMsgs;inMsgs;outBytes;inBytes;pendingLimit;lastError;abortReconnect;whyClosed;servers;server;features;connectPromise;constructor(c,g){this._closed=!1,this.connected=!1,this.connectedOnce=!1,this.infoReceived=!1,this.noMorePublishing=!1,this.abortReconnect=!1,this.listeners=[],this.pendingLimit=v1,this.outMsgs=0,this.inMsgs=0,this.outBytes=0,this.inBytes=0,this.options=c,this.publisher=g,this.subscriptions=new S1,this.muxSubscriptions=new o1,this.outbound=new Xl,this.pongs=[],this.whyClosed="",this.pendingLimit=c.pendingLimit||this.pendingLimit,this.features=new Nb({major:0,minor:0,micro:0}),this.connectPromise=null;const x=typeof c.servers=="string"?[c.servers]:c.servers;this.servers=new n1(x,{randomize:!c.noRandomize}),this.closed=ti(),this.parser=new b_(this),this.heartbeats=new a1(this,this.options.pingInterval||ly,this.options.maxPingOut||m1)}resetOutbound(){this.outbound.reset();const c=this.pongs;this.pongs=[];const g=St.errorForCode(ct.Disconnect);g.stack="",c.forEach(x=>{x.reject(g)}),this.parser=new b_(this),this.infoReceived=!1}dispatchStatus(c){this.listeners.forEach(g=>{g.push(c)})}status(){const c=new Oi;return this.listeners.push(c),c}prepare(){this.transport&&this.transport.discard(),this.info=void 0,this.resetOutbound();const c=ti();return c.catch(()=>{}),this.pongs.unshift(c),this.connectError=g=>{c.reject(g)},this.transport=Ub(),this.transport.closed().then(async g=>{if(this.connected=!1,!this.isClosed()){await this.disconnected(this.transport.closeError||this.lastError);return}}),c}disconnect(){this.dispatchStatus({type:Vl.StaleConnection,data:""}),this.transport.disconnect()}reconnect(){return this.connected&&(this.dispatchStatus({type:Vl.ClientInitiatedReconnect,data:""}),this.transport.disconnect()),Promise.resolve()}async disconnected(c){this.dispatchStatus({type:nn.Disconnect,data:this.servers.getCurrentServer().toString()}),this.options.reconnect?await this.dialLoop().then(()=>{this.dispatchStatus({type:nn.Reconnect,data:this.servers.getCurrentServer().toString()}),this.lastError?.code===ct.AuthenticationExpired&&(this.lastError=void 0)}).catch(g=>{this._close(g)}):await this._close(c)}async dial(c){const g=this.prepare();let x;try{x=Hl(this.options.timeout||2e4);const E=this.transport.connect(c,this.options);await Promise.race([E,x]),(async()=>{try{for await(const k of this.transport)this.parser.parse(k)}catch(k){console.log("reader closed",k)}})().then()}catch(E){g.reject(E)}try{await Promise.race([x,g]),x&&x.cancel(),this.connected=!0,this.connectError=void 0,this.sendSubscriptions(),this.connectedOnce=!0,this.server.didConnect=!0,this.server.reconnects=0,this.flushPending(),this.heartbeats.start()}catch(E){throw x&&x.cancel(),await this.transport.close(E),E}}async _doDial(c){const{resolve:g}=this.options,x=await c.resolve({fn:Sf(),debug:this.options.debug,randomize:!this.options.noRandomize,resolve:g});let E=null;for(const k of x)try{E=null,this.dispatchStatus({type:Vl.Reconnecting,data:k.toString()}),await this.dial(k);return}catch(S){E=S}throw E}dialLoop(){return this.connectPromise===null&&(this.connectPromise=this.dodialLoop(),this.connectPromise.then(()=>{}).catch(()=>{}).finally(()=>{this.connectPromise=null})),this.connectPromise}async dodialLoop(){let c;for(;;){this._closed&&this.servers.clear();const g=this.options.reconnectDelayHandler?this.options.reconnectDelayHandler():cy;let x=g;const E=this.selectServer();if(!E||this.abortReconnect)throw c||(this.lastError?this.lastError:St.errorForCode(ct.ConnectionRefused));const k=Date.now();if(E.lastConnect===0||E.lastConnect+g<=k){E.lastConnect=Date.now();try{await this._doDial(E);break}catch(S){if(c=S,!this.connectedOnce){if(this.options.waitOnFirstConnect)continue;this.servers.removeCurrentServer()}E.reconnects++;const l=this.options.maxReconnectAttempts||0;l!==-1&&E.reconnects>=l&&this.servers.removeCurrentServer()}}else x=Math.min(x,E.lastConnect+g-k),await Jl(x)}}static async connect(c,g){const x=new wd(c,g);return await x.dialLoop(),x}static toError(c){const g=c?c.toLowerCase():"";if(g.indexOf("permissions violation")!==-1){const x=new St(c,ct.PermissionsViolation),E=c.match(/(Publish|Subscription) to "(\S+)"/);if(E){x.permissionContext={operation:E[1].toLowerCase(),subject:E[2],queue:void 0};const k=c.match(/using queue "(\S+)"/);k&&(x.permissionContext.queue=k[1])}return x}else return g.indexOf("authorization violation")!==-1?new St(c,ct.AuthorizationViolation):g.indexOf("user authentication expired")!==-1?new St(c,ct.AuthenticationExpired):g.indexOf("account authentication expired")!=-1?new St(c,ct.AccountExpired):g.indexOf("authentication timeout")!==-1?new St(c,ct.AuthenticationTimeout):new St(c,ct.ProtocolError)}processMsg(c,g){if(this.inMsgs++,this.inBytes+=g.length,!this.subscriptions.sidCounter)return;const x=this.subscriptions.get(c.sid);x&&(x.received+=1,x.callback&&x.callback(null,new ty(c,g,this)),x.max!==void 0&&x.received>=x.max&&x.unsubscribe())}processError(c){const g=o_(c),x=wd.toError(g),E={type:nn.Error,data:x.code};if(x.isPermissionError()){let k=!1;x.permissionContext&&(E.permissionContext=x.permissionContext,k=this.subscriptions.getMux()?.subject===x.permissionContext.subject),this.subscriptions.handleError(x),this.muxSubscriptions.handleError(k,x),k&&this.subscriptions.setMux(null)}this.dispatchStatus(E),this.handleError(x)}handleError(c){c.isAuthError()?this.handleAuthError(c):c.isProtocolError()?this.lastError=c:c.isAuthTimeout()&&(this.lastError=c),c.isPermissionError()||(this.lastError=c)}handleAuthError(c){this.lastError&&c.code===this.lastError.code&&this.options.ignoreAuthErrorAbort===!1&&(this.abortReconnect=!0),this.connectError?this.connectError(c):this.disconnect()}processPing(){this.transport.send(w1)}processPong(){const c=this.pongs.shift();c&&c.resolve()}processInfo(c){const g=JSON.parse(o_(c));this.info=g;const x=this.options&&this.options.ignoreClusterUpdates?void 0:this.servers.update(g,this.transport.isEncrypted());if(!this.infoReceived){this.features.update(Da(g.version)),this.infoReceived=!0,this.transport.isEncrypted()&&this.servers.updateTLSName();const{version:k,lang:S}=this.transport;try{const l=new T1({version:k,lang:S},this.options,g.nonce);g.headers&&(l.headers=!0,l.no_responders=!0);const $=JSON.stringify(l);this.transport.send(yu(`CONNECT ${$}${ud}`)),this.transport.send(S_)}catch(l){this._close(l)}}x&&this.dispatchStatus({type:nn.Update,data:x}),g.ldm!==void 0&&g.ldm&&this.dispatchStatus({type:nn.LDM,data:this.servers.getCurrentServer().toString()})}push(c){switch(c.kind){case ls.MSG:{const{msg:g,data:x}=c;this.processMsg(g,x);break}case ls.OK:break;case ls.ERR:this.processError(c.data);break;case ls.PING:this.processPing();break;case ls.PONG:this.processPong();break;case ls.INFO:this.processInfo(c.data);break}}sendCommand(c,...g){const x=this.outbound.length();let E;typeof c=="string"?E=yu(c):E=c,this.outbound.fill(E,...g),x===0?queueMicrotask(()=>{this.flushPending()}):this.outbound.size()>=this.pendingLimit&&this.flushPending()}publish(c,g=Ls,x){let E;if(g instanceof Uint8Array)E=g;else if(typeof g=="string")E=Ra.encode(g);else throw St.errorForCode(ct.BadPayload);let k=E.length;x=x||{},x.reply=x.reply||"";let S=Ls,l=0;if(x.headers){if(this.info&&!this.info.headers)throw new St("headers",ct.ServerOptionNotAvailable);S=x.headers.encode(),l=S.length,k=E.length+l}if(this.info&&k>this.info.max_payload)throw St.errorForCode(ct.MaxPayloadExceeded);this.outBytes+=k,this.outMsgs++;let $;x.headers?(x.reply?$=`HPUB ${c} ${x.reply} ${l} ${k}\r
`:$=`HPUB ${c} ${l} ${k}\r
`,this.sendCommand($,S,E,bd)):(x.reply?$=`PUB ${c} ${x.reply} ${k}\r
`:$=`PUB ${c} ${k}\r
`,this.sendCommand($,E,bd))}request(c){return this.initMux(),this.muxSubscriptions.add(c),c}subscribe(c){return this.subscriptions.add(c),this._subunsub(c),c}_sub(c){c.queue?this.sendCommand(`SUB ${c.subject} ${c.queue} ${c.sid}\r
`):this.sendCommand(`SUB ${c.subject} ${c.sid}\r
`)}_subunsub(c){return this._sub(c),c.max&&this.unsubscribe(c,c.max),c}unsubscribe(c,g){this.unsub(c,g),(c.max===void 0||c.received>=c.max)&&this.subscriptions.cancel(c)}unsub(c,g){!c||this.isClosed()||(g?this.sendCommand(`UNSUB ${c.sid} ${g}\r
`):this.sendCommand(`UNSUB ${c.sid}\r
`),c.max=g)}resub(c,g){!c||this.isClosed()||(this.unsub(c),c.subject=g,this.subscriptions.resub(c),this._sub(c))}flush(c){return c||(c=ti()),this.pongs.push(c),this.outbound.fill(S_),this.flushPending(),c}sendSubscriptions(){const c=[];this.subscriptions.all().forEach(g=>{const x=g;x.queue?c.push(`SUB ${x.subject} ${x.queue} ${x.sid}${ud}`):c.push(`SUB ${x.subject} ${x.sid}${ud}`)}),c.length&&this.transport.send(yu(c.join("")))}async _close(c){this._closed||(this.whyClosed=new Error("close trace").stack||"",this.heartbeats.cancel(),this.connectError&&(this.connectError(c),this.connectError=void 0),this.muxSubscriptions.close(),this.subscriptions.close(),this.listeners.forEach(g=>{g.stop()}),this._closed=!0,await this.transport.close(c),await this.closed.resolve(c))}close(){return this._close()}isClosed(){return this._closed}drain(){const c=this.subscriptions.all(),g=[];return c.forEach(x=>{g.push(x.drain())}),Promise.all(g).then(async()=>(this.noMorePublishing=!0,await this.flush(),this.close())).catch(()=>{})}flushPending(){if(!(!this.infoReceived||!this.connected)&&this.outbound.size()){const c=this.outbound.drain();this.transport.send(c)}}initMux(){if(!this.subscriptions.getMux()){const g=this.muxSubscriptions.init(this.options.inboxPrefix),x=new uy(this,`${g}*`);x.callback=this.muxSubscriptions.dispatcher(),this.subscriptions.setMux(x),this.subscribe(x)}}selectServer(){const c=this.servers.selectServer();if(c!==void 0)return this.server=c,this.server}getServer(){return this.server}}const P1="$SRV";class P_{msg;constructor(c){this.msg=c}get data(){return this.msg.data}get sid(){return this.msg.sid}get subject(){return this.msg.subject}get reply(){return this.msg.reply||""}get headers(){return this.msg.headers}respond(c,g){return this.msg.respond(c,g)}respondError(c,g,x,E){return E=E||{},E.headers=E.headers||ro(),E.headers?.set(_d,`${c}`),E.headers?.set(gd,g),this.msg.respond(x,E)}json(c){return this.msg.json(c)}string(){return this.msg.string()}}class Tu{subject;queue;srv;constructor(c,g="",x=""){g!==""&&M1("service group",g);let E="";if(c instanceof Iu)this.srv=c,E="";else if(c instanceof Tu){const k=c;this.srv=k.srv,x===""&&k.queue!==""&&(x=k.queue),E=k.subject}else throw new Error("unknown ServiceGroup type");this.subject=this.calcSubject(E,g),this.queue=x}calcSubject(c,g=""){return g===""?c:c!==""?`${c}.${g}`:g}addEndpoint(c="",g){g=g||{subject:c};const x=typeof g=="function"?{handler:g,subject:c}:g;mu("endpoint",c);let{subject:E,handler:k,metadata:S,queue:l}=x;E=E||c,l=l||this.queue,E1("endpoint subject",E),E=this.calcSubject(this.subject,E);const $={name:c,subject:E,queue:l,handler:k,metadata:S};return this.srv._addEndpoint($)}addGroup(c="",g=""){return new Tu(this,c,g)}}function E1(v,c){if(c==="")throw new Error(`${v} cannot be empty`);if(c.indexOf(" ")!==-1)throw new Error(`${v} cannot contain spaces: '${c}'`);const g=c.split(".");g.forEach((x,E)=>{if(x===">"&&E!==g.length-1)throw new Error(`${v} cannot have internal '>': '${c}'`)})}function M1(v,c){if(c.indexOf(" ")!==-1)throw new Error(`${v} cannot contain spaces: '${c}'`);c.split(".").forEach(x=>{if(x===">")throw new Error(`${v} name cannot contain internal '>': '${c}'`)})}class Iu{nc;_id;config;handlers;internal;_stopped;_done;started;static controlSubject(c,g="",x="",E){const k=E??P1;return g===""&&x===""?`${k}.${c}`:(mu("control subject name",g),x!==""?(mu("control subject id",x),`${k}.${c}.${g}.${x}`):`${k}.${c}.${g}`)}constructor(c,g={name:"",version:""}){this.nc=c,this.config=Object.assign({},g),this.config.queue||(this.config.queue="q"),mu("name",this.config.name),mu("queue",this.config.queue),Da(this.config.version),this._id=Bo.next(),this.internal=[],this._done=ti(),this._stopped=!1,this.handlers=[],this.started=new Date().toISOString(),this.reset(),this.nc.closed().then(()=>{this.close().catch()}).catch(x=>{this.close(x).catch()})}get subjects(){return this.handlers.filter(c=>c.internal===!1).map(c=>c.subject)}get id(){return this._id}get name(){return this.config.name}get description(){return this.config.description??""}get version(){return this.config.version}get metadata(){return this.config.metadata}errorToHeader(c){const g=ro();if(c instanceof yd){const x=c;g.set(gd,x.message),g.set(_d,`${x.code}`)}else g.set(gd,c.message),g.set(_d,"500");return g}setupHandler(c,g=!1){const x=g?"":c.queue?c.queue:this.config.queue,{name:E,subject:k,handler:S}=c,l=c;l.internal=g,g&&this.internal.push(l),l.stats=new I1(E,k,x),l.queue=x;const $=S?(oe,me)=>{if(oe){this.close(oe);return}const we=Date.now();try{S(oe,new P_(me))}catch(ye){l.stats.countError(ye),me?.respond(Ls,{headers:this.errorToHeader(ye)})}finally{l.stats.countLatency(we)}}:void 0;return l.sub=this.nc.subscribe(k,{callback:$,queue:x}),l.sub.closed.then(()=>{this._stopped||this.close(new Error(`required subscription ${c.subject} stopped`)).catch()}).catch(oe=>{if(!this._stopped){const me=new Error(`required subscription ${c.subject} errored: ${oe.message}`);me.stack=oe.stack,this.close(me).catch()}}),l}info(){return{type:xu.INFO,name:this.name,id:this.id,version:this.version,description:this.description,metadata:this.metadata,endpoints:this.endpoints()}}endpoints(){return this.handlers.map(c=>{const{subject:g,metadata:x,name:E,queue:k}=c;return{subject:g,metadata:x,name:E,queue_group:k}})}async stats(){const c=[];for(const g of this.handlers){if(typeof this.config.statsHandler=="function")try{g.stats.data=await this.config.statsHandler(g)}catch(x){g.stats.countError(x)}c.push(g.stats.stats(g.qi))}return{type:xu.STATS,name:this.name,id:this.id,version:this.version,started:this.started,metadata:this.metadata,endpoints:c}}addInternalHandler(c,g){const x=`${c}`.toUpperCase();this._doAddInternalHandler(`${x}-all`,c,g),this._doAddInternalHandler(`${x}-kind`,c,g,this.name),this._doAddInternalHandler(`${x}`,c,g,this.name,this.id)}_doAddInternalHandler(c,g,x,E="",k=""){const S={};S.name=c,S.subject=Iu.controlSubject(g,E,k),S.handler=x,this.setupHandler(S,!0)}start(){const c=ln(),g=(S,l)=>S?(this.close(S),Promise.reject(S)):this.stats().then($=>(l?.respond(c.encode($)),Promise.resolve())),x=(S,l)=>S?(this.close(S),Promise.reject(S)):(l?.respond(c.encode(this.info())),Promise.resolve()),E=c.encode(this.ping()),k=(S,l)=>S?(this.close(S).then().catch(),Promise.reject(S)):(l.respond(E),Promise.resolve());return this.addInternalHandler(Fo.PING,k),this.addInternalHandler(Fo.STATS,g),this.addInternalHandler(Fo.INFO,x),this.handlers.forEach(S=>{const{subject:l}=S;typeof l=="string"&&S.handler!==null&&this.setupHandler(S)}),Promise.resolve(this)}close(c){if(this._stopped)return this._done;this._stopped=!0;let g=[];return this.nc.isClosed()||(g=this.handlers.concat(this.internal).map(x=>x.sub.drain())),Promise.allSettled(g).then(()=>{this._done.resolve(c||null)}),this._done}get stopped(){return this._done}get isStopped(){return this._stopped}stop(c){return this.close(c)}ping(){return{type:xu.PING,name:this.name,id:this.id,version:this.version,metadata:this.metadata}}reset(){if(this.started=new Date().toISOString(),this.handlers)for(const c of this.handlers)c.stats.reset(c.qi)}addGroup(c,g){return new Tu(this,c,g)}addEndpoint(c,g){return new Tu(this).addEndpoint(c,g)}_addEndpoint(c){const g=new Oi;g.noIterator=typeof c.handler=="function",g.noIterator||(c.handler=(E,k)=>{E?this.stop(E).catch():g.push(new P_(k))},g.iterClosed.then(()=>{this.close().catch()}));const x=this.setupHandler(c,!1);return x.qi=g,this.handlers.push(x),g}}class I1{name;subject;average_processing_time;num_requests;processing_time;num_errors;last_error;data;metadata;queue;constructor(c,g,x=""){this.name=c,this.subject=g,this.average_processing_time=0,this.num_errors=0,this.num_requests=0,this.processing_time=0,this.queue=x}reset(c){this.num_requests=0,this.processing_time=0,this.average_processing_time=0,this.num_errors=0,this.last_error=void 0,this.data=void 0;const g=c;g&&(g.time=0,g.processed=0)}countLatency(c){this.num_requests++,this.processing_time+=ei(Date.now()-c),this.average_processing_time=Math.round(this.processing_time/this.num_requests)}countError(c){this.num_errors++,this.last_error=c.message}_stats(){const{name:c,subject:g,average_processing_time:x,num_errors:E,num_requests:k,processing_time:S,last_error:l,data:$,queue:oe}=this;return{name:c,subject:g,average_processing_time:x,num_errors:E,num_requests:k,processing_time:S,last_error:l,data:$,queue_group:oe}}stats(c){const g=c;return g?.noIterator===!1&&(this.processing_time=ei(g.time),this.num_requests=g.processed,this.average_processing_time=this.processing_time>0&&this.num_requests>0?this.processing_time/this.num_requests:0),this._stats()}}class A1{nc;prefix;opts;constructor(c,g={strategy:an.JitterTimer,maxWait:2e3},x){this.nc=c,this.prefix=x,this.opts=g}ping(c="",g=""){return this.q(Fo.PING,c,g)}stats(c="",g=""){return this.q(Fo.STATS,c,g)}info(c="",g=""){return this.q(Fo.INFO,c,g)}async q(c,g="",x=""){const E=new Oi,k=ln(),S=Iu.controlSubject(c,g,x,this.prefix),l=await this.nc.requestMany(S,Ls,this.opts);return(async()=>{for await(const $ of l)try{const oe=k.decode($.data);E.push(oe)}catch(oe){E.push(()=>{E.stop(oe)})}E.push(()=>{E.stop()})})().catch($=>{E.stop($)}),E}}function hy(){return{key:{encode(v){return v},decode(v){return v}},value:{encode(v){return v},decode(v){return v}}}}function C1(){return{replicas:1,history:1,timeout:2e3,max_bytes:-1,maxValueSize:-1,codec:hy(),storage:bf.File}}const Td="KV-Operation",E_="$KV",k1=/^[-/=.\w]+$/,D1=/^[-/=.>*\w]+$/,z1=/^[-\w]+$/;function R1(v){if(v.startsWith(".")||v.endsWith(".")||!k1.test(v))throw new Error(`invalid key: ${v}`)}function F1(v){if(v.startsWith(".")||v.endsWith(".")||!D1.test(v))throw new Error(`invalid key: ${v}`)}function L1(v){if(v.startsWith(".")||v.endsWith("."))throw new Error(`invalid key: ${v}`);const c=v.split(".");let g=!1;for(let x=0;x<c.length;x++)switch(c[x]){case"*":g=!0;break;case">":if(x!==c.length-1)throw new Error(`invalid key: ${v}`);g=!0;break}return g}function hd(v){if(!z1.test(v))throw new Error(`invalid bucket name: ${v}`)}var En;(function(v){v.MsgIdHdr="Nats-Msg-Id",v.ExpectedStreamHdr="Nats-Expected-Stream",v.ExpectedLastSeqHdr="Nats-Expected-Last-Sequence",v.ExpectedLastMsgIdHdr="Nats-Expected-Last-Msg-Id",v.ExpectedLastSubjectSequenceHdr="Nats-Expected-Last-Subject-Sequence"})(En||(En={}));class Su{js;jsm;stream;bucket;direct;codec;prefix;editPrefix;useJsPrefix;_prefixLen;constructor(c,g,x){hd(c),this.js=g,this.jsm=x,this.bucket=c,this.prefix=E_,this.editPrefix="",this.useJsPrefix=!1,this._prefixLen=0}static async create(c,g,x={}){hd(g);const E=await c.jetstreamManager(),k=new Su(g,c,E);return await k.init(x),k}static async bind(c,g,x={}){const E=await c.jetstreamManager(),k={config:{allow_direct:x.allow_direct}};hd(g);const S=new Su(g,c,E);return k.config.name=x.streamName??S.bucketName(),Object.assign(S,k),S.stream=k.config.name,S.codec=x.codec||hy(),S.direct=k.config.allow_direct??!1,S.initializePrefixes(k),S}async init(c={}){const g=Object.assign(C1(),c);this.codec=g.codec;const x={};this.stream=x.name=c.streamName??this.bucketName(),x.retention=vf.Limits,x.max_msgs_per_subject=g.history,g.maxBucketSize&&(g.max_bytes=g.maxBucketSize),g.max_bytes&&(x.max_bytes=g.max_bytes),x.max_msg_size=g.maxValueSize,x.storage=g.storage;const E=c.placementCluster??"";if(E&&(c.placement={},c.placement.cluster=E,c.placement.tags=[]),c.placement&&(x.placement=c.placement),c.republish&&(x.republish=c.republish),c.description&&(x.description=c.description),c.mirror){const we=Object.assign({},c.mirror);we.name.startsWith(Ds)||(we.name=`${Ds}${we.name}`),x.mirror=we,x.mirror_direct=!0}else if(c.sources){const we=c.sources.map(ye=>{const ze=Object.assign({},ye),Ke=ze.name.startsWith(Ds)?ze.name.substring(Ds.length):ze.name;return ze.name.startsWith(Ds)||(ze.name=`${Ds}${ze.name}`),!ye.external&&Ke!==this.bucket&&(ze.subject_transforms=[{src:`$KV.${Ke}.>`,dest:`$KV.${this.bucket}.>`}]),ze});x.sources=we,x.subjects=[this.subjectForBucket()]}else x.subjects=[this.subjectForBucket()];c.metadata&&(x.metadata=c.metadata),typeof c.compression=="boolean"&&(x.compression=c.compression?jo.S2:jo.None);const k=this.js.nc,S=k.getServerVersion(),l=S?Tf(S,Da("2.7.2"))>=0:!1;x.discard=l?wu.New:wu.Old;const{ok:$,min:oe}=k.features.get(fr.JS_ALLOW_DIRECT);if(!$&&c.allow_direct===!0){const we=S?`${S.major}.${S.minor}.${S.micro}`:"unknown";return Promise.reject(new Error(`allow_direct is not available on server version ${we} - requires ${oe}`))}c.allow_direct=typeof c.allow_direct=="boolean"?c.allow_direct:$,x.allow_direct=c.allow_direct,this.direct=x.allow_direct,x.num_replicas=g.replicas,g.ttl&&(x.max_age=ei(g.ttl)),x.allow_rollup_hdrs=!0;let me;try{me=await this.jsm.streams.info(x.name),!me.config.allow_direct&&this.direct===!0&&(this.direct=!1)}catch(we){if(we.message==="stream not found")me=await this.jsm.streams.add(x);else throw we}this.initializePrefixes(me)}initializePrefixes(c){this._prefixLen=0,this.prefix=`$KV.${this.bucket}`,this.useJsPrefix=this.js.apiPrefix!=="$JS.API";const{mirror:g}=c.config;if(g){let x=g.name;if(x.startsWith(Ds)&&(x=x.substring(Ds.length)),g.external&&g.external.api!==""){const E=g.name.substring(Ds.length);this.useJsPrefix=!1,this.prefix=`$KV.${E}`,this.editPrefix=`${g.external.api}.$KV.${x}`}else this.editPrefix=this.prefix}}bucketName(){return this.stream??`${Ds}${this.bucket}`}subjectForBucket(){return`${this.prefix}.${this.bucket}.>`}subjectForKey(c,g=!1){const x=[];return g?(this.useJsPrefix&&x.push(this.js.apiPrefix),this.editPrefix!==""?x.push(this.editPrefix):x.push(this.prefix)):this.prefix&&x.push(this.prefix),x.push(c),x.join(".")}fullKeyName(c){return this.prefix!==""?`${this.prefix}.${c}`:`${E_}.${this.bucket}.${c}`}get prefixLen(){return this._prefixLen===0&&(this._prefixLen=this.prefix.length+1),this._prefixLen}encodeKey(c){const g=[];for(const x of c.split("."))switch(x){case">":case"*":g.push(x);break;default:g.push(this.codec.key.encode(x));break}return g.join(".")}decodeKey(c){const g=[];for(const x of c.split("."))switch(x){case">":case"*":g.push(x);break;default:g.push(this.codec.key.decode(x));break}return g.join(".")}validateKey=R1;validateSearchKey=F1;hasWildcards=L1;close(){return Promise.resolve()}dataLen(c,g){const x=g&&g.get(cs.MessageSizeHdr)||"";return x!==""?parseInt(x,10):c.length}smToEntry(c){return new K1(this.bucket,this.prefixLen,c)}jmToEntry(c){const g=this.decodeKey(c.subject.substring(this.prefixLen));return new Q1(this.bucket,g,c)}async create(c,g){let x;try{const k=await this.put(c,g,{previousSeq:0});return Promise.resolve(k)}catch(k){if(x=k,k?.api_error?.err_code!==10071)return Promise.reject(k)}let E=0;try{const k=await this.get(c);return k?.operation==="DEL"||k?.operation==="PURGE"?(E=k!==null?k.revision:0,this.update(c,g,E)):Promise.reject(x)}catch(k){return Promise.reject(k)}}update(c,g,x){if(x<=0)throw new Error("version must be greater than 0");return this.put(c,g,{previousSeq:x})}async put(c,g,x={}){const E=this.encodeKey(c);this.validateKey(E);const k={};if(x.previousSeq!==void 0){const S=ro();k.headers=S,S.set(En.ExpectedLastSubjectSequenceHdr,`${x.previousSeq}`)}try{return(await this.js.publish(this.subjectForKey(E,!0),g,k)).seq}catch(S){const l=S;return l.isJetStreamError()?(l.message=l.api_error?.description,l.code=`${l.api_error?.code}`,Promise.reject(l)):Promise.reject(S)}}async get(c,g){const x=this.encodeKey(c);this.validateKey(x);let E={last_by_subj:this.subjectForKey(x)};g&&g.revision>0&&(E={seq:g.revision});let k;try{this.direct?k=await this.jsm.direct.getMessage(this.bucketName(),E):k=await this.jsm.streams.getMessage(this.bucketName(),E);const S=this.smToEntry(k);return S.key!==x?null:S}catch(S){if(S.code===ct.JetStream404NoMessages)return null;throw S}}purge(c,g){return this._deleteOrPurge(c,"PURGE",g)}delete(c,g){return this._deleteOrPurge(c,"DEL",g)}async purgeDeletes(c=1800*1e3){const g=ti(),x=[],E=await this.watch({key:">",initializedFn:()=>{g.resolve()}});(async()=>{for await(const $ of E)($.operation==="DEL"||$.operation==="PURGE")&&x.push($)})().then(),await g,E.stop();const k=Date.now()-c,S=x.map($=>{const oe=this.subjectForKey($.key);return $.created.getTime()>=k?this.jsm.streams.purge(this.stream,{filter:oe,keep:1}):this.jsm.streams.purge(this.stream,{filter:oe,keep:0})}),l=await Promise.all(S);return l.unshift({success:!0,purged:0}),l.reduce(($,oe)=>($.purged+=oe.purged,$))}async _deleteOrPurge(c,g,x){if(!this.hasWildcards(c))return this._doDeleteOrPurge(c,g,x);const E=await this.keys(c),k=[];for await(const S of E)k.push(this._doDeleteOrPurge(S,g)),k.length===100&&(await Promise.all(k),k.length=0);k.length>0&&await Promise.all(k)}async _doDeleteOrPurge(c,g,x){const E=this.encodeKey(c);this.validateKey(E);const k=ro();k.set(Td,g),g==="PURGE"&&k.set(cs.RollupHdr,cs.RollupValueSubject),x?.previousSeq&&k.set(En.ExpectedLastSubjectSequenceHdr,`${x.previousSeq}`),await this.js.publish(this.subjectForKey(E,!0),Ls,{headers:k})}_buildCC(c,g,x={}){let k=(Array.isArray(c)?c:[c]).map($=>{const oe=this.encodeKey($);return this.validateSearchKey($),this.fullKeyName(oe)}),S=pi.LastPerSubject;g===sn.AllHistory&&(S=pi.All),g===sn.UpdatesOnly&&(S=pi.New);let l;return k.length===1&&(l=k[0],k=void 0),Object.assign({deliver_policy:S,ack_policy:Fi.None,filter_subjects:k,filter_subject:l,flow_control:!0,idle_heartbeat:ei(5*1e3)},x)}remove(c){return this.purge(c)}async history(c={}){const g=c.key??">",x=new Oi,E={};E.headers_only=c.headers_only||!1;let k;k=()=>{x.stop()};let S=0;const l=this._buildCC(g,sn.AllHistory,E),$=l.filter_subject,oe=eo(l);oe.bindStream(this.stream),oe.orderedConsumer(),oe.callback((we,ye)=>{if(we){x.stop(we);return}if(ye){const ze=this.jmToEntry(ye);x.push(ze),x.received++,(k&&S>0&&x.received>=S||ye.info.pending===0)&&(x.push(k),k=void 0)}});const me=await this.js.subscribe($,oe);if(k){const{info:{last:we}}=me,ye=we.num_pending+we.delivered.consumer_seq;if(ye===0||x.received>=ye)try{k()}catch(ze){x.stop(ze)}finally{k=void 0}else S=ye}return x._data=me,x.iterClosed.then(()=>{me.unsubscribe()}),me.closed.then(()=>{x.stop()}).catch(we=>{x.stop(we)}),x}canSetWatcherName(){const g=this.js.nc,{ok:x}=g.features.get(fr.JS_NEW_CONSUMER_CREATE_API);return x}async watch(c={}){const g=c.key??">",x=new Oi,E={};E.headers_only=c.headers_only||!1;let k=sn.LastValue;c.include===sn.AllHistory?k=sn.AllHistory:c.include===sn.UpdatesOnly&&(k=sn.UpdatesOnly);const S=c.ignoreDeletes===!0;let l=c.initializedFn,$=0;const oe=this._buildCC(g,k,E),me=oe.filter_subject,we=eo(oe);this.canSetWatcherName()&&we.consumerName(Bo.next()),we.bindStream(this.stream),c.resumeFromRevision&&c.resumeFromRevision>0&&we.startSequence(c.resumeFromRevision),we.orderedConsumer(),we.callback((ze,Ke)=>{if(ze){x.stop(ze);return}if(Ke){const ot=this.jmToEntry(Ke);if(S&&ot.operation==="DEL")return;x.push(ot),x.received++,l&&($>0&&x.received>=$||Ke.info.pending===0)&&(x.push(l),l=void 0)}});const ye=await this.js.subscribe(me,we);if(l){const{info:{last:ze}}=ye,Ke=ze.num_pending+ze.delivered.consumer_seq;if(Ke===0||x.received>=Ke)try{l()}catch(ot){x.stop(ot)}finally{l=void 0}else $=Ke}return x._data=ye,x.iterClosed.then(()=>{ye.unsubscribe()}),ye.closed.then(()=>{x.stop()}).catch(ze=>{x.stop(ze)}),x}async keys(c=">"){const g=new Oi,x=this._buildCC(c,sn.LastValue,{headers_only:!0}),E=Array.isArray(c)?">":x.filter_subject,k=eo(x);k.bindStream(this.stream),k.orderedConsumer();const S=await this.js.subscribe(E,k);return(async()=>{for await(const $ of S){const oe=$.headers?.get(Td);if(oe!=="DEL"&&oe!=="PURGE"){const me=this.decodeKey($.subject.substring(this.prefixLen));g.push(me)}$.info.pending===0&&S.unsubscribe()}})().then(()=>{g.stop()}).catch($=>{g.stop($)}),S.info.last.num_pending===0&&S.unsubscribe(),g}purgeBucket(c){return this.jsm.streams.purge(this.bucketName(),c)}destroy(){return this.jsm.streams.delete(this.bucketName())}async status(){const g=this.js.nc.info?.cluster??"",x=this.bucketName(),E=await this.jsm.streams.info(x);return new dy(E,g)}}class dy{si;cluster;constructor(c,g=""){this.si=c,this.cluster=g}get bucket(){return this.si.config.name.startsWith(Ds)?this.si.config.name.substring(Ds.length):this.si.config.name}get values(){return this.si.state.messages}get history(){return this.si.config.max_msgs_per_subject}get ttl(){return zf(this.si.config.max_age)}get bucket_location(){return this.cluster}get backingStore(){return this.si.config.storage}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get description(){return this.si.config.description??""}get maxBucketSize(){return this.si.config.max_bytes}get maxValueSize(){return this.si.config.max_msg_size}get max_bytes(){return this.si.config.max_bytes}get placement(){return this.si.config.placement||{cluster:"",tags:[]}}get placementCluster(){return this.si.config.placement?.cluster??""}get republish(){return this.si.config.republish??{src:"",dest:""}}get streamInfo(){return this.si}get size(){return this.si.state.bytes}get metadata(){return this.si.config.metadata??{}}get compression(){return this.si.config.compression?this.si.config.compression!==jo.None:!1}}const Ff="OBJ_",M_="SHA-256=";function O1(v){return hd(v),`${Ff}${v}`}function B1(v){return v.startsWith(Ff)?v.substring(4):v}class Mf{si;backingStore;constructor(c){this.si=c,this.backingStore="JetStream"}get bucket(){return B1(this.si.config.name)}get description(){return this.si.config.description??""}get ttl(){return this.si.config.max_age}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get sealed(){return this.si.config.sealed}get size(){return this.si.state.bytes}get streamInfo(){return this.si}get metadata(){return this.si.config.metadata}get compression(){return this.si.config.compression?this.si.config.compression!==jo.None:!1}}function ad(v){if(v===void 0)return;const{domain:c}=v;if(c===void 0)return v;const g=Object.assign({},v);if(delete g.domain,c==="")return g;if(g.external)throw new Error("domain and external are both set");return g.external={api:`$JS.${c}.API`},g}var Gs;(function(v){v[v.Unset=-1]="Unset",v[v.Consume=0]="Consume",v[v.Fetch=1]="Fetch"})(Gs||(Gs={}));var Mn;(function(v){v.HeartbeatsMissed="heartbeats_missed",v.ConsumerNotFound="consumer_not_found",v.StreamNotFound="stream_not_found",v.ConsumerDeleted="consumer_deleted",v.OrderedConsumerRecreated="ordered_consumer_recreated",v.NoResponders="no_responders"})(Mn||(Mn={}));var Gl;(function(v){v.DebugEvent="debug",v.Discard="discard",v.Reset="reset",v.Next="next"})(Gl||(Gl={}));const I_=Uint8Array.of(43,65,67,75),j1=Uint8Array.of(45,78,65,75),fu=Uint8Array.of(43,87,80,73),N1=Uint8Array.of(43,78,88,84),V1=Uint8Array.of(43,84,69,82,77),$1=Uint8Array.of(32);function Pu(v,c=5e3){return new ow(v,c)}class af extends Oi{consumer;opts;sub;monitor;pending;inbox;refilling;pong;callback;timeout;cleanupHandler;listeners;statusIterator;forOrderedConsumer;resetHandler;abortOnMissingResource;bind;inBackOff;constructor(c,g,x=!1){super(),this.consumer=c;const E=g;this.opts=this.parseOptions(g,x),this.callback=E.callback||null,this.noIterator=typeof this.callback=="function",this.monitor=null,this.pong=null,this.pending={msgs:0,bytes:0,requests:0},this.refilling=x,this.timeout=null,this.inbox=An(c.api.nc.options.inboxPrefix),this.listeners=[],this.forOrderedConsumer=!1,this.abortOnMissingResource=E.abort_on_missing_resource===!0,this.bind=E.bind===!0,this.inBackOff=!1,this.start()}start(){const{max_messages:c,max_bytes:g,idle_heartbeat:x,threshold_bytes:E,threshold_messages:k}=this.opts;this.closed().then(l=>{if(this.cleanupHandler)try{this.cleanupHandler(l)}catch{}});const{sub:S}=this;S&&S.unsubscribe(),this.sub=this.consumer.api.nc.subscribe(this.inbox,{callback:(l,$)=>{if(l){this.stop(l);return}if(this.monitor?.work(),$.subject===this.inbox){if(xf($))return;const me=$.headers?.code,we=$.headers?.description?.toLowerCase()||"unknown",{msgsLeft:ye,bytesLeft:ze}=this.parseDiscard($.headers);if(ye>0||ze>0)this.pending.msgs-=ye,this.pending.bytes-=ze,this.pending.requests--,this.notify(Gl.Discard,{msgsLeft:ye,bytesLeft:ze});else if(me===400){this.stop(new St(we,`${me}`));return}else if(me===409&&we==="consumer deleted"){if(this.notify(Mn.ConsumerDeleted,`${me} ${we}`),!this.refilling||this.abortOnMissingResource){const Ke=new St(we,`${me}`);this.stop(Ke);return}}else if(me===503){if(this.notify(Mn.NoResponders,`${me} No Responders`),!this.refilling||this.abortOnMissingResource){const Ke=new St("no responders",`${me}`);this.stop(Ke);return}}else this.notify(Gl.DebugEvent,`${me} ${we}`)}else this._push(Pu($,this.consumer.api.timeout)),this.received++,this.pending.msgs&&this.pending.msgs--,this.pending.bytes&&(this.pending.bytes-=$.size());if(this.pending.msgs===0&&this.pending.bytes===0&&(this.pending.requests=0),this.refilling){if(c&&this.pending.msgs<=k||g&&this.pending.bytes<=E){const me=this.pullOptions();this.pull(me)}}else this.pending.requests===0&&this._push(()=>{this.stop()})}}),this.sub.closed.then(()=>{this.sub.draining&&this._push(()=>{this.stop()})}),x&&(this.monitor=new Rf(x,l=>(this.notify(Mn.HeartbeatsMissed,l),this.resetPending().then(()=>{}).catch(()=>{}),!1),{maxOut:2})),(async()=>{const l=this.consumer.api.nc.status();this.statusIterator=l;for await(const $ of l)switch($.type){case nn.Disconnect:this.monitor?.cancel();break;case nn.Reconnect:this.resetPending().then(oe=>{oe&&this.monitor?.restart()}).catch(()=>{});break}})(),this.pull(this.pullOptions())}_push(c){if(!this.callback)super.push(c);else{const g=typeof c=="function"?c:null;try{g?g():this.callback(c)}catch(x){this.stop(x)}}}notify(c,g){this.listeners.length>0&&this.listeners.forEach(x=>{x.done||x.push({type:c,data:g})})}resetPending(){return this.bind?this.resetPendingNoInfo():this.resetPendingWithInfo()}resetPendingNoInfo(){return this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),Promise.resolve(!0)}async resetPendingWithInfo(){if(this.inBackOff)return!1;let c=0,g=0;const x=Df([this.opts.expires]);let E=0;for(;;){if(this.done)return!1;if(this.consumer.api.nc.isClosed())return console.error("aborting resetPending - connection is closed"),!1;try{return await this.consumer.info(),this.inBackOff=!1,c=0,this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),!0}catch(k){if(k.message==="stream not found"){if(g++,this.notify(Mn.StreamNotFound,g),!this.refilling||this.abortOnMissingResource)return this.stop(k),!1}else if(k.message==="consumer not found"){if(c++,this.notify(Mn.ConsumerNotFound,c),this.resetHandler)try{this.resetHandler()}catch{}if(!this.refilling||this.abortOnMissingResource)return this.stop(k),!1;if(this.forOrderedConsumer)return!1}else c=0,g=0;this.inBackOff=!0;const S=x.backoff(E),l=Jl(S);await Promise.race([l,this.consumer.api.nc.closed()]),l.cancel(),E++}}}pull(c){this.pending.bytes+=c.max_bytes??0,this.pending.msgs+=c.batch??0,this.pending.requests++;const g=this.consumer.api.nc;this._push(()=>{g.publish(`${this.consumer.api.prefix}.CONSUMER.MSG.NEXT.${this.consumer.stream}.${this.consumer.name}`,this.consumer.api.jc.encode(c),{reply:this.inbox}),this.notify(Gl.Next,c)})}pullOptions(){const c=this.opts.max_messages-this.pending.msgs,g=this.opts.max_bytes-this.pending.bytes,x=ei(this.opts.idle_heartbeat),E=ei(this.opts.expires);return{batch:c,max_bytes:g,idle_heartbeat:x,expires:E}}parseDiscard(c){const g={msgsLeft:0,bytesLeft:0},x=c?.get(cs.PendingMessagesHdr);x&&(g.msgsLeft=parseInt(x));const E=c?.get(cs.PendingBytesHdr);return E&&(g.bytesLeft=parseInt(E)),g}trackTimeout(c){this.timeout=c}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}clearTimers(){this.monitor?.cancel(),this.monitor=null,this.timeout?.cancel(),this.timeout=null}setCleanupHandler(c){this.cleanupHandler=c}stop(c){this.done||(this.sub?.unsubscribe(),this.clearTimers(),this.statusIterator?.stop(),this._push(()=>{super.stop(c),this.listeners.forEach(g=>{g.stop()})}))}parseOptions(c,g=!1){const x=c||{};if(x.max_messages=x.max_messages||0,x.max_bytes=x.max_bytes||0,x.max_messages!==0&&x.max_bytes!==0)throw new Error("only specify one of max_messages or max_bytes");if(x.max_messages===0&&(x.max_messages=100),x.expires=x.expires||3e4,x.expires<1e3)throw new Error("expires should be at least 1000ms");if(x.idle_heartbeat=x.idle_heartbeat||x.expires/2,x.idle_heartbeat=x.idle_heartbeat>3e4?3e4:x.idle_heartbeat,g){const E=Math.round(x.max_messages*.75)||1;x.threshold_messages=x.threshold_messages||E;const k=Math.round(x.max_bytes*.75)||1;x.threshold_bytes=x.threshold_bytes||k}return x}status(){const c=new Oi;return this.listeners.push(c),Promise.resolve(c)}}class U1 extends Oi{src;listeners;constructor(){super(),this.listeners=[]}setSource(c){this.src&&(this.src.resetHandler=void 0,this.src.setCleanupHandler(),this.src.stop()),this.src=c,this.src.setCleanupHandler(g=>{this.stop(g||void 0)}),(async()=>{const g=await this.src.status();for await(const x of g)this.notify(x.type,x.data)})().catch(()=>{})}notify(c,g){this.listeners.length>0&&this.listeners.forEach(x=>{x.done||x.push({type:c,data:g})})}stop(c){this.done||(this.src?.stop(c),super.stop(c),this.listeners.forEach(g=>{g.stop()}))}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}status(){const c=new Oi;return this.listeners.push(c),Promise.resolve(c)}}class If{api;_info;stream;name;constructor(c,g){this.api=c,this._info=g,this.stream=g.stream_name,this.name=g.name}consume(c={max_messages:100,expires:3e4}){return Promise.resolve(new af(this,c,!0))}fetch(c={max_messages:100,expires:3e4}){const g=new af(this,c,!1),x=Math.round(g.opts.expires*1.05),E=Hl(x);return g.closed().catch(()=>{}).finally(()=>{E.cancel()}),E.catch(()=>{g.close().catch()}),g.trackTimeout(E),Promise.resolve(g)}next(c={expires:3e4}){const g=ti(),x=c;x.max_messages=1;const E=new af(this,x,!1),k=Math.round(E.opts.expires*1.05);k>=6e4&&(async()=>{for await(const l of await E.status())if(l.type===Mn.HeartbeatsMissed&&l.data>=2){g.reject(new Error("consumer missed heartbeats"));break}})().catch(),(async()=>{for await(const l of E){g.resolve(l);break}})().catch(()=>{});const S=Hl(k);return E.closed().then(l=>{l?g.reject(l):g.resolve(null)}).catch(l=>{g.reject(l)}).finally(()=>{S.cancel()}),S.catch(l=>{g.resolve(null),E.close().catch()}),E.trackTimeout(S),g}delete(){const{stream_name:c,name:g}=this._info;return this.api.delete(c,g)}info(c=!1){if(c)return Promise.resolve(this._info);const{stream_name:g,name:x}=this._info;return this.api.info(g,x).then(E=>(this._info=E,this._info))}}class q1{api;consumerOpts;consumer;opts;cursor;stream;namePrefix;serial;currentConsumer;userCallback;iter;type;startSeq;maxInitialReset;constructor(c,g,x={}){this.api=c,this.stream=g,this.cursor={stream_seq:1,deliver_seq:0},this.namePrefix=Bo.next(),typeof x.name_prefix=="string"&&(Md("name_prefix",x.name_prefix),this.namePrefix=x.name_prefix+this.namePrefix),this.serial=0,this.currentConsumer=null,this.userCallback=null,this.iter=null,this.type=Gs.Unset,this.consumerOpts=x,this.maxInitialReset=30,this.startSeq=this.consumerOpts.opt_start_seq||0,this.cursor.stream_seq=this.startSeq>0?this.startSeq-1:0}getConsumerOpts(c){this.serial++;const g=`${this.namePrefix}_${this.serial}`;c=c===0?1:c;const x={name:g,deliver_policy:pi.StartSequence,opt_start_seq:c,ack_policy:Fi.None,inactive_threshold:ei(300*1e3),num_replicas:1};return this.consumerOpts.headers_only===!0&&(x.headers_only=!0),Array.isArray(this.consumerOpts.filterSubjects)&&(x.filter_subjects=this.consumerOpts.filterSubjects),typeof this.consumerOpts.filterSubjects=="string"&&(x.filter_subject=this.consumerOpts.filterSubjects),this.consumerOpts.replay_policy&&(x.replay_policy=this.consumerOpts.replay_policy),c===this.startSeq+1&&(x.deliver_policy=this.consumerOpts.deliver_policy||pi.StartSequence,(this.consumerOpts.deliver_policy===pi.LastPerSubject||this.consumerOpts.deliver_policy===pi.New||this.consumerOpts.deliver_policy===pi.Last)&&(delete x.opt_start_seq,x.deliver_policy=this.consumerOpts.deliver_policy),x.deliver_policy===pi.LastPerSubject&&typeof x.filter_subjects>"u"&&typeof x.filter_subject>"u"&&(x.filter_subject=">"),this.consumerOpts.opt_start_time&&(delete x.opt_start_seq,x.deliver_policy=pi.StartTime,x.opt_start_time=this.consumerOpts.opt_start_time),this.consumerOpts.inactive_threshold&&(x.inactive_threshold=ei(this.consumerOpts.inactive_threshold))),x}async resetConsumer(c=0){Bo.next();const g=this.serial===0;this.consumer?.delete().catch(()=>{}),c=c===0?1:c,this.cursor.deliver_seq=0;const x=this.getConsumerOpts(c);x.max_deliver=1,x.mem_storage=!0;const E=Df([this.opts?.expires||3e4]);let k;for(let S=0;;S++)try{k=await this.api.add(this.stream,x),this.iter?.notify(Mn.OrderedConsumerRecreated,k.name);break}catch(l){if(l.message==="stream not found"&&(this.iter?.notify(Mn.StreamNotFound,S),this.type===Gs.Fetch||this.opts.abort_on_missing_resource===!0))return this.iter?.stop(l),Promise.reject(l);if(g&&S>=this.maxInitialReset)throw l;await Jl(E.backoff(S+1))}return k}internalHandler(c){return g=>{if(this.serial!==c)return;const x=g.info.deliverySequence;if(x!==this.cursor.deliver_seq+1){this.notifyOrderedResetAndReset();return}this.cursor.deliver_seq=x,this.cursor.stream_seq=g.info.streamSequence,this.userCallback?this.userCallback(g):this.iter?.push(g)}}async reset(c={max_messages:100,expires:3e4},g){g=g||{};const x=g.fromFetch||!1,E=g.orderedReset||!1;if(this.type===Gs.Fetch&&E){this.iter?.src.stop(),await this.iter?.closed(),this.currentConsumer=null;return}(this.currentConsumer===null||E)&&(this.currentConsumer=await this.resetConsumer(this.cursor.stream_seq+1)),(this.iter===null||x)&&(this.iter=new U1),this.consumer=new If(this.api,this.currentConsumer);const k=c;k.callback=this.internalHandler(this.serial);let S=null;this.type===Gs.Fetch&&x?S=await this.consumer.fetch(c):this.type===Gs.Consume&&(S=await this.consumer.consume(c));const l=S;l.forOrderedConsumer=!0,l.resetHandler=()=>{this.notifyOrderedResetAndReset()},this.iter.setSource(l)}notifyOrderedResetAndReset(){this.iter?.notify(Gl.Reset,""),this.reset(this.opts,{orderedReset:!0})}async consume(c={max_messages:100,expires:3e4}){if(c.bind)return Promise.reject(new Error("bind is not supported"));if(this.type===Gs.Fetch)return Promise.reject(new Error("ordered consumer initialized as fetch"));if(this.type===Gs.Consume)return Promise.reject(new Error("ordered consumer doesn't support concurrent consume"));const{callback:x}=c;return x&&(this.userCallback=x),this.type=Gs.Consume,this.opts=c,await this.reset(c),this.iter}async fetch(c={max_messages:100,expires:3e4}){if(c.bind)return Promise.reject(new Error("bind is not supported"));if(this.type===Gs.Consume)return Promise.reject(new Error("ordered consumer already initialized as consume"));if(this.iter?.done===!1)return Promise.reject(new Error("ordered consumer doesn't support concurrent fetch"));const{callback:x}=c;return x&&(this.userCallback=x),this.type=Gs.Fetch,this.opts=c,await this.reset(c,{fromFetch:!0}),this.iter}async next(c={expires:3e4}){const g=c;if(g.bind)return Promise.reject(new Error("bind is not supported"));g.max_messages=1;const x=ti();return g.callback=k=>{this.userCallback=null,x.resolve(k)},(await this.fetch(g)).iterClosed.then(k=>{k&&x.reject(k),x.resolve(null)}).catch(k=>{x.reject(k)}),x}delete(){return this.currentConsumer?this.api.delete(this.stream,this.currentConsumer.name).then(c=>Promise.resolve(c)).catch(c=>Promise.reject(c)).finally(()=>{this.currentConsumer=null}):Promise.resolve(!1)}async info(c){return this.currentConsumer==null?(this.currentConsumer=await this.resetConsumer(this.startSeq),Promise.resolve(this.currentConsumer)):c&&this.currentConsumer?Promise.resolve(this.currentConsumer):this.api.info(this.stream,this.currentConsumer.name)}}class Af{api;notified;constructor(c){this.api=c,this.notified=!1}checkVersion(){const c=this.api.nc.features.get(fr.JS_SIMPLIFICATION);return c.ok?Promise.resolve():Promise.reject(new Error(`consumers framework is only supported on servers ${c.min} or better`))}getPullConsumerFor(c){if(c.config.deliver_subject!==void 0)throw new Error("push consumer not supported");return new If(this.api,c)}async get(c,g={}){return typeof g=="object"?this.ordered(c,g):(await this.checkVersion(),this.api.info(c,g).then(x=>x.config.deliver_subject!==void 0?Promise.reject(new Error("push consumer not supported")):new If(this.api,x)).catch(x=>Promise.reject(x)))}async ordered(c,g){await this.checkVersion();const x=this.api;return new Lf(x.nc,x.opts).info(c).then(k=>Promise.resolve(new q1(this.api,c,g))).catch(k=>Promise.reject(k))}}class Ad{api;_info;constructor(c,g){this.api=c,this._info=g}get name(){return this._info.config.name}alternates(){return this.info().then(c=>c.alternates?c.alternates:[])}async best(){if(await this.info(),this._info.alternates){const c=await this.api.info(this._info.alternates[0].name);return new Ad(this.api,c)}else return this}info(c=!1,g){return c?Promise.resolve(this._info):this.api.info(this.name,g).then(x=>(this._info=x,this._info))}getConsumerFromInfo(c){return new Af(new vd(this.api.nc,this.api.opts)).getPullConsumerFor(c)}getConsumer(c){return new Af(new vd(this.api.nc,this.api.opts)).get(this.name,c)}getMessage(c){return this.api.getMessage(this.name,c)}deleteMessage(c,g){return this.api.deleteMessage(this.name,c,g)}}class Lf extends Mu{constructor(c,g){super(c,g)}checkStreamConfigVersions(c){const g=this.nc;if(c.metadata){const{min:E,ok:k}=g.features.get(fr.JS_STREAM_CONSUMER_METADATA);if(!k)throw new Error(`stream 'metadata' requires server ${E}`)}if(c.first_seq){const{min:E,ok:k}=g.features.get(fr.JS_STREAM_FIRST_SEQ);if(!k)throw new Error(`stream 'first_seq' requires server ${E}`)}if(c.subject_transform){const{min:E,ok:k}=g.features.get(fr.JS_STREAM_SUBJECT_TRANSFORM);if(!k)throw new Error(`stream 'subject_transform' requires server ${E}`)}if(c.compression){const{min:E,ok:k}=g.features.get(fr.JS_STREAM_COMPRESSION);if(!k)throw new Error(`stream 'compression' requires server ${E}`)}if(c.consumer_limits){const{min:E,ok:k}=g.features.get(fr.JS_DEFAULT_CONSUMER_LIMITS);if(!k)throw new Error(`stream 'consumer_limits' requires server ${E}`)}function x(E,k){if((k?.subject_transforms?.length||0)>0){const{min:l,ok:$}=g.features.get(fr.JS_STREAM_SOURCE_SUBJECT_TRANSFORM);if(!$)throw new Error(`${E} 'subject_transforms' requires server ${l}`)}}c.sources&&c.sources.forEach(E=>{x("stream sources",E)}),c.mirror&&x("stream mirror",c.mirror)}async add(c={}){this.checkStreamConfigVersions(c),as(c.name),c.mirror=ad(c.mirror),c.sources=c.sources?.map(ad);const x=await this._request(`${this.prefix}.STREAM.CREATE.${c.name}`,c);return this._fixInfo(x),x}async delete(c){return as(c),(await this._request(`${this.prefix}.STREAM.DELETE.${c}`)).success}async update(c,g={}){if(typeof c=="object"){const l=c;c=l.name,g=l,console.trace("\x1B[33m >> streams.update(config: StreamConfig) api changed to streams.update(name: string, config: StreamUpdateConfig) - this shim will be removed - update your code.  \x1B[0m")}this.checkStreamConfigVersions(g),as(c);const x=await this.info(c),E=Object.assign(x.config,g);E.mirror=ad(E.mirror),E.sources=E.sources?.map(ad);const S=await this._request(`${this.prefix}.STREAM.UPDATE.${c}`,E);return this._fixInfo(S),S}async info(c,g){as(c);const x=`${this.prefix}.STREAM.INFO.${c}`;let k=await this._request(x,g),{total:S,limit:l}=k,$=k.state.subjects?Object.getOwnPropertyNames(k.state.subjects).length:1;if(S&&S>$){const oe=[k],me=g||{};let we=0;for(;S>$;){we++,me.offset=l*we;const ze=await this._request(x,me);S=ze.total,oe.push(ze);const Ke=Object.getOwnPropertyNames(ze.state.subjects).length;if($+=Ke,Ke<l)break}let ye={};for(let ze=0;ze<oe.length;ze++)k=oe[ze],k.state.subjects&&(ye=Object.assign(ye,k.state.subjects));k.offset=0,k.total=0,k.limit=0,k.state.subjects=ye}return this._fixInfo(k),k}list(c=""){const g=c?.length?{subject:c}:{},x=k=>{const S=k;return S.streams.forEach(l=>{this._fixInfo(l)}),S.streams},E=`${this.prefix}.STREAM.LIST`;return new gu(E,x,this,g)}_fixInfo(c){c.config.sealed=c.config.sealed||!1,c.config.deny_delete=c.config.deny_delete||!1,c.config.deny_purge=c.config.deny_purge||!1,c.config.allow_rollup_hdrs=c.config.allow_rollup_hdrs||!1}async purge(c,g){if(g){const{keep:E,seq:k}=g;if(typeof E=="number"&&typeof k=="number")throw new Error("can specify one of keep or seq")}return as(c),await this._request(`${this.prefix}.STREAM.PURGE.${c}`,g)}async deleteMessage(c,g,x=!0){as(c);const E={seq:g};return x||(E.no_erase=!0),(await this._request(`${this.prefix}.STREAM.MSG.DELETE.${c}`,E)).success}async getMessage(c,g){as(c);const E=await this._request(`${this.prefix}.STREAM.MSG.GET.${c}`,g);return new H1(E)}find(c){return this.findStream(c)}listKvs(){const c=x=>{const k=x.streams.filter($=>$.config.name.startsWith(Ds));k.forEach($=>{this._fixInfo($)});let S="";return k.length&&(S=this.nc.info?.cluster??""),k.map($=>new dy($,S))},g=`${this.prefix}.STREAM.LIST`;return new gu(g,c,this)}listObjectStores(){const c=x=>{const k=x.streams.filter(l=>l.config.name.startsWith(Ff));return k.forEach(l=>{this._fixInfo(l)}),k.map(l=>new Mf(l))},g=`${this.prefix}.STREAM.LIST`;return new gu(g,c,this)}names(c=""){const g=c?.length?{subject:c}:{},x=k=>k.streams,E=`${this.prefix}.STREAM.NAMES`;return new gu(E,x,this,g)}async get(c){const g=await this.info(c);return Promise.resolve(new Ad(this,g))}}class G1 extends Mu{constructor(c,g){super(c,g)}async getMessage(c,g){as(c);let x=g;const{last_by_subj:E}=x;E&&(x=null);const k=x?this.jc.encode(x):Ls,S=this.opts.apiPrefix||"$JS.API",l=E?`${S}.DIRECT.GET.${c}.${E}`:`${S}.DIRECT.GET.${c}`,$=await this.nc.request(l,k,{timeout:this.timeout}),oe=Ul($);if(oe)return Promise.reject(oe);const me=new A_($);return Promise.resolve(me)}async getBatch(c,g){as(c);const E=`${this.opts.apiPrefix||"$JS.API"}.DIRECT.GET.${c}`;if(!Array.isArray(g.multi_last)||g.multi_last.length===0)return Promise.reject("multi_last is required");const k=JSON.stringify(g,($,oe)=>$==="up_to_time"&&oe instanceof Date?oe.toISOString():oe),S=new Oi,l=await this.nc.requestMany(E,k,{strategy:an.SentinelMsg});return(async()=>{let $=!1,oe=!1,me;for await(const we of l){if(!$){$=!0;const ye=we.headers?.code||0;if(ye!==0&&ye<200||ye>299){me=we.headers?.description.toLowerCase();break}if(we.headers?.get("Nats-Num-Pending")===""){oe=!0;break}}if(we.data.length===0)break;S.push(new A_(we))}S.push(()=>{if(oe)throw new Error("batch direct get not supported by the server");if(me)throw new Error(`bad request: ${me}`);S.stop()})})(),Promise.resolve(S)}}class A_{data;header;static jc;constructor(c){if(!c.headers)throw new Error("headers expected");this.data=c.data,this.header=c.headers}get subject(){return this.header.last(jl.Subject)}get seq(){const c=this.header.last(jl.Sequence);return typeof c=="string"?parseInt(c):0}get time(){return new Date(Date.parse(this.timestamp))}get timestamp(){return this.header.last(jl.TimeStamp)}get stream(){return this.header.last(jl.Stream)}json(c){return ln(c).decode(this.data)}string(){return Rs.decode(this.data)}}class Z1 extends Mu{streams;consumers;direct;constructor(c,g){super(c,g),this.streams=new Lf(c,g),this.consumers=new vd(c,g),this.direct=new G1(c,g)}async getAccountInfo(){return await this._request(`${this.prefix}.INFO`)}jetstream(){return this.nc.jetstream(this.getOptions())}advisories(){const c=new Oi;return this.nc.subscribe("$JS.EVENT.ADVISORY.>",{callback:(g,x)=>{if(g)throw g;try{const E=this.parseJsResponse(x),k=E.type.split("."),S=k[k.length-1];c.push({kind:S,data:E})}catch(E){c.stop(E)}}}),c}}class H1{_header;smr;static jc;constructor(c){this.smr=c}get subject(){return this.smr.message.subject}get seq(){return this.smr.message.seq}get timestamp(){return this.smr.message.time}get time(){return new Date(Date.parse(this.timestamp))}get data(){return this.smr.message.data?this._parse(this.smr.message.data):Ls}get header(){if(!this._header)if(this.smr.message.hdrs){const c=this._parse(this.smr.message.hdrs);this._header=Lo.decode(c)}else this._header=ro();return this._header}_parse(c){const g=atob(c),x=g.length,E=new Uint8Array(x);for(let k=0;k<x;k++)E[k]=g.charCodeAt(k);return E}json(c){return ln(c).decode(this.data)}string(){return Rs.decode(this.data)}}class W1{api;constructor(c){this.api=c}get(c){return this.api.info(c).then(g=>new Ad(this.api,g))}}class lf{info;hdrs;constructor(c){this.info=c}get name(){return this.info.name}get description(){return this.info.description??""}get headers(){return this.hdrs||(this.hdrs=Lo.fromRecord(this.info.headers||{})),this.hdrs}get options(){return this.info.options}get bucket(){return this.info.bucket}get chunks(){return this.info.chunks}get deleted(){return this.info.deleted??!1}get digest(){return this.info.digest}get mtime(){return this.info.mtime}get nuid(){return this.info.nuid}get size(){return this.info.size}get revision(){return this.info.revision}get metadata(){return this.info.metadata||{}}isLink(){return this.info.options?.link!==void 0&&this.info.options?.link!==null}}function C_(v){const c={name:v.name,description:v.description??"",options:v.options,metadata:v.metadata};if(v.headers){const g=v.headers;c.headers=g.toRecord()}return c}function X1(){return new ReadableStream({pull(v){v.enqueue(new Uint8Array(0)),v.close()}})}class bu{jsm;js;stream;name;constructor(c,g,x){this.name=c,this.jsm=g,this.js=x}_checkNotEmpty(c){return!c||c.length===0?{name:c,error:new Error("name cannot be empty")}:{name:c}}async info(c){const g=await this.rawInfo(c);return g?new lf(g):null}async list(){const c=[],g=await this.watch({ignoreDeletes:!0,includeHistory:!0});for await(const x of g){if(x===null)break;c.push(x)}return Promise.resolve(c)}async rawInfo(c){const{name:g,error:x}=this._checkNotEmpty(c);if(x)return Promise.reject(x);const E=this._metaSubject(g);try{const k=await this.jsm.streams.getMessage(this.stream,{last_by_subj:E}),l=ln().decode(k.data);return l.revision=k.seq,l}catch(k){return k.code==="404"?null:Promise.reject(k)}}async _si(c){try{return await this.jsm.streams.info(this.stream,c)}catch(g){return g.code==="404"?null:Promise.reject(g)}}async seal(){let c=await this._si();return c===null?Promise.reject(new Error("object store not found")):(c.config.sealed=!0,c=await this.jsm.streams.update(this.stream,c.config),Promise.resolve(new Mf(c)))}async status(c){const g=await this._si(c);return g===null?Promise.reject(new Error("object store not found")):Promise.resolve(new Mf(g))}destroy(){return this.jsm.streams.delete(this.stream)}async _put(c,g,x){const E=this.js.getOptions();x=x||{timeout:E.timeout},x.timeout=x.timeout||E.timeout,x.previousRevision=x.previousRevision??void 0;const{timeout:k,previousRevision:S}=x,$=this.js.nc.info?.max_payload||1024;c=c||{},c.options=c.options||{};let oe=c.options?.max_chunk_size||128*1024;oe=oe>$?$:oe,c.options.max_chunk_size=oe;const me=await this.info(c.name),{name:we,error:ye}=this._checkNotEmpty(c.name);if(ye)return Promise.reject(ye);const ze=Bo.next(),Ke=this._chunkSubject(ze),ot=this._metaSubject(we),ge=Object.assign({bucket:this.name,nuid:ze,size:0,chunks:0},C_(c)),Pt=ti(),xt=[],At=new Xl;try{const Qt=g?g.getReader():null,Fe=y_.create();for(;;){const{done:st,value:Ye}=Qt?await Qt.read():{done:!0,value:void 0};if(st){if(At.size()>0){const vt=At.drain();Fe.update(vt),ge.chunks++,ge.size+=vt.length,xt.push(this.js.publish(Ke,vt,{timeout:k}))}await Promise.all(xt),xt.length=0,ge.mtime=new Date().toISOString();const He=ql.encode(Fe.digest());ge.digest=`${M_}${He}`,ge.deleted=!1;const Ge=ro();typeof S=="number"&&Ge.set(En.ExpectedLastSubjectSequenceHdr,`${S}`),Ge.set(cs.RollupHdr,cs.RollupValueSubject);const pt=await this.js.publish(ot,ln().encode(ge),{headers:Ge,timeout:k});if(ge.revision=pt.seq,me)try{await this.jsm.streams.purge(this.stream,{filter:`$O.${this.name}.C.${me.nuid}`})}catch{}Pt.resolve(new lf(ge));break}if(Ye)for(At.fill(Ye);At.size()>oe;){ge.chunks++,ge.size+=oe;const He=At.drain(c.options.max_chunk_size);Fe.update(He),xt.push(this.js.publish(Ke,He,{timeout:k}))}}}catch(Qt){await this.jsm.streams.purge(this.stream,{filter:Ke}),Pt.reject(Qt)}return Pt}putBlob(c,g,x){function E(k){return new ReadableStream({pull(S){S.enqueue(k),S.close()}})}return g===null&&(g=new Uint8Array(0)),this.put(c,E(g),x)}put(c,g,x){return c?.options?.link?Promise.reject(new Error("link cannot be set when putting the object in bucket")):this._put(c,g,x)}async getBlob(c){async function g(k){const S=new Xl,l=k.getReader();for(;;){const{done:$,value:oe}=await l.read();if($)return S.drain();oe&&oe.length&&S.fill(oe)}}const x=await this.get(c);if(x===null)return Promise.resolve(null);const E=await Promise.all([x.error,g(x.data)]);return E[0]?Promise.reject(E[0]):Promise.resolve(E[1])}async get(c){const g=await this.rawInfo(c);if(g===null||g.deleted)return Promise.resolve(null);if(g.options&&g.options.link){const we=g.options.link.name||"";if(we==="")throw new Error("link is a bucket");return(g.options.link.bucket!==this.name?await bu.create(this.js,g.options.link.bucket):this).get(we)}if(!g.digest.startsWith(M_))return Promise.reject(new Error(`unknown digest type: ${g.digest}`));const x=wf(g.digest.substring(8));if(x===null)return Promise.reject(new Error(`unable to parse digest: ${g.digest}`));const E=ti(),k={info:new lf(g),error:E};if(g.size===0)return k.data=X1(),E.resolve(null),Promise.resolve(k);let S;const l=eo();l.orderedConsumer();const $=y_.create(),oe=`$O.${this.name}.C.${g.nuid}`,me=await this.js.subscribe(oe,l);return(async()=>{for await(const we of me)we.data.length>0&&($.update(we.data),S.enqueue(we.data)),we.info.pending===0&&(Lb(x,$.digest())?S.close():S.error(new Error(`received a corrupt object, digests do not match received: ${g.digest} calculated ${x}`)),me.unsubscribe())})().then(()=>{E.resolve()}).catch(we=>{S.error(we),E.reject(we)}),k.data=new ReadableStream({start(we){S=we},cancel(){me.unsubscribe()}}),k}linkStore(c,g){if(!(g instanceof bu))return Promise.reject("bucket required");const x=g,{name:E,error:k}=this._checkNotEmpty(c);if(k)return Promise.reject(k);const S={name:E,options:{link:{bucket:x.name}}};return this._put(S,null)}async link(c,g){const{name:x,error:E}=this._checkNotEmpty(c);if(E)return Promise.reject(E);if(g.deleted)return Promise.reject(new Error("src object is deleted"));if(g.isLink())return Promise.reject(new Error("src object is a link"));const k=await this.rawInfo(c);if(k!==null&&!k.deleted)return Promise.reject(new Error("an object already exists with that name"));const S={bucket:g.bucket,name:g.name},l={name:x,bucket:g.bucket,options:{link:S}};await this.js.publish(this._metaSubject(c),JSON.stringify(l));const $=await this.info(c);return Promise.resolve($)}async delete(c){const g=await this.rawInfo(c);if(g===null)return Promise.resolve({purged:0,success:!1});g.deleted=!0,g.size=0,g.chunks=0,g.digest="";const x=ln(),E=ro();return E.set(cs.RollupHdr,cs.RollupValueSubject),await this.js.publish(this._metaSubject(g.name),x.encode(g),{headers:E}),this.jsm.streams.purge(this.stream,{filter:this._chunkSubject(g.nuid)})}async update(c,g={}){const x=await this.rawInfo(c);if(x===null)return Promise.reject(new Error("object not found"));if(x.deleted)return Promise.reject(new Error("cannot update meta for a deleted object"));g.name=g.name??x.name;const{name:E,error:k}=this._checkNotEmpty(g.name);if(k)return Promise.reject(k);if(c!==g.name){const $=await this.info(g.name);if($&&!$.deleted)return Promise.reject(new Error("an object already exists with that name"))}g.name=E;const S=Object.assign({},x,C_(g)),l=await this.js.publish(this._metaSubject(S.name),JSON.stringify(S));return c!==g.name&&await this.jsm.streams.purge(this.stream,{filter:this._metaSubject(c)}),Promise.resolve(l)}async watch(c={}){c.includeHistory=c.includeHistory??!1,c.ignoreDeletes=c.ignoreDeletes??!1;let g=!1;const x=new Oi,E=this._metaSubjectAll();try{await this.jsm.streams.getMessage(this.stream,{last_by_subj:E})}catch($){$.code==="404"?(x.push(null),g=!0):x.stop($)}const k=ln(),S=eo();S.orderedConsumer(),c.includeHistory?S.deliverLastPerSubject():(g=!0,S.deliverNew()),S.callback(($,oe)=>{if($){x.stop($);return}if(oe!==null){const me=k.decode(oe.data);me.deleted&&c.ignoreDeletes===!0||x.push(me),oe.info?.pending===0&&!g&&(g=!0,x.push(null))}});const l=await this.js.subscribe(E,S);return x._data=l,x.iterClosed.then(()=>{l.unsubscribe()}),l.closed.then(()=>{x.stop()}).catch($=>{x.stop($)}),x}_chunkSubject(c){return`$O.${this.name}.C.${c}`}_metaSubject(c){return`$O.${this.name}.M.${ql.encode(c)}`}_metaSubjectAll(){return`$O.${this.name}.M.>`}async init(c={}){try{this.stream=O1(this.name)}catch(E){return Promise.reject(E)}const g=c?.ttl||0;delete c.ttl;const x=Object.assign({max_age:g},c);x.name=this.stream,x.num_replicas=c.replicas??1,x.allow_direct=!0,x.allow_rollup_hdrs=!0,x.discard=wu.New,x.subjects=[`$O.${this.name}.C.>`,`$O.${this.name}.M.>`],c.placement&&(x.placement=c.placement),c.metadata&&(x.metadata=c.metadata),typeof c.compression=="boolean"&&(x.compression=c.compression?jo.S2:jo.None);try{await this.jsm.streams.info(x.name)}catch(E){E.message==="stream not found"&&await this.jsm.streams.add(x)}}static async create(c,g,x={}){const E=await c.jetstreamManager(),k=new bu(g,E,c);return await k.init(x),Promise.resolve(k)}}class Y1{js;constructor(c){this.js=c}kv(c,g={}){const x=this.js,{ok:E,min:k}=x.nc.features.get(fr.JS_KV);return E?g.bindOnly?Su.bind(this.js,c,g):Su.create(this.js,c,g):Promise.reject(new Error(`kv is only supported on servers ${k} or better`))}os(c,g={}){if(typeof crypto?.subtle?.digest!="function")return Promise.reject(new Error("objectstore: unable to calculate hashes - crypto.subtle.digest with sha256 support is required"));const x=this.js,{ok:E,min:k}=x.nc.features.get(fr.JS_OBJECTSTORE);return E?bu.create(this.js,c,g):Promise.reject(new Error(`objectstore is only supported on servers ${k} or better`))}}class Of extends Mu{consumers;streams;consumerAPI;streamAPI;constructor(c,g){super(c,g),this.consumerAPI=new vd(c,g),this.streamAPI=new Lf(c,g),this.consumers=new Af(this.consumerAPI),this.streams=new W1(this.streamAPI)}jetstreamManager(c){c===void 0&&(c=this.opts.checkAPI);const g=Object.assign({},this.opts,{checkAPI:c});return this.nc.jetstreamManager(g)}get apiPrefix(){return this.prefix}get views(){return new Y1(this)}async publish(c,g=Ls,x){x=x||{},x.expect=x.expect||{};const E=x?.headers||ro();x&&(x.msgID&&E.set(En.MsgIdHdr,x.msgID),x.expect.lastMsgID&&E.set(En.ExpectedLastMsgIdHdr,x.expect.lastMsgID),x.expect.streamName&&E.set(En.ExpectedStreamHdr,x.expect.streamName),typeof x.expect.lastSequence=="number"&&E.set(En.ExpectedLastSeqHdr,`${x.expect.lastSequence}`),typeof x.expect.lastSubjectSequence=="number"&&E.set(En.ExpectedLastSubjectSequenceHdr,`${x.expect.lastSubjectSequence}`));const k=x.timeout||this.timeout,S={};k&&(S.timeout=k),x&&(S.headers=E);let{retries:l,retry_delay:$}=x;l=l||1,$=$||250;let oe;for(let we=0;we<l;we++)try{oe=await this.nc.request(c,g,S);break}catch(ye){if(ye.code==="503"&&we+1<l)await Jl($);else throw ye}const me=this.parseJsResponse(oe);if(me.stream==="")throw St.errorForCode(ct.JetStreamInvalidAck);return me.duplicate=me.duplicate?me.duplicate:!1,me}async pull(c,g,x=0){as(c),$l(g);let E=this.timeout;x>E&&(E=x),x=x<0?0:ei(x);const k={batch:1,no_wait:x===0,expires:x},S=await this.nc.request(`${this.prefix}.CONSUMER.MSG.NEXT.${c}.${g}`,this.jc.encode(k),{noMux:!0,timeout:E}),l=Ul(S);if(l)throw l;return Pu(S,this.timeout)}fetch(c,g,x={}){as(c),$l(g);let E=null;const k=(x.max_bytes??0)>0;let S=0;const l=k?x.max_bytes:0;let $=null;const oe={};if(oe.batch=x.batch||1,l){const Pt=this.nc.features.get(fr.JS_PULL_MAX_BYTES);if(!Pt.ok)throw new Error(`max_bytes is only supported on servers ${Pt.min} or better`);oe.max_bytes=l}oe.no_wait=x.no_wait||!1,oe.no_wait&&oe.expires&&(oe.expires=0);const me=x.expires||0;if(me&&(oe.expires=ei(me)),me===0&&oe.no_wait===!1)throw new Error("expires or no_wait is required");const we=x.idle_heartbeat||0;we&&(oe.idle_heartbeat=ei(we),x.delay_heartbeat===!0&&(oe.idle_heartbeat=ei(we*4)));const ye=new Oi,ze=oe.batch;let Ke=0;ye.protocolFilterFn=(Pt,xt=!1)=>xf(Pt.msg)?($?.work(),!1):!0,ye.dispatchedFn=Pt=>{if(Pt){if(k&&(S+=Pt.data.length),Ke++,E&&Pt.info.pending===0)return;(ye.getPending()===1&&Pt.info.pending===0||ze===Ke||l>0&&S>=l)&&ye.stop()}};const ot=An(this.nc.options.inboxPrefix),ge=this.nc.subscribe(ot,{max:x.batch,callback:(Pt,xt)=>{Pt===null&&(Pt=Ul(xt)),Pt!==null?(E&&(E.cancel(),E=null),_b(Pt)?ye.stop(fy(Pt)===null?void 0:Pt):ye.stop(Pt)):($?.work(),ye.received++,ye.push(Pu(xt,this.timeout)))}});return me&&(E=Hl(me),E.catch(()=>{ge.isClosed()||(ge.drain().catch(()=>{}),E=null),$&&$.cancel()})),(async()=>{try{we&&($=new Rf(we,Pt=>(ye.push(()=>{ye.err=new St(`${Zs.IdleHeartbeatMissed}: ${Pt}`,ct.JetStreamIdleHeartBeat)}),!0)))}catch{}await ge.closed,E!==null&&(E.cancel(),E=null),$&&$.cancel(),ye.stop()})().catch(),this.nc.publish(`${this.prefix}.CONSUMER.MSG.NEXT.${c}.${g}`,this.jc.encode(oe),{reply:ot}),ye}async pullSubscribe(c,g=eo()){const x=await this._processOptions(c,g);if(x.ordered)throw new Error("pull subscribers cannot be be ordered");if(x.config.deliver_subject)throw new Error("consumer info specifies deliver_subject - pull consumers cannot have deliver_subject set");const E=x.config.ack_policy;if(E===Fi.None||E===Fi.All)throw new Error("ack policy for pull consumers must be explicit");const k=this._buildTypedSubscriptionOpts(x),S=new ew(this,x.deliver,k);S.info=x;try{await this._maybeCreateConsumer(x)}catch(l){throw S.unsubscribe(),l}return S}async subscribe(c,g=eo()){const x=await this._processOptions(c,g);if(!x.isBind&&!x.config.deliver_subject)throw new Error("push consumer requires deliver_subject");const E=this._buildTypedSubscriptionOpts(x),k=new py(this,x.deliver,E);k.info=x;try{await this._maybeCreateConsumer(x)}catch(S){throw k.unsubscribe(),S}return k._maybeSetupHbMonitoring(),k}async _processOptions(c,g=eo()){const x=f_(g)?g.getOpts():g;if(x.isBind=f_(g)?g.isBind:!1,x.flow_control={heartbeat_count:0,fc_count:0,consumer_restarts:0},x.ordered){if(x.ordered_consumer_sequence={stream_seq:0,delivery_seq:0},x.config.ack_policy!==Fi.NotSet&&x.config.ack_policy!==Fi.None)throw new St("ordered consumer: ack_policy can only be set to 'none'",ct.ApiError);if(x.config.durable_name&&x.config.durable_name.length>0)throw new St("ordered consumer: durable_name cannot be set",ct.ApiError);if(x.config.deliver_subject&&x.config.deliver_subject.length>0)throw new St("ordered consumer: deliver_subject cannot be set",ct.ApiError);if(x.config.max_deliver!==void 0&&x.config.max_deliver>1)throw new St("ordered consumer: max_deliver cannot be set",ct.ApiError);if(x.config.deliver_group&&x.config.deliver_group.length>0)throw new St("ordered consumer: deliver_group cannot be set",ct.ApiError);x.config.deliver_subject=An(this.nc.options.inboxPrefix),x.config.ack_policy=Fi.None,x.config.max_deliver=1,x.config.flow_control=!0,x.config.idle_heartbeat=x.config.idle_heartbeat||ei(5e3),x.config.ack_wait=ei(1320*60*1e3),x.config.mem_storage=!0,x.config.num_replicas=1}if(x.config.ack_policy===Fi.NotSet&&(x.config.ack_policy=Fi.All),x.api=this,x.config=x.config||{},x.stream=x.stream?x.stream:await this.findStream(c),x.attached=!1,x.config.durable_name)try{const E=await this.consumerAPI.info(x.stream,x.config.durable_name);if(E){if(E.config.filter_subject&&E.config.filter_subject!==c)throw new Error("subject does not match consumer");const k=x.config.deliver_group??"";if(k===""&&E.push_bound===!0)throw new Error("duplicate subscription");const S=E.config.deliver_group??"";if(k!==S)throw S===""?new Error("durable requires no queue group"):new Error(`durable requires queue group '${S}'`);x.last=E,x.config=E.config,x.attached=!0,x.config.durable_name||(x.name=E.name)}}catch(E){if(E.code!=="404")throw E}return!x.attached&&x.config.filter_subject===void 0&&x.config.filter_subjects===void 0&&(x.config.filter_subject=c),x.deliver=x.config.deliver_subject||An(this.nc.options.inboxPrefix),x}_buildTypedSubscriptionOpts(c){const g={};return g.adapter=tw(c.callbackFn===void 0,this.timeout),g.ingestionFilterFn=Of.ingestionFn(c.ordered),g.protocolFilterFn=(x,E=!1)=>{const k=x;return yf(k.msg)?(E||k.msg.respond(),!1):!0},!c.mack&&c.config.ack_policy!==Fi.None&&(g.dispatchedFn=sw),c.callbackFn&&(g.callback=c.callbackFn),g.max=c.max||0,g.queue=c.queue,g}async _maybeCreateConsumer(c){if(c.attached)return;if(c.isBind)throw new Error(`unable to bind - durable consumer ${c.config.durable_name} doesn't exist in ${c.stream}`);c.config=Object.assign({deliver_policy:pi.All,ack_policy:Fi.Explicit,ack_wait:ei(30*1e3),replay_policy:Wl.Instant},c.config);const g=await this.consumerAPI.add(c.stream,c.config);if(Array.isArray(c.config.filter_subjects&&!Array.isArray(g.config.filter_subjects)))throw new Error("jetstream server doesn't support consumers with multiple filter subjects");c.name=g.name,c.config=g.config,c.last=g}static ingestionFn(c){return(g,x)=>{const E=x;if(!g)return{ingest:!1,protocol:!1};const k=g;if(Ul(k.msg)||E.monitor?.work(),xf(k.msg)){const l=c?E._checkHbOrderConsumer(k.msg):!0;return c||E.info.flow_control.heartbeat_count++,{ingest:l,protocol:!0}}else if(yf(k.msg))return E.info.flow_control.fc_count++,{ingest:!0,protocol:!0};return{ingest:c?E._checkOrderedConsumer(g):!0,protocol:!1}}}}class Bf{options;protocol;draining;listeners;_services;constructor(c){this.draining=!1,this.options=y1(c),this.listeners=[]}static connect(c={}){return new Promise((g,x)=>{const E=new Bf(c);wd.connect(E.options,E).then(k=>{E.protocol=k,(async function(){for await(const S of k.status())E.listeners.forEach(l=>{l.push(S)})})(),g(E)}).catch(k=>{x(k)})})}closed(){return this.protocol.closed}async close(){await this.protocol.close()}_check(c,g,x){if(this.isClosed())throw St.errorForCode(ct.ConnectionClosed);if(g&&this.isDraining()||x&&this.protocol.noMorePublishing)throw St.errorForCode(ct.ConnectionDraining);if(c=c||"",c.length===0)throw St.errorForCode(ct.BadSubject)}publish(c,g,x){this._check(c,!1,!0),this.protocol.publish(c,g,x)}publishMessage(c){return this.publish(c.subject,c.data,{reply:c.reply,headers:c.headers})}respondMessage(c){return c.reply?(this.publish(c.reply,c.data,{reply:c.reply,headers:c.headers}),!0):!1}subscribe(c,g={}){this._check(c,!0,!1);const x=new uy(this.protocol,c,g);return this.protocol.subscribe(x),x}_resub(c,g,x){this._check(g,!0,!1);const E=c;E.max=x,x&&(E.max=x+E.received),this.protocol.resub(E,g)}requestMany(c,g=Ls,x={maxWait:1e3,maxMessages:-1}){const E=!this.protocol.options.noAsyncTraces;try{this._check(c,!0,!0)}catch($){return Promise.reject($)}if(x.strategy=x.strategy||an.Timer,x.maxWait=x.maxWait||1e3,x.maxWait<1)return Promise.reject(new St("timeout",ct.InvalidOption));const k=new Oi;function S($){k.push(()=>{k.stop($)})}function l($,oe){$||oe===null?S($===null?void 0:$):k.push(oe)}if(x.noMux){const $=E?new Error().stack:null;let oe=typeof x.maxMessages=="number"&&x.maxMessages>0?x.maxMessages:-1;const me=this.subscribe(An(this.options.inboxPrefix),{callback:(Ke,ot)=>{if(ot?.data?.length===0&&ot?.headers?.status===ct.NoResponders&&(Ke=St.errorForCode(ct.NoResponders)),Ke){$&&(Ke.stack+=`

${$}`),we(Ke);return}l(null,ot),x.strategy===an.Count&&(oe--,oe===0&&we()),x.strategy===an.JitterTimer&&(ze(),ye=setTimeout(()=>{we()},300)),x.strategy===an.SentinelMsg&&ot&&ot.data.length===0&&we()}});me.requestSubject=c,me.closed.then(()=>{S()}).catch(Ke=>{k.stop(Ke)});const we=Ke=>{Ke&&k.push(()=>{throw Ke}),ze(),me.drain().then(()=>{S()}).catch(ot=>{S()})};k.iterClosed.then(()=>{ze(),me?.unsubscribe()}).catch(Ke=>{ze(),me?.unsubscribe()});try{this.publish(c,g,{reply:me.getSubject()})}catch(Ke){we(Ke)}let ye=setTimeout(()=>{we()},x.maxWait);const ze=()=>{ye&&clearTimeout(ye)}}else{const $=x;$.callback=l,k.iterClosed.then(()=>{oe.cancel()}).catch(me=>{oe.cancel(me)});const oe=new Ob(this.protocol.muxSubscriptions,c,$);this.protocol.request(oe);try{this.publish(c,g,{reply:`${this.protocol.muxSubscriptions.baseInbox}${oe.token}`,headers:x.headers})}catch(me){oe.cancel(me)}}return Promise.resolve(k)}request(c,g,x={timeout:1e3,noMux:!1}){try{this._check(c,!0,!0)}catch(k){return Promise.reject(k)}const E=!this.protocol.options.noAsyncTraces;if(x.timeout=x.timeout||1e3,x.timeout<1)return Promise.reject(new St("timeout",ct.InvalidOption));if(!x.noMux&&x.reply)return Promise.reject(new St("reply can only be used with noMux",ct.InvalidOption));if(x.noMux){const k=x.reply?x.reply:An(this.options.inboxPrefix),S=ti(),l=E?new Error:null,$=this.subscribe(k,{max:1,timeout:x.timeout,callback:(oe,me)=>{oe?(l&&oe.code!==ct.Timeout&&(oe.stack+=`

${l.stack}`),$.unsubscribe(),S.reject(oe)):(oe=ey(me),oe?(l&&(oe.stack+=`

${l.stack}`),S.reject(oe)):S.resolve(me))}});return $.requestSubject=c,this.protocol.publish(c,g,{reply:k,headers:x.headers}),S}else{const k=new sy(this.protocol.muxSubscriptions,c,x,E);this.protocol.request(k);try{this.publish(c,g,{reply:`${this.protocol.muxSubscriptions.baseInbox}${k.token}`,headers:x.headers})}catch(l){k.cancel(l)}const S=Promise.race([k.timer,k.deferred]);return S.catch(()=>{k.cancel()}),S}}flush(){return this.isClosed()?Promise.reject(St.errorForCode(ct.ConnectionClosed)):this.protocol.flush()}drain(){return this.isClosed()?Promise.reject(St.errorForCode(ct.ConnectionClosed)):this.isDraining()?Promise.reject(St.errorForCode(ct.ConnectionDraining)):(this.draining=!0,this.protocol.drain())}isClosed(){return this.protocol.isClosed()}isDraining(){return this.draining}getServer(){const c=this.protocol.getServer();return c?c.listen:""}status(){const c=new Oi;return c.iterClosed.then(()=>{const g=this.listeners.indexOf(c);this.listeners.splice(g,1)}),this.listeners.push(c),c}get info(){return this.protocol.isClosed()?void 0:this.protocol.info}async context(){return(await this.request("$SYS.REQ.USER.INFO")).json((g,x)=>g==="time"?new Date(Date.parse(x)):x)}stats(){return{inBytes:this.protocol.inBytes,outBytes:this.protocol.outBytes,inMsgs:this.protocol.inMsgs,outMsgs:this.protocol.outMsgs}}async jetstreamManager(c={}){const g=new Z1(this,c);if(c.checkAPI!==!1)try{await g.getAccountInfo()}catch(x){const E=x;throw E.code===ct.NoResponders&&(E.code=ct.JetStreamNotEnabled),E}return g}jetstream(c={}){return new Of(this,c)}getServerVersion(){const c=this.info;return c?Da(c.version):void 0}async rtt(){if(!this.protocol._closed&&!this.protocol.connected)throw St.errorForCode(ct.Disconnect);const c=Date.now();return await this.flush(),Date.now()-c}get features(){return this.protocol.features}get services(){return this._services||(this._services=new J1(this)),this._services}reconnect(){return this.isClosed()?Promise.reject(St.errorForCode(ct.ConnectionClosed)):this.isDraining()?Promise.reject(St.errorForCode(ct.ConnectionDraining)):this.protocol.reconnect()}}class J1{nc;constructor(c){this.nc=c}add(c){try{return new Iu(this.nc,c).start()}catch(g){return Promise.reject(g)}}client(c,g){return new A1(this.nc,c,g)}}class K1{bucket;sm;prefixLen;constructor(c,g,x){this.bucket=c,this.prefixLen=g,this.sm=x}get key(){return this.sm.subject.substring(this.prefixLen)}get value(){return this.sm.data}get delta(){return 0}get created(){return this.sm.time}get revision(){return this.sm.seq}get operation(){return this.sm.header.get(Td)||"PUT"}get length(){const c=this.sm.header.get(cs.MessageSizeHdr)||"";return c!==""?parseInt(c,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class Q1{bucket;key;sm;constructor(c,g,x){this.bucket=c,this.key=g,this.sm=x}get value(){return this.sm.data}get created(){return new Date(zf(this.sm.info.timestampNanos))}get revision(){return this.sm.seq}get operation(){return this.sm.headers?.get(Td)||"PUT"}get delta(){return this.sm.info.pending}get length(){const c=this.sm.headers?.get(cs.MessageSizeHdr)||"";return c!==""?parseInt(c,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class py extends Vb{js;monitor;constructor(c,g,x){super(c.nc,g,x),this.js=c,this.monitor=null,this.sub.closed.then(()=>{this.monitor&&this.monitor.cancel()})}set info(c){this.sub.info=c}get info(){return this.sub.info}_resetOrderedConsumer(c){if(this.info===null||this.sub.isClosed())return;const g=An(this.js.nc.options.inboxPrefix);this.js.nc._resub(this.sub,g);const E=this.info;E.config.name=Bo.next(),E.ordered_consumer_sequence.delivery_seq=0,E.flow_control.heartbeat_count=0,E.flow_control.fc_count=0,E.flow_control.consumer_restarts++,E.deliver=g,E.config.deliver_subject=g,E.config.deliver_policy=pi.StartSequence,E.config.opt_start_seq=c;const k={};k.stream_name=this.info.stream,k.config=E.config;const S=`${E.api.prefix}.CONSUMER.CREATE.${E.stream}`;this.js._request(S,k,{retries:-1}).then(l=>{const $=l,oe=this.sub.info;oe.last=$,this.info.config=$.config,this.info.name=$.name}).catch(l=>{const $=new St(`unable to recreate ordered consumer ${E.stream} at seq ${c}`,ct.RequestError,l);this.sub.callback($,{})})}_maybeSetupHbMonitoring(){const c=this.info?.config?.idle_heartbeat||0;c&&this._setupHbMonitoring(zf(c))}_setupHbMonitoring(c,g=0){const x={cancelAfter:0,maxOut:2};g&&(x.cancelAfter=g);const E=this.sub,k=S=>{const l=bb(409,`${Zs.IdleHeartbeatMissed}: ${S}`,this.sub.subject);if(!this.info?.ordered)this.sub.callback(null,l);else{if(!this.js.nc.protocol.connected)return!1;const oe=this.info?.ordered_consumer_sequence?.stream_seq||0;return this._resetOrderedConsumer(oe+1),this.monitor?.restart(),!1}return!E.noIterator};this.monitor=new Rf(c,k,x)}_checkHbOrderConsumer(c){const g=c.headers.get(cs.ConsumerStalledHdr);g!==""&&this.js.nc.publish(g);const x=parseInt(c.headers.get(cs.LastConsumerSeqHdr),10),E=this.info.ordered_consumer_sequence;return this.info.flow_control.heartbeat_count++,x!==E.delivery_seq&&this._resetOrderedConsumer(E.stream_seq+1),!1}_checkOrderedConsumer(c){const g=this.info.ordered_consumer_sequence,x=c.info.streamSequence,E=c.info.deliverySequence;return E!=g.delivery_seq+1?(this._resetOrderedConsumer(g.stream_seq+1),!1):(g.delivery_seq=E,g.stream_seq=x,!0)}async destroy(){this.isClosed()||await this.drain();const c=this.sub.info,g=c.config.durable_name||c.name,x=`${c.api.prefix}.CONSUMER.DELETE.${c.stream}.${g}`;await c.api._request(x)}async consumerInfo(){const c=this.sub.info,g=c.config.durable_name||c.name,x=`${c.api.prefix}.CONSUMER.INFO.${c.stream}.${g}`,E=await c.api._request(x);return c.last=E,E}}class ew extends py{constructor(c,g,x){super(c,g,x)}pull(c={batch:1}){const{stream:g,config:x,name:E}=this.sub.info,k=x.durable_name??E,S={};if(S.batch=c.batch||1,S.no_wait=c.no_wait||!1,(c.max_bytes??0)>0){const oe=this.js.nc.features.get(fr.JS_PULL_MAX_BYTES);if(!oe.ok)throw new Error(`max_bytes is only supported on servers ${oe.min} or better`);S.max_bytes=c.max_bytes}let l=0;c.expires&&c.expires>0&&(l=c.expires,S.expires=ei(l));let $=0;if(c.idle_heartbeat&&c.idle_heartbeat>0&&($=c.idle_heartbeat,S.idle_heartbeat=ei($)),$&&l===0)throw new Error("idle_heartbeat requires expires");if($>l)throw new Error("expires must be greater than idle_heartbeat");if(this.info){this.monitor&&this.monitor.cancel(),l&&$&&(this.monitor?this.monitor._change($,l):this._setupHbMonitoring($,l));const oe=this.info.api,me=`${oe.prefix}.CONSUMER.MSG.NEXT.${g}.${k}`,we=this.sub.subject;oe.nc.publish(me,oe.jc.encode(S),{reply:we})}}}function tw(v,c){return v?iw(c):rw(c)}function rw(v){return(c,g)=>c?[c,null]:(c=Ul(g),c?[c,null]:[null,Pu(g,v)])}function iw(v){return(c,g)=>{if(c)return[c,null];const x=Ul(g);return x!==null?[fy(x),null]:[null,Pu(g,v)]}}function fy(v){if(v!==null)switch(v.code){case ct.JetStream404NoMessages:case ct.JetStream408RequestTimeout:return null;case ct.JetStream409:return wb(v)?v:null;default:return v}return null}function sw(v){v&&v.ack()}function nw(v){const c=v.split(".");if(c.length===9&&c.splice(2,0,"_",""),c.length<11||c[0]!=="$JS"||c[1]!=="ACK")throw new Error("not js message");const g={};return g.domain=c[2]==="_"?"":c[2],g.account_hash=c[3],g.stream=c[4],g.consumer=c[5],g.deliveryCount=parseInt(c[6],10),g.redeliveryCount=g.deliveryCount,g.redelivered=g.deliveryCount>1,g.streamSequence=parseInt(c[7],10),g.deliverySequence=parseInt(c[8],10),g.timestampNanos=parseInt(c[9],10),g.pending=parseInt(c[10],10),g}class ow{msg;di;didAck;timeout;constructor(c,g){this.msg=c,this.didAck=!1,this.timeout=g}get subject(){return this.msg.subject}get sid(){return this.msg.sid}get data(){return this.msg.data}get headers(){return this.msg.headers}get info(){return this.di||(this.di=nw(this.reply)),this.di}get redelivered(){return this.info.deliveryCount>1}get reply(){return this.msg.reply||""}get seq(){return this.info.streamSequence}doAck(c){this.didAck||(this.didAck=!this.isWIP(c),this.msg.respond(c))}isWIP(c){return c.length===4&&c[0]===fu[0]&&c[1]===fu[1]&&c[2]===fu[2]&&c[3]===fu[3]}async ackAck(c){c=c||{},c.timeout=c.timeout||this.timeout;const g=ti();if(this.didAck)g.resolve(!1);else if(this.didAck=!0,this.msg.reply){const E=this.msg.publisher,k=!E.options?.noAsyncTraces,S=new sy(E.muxSubscriptions,this.msg.reply,{timeout:c.timeout},k);E.request(S);try{E.publish(this.msg.reply,I_,{reply:`${E.muxSubscriptions.baseInbox}${S.token}`})}catch(l){S.cancel(l)}try{await Promise.race([S.timer,S.deferred]),g.resolve(!0)}catch(l){S.cancel(l),g.reject(l)}}else g.resolve(!1);return g}ack(){this.doAck(I_)}nak(c){let g=j1;c&&(g=_f().encode(`-NAK ${JSON.stringify({delay:ei(c)})}`)),this.doAck(g)}working(){this.doAck(fu)}next(c,g={batch:1}){const x={};x.batch=g.batch||1,x.no_wait=g.no_wait||!1,g.expires&&g.expires>0&&(x.expires=ei(g.expires));const E=ln().encode(x),k=Xl.concat(N1,$1,E),S=c?{reply:c}:void 0;this.msg.respond(k,S)}term(c=""){let g=V1;c?.length>0&&(g=_f().encode(`+TERM ${c}`)),this.doAck(g)}json(){return this.msg.json()}string(){return this.msg.string()}}const aw="1.30.3",lw="nats.ws";class cw{version;lang;closeError;connected;done;socket;options;socketClosed;encrypted;peeked;yields;signal;closedNotification;constructor(){this.version=aw,this.lang=lw,this.connected=!1,this.done=!1,this.socketClosed=!1,this.encrypted=!1,this.peeked=!1,this.yields=[],this.signal=ti(),this.closedNotification=ti()}async connect(c,g){const x=ti();if(g.tls)return x.reject(new St("tls",ct.InvalidOption)),x;this.options=g;const E=c.src;if(g.wsFactory){const{socket:k,encrypted:S}=await g.wsFactory(c.src,g);this.socket=k,this.encrypted=S}else this.encrypted=E.indexOf("wss://")===0,this.socket=new WebSocket(E);return this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{this.isDiscarded()},this.socket.onmessage=k=>{if(this.isDiscarded())return;if(this.yields.push(new Uint8Array(k.data)),this.peeked){this.signal.resolve();return}const S=Xl.concat(...this.yields),l=Hb(S);if(l!==""){const $=b1.exec(l);if(!$){g.debug&&console.error("!!!",sd(S)),x.reject(new Error("unexpected response from server"));return}try{const oe=JSON.parse($[1]);x1(oe,this.options),this.peeked=!0,this.connected=!0,this.signal.resolve(),x.resolve()}catch(oe){x.reject(oe);return}}},this.socket.onclose=k=>{if(this.isDiscarded())return;this.socketClosed=!0;let S;this.done||(k.wasClean||(S=new Error(k.reason)),this._closed(S))},this.socket.onerror=k=>{if(this.isDiscarded())return;const S=k,l=new St(S.message,ct.Unknown,new Error(S.error));x.reject(l)},x}disconnect(){this._closed(void 0,!0)}async _closed(c,g=!0){if(!this.isDiscarded()&&this.connected&&!this.done){if(this.closeError=c,!c)for(;!this.socketClosed&&this.socket.bufferedAmount>0;)await Jl(100);this.done=!0;try{this.socket.close(c?1002:1e3,c?c.message:void 0)}catch{}g&&this.closedNotification.resolve(c)}}get isClosed(){return this.done}[Symbol.asyncIterator](){return this.iterate()}async*iterate(){for(;;){if(this.isDiscarded())return;this.yields.length===0&&await this.signal;const c=this.yields;this.yields=[];for(let g=0;g<c.length;g++)this.options.debug&&console.info(`> ${sd(c[g])}`),yield c[g];if(this.done)break;this.yields.length===0&&(c.length=0,this.yields=c,this.signal=ti())}}isEncrypted(){return this.connected&&this.encrypted}send(c){if(!this.isDiscarded())try{this.socket.send(c.buffer),this.options.debug&&console.info(`< ${sd(c)}`);return}catch(g){this.options.debug&&console.error(`!!! ${sd(c)}: ${g}`)}}close(c){return this._closed(c,!1)}closed(){return this.closedNotification}isDiscarded(){return this.done?(this.discard(),!0):!1}discard(){this.done=!0;try{this.socket?.close()}catch{}}}function uw(v,c){/^(.*:\/\/)(.*)/.test(v)||(typeof c=="boolean"?v=`${c===!0?"https":"http"}://${v}`:v=`https://${v}`);let x=new URL(v);const E=x.protocol.toLowerCase();E==="ws:"&&(c=!1),E==="wss:"&&(c=!0),E!=="https:"&&E!=="http"&&(v=v.replace(/^(.*:\/\/)(.*)/gm,"$2"),x=new URL(`http://${v}`));let k,S;const l=x.hostname,$=x.pathname,oe=x.search||"";switch(E){case"http:":case"ws:":case"nats:":S=x.port||"80",k="ws:";break;case"https:":case"wss:":case"tls:":S=x.port||"443",k="wss:";break;default:S=x.port||c===!0?"443":"80",k=c===!0?"wss:":"ws:";break}return`${k}//${l}:${S}${$}${oe}`}function hw(v={}){return $b({defaultPort:443,urlParseFn:uw,factory:()=>new cw}),Bf.connect(v)}const dw=_f(),pw="---";class fw{isConnected=wi(!1);vehicles=wi({});stops=wi({});trips=wi({});subscriptions=wi({});subscriptionsQueue={};nc;js=wi();constructor(c=!0){c&&this.load()}async load(){this.nc=await hw({servers:[Qx],waitOnFirstConnect:!0,maxReconnectAttempts:-1}),this.isConnected.value=!0,this.js.value=this.nc.jetstream(),await this.processSubscriptionsQueue(),(async()=>{if(!this.nc)throw new Error("NATS connection is not initialized");for await(const c of this.nc.status())c.type===nn.Disconnect&&(this.isConnected.value=!1),c.type===nn.Reconnect&&(this.isConnected.value=!0,await this.processSubscriptionsQueue())})()}async subscribe(c,g){if(this.subscriptions.value[c])return;if(!this.isConnected.value||!this.js.value){this.subscriptionsQueue[c]=g;return}let x=()=>{};this.subscriptions.value[c]={pending:new Promise(S=>{x=S})};const E=eo();E.deliverTo(An()),E.deliverAll(),E.ackNone(),E.replayInstantly();const k=await this.js.value.subscribe(c,E);this.subscriptions.value[c].subscription=k,x(),(async()=>{for await(const S of k){const l=dw.decode(S.data);if(l!==pw){const $=JSON.parse(l);l!==JSON.stringify(g.value[$.id])&&(g.value=Object.freeze({...g.value,[$.id]:Object.freeze($)}))}}})()}async unsubscribe(c){if(this.subscriptions.value[c]){const{pending:g}=this.subscriptions.value[c];g&&await g,this.subscriptions.value[c]?.subscription?.unsubscribe(),delete this.subscriptions.value[c]}this.subscriptionsQueue[c]&&delete this.subscriptionsQueue[c]}async processSubscriptionsQueue(){await Promise.all(Object.keys(this.subscriptionsQueue).map(async c=>{await this.subscribe(c,this.subscriptionsQueue[c]),delete this.subscriptionsQueue[c]}))}useStops(){return this.subscribe("data.map.stop.>",this.stops),{stops:Tr(()=>Object.values(this.stops.value)),loading:wi(!1),unsubscribe:async()=>{await this.unsubscribe("data.map.stop.>")}}}useVehicles(){return this.subscribe("data.map.vehicle.>",this.vehicles),{vehicles:Tr(()=>Object.values(this.vehicles.value)),loading:wi(!1),unsubscribe:async()=>{await this.unsubscribe("data.map.vehicle.>")}}}useStop(c){return c.value&&this.subscribe(`data.map.stop.${c.value}`,this.stops),Ro(c,async(g,x)=>{x&&await this.unsubscribe(`data.map.stop.${x}`),g&&await this.subscribe(`data.map.stop.${g}`,this.stops)}),{stop:Tr(()=>c.value?this.stops.value[c.value]??null:null),loading:wi(!1),unsubscribe:async()=>{await this.unsubscribe(`data.map.stop.${c.value}`)}}}useVehicle(c){return c.value&&this.subscribe(`data.map.vehicle.${c.value}`,this.vehicles),Ro(c,async(g,x)=>{x&&await this.unsubscribe(`data.map.vehicle.${x}`),g&&await this.subscribe(`data.map.vehicle.${g}`,this.vehicles)}),{vehicle:Tr(()=>c.value?this.vehicles.value[c.value]??null:null),loading:wi(!1),unsubscribe:async()=>{await this.unsubscribe(`data.map.vehicle.${c.value}`)}}}useTrip(c){return c.value&&this.subscribe(`data.map.trip.${c.value}`,this.trips),Ro(c,async(g,x)=>{x&&await this.unsubscribe(`data.map.trip.${x}`),g&&await this.subscribe(`data.map.trip.${g}`,this.trips)}),{trip:Tr(()=>c.value?this.trips.value[c.value]??null:null),loading:wi(!1),unsubscribe:async()=>{await this.unsubscribe(`data.map.trip.${c.value}`)}}}useSearch(c,g){const{stops:x,loading:E}=this.useStops(),k=Tr(()=>[...Object.values(x.value)]),S=Tr(()=>new Yl(k.value,{includeScore:!0,keys:["name"],threshold:.4}));return{results:Tr(()=>c.value===""||c.value.length<3?[]:S.value.search(c.value).slice(0,20).map($=>$.item)),loading:E}}}function mw(){return new fw}const Qn=mw(),gw={id:"app-bar",class:"absolute top-0 right-0 left-0 z-20 mx-2 mt-[calc(0.5rem+var(--safe-area-top,0px))] flex h-12 items-center justify-between gap-x-1 rounded-md border border-gray-200 bg-white py-1 pr-1 shadow-xl md:right-auto md:left-1/2 md:w-96 md:-translate-x-1/2 md:transform dark:border-neutral-950 dark:bg-neutral-800 dark:text-gray-300"},_w=["alt"],yw={key:0,class:"flex h-full grow"},xw=["value","title","placeholder"],vw={key:1,class:"mr-2 flex items-center gap-x-2"},bw=Hs({__name:"AppBar",props:{searchInput:{}},emits:["update:search-input"],setup(v,{emit:c}){const g=v,x=c,{isConnected:E}=Qn,{t:k}=za(),S=B_(),l=j_(),{needRefresh:$,updateServiceWorker:oe}=Pv(),me=Zl(g,"searchInput"),we=Tr({get(){return me.value},set(ye){x("update:search-input",ye),ye.length>0&&S.name!=="search"&&l.push({name:"search"}),ye.length===0&&S.name==="search"&&l.push({name:"home"})}});return(ye,ze)=>{const Ke=Eu("router-link"),ot=Tv,ge=vv;return We(),It("nav",gw,[Li(Ke,{to:{name:"home"},class:"p-2"},{default:Ii(()=>[yt("img",{alt:_t(k)("logo_alt"),src:lv,class:"h-6 w-6"},null,8,_w)]),_:1}),_t(E)?(We(),It("div",yw,[yt("input",{value:we.value,type:"text",class:"focus-visible:border-opacity-50 h-full w-full border border-transparent bg-transparent p-2 focus:outline-none focus-visible:rounded-md focus-visible:border-gray-300 focus-visible:outline-none",title:_t(k)("search"),placeholder:`${_t(k)("search")} ...`,autofocus:"",name:"query",onInput:ze[0]||(ze[0]=Pt=>we.value=Pt.currentTarget.value),onKeydown:ze[1]||(ze[1]=ev(Pt=>ye.$router.back(),["escape"])),onClick:ze[2]||(ze[2]=Pt=>ye.$router.push({name:"search"}))},null,40,xw)])):(We(),It("div",vw,[yt("span",null,_r(_t(k)("no_connection")),1),Li(ot,{class:"text-red-600"})])),_t($)?(We(),Ot(Nl,{key:2,class:"h-full gap-x-1",onClick:ze[3]||(ze[3]=Pt=>_t(oe)(!0))},{default:Ii(()=>[Li(ge),yt("span",null,_r(_t(k)("update")),1)]),_:1})):Nr("",!0)])}}});var dd={exports:{}};var ww=dd.exports,k_;function Tw(){return k_||(k_=1,(function(v,c){(function(g,x){v.exports=x()})(ww,(function(){var g={},x={};function E(S,l,$){if(x[S]=$,S==="index"){var oe="var sharedModule = {}; ("+x.shared+")(sharedModule); ("+x.worker+")(sharedModule);",me={};return x.shared(me),x.index(g,me),typeof window<"u"&&g.setWorkerUrl(window.URL.createObjectURL(new Blob([oe],{type:"text/javascript"}))),g}}E("shared",["exports"],(function(S){function l(i,e,r,n){return new(r||(r=Promise))((function(a,h){function d(w){try{y(n.next(w))}catch(P){h(P)}}function m(w){try{y(n.throw(w))}catch(P){h(P)}}function y(w){var P;w.done?a(w.value):(P=w.value,P instanceof r?P:new r((function(I){I(P)}))).then(d,m)}y((n=n.apply(i,e||[])).next())}))}function $(i,e){this.x=i,this.y=e}function oe(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var me,we;typeof SuppressedError=="function"&&SuppressedError,$.prototype={clone(){return new $(this.x,this.y)},add(i){return this.clone()._add(i)},sub(i){return this.clone()._sub(i)},multByPoint(i){return this.clone()._multByPoint(i)},divByPoint(i){return this.clone()._divByPoint(i)},mult(i){return this.clone()._mult(i)},div(i){return this.clone()._div(i)},rotate(i){return this.clone()._rotate(i)},rotateAround(i,e){return this.clone()._rotateAround(i,e)},matMult(i){return this.clone()._matMult(i)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(i){return this.x===i.x&&this.y===i.y},dist(i){return Math.sqrt(this.distSqr(i))},distSqr(i){const e=i.x-this.x,r=i.y-this.y;return e*e+r*r},angle(){return Math.atan2(this.y,this.x)},angleTo(i){return Math.atan2(this.y-i.y,this.x-i.x)},angleWith(i){return this.angleWithSep(i.x,i.y)},angleWithSep(i,e){return Math.atan2(this.x*e-this.y*i,this.x*i+this.y*e)},_matMult(i){const e=i[2]*this.x+i[3]*this.y;return this.x=i[0]*this.x+i[1]*this.y,this.y=e,this},_add(i){return this.x+=i.x,this.y+=i.y,this},_sub(i){return this.x-=i.x,this.y-=i.y,this},_mult(i){return this.x*=i,this.y*=i,this},_div(i){return this.x/=i,this.y/=i,this},_multByPoint(i){return this.x*=i.x,this.y*=i.y,this},_divByPoint(i){return this.x/=i.x,this.y/=i.y,this},_unit(){return this._div(this.mag()),this},_perp(){const i=this.y;return this.y=this.x,this.x=-i,this},_rotate(i){const e=Math.cos(i),r=Math.sin(i),n=r*this.x+e*this.y;return this.x=e*this.x-r*this.y,this.y=n,this},_rotateAround(i,e){const r=Math.cos(i),n=Math.sin(i),a=e.y+n*(this.x-e.x)+r*(this.y-e.y);return this.x=e.x+r*(this.x-e.x)-n*(this.y-e.y),this.y=a,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:$},$.convert=function(i){if(i instanceof $)return i;if(Array.isArray(i))return new $(+i[0],+i[1]);if(i.x!==void 0&&i.y!==void 0)return new $(+i.x,+i.y);throw new Error("Expected [x, y] or {x, y} point format")};var ye=(function(){if(we)return me;function i(e,r,n,a){this.cx=3*e,this.bx=3*(n-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*r,this.by=3*(a-r)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=r,this.p2x=n,this.p2y=a}return we=1,me=i,i.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,r){if(r===void 0&&(r=1e-6),e<0)return 0;if(e>1)return 1;for(var n=e,a=0;a<8;a++){var h=this.sampleCurveX(n)-e;if(Math.abs(h)<r)return n;var d=this.sampleCurveDerivativeX(n);if(Math.abs(d)<1e-6)break;n-=h/d}var m=0,y=1;for(n=e,a=0;a<20&&(h=this.sampleCurveX(n),!(Math.abs(h-e)<r));a++)e>h?m=n:y=n,n=.5*(y-m)+m;return n},solve:function(e,r){return this.sampleCurveY(this.solveCurveX(e,r))}},me})(),ze=oe(ye);let Ke,ot;function ge(){return Ke==null&&(Ke=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),Ke}function Pt(){if(ot==null&&(ot=!1,ge())){const e=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(e){for(let n=0;n<25;n++){const a=4*n;e.fillStyle=`rgb(${a},${a+1},${a+2})`,e.fillRect(n%5,Math.floor(n/5),1,1)}const r=e.getImageData(0,0,5,5).data;for(let n=0;n<100;n++)if(n%4!=3&&r[n]!==n){ot=!0;break}}}return ot||!1}var xt=1e-6,At=typeof Float32Array<"u"?Float32Array:Array;function Qt(){var i=new At(9);return At!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i}function Fe(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function st(){var i=new At(3);return At!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function Ye(i){var e=i[0],r=i[1],n=i[2];return Math.sqrt(e*e+r*r+n*n)}function He(i,e,r){var n=new At(3);return n[0]=i,n[1]=e,n[2]=r,n}function Ge(i,e,r){return i[0]=e[0]+r[0],i[1]=e[1]+r[1],i[2]=e[2]+r[2],i}function pt(i,e,r){return i[0]=e[0]*r,i[1]=e[1]*r,i[2]=e[2]*r,i}function vt(i,e,r){var n=e[0],a=e[1],h=e[2],d=r[0],m=r[1],y=r[2];return i[0]=a*y-h*m,i[1]=h*d-n*y,i[2]=n*m-a*d,i}var Qe,Zt=Ye;function Ht(i,e,r){var n=e[0],a=e[1],h=e[2],d=e[3];return i[0]=r[0]*n+r[4]*a+r[8]*h+r[12]*d,i[1]=r[1]*n+r[5]*a+r[9]*h+r[13]*d,i[2]=r[2]*n+r[6]*a+r[10]*h+r[14]*d,i[3]=r[3]*n+r[7]*a+r[11]*h+r[15]*d,i}function rt(){var i=new At(4);return At!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i[3]=1,i}function Jt(i,e,r,n){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"zyx",h=Math.PI/360;e*=h,n*=h,r*=h;var d=Math.sin(e),m=Math.cos(e),y=Math.sin(r),w=Math.cos(r),P=Math.sin(n),I=Math.cos(n);switch(a){case"xyz":i[0]=d*w*I+m*y*P,i[1]=m*y*I-d*w*P,i[2]=m*w*P+d*y*I,i[3]=m*w*I-d*y*P;break;case"xzy":i[0]=d*w*I-m*y*P,i[1]=m*y*I-d*w*P,i[2]=m*w*P+d*y*I,i[3]=m*w*I+d*y*P;break;case"yxz":i[0]=d*w*I+m*y*P,i[1]=m*y*I-d*w*P,i[2]=m*w*P-d*y*I,i[3]=m*w*I+d*y*P;break;case"yzx":i[0]=d*w*I+m*y*P,i[1]=m*y*I+d*w*P,i[2]=m*w*P-d*y*I,i[3]=m*w*I-d*y*P;break;case"zxy":i[0]=d*w*I-m*y*P,i[1]=m*y*I+d*w*P,i[2]=m*w*P+d*y*I,i[3]=m*w*I-d*y*P;break;case"zyx":i[0]=d*w*I-m*y*P,i[1]=m*y*I+d*w*P,i[2]=m*w*P-d*y*I,i[3]=m*w*I+d*y*P;break;default:throw new Error("Unknown angle order "+a)}return i}function Wt(){var i=new At(2);return At!=Float32Array&&(i[0]=0,i[1]=0),i}function Xt(i,e){var r=new At(2);return r[0]=i,r[1]=e,r}st(),Qe=new At(4),At!=Float32Array&&(Qe[0]=0,Qe[1]=0,Qe[2]=0,Qe[3]=0),st(),He(1,0,0),He(0,1,0),rt(),rt(),Qt(),Wt();const Ct=8192;function Kt(i,e,r){return e*(Ct/(i.tileSize*Math.pow(2,r-i.tileID.overscaledZ)))}function Nt(i,e){return(i%e+e)%e}function hr(i,e,r){return i*(1-r)+e*r}function us(i){if(i<=0)return 0;if(i>=1)return 1;const e=i*i,r=e*i;return 4*(i<.5?r:3*(i-e)+r-.75)}function Os(i,e,r,n){const a=new ze(i,e,r,n);return h=>a.solve(h)}const ci=Os(.25,.1,.25,1);function Bi(i,e,r){return Math.min(r,Math.max(e,i))}function ii(i,e,r){const n=r-e,a=((i-e)%n+n)%n+e;return a===e?r:a}function Sr(i,...e){for(const r of e)for(const n in r)i[n]=r[n];return i}let Vt=1;function Lr(i,e,r){const n={};for(const a in i)n[a]=e.call(this,i[a],a,i);return n}function cn(i,e,r){const n={};for(const a in i)e.call(this,i[a],a,i)&&(n[a]=i[a]);return n}function Zi(i){return Array.isArray(i)?i.map(Zi):typeof i=="object"&&i?Lr(i,Zi):i}const Bs={};function Vr(i){Bs[i]||(typeof console<"u"&&console.warn(i),Bs[i]=!0)}function ji(i,e,r){return(r.y-i.y)*(e.x-i.x)>(e.y-i.y)*(r.x-i.x)}function Ni(i){return typeof WorkerGlobalScope<"u"&&i!==void 0&&i instanceof WorkerGlobalScope}let Mr=null;function js(i){return typeof ImageBitmap<"u"&&i instanceof ImageBitmap}const Ws="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function un(i,e,r,n,a){return l(this,void 0,void 0,(function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const h=new VideoFrame(i,{timestamp:0});try{const d=h?.format;if(!d||!d.startsWith("BGR")&&!d.startsWith("RGB"))throw new Error(`Unrecognized format ${d}`);const m=d.startsWith("BGR"),y=new Uint8ClampedArray(n*a*4);if(yield h.copyTo(y,(function(w,P,I,C,D){const F=4*Math.max(-P,0),L=(Math.max(0,I)-I)*C*4+F,B=4*C,U=Math.max(0,P),ee=Math.max(0,I);return{rect:{x:U,y:ee,width:Math.min(w.width,P+C)-U,height:Math.min(w.height,I+D)-ee},layout:[{offset:L,stride:B}]}})(i,e,r,n,a)),m)for(let w=0;w<y.length;w+=4){const P=y[w];y[w]=y[w+2],y[w+2]=P}return y}finally{h.close()}}))}let Hi,Wi;function _s(i,e,r,n){return i.addEventListener(e,r,n),{unsubscribe:()=>{i.removeEventListener(e,r,n)}}}function Ti(i){return i*Math.PI/180}function Ai(i){return i/Math.PI*180}const ve={touchstart:!0,touchmove:!0,touchmoveWindow:!0,touchend:!0,touchcancel:!0},N={dblclick:!0,click:!0,mouseover:!0,mouseout:!0,mousedown:!0,mousemove:!0,mousemoveWindow:!0,mouseup:!0,mouseupWindow:!0,contextmenu:!0,wheel:!0},j="AbortError";class Z extends Error{constructor(e=j){super(e instanceof Error?e.message:e),this.name=j,e instanceof Error&&e.stack&&(this.stack=e.stack)}}function ce(i){return i.name===j}const he={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function Te(i){return he.REGISTERED_PROTOCOLS[i.substring(0,i.indexOf("://"))]}const _e="global-dispatcher";class de extends Error{constructor(e,r,n,a){super(`AJAXError: ${r} (${e}): ${n}`),this.status=e,this.statusText=r,this.url=n,this.body=a}}const Ee=()=>Ni(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,Ue=function(i,e){if(/:\/\//.test(i.url)&&!/^https?:|^file:/.test(i.url)){const n=Te(i.url);if(n)return n(i,e);if(Ni(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:i,targetMapId:_e},e)}if(!(/^file:/.test(r=i.url)||/^file:/.test(Ee())&&!/^\w+:/.test(r))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return(function(n,a){return l(this,void 0,void 0,(function*(){const h=new Request(n.url,{method:n.method||"GET",body:n.body,credentials:n.credentials,headers:n.headers,cache:n.cache,referrer:Ee(),signal:a.signal});let d,m;n.type!=="json"||h.headers.has("Accept")||h.headers.set("Accept","application/json");try{d=yield fetch(h)}catch(w){throw ce(w)?w:new de(0,w.message,n.url,new Blob)}if(!d.ok){const w=yield d.blob();throw new de(d.status,d.statusText,n.url,w)}m=n.type==="arrayBuffer"||n.type==="image"?d.arrayBuffer():n.type==="json"?d.json():d.text();const y=yield m;return a.signal.throwIfAborted(),{data:y,cacheControl:d.headers.get("Cache-Control"),expires:d.headers.get("Expires")}}))})(i,e);if(Ni(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:i,mustQueue:!0,targetMapId:_e},e)}var r;return(function(n,a){return new Promise(((h,d)=>{var m;const y=new XMLHttpRequest;y.open(n.method||"GET",n.url,!0),n.type!=="arrayBuffer"&&n.type!=="image"||(y.responseType="arraybuffer");for(const w in n.headers)y.setRequestHeader(w,n.headers[w]);n.type==="json"&&(y.responseType="text",!((m=n.headers)===null||m===void 0)&&m.Accept||y.setRequestHeader("Accept","application/json")),y.withCredentials=n.credentials==="include",y.onerror=()=>{d(new Error(y.statusText))},y.onload=()=>{if(!a.signal.aborted)if((y.status>=200&&y.status<300||y.status===0)&&y.response!==null){let w=y.response;if(n.type==="json")try{w=JSON.parse(y.response)}catch(P){return void d(P)}h({data:w,cacheControl:y.getResponseHeader("Cache-Control"),expires:y.getResponseHeader("Expires")})}else{const w=new Blob([y.response],{type:y.getResponseHeader("Content-Type")});d(new de(y.status,y.statusText,n.url,w))}},a.signal.addEventListener("abort",(()=>{y.abort(),d(new Z(a.signal.reason))})),y.send(n.body)}))})(i,e)};function Oe(i){if(!i||i.indexOf("://")<=0||i.indexOf("data:image/")===0||i.indexOf("blob:")===0)return!0;const e=new URL(i),r=window.location;return e.protocol===r.protocol&&e.host===r.host}function at(i,e,r){r[i]&&r[i].indexOf(e)!==-1||(r[i]=r[i]||[],r[i].push(e))}function ft(i,e,r){if(r&&r[i]){const n=r[i].indexOf(e);n!==-1&&r[i].splice(n,1)}}class kt{constructor(e,r={}){Sr(this,r),this.type=e}}class nr extends kt{constructor(e,r={}){super("error",Sr({error:e},r))}}class er{on(e,r){return this._listeners=this._listeners||{},at(e,r,this._listeners),{unsubscribe:()=>{this.off(e,r)}}}off(e,r){return ft(e,r,this._listeners),ft(e,r,this._oneTimeListeners),this}once(e,r){return r?(this._oneTimeListeners=this._oneTimeListeners||{},at(e,r,this._oneTimeListeners),this):new Promise((n=>this.once(e,n)))}fire(e,r){typeof e=="string"&&(e=new kt(e,r||{}));const n=e.type;if(this.listens(n)){e.target=this;const a=this._listeners&&this._listeners[n]?this._listeners[n].slice():[];for(const m of a)m.call(this,e);const h=this._oneTimeListeners&&this._oneTimeListeners[n]?this._oneTimeListeners[n].slice():[];for(const m of h)ft(n,m,this._oneTimeListeners),m.call(this,e);const d=this._eventedParent;d&&(Sr(e,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),d.fire(e))}else e instanceof nr&&console.error(e.error);return this}listens(e){return this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e)}setEventedParent(e,r){return this._eventedParent=e,this._eventedParentData=r,this}}var Se={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number",length:2},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},state:{type:"state",default:{}},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},"font-faces":{type:"fontFaces"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},encoding:{type:"enum",values:{mvt:{},mlt:{}},default:"mvt"},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"filter"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},"color-relief":{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_color-relief","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},"layout_color-relief":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible",expression:{interpolated:!1,parameters:["global-state"]},"property-type":"data-constant"}},filter:{type:"boolean",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"expression_name",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_color-relief","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"numberArray",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-altitude":{type:"numberArray",default:45,minimum:0,maximum:90,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"colorArray",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"colorArray",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-method":{type:"enum",values:{standard:{},basic:{},combined:{},igor:{},multidirectional:{}},default:"standard",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},"paint_color-relief":{"color-relief-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"color-relief-color":{type:"color",transition:!1,expression:{interpolated:!0,parameters:["elevation"]},"property-type":"color-ramp"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}},interpolation:{type:"array",value:"interpolation_name",minimum:1},interpolation_name:{type:"enum",values:{linear:{syntax:{overloads:[{parameters:[],"output-type":"interpolation"}],parameters:[]}},exponential:{syntax:{overloads:[{parameters:["base"],"output-type":"interpolation"}],parameters:[{name:"base",type:"number literal"}]}},"cubic-bezier":{syntax:{overloads:[{parameters:["x1","y1","x2","y2"],"output-type":"interpolation"}],parameters:[{name:"x1",type:"number literal"},{name:"y1",type:"number literal"},{name:"x2",type:"number literal"},{name:"y2",type:"number literal"}]}}}}};const dr=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function ui(i,e){const r={};for(const n in i)n!=="ref"&&(r[n]=i[n]);return dr.forEach((n=>{n in e&&(r[n]=e[n])})),r}function Dt(i,e){if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!Dt(i[r],e[r]))return!1;return!0}if(typeof i=="object"&&i!==null&&e!==null){if(typeof e!="object"||Object.keys(i).length!==Object.keys(e).length)return!1;for(const r in i)if(!Dt(i[r],e[r]))return!1;return!0}return i===e}function or(i,e){i.push(e)}function Hr(i,e,r){or(r,{command:"addSource",args:[i,e[i]]})}function cr(i,e,r){or(e,{command:"removeSource",args:[i]}),r[i]=!0}function mr(i,e,r,n){cr(i,r,n),Hr(i,e,r)}function ar(i,e,r){let n;for(n in i[r])if(Object.prototype.hasOwnProperty.call(i[r],n)&&n!=="data"&&!Dt(i[r][n],e[r][n]))return!1;for(n in e[r])if(Object.prototype.hasOwnProperty.call(e[r],n)&&n!=="data"&&!Dt(i[r][n],e[r][n]))return!1;return!0}function Cr(i,e,r,n,a,h){i=i||{},e=e||{};for(const d in i)Object.prototype.hasOwnProperty.call(i,d)&&(Dt(i[d],e[d])||r.push({command:h,args:[n,d,e[d],a]}));for(const d in e)Object.prototype.hasOwnProperty.call(e,d)&&!Object.prototype.hasOwnProperty.call(i,d)&&(Dt(i[d],e[d])||r.push({command:h,args:[n,d,e[d],a]}))}function ys(i){return i.id}function xs(i,e){return i[e.id]=e,i}class Ze{constructor(e,r,n,a){this.message=(e?`${e}: `:"")+n,a&&(this.identifier=a),r!=null&&r.__line__&&(this.line=r.__line__)}}function fi(i,...e){for(const r of e)for(const n in r)i[n]=r[n];return i}class Si extends Error{constructor(e,r){super(r),this.message=r,this.key=e}}class io{constructor(e,r=[]){this.parent=e,this.bindings={};for(const[n,a]of r)this.bindings[n]=a}concat(e){return new io(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const Wr={kind:"null"},et={kind:"number"},Rt={kind:"string"},Lt={kind:"boolean"},Pi={kind:"color"},Cn={kind:"projectionDefinition"},vs={kind:"object"},Mt={kind:"value"},hn={kind:"collator"},G={kind:"formatted"},K={kind:"padding"},J={kind:"colorArray"},se={kind:"numberArray"},fe={kind:"resolvedImage"},xe={kind:"variableAnchorOffsetCollection"};function je(i,e){return{kind:"array",itemType:i,N:e}}function Be(i){if(i.kind==="array"){const e=Be(i.itemType);return typeof i.N=="number"?`array<${e}, ${i.N}>`:i.itemType.kind==="value"?"array":`array<${e}>`}return i.kind}const ke=[Wr,et,Rt,Lt,Pi,Cn,G,vs,je(Mt),K,se,J,fe,xe];function Ve(i,e){if(e.kind==="error")return null;if(i.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Ve(i.itemType,e.itemType))&&(typeof i.N!="number"||i.N===e.N))return null}else{if(i.kind===e.kind)return null;if(i.kind==="value"){for(const r of ke)if(!Ve(r,e))return null}}return`Expected ${Be(i)} but found ${Be(e)} instead.`}function wt(i,e){return e.some((r=>r.kind===i.kind))}function $t(i,e){return e.some((r=>r==="null"?i===null:r==="array"?Array.isArray(i):r==="object"?i&&!Array.isArray(i)&&typeof i=="object":r===typeof i))}function sr(i,e){return i.kind==="array"&&e.kind==="array"?i.itemType.kind===e.itemType.kind&&typeof i.N=="number":i.kind===e.kind}const Xi=.96422,Yi=.82521,Fa=4/29,$r=6/29,Au=3*$r*$r,Cu=$r*$r*$r,Vo=Math.PI/180,ku=180/Math.PI;function Du(i){return(i%=360)<0&&(i+=360),i}function zu([i,e,r,n]){let a,h;const d=Kl((.2225045*(i=La(i))+.7168786*(e=La(e))+.0606169*(r=La(r)))/1);i===e&&e===r?a=h=d:(a=Kl((.4360747*i+.3850649*e+.1430804*r)/Xi),h=Kl((.0139322*i+.0971045*e+.7141733*r)/Yi));const m=116*d-16;return[m<0?0:m,500*(a-d),200*(d-h),n]}function La(i){return i<=.04045?i/12.92:Math.pow((i+.055)/1.055,2.4)}function Kl(i){return i>Cu?Math.pow(i,1/3):i/Au+Fa}function Ql([i,e,r,n]){let a=(i+16)/116,h=isNaN(e)?a:a+e/500,d=isNaN(r)?a:a-r/200;return a=1*tc(a),h=Xi*tc(h),d=Yi*tc(d),[ec(3.1338561*h-1.6168667*a-.4906146*d),ec(-.9787684*h+1.9161415*a+.033454*d),ec(.0719453*h-.2289914*a+1.4052427*d),n]}function ec(i){return(i=i<=.00304?12.92*i:1.055*Math.pow(i,1/2.4)-.055)<0?0:i>1?1:i}function tc(i){return i>$r?i*i*i:Au*(i-Fa)}const Cd=Object.hasOwn||function(i,e){return Object.prototype.hasOwnProperty.call(i,e)};function $o(i,e){return Cd(i,e)?i[e]:void 0}function Oa(i){return parseInt(i.padEnd(2,i),16)/255}function Ru(i,e){return so(e?i/100:i,0,1)}function so(i,e,r){return Math.min(Math.max(e,i),r)}function rc(i){return!i.some(Number.isNaN)}const Uo={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function dn(i,e,r){return i+r*(e-i)}function no(i,e,r){return i.map(((n,a)=>dn(n,e[a],r)))}class Ut{constructor(e,r,n,a=1,h=!0){this.r=e,this.g=r,this.b=n,this.a=a,h||(this.r*=a,this.g*=a,this.b*=a,a||this.overwriteGetter("rgb",[e,r,n,a]))}static parse(e){if(e instanceof Ut)return e;if(typeof e!="string")return;const r=(function(n){if((n=n.toLowerCase().trim())==="transparent")return[0,0,0,0];const a=$o(Uo,n);if(a){const[d,m,y]=a;return[d/255,m/255,y/255,1]}if(n.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(n)){const d=n.length<6?1:2;let m=1;return[Oa(n.slice(m,m+=d)),Oa(n.slice(m,m+=d)),Oa(n.slice(m,m+=d)),Oa(n.slice(m,m+d)||"ff")]}if(n.startsWith("rgb")){const d=n.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(d){const[m,y,w,P,I,C,D,F,L,B,U,ee]=d,q=[P||" ",D||" ",B].join("");if(q==="  "||q==="  /"||q===",,"||q===",,,"){const H=[w,C,L].join(""),re=H==="%%%"?100:H===""?255:0;if(re){const ae=[so(+y/re,0,1),so(+I/re,0,1),so(+F/re,0,1),U?Ru(+U,ee):1];if(rc(ae))return ae}}return}}const h=n.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(h){const[d,m,y,w,P,I,C,D,F]=h,L=[y||" ",P||" ",C].join("");if(L==="  "||L==="  /"||L===",,"||L===",,,"){const B=[+m,so(+w,0,100),so(+I,0,100),D?Ru(+D,F):1];if(rc(B))return(function([U,ee,q,H]){function re(ae){const be=(ae+U/30)%12,Le=ee*Math.min(q,1-q);return q-Le*Math.max(-1,Math.min(be-3,9-be,1))}return U=Du(U),ee/=100,q/=100,[re(0),re(8),re(4),H]})(B)}}})(e);return r?new Ut(...r,!1):void 0}get rgb(){const{r:e,g:r,b:n,a}=this,h=a||1/0;return this.overwriteGetter("rgb",[e/h,r/h,n/h,a])}get hcl(){return this.overwriteGetter("hcl",(function(e){const[r,n,a,h]=zu(e),d=Math.sqrt(n*n+a*a);return[Math.round(1e4*d)?Du(Math.atan2(a,n)*ku):NaN,d,r,h]})(this.rgb))}get lab(){return this.overwriteGetter("lab",zu(this.rgb))}overwriteGetter(e,r){return Object.defineProperty(this,e,{value:r}),r}toString(){const[e,r,n,a]=this.rgb;return`rgba(${[e,r,n].map((h=>Math.round(255*h))).join(",")},${a})`}static interpolate(e,r,n,a="rgb"){switch(a){case"rgb":{const[h,d,m,y]=no(e.rgb,r.rgb,n);return new Ut(h,d,m,y,!1)}case"hcl":{const[h,d,m,y]=e.hcl,[w,P,I,C]=r.hcl;let D,F;if(isNaN(h)||isNaN(w))isNaN(h)?isNaN(w)?D=NaN:(D=w,m!==1&&m!==0||(F=P)):(D=h,I!==1&&I!==0||(F=d));else{let q=w-h;w>h&&q>180?q-=360:w<h&&h-w>180&&(q+=360),D=h+n*q}const[L,B,U,ee]=(function([q,H,re,ae]){return q=isNaN(q)?0:q*Vo,Ql([re,Math.cos(q)*H,Math.sin(q)*H,ae])})([D,F??dn(d,P,n),dn(m,I,n),dn(y,C,n)]);return new Ut(L,B,U,ee,!1)}case"lab":{const[h,d,m,y]=Ql(no(e.lab,r.lab,n));return new Ut(h,d,m,y,!1)}}}}Ut.black=new Ut(0,0,0,1),Ut.white=new Ut(1,1,1,1),Ut.transparent=new Ut(0,0,0,0),Ut.red=new Ut(1,0,0,1);class ic{constructor(e,r,n){this.sensitivity=e?r?"variant":"case":r?"accent":"base",this.locale=n,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,r){return this.collator.compare(e,r)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}const kd=["bottom","center","top"];class sc{constructor(e,r,n,a,h,d){this.text=e,this.image=r,this.scale=n,this.fontStack=a,this.textColor=h,this.verticalAlign=d}}class Ji{constructor(e){this.sections=e}static fromString(e){return new Ji([new sc(e,null,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some((e=>e.text.length!==0||e.image&&e.image.name.length!==0))}static factory(e){return e instanceof Ji?e:Ji.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map((e=>e.text)).join("")}}class Ci{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof Ci)return e;if(typeof e=="number")return new Ci([e,e,e,e]);if(Array.isArray(e)&&!(e.length<1||e.length>4)){for(const r of e)if(typeof r!="number")return;switch(e.length){case 1:e=[e[0],e[0],e[0],e[0]];break;case 2:e=[e[0],e[1],e[0],e[1]];break;case 3:e=[e[0],e[1],e[2],e[1]]}return new Ci(e)}}toString(){return JSON.stringify(this.values)}static interpolate(e,r,n){return new Ci(no(e.values,r.values,n))}}class Or{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof Or)return e;if(typeof e=="number")return new Or([e]);if(Array.isArray(e)){for(const r of e)if(typeof r!="number")return;return new Or(e)}}toString(){return JSON.stringify(this.values)}static interpolate(e,r,n){return new Or(no(e.values,r.values,n))}}class zt{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof zt)return e;if(typeof e=="string"){const n=Ut.parse(e);return n?new zt([n]):void 0}if(!Array.isArray(e))return;const r=[];for(const n of e){if(typeof n!="string")return;const a=Ut.parse(n);if(!a)return;r.push(a)}return new zt(r)}toString(){return JSON.stringify(this.values)}static interpolate(e,r,n,a="rgb"){const h=[];if(e.values.length!=r.values.length)throw new Error(`colorArray: Arrays have mismatched length (${e.values.length} vs. ${r.values.length}), cannot interpolate.`);for(let d=0;d<e.values.length;d++)h.push(Ut.interpolate(e.values[d],r.values[d],n,a));return new zt(h)}}class yr extends Error{constructor(e){super(e),this.name="RuntimeError"}toJSON(){return this.message}}const pn=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class Vi{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof Vi)return e;if(Array.isArray(e)&&!(e.length<1)&&e.length%2==0){for(let r=0;r<e.length;r+=2){const n=e[r],a=e[r+1];if(typeof n!="string"||!pn.has(n)||!Array.isArray(a)||a.length!==2||typeof a[0]!="number"||typeof a[1]!="number")return}return new Vi(e)}}toString(){return JSON.stringify(this.values)}static interpolate(e,r,n){const a=e.values,h=r.values;if(a.length!==h.length)throw new yr(`Cannot interpolate values of different length. from: ${e.toString()}, to: ${r.toString()}`);const d=[];for(let m=0;m<a.length;m+=2){if(a[m]!==h[m])throw new yr(`Cannot interpolate values containing mismatched anchors. from[${m}]: ${a[m]}, to[${m}]: ${h[m]}`);d.push(a[m]);const[y,w]=a[m+1],[P,I]=h[m+1];d.push([dn(y,P,n),dn(w,I,n)])}return new Vi(d)}}class rs{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new rs({name:e,available:!1}):null}}class $i{constructor(e,r,n){this.from=e,this.to=r,this.transition=n}static interpolate(e,r,n){return new $i(e,r,n)}static parse(e){return e instanceof $i?e:Array.isArray(e)&&e.length===3&&typeof e[0]=="string"&&typeof e[1]=="string"&&typeof e[2]=="number"?new $i(e[0],e[1],e[2]):typeof e=="object"&&typeof e.from=="string"&&typeof e.to=="string"&&typeof e.transition=="number"?new $i(e.from,e.to,e.transition):typeof e=="string"?new $i(e,e,1):void 0}}function oo(i,e,r,n){return typeof i=="number"&&i>=0&&i<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof r=="number"&&r>=0&&r<=255?n===void 0||typeof n=="number"&&n>=0&&n<=1?null:`Invalid rgba value [${[i,e,r,n].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof n=="number"?[i,e,r,n]:[i,e,r]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function fn(i){if(i===null||typeof i=="string"||typeof i=="boolean"||typeof i=="number"||i instanceof $i||i instanceof Ut||i instanceof ic||i instanceof Ji||i instanceof Ci||i instanceof Or||i instanceof zt||i instanceof Vi||i instanceof rs)return!0;if(Array.isArray(i)){for(const e of i)if(!fn(e))return!1;return!0}if(typeof i=="object"){for(const e in i)if(!fn(i[e]))return!1;return!0}return!1}function Xr(i){if(i===null)return Wr;if(typeof i=="string")return Rt;if(typeof i=="boolean")return Lt;if(typeof i=="number")return et;if(i instanceof Ut)return Pi;if(i instanceof $i)return Cn;if(i instanceof ic)return hn;if(i instanceof Ji)return G;if(i instanceof Ci)return K;if(i instanceof Or)return se;if(i instanceof zt)return J;if(i instanceof Vi)return xe;if(i instanceof rs)return fe;if(Array.isArray(i)){const e=i.length;let r;for(const n of i){const a=Xr(n);if(r){if(r===a)continue;r=Mt;break}r=a}return je(r||Mt,e)}return vs}function kn(i){const e=typeof i;return i===null?"":e==="string"||e==="number"||e==="boolean"?String(i):i instanceof Ut||i instanceof $i||i instanceof Ji||i instanceof Ci||i instanceof Or||i instanceof zt||i instanceof Vi||i instanceof rs?i.toString():JSON.stringify(i)}class Ns{constructor(e,r){this.type=e,this.value=r}static parse(e,r){if(e.length!==2)return r.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!fn(e[1]))return r.error("invalid value");const n=e[1];let a=Xr(n);const h=r.expectedType;return a.kind!=="array"||a.N!==0||!h||h.kind!=="array"||typeof h.N=="number"&&h.N!==0||(a=h),new Ns(a,n)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const Ba={string:Rt,number:et,boolean:Lt,object:vs};class Ki{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");let n,a=1;const h=e[0];if(h==="array"){let m,y;if(e.length>2){const w=e[1];if(typeof w!="string"||!(w in Ba)||w==="object")return r.error('The item type argument of "array" must be one of string, number, boolean',1);m=Ba[w],a++}else m=Mt;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return r.error('The length argument to "array" must be a positive integer literal',2);y=e[2],a++}n=je(m,y)}else{if(!Ba[h])throw new Error(`Types doesn't contain name = ${h}`);n=Ba[h]}const d=[];for(;a<e.length;a++){const m=r.parse(e[a],a,Mt);if(!m)return null;d.push(m)}return new Ki(n,d)}evaluate(e){for(let r=0;r<this.args.length;r++){const n=this.args[r].evaluate(e);if(!Ve(this.type,Xr(n)))return n;if(r===this.args.length-1)throw new yr(`Expected value to be of type ${Be(this.type)}, but found ${Be(Xr(n))} instead.`)}throw new Error}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}}const Dn={"to-boolean":Lt,"to-color":Pi,"to-number":et,"to-string":Rt};class Xs{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const n=e[0];if(!Dn[n])throw new Error(`Can't parse ${n} as it is not part of the known types`);if((n==="to-boolean"||n==="to-string")&&e.length!==2)return r.error("Expected one argument.");const a=Dn[n],h=[];for(let d=1;d<e.length;d++){const m=r.parse(e[d],d,Mt);if(!m)return null;h.push(m)}return new Xs(a,h)}evaluate(e){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(e);case"color":{let r,n;for(const a of this.args){if(r=a.evaluate(e),n=null,r instanceof Ut)return r;if(typeof r=="string"){const h=e.parseColor(r);if(h)return h}else if(Array.isArray(r)&&(n=r.length<3||r.length>4?`Invalid rgba value ${JSON.stringify(r)}: expected an array containing either three or four numeric values.`:oo(r[0],r[1],r[2],r[3]),!n))return new Ut(r[0]/255,r[1]/255,r[2]/255,r[3])}throw new yr(n||`Could not parse color from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"padding":{let r;for(const n of this.args){r=n.evaluate(e);const a=Ci.parse(r);if(a)return a}throw new yr(`Could not parse padding from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"numberArray":{let r;for(const n of this.args){r=n.evaluate(e);const a=Or.parse(r);if(a)return a}throw new yr(`Could not parse numberArray from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"colorArray":{let r;for(const n of this.args){r=n.evaluate(e);const a=zt.parse(r);if(a)return a}throw new yr(`Could not parse colorArray from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"variableAnchorOffsetCollection":{let r;for(const n of this.args){r=n.evaluate(e);const a=Vi.parse(r);if(a)return a}throw new yr(`Could not parse variableAnchorOffsetCollection from value '${typeof r=="string"?r:JSON.stringify(r)}'`)}case"number":{let r=null;for(const n of this.args){if(r=n.evaluate(e),r===null)return 0;const a=Number(r);if(!isNaN(a))return a}throw new yr(`Could not convert ${JSON.stringify(r)} to number.`)}case"formatted":return Ji.fromString(kn(this.args[0].evaluate(e)));case"resolvedImage":return rs.fromString(kn(this.args[0].evaluate(e)));case"projectionDefinition":return this.args[0].evaluate(e);default:return kn(this.args[0].evaluate(e))}}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}}const Fu=["Unknown","Point","LineString","Polygon"];class nc{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache=new Map,this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Fu[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(e){let r=this._parseColorCache.get(e);return r||(r=Ut.parse(e),this._parseColorCache.set(e,r)),r}}class zn{constructor(e,r,n=[],a,h=new io,d=[]){this.registry=e,this.path=n,this.key=n.map((m=>`[${m}]`)).join(""),this.scope=h,this.errors=d,this.expectedType=a,this._isConstant=r}parse(e,r,n,a,h={}){return r?this.concat(r,n,a)._parse(e,h):this._parse(e,h)}_parse(e,r){function n(a,h,d){return d==="assert"?new Ki(h,[a]):d==="coerce"?new Xs(h,[a]):a}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const a=e[0];if(typeof a!="string")return this.error(`Expression name must be a string, but found ${typeof a} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const h=this.registry[a];if(h){let d=h.parse(e,this);if(!d)return null;if(this.expectedType){const m=this.expectedType,y=d.type;if(m.kind!=="string"&&m.kind!=="number"&&m.kind!=="boolean"&&m.kind!=="object"&&m.kind!=="array"||y.kind!=="value"){if(m.kind==="projectionDefinition"&&["string","array"].includes(y.kind)||["color","formatted","resolvedImage"].includes(m.kind)&&["value","string"].includes(y.kind)||["padding","numberArray"].includes(m.kind)&&["value","number","array"].includes(y.kind)||m.kind==="colorArray"&&["value","string","array"].includes(y.kind)||m.kind==="variableAnchorOffsetCollection"&&["value","array"].includes(y.kind))d=n(d,m,r.typeAnnotation||"coerce");else if(this.checkSubtype(m,y))return null}else d=n(d,m,r.typeAnnotation||"assert")}if(!(d instanceof Ns)&&d.type.kind!=="resolvedImage"&&this._isConstant(d)){const m=new nc;try{d=new Ns(d.type,d.evaluate(m))}catch(y){return this.error(y.message),null}}return d}return this.error(`Unknown expression "${a}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,r,n){const a=typeof e=="number"?this.path.concat(e):this.path,h=n?this.scope.concat(n):this.scope;return new zn(this.registry,this._isConstant,a,r||null,h,this.errors)}error(e,...r){const n=`${this.key}${r.map((a=>`[${a}]`)).join("")}`;this.errors.push(new Si(n,e))}checkSubtype(e,r){const n=Ve(e,r);return n&&this.error(n),n}}class xr{constructor(e,r){this.type=r.type,this.bindings=[].concat(e),this.result=r}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const r of this.bindings)e(r[1]);e(this.result)}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const n=[];for(let h=1;h<e.length-1;h+=2){const d=e[h];if(typeof d!="string")return r.error(`Expected string, but found ${typeof d} instead.`,h);if(/[^a-zA-Z0-9_]/.test(d))return r.error("Variable names must contain only alphanumeric characters or '_'.",h);const m=r.parse(e[h+1],h+1);if(!m)return null;n.push([d,m])}const a=r.parse(e[e.length-1],e.length-1,r.expectedType,n);return a?new xr(n,a):null}outputDefined(){return this.result.outputDefined()}}class ao{constructor(e,r){this.type=r.type,this.name=e,this.boundExpression=r}static parse(e,r){if(e.length!==2||typeof e[1]!="string")return r.error("'var' expression requires exactly one string literal argument.");const n=e[1];return r.scope.has(n)?new ao(n,r.scope.get(n)):r.error(`Unknown variable "${n}". Make sure "${n}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}}class tr{constructor(e,r,n){this.type=e,this.index=r,this.input=n}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const n=r.parse(e[1],1,et),a=r.parse(e[2],2,je(r.expectedType||Mt));return n&&a?new tr(a.type.itemType,n,a):null}evaluate(e){const r=this.index.evaluate(e),n=this.input.evaluate(e);if(r<0)throw new yr(`Array index out of bounds: ${r} < 0.`);if(r>=n.length)throw new yr(`Array index out of bounds: ${r} > ${n.length-1}.`);if(r!==Math.floor(r))throw new yr(`Array index must be an integer, but found ${r} instead.`);return n[r]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}}class jt{constructor(e,r){this.type=Lt,this.needle=e,this.haystack=r}static parse(e,r){if(e.length!==3)return r.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const n=r.parse(e[1],1,Mt),a=r.parse(e[2],2,Mt);return n&&a?wt(n.type,[Lt,Rt,et,Wr,Mt])?new jt(n,a):r.error(`Expected first argument to be of type boolean, string, number or null, but found ${Be(n.type)} instead`):null}evaluate(e){const r=this.needle.evaluate(e),n=this.haystack.evaluate(e);if(!n)return!1;if(!$t(r,["boolean","string","number","null"]))throw new yr(`Expected first argument to be of type boolean, string, number or null, but found ${Be(Xr(r))} instead.`);if(!$t(n,["string","array"]))throw new yr(`Expected second argument to be of type array or string, but found ${Be(Xr(n))} instead.`);return n.indexOf(r)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}}class lo{constructor(e,r,n){this.type=et,this.needle=e,this.haystack=r,this.fromIndex=n}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 2 or 3 arguments, but found ${e.length-1} instead.`);const n=r.parse(e[1],1,Mt),a=r.parse(e[2],2,Mt);if(!n||!a)return null;if(!wt(n.type,[Lt,Rt,et,Wr,Mt]))return r.error(`Expected first argument to be of type boolean, string, number or null, but found ${Be(n.type)} instead`);if(e.length===4){const h=r.parse(e[3],3,et);return h?new lo(n,a,h):null}return new lo(n,a)}evaluate(e){const r=this.needle.evaluate(e),n=this.haystack.evaluate(e);if(!$t(r,["boolean","string","number","null"]))throw new yr(`Expected first argument to be of type boolean, string, number or null, but found ${Be(Xr(r))} instead.`);let a;if(this.fromIndex&&(a=this.fromIndex.evaluate(e)),$t(n,["string"])){const h=n.indexOf(r,a);return h===-1?-1:[...n.slice(0,h)].length}if($t(n,["array"]))return n.indexOf(r,a);throw new yr(`Expected second argument to be of type array or string, but found ${Be(Xr(n))} instead.`)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}}class rr{constructor(e,r,n,a,h,d){this.inputType=e,this.type=r,this.input=n,this.cases=a,this.outputs=h,this.otherwise=d}static parse(e,r){if(e.length<5)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return r.error("Expected an even number of arguments.");let n,a;r.expectedType&&r.expectedType.kind!=="value"&&(a=r.expectedType);const h={},d=[];for(let w=2;w<e.length-1;w+=2){let P=e[w];const I=e[w+1];Array.isArray(P)||(P=[P]);const C=r.concat(w);if(P.length===0)return C.error("Expected at least one branch label.");for(const F of P){if(typeof F!="number"&&typeof F!="string")return C.error("Branch labels must be numbers or strings.");if(typeof F=="number"&&Math.abs(F)>Number.MAX_SAFE_INTEGER)return C.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof F=="number"&&Math.floor(F)!==F)return C.error("Numeric branch labels must be integer values.");if(n){if(C.checkSubtype(n,Xr(F)))return null}else n=Xr(F);if(h[String(F)]!==void 0)return C.error("Branch labels must be unique.");h[String(F)]=d.length}const D=r.parse(I,w,a);if(!D)return null;a=a||D.type,d.push(D)}const m=r.parse(e[1],1,Mt);if(!m)return null;const y=r.parse(e[e.length-1],e.length-1,a);return y?m.type.kind!=="value"&&r.concat(1).checkSubtype(n,m.type)?null:new rr(n,a,m,h,d,y):null}evaluate(e){const r=this.input.evaluate(e);return(Xr(r)===this.inputType&&this.outputs[this.cases[r]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))&&this.otherwise.outputDefined()}}class qo{constructor(e,r,n){this.type=e,this.branches=r,this.otherwise=n}static parse(e,r){if(e.length<4)return r.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return r.error("Expected an odd number of arguments.");let n;r.expectedType&&r.expectedType.kind!=="value"&&(n=r.expectedType);const a=[];for(let d=1;d<e.length-1;d+=2){const m=r.parse(e[d],d,Lt);if(!m)return null;const y=r.parse(e[d+1],d+1,n);if(!y)return null;a.push([m,y]),n=n||y.type}const h=r.parse(e[e.length-1],e.length-1,n);if(!h)return null;if(!n)throw new Error("Can't infer output type");return new qo(n,a,h)}evaluate(e){for(const[r,n]of this.branches)if(r.evaluate(e))return n.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[r,n]of this.branches)e(r),e(n);e(this.otherwise)}outputDefined(){return this.branches.every((([e,r])=>r.outputDefined()))&&this.otherwise.outputDefined()}}class hs{constructor(e,r,n,a){this.type=e,this.input=r,this.beginIndex=n,this.endIndex=a}static parse(e,r){if(e.length<=2||e.length>=5)return r.error(`Expected 2 or 3 arguments, but found ${e.length-1} instead.`);const n=r.parse(e[1],1,Mt),a=r.parse(e[2],2,et);if(!n||!a)return null;if(!wt(n.type,[je(Mt),Rt,Mt]))return r.error(`Expected first argument to be of type array or string, but found ${Be(n.type)} instead`);if(e.length===4){const h=r.parse(e[3],3,et);return h?new hs(n.type,n,a,h):null}return new hs(n.type,n,a)}evaluate(e){const r=this.input.evaluate(e),n=this.beginIndex.evaluate(e);let a;if(this.endIndex&&(a=this.endIndex.evaluate(e)),$t(r,["string"]))return[...r].slice(n,a).join("");if($t(r,["array"]))return r.slice(n,a);throw new yr(`Expected first argument to be of type array or string, but found ${Be(Xr(r))} instead.`)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}}function co(i,e){const r=i.length-1;let n,a,h=0,d=r,m=0;for(;h<=d;)if(m=Math.floor((h+d)/2),n=i[m],a=i[m+1],n<=e){if(m===r||e<a)return m;h=m+1}else{if(!(n>e))throw new yr("Input is not a number.");d=m-1}return 0}class mn{constructor(e,r,n){this.type=e,this.input=r,this.labels=[],this.outputs=[];for(const[a,h]of n)this.labels.push(a),this.outputs.push(h)}static parse(e,r){if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");const n=r.parse(e[1],1,et);if(!n)return null;const a=[];let h=null;r.expectedType&&r.expectedType.kind!=="value"&&(h=r.expectedType);for(let d=1;d<e.length;d+=2){const m=d===1?-1/0:e[d],y=e[d+1],w=d,P=d+1;if(typeof m!="number")return r.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',w);if(a.length&&a[a.length-1][0]>=m)return r.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',w);const I=r.parse(y,P,h);if(!I)return null;h=h||I.type,a.push([m,I])}return new mn(h,n,a)}evaluate(e){const r=this.labels,n=this.outputs;if(r.length===1)return n[0].evaluate(e);const a=this.input.evaluate(e);if(a<=r[0])return n[0].evaluate(e);const h=r.length;return a>=r[h-1]?n[h-1].evaluate(e):n[co(r,a)].evaluate(e)}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}}function Lu(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Go,oc,Dd=(function(){if(oc)return Go;function i(e,r,n,a){this.cx=3*e,this.bx=3*(n-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*r,this.by=3*(a-r)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=r,this.p2x=n,this.p2y=a}return oc=1,Go=i,i.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,r){if(r===void 0&&(r=1e-6),e<0)return 0;if(e>1)return 1;for(var n=e,a=0;a<8;a++){var h=this.sampleCurveX(n)-e;if(Math.abs(h)<r)return n;var d=this.sampleCurveDerivativeX(n);if(Math.abs(d)<1e-6)break;n-=h/d}var m=0,y=1;for(n=e,a=0;a<20&&(h=this.sampleCurveX(n),!(Math.abs(h-e)<r));a++)e>h?m=n:y=n,n=.5*(y-m)+m;return n},solve:function(e,r){return this.sampleCurveY(this.solveCurveX(e,r))}},Go})(),Ou=Lu(Dd);class Ui{constructor(e,r,n,a,h){this.type=e,this.operator=r,this.interpolation=n,this.input=a,this.labels=[],this.outputs=[];for(const[d,m]of h)this.labels.push(d),this.outputs.push(m)}static interpolationFactor(e,r,n,a){let h=0;if(e.name==="exponential")h=Vs(r,e.base,n,a);else if(e.name==="linear")h=Vs(r,1,n,a);else if(e.name==="cubic-bezier"){const d=e.controlPoints;h=new Ou(d[0],d[1],d[2],d[3]).solve(Vs(r,1,n,a))}return h}static parse(e,r){let[n,a,h,...d]=e;if(!Array.isArray(a)||a.length===0)return r.error("Expected an interpolation type expression.",1);if(a[0]==="linear")a={name:"linear"};else if(a[0]==="exponential"){const w=a[1];if(typeof w!="number")return r.error("Exponential interpolation requires a numeric base.",1,1);a={name:"exponential",base:w}}else{if(a[0]!=="cubic-bezier")return r.error(`Unknown interpolation type ${String(a[0])}`,1,0);{const w=a.slice(1);if(w.length!==4||w.some((P=>typeof P!="number"||P<0||P>1)))return r.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);a={name:"cubic-bezier",controlPoints:w}}}if(e.length-1<4)return r.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return r.error("Expected an even number of arguments.");if(h=r.parse(h,2,et),!h)return null;const m=[];let y=null;n!=="interpolate-hcl"&&n!=="interpolate-lab"||r.expectedType==J?r.expectedType&&r.expectedType.kind!=="value"&&(y=r.expectedType):y=Pi;for(let w=0;w<d.length;w+=2){const P=d[w],I=d[w+1],C=w+3,D=w+4;if(typeof P!="number")return r.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',C);if(m.length&&m[m.length-1][0]>=P)return r.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',C);const F=r.parse(I,D,y);if(!F)return null;y=y||F.type,m.push([P,F])}return sr(y,et)||sr(y,Cn)||sr(y,Pi)||sr(y,K)||sr(y,se)||sr(y,J)||sr(y,xe)||sr(y,je(et))?new Ui(y,n,a,h,m):r.error(`Type ${Be(y)} is not interpolatable.`)}evaluate(e){const r=this.labels,n=this.outputs;if(r.length===1)return n[0].evaluate(e);const a=this.input.evaluate(e);if(a<=r[0])return n[0].evaluate(e);const h=r.length;if(a>=r[h-1])return n[h-1].evaluate(e);const d=co(r,a),m=Ui.interpolationFactor(this.interpolation,a,r[d],r[d+1]),y=n[d].evaluate(e),w=n[d+1].evaluate(e);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return dn(y,w,m);case"color":return Ut.interpolate(y,w,m);case"padding":return Ci.interpolate(y,w,m);case"colorArray":return zt.interpolate(y,w,m);case"numberArray":return Or.interpolate(y,w,m);case"variableAnchorOffsetCollection":return Vi.interpolate(y,w,m);case"array":return no(y,w,m);case"projectionDefinition":return $i.interpolate(y,w,m)}case"interpolate-hcl":switch(this.type.kind){case"color":return Ut.interpolate(y,w,m,"hcl");case"colorArray":return zt.interpolate(y,w,m,"hcl")}case"interpolate-lab":switch(this.type.kind){case"color":return Ut.interpolate(y,w,m,"lab");case"colorArray":return zt.interpolate(y,w,m,"lab")}}}eachChild(e){e(this.input);for(const r of this.outputs)e(r)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}}function Vs(i,e,r,n){const a=n-r,h=i-r;return a===0?0:e===1?h/a:(Math.pow(e,h)-1)/(Math.pow(e,a)-1)}const kr={color:Ut.interpolate,number:dn,padding:Ci.interpolate,numberArray:Or.interpolate,colorArray:zt.interpolate,variableAnchorOffsetCollection:Vi.interpolate,array:no};class Rn{constructor(e,r){this.type=e,this.args=r}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");let n=null;const a=r.expectedType;a&&a.kind!=="value"&&(n=a);const h=[];for(const m of e.slice(1)){const y=r.parse(m,1+h.length,n,void 0,{typeAnnotation:"omit"});if(!y)return null;n=n||y.type,h.push(y)}if(!n)throw new Error("No output type");const d=a&&h.some((m=>Ve(a,m.type)));return new Rn(d?Mt:n,h)}evaluate(e){let r,n=null,a=0;for(const h of this.args)if(a++,n=h.evaluate(e),n&&n instanceof rs&&!n.available&&(r||(r=n.name),n=null,a===this.args.length&&(n=r)),n!==null)break;return n}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}}function ac(i,e){return i==="=="||i==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Zo(i,e,r,n){return n.compare(e,r)===0}function Ur(i,e,r){const n=i!=="=="&&i!=="!=";return class my{constructor(h,d,m){this.type=Lt,this.lhs=h,this.rhs=d,this.collator=m,this.hasUntypedArgument=h.type.kind==="value"||d.type.kind==="value"}static parse(h,d){if(h.length!==3&&h.length!==4)return d.error("Expected two or three arguments.");const m=h[0];let y=d.parse(h[1],1,Mt);if(!y)return null;if(!ac(m,y.type))return d.concat(1).error(`"${m}" comparisons are not supported for type '${Be(y.type)}'.`);let w=d.parse(h[2],2,Mt);if(!w)return null;if(!ac(m,w.type))return d.concat(2).error(`"${m}" comparisons are not supported for type '${Be(w.type)}'.`);if(y.type.kind!==w.type.kind&&y.type.kind!=="value"&&w.type.kind!=="value")return d.error(`Cannot compare types '${Be(y.type)}' and '${Be(w.type)}'.`);n&&(y.type.kind==="value"&&w.type.kind!=="value"?y=new Ki(w.type,[y]):y.type.kind!=="value"&&w.type.kind==="value"&&(w=new Ki(y.type,[w])));let P=null;if(h.length===4){if(y.type.kind!=="string"&&w.type.kind!=="string"&&y.type.kind!=="value"&&w.type.kind!=="value")return d.error("Cannot use collator to compare non-string types.");if(P=d.parse(h[3],3,hn),!P)return null}return new my(y,w,P)}evaluate(h){const d=this.lhs.evaluate(h),m=this.rhs.evaluate(h);if(n&&this.hasUntypedArgument){const y=Xr(d),w=Xr(m);if(y.kind!==w.kind||y.kind!=="string"&&y.kind!=="number")throw new yr(`Expected arguments for "${i}" to be (string, string) or (number, number), but found (${y.kind}, ${w.kind}) instead.`)}if(this.collator&&!n&&this.hasUntypedArgument){const y=Xr(d),w=Xr(m);if(y.kind!=="string"||w.kind!=="string")return e(h,d,m)}return this.collator?r(h,d,m,this.collator.evaluate(h)):e(h,d,m)}eachChild(h){h(this.lhs),h(this.rhs),this.collator&&h(this.collator)}outputDefined(){return!0}}}const Bu=Ur("==",(function(i,e,r){return e===r}),Zo),lc=Ur("!=",(function(i,e,r){return e!==r}),(function(i,e,r,n){return!Zo(0,e,r,n)})),ju=Ur("<",(function(i,e,r){return e<r}),(function(i,e,r,n){return n.compare(e,r)<0})),zd=Ur(">",(function(i,e,r){return e>r}),(function(i,e,r,n){return n.compare(e,r)>0})),uo=Ur("<=",(function(i,e,r){return e<=r}),(function(i,e,r,n){return n.compare(e,r)<=0})),ja=Ur(">=",(function(i,e,r){return e>=r}),(function(i,e,r,n){return n.compare(e,r)>=0}));class ho{constructor(e,r,n){this.type=hn,this.locale=n,this.caseSensitive=e,this.diacriticSensitive=r}static parse(e,r){if(e.length!==2)return r.error("Expected one argument.");const n=e[1];if(typeof n!="object"||Array.isArray(n))return r.error("Collator options argument must be an object.");const a=r.parse(n["case-sensitive"]!==void 0&&n["case-sensitive"],1,Lt);if(!a)return null;const h=r.parse(n["diacritic-sensitive"]!==void 0&&n["diacritic-sensitive"],1,Lt);if(!h)return null;let d=null;return n.locale&&(d=r.parse(n.locale,1,Rt),!d)?null:new ho(a,h,d)}evaluate(e){return new ic(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}}class cc{constructor(e,r,n,a,h){this.type=Rt,this.number=e,this.locale=r,this.currency=n,this.minFractionDigits=a,this.maxFractionDigits=h}static parse(e,r){if(e.length!==3)return r.error("Expected two arguments.");const n=r.parse(e[1],1,et);if(!n)return null;const a=e[2];if(typeof a!="object"||Array.isArray(a))return r.error("NumberFormat options argument must be an object.");let h=null;if(a.locale&&(h=r.parse(a.locale,1,Rt),!h))return null;let d=null;if(a.currency&&(d=r.parse(a.currency,1,Rt),!d))return null;let m=null;if(a["min-fraction-digits"]&&(m=r.parse(a["min-fraction-digits"],1,et),!m))return null;let y=null;return a["max-fraction-digits"]&&(y=r.parse(a["max-fraction-digits"],1,et),!y)?null:new cc(n,h,d,m,y)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}}class Ho{constructor(e){this.type=G,this.sections=e}static parse(e,r){if(e.length<2)return r.error("Expected at least one argument.");const n=e[1];if(!Array.isArray(n)&&typeof n=="object")return r.error("First argument must be an image or text section.");const a=[];let h=!1;for(let d=1;d<=e.length-1;++d){const m=e[d];if(h&&typeof m=="object"&&!Array.isArray(m)){h=!1;let y=null;if(m["font-scale"]&&(y=r.parse(m["font-scale"],1,et),!y))return null;let w=null;if(m["text-font"]&&(w=r.parse(m["text-font"],1,je(Rt)),!w))return null;let P=null;if(m["text-color"]&&(P=r.parse(m["text-color"],1,Pi),!P))return null;let I=null;if(m["vertical-align"]){if(typeof m["vertical-align"]=="string"&&!kd.includes(m["vertical-align"]))return r.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${m["vertical-align"]}' instead.`);if(I=r.parse(m["vertical-align"],1,Rt),!I)return null}const C=a[a.length-1];C.scale=y,C.font=w,C.textColor=P,C.verticalAlign=I}else{const y=r.parse(e[d],1,Mt);if(!y)return null;const w=y.type.kind;if(w!=="string"&&w!=="value"&&w!=="null"&&w!=="resolvedImage")return r.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");h=!0,a.push({content:y,scale:null,font:null,textColor:null,verticalAlign:null})}}return new Ho(a)}evaluate(e){return new Ji(this.sections.map((r=>{const n=r.content.evaluate(e);return Xr(n)===fe?new sc("",n,null,null,null,r.verticalAlign?r.verticalAlign.evaluate(e):null):new sc(kn(n),null,r.scale?r.scale.evaluate(e):null,r.font?r.font.evaluate(e).join(","):null,r.textColor?r.textColor.evaluate(e):null,r.verticalAlign?r.verticalAlign.evaluate(e):null)})))}eachChild(e){for(const r of this.sections)e(r.content),r.scale&&e(r.scale),r.font&&e(r.font),r.textColor&&e(r.textColor),r.verticalAlign&&e(r.verticalAlign)}outputDefined(){return!1}}class po{constructor(e){this.type=fe,this.input=e}static parse(e,r){if(e.length!==2)return r.error("Expected two arguments.");const n=r.parse(e[1],1,Rt);return n?new po(n):r.error("No image name provided.")}evaluate(e){const r=this.input.evaluate(e),n=rs.fromString(r);return n&&e.availableImages&&(n.available=e.availableImages.indexOf(r)>-1),n}eachChild(e){e(this.input)}outputDefined(){return!1}}class fo{constructor(e){this.type=et,this.input=e}static parse(e,r){if(e.length!==2)return r.error(`Expected 1 argument, but found ${e.length-1} instead.`);const n=r.parse(e[1],1);return n?n.type.kind!=="array"&&n.type.kind!=="string"&&n.type.kind!=="value"?r.error(`Expected argument of type string or array, but found ${Be(n.type)} instead.`):new fo(n):null}evaluate(e){const r=this.input.evaluate(e);if(typeof r=="string")return[...r].length;if(Array.isArray(r))return r.length;throw new yr(`Expected value to be of type string or array, but found ${Be(Xr(r))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}}const oi=8192;function Nu(i,e){const r=(180+i[0])/360,n=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i[1]*Math.PI/360)))/360,a=Math.pow(2,e.z);return[Math.round(r*a*oi),Math.round(n*a*oi)]}function mo(i,e){const r=Math.pow(2,e.z);return[(a=(i[0]/oi+e.x)/r,360*a-180),(n=(i[1]/oi+e.y)/r,360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90)];var n,a}function Wo(i,e){i[0]=Math.min(i[0],e[0]),i[1]=Math.min(i[1],e[1]),i[2]=Math.max(i[2],e[0]),i[3]=Math.max(i[3],e[1])}function Fn(i,e){return!(i[0]<=e[0]||i[2]>=e[2]||i[1]<=e[1]||i[3]>=e[3])}function Rd(i,e,r){const n=i[0]-e[0],a=i[1]-e[1],h=i[0]-r[0],d=i[1]-r[1];return n*d-h*a==0&&n*h<=0&&a*d<=0}function Na(i,e,r,n){return(a=[n[0]-r[0],n[1]-r[1]])[0]*(h=[e[0]-i[0],e[1]-i[1]])[1]-a[1]*h[0]!=0&&!(!uc(i,e,r,n)||!uc(r,n,i,e));var a,h}function Fd(i,e,r){for(const n of r)for(let a=0;a<n.length-1;++a)if(Na(i,e,n[a],n[a+1]))return!0;return!1}function go(i,e,r=!1){let n=!1;for(const m of e)for(let y=0;y<m.length-1;y++){if(Rd(i,m[y],m[y+1]))return r;(h=m[y])[1]>(a=i)[1]!=(d=m[y+1])[1]>a[1]&&a[0]<(d[0]-h[0])*(a[1]-h[1])/(d[1]-h[1])+h[0]&&(n=!n)}var a,h,d;return n}function Va(i,e){for(const r of e)if(go(i,r))return!0;return!1}function Vu(i,e){for(const r of i)if(!go(r,e))return!1;for(let r=0;r<i.length-1;++r)if(Fd(i[r],i[r+1],e))return!1;return!0}function $u(i,e){for(const r of e)if(Vu(i,r))return!0;return!1}function uc(i,e,r,n){const a=n[0]-r[0],h=n[1]-r[1],d=(i[0]-r[0])*h-a*(i[1]-r[1]),m=(e[0]-r[0])*h-a*(e[1]-r[1]);return d>0&&m<0||d<0&&m>0}function hc(i,e,r){const n=[];for(let a=0;a<i.length;a++){const h=[];for(let d=0;d<i[a].length;d++){const m=Nu(i[a][d],r);Wo(e,m),h.push(m)}n.push(h)}return n}function dc(i,e,r){const n=[];for(let a=0;a<i.length;a++){const h=hc(i[a],e,r);n.push(h)}return n}function Uu(i,e,r,n){if(i[0]<r[0]||i[0]>r[2]){const a=.5*n;let h=i[0]-r[0]>a?-n:r[0]-i[0]>a?n:0;h===0&&(h=i[0]-r[2]>a?-n:r[2]-i[0]>a?n:0),i[0]+=h}Wo(e,i)}function qu(i,e,r,n){const a=Math.pow(2,n.z)*oi,h=[n.x*oi,n.y*oi],d=[];for(const m of i)for(const y of m){const w=[y.x+h[0],y.y+h[1]];Uu(w,e,r,a),d.push(w)}return d}function Gu(i,e,r,n){const a=Math.pow(2,n.z)*oi,h=[n.x*oi,n.y*oi],d=[];for(const y of i){const w=[];for(const P of y){const I=[P.x+h[0],P.y+h[1]];Wo(e,I),w.push(I)}d.push(w)}if(e[2]-e[0]<=a/2){(m=e)[0]=m[1]=1/0,m[2]=m[3]=-1/0;for(const y of d)for(const w of y)Uu(w,e,r,a)}var m;return d}class Ln{constructor(e,r){this.type=Lt,this.geojson=e,this.geometries=r}static parse(e,r){if(e.length!==2)return r.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(fn(e[1])){const n=e[1];if(n.type==="FeatureCollection"){const a=[];for(const h of n.features){const{type:d,coordinates:m}=h.geometry;d==="Polygon"&&a.push(m),d==="MultiPolygon"&&a.push(...m)}if(a.length)return new Ln(n,{type:"MultiPolygon",coordinates:a})}else if(n.type==="Feature"){const a=n.geometry.type;if(a==="Polygon"||a==="MultiPolygon")return new Ln(n,n.geometry)}else if(n.type==="Polygon"||n.type==="MultiPolygon")return new Ln(n,n)}return r.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return(function(r,n){const a=[1/0,1/0,-1/0,-1/0],h=[1/0,1/0,-1/0,-1/0],d=r.canonicalID();if(n.type==="Polygon"){const m=hc(n.coordinates,h,d),y=qu(r.geometry(),a,h,d);if(!Fn(a,h))return!1;for(const w of y)if(!go(w,m))return!1}if(n.type==="MultiPolygon"){const m=dc(n.coordinates,h,d),y=qu(r.geometry(),a,h,d);if(!Fn(a,h))return!1;for(const w of y)if(!Va(w,m))return!1}return!0})(e,this.geometries);if(e.geometryType()==="LineString")return(function(r,n){const a=[1/0,1/0,-1/0,-1/0],h=[1/0,1/0,-1/0,-1/0],d=r.canonicalID();if(n.type==="Polygon"){const m=hc(n.coordinates,h,d),y=Gu(r.geometry(),a,h,d);if(!Fn(a,h))return!1;for(const w of y)if(!Vu(w,m))return!1}if(n.type==="MultiPolygon"){const m=dc(n.coordinates,h,d),y=Gu(r.geometry(),a,h,d);if(!Fn(a,h))return!1;for(const w of y)if(!$u(w,m))return!1}return!0})(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let Zu=class{constructor(i=[],e=(r,n)=>r<n?-1:r>n?1:0){if(this.data=i,this.length=this.data.length,this.compare=e,this.length>0)for(let r=(this.length>>1)-1;r>=0;r--)this._down(r)}push(i){this.data.push(i),this._up(this.length++)}pop(){if(this.length===0)return;const i=this.data[0],e=this.data.pop();return--this.length>0&&(this.data[0]=e,this._down(0)),i}peek(){return this.data[0]}_up(i){const{data:e,compare:r}=this,n=e[i];for(;i>0;){const a=i-1>>1,h=e[a];if(r(n,h)>=0)break;e[i]=h,i=a}e[i]=n}_down(i){const{data:e,compare:r}=this,n=this.length>>1,a=e[i];for(;i<n;){let h=1+(i<<1);const d=h+1;if(d<this.length&&r(e[d],e[h])<0&&(h=d),r(e[h],a)>=0)break;e[i]=e[h],i=h}e[i]=a}};function pc(i,e,r=0,n=i.length-1,a=Hu){for(;n>r;){if(n-r>600){const y=n-r+1,w=e-r+1,P=Math.log(y),I=.5*Math.exp(2*P/3),C=.5*Math.sqrt(P*I*(y-I)/y)*(w-y/2<0?-1:1);pc(i,e,Math.max(r,Math.floor(e-w*I/y+C)),Math.min(n,Math.floor(e+(y-w)*I/y+C)),a)}const h=i[e];let d=r,m=n;for(_o(i,r,e),a(i[n],h)>0&&_o(i,r,n);d<m;){for(_o(i,d,m),d++,m--;a(i[d],h)<0;)d++;for(;a(i[m],h)>0;)m--}a(i[r],h)===0?_o(i,r,m):(m++,_o(i,m,n)),m<=e&&(r=m+1),e<=m&&(n=m-1)}}function _o(i,e,r){const n=i[e];i[e]=i[r],i[r]=n}function Hu(i,e){return i<e?-1:i>e?1:0}function $a(i,e){if(i.length<=1)return[i];const r=[];let n,a;for(const h of i){const d=Od(h);d!==0&&(h.area=Math.abs(d),a===void 0&&(a=d<0),a===d<0?(n&&r.push(n),n=[h]):n.push(h))}if(n&&r.push(n),e>1)for(let h=0;h<r.length;h++)r[h].length<=e||(pc(r[h],e,1,r[h].length-1,Ld),r[h]=r[h].slice(0,e));return r}function Ld(i,e){return e.area-i.area}function Od(i){let e=0;for(let r,n,a=0,h=i.length,d=h-1;a<h;d=a++)r=i[a],n=i[d],e+=(n.x-r.x)*(r.y+n.y);return e}const Wu=1/298.257223563,Xo=Wu*(2-Wu),Xu=Math.PI/180;class fc{constructor(e){const r=6378.137*Xu*1e3,n=Math.cos(e*Xu),a=1/(1-Xo*(1-n*n)),h=Math.sqrt(a);this.kx=r*h*n,this.ky=r*h*a*(1-Xo)}distance(e,r){const n=this.wrap(e[0]-r[0])*this.kx,a=(e[1]-r[1])*this.ky;return Math.sqrt(n*n+a*a)}pointOnLine(e,r){let n,a,h,d,m=1/0;for(let y=0;y<e.length-1;y++){let w=e[y][0],P=e[y][1],I=this.wrap(e[y+1][0]-w)*this.kx,C=(e[y+1][1]-P)*this.ky,D=0;I===0&&C===0||(D=(this.wrap(r[0]-w)*this.kx*I+(r[1]-P)*this.ky*C)/(I*I+C*C),D>1?(w=e[y+1][0],P=e[y+1][1]):D>0&&(w+=I/this.kx*D,P+=C/this.ky*D)),I=this.wrap(r[0]-w)*this.kx,C=(r[1]-P)*this.ky;const F=I*I+C*C;F<m&&(m=F,n=w,a=P,h=y,d=D)}return{point:[n,a],index:h,t:Math.max(0,Math.min(1,d))}}wrap(e){for(;e<-180;)e+=360;for(;e>180;)e-=360;return e}}function Yu(i,e){return e[0]-i[0]}function Ua(i){return i[1]-i[0]+1}function bs(i,e){return i[1]>=i[0]&&i[1]<e}function qa(i,e){if(i[0]>i[1])return[null,null];const r=Ua(i);if(e){if(r===2)return[i,null];const a=Math.floor(r/2);return[[i[0],i[0]+a],[i[0]+a,i[1]]]}if(r===1)return[i,null];const n=Math.floor(r/2)-1;return[[i[0],i[0]+n],[i[0]+n+1,i[1]]]}function mc(i,e){if(!bs(e,i.length))return[1/0,1/0,-1/0,-1/0];const r=[1/0,1/0,-1/0,-1/0];for(let n=e[0];n<=e[1];++n)Wo(r,i[n]);return r}function gc(i){const e=[1/0,1/0,-1/0,-1/0];for(const r of i)for(const n of r)Wo(e,n);return e}function _c(i){return i[0]!==-1/0&&i[1]!==-1/0&&i[2]!==1/0&&i[3]!==1/0}function Ga(i,e,r){if(!_c(i)||!_c(e))return NaN;let n=0,a=0;return i[2]<e[0]&&(n=e[0]-i[2]),i[0]>e[2]&&(n=i[0]-e[2]),i[1]>e[3]&&(a=i[1]-e[3]),i[3]<e[1]&&(a=e[1]-i[3]),r.distance([0,0],[n,a])}function On(i,e,r){const n=r.pointOnLine(e,i);return r.distance(i,n.point)}function yc(i,e,r,n,a){const h=Math.min(On(i,[r,n],a),On(e,[r,n],a)),d=Math.min(On(r,[i,e],a),On(n,[i,e],a));return Math.min(h,d)}function Bd(i,e,r,n,a){if(!bs(e,i.length)||!bs(n,r.length))return 1/0;let h=1/0;for(let d=e[0];d<e[1];++d){const m=i[d],y=i[d+1];for(let w=n[0];w<n[1];++w){const P=r[w],I=r[w+1];if(Na(m,y,P,I))return 0;h=Math.min(h,yc(m,y,P,I,a))}}return h}function Ju(i,e,r,n,a){if(!bs(e,i.length)||!bs(n,r.length))return NaN;let h=1/0;for(let d=e[0];d<=e[1];++d)for(let m=n[0];m<=n[1];++m)if(h=Math.min(h,a.distance(i[d],r[m])),h===0)return h;return h}function jd(i,e,r){if(go(i,e,!0))return 0;let n=1/0;for(const a of e){const h=a[0],d=a[a.length-1];if(h!==d&&(n=Math.min(n,On(i,[d,h],r)),n===0))return n;const m=r.pointOnLine(a,i);if(n=Math.min(n,r.distance(i,m.point)),n===0)return n}return n}function Nd(i,e,r,n){if(!bs(e,i.length))return NaN;for(let h=e[0];h<=e[1];++h)if(go(i[h],r,!0))return 0;let a=1/0;for(let h=e[0];h<e[1];++h){const d=i[h],m=i[h+1];for(const y of r)for(let w=0,P=y.length,I=P-1;w<P;I=w++){const C=y[I],D=y[w];if(Na(d,m,C,D))return 0;a=Math.min(a,yc(d,m,C,D,n))}}return a}function Ku(i,e){for(const r of i)for(const n of r)if(go(n,e,!0))return!0;return!1}function Vd(i,e,r,n=1/0){const a=gc(i),h=gc(e);if(n!==1/0&&Ga(a,h,r)>=n)return n;if(Fn(a,h)){if(Ku(i,e))return 0}else if(Ku(e,i))return 0;let d=1/0;for(const m of i)for(let y=0,w=m.length,P=w-1;y<w;P=y++){const I=m[P],C=m[y];for(const D of e)for(let F=0,L=D.length,B=L-1;F<L;B=F++){const U=D[B],ee=D[F];if(Na(I,C,U,ee))return 0;d=Math.min(d,yc(I,C,U,ee,r))}}return d}function lr(i,e,r,n,a,h){if(!h)return;const d=Ga(mc(n,h),a,r);d<e&&i.push([d,h,[0,0]])}function Za(i,e,r,n,a,h,d){if(!h||!d)return;const m=Ga(mc(n,h),mc(a,d),r);m<e&&i.push([m,h,d])}function Ha(i,e,r,n,a=1/0){let h=Math.min(n.distance(i[0],r[0][0]),a);if(h===0)return h;const d=new Zu([[0,[0,i.length-1],[0,0]]],Yu),m=gc(r);for(;d.length>0;){const y=d.pop();if(y[0]>=h)continue;const w=y[1],P=e?50:100;if(Ua(w)<=P){if(!bs(w,i.length))return NaN;if(e){const I=Nd(i,w,r,n);if(isNaN(I)||I===0)return I;h=Math.min(h,I)}else for(let I=w[0];I<=w[1];++I){const C=jd(i[I],r,n);if(h=Math.min(h,C),h===0)return 0}}else{const I=qa(w,e);lr(d,h,n,i,m,I[0]),lr(d,h,n,i,m,I[1])}}return h}function Wa(i,e,r,n,a,h=1/0){let d=Math.min(h,a.distance(i[0],r[0]));if(d===0)return d;const m=new Zu([[0,[0,i.length-1],[0,r.length-1]]],Yu);for(;m.length>0;){const y=m.pop();if(y[0]>=d)continue;const w=y[1],P=y[2],I=e?50:100,C=n?50:100;if(Ua(w)<=I&&Ua(P)<=C){if(!bs(w,i.length)&&bs(P,r.length))return NaN;let D;if(e&&n)D=Bd(i,w,r,P,a),d=Math.min(d,D);else if(e&&!n){const F=i.slice(w[0],w[1]+1);for(let L=P[0];L<=P[1];++L)if(D=On(r[L],F,a),d=Math.min(d,D),d===0)return d}else if(!e&&n){const F=r.slice(P[0],P[1]+1);for(let L=w[0];L<=w[1];++L)if(D=On(i[L],F,a),d=Math.min(d,D),d===0)return d}else D=Ju(i,w,r,P,a),d=Math.min(d,D)}else{const D=qa(w,e),F=qa(P,n);Za(m,d,a,i,r,D[0],F[0]),Za(m,d,a,i,r,D[0],F[1]),Za(m,d,a,i,r,D[1],F[0]),Za(m,d,a,i,r,D[1],F[1])}}return d}function xc(i){return i.type==="MultiPolygon"?i.coordinates.map((e=>({type:"Polygon",coordinates:e}))):i.type==="MultiLineString"?i.coordinates.map((e=>({type:"LineString",coordinates:e}))):i.type==="MultiPoint"?i.coordinates.map((e=>({type:"Point",coordinates:e}))):[i]}class Bn{constructor(e,r){this.type=et,this.geojson=e,this.geometries=r}static parse(e,r){if(e.length!==2)return r.error(`'distance' expression requires exactly one argument, but found ${e.length-1} instead.`);if(fn(e[1])){const n=e[1];if(n.type==="FeatureCollection")return new Bn(n,n.features.map((a=>xc(a.geometry))).flat());if(n.type==="Feature")return new Bn(n,xc(n.geometry));if("type"in n&&"coordinates"in n)return new Bn(n,xc(n))}return r.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return(function(r,n){const a=r.geometry(),h=a.flat().map((y=>mo([y.x,y.y],r.canonical)));if(a.length===0)return NaN;const d=new fc(h[0][1]);let m=1/0;for(const y of n){switch(y.type){case"Point":m=Math.min(m,Wa(h,!1,[y.coordinates],!1,d,m));break;case"LineString":m=Math.min(m,Wa(h,!1,y.coordinates,!0,d,m));break;case"Polygon":m=Math.min(m,Ha(h,!1,y.coordinates,d,m))}if(m===0)return m}return m})(e,this.geometries);if(e.geometryType()==="LineString")return(function(r,n){const a=r.geometry(),h=a.flat().map((y=>mo([y.x,y.y],r.canonical)));if(a.length===0)return NaN;const d=new fc(h[0][1]);let m=1/0;for(const y of n){switch(y.type){case"Point":m=Math.min(m,Wa(h,!0,[y.coordinates],!1,d,m));break;case"LineString":m=Math.min(m,Wa(h,!0,y.coordinates,!0,d,m));break;case"Polygon":m=Math.min(m,Ha(h,!0,y.coordinates,d,m))}if(m===0)return m}return m})(e,this.geometries);if(e.geometryType()==="Polygon")return(function(r,n){const a=r.geometry();if(a.length===0||a[0].length===0)return NaN;const h=$a(a,0).map((y=>y.map((w=>w.map((P=>mo([P.x,P.y],r.canonical))))))),d=new fc(h[0][0][0][1]);let m=1/0;for(const y of n)for(const w of h){switch(y.type){case"Point":m=Math.min(m,Ha([y.coordinates],!1,w,d,m));break;case"LineString":m=Math.min(m,Ha(y.coordinates,!0,w,d,m));break;case"Polygon":m=Math.min(m,Vd(w,y.coordinates,d,m))}if(m===0)return m}return m})(e,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}class Yo{constructor(e){this.type=Mt,this.key=e}static parse(e,r){if(e.length!==2)return r.error(`Expected 1 argument, but found ${e.length-1} instead.`);const n=e[1];return n==null?r.error("Global state property must be defined."):typeof n!="string"?r.error(`Global state property must be string, but found ${typeof e[1]} instead.`):new Yo(n)}evaluate(e){var r;const n=(r=e.globals)===null||r===void 0?void 0:r.globalState;return n&&Object.keys(n).length!==0?$o(n,this.key):null}eachChild(){}outputDefined(){return!1}}const yo={"==":Bu,"!=":lc,">":zd,"<":ju,">=":ja,"<=":uo,array:Ki,at:tr,boolean:Ki,case:qo,coalesce:Rn,collator:ho,format:Ho,image:po,in:jt,"index-of":lo,interpolate:Ui,"interpolate-hcl":Ui,"interpolate-lab":Ui,length:fo,let:xr,literal:Ns,match:rr,number:Ki,"number-format":cc,object:Ki,slice:hs,step:mn,string:Ki,"to-boolean":Xs,"to-color":Xs,"to-number":Xs,"to-string":Xs,var:ao,within:Ln,distance:Bn,"global-state":Yo};class ds{constructor(e,r,n,a){this.name=e,this.type=r,this._evaluate=n,this.args=a}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}static parse(e,r){const n=e[0],a=ds.definitions[n];if(!a)return r.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0);const h=Array.isArray(a)?a[0]:a.type,d=Array.isArray(a)?[[a[1],a[2]]]:a.overloads,m=d.filter((([w])=>!Array.isArray(w)||w.length===e.length-1));let y=null;for(const[w,P]of m){y=new zn(r.registry,Xa,r.path,null,r.scope);const I=[];let C=!1;for(let D=1;D<e.length;D++){const F=e[D],L=Array.isArray(w)?w[D-1]:w.type,B=y.parse(F,1+I.length,L);if(!B){C=!0;break}I.push(B)}if(!C)if(Array.isArray(w)&&w.length!==I.length)y.error(`Expected ${w.length} arguments, but found ${I.length} instead.`);else{for(let D=0;D<I.length;D++){const F=Array.isArray(w)?w[D]:w.type,L=I[D];y.concat(D+1).checkSubtype(F,L.type)}if(y.errors.length===0)return new ds(n,h,P,I)}}if(m.length===1)r.errors.push(...y.errors);else{const w=(m.length?m:d).map((([I])=>{return C=I,Array.isArray(C)?`(${C.map(Be).join(", ")})`:`(${Be(C.type)}...)`;var C})).join(" | "),P=[];for(let I=1;I<e.length;I++){const C=r.parse(e[I],1+P.length);if(!C)return null;P.push(Be(C.type))}r.error(`Expected arguments of type ${w}, but found (${P.join(", ")}) instead.`)}return null}static register(e,r){ds.definitions=r;for(const n in r)e[n]=ds}}function Qu(i,[e,r,n,a]){e=e.evaluate(i),r=r.evaluate(i),n=n.evaluate(i);const h=a?a.evaluate(i):1,d=oo(e,r,n,h);if(d)throw new yr(d);return new Ut(e/255,r/255,n/255,h,!1)}function eh(i,e){return i in e}function vc(i,e){const r=e[i];return r===void 0?null:r}function jn(i){return{type:i}}function Xa(i){if(i instanceof ao)return Xa(i.boundExpression);if(i instanceof ds&&i.name==="error"||i instanceof ho||i instanceof Ln||i instanceof Bn||i instanceof Yo)return!1;const e=i instanceof Xs||i instanceof Ki;let r=!0;return i.eachChild((n=>{r=e?r&&Xa(n):r&&n instanceof Ns})),!!r&&Ya(i)&&Ja(i,["zoom","heatmap-density","elevation","line-progress","accumulated","is-supported-script"])}function Ya(i){if(i instanceof ds&&(i.name==="get"&&i.args.length===1||i.name==="feature-state"||i.name==="has"&&i.args.length===1||i.name==="properties"||i.name==="geometry-type"||i.name==="id"||/^filter-/.test(i.name))||i instanceof Ln||i instanceof Bn)return!1;let e=!0;return i.eachChild((r=>{e&&!Ya(r)&&(e=!1)})),e}function Jo(i){if(i instanceof ds&&i.name==="feature-state")return!1;let e=!0;return i.eachChild((r=>{e&&!Jo(r)&&(e=!1)})),e}function Ja(i,e){if(i instanceof ds&&e.indexOf(i.name)>=0)return!1;let r=!0;return i.eachChild((n=>{r&&!Ja(n,e)&&(r=!1)})),r}function th(i){return{result:"success",value:i}}function xo(i){return{result:"error",value:i}}function vo(i){return i["property-type"]==="data-driven"||i["property-type"]==="cross-faded-data-driven"}function rh(i){return!!i.expression&&i.expression.parameters.indexOf("zoom")>-1}function bc(i){return!!i.expression&&i.expression.interpolated}function qt(i){return i instanceof Number?"number":i instanceof String?"string":i instanceof Boolean?"boolean":Array.isArray(i)?"array":i===null?"null":typeof i}function Ka(i){return typeof i=="object"&&i!==null&&!Array.isArray(i)&&Xr(i)===vs}function $d(i){return i}function ih(i,e){const r=i.stops&&typeof i.stops[0][0]=="object",n=r||!(r||i.property!==void 0),a=i.type||(bc(e)?"exponential":"interval"),h=(function(P){switch(P.type){case"color":return Ut.parse;case"padding":return Ci.parse;case"numberArray":return Or.parse;case"colorArray":return zt.parse;default:return null}})(e);if(h&&((i=fi({},i)).stops&&(i.stops=i.stops.map((P=>[P[0],h(P[1])]))),i.default=h(i.default?i.default:e.default)),i.colorSpace&&(d=i.colorSpace)!=="rgb"&&d!=="hcl"&&d!=="lab")throw new Error(`Unknown color space: "${i.colorSpace}"`);var d;const m=(function(P){switch(P){case"exponential":return sh;case"interval":return qd;case"categorical":return Ud;case"identity":return Gd;default:throw new Error(`Unknown function type "${P}"`)}})(a);let y,w;if(a==="categorical"){y=Object.create(null);for(const P of i.stops)y[P[0]]=P[1];w=typeof i.stops[0][0]}if(r){const P={},I=[];for(let F=0;F<i.stops.length;F++){const L=i.stops[F],B=L[0].zoom;P[B]===void 0&&(P[B]={zoom:B,type:i.type,property:i.property,default:i.default,stops:[]},I.push(B)),P[B].stops.push([L[0].value,L[1]])}const C=[];for(const F of I)C.push([P[F].zoom,ih(P[F],e)]);const D={name:"linear"};return{kind:"composite",interpolationType:D,interpolationFactor:Ui.interpolationFactor.bind(void 0,D),zoomStops:C.map((F=>F[0])),evaluate:({zoom:F},L)=>sh({stops:C,base:i.base},e,F).evaluate(F,L)}}if(n){const P=a==="exponential"?{name:"exponential",base:i.base!==void 0?i.base:1}:null;return{kind:"camera",interpolationType:P,interpolationFactor:Ui.interpolationFactor.bind(void 0,P),zoomStops:i.stops.map((I=>I[0])),evaluate:({zoom:I})=>m(i,e,I,y,w)}}return{kind:"source",evaluate(P,I){const C=I&&I.properties?I.properties[i.property]:void 0;return C===void 0?Ko(i.default,e.default):m(i,e,C,y,w)}}}function Ko(i,e,r){return i!==void 0?i:e!==void 0?e:r!==void 0?r:void 0}function Ud(i,e,r,n,a){return Ko(typeof r===a?n[r]:void 0,i.default,e.default)}function qd(i,e,r){if(qt(r)!=="number")return Ko(i.default,e.default);const n=i.stops.length;if(n===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[n-1][0])return i.stops[n-1][1];const a=co(i.stops.map((h=>h[0])),r);return i.stops[a][1]}function sh(i,e,r){const n=i.base!==void 0?i.base:1;if(qt(r)!=="number")return Ko(i.default,e.default);const a=i.stops.length;if(a===1||r<=i.stops[0][0])return i.stops[0][1];if(r>=i.stops[a-1][0])return i.stops[a-1][1];const h=co(i.stops.map((P=>P[0])),r),d=(function(P,I,C,D){const F=D-C,L=P-C;return F===0?0:I===1?L/F:(Math.pow(I,L)-1)/(Math.pow(I,F)-1)})(r,n,i.stops[h][0],i.stops[h+1][0]),m=i.stops[h][1],y=i.stops[h+1][1],w=kr[e.type]||$d;return typeof m.evaluate=="function"?{evaluate(...P){const I=m.evaluate.apply(void 0,P),C=y.evaluate.apply(void 0,P);if(I!==void 0&&C!==void 0)return w(I,C,d,i.colorSpace)}}:w(m,y,d,i.colorSpace)}function Gd(i,e,r){switch(e.type){case"color":r=Ut.parse(r);break;case"formatted":r=Ji.fromString(r.toString());break;case"resolvedImage":r=rs.fromString(r.toString());break;case"padding":r=Ci.parse(r);break;case"colorArray":r=zt.parse(r);break;case"numberArray":r=Or.parse(r);break;default:qt(r)===e.type||e.type==="enum"&&e.values[r]||(r=void 0)}return Ko(r,i.default,e.default)}ds.register(yo,{error:[{kind:"error"},[Rt],(i,[e])=>{throw new yr(e.evaluate(i))}],typeof:[Rt,[Mt],(i,[e])=>Be(Xr(e.evaluate(i)))],"to-rgba":[je(et,4),[Pi],(i,[e])=>{const[r,n,a,h]=e.evaluate(i).rgb;return[255*r,255*n,255*a,h]}],rgb:[Pi,[et,et,et],Qu],rgba:[Pi,[et,et,et,et],Qu],has:{type:Lt,overloads:[[[Rt],(i,[e])=>eh(e.evaluate(i),i.properties())],[[Rt,vs],(i,[e,r])=>eh(e.evaluate(i),r.evaluate(i))]]},get:{type:Mt,overloads:[[[Rt],(i,[e])=>vc(e.evaluate(i),i.properties())],[[Rt,vs],(i,[e,r])=>vc(e.evaluate(i),r.evaluate(i))]]},"feature-state":[Mt,[Rt],(i,[e])=>vc(e.evaluate(i),i.featureState||{})],properties:[vs,[],i=>i.properties()],"geometry-type":[Rt,[],i=>i.geometryType()],id:[Mt,[],i=>i.id()],zoom:[et,[],i=>i.globals.zoom],"heatmap-density":[et,[],i=>i.globals.heatmapDensity||0],elevation:[et,[],i=>i.globals.elevation||0],"line-progress":[et,[],i=>i.globals.lineProgress||0],accumulated:[Mt,[],i=>i.globals.accumulated===void 0?null:i.globals.accumulated],"+":[et,jn(et),(i,e)=>{let r=0;for(const n of e)r+=n.evaluate(i);return r}],"*":[et,jn(et),(i,e)=>{let r=1;for(const n of e)r*=n.evaluate(i);return r}],"-":{type:et,overloads:[[[et,et],(i,[e,r])=>e.evaluate(i)-r.evaluate(i)],[[et],(i,[e])=>-e.evaluate(i)]]},"/":[et,[et,et],(i,[e,r])=>e.evaluate(i)/r.evaluate(i)],"%":[et,[et,et],(i,[e,r])=>e.evaluate(i)%r.evaluate(i)],ln2:[et,[],()=>Math.LN2],pi:[et,[],()=>Math.PI],e:[et,[],()=>Math.E],"^":[et,[et,et],(i,[e,r])=>Math.pow(e.evaluate(i),r.evaluate(i))],sqrt:[et,[et],(i,[e])=>Math.sqrt(e.evaluate(i))],log10:[et,[et],(i,[e])=>Math.log(e.evaluate(i))/Math.LN10],ln:[et,[et],(i,[e])=>Math.log(e.evaluate(i))],log2:[et,[et],(i,[e])=>Math.log(e.evaluate(i))/Math.LN2],sin:[et,[et],(i,[e])=>Math.sin(e.evaluate(i))],cos:[et,[et],(i,[e])=>Math.cos(e.evaluate(i))],tan:[et,[et],(i,[e])=>Math.tan(e.evaluate(i))],asin:[et,[et],(i,[e])=>Math.asin(e.evaluate(i))],acos:[et,[et],(i,[e])=>Math.acos(e.evaluate(i))],atan:[et,[et],(i,[e])=>Math.atan(e.evaluate(i))],min:[et,jn(et),(i,e)=>Math.min(...e.map((r=>r.evaluate(i))))],max:[et,jn(et),(i,e)=>Math.max(...e.map((r=>r.evaluate(i))))],abs:[et,[et],(i,[e])=>Math.abs(e.evaluate(i))],round:[et,[et],(i,[e])=>{const r=e.evaluate(i);return r<0?-Math.round(-r):Math.round(r)}],floor:[et,[et],(i,[e])=>Math.floor(e.evaluate(i))],ceil:[et,[et],(i,[e])=>Math.ceil(e.evaluate(i))],"filter-==":[Lt,[Rt,Mt],(i,[e,r])=>i.properties()[e.value]===r.value],"filter-id-==":[Lt,[Mt],(i,[e])=>i.id()===e.value],"filter-type-==":[Lt,[Rt],(i,[e])=>i.geometryType()===e.value],"filter-<":[Lt,[Rt,Mt],(i,[e,r])=>{const n=i.properties()[e.value],a=r.value;return typeof n==typeof a&&n<a}],"filter-id-<":[Lt,[Mt],(i,[e])=>{const r=i.id(),n=e.value;return typeof r==typeof n&&r<n}],"filter->":[Lt,[Rt,Mt],(i,[e,r])=>{const n=i.properties()[e.value],a=r.value;return typeof n==typeof a&&n>a}],"filter-id->":[Lt,[Mt],(i,[e])=>{const r=i.id(),n=e.value;return typeof r==typeof n&&r>n}],"filter-<=":[Lt,[Rt,Mt],(i,[e,r])=>{const n=i.properties()[e.value],a=r.value;return typeof n==typeof a&&n<=a}],"filter-id-<=":[Lt,[Mt],(i,[e])=>{const r=i.id(),n=e.value;return typeof r==typeof n&&r<=n}],"filter->=":[Lt,[Rt,Mt],(i,[e,r])=>{const n=i.properties()[e.value],a=r.value;return typeof n==typeof a&&n>=a}],"filter-id->=":[Lt,[Mt],(i,[e])=>{const r=i.id(),n=e.value;return typeof r==typeof n&&r>=n}],"filter-has":[Lt,[Mt],(i,[e])=>e.value in i.properties()],"filter-has-id":[Lt,[],i=>i.id()!==null&&i.id()!==void 0],"filter-type-in":[Lt,[je(Rt)],(i,[e])=>e.value.indexOf(i.geometryType())>=0],"filter-id-in":[Lt,[je(Mt)],(i,[e])=>e.value.indexOf(i.id())>=0],"filter-in-small":[Lt,[Rt,je(Mt)],(i,[e,r])=>r.value.indexOf(i.properties()[e.value])>=0],"filter-in-large":[Lt,[Rt,je(Mt)],(i,[e,r])=>(function(n,a,h,d){for(;h<=d;){const m=h+d>>1;if(a[m]===n)return!0;a[m]>n?d=m-1:h=m+1}return!1})(i.properties()[e.value],r.value,0,r.value.length-1)],all:{type:Lt,overloads:[[[Lt,Lt],(i,[e,r])=>e.evaluate(i)&&r.evaluate(i)],[jn(Lt),(i,e)=>{for(const r of e)if(!r.evaluate(i))return!1;return!0}]]},any:{type:Lt,overloads:[[[Lt,Lt],(i,[e,r])=>e.evaluate(i)||r.evaluate(i)],[jn(Lt),(i,e)=>{for(const r of e)if(r.evaluate(i))return!0;return!1}]]},"!":[Lt,[Lt],(i,[e])=>!e.evaluate(i)],"is-supported-script":[Lt,[Rt],(i,[e])=>{const r=i.globals&&i.globals.isSupportedScript;return!r||r(e.evaluate(i))}],upcase:[Rt,[Rt],(i,[e])=>e.evaluate(i).toUpperCase()],downcase:[Rt,[Rt],(i,[e])=>e.evaluate(i).toLowerCase()],concat:[Rt,jn(Mt),(i,e)=>e.map((r=>kn(r.evaluate(i)))).join("")],"resolved-locale":[Rt,[hn],(i,[e])=>e.evaluate(i).resolvedLocale()]});class wc{constructor(e,r,n){this.expression=e,this._warningHistory={},this._evaluator=new nc,this._defaultValue=r?(function(a){if(a.type==="color"&&Ka(a.default))return new Ut(0,0,0,0);switch(a.type){case"color":return Ut.parse(a.default)||null;case"padding":return Ci.parse(a.default)||null;case"numberArray":return Or.parse(a.default)||null;case"colorArray":return zt.parse(a.default)||null;case"variableAnchorOffsetCollection":return Vi.parse(a.default)||null;case"projectionDefinition":return $i.parse(a.default)||null;default:return a.default===void 0?null:a.default}})(r):null,this._enumValues=r&&r.type==="enum"?r.values:null,this._globalState=n}evaluateWithoutErrorHandling(e,r,n,a,h,d){return this._globalState&&(e=Nn(e,this._globalState)),this._evaluator.globals=e,this._evaluator.feature=r,this._evaluator.featureState=n,this._evaluator.canonical=a,this._evaluator.availableImages=h||null,this._evaluator.formattedSection=d,this.expression.evaluate(this._evaluator)}evaluate(e,r,n,a,h,d){this._globalState&&(e=Nn(e,this._globalState)),this._evaluator.globals=e,this._evaluator.feature=r||null,this._evaluator.featureState=n||null,this._evaluator.canonical=a,this._evaluator.availableImages=h||null,this._evaluator.formattedSection=d||null;try{const m=this.expression.evaluate(this._evaluator);if(m==null||typeof m=="number"&&m!=m)return this._defaultValue;if(this._enumValues&&!(m in this._enumValues))throw new yr(`Expected value to be one of ${Object.keys(this._enumValues).map((y=>JSON.stringify(y))).join(", ")}, but found ${JSON.stringify(m)} instead.`);return m}catch(m){return this._warningHistory[m.message]||(this._warningHistory[m.message]=!0,typeof console<"u"&&console.warn(m.message)),this._defaultValue}}}function bo(i){return Array.isArray(i)&&i.length>0&&typeof i[0]=="string"&&i[0]in yo}function Qo(i,e,r){const n=new zn(yo,Xa,[],e?(function(h){const d={color:Pi,string:Rt,number:et,enum:Rt,boolean:Lt,formatted:G,padding:K,numberArray:se,colorArray:J,projectionDefinition:Cn,resolvedImage:fe,variableAnchorOffsetCollection:xe};return h.type==="array"?je(d[h.value]||Mt,h.length):d[h.type]})(e):void 0),a=n.parse(i,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return a?th(new wc(a,e,r)):xo(n.errors)}class Qa{constructor(e,r,n){this.kind=e,this._styleExpression=r,this.isStateDependent=e!=="constant"&&!Jo(r.expression),this.globalStateRefs=gn(r.expression),this._globalState=n}evaluateWithoutErrorHandling(e,r,n,a,h,d){return this._globalState&&(e=Nn(e,this._globalState)),this._styleExpression.evaluateWithoutErrorHandling(e,r,n,a,h,d)}evaluate(e,r,n,a,h,d){return this._globalState&&(e=Nn(e,this._globalState)),this._styleExpression.evaluate(e,r,n,a,h,d)}}class Tc{constructor(e,r,n,a,h){this.kind=e,this.zoomStops=n,this._styleExpression=r,this.isStateDependent=e!=="camera"&&!Jo(r.expression),this.globalStateRefs=gn(r.expression),this.interpolationType=a,this._globalState=h}evaluateWithoutErrorHandling(e,r,n,a,h,d){return this._globalState&&(e=Nn(e,this._globalState)),this._styleExpression.evaluateWithoutErrorHandling(e,r,n,a,h,d)}evaluate(e,r,n,a,h,d){return this._globalState&&(e=Nn(e,this._globalState)),this._styleExpression.evaluate(e,r,n,a,h,d)}interpolationFactor(e,r,n){return this.interpolationType?Ui.interpolationFactor(this.interpolationType,e,r,n):0}}function Sc(i,e,r){const n=Qo(i,e,r);if(n.result==="error")return n;const a=n.value.expression,h=Ya(a);if(!h&&!vo(e))return xo([new Si("","data expressions not supported")]);const d=Ja(a,["zoom"]);if(!d&&!rh(e))return xo([new Si("","zoom expressions not supported")]);const m=tl(a);return m||d?m instanceof Si?xo([m]):m instanceof Ui&&!bc(e)?xo([new Si("",'"interpolate" expressions cannot be used with this property')]):th(m?new Tc(h?"camera":"composite",n.value,m.labels,m instanceof Ui?m.interpolation:void 0,r):new Qa(h?"constant":"source",n.value,r)):xo([new Si("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class el{constructor(e,r){this._parameters=e,this._specification=r,fi(this,ih(this._parameters,this._specification))}static deserialize(e){return new el(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function tl(i){let e=null;if(i instanceof xr)e=tl(i.result);else if(i instanceof Rn){for(const r of i.args)if(e=tl(r),e)break}else(i instanceof mn||i instanceof Ui)&&i.input instanceof ds&&i.input.name==="zoom"&&(e=i);return e instanceof Si||i.eachChild((r=>{const n=tl(r);n instanceof Si?e=n:!e&&n?e=new Si("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&n&&e!==n&&(e=new Si("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),e}function gn(i,e=new Set){return i instanceof Yo&&e.add(i.key),i.eachChild((r=>{gn(r,e)})),e}function Nn(i,e){const{zoom:r,heatmapDensity:n,elevation:a,lineProgress:h,isSupportedScript:d,accumulated:m}=i??{};return{zoom:r,heatmapDensity:n,elevation:a,lineProgress:h,isSupportedScript:d,accumulated:m,globalState:e}}function Pc(i){if(i===!0||i===!1)return!0;if(!Array.isArray(i)||i.length===0)return!1;switch(i[0]){case"has":return i.length>=2&&i[1]!=="$id"&&i[1]!=="$type";case"in":return i.length>=3&&(typeof i[1]!="string"||Array.isArray(i[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return i.length!==3||Array.isArray(i[1])||Array.isArray(i[2]);case"any":case"all":for(const e of i.slice(1))if(!Pc(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}const Zd={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function ea(i,e){if(i==null)return{filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set};Pc(i)||(i=ta(i));const r=Qo(i,Zd,e);if(r.result==="error")throw new Error(r.value.map((n=>`${n.key}: ${n.message}`)).join(", "));return{filter:(n,a,h)=>r.value.evaluate(n,a,{},h),needGeometry:nh(i),getGlobalStateRefs:()=>gn(r.value.expression)}}function Hd(i,e){return i<e?-1:i>e?1:0}function nh(i){if(!Array.isArray(i))return!1;if(i[0]==="within"||i[0]==="distance")return!0;for(let e=1;e<i.length;e++)if(nh(i[e]))return!0;return!1}function ta(i){if(!i)return!0;const e=i[0];return i.length<=1?e!=="any":e==="=="?rl(i[1],i[2],"=="):e==="!="?ra(rl(i[1],i[2],"==")):e==="<"||e===">"||e==="<="||e===">="?rl(i[1],i[2],e):e==="any"?(r=i.slice(1),["any"].concat(r.map(ta))):e==="all"?["all"].concat(i.slice(1).map(ta)):e==="none"?["all"].concat(i.slice(1).map(ta).map(ra)):e==="in"?oh(i[1],i.slice(2)):e==="!in"?ra(oh(i[1],i.slice(2))):e==="has"?ah(i[1]):e!=="!has"||ra(ah(i[1]));var r}function rl(i,e,r){switch(i){case"$type":return[`filter-type-${r}`,e];case"$id":return[`filter-id-${r}`,e];default:return[`filter-${r}`,i,e]}}function oh(i,e){if(e.length===0)return!1;switch(i){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some((r=>typeof r!=typeof e[0]))?["filter-in-large",i,["literal",e.sort(Hd)]]:["filter-in-small",i,["literal",e]]}}function ah(i){switch(i){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",i]}}function ra(i){return["!",i]}function il(i){const e=typeof i;if(e==="number"||e==="boolean"||e==="string"||i==null)return JSON.stringify(i);if(Array.isArray(i)){let a="[";for(const h of i)a+=`${il(h)},`;return`${a}]`}const r=Object.keys(i).sort();let n="{";for(let a=0;a<r.length;a++)n+=`${JSON.stringify(r[a])}:${il(i[r[a]])},`;return`${n}}`}function lh(i){let e="";for(const r of dr)e+=`/${il(i[r])}`;return e}function ch(i){const e=i.value;return e?[new Ze(i.key,e,"constants have been deprecated as of v8")]:[]}function Yr(i){return i instanceof Number||i instanceof String||i instanceof Boolean?i.valueOf():i}function Vn(i){if(Array.isArray(i))return i.map(Vn);if(i instanceof Object&&!(i instanceof Number||i instanceof String||i instanceof Boolean)){const e={};for(const r in i)e[r]=Vn(i[r]);return e}return Yr(i)}function is(i){const e=i.key,r=i.value,n=i.valueSpec||{},a=i.objectElementValidators||{},h=i.style,d=i.styleSpec,m=i.validateSpec;let y=[];const w=qt(r);if(w!=="object")return[new Ze(e,r,`object expected, ${w} found`)];for(const P in r){const I=P.split(".")[0],C=$o(n,I)||n["*"];let D;if($o(a,I))D=a[I];else if($o(n,I)){if(r[P]===void 0)continue;D=m}else if(a["*"])D=a["*"];else{if(!n["*"]){y.push(new Ze(e,r[P],`unknown property "${P}"`));continue}D=m}y=y.concat(D({key:(e&&`${e}.`)+P,value:r[P],valueSpec:C,style:h,styleSpec:d,object:r,objectKey:P,validateSpec:m},r))}for(const P in n)a[P]||n[P].required&&n[P].default===void 0&&r[P]===void 0&&y.push(new Ze(e,r,`missing required property "${P}"`));return y}function sl(i){const e=i.value,r=i.valueSpec,n=i.style,a=i.styleSpec,h=i.key,d=i.arrayElementValidator||i.validateSpec;if(qt(e)!=="array")return[new Ze(h,e,`array expected, ${qt(e)} found`)];if(r.length&&e.length!==r.length)return[new Ze(h,e,`array length ${r.length} expected, length ${e.length} found`)];let m={type:r.value,values:r.values};a.$version<7&&(m.function=r.function),qt(r.value)==="object"&&(m=r.value);let y=[];for(let w=0;w<e.length;w++)y=y.concat(d({array:e,arrayIndex:w,value:e[w],valueSpec:m,validateSpec:i.validateSpec,style:n,styleSpec:a,key:`${h}[${w}]`}));return y}function ia(i){const e=i.key,r=i.value,n=i.valueSpec;let a=qt(r);return a==="number"&&r!=r&&(a="NaN"),a!=="number"?[new Ze(e,r,`number expected, ${a} found`)]:"minimum"in n&&r<n.minimum?[new Ze(e,r,`${r} is less than the minimum value ${n.minimum}`)]:"maximum"in n&&r>n.maximum?[new Ze(e,r,`${r} is greater than the maximum value ${n.maximum}`)]:[]}function nl(i){const e=i.valueSpec,r=Yr(i.value.type);let n,a,h,d={};const m=r!=="categorical"&&i.value.property===void 0,y=!m,w=qt(i.value.stops)==="array"&&qt(i.value.stops[0])==="array"&&qt(i.value.stops[0][0])==="object",P=is({key:i.key,value:i.value,valueSpec:i.styleSpec.function,validateSpec:i.validateSpec,style:i.style,styleSpec:i.styleSpec,objectElementValidators:{stops:function(D){if(r==="identity")return[new Ze(D.key,D.value,'identity function may not have a "stops" property')];let F=[];const L=D.value;return F=F.concat(sl({key:D.key,value:L,valueSpec:D.valueSpec,validateSpec:D.validateSpec,style:D.style,styleSpec:D.styleSpec,arrayElementValidator:I})),qt(L)==="array"&&L.length===0&&F.push(new Ze(D.key,L,"array must have at least one stop")),F},default:function(D){return D.validateSpec({key:D.key,value:D.value,valueSpec:e,validateSpec:D.validateSpec,style:D.style,styleSpec:D.styleSpec})}}});return r==="identity"&&m&&P.push(new Ze(i.key,i.value,'missing required property "property"')),r==="identity"||i.value.stops||P.push(new Ze(i.key,i.value,'missing required property "stops"')),r==="exponential"&&i.valueSpec.expression&&!bc(i.valueSpec)&&P.push(new Ze(i.key,i.value,"exponential functions not supported")),i.styleSpec.$version>=8&&(y&&!vo(i.valueSpec)?P.push(new Ze(i.key,i.value,"property functions not supported")):m&&!rh(i.valueSpec)&&P.push(new Ze(i.key,i.value,"zoom functions not supported"))),r!=="categorical"&&!w||i.value.property!==void 0||P.push(new Ze(i.key,i.value,'"property" property is required')),P;function I(D){let F=[];const L=D.value,B=D.key;if(qt(L)!=="array")return[new Ze(B,L,`array expected, ${qt(L)} found`)];if(L.length!==2)return[new Ze(B,L,`array length 2 expected, length ${L.length} found`)];if(w){if(qt(L[0])!=="object")return[new Ze(B,L,`object expected, ${qt(L[0])} found`)];if(L[0].zoom===void 0)return[new Ze(B,L,"object stop key must have zoom")];if(L[0].value===void 0)return[new Ze(B,L,"object stop key must have value")];if(h&&h>Yr(L[0].zoom))return[new Ze(B,L[0].zoom,"stop zoom values must appear in ascending order")];Yr(L[0].zoom)!==h&&(h=Yr(L[0].zoom),a=void 0,d={}),F=F.concat(is({key:`${B}[0]`,value:L[0],valueSpec:{zoom:{}},validateSpec:D.validateSpec,style:D.style,styleSpec:D.styleSpec,objectElementValidators:{zoom:ia,value:C}}))}else F=F.concat(C({key:`${B}[0]`,value:L[0],validateSpec:D.validateSpec,style:D.style,styleSpec:D.styleSpec},L));return bo(Vn(L[1]))?F.concat([new Ze(`${B}[1]`,L[1],"expressions are not allowed in function stops.")]):F.concat(D.validateSpec({key:`${B}[1]`,value:L[1],valueSpec:e,validateSpec:D.validateSpec,style:D.style,styleSpec:D.styleSpec}))}function C(D,F){const L=qt(D.value),B=Yr(D.value),U=D.value!==null?D.value:F;if(n){if(L!==n)return[new Ze(D.key,U,`${L} stop domain type must match previous stop domain type ${n}`)]}else n=L;if(L!=="number"&&L!=="string"&&L!=="boolean")return[new Ze(D.key,U,"stop domain value must be a number, string, or boolean")];if(L!=="number"&&r!=="categorical"){let ee=`number expected, ${L} found`;return vo(e)&&r===void 0&&(ee+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Ze(D.key,U,ee)]}return r!=="categorical"||L!=="number"||isFinite(B)&&Math.floor(B)===B?r!=="categorical"&&L==="number"&&a!==void 0&&B<a?[new Ze(D.key,U,"stop domain values must appear in ascending order")]:(a=B,r==="categorical"&&B in d?[new Ze(D.key,U,"stop domain values must be unique")]:(d[B]=!0,[])):[new Ze(D.key,U,`integer expected, found ${B}`)]}}function _n(i){const e=(i.expressionContext==="property"?Sc:Qo)(Vn(i.value),i.valueSpec);if(e.result==="error")return e.value.map((n=>new Ze(`${i.key}${n.key}`,i.value,n.message)));const r=e.value.expression||e.value._styleExpression.expression;if(i.expressionContext==="property"&&i.propertyKey==="text-font"&&!r.outputDefined())return[new Ze(i.key,i.value,`Invalid data expression for "${i.propertyKey}". Output values must be contained as literals within the expression.`)];if(i.expressionContext==="property"&&i.propertyType==="layout"&&!Jo(r))return[new Ze(i.key,i.value,'"feature-state" data expressions are not supported with layout properties.')];if(i.expressionContext==="filter"&&!Jo(r))return[new Ze(i.key,i.value,'"feature-state" data expressions are not supported with filters.')];if(i.expressionContext&&i.expressionContext.indexOf("cluster")===0){if(!Ja(r,["zoom","feature-state"]))return[new Ze(i.key,i.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(i.expressionContext==="cluster-initial"&&!Ya(r))return[new Ze(i.key,i.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function sa(i){const e=i.key,r=i.value,n=qt(r);return n!=="string"?[new Ze(e,r,`color expected, ${n} found`)]:Ut.parse(String(r))?[]:[new Ze(e,r,`color expected, "${r}" found`)]}function $n(i){const e=i.key,r=i.value,n=i.valueSpec,a=[];return Array.isArray(n.values)?n.values.indexOf(Yr(r))===-1&&a.push(new Ze(e,r,`expected one of [${n.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(n.values).indexOf(Yr(r))===-1&&a.push(new Ze(e,r,`expected one of [${Object.keys(n.values).join(", ")}], ${JSON.stringify(r)} found`)),a}function wo(i){return Pc(Vn(i.value))?_n(fi({},i,{expressionContext:"filter",valueSpec:{value:"boolean"}})):uh(i)}function uh(i){const e=i.value,r=i.key;if(qt(e)!=="array")return[new Ze(r,e,`array expected, ${qt(e)} found`)];const n=i.styleSpec;let a,h=[];if(e.length<1)return[new Ze(r,e,"filter array must have at least 1 element")];switch(h=h.concat($n({key:`${r}[0]`,value:e[0],valueSpec:n.filter_operator,style:i.style,styleSpec:i.styleSpec})),Yr(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&Yr(e[1])==="$type"&&h.push(new Ze(r,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":e.length!==3&&h.push(new Ze(r,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(a=qt(e[1]),a!=="string"&&h.push(new Ze(`${r}[1]`,e[1],`string expected, ${a} found`)));for(let d=2;d<e.length;d++)a=qt(e[d]),Yr(e[1])==="$type"?h=h.concat($n({key:`${r}[${d}]`,value:e[d],valueSpec:n.geometry_type,style:i.style,styleSpec:i.styleSpec})):a!=="string"&&a!=="number"&&a!=="boolean"&&h.push(new Ze(`${r}[${d}]`,e[d],`string, number, or boolean expected, ${a} found`));break;case"any":case"all":case"none":for(let d=1;d<e.length;d++)h=h.concat(uh({key:`${r}[${d}]`,value:e[d],style:i.style,styleSpec:i.styleSpec}));break;case"has":case"!has":a=qt(e[1]),e.length!==2?h.push(new Ze(r,e,`filter array for "${e[0]}" operator must have 2 elements`)):a!=="string"&&h.push(new Ze(`${r}[1]`,e[1],`string expected, ${a} found`))}return h}function hh(i,e){const r=i.key,n=i.validateSpec,a=i.style,h=i.styleSpec,d=i.value,m=i.objectKey,y=h[`${e}_${i.layerType}`];if(!y)return[];const w=m.match(/^(.*)-transition$/);if(e==="paint"&&w&&y[w[1]]&&y[w[1]].transition)return n({key:r,value:d,valueSpec:h.transition,style:a,styleSpec:h});const P=i.valueSpec||y[m];if(!P)return[new Ze(r,d,`unknown property "${m}"`)];let I;if(qt(d)==="string"&&vo(P)&&!P.tokens&&(I=/^{([^}]+)}$/.exec(d)))return[new Ze(r,d,`"${m}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(I[1])} }\`.`)];const C=[];return i.layerType==="symbol"&&m==="text-font"&&Ka(Vn(d))&&Yr(d.type)==="identity"&&C.push(new Ze(r,d,'"text-font" does not support identity functions')),C.concat(n({key:i.key,value:d,valueSpec:P,style:a,styleSpec:h,expressionContext:"property",propertyType:e,propertyKey:m}))}function dh(i){return hh(i,"paint")}function ph(i){return hh(i,"layout")}function fh(i){let e=[];const r=i.value,n=i.key,a=i.style,h=i.styleSpec;if(qt(r)!=="object")return[new Ze(n,r,`object expected, ${qt(r)} found`)];r.type||r.ref||e.push(new Ze(n,r,'either "type" or "ref" is required'));let d=Yr(r.type);const m=Yr(r.ref);if(r.id){const y=Yr(r.id);for(let w=0;w<i.arrayIndex;w++){const P=a.layers[w];Yr(P.id)===y&&e.push(new Ze(n,r.id,`duplicate layer id "${r.id}", previously used at line ${P.id.__line__}`))}}if("ref"in r){let y;["type","source","source-layer","filter","layout"].forEach((w=>{w in r&&e.push(new Ze(n,r[w],`"${w}" is prohibited for ref layers`))})),a.layers.forEach((w=>{Yr(w.id)===m&&(y=w)})),y?y.ref?e.push(new Ze(n,r.ref,"ref cannot reference another ref layer")):d=Yr(y.type):e.push(new Ze(n,r.ref,`ref layer "${m}" not found`))}else if(d!=="background")if(r.source){const y=a.sources&&a.sources[r.source],w=y&&Yr(y.type);y?w==="vector"&&d==="raster"?e.push(new Ze(n,r.source,`layer "${r.id}" requires a raster source`)):w!=="raster-dem"&&d==="hillshade"||w!=="raster-dem"&&d==="color-relief"?e.push(new Ze(n,r.source,`layer "${r.id}" requires a raster-dem source`)):w==="raster"&&d!=="raster"?e.push(new Ze(n,r.source,`layer "${r.id}" requires a vector source`)):w!=="vector"||r["source-layer"]?w==="raster-dem"&&d!=="hillshade"&&d!=="color-relief"?e.push(new Ze(n,r.source,"raster-dem source can only be used with layer type 'hillshade' or 'color-relief'.")):d!=="line"||!r.paint||!r.paint["line-gradient"]||w==="geojson"&&y.lineMetrics||e.push(new Ze(n,r,`layer "${r.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):e.push(new Ze(n,r,`layer "${r.id}" must specify a "source-layer"`)):e.push(new Ze(n,r.source,`source "${r.source}" not found`))}else e.push(new Ze(n,r,'missing required property "source"'));return e=e.concat(is({key:n,value:r,valueSpec:h.layer,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,objectElementValidators:{"*":()=>[],type:()=>i.validateSpec({key:`${n}.type`,value:r.type,valueSpec:h.layer.type,style:i.style,styleSpec:i.styleSpec,validateSpec:i.validateSpec,object:r,objectKey:"type"}),filter:wo,layout:y=>is({layer:r,key:y.key,value:y.value,style:y.style,styleSpec:y.styleSpec,validateSpec:y.validateSpec,objectElementValidators:{"*":w=>ph(fi({layerType:d},w))}}),paint:y=>is({layer:r,key:y.key,value:y.value,style:y.style,styleSpec:y.styleSpec,validateSpec:y.validateSpec,objectElementValidators:{"*":w=>dh(fi({layerType:d},w))}})}})),e}function yn(i){const e=i.value,r=i.key,n=qt(e);return n!=="string"?[new Ze(r,e,`string expected, ${n} found`)]:[]}const Ec={promoteId:function({key:i,value:e}){if(qt(e)==="string")return yn({key:i,value:e});{const r=[];for(const n in e)r.push(...yn({key:`${i}.${n}`,value:e[n]}));return r}}};function Mc(i){const e=i.value,r=i.key,n=i.styleSpec,a=i.style,h=i.validateSpec;if(!e.type)return[new Ze(r,e,'"type" is required')];const d=Yr(e.type);let m;switch(d){case"vector":case"raster":return m=is({key:r,value:e,valueSpec:n[`source_${d.replace("-","_")}`],style:i.style,styleSpec:n,objectElementValidators:Ec,validateSpec:h}),m;case"raster-dem":return m=(function(y){var w;const P=(w=y.sourceName)!==null&&w!==void 0?w:"",I=y.value,C=y.styleSpec,D=C.source_raster_dem,F=y.style;let L=[];const B=qt(I);if(I===void 0)return L;if(B!=="object")return L.push(new Ze("source_raster_dem",I,`object expected, ${B} found`)),L;const U=Yr(I.encoding)==="custom",ee=["redFactor","greenFactor","blueFactor","baseShift"],q=y.value.encoding?`"${y.value.encoding}"`:"Default";for(const H in I)!U&&ee.includes(H)?L.push(new Ze(H,I[H],`In "${P}": "${H}" is only valid when "encoding" is set to "custom". ${q} encoding found`)):D[H]?L=L.concat(y.validateSpec({key:H,value:I[H],valueSpec:D[H],validateSpec:y.validateSpec,style:F,styleSpec:C})):L.push(new Ze(H,I[H],`unknown property "${H}"`));return L})({sourceName:r,value:e,style:i.style,styleSpec:n,validateSpec:h}),m;case"geojson":if(m=is({key:r,value:e,valueSpec:n.source_geojson,style:a,styleSpec:n,validateSpec:h,objectElementValidators:Ec}),e.cluster)for(const y in e.clusterProperties){const[w,P]=e.clusterProperties[y],I=typeof w=="string"?[w,["accumulated"],["get",y]]:w;m.push(..._n({key:`${r}.${y}.map`,value:P,expressionContext:"cluster-map"})),m.push(..._n({key:`${r}.${y}.reduce`,value:I,expressionContext:"cluster-reduce"}))}return m;case"video":return is({key:r,value:e,valueSpec:n.source_video,style:a,validateSpec:h,styleSpec:n});case"image":return is({key:r,value:e,valueSpec:n.source_image,style:a,validateSpec:h,styleSpec:n});case"canvas":return[new Ze(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return $n({key:`${r}.type`,value:e.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]}})}}function na(i){const e=i.value,r=i.styleSpec,n=r.light,a=i.style;let h=[];const d=qt(e);if(e===void 0)return h;if(d!=="object")return h=h.concat([new Ze("light",e,`object expected, ${d} found`)]),h;for(const m in e){const y=m.match(/^(.*)-transition$/);h=h.concat(y&&n[y[1]]&&n[y[1]].transition?i.validateSpec({key:m,value:e[m],valueSpec:r.transition,validateSpec:i.validateSpec,style:a,styleSpec:r}):n[m]?i.validateSpec({key:m,value:e[m],valueSpec:n[m],validateSpec:i.validateSpec,style:a,styleSpec:r}):[new Ze(m,e[m],`unknown property "${m}"`)])}return h}function mh(i){const e=i.value,r=i.styleSpec,n=r.sky,a=i.style,h=qt(e);if(e===void 0)return[];if(h!=="object")return[new Ze("sky",e,`object expected, ${h} found`)];let d=[];for(const m in e)d=d.concat(n[m]?i.validateSpec({key:m,value:e[m],valueSpec:n[m],style:a,styleSpec:r}):[new Ze(m,e[m],`unknown property "${m}"`)]);return d}function Ic(i){const e=i.value,r=i.styleSpec,n=r.terrain,a=i.style;let h=[];const d=qt(e);if(e===void 0)return h;if(d!=="object")return h=h.concat([new Ze("terrain",e,`object expected, ${d} found`)]),h;for(const m in e)h=h.concat(n[m]?i.validateSpec({key:m,value:e[m],valueSpec:n[m],validateSpec:i.validateSpec,style:a,styleSpec:r}):[new Ze(m,e[m],`unknown property "${m}"`)]);return h}function Ac(i){let e=[];const r=i.value,n=i.key;if(Array.isArray(r)){const a=[],h=[];for(const d in r)r[d].id&&a.includes(r[d].id)&&e.push(new Ze(n,r,`all the sprites' ids must be unique, but ${r[d].id} is duplicated`)),a.push(r[d].id),r[d].url&&h.includes(r[d].url)&&e.push(new Ze(n,r,`all the sprites' URLs must be unique, but ${r[d].url} is duplicated`)),h.push(r[d].url),e=e.concat(is({key:`${n}[${d}]`,value:r[d],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:i.validateSpec}));return e}return yn({key:n,value:r})}function gh(i){return!!i&&i.constructor===Object}function Cc(i){return gh(i.value)?[]:[new Ze(i.key,i.value,`object expected, ${qt(i.value)} found`)]}const kc={"*":()=>[],array:sl,boolean:function(i){const e=i.value,r=i.key,n=qt(e);return n!=="boolean"?[new Ze(r,e,`boolean expected, ${n} found`)]:[]},number:ia,color:sa,constants:ch,enum:$n,filter:wo,function:nl,layer:fh,object:is,source:Mc,light:na,sky:mh,terrain:Ic,projection:function(i){const e=i.value,r=i.styleSpec,n=r.projection,a=i.style,h=qt(e);if(e===void 0)return[];if(h!=="object")return[new Ze("projection",e,`object expected, ${h} found`)];let d=[];for(const m in e)d=d.concat(n[m]?i.validateSpec({key:m,value:e[m],valueSpec:n[m],style:a,styleSpec:r}):[new Ze(m,e[m],`unknown property "${m}"`)]);return d},projectionDefinition:function(i){const e=i.key;let r=i.value;r=r instanceof String?r.valueOf():r;const n=qt(r);return n!=="array"||(function(a){return Array.isArray(a)&&a.length===3&&typeof a[0]=="string"&&typeof a[1]=="string"&&typeof a[2]=="number"})(r)||(function(a){return!!["interpolate","step","literal"].includes(a[0])})(r)?["array","string"].includes(n)?[]:[new Ze(e,r,`projection expected, invalid type "${n}" found`)]:[new Ze(e,r,`projection expected, invalid array ${JSON.stringify(r)} found`)]},string:yn,formatted:function(i){return yn(i).length===0?[]:_n(i)},resolvedImage:function(i){return yn(i).length===0?[]:_n(i)},padding:function(i){const e=i.key,r=i.value;if(qt(r)==="array"){if(r.length<1||r.length>4)return[new Ze(e,r,`padding requires 1 to 4 values; ${r.length} values found`)];const n={type:"number"};let a=[];for(let h=0;h<r.length;h++)a=a.concat(i.validateSpec({key:`${e}[${h}]`,value:r[h],validateSpec:i.validateSpec,valueSpec:n}));return a}return ia({key:e,value:r,valueSpec:{}})},numberArray:function(i){const e=i.key,r=i.value;if(qt(r)==="array"){const n={type:"number"};if(r.length<1)return[new Ze(e,r,"array length at least 1 expected, length 0 found")];let a=[];for(let h=0;h<r.length;h++)a=a.concat(i.validateSpec({key:`${e}[${h}]`,value:r[h],validateSpec:i.validateSpec,valueSpec:n}));return a}return ia({key:e,value:r,valueSpec:{}})},colorArray:function(i){const e=i.key,r=i.value;if(qt(r)==="array"){if(r.length<1)return[new Ze(e,r,"array length at least 1 expected, length 0 found")];let n=[];for(let a=0;a<r.length;a++)n=n.concat(sa({key:`${e}[${a}]`,value:r[a]}));return n}return sa({key:e,value:r})},variableAnchorOffsetCollection:function(i){const e=i.key,r=i.value,n=qt(r),a=i.styleSpec;if(n!=="array"||r.length<1||r.length%2!=0)return[new Ze(e,r,"variableAnchorOffsetCollection requires a non-empty array of even length")];let h=[];for(let d=0;d<r.length;d+=2)h=h.concat($n({key:`${e}[${d}]`,value:r[d],valueSpec:a.layout_symbol["text-anchor"]})),h=h.concat(sl({key:`${e}[${d+1}]`,value:r[d+1],valueSpec:{length:2,value:"number"},validateSpec:i.validateSpec,style:i.style,styleSpec:a}));return h},sprite:Ac,state:Cc,fontFaces:function(i){const e=i.key,r=i.value,n=i.validateSpec,a=i.styleSpec,h=i.style;if(!gh(r))return[new Ze(e,r,`object expected, ${qt(r)} found`)];const d=[];for(const m in r){const y=r[m],w=qt(y);if(w==="string")d.push(...yn({key:`${e}.${m}`,value:y}));else if(w==="array"){const P={url:{type:"string",required:!0},"unicode-range":{type:"array",value:"string"}};for(const[I,C]of y.entries())d.push(...is({key:`${e}.${m}[${I}]`,value:C,valueSpec:P,styleSpec:a,style:h,validateSpec:n}))}else d.push(new Ze(`${e}.${m}`,y,`string or array expected, ${w} found`))}return d}};function xn(i){const e=i.value,r=i.valueSpec,n=i.styleSpec;return i.validateSpec=xn,r.expression&&Ka(Yr(e))?nl(i):r.expression&&bo(Vn(e))?_n(i):r.type&&kc[r.type]?kc[r.type](i):is(fi({},i,{valueSpec:r.type?n[r.type]:r}))}function _h(i){const e=i.value,r=i.key,n=yn(i);return n.length||(e.indexOf("{fontstack}")===-1&&n.push(new Ze(r,e,'"glyphs" url must include a "{fontstack}" token')),e.indexOf("{range}")===-1&&n.push(new Ze(r,e,'"glyphs" url must include a "{range}" token'))),n}function ps(i,e=Se){let r=[];return r=r.concat(xn({key:"",value:i,valueSpec:e.$root,styleSpec:e,style:i,validateSpec:xn,objectElementValidators:{glyphs:_h,"*":()=>[]}})),i.constants&&(r=r.concat(ch({key:"constants",value:i.constants}))),yh(r)}function ws(i){return function(e){return i(Object.assign({},e,{validateSpec:xn}))}}function yh(i){return[].concat(i).sort(((e,r)=>e.line-r.line))}function Ts(i){return function(...e){return yh(i.apply(this,e))}}ps.source=Ts(ws(Mc)),ps.sprite=Ts(ws(Ac)),ps.glyphs=Ts(ws(_h)),ps.light=Ts(ws(na)),ps.sky=Ts(ws(mh)),ps.terrain=Ts(ws(Ic)),ps.state=Ts(ws(Cc)),ps.layer=Ts(ws(fh)),ps.filter=Ts(ws(wo)),ps.paintProperty=Ts(ws(dh)),ps.layoutProperty=Ts(ws(ph));const Wd={type:"enum","property-type":"data-constant",expression:{interpolated:!1,parameters:["global-state"]},values:{visible:{},none:{}},transition:!1,default:"visible"};class oa{constructor(e,r){this._globalState=r,this.setValue(e)}evaluate(){var e;return(e=this._literalValue)!==null&&e!==void 0?e:this._compiledValue.evaluate({})}setValue(e){if(e==null||e==="visible"||e==="none")return this._literalValue=e==="none"?"none":"visible",this._compiledValue=void 0,void(this._globalStateRefs=new Set);const r=Qo(e,Wd,this._globalState);if(r.result==="error")throw this._literalValue="visible",this._compiledValue=void 0,new Error(r.value.map((n=>`${n.key}: ${n.message}`)).join(", "));this._literalValue=void 0,this._compiledValue=r.value,this._globalStateRefs=gn(r.value.expression)}getGlobalStateRefs(){return this._globalStateRefs}}const aa=Se,mi=ps,la=mi.light,xh=mi.sky,Xd=mi.paintProperty,Yd=mi.layoutProperty;function To(i,e){let r=!1;if(e&&e.length)for(const n of e)i.fire(new nr(new Error(n.message))),r=!0;return r}class So{constructor(e,r,n){const a=this.cells=[];if(e instanceof ArrayBuffer){this.arrayBuffer=e;const d=new Int32Array(this.arrayBuffer);e=d[0],this.d=(r=d[1])+2*(n=d[2]);for(let y=0;y<this.d*this.d;y++){const w=d[3+y],P=d[3+y+1];a.push(w===P?null:d.subarray(w,P))}const m=d[3+a.length+1];this.keys=d.subarray(d[3+a.length],m),this.bboxes=d.subarray(m),this.insert=this._insertReadonly}else{this.d=r+2*n;for(let d=0;d<this.d*this.d;d++)a.push([]);this.keys=[],this.bboxes=[]}this.n=r,this.extent=e,this.padding=n,this.scale=r/e,this.uid=0;const h=n/r*e;this.min=-h,this.max=e+h}insert(e,r,n,a,h){this._forEachCell(r,n,a,h,this._insertCell,this.uid++,void 0,void 0),this.keys.push(e),this.bboxes.push(r),this.bboxes.push(n),this.bboxes.push(a),this.bboxes.push(h)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(e,r,n,a,h,d){this.cells[h].push(d)}query(e,r,n,a,h){const d=this.min,m=this.max;if(e<=d&&r<=d&&m<=n&&m<=a&&!h)return Array.prototype.slice.call(this.keys);{const y=[];return this._forEachCell(e,r,n,a,this._queryCell,y,{},h),y}}_queryCell(e,r,n,a,h,d,m,y){const w=this.cells[h];if(w!==null){const P=this.keys,I=this.bboxes;for(let C=0;C<w.length;C++){const D=w[C];if(m[D]===void 0){const F=4*D;(y?y(I[F+0],I[F+1],I[F+2],I[F+3]):e<=I[F+2]&&r<=I[F+3]&&n>=I[F+0]&&a>=I[F+1])?(m[D]=!0,d.push(P[D])):m[D]=!1}}}}_forEachCell(e,r,n,a,h,d,m,y){const w=this._convertToCellCoord(e),P=this._convertToCellCoord(r),I=this._convertToCellCoord(n),C=this._convertToCellCoord(a);for(let D=w;D<=I;D++)for(let F=P;F<=C;F++){const L=this.d*F+D;if((!y||y(this._convertFromCellCoord(D),this._convertFromCellCoord(F),this._convertFromCellCoord(D+1),this._convertFromCellCoord(F+1)))&&h.call(this,e,r,n,a,L,d,m,y))return}}_convertFromCellCoord(e){return(e-this.padding)/this.scale}_convertToCellCoord(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const e=this.cells,r=3+this.cells.length+1+1;let n=0;for(let d=0;d<this.cells.length;d++)n+=this.cells[d].length;const a=new Int32Array(r+n+this.keys.length+this.bboxes.length);a[0]=this.extent,a[1]=this.n,a[2]=this.padding;let h=r;for(let d=0;d<e.length;d++){const m=e[d];a[3+d]=h,a.set(m,h),h+=m.length}return a[3+e.length]=h,a.set(this.keys,h),h+=this.keys.length,a[3+e.length+1]=h,a.set(this.bboxes,h),h+=this.bboxes.length,a.buffer}static serialize(e,r){const n=e.toArrayBuffer();return r&&r.push(n),{buffer:n}}static deserialize(e){return new So(e.buffer)}}const Ss={};function ht(i,e,r={}){if(Ss[i])throw new Error(`${i} is already registered.`);Object.defineProperty(e,"_classRegistryKey",{value:i,writeable:!1}),Ss[i]={klass:e,omit:r.omit||[],shallow:r.shallow||[]}}ht("Object",Object),ht("Set",Set),ht("TransferableGridIndex",So),ht("Color",Ut),ht("Error",Error),ht("AJAXError",de),ht("ResolvedImage",rs),ht("StylePropertyFunction",el),ht("StyleExpression",wc,{omit:["_evaluator"]}),ht("ZoomDependentExpression",Tc),ht("ZoomConstantExpression",Qa),ht("CompoundExpression",ds,{omit:["_evaluate"]});for(const i in yo)yo[i]._classRegistryKey||ht(`Expression_${i}`,yo[i]);function ol(i){return i&&typeof ArrayBuffer<"u"&&(i instanceof ArrayBuffer||i.constructor&&i.constructor.name==="ArrayBuffer")}function Dc(i){return i.$name||i.constructor._classRegistryKey}function Po(i){return!(function(e){if(e===null||typeof e!="object")return!1;const r=Dc(e);return!(!r||r==="Object")})(i)&&(i==null||typeof i=="boolean"||typeof i=="number"||typeof i=="string"||i instanceof Boolean||i instanceof Number||i instanceof String||i instanceof Date||i instanceof RegExp||i instanceof Blob||i instanceof Error||ol(i)||js(i)||ArrayBuffer.isView(i)||i instanceof ImageData)}function ca(i,e){if(Po(i))return(ol(i)||js(i))&&e&&e.push(i),ArrayBuffer.isView(i)&&e&&e.push(i.buffer),i instanceof ImageData&&e&&e.push(i.data.buffer),i;if(Array.isArray(i)){const h=[];for(const d of i)h.push(ca(d,e));return h}if(typeof i!="object")throw new Error("can't serialize object of type "+typeof i);const r=Dc(i);if(!r)throw new Error(`can't serialize object of unregistered class ${i.constructor.name}`);if(!Ss[r])throw new Error(`${r} is not registered.`);const{klass:n}=Ss[r],a=n.serialize?n.serialize(i,e):{};if(n.serialize){if(e&&a===e[e.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const h in i){if(!i.hasOwnProperty(h)||Ss[r].omit.indexOf(h)>=0)continue;const d=i[h];a[h]=Ss[r].shallow.indexOf(h)>=0?d:ca(d,e)}i instanceof Error&&(a.message=i.message)}if(a.$name)throw new Error("$name property is reserved for worker serialization logic.");return r!=="Object"&&(a.$name=r),a}function ua(i){if(Po(i))return i;if(Array.isArray(i))return i.map(ua);if(typeof i!="object")throw new Error("can't deserialize object of type "+typeof i);const e=Dc(i)||"Object";if(!Ss[e])throw new Error(`can't deserialize unregistered class ${e}`);const{klass:r}=Ss[e];if(!r)throw new Error(`can't deserialize unregistered class ${e}`);if(r.deserialize)return r.deserialize(i);const n=Object.create(r.prototype);for(const a of Object.keys(i)){if(a==="$name")continue;const h=i[a];n[a]=Ss[e].shallow.indexOf(a)>=0?h:ua(h)}return n}class zc{constructor(){this.first=!0}update(e,r){const n=Math.floor(e);return this.first?(this.first=!1,this.lastIntegerZoom=n,this.lastIntegerZoomTime=0,this.lastZoom=e,this.lastFloorZoom=n,!0):(this.lastFloorZoom>n?(this.lastIntegerZoom=n+1,this.lastIntegerZoomTime=r):this.lastFloorZoom<n&&(this.lastIntegerZoom=n,this.lastIntegerZoomTime=r),e!==this.lastZoom&&(this.lastZoom=e,this.lastFloorZoom=n,!0))}}function ha(i){return/[\u02EA\u02EB\u2E80-\u2FDF\u2FF0-\u303F\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FD-\u30FF\u3105-\u312F\u31A0-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE4F\uFF00-\uFFEF]|\uD81B[\uDFE0-\uDFFF]|[\uD81C-\uD822\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFFF]|\uD82C[\uDC00-\uDEFB]|\uD83C[\uDE00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(i))}function Rc(i){return/[\u02EA\u02EB\u1100-\u11FF\u1400-\u167F\u18B0-\u18F5\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u3007\u3012\u3013\u3020-\u302F\u3031-\u303F\u3041-\u3096\u309D-\u30FB\u30FD-\u30FF\u3105-\u312F\u3131-\u318E\u3190-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE48\uFE50-\uFE57\uFE5F-\uFE62\uFE67-\uFE6F\uFF00-\uFF07\uFF0A-\uFF0C\uFF0E-\uFF19\uFF1F-\uFF3A\uFF3C\uFF3E\uFF40-\uFF5A\uFFE0-\uFFE2\uFFE4-\uFFE7]|\uD802[\uDD80-\uDD9F]|\uD805[\uDD80-\uDDFF]|\uD806[\uDE00-\uDEBF]|\uD811[\uDC00-\uDE7F]|\uD81B[\uDFE0-\uDFE4\uDFF0-\uDFF6]|[\uD81C-\uD822\uD83D\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFF3\uDFF5-\uDFFB\uDFFD\uDFFE]|\uD82C[\uDC00-\uDD22\uDD30-\uDEFB]|\uD833[\uDEC0-\uDFCF]|\uD834[\uDC00-\uDDFF\uDEE0-\uDF7F]|\uD836[\uDC00-\uDEAF]|\uD83C[\uDC00-\uDE00\uDF00-\uDFFF]|\uD83E[\uDD00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(i))}function vh(i){return/\s/u.test(String.fromCodePoint(i))}function Eo(i){for(const e of i)if(Rc(e.codePointAt(0)))return!0;return!1}function Jd(i){for(const e of i)if(!bh(e.codePointAt(0)))return!1;return!0}function al(i){const e=i.map((r=>{try{return new RegExp(`\\p{sc=${r}}`,"u").source}catch{return null}})).filter((r=>r));return new RegExp(e.join("|"),"u")}const ll=al(["Arab","Dupl","Mong","Ougr","Syrc"]);function bh(i){return!ll.test(String.fromCodePoint(i))}function Fc(i){return!(Rc(i)||(e=i,/[\xA7\xA9\xAE\xB1\xBC-\xBE\xD7\xF7\u2016\u2020\u2021\u2030\u2031\u203B\u203C\u2042\u2047-\u2049\u2051\u2100-\u218F\u221E\u2234\u2235\u2300-\u2307\u230C-\u231F\u2324-\u2328\u232B\u237D-\u239A\u23BE-\u23CD\u23CF\u23D1-\u23DB\u23E2-\u2422\u2424-\u24FF\u25A0-\u2619\u2620-\u2767\u2776-\u2793\u2B12-\u2B2F\u2B50-\u2B59\u2BB8-\u2BEB\u3000-\u303F\u30A0-\u30FF\uE000-\uF8FF\uFE30-\uFE6F\uFF00-\uFFEF\uFFFC\uFFFD]|[\uDB80-\uDBFF][\uDC00-\uDFFF]/gim.test(String.fromCodePoint(e))));var e}const wh=al(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function Lc(i){return wh.test(String.fromCodePoint(i))}function Oc(i,e){return!(!e&&Lc(i)||/[\u0900-\u0DFF\u0F00-\u109F\u1780-\u17FF]/gim.test(String.fromCodePoint(i)))}function Th(i){for(const e of i)if(Lc(e.codePointAt(0)))return!0;return!1}const vn=new class{constructor(){this.TIMEOUT=5e3,this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null,this.loadScriptResolve=()=>{}}setState(i){this.pluginStatus=i.pluginStatus,this.pluginURL=i.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(i){if(vn.isParsed())throw new Error("RTL text plugin already registered.");this.applyArabicShaping=i.applyArabicShaping,this.processBidirectionalText=i.processBidirectionalText,this.processStyledBidirectionalText=i.processStyledBidirectionalText,this.loadScriptResolve()}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getRTLTextPluginStatus(){return this.pluginStatus}syncState(i,e){return l(this,void 0,void 0,(function*(){if(this.isParsed())return this.getState();if(i.pluginStatus!=="loading")return this.setState(i),i;const r=i.pluginURL,n=new Promise((h=>{this.loadScriptResolve=h}));e(r);const a=new Promise((h=>setTimeout((()=>h()),this.TIMEOUT)));if(yield Promise.race([n,a]),this.isParsed()){const h={pluginStatus:"loaded",pluginURL:r};return this.setState(h),h}throw this.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${r}`)}))}};class gr{constructor(e,r){this.isSupportedScript=Kd,this.zoom=e,r?(this.now=r.now||0,this.fadeDuration=r.fadeDuration||0,this.zoomHistory=r.zoomHistory||new zc,this.transition=r.transition||{}):(this.now=0,this.fadeDuration=0,this.zoomHistory=new zc,this.transition={})}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const e=this.zoom,r=e-Math.floor(e),n=this.crossFadingFactor();return e>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:r+(1-r)*n}:{fromScale:.5,toScale:1,t:1-(1-n)*r}}}function Kd(i){return(function(e,r){for(const n of e)if(!Oc(n.codePointAt(0),r))return!1;return!0})(i,vn.getRTLTextPluginStatus()==="loaded")}const da="-transition";class cl{constructor(e,r,n){this.property=e,this.value=r,this.expression=(function(a,h,d){if(Ka(a))return new el(a,h);if(bo(a)){const m=Sc(a,h,d);if(m.result==="error")throw new Error(m.value.map((y=>`${y.key}: ${y.message}`)).join(", "));return m.value}{let m=a;return h.type==="color"&&typeof a=="string"?m=Ut.parse(a):h.type!=="padding"||typeof a!="number"&&!Array.isArray(a)?h.type!=="numberArray"||typeof a!="number"&&!Array.isArray(a)?h.type!=="colorArray"||typeof a!="string"&&!Array.isArray(a)?h.type==="variableAnchorOffsetCollection"&&Array.isArray(a)?m=Vi.parse(a):h.type==="projectionDefinition"&&typeof a=="string"&&(m=$i.parse(a)):m=zt.parse(a):m=Or.parse(a):m=Ci.parse(a),{globalStateRefs:new Set,_globalState:null,kind:"constant",evaluate:()=>m}}})(r===void 0?e.specification.default:r,e.specification,n)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}getGlobalStateRefs(){return this.expression.globalStateRefs||new Set}possiblyEvaluate(e,r,n){return this.property.possiblyEvaluate(this,e,r,n)}}class ul{constructor(e,r){this.property=e,this.value=new cl(e,void 0,r)}transitioned(e,r){return new Sh(this.property,this.value,r,Sr({},e.transition,this.transition),e.now)}untransitioned(){return new Sh(this.property,this.value,null,{},0)}}class Bc{constructor(e,r){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._globalState=r}getValue(e){return Zi(this._values[e].value.value)}setValue(e,r){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new ul(this._values[e].property,this._globalState)),this._values[e].value=new cl(this._values[e].property,r===null?void 0:Zi(r),this._globalState)}getTransition(e){return Zi(this._values[e].transition)}setTransition(e,r){Object.prototype.hasOwnProperty.call(this._values,e)||(this._values[e]=new ul(this._values[e].property,this._globalState)),this._values[e].transition=Zi(r)||void 0}serialize(){const e={};for(const r of Object.keys(this._values)){const n=this.getValue(r);n!==void 0&&(e[r]=n);const a=this.getTransition(r);a!==void 0&&(e[`${r}${da}`]=a)}return e}transitioned(e,r){const n=new Ph(this._properties);for(const a of Object.keys(this._values))n._values[a]=this._values[a].transitioned(e,r._values[a]);return n}untransitioned(){const e=new Ph(this._properties);for(const r of Object.keys(this._values))e._values[r]=this._values[r].untransitioned();return e}}class Sh{constructor(e,r,n,a,h){this.property=e,this.value=r,this.begin=h+a.delay||0,this.end=this.begin+a.duration||0,e.specification.transition&&(a.delay||a.duration)&&(this.prior=n)}possiblyEvaluate(e,r,n){const a=e.now||0,h=this.value.possiblyEvaluate(e,r,n),d=this.prior;if(d){if(a>this.end)return this.prior=null,h;if(this.value.isDataDriven())return this.prior=null,h;if(a<this.begin)return d.possiblyEvaluate(e,r,n);{const m=(a-this.begin)/(this.end-this.begin);return this.property.interpolate(d.possiblyEvaluate(e,r,n),h,us(m))}}return h}}class Ph{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,r,n){const a=new pa(this._properties);for(const h of Object.keys(this._values))a._values[h]=this._values[h].possiblyEvaluate(e,r,n);return a}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Eh{constructor(e,r){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._globalState=r}hasValue(e){return this._values[e].value!==void 0}getValue(e){return Zi(this._values[e].value)}setValue(e,r){this._values[e]=new cl(this._values[e].property,r===null?void 0:Zi(r),this._globalState)}serialize(){const e={};for(const r of Object.keys(this._values)){const n=this.getValue(r);n!==void 0&&(e[r]=n)}return e}possiblyEvaluate(e,r,n){const a=new pa(this._properties);for(const h of Object.keys(this._values))a._values[h]=this._values[h].possiblyEvaluate(e,r,n);return a}}class Ps{constructor(e,r,n){this.property=e,this.value=r,this.parameters=n}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,r,n,a){return this.property.evaluate(this.value,this.parameters,e,r,n,a)}}class pa{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class bt{constructor(e){this.specification=e}possiblyEvaluate(e,r){if(e.isDataDriven())throw new Error("Value should not be data driven");return e.expression.evaluate(r)}interpolate(e,r,n){const a=kr[this.specification.type];return a?a(e,r,n):e}}class Et{constructor(e,r){this.specification=e,this.overrides=r}possiblyEvaluate(e,r,n,a){return new Ps(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(r,null,{},n,a)}:e.expression,r)}interpolate(e,r,n){if(e.value.kind!=="constant"||r.value.kind!=="constant")return e;if(e.value.value===void 0||r.value.value===void 0)return new Ps(this,{kind:"constant",value:void 0},e.parameters);const a=kr[this.specification.type];if(a){const h=a(e.value.value,r.value.value,n);return new Ps(this,{kind:"constant",value:h},e.parameters)}return e}evaluate(e,r,n,a,h,d){return e.kind==="constant"?e.value:e.evaluate(r,n,a,h,d)}}class fa extends Et{possiblyEvaluate(e,r,n,a){if(e.value===void 0)return new Ps(this,{kind:"constant",value:void 0},r);if(e.expression.kind==="constant"){const h=e.expression.evaluate(r,null,{},n,a),d=e.property.specification.type==="resolvedImage"&&typeof h!="string"?h.name:h,m=this._calculate(d,d,d,r);return new Ps(this,{kind:"constant",value:m},r)}if(e.expression.kind==="camera"){const h=this._calculate(e.expression.evaluate({zoom:r.zoom-1}),e.expression.evaluate({zoom:r.zoom}),e.expression.evaluate({zoom:r.zoom+1}),r);return new Ps(this,{kind:"constant",value:h},r)}return new Ps(this,e.expression,r)}evaluate(e,r,n,a,h,d){if(e.kind==="source"){const m=e.evaluate(r,n,a,h,d);return this._calculate(m,m,m,r)}return e.kind==="composite"?this._calculate(e.evaluate({zoom:Math.floor(r.zoom)-1},n,a),e.evaluate({zoom:Math.floor(r.zoom)},n,a),e.evaluate({zoom:Math.floor(r.zoom)+1},n,a),r):e.value}_calculate(e,r,n,a){return a.zoom>a.zoomHistory.lastIntegerZoom?{from:e,to:r}:{from:n,to:r}}interpolate(e){return e}}class hl{constructor(e){this.specification=e}possiblyEvaluate(e,r,n,a){if(e.value!==void 0){if(e.expression.kind==="constant"){const h=e.expression.evaluate(r,null,{},n,a);return this._calculate(h,h,h,r)}return this._calculate(e.expression.evaluate(new gr(Math.floor(r.zoom-1),r)),e.expression.evaluate(new gr(Math.floor(r.zoom),r)),e.expression.evaluate(new gr(Math.floor(r.zoom+1),r)),r)}}_calculate(e,r,n,a){return a.zoom>a.zoomHistory.lastIntegerZoom?{from:e,to:r}:{from:n,to:r}}interpolate(e){return e}}class dl{constructor(e){this.specification=e}possiblyEvaluate(e,r,n,a){return!!e.expression.evaluate(r,null,{},n,a)}interpolate(){return!1}}class qi{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const r in e){const n=e[r];n.specification.overridable&&this.overridableProperties.push(r);const a=this.defaultPropertyValues[r]=new cl(n,void 0,void 0),h=this.defaultTransitionablePropertyValues[r]=new ul(n,void 0);this.defaultTransitioningPropertyValues[r]=h.untransitioned(),this.defaultPossiblyEvaluatedValues[r]=a.possiblyEvaluate({})}}}ht("DataDrivenProperty",Et),ht("DataConstantProperty",bt),ht("CrossFadedDataDrivenProperty",fa),ht("CrossFadedProperty",hl),ht("ColorRampProperty",dl);class fs extends er{constructor(e,r,n){if(super(),this.id=e.id,this.type=e.type,this._globalState=n,this._featureFilter={filter:()=>!0,needGeometry:!1,getGlobalStateRefs:()=>new Set},e.type!=="custom"&&(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,this._visibilityExpression=(function(a,h){return new oa(a,h)})(this.visibility,n),e.type!=="background"&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter,this._featureFilter=ea(e.filter,n)),r.layout&&(this._unevaluatedLayout=new Eh(r.layout,n)),r.paint)){this._transitionablePaint=new Bc(r.paint,n);for(const a in e.paint)this.setPaintProperty(a,e.paint[a],{validate:!1});for(const a in e.layout)this.setLayoutProperty(a,e.layout[a],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new pa(r.paint)}}setFilter(e){this.filter=e,this._featureFilter=ea(e,this._globalState)}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}getLayoutAffectingGlobalStateRefs(){const e=new Set;for(const r of this._visibilityExpression.getGlobalStateRefs())e.add(r);if(this._unevaluatedLayout)for(const r in this._unevaluatedLayout._values){const n=this._unevaluatedLayout._values[r];for(const a of n.getGlobalStateRefs())e.add(a)}for(const r of this._featureFilter.getGlobalStateRefs())e.add(r);return e}getPaintAffectingGlobalStateRefs(){var e;const r=new globalThis.Map;if(this._transitionablePaint)for(const n in this._transitionablePaint._values){const a=this._transitionablePaint._values[n].value;for(const h of a.getGlobalStateRefs()){const d=(e=r.get(h))!==null&&e!==void 0?e:[];d.push({name:n,value:a.value}),r.set(h,d)}}return r}getVisibilityAffectingGlobalStateRefs(){return this._visibilityExpression.getGlobalStateRefs()}setLayoutProperty(e,r,n={}){if(r==null||!this._validate(Yd,`layers.${this.id}.layout.${e}`,e,r,n))return e==="visibility"?(this.visibility=r,this._visibilityExpression.setValue(r),void this.recalculateVisibility()):void this._unevaluatedLayout.setValue(e,r)}getPaintProperty(e){return e.endsWith(da)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,r,n={}){if(r!=null&&this._validate(Xd,`layers.${this.id}.paint.${e}`,e,r,n))return!1;if(e.endsWith(da))return this._transitionablePaint.setTransition(e.slice(0,-11),r||void 0),!1;{const a=this._transitionablePaint._values[e],h=a.property.specification["property-type"]==="cross-faded-data-driven",d=a.value.isDataDriven(),m=a.value;this._transitionablePaint.setValue(e,r),this._handleSpecialPaintPropertyUpdate(e);const y=this._transitionablePaint._values[e].value;return y.isDataDriven()||d||h||this._handleOverridablePaintPropertyUpdate(e,m,y)}}_handleSpecialPaintPropertyUpdate(e){}_handleOverridablePaintPropertyUpdate(e,r,n){return!1}isHidden(e=this.minzoom,r=!1){return!!(this.minzoom&&e<(r?Math.floor(this.minzoom):this.minzoom))||!!(this.maxzoom&&e>=this.maxzoom)||this._evaluatedVisibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculateVisibility(){this._evaluatedVisibility=this._visibilityExpression.evaluate()}recalculate(e,r){e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,r)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,r)}serialize(){const e={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(e.layout=e.layout||{},e.layout.visibility=this.visibility),cn(e,((r,n)=>!(r===void 0||n==="layout"&&!Object.keys(r).length||n==="paint"&&!Object.keys(r).length)))}_validate(e,r,n,a,h={}){return(!h||h.validate!==!1)&&To(this,e.call(mi,{key:r,layerType:this.type,objectKey:n,value:a,styleSpec:Se,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const e in this.paint._values){const r=this.paint.get(e);if(r instanceof Ps&&vo(r.property.specification)&&(r.value.kind==="source"||r.value.kind==="composite")&&r.value.isStateDependent)return!0}return!1}}let jc;var Mh={get paint(){return jc=jc||new qi({"raster-opacity":new bt(Se.paint_raster["raster-opacity"]),"raster-hue-rotate":new bt(Se.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new bt(Se.paint_raster["raster-brightness-min"]),"raster-brightness-max":new bt(Se.paint_raster["raster-brightness-max"]),"raster-saturation":new bt(Se.paint_raster["raster-saturation"]),"raster-contrast":new bt(Se.paint_raster["raster-contrast"]),"raster-resampling":new bt(Se.paint_raster["raster-resampling"]),"raster-fade-duration":new bt(Se.paint_raster["raster-fade-duration"])})}};class Qd extends fs{constructor(e,r){super(e,Mh,r)}}const ep={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class ma{constructor(e,r){this._structArray=e,this._pos1=r*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Br{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,r){return e._trim(),r&&(e.isTransferred=!0,r.push(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const r=Object.create(this.prototype);return r.arrayBuffer=e.arrayBuffer,r.length=e.length,r.capacity=e.arrayBuffer.byteLength/r.bytesPerElement,r._refreshViews(),r}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const r=this.uint8;this._refreshViews(),r&&this.uint8.set(r)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function Jr(i,e=1){let r=0,n=0;return{members:i.map((a=>{const h=ep[a.type].BYTES_PER_ELEMENT,d=r=Un(r,Math.max(e,h)),m=a.components||1;return n=Math.max(n,h),r+=h*m,{name:a.name,type:a.type,components:m,offset:d}})),size:Un(r,Math.max(n,e)),alignment:e}}function Un(i,e){return Math.ceil(i/e)*e}class ga extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r){const n=this.length;return this.resize(n+1),this.emplace(n,e,r)}emplace(e,r,n){const a=2*e;return this.int16[a+0]=r,this.int16[a+1]=n,e}}ga.prototype.bytesPerElement=4,ht("StructArrayLayout2i4",ga);class pl extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,r,n)}emplace(e,r,n,a){const h=3*e;return this.int16[h+0]=r,this.int16[h+1]=n,this.int16[h+2]=a,e}}pl.prototype.bytesPerElement=6,ht("StructArrayLayout3i6",pl);class Nc extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,r,n,a)}emplace(e,r,n,a,h){const d=4*e;return this.int16[d+0]=r,this.int16[d+1]=n,this.int16[d+2]=a,this.int16[d+3]=h,e}}Nc.prototype.bytesPerElement=8,ht("StructArrayLayout4i8",Nc);class fl extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,h,d){const m=this.length;return this.resize(m+1),this.emplace(m,e,r,n,a,h,d)}emplace(e,r,n,a,h,d,m){const y=6*e;return this.int16[y+0]=r,this.int16[y+1]=n,this.int16[y+2]=a,this.int16[y+3]=h,this.int16[y+4]=d,this.int16[y+5]=m,e}}fl.prototype.bytesPerElement=12,ht("StructArrayLayout2i4i12",fl);class Vc extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,h,d){const m=this.length;return this.resize(m+1),this.emplace(m,e,r,n,a,h,d)}emplace(e,r,n,a,h,d,m){const y=4*e,w=8*e;return this.int16[y+0]=r,this.int16[y+1]=n,this.uint8[w+4]=a,this.uint8[w+5]=h,this.uint8[w+6]=d,this.uint8[w+7]=m,e}}Vc.prototype.bytesPerElement=8,ht("StructArrayLayout2i4ub8",Vc);class _a extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r){const n=this.length;return this.resize(n+1),this.emplace(n,e,r)}emplace(e,r,n){const a=2*e;return this.float32[a+0]=r,this.float32[a+1]=n,e}}_a.prototype.bytesPerElement=8,ht("StructArrayLayout2f8",_a);class Ys extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,h,d,m,y,w,P){const I=this.length;return this.resize(I+1),this.emplace(I,e,r,n,a,h,d,m,y,w,P)}emplace(e,r,n,a,h,d,m,y,w,P,I){const C=10*e;return this.uint16[C+0]=r,this.uint16[C+1]=n,this.uint16[C+2]=a,this.uint16[C+3]=h,this.uint16[C+4]=d,this.uint16[C+5]=m,this.uint16[C+6]=y,this.uint16[C+7]=w,this.uint16[C+8]=P,this.uint16[C+9]=I,e}}Ys.prototype.bytesPerElement=20,ht("StructArrayLayout10ui20",Ys);class ml extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,h,d,m,y){const w=this.length;return this.resize(w+1),this.emplace(w,e,r,n,a,h,d,m,y)}emplace(e,r,n,a,h,d,m,y,w){const P=8*e;return this.uint16[P+0]=r,this.uint16[P+1]=n,this.uint16[P+2]=a,this.uint16[P+3]=h,this.uint16[P+4]=d,this.uint16[P+5]=m,this.uint16[P+6]=y,this.uint16[P+7]=w,e}}ml.prototype.bytesPerElement=16,ht("StructArrayLayout8ui16",ml);class ya extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,h,d,m,y,w,P,I,C){const D=this.length;return this.resize(D+1),this.emplace(D,e,r,n,a,h,d,m,y,w,P,I,C)}emplace(e,r,n,a,h,d,m,y,w,P,I,C,D){const F=12*e;return this.int16[F+0]=r,this.int16[F+1]=n,this.int16[F+2]=a,this.int16[F+3]=h,this.uint16[F+4]=d,this.uint16[F+5]=m,this.uint16[F+6]=y,this.uint16[F+7]=w,this.int16[F+8]=P,this.int16[F+9]=I,this.int16[F+10]=C,this.int16[F+11]=D,e}}ya.prototype.bytesPerElement=24,ht("StructArrayLayout4i4ui4i24",ya);class gl extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,r,n)}emplace(e,r,n,a){const h=3*e;return this.float32[h+0]=r,this.float32[h+1]=n,this.float32[h+2]=a,e}}gl.prototype.bytesPerElement=12,ht("StructArrayLayout3f12",gl);class xa extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint32[1*e+0]=r,e}}xa.prototype.bytesPerElement=4,ht("StructArrayLayout1ul4",xa);class $c extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,h,d,m,y,w){const P=this.length;return this.resize(P+1),this.emplace(P,e,r,n,a,h,d,m,y,w)}emplace(e,r,n,a,h,d,m,y,w,P){const I=10*e,C=5*e;return this.int16[I+0]=r,this.int16[I+1]=n,this.int16[I+2]=a,this.int16[I+3]=h,this.int16[I+4]=d,this.int16[I+5]=m,this.uint32[C+3]=y,this.uint16[I+8]=w,this.uint16[I+9]=P,e}}$c.prototype.bytesPerElement=20,ht("StructArrayLayout6i1ul2ui20",$c);class Mo extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,h,d){const m=this.length;return this.resize(m+1),this.emplace(m,e,r,n,a,h,d)}emplace(e,r,n,a,h,d,m){const y=6*e;return this.int16[y+0]=r,this.int16[y+1]=n,this.int16[y+2]=a,this.int16[y+3]=h,this.int16[y+4]=d,this.int16[y+5]=m,e}}Mo.prototype.bytesPerElement=12,ht("StructArrayLayout2i2i2i12",Mo);class qn extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,h){const d=this.length;return this.resize(d+1),this.emplace(d,e,r,n,a,h)}emplace(e,r,n,a,h,d){const m=4*e,y=8*e;return this.float32[m+0]=r,this.float32[m+1]=n,this.float32[m+2]=a,this.int16[y+6]=h,this.int16[y+7]=d,e}}qn.prototype.bytesPerElement=16,ht("StructArrayLayout2f1f2i16",qn);class Uc extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,r,n,a,h,d){const m=this.length;return this.resize(m+1),this.emplace(m,e,r,n,a,h,d)}emplace(e,r,n,a,h,d,m){const y=16*e,w=4*e,P=8*e;return this.uint8[y+0]=r,this.uint8[y+1]=n,this.float32[w+1]=a,this.float32[w+2]=h,this.int16[P+6]=d,this.int16[P+7]=m,e}}Uc.prototype.bytesPerElement=16,ht("StructArrayLayout2ub2f2i16",Uc);class va extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,r,n)}emplace(e,r,n,a){const h=3*e;return this.uint16[h+0]=r,this.uint16[h+1]=n,this.uint16[h+2]=a,e}}va.prototype.bytesPerElement=6,ht("StructArrayLayout3ui6",va);class Gn extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a,h,d,m,y,w,P,I,C,D,F,L,B,U){const ee=this.length;return this.resize(ee+1),this.emplace(ee,e,r,n,a,h,d,m,y,w,P,I,C,D,F,L,B,U)}emplace(e,r,n,a,h,d,m,y,w,P,I,C,D,F,L,B,U,ee){const q=24*e,H=12*e,re=48*e;return this.int16[q+0]=r,this.int16[q+1]=n,this.uint16[q+2]=a,this.uint16[q+3]=h,this.uint32[H+2]=d,this.uint32[H+3]=m,this.uint32[H+4]=y,this.uint16[q+10]=w,this.uint16[q+11]=P,this.uint16[q+12]=I,this.float32[H+7]=C,this.float32[H+8]=D,this.uint8[re+36]=F,this.uint8[re+37]=L,this.uint8[re+38]=B,this.uint32[H+10]=U,this.int16[q+22]=ee,e}}Gn.prototype.bytesPerElement=48,ht("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",Gn);class qc extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a,h,d,m,y,w,P,I,C,D,F,L,B,U,ee,q,H,re,ae,be,Le,De,Ne,tt,qe){const Re=this.length;return this.resize(Re+1),this.emplace(Re,e,r,n,a,h,d,m,y,w,P,I,C,D,F,L,B,U,ee,q,H,re,ae,be,Le,De,Ne,tt,qe)}emplace(e,r,n,a,h,d,m,y,w,P,I,C,D,F,L,B,U,ee,q,H,re,ae,be,Le,De,Ne,tt,qe,Re){const Ae=32*e,ut=16*e;return this.int16[Ae+0]=r,this.int16[Ae+1]=n,this.int16[Ae+2]=a,this.int16[Ae+3]=h,this.int16[Ae+4]=d,this.int16[Ae+5]=m,this.int16[Ae+6]=y,this.int16[Ae+7]=w,this.uint16[Ae+8]=P,this.uint16[Ae+9]=I,this.uint16[Ae+10]=C,this.uint16[Ae+11]=D,this.uint16[Ae+12]=F,this.uint16[Ae+13]=L,this.uint16[Ae+14]=B,this.uint16[Ae+15]=U,this.uint16[Ae+16]=ee,this.uint16[Ae+17]=q,this.uint16[Ae+18]=H,this.uint16[Ae+19]=re,this.uint16[Ae+20]=ae,this.uint16[Ae+21]=be,this.uint16[Ae+22]=Le,this.uint32[ut+12]=De,this.float32[ut+13]=Ne,this.float32[ut+14]=tt,this.uint16[Ae+30]=qe,this.uint16[Ae+31]=Re,e}}qc.prototype.bytesPerElement=64,ht("StructArrayLayout8i15ui1ul2f2ui64",qc);class _l extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.float32[1*e+0]=r,e}}_l.prototype.bytesPerElement=4,ht("StructArrayLayout1f4",_l);class yl extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,r,n)}emplace(e,r,n,a){const h=3*e;return this.uint16[6*e+0]=r,this.float32[h+1]=n,this.float32[h+2]=a,e}}yl.prototype.bytesPerElement=12,ht("StructArrayLayout1ui2f12",yl);class Gc extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r,n){const a=this.length;return this.resize(a+1),this.emplace(a,e,r,n)}emplace(e,r,n,a){const h=4*e;return this.uint32[2*e+0]=r,this.uint16[h+2]=n,this.uint16[h+3]=a,e}}Gc.prototype.bytesPerElement=8,ht("StructArrayLayout1ul2ui8",Gc);class p extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,r){const n=this.length;return this.resize(n+1),this.emplace(n,e,r)}emplace(e,r,n){const a=2*e;return this.uint16[a+0]=r,this.uint16[a+1]=n,e}}p.prototype.bytesPerElement=4,ht("StructArrayLayout2ui4",p);class t extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const r=this.length;return this.resize(r+1),this.emplace(r,e)}emplace(e,r){return this.uint16[1*e+0]=r,e}}t.prototype.bytesPerElement=2,ht("StructArrayLayout1ui2",t);class s extends Br{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,r,n,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,r,n,a)}emplace(e,r,n,a,h){const d=4*e;return this.float32[d+0]=r,this.float32[d+1]=n,this.float32[d+2]=a,this.float32[d+3]=h,e}}s.prototype.bytesPerElement=16,ht("StructArrayLayout4f16",s);class o extends ma{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new $(this.anchorPointX,this.anchorPointY)}}o.prototype.size=20;class u extends $c{get(e){return new o(this,e)}}ht("CollisionBoxArray",u);class f extends ma{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(e){this._structArray.uint8[this._pos1+37]=e}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(e){this._structArray.uint8[this._pos1+38]=e}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(e){this._structArray.uint32[this._pos4+10]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}f.prototype.size=48;class _ extends Gn{get(e){return new f(this,e)}}ht("PlacedSymbolArray",_);class b extends ma{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(e){this._structArray.uint32[this._pos4+12]=e}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}b.prototype.size=64;class T extends qc{get(e){return new b(this,e)}}ht("SymbolInstanceArray",T);class M extends _l{getoffsetX(e){return this.float32[1*e+0]}}ht("GlyphOffsetArray",M);class A extends pl{getx(e){return this.int16[3*e+0]}gety(e){return this.int16[3*e+1]}gettileUnitDistanceFromAnchor(e){return this.int16[3*e+2]}}ht("SymbolLineVertexArray",A);class R extends ma{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}R.prototype.size=12;class z extends yl{get(e){return new R(this,e)}}ht("TextAnchorOffsetArray",z);class O extends ma{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}O.prototype.size=8;class V extends Gc{get(e){return new O(this,e)}}ht("FeatureIndexArray",V);class W extends ga{}class Y extends ga{}class X extends ga{}class te extends fl{}class le extends Vc{}class Q extends _a{}class ne extends Ys{}class ue extends ml{}class ie extends ya{}class pe extends gl{}class Ce extends xa{}class Pe extends Mo{}class Me extends Uc{}class Ie extends va{}class Xe extends p{}const Je=Jr([{name:"a_pos",components:2,type:"Int16"}],4),{members:$e}=Je;class it{constructor(e=[]){this._forceNewSegmentOnNextPrepare=!1,this.segments=e}prepareSegment(e,r,n,a){const h=this.segments[this.segments.length-1];return e>it.MAX_VERTEX_ARRAY_LENGTH&&Vr(`Max vertices per segment is ${it.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}. Consider using the \`fillLargeMeshArrays\` function if you require meshes with more than ${it.MAX_VERTEX_ARRAY_LENGTH} vertices.`),this._forceNewSegmentOnNextPrepare||!h||h.vertexLength+e>it.MAX_VERTEX_ARRAY_LENGTH||h.sortKey!==a?this.createNewSegment(r,n,a):h}createNewSegment(e,r,n){const a={vertexOffset:e.length,primitiveOffset:r.length,vertexLength:0,primitiveLength:0,vaos:{}};return n!==void 0&&(a.sortKey=n),this._forceNewSegmentOnNextPrepare=!1,this.segments.push(a),a}getOrCreateLatestSegment(e,r,n){return this.prepareSegment(0,e,r,n)}forceNewSegmentOnNextPrepare(){this._forceNewSegmentOnNextPrepare=!0}get(){return this.segments}destroy(){for(const e of this.segments)for(const r in e.vaos)e.vaos[r].destroy()}static simpleSegment(e,r,n,a){return new it([{vertexOffset:e,primitiveOffset:r,vertexLength:n,primitiveLength:a,vaos:{},sortKey:0}])}}function Ft(i,e){return 256*(i=Bi(Math.floor(i),0,255))+Bi(Math.floor(e),0,255)}it.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,ht("SegmentVector",it);const pr=Jr([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]),Ir=Jr([{name:"a_dasharray_from",components:4,type:"Uint16"},{name:"a_dasharray_to",components:4,type:"Uint16"}]);var vr,Dr,br,qr={exports:{}},zr={exports:{}},gi={exports:{}},si=(function(){if(br)return qr.exports;br=1;var i=(vr||(vr=1,zr.exports=function(r,n){var a,h,d,m,y,w,P,I;for(h=r.length-(a=3&r.length),d=n,y=3432918353,w=461845907,I=0;I<h;)P=255&r.charCodeAt(I)|(255&r.charCodeAt(++I))<<8|(255&r.charCodeAt(++I))<<16|(255&r.charCodeAt(++I))<<24,++I,d=27492+(65535&(m=5*(65535&(d=(d^=P=(65535&(P=(P=(65535&P)*y+(((P>>>16)*y&65535)<<16)&4294967295)<<15|P>>>17))*w+(((P>>>16)*w&65535)<<16)&4294967295)<<13|d>>>19))+((5*(d>>>16)&65535)<<16)&4294967295))+((58964+(m>>>16)&65535)<<16);switch(P=0,a){case 3:P^=(255&r.charCodeAt(I+2))<<16;case 2:P^=(255&r.charCodeAt(I+1))<<8;case 1:d^=P=(65535&(P=(P=(65535&(P^=255&r.charCodeAt(I)))*y+(((P>>>16)*y&65535)<<16)&4294967295)<<15|P>>>17))*w+(((P>>>16)*w&65535)<<16)&4294967295}return d^=r.length,d=2246822507*(65535&(d^=d>>>16))+((2246822507*(d>>>16)&65535)<<16)&4294967295,d=3266489909*(65535&(d^=d>>>13))+((3266489909*(d>>>16)&65535)<<16)&4294967295,(d^=d>>>16)>>>0}),zr.exports),e=(Dr||(Dr=1,gi.exports=function(r,n){for(var a,h=r.length,d=n^h,m=0;h>=4;)a=1540483477*(65535&(a=255&r.charCodeAt(m)|(255&r.charCodeAt(++m))<<8|(255&r.charCodeAt(++m))<<16|(255&r.charCodeAt(++m))<<24))+((1540483477*(a>>>16)&65535)<<16),d=1540483477*(65535&d)+((1540483477*(d>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),h-=4,++m;switch(h){case 3:d^=(255&r.charCodeAt(m+2))<<16;case 2:d^=(255&r.charCodeAt(m+1))<<8;case 1:d=1540483477*(65535&(d^=255&r.charCodeAt(m)))+((1540483477*(d>>>16)&65535)<<16)}return d=1540483477*(65535&(d^=d>>>13))+((1540483477*(d>>>16)&65535)<<16),(d^=d>>>15)>>>0}),gi.exports);return qr.exports=i,qr.exports.murmur3=i,qr.exports.murmur2=e,qr.exports})(),Kr=oe(si);class Ei{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(e,r,n,a){this.ids.push(bn(e)),this.positions.push(r,n,a)}getPositions(e){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const r=bn(e);let n=0,a=this.ids.length-1;for(;n<a;){const d=n+a>>1;this.ids[d]>=r?a=d:n=d+1}const h=[];for(;this.ids[n]===r;)h.push({index:this.positions[3*n],start:this.positions[3*n+1],end:this.positions[3*n+2]}),n++;return h}static serialize(e,r){const n=new Float64Array(e.ids),a=new Uint32Array(e.positions);return Js(n,a,0,n.length-1),r&&r.push(n.buffer,a.buffer),{ids:n,positions:a}}static deserialize(e){const r=new Ei;return r.ids=e.ids,r.positions=e.positions,r.indexed=!0,r}}function bn(i){const e=+i;return!isNaN(e)&&e<=Number.MAX_SAFE_INTEGER?e:Kr(String(i))}function Js(i,e,r,n){for(;r<n;){const a=i[r+n>>1];let h=r-1,d=n+1;for(;;){do h++;while(i[h]<a);do d--;while(i[d]>a);if(h>=d)break;$s(i,h,d),$s(e,3*h,3*d),$s(e,3*h+1,3*d+1),$s(e,3*h+2,3*d+2)}d-r<n-d?(Js(i,e,r,d),r=d+1):(Js(i,e,d+1,n),n=d)}}function $s(i,e,r){const n=i[e];i[e]=i[r],i[r]=n}ht("FeaturePositionMap",Ei);class Qi{constructor(e,r){this.gl=e.gl,this.location=r}}class Zn extends Qi{constructor(e,r){super(e,r),this.current=0}set(e){this.current!==e&&(this.current=e,this.gl.uniform1f(this.location,e))}}class ba extends Qi{constructor(e,r){super(e,r),this.current=[0,0,0,0]}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]&&e[3]===this.current[3]||(this.current=e,this.gl.uniform4f(this.location,e[0],e[1],e[2],e[3]))}}class Hn extends Qi{constructor(e,r){super(e,r),this.current=Ut.transparent}set(e){e.r===this.current.r&&e.g===this.current.g&&e.b===this.current.b&&e.a===this.current.a||(this.current=e,this.gl.uniform4f(this.location,e.r,e.g,e.b,e.a))}}const ms=new Float32Array(16);function Us(i){return[Ft(255*i.r,255*i.g),Ft(255*i.b,255*i.a)]}class Es{constructor(e,r,n){this.value=e,this.uniformNames=r.map((a=>`u_${a}`)),this.type=n}setUniform(e,r,n){e.set(n.constantOr(this.value))}getBinding(e,r,n){return this.type==="color"?new Hn(e,r):new Zn(e,r)}}class Ms{constructor(e,r){this.uniformNames=r.map((n=>`u_${n}`)),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(e,r){this.pixelRatioFrom=r.pixelRatio,this.pixelRatioTo=e.pixelRatio,this.patternFrom=r.tlbr,this.patternTo=e.tlbr}setConstantDashPositions(e,r){this.dashTo=[0,e.y,e.height,e.width],this.dashFrom=[0,r.y,r.height,r.width]}setUniform(e,r,n,a){let h=null;a==="u_pattern_to"?h=this.patternTo:a==="u_pattern_from"?h=this.patternFrom:a==="u_dasharray_to"?h=this.dashTo:a==="u_dasharray_from"?h=this.dashFrom:a==="u_pixel_ratio_to"?h=this.pixelRatioTo:a==="u_pixel_ratio_from"&&(h=this.pixelRatioFrom),h!==null&&e.set(h)}getBinding(e,r,n){return n.substr(0,9)==="u_pattern"||n.substr(0,12)==="u_dasharray_"?new ba(e,r):new Zn(e,r)}}class Pr{constructor(e,r,n,a){this.expression=e,this.type=n,this.maxValue=0,this.paintVertexAttributes=r.map((h=>({name:`a_${h}`,type:"Float32",components:n==="color"?2:1,offset:0}))),this.paintVertexArray=new a}populatePaintArray(e,r,n){const a=this.paintVertexArray.length,h=this.expression.evaluate(new gr(0,n),r,{},n.canonical,[],n.formattedSection);this.paintVertexArray.resize(e),this._setPaintValue(a,e,h)}updatePaintArray(e,r,n,a,h){const d=this.expression.evaluate(new gr(0,h),n,a);this._setPaintValue(e,r,d)}_setPaintValue(e,r,n){if(this.type==="color"){const a=Us(n);for(let h=e;h<r;h++)this.paintVertexArray.emplace(h,a[0],a[1])}else{for(let a=e;a<r;a++)this.paintVertexArray.emplace(a,n);this.maxValue=Math.max(this.maxValue,Math.abs(n))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class wr{constructor(e,r,n,a,h,d){this.expression=e,this.uniformNames=r.map((m=>`u_${m}_t`)),this.type=n,this.useIntegerZoom=a,this.zoom=h,this.maxValue=0,this.paintVertexAttributes=r.map((m=>({name:`a_${m}`,type:"Float32",components:n==="color"?4:2,offset:0}))),this.paintVertexArray=new d}populatePaintArray(e,r,n){const a=this.expression.evaluate(new gr(this.zoom,n),r,{},n.canonical,[],n.formattedSection),h=this.expression.evaluate(new gr(this.zoom+1,n),r,{},n.canonical,[],n.formattedSection),d=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(d,e,a,h)}updatePaintArray(e,r,n,a,h){const d=this.expression.evaluate(new gr(this.zoom,h),n,a),m=this.expression.evaluate(new gr(this.zoom+1,h),n,a);this._setPaintValue(e,r,d,m)}_setPaintValue(e,r,n,a){if(this.type==="color"){const h=Us(n),d=Us(a);for(let m=e;m<r;m++)this.paintVertexArray.emplace(m,h[0],h[1],d[0],d[1])}else{for(let h=e;h<r;h++)this.paintVertexArray.emplace(h,n,a);this.maxValue=Math.max(this.maxValue,Math.abs(n),Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,r){const n=this.useIntegerZoom?Math.floor(r.zoom):r.zoom,a=Bi(this.expression.interpolationFactor(n,this.zoom,this.zoom+1),0,1);e.set(a)}getBinding(e,r,n){return new Zn(e,r)}}class hi{constructor(e,r,n,a,h,d){this.expression=e,this.type=r,this.useIntegerZoom=n,this.zoom=a,this.layerId=d,this.zoomInPaintVertexArray=new h,this.zoomOutPaintVertexArray=new h}populatePaintArray(e,r,n){const a=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(e),this.zoomOutPaintVertexArray.resize(e),this._setPaintValues(a,e,this.getPositionIds(r),n)}updatePaintArray(e,r,n,a,h){this._setPaintValues(e,r,this.getPositionIds(n),h)}_setPaintValues(e,r,n,a){const h=this.getPositions(a);if(!h||!n)return;const d=h[n.min],m=h[n.mid],y=h[n.max];if(d&&m&&y)for(let w=e;w<r;w++)this.emplace(this.zoomInPaintVertexArray,w,m,d),this.emplace(this.zoomOutPaintVertexArray,w,m,y)}upload(e){if(this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer){const r=this.getVertexAttributes();this.zoomInPaintVertexBuffer=e.createVertexBuffer(this.zoomInPaintVertexArray,r,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=e.createVertexBuffer(this.zoomOutPaintVertexArray,r,this.expression.isStateDependent)}}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class di extends hi{getPositions(e){return e.imagePositions}getPositionIds(e){return e.patterns&&e.patterns[this.layerId]}getVertexAttributes(){return pr.members}emplace(e,r,n,a){e.emplace(r,n.tlbr[0],n.tlbr[1],n.tlbr[2],n.tlbr[3],a.tlbr[0],a.tlbr[1],a.tlbr[2],a.tlbr[3],n.pixelRatio,a.pixelRatio)}}class Ih extends hi{getPositions(e){return e.dashPositions}getPositionIds(e){return e.dashes&&e.dashes[this.layerId]}getVertexAttributes(){return Ir.members}emplace(e,r,n,a){e.emplace(r,0,n.y,n.height,n.width,0,a.y,a.height,a.width)}}class Ah{constructor(e,r,n){this.binders={},this._buffers=[];const a=[];for(const h in e.paint._values){if(!n(h))continue;const d=e.paint.get(h);if(!(d instanceof Ps&&vo(d.property.specification)))continue;const m=tp(h,e.type),y=d.value,w=d.property.specification.type,P=d.property.useIntegerZoom,I=d.property.specification["property-type"],C=I==="cross-faded"||I==="cross-faded-data-driven";if(y.kind==="constant")this.binders[h]=C?new Ms(y.value,m):new Es(y.value,m,w),a.push(`/u_${h}`);else if(y.kind==="source"||C){const D=Ch(h,w,"source");this.binders[h]=C?h==="line-dasharray"?new Ih(y,w,P,r,D,e.id):new di(y,w,P,r,D,e.id):new Pr(y,m,w,D),a.push(`/a_${h}`)}else{const D=Ch(h,w,"composite");this.binders[h]=new wr(y,m,w,P,r,D),a.push(`/z_${h}`)}}this.cacheKey=a.sort().join("")}getMaxValue(e){const r=this.binders[e];return r instanceof Pr||r instanceof wr?r.maxValue:0}populatePaintArrays(e,r,n){for(const a in this.binders){const h=this.binders[a];(h instanceof Pr||h instanceof wr||h instanceof hi)&&h.populatePaintArray(e,r,n)}}setConstantPatternPositions(e,r){for(const n in this.binders){const a=this.binders[n];a instanceof Ms&&a.setConstantPatternPositions(e,r)}}setConstantDashPositions(e,r){for(const n in this.binders){const a=this.binders[n];a instanceof Ms&&a.setConstantDashPositions(e,r)}}updatePaintArrays(e,r,n,a,h){let d=!1;for(const m in e){const y=r.getPositions(m);for(const w of y){const P=n.feature(w.index);for(const I in this.binders){const C=this.binders[I];if((C instanceof Pr||C instanceof wr||C instanceof hi)&&C.expression.isStateDependent===!0){const D=a.paint.get(I);C.expression=D.value,C.updatePaintArray(w.start,w.end,P,e[m],h),d=!0}}}}return d}defines(){const e=[];for(const r in this.binders){const n=this.binders[r];(n instanceof Es||n instanceof Ms)&&e.push(...n.uniformNames.map((a=>`#define HAS_UNIFORM_${a}`)))}return e}getBinderAttributes(){const e=[];for(const r in this.binders){const n=this.binders[r];if(n instanceof Pr||n instanceof wr)for(let a=0;a<n.paintVertexAttributes.length;a++)e.push(n.paintVertexAttributes[a].name);else if(n instanceof hi){const a=n.getVertexAttributes();for(const h of a)e.push(h.name)}}return e}getBinderUniforms(){const e=[];for(const r in this.binders){const n=this.binders[r];if(n instanceof Es||n instanceof Ms||n instanceof wr)for(const a of n.uniformNames)e.push(a)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e,r){const n=[];for(const a in this.binders){const h=this.binders[a];if(h instanceof Es||h instanceof Ms||h instanceof wr){for(const d of h.uniformNames)if(r[d]){const m=h.getBinding(e,r[d],d);n.push({name:d,property:a,binding:m})}}}return n}setUniforms(e,r,n,a){for(const{name:h,property:d,binding:m}of r)this.binders[d].setUniform(m,a,n.get(d),h)}updatePaintBuffers(e){this._buffers=[];for(const r in this.binders){const n=this.binders[r];if(e&&n instanceof hi){const a=e.fromScale===2?n.zoomInPaintVertexBuffer:n.zoomOutPaintVertexBuffer;a&&this._buffers.push(a)}else(n instanceof Pr||n instanceof wr)&&n.paintVertexBuffer&&this._buffers.push(n.paintVertexBuffer)}}upload(e){for(const r in this.binders){const n=this.binders[r];(n instanceof Pr||n instanceof wr||n instanceof hi)&&n.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const r=this.binders[e];(r instanceof Pr||r instanceof wr||r instanceof hi)&&r.destroy()}}}class Wn{constructor(e,r,n=()=>!0){this.programConfigurations={};for(const a of e)this.programConfigurations[a.id]=new Ah(a,r,n);this.needsUpload=!1,this._featureMap=new Ei,this._bufferOffset=0}populatePaintArrays(e,r,n,a){for(const h in this.programConfigurations)this.programConfigurations[h].populatePaintArrays(e,r,a);r.id!==void 0&&this._featureMap.add(r.id,n,this._bufferOffset,e),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,r,n,a){for(const h of n)this.needsUpload=this.programConfigurations[h.id].updatePaintArrays(e,this._featureMap,r,h,a)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const r in this.programConfigurations)this.programConfigurations[r].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}function tp(i,e){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-dasharray":["dasharray_to","dasharray_from"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[i]||[i.replace(`${e}-`,"").replace(/-/g,"_")]}function Ch(i,e,r){const n={color:{source:_a,composite:s},number:{source:_l,composite:_a}},a=(function(h){return{"line-pattern":{source:ne,composite:ne},"fill-pattern":{source:ne,composite:ne},"fill-extrusion-pattern":{source:ne,composite:ne},"line-dasharray":{source:ue,composite:ue}}[h]})(i);return a&&a[r]||n[e][r]}ht("ConstantBinder",Es),ht("CrossFadedConstantBinder",Ms),ht("SourceExpressionBinder",Pr),ht("CrossFadedPatternBinder",di),ht("CrossFadedDasharrayBinder",Ih),ht("CompositeExpressionBinder",wr),ht("ProgramConfiguration",Ah,{omit:["_buffers"]}),ht("ProgramConfigurationSet",Wn);const Zc=Math.pow(2,14)-1,wn=-Zc-1;function Tn(i){const e=Ct/i.extent,r=i.loadGeometry();for(let n=0;n<r.length;n++){const a=r[n];for(let h=0;h<a.length;h++){const d=a[h],m=Math.round(d.x*e),y=Math.round(d.y*e);d.x=Bi(m,wn,Zc),d.y=Bi(y,wn,Zc),(m<d.x||m>d.x+1||y<d.y||y>d.y+1)&&Vr("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return r}function Sn(i,e){return{type:i.type,id:i.id,properties:i.properties,geometry:e?Tn(i):[]}}const Hc=-32768;function Wc(i,e,r,n,a){i.emplaceBack(Hc+8*e+n,Hc+8*r+a)}class xl{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((r=>r.id)),this.index=e.index,this.hasDependencies=!1,this.layoutVertexArray=new Y,this.indexArray=new Ie,this.segments=new it,this.programConfigurations=new Wn(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter((r=>r.isStateDependent())).map((r=>r.id))}populate(e,r,n){const a=this.layers[0],h=[];let d=null,m=!1,y=a.type==="heatmap";if(a.type==="circle"){const P=a;d=P.layout.get("circle-sort-key"),m=!d.isConstant(),y=y||P.paint.get("circle-pitch-alignment")==="map"}const w=y?r.subdivisionGranularity.circle:1;for(const{feature:P,id:I,index:C,sourceLayerIndex:D}of e){const F=this.layers[0]._featureFilter.needGeometry,L=Sn(P,F);if(!this.layers[0]._featureFilter.filter(new gr(this.zoom),L,n))continue;const B=m?d.evaluate(L,{},n):void 0,U={id:I,properties:P.properties,type:P.type,sourceLayerIndex:D,index:C,geometry:F?L.geometry:Tn(P),patterns:{},sortKey:B};h.push(U)}m&&h.sort(((P,I)=>P.sortKey-I.sortKey));for(const P of h){const{geometry:I,index:C,sourceLayerIndex:D}=P,F=e[C].feature;this.addFeature(P,I,C,n,w),r.featureIndex.insert(F,I,C,D,this.index)}}update(e,r,n){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,{imagePositions:n})}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,$e),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,r,n,a,h=1){let d;switch(h){case 1:d=[0,7];break;case 3:d=[0,2,5,7];break;case 5:d=[0,1,3,4,6,7];break;case 7:d=[0,1,2,3,4,5,6,7];break;default:throw new Error(`Invalid circle bucket granularity: ${h}; valid values are 1, 3, 5, 7.`)}const m=d.length;for(const y of r)for(const w of y){const P=w.x,I=w.y;if(P<0||P>=Ct||I<0||I>=Ct)continue;const C=this.segments.prepareSegment(m*m,this.layoutVertexArray,this.indexArray,e.sortKey),D=C.vertexLength;for(let F=0;F<m;F++)for(let L=0;L<m;L++)Wc(this.layoutVertexArray,P,I,d[L],d[F]);for(let F=0;F<m-1;F++)for(let L=0;L<m-1;L++){const B=D+F*m+L,U=D+(F+1)*m+L;this.indexArray.emplaceBack(B,U+1,B+1),this.indexArray.emplaceBack(B,U,U+1)}C.vertexLength+=m*m,C.primitiveLength+=(m-1)*(m-1)*2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,{imagePositions:{},canonical:a})}}function vl(i,e){for(let r=0;r<i.length;r++)if(bl(e,i[r]))return!0;for(let r=0;r<e.length;r++)if(bl(i,e[r]))return!0;return!!rp(i,e)}function kh(i,e,r){return!!bl(i,e)||!!ip(e,i,r)}function $f(i,e){if(i.length===1)return qf(e,i[0]);for(let r=0;r<e.length;r++){const n=e[r];for(let a=0;a<n.length;a++)if(bl(i,n[a]))return!0}for(let r=0;r<i.length;r++)if(qf(e,i[r]))return!0;for(let r=0;r<e.length;r++)if(rp(i,e[r]))return!0;return!1}function Sy(i,e,r){if(i.length>1){if(rp(i,e))return!0;for(let n=0;n<e.length;n++)if(ip(e[n],i,r))return!0}for(let n=0;n<i.length;n++)if(ip(i[n],e,r))return!0;return!1}function rp(i,e){if(i.length===0||e.length===0)return!1;for(let r=0;r<i.length-1;r++){const n=i[r],a=i[r+1];for(let h=0;h<e.length-1;h++)if(Py(n,a,e[h],e[h+1]))return!0}return!1}function Py(i,e,r,n){return ji(i,r,n)!==ji(e,r,n)&&ji(i,e,r)!==ji(i,e,n)}function ip(i,e,r){const n=r*r;if(e.length===1)return i.distSqr(e[0])<n;for(let a=1;a<e.length;a++)if(Uf(i,e[a-1],e[a])<n)return!0;return!1}function Uf(i,e,r){const n=e.distSqr(r);if(n===0)return i.distSqr(e);const a=((i.x-e.x)*(r.x-e.x)+(i.y-e.y)*(r.y-e.y))/n;return i.distSqr(a<0?e:a>1?r:r.sub(e)._mult(a)._add(e))}function qf(i,e){let r,n,a,h=!1;for(let d=0;d<i.length;d++){r=i[d];for(let m=0,y=r.length-1;m<r.length;y=m++)n=r[m],a=r[y],n.y>e.y!=a.y>e.y&&e.x<(a.x-n.x)*(e.y-n.y)/(a.y-n.y)+n.x&&(h=!h)}return h}function bl(i,e){let r=!1;for(let n=0,a=i.length-1;n<i.length;a=n++){const h=i[n],d=i[a];h.y>e.y!=d.y>e.y&&e.x<(d.x-h.x)*(e.y-h.y)/(d.y-h.y)+h.x&&(r=!r)}return r}function Ey(i,e,r){const n=r[0],a=r[2];if(i.x<n.x&&e.x<n.x||i.x>a.x&&e.x>a.x||i.y<n.y&&e.y<n.y||i.y>a.y&&e.y>a.y)return!1;const h=ji(i,e,r[0]);return h!==ji(i,e,r[1])||h!==ji(i,e,r[2])||h!==ji(i,e,r[3])}function wl(i,e,r){const n=e.paint.get(i).value;return n.kind==="constant"?n.value:r.programConfigurations.get(e.id).getMaxValue(i)}function Dh(i){return Math.sqrt(i[0]*i[0]+i[1]*i[1])}function zh(i,e,r,n,a){if(!e[0]&&!e[1])return i;const h=$.convert(e)._mult(a);r==="viewport"&&h._rotate(-n);const d=[];for(let m=0;m<i.length;m++)d.push(i[m].sub(h));return d}function My(i){const e=[];for(let r=0;r<i.length;r++){const n=i[r],a=e.at(-1);(r===0||a&&!n.equals(a))&&e.push(n)}return e}function Iy({queryGeometry:i,size:e},r){return kh(i,r,e)}function Ay({queryGeometry:i,size:e,transform:r,unwrappedTileID:n,getElevation:a},h){return kh(i,h,e*(r.projectTileCoordinates(h.x,h.y,n,a).signedDistanceFromCamera/r.cameraToCenterDistance))}function Cy({queryGeometry:i,size:e,transform:r,unwrappedTileID:n,getElevation:a},h){const d=r.projectTileCoordinates(h.x,h.y,n,a).signedDistanceFromCamera,m=e*(r.cameraToCenterDistance/d);return kh(i,sp(h,r,n,a),m)}function ky({queryGeometry:i,size:e,transform:r,unwrappedTileID:n,getElevation:a},h){return kh(i,sp(h,r,n,a),e)}function Gf({queryGeometry:i,size:e,transform:r,unwrappedTileID:n,getElevation:a,pitchAlignment:h="map",pitchScale:d="map"},m){const y=h==="map"?d==="map"?Iy:Ay:d==="map"?Cy:ky,w={queryGeometry:i,size:e,transform:r,unwrappedTileID:n,getElevation:a};for(const P of m)for(const I of P)if(y(w,I))return!0;return!1}function sp(i,e,r,n){const a=e.projectTileCoordinates(i.x,i.y,r,n).point;return new $((.5*a.x+.5)*e.width,(.5*-a.y+.5)*e.height)}let Zf,Hf;ht("CircleBucket",xl,{omit:["layers"]});var Dy={get paint(){return Hf=Hf||new qi({"circle-radius":new Et(Se.paint_circle["circle-radius"]),"circle-color":new Et(Se.paint_circle["circle-color"]),"circle-blur":new Et(Se.paint_circle["circle-blur"]),"circle-opacity":new Et(Se.paint_circle["circle-opacity"]),"circle-translate":new bt(Se.paint_circle["circle-translate"]),"circle-translate-anchor":new bt(Se.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new bt(Se.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new bt(Se.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Et(Se.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Et(Se.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Et(Se.paint_circle["circle-stroke-opacity"])})},get layout(){return Zf=Zf||new qi({"circle-sort-key":new Et(Se.layout_circle["circle-sort-key"])})}};class zy extends fs{constructor(e,r){super(e,Dy,r)}createBucket(e){return new xl(e)}queryRadius(e){const r=e;return wl("circle-radius",this,r)+wl("circle-stroke-width",this,r)+Dh(this.paint.get("circle-translate"))}queryIntersectsFeature({queryGeometry:e,feature:r,featureState:n,geometry:a,transform:h,pixelsToTileUnits:d,unwrappedTileID:m,getElevation:y}){const w=zh(e,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),-h.bearingInRadians,d),P=this.paint.get("circle-radius").evaluate(r,n)+this.paint.get("circle-stroke-width").evaluate(r,n),I=this.paint.get("circle-pitch-scale"),C=this.paint.get("circle-pitch-alignment");let D,F;return C==="map"?(D=w,F=P*d):(D=(function(L,B,U,ee){return L.map((q=>sp(q,B,U,ee)))})(w,h,m,y),F=P),Gf({queryGeometry:D,size:F,transform:h,unwrappedTileID:m,getElevation:y,pitchAlignment:C,pitchScale:I},a)}}class Wf extends xl{}let Xf;ht("HeatmapBucket",Wf,{omit:["layers"]});var Ry={get paint(){return Xf=Xf||new qi({"heatmap-radius":new Et(Se.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Et(Se.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new bt(Se.paint_heatmap["heatmap-intensity"]),"heatmap-color":new dl(Se.paint_heatmap["heatmap-color"]),"heatmap-opacity":new bt(Se.paint_heatmap["heatmap-opacity"])})}};function np(i,{width:e,height:r},n,a){if(a){if(a instanceof Uint8ClampedArray)a=new Uint8Array(a.buffer);else if(a.length!==e*r*n)throw new RangeError(`mismatched image size. expected: ${a.length} but got: ${e*r*n}`)}else a=new Uint8Array(e*r*n);return i.width=e,i.height=r,i.data=a,i}function Yf(i,{width:e,height:r},n){if(e===i.width&&r===i.height)return;const a=np({},{width:e,height:r},n);op(i,a,{x:0,y:0},{x:0,y:0},{width:Math.min(i.width,e),height:Math.min(i.height,r)},n),i.width=e,i.height=r,i.data=a.data}function op(i,e,r,n,a,h){if(a.width===0||a.height===0)return e;if(a.width>i.width||a.height>i.height||r.x>i.width-a.width||r.y>i.height-a.height)throw new RangeError("out of range source coordinates for image copy");if(a.width>e.width||a.height>e.height||n.x>e.width-a.width||n.y>e.height-a.height)throw new RangeError("out of range destination coordinates for image copy");const d=i.data,m=e.data;if(d===m)throw new Error("srcData equals dstData, so image is already copied");for(let y=0;y<a.height;y++){const w=((r.y+y)*i.width+r.x)*h,P=((n.y+y)*e.width+n.x)*h;for(let I=0;I<a.width*h;I++)m[P+I]=d[w+I]}return e}class Xc{constructor(e,r){np(this,e,1,r)}resize(e){Yf(this,e,1)}clone(){return new Xc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,n,a,h){op(e,r,n,a,h,1)}}class ss{constructor(e,r){np(this,e,4,r)}resize(e){Yf(this,e,4)}replace(e,r){r?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new ss({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,r,n,a,h){op(e,r,n,a,h,4)}setPixel(e,r,n){const a=4*(e*this.width+r);this.data[a+0]=Math.round(255*n.r/n.a),this.data[a+1]=Math.round(255*n.g/n.a),this.data[a+2]=Math.round(255*n.b/n.a),this.data[a+3]=Math.round(255*n.a)}}function Jf(i){const e={},r=i.resolution||256,n=i.clips?i.clips.length:1,a=i.image||new ss({width:r,height:n});if(Math.log(r)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${r}`);const h=(d,m,y)=>{e[i.evaluationKey]=y;const w=i.expression.evaluate(e);a.setPixel(d/4/r,m/4,w)};if(i.clips)for(let d=0,m=0;d<n;++d,m+=4*r)for(let y=0,w=0;y<r;y++,w+=4){const P=y/(r-1),{start:I,end:C}=i.clips[d];h(m,w,I*(1-P)+C*P)}else for(let d=0,m=0;d<r;d++,m+=4)h(0,m,d/(r-1));return a}ht("AlphaImage",Xc),ht("RGBAImage",ss);const ap="big-fb";class Fy extends fs{createBucket(e){return new Wf(e)}constructor(e,r){super(e,Ry,r),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){e==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Jf({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(ap)&&this.heatmapFbos.delete(ap)}queryRadius(e){return wl("heatmap-radius",this,e)}queryIntersectsFeature({queryGeometry:e,feature:r,featureState:n,geometry:a,transform:h,pixelsToTileUnits:d,unwrappedTileID:m,getElevation:y}){return Gf({queryGeometry:e,size:this.paint.get("heatmap-radius").evaluate(r,n)*d,transform:h,unwrappedTileID:m,getElevation:y},a)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&!this.isHidden()}}let Kf;var Ly={get paint(){return Kf=Kf||new qi({"hillshade-illumination-direction":new bt(Se.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-altitude":new bt(Se.paint_hillshade["hillshade-illumination-altitude"]),"hillshade-illumination-anchor":new bt(Se.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new bt(Se.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new bt(Se.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new bt(Se.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new bt(Se.paint_hillshade["hillshade-accent-color"]),"hillshade-method":new bt(Se.paint_hillshade["hillshade-method"])})}};class Oy extends fs{constructor(e,r){super(e,Ly,r),this.recalculate({zoom:0,zoomHistory:{}},void 0)}getIlluminationProperties(){let e=this.paint.get("hillshade-illumination-direction").values,r=this.paint.get("hillshade-illumination-altitude").values,n=this.paint.get("hillshade-highlight-color").values,a=this.paint.get("hillshade-shadow-color").values;const h=Math.max(e.length,r.length,n.length,a.length);e=e.concat(Array(h-e.length).fill(e.at(-1))),r=r.concat(Array(h-r.length).fill(r.at(-1))),n=n.concat(Array(h-n.length).fill(n.at(-1))),a=a.concat(Array(h-a.length).fill(a.at(-1)));const d=r.map(Ti);return{directionRadians:e.map(Ti),altitudeRadians:d,shadowColor:a,highlightColor:n}}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&!this.isHidden()}}let Qf;var By={get paint(){return Qf=Qf||new qi({"color-relief-opacity":new bt(Se["paint_color-relief"]["color-relief-opacity"]),"color-relief-color":new dl(Se["paint_color-relief"]["color-relief-color"])})}};class lp{constructor(e,r,n,a){this.context=e,this.format=n,this.texture=e.gl.createTexture(),this.update(r,a)}update(e,r,n){const{width:a,height:h}=e,d=!(this.size&&this.size[0]===a&&this.size[1]===h||n),{context:m}=this,{gl:y}=m;if(this.useMipmap=!!(r&&r.useMipmap),y.bindTexture(y.TEXTURE_2D,this.texture),m.pixelStoreUnpackFlipY.set(!1),m.pixelStoreUnpack.set(1),m.pixelStoreUnpackPremultiplyAlpha.set(this.format===y.RGBA&&(!r||r.premultiply!==!1)),d)this.size=[a,h],e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||js(e)?y.texImage2D(y.TEXTURE_2D,0,this.format,this.format,y.UNSIGNED_BYTE,e):y.texImage2D(y.TEXTURE_2D,0,this.format,a,h,0,this.format,y.UNSIGNED_BYTE,e.data);else{const{x:w,y:P}=n||{x:0,y:0};e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||js(e)?y.texSubImage2D(y.TEXTURE_2D,0,w,P,y.RGBA,y.UNSIGNED_BYTE,e):y.texSubImage2D(y.TEXTURE_2D,0,w,P,a,h,y.RGBA,y.UNSIGNED_BYTE,e.data)}this.useMipmap&&this.isSizePowerOfTwo()&&y.generateMipmap(y.TEXTURE_2D),m.pixelStoreUnpackFlipY.setDefault(),m.pixelStoreUnpack.setDefault(),m.pixelStoreUnpackPremultiplyAlpha.setDefault()}bind(e,r,n){const{context:a}=this,{gl:h}=a;h.bindTexture(h.TEXTURE_2D,this.texture),n!==h.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(n=h.LINEAR),e!==this.filter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,e),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,n||e),this.filter=e),r!==this.wrap&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,r),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,r),this.wrap=r)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class em{constructor(e,r,n,a=1,h=1,d=1,m=0){if(this.uid=e,r.height!==r.width)throw new RangeError("DEM tiles must be square");if(n&&!["mapbox","terrarium","custom"].includes(n))return void Vr(`"${n}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=r.height;const y=this.dim=r.height-2;switch(this.data=new Uint32Array(r.data.buffer),n){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=a,this.greenFactor=h,this.blueFactor=d,this.baseShift=m;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let w=0;w<y;w++)this.data[this._idx(-1,w)]=this.data[this._idx(0,w)],this.data[this._idx(y,w)]=this.data[this._idx(y-1,w)],this.data[this._idx(w,-1)]=this.data[this._idx(w,0)],this.data[this._idx(w,y)]=this.data[this._idx(w,y-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(y,-1)]=this.data[this._idx(y-1,0)],this.data[this._idx(-1,y)]=this.data[this._idx(0,y-1)],this.data[this._idx(y,y)]=this.data[this._idx(y-1,y-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let w=0;w<y;w++)for(let P=0;P<y;P++){const I=this.get(w,P);I>this.max&&(this.max=I),I<this.min&&(this.min=I)}}get(e,r){const n=new Uint8Array(this.data.buffer),a=4*this._idx(e,r);return this.unpack(n[a],n[a+1],n[a+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(e,r){if(e<-1||e>=this.dim+1||r<-1||r>=this.dim+1)throw new RangeError(`Out of range source coordinates for DEM data. x: ${e}, y: ${r}, dim: ${this.dim}`);return(r+1)*this.stride+(e+1)}unpack(e,r,n){return e*this.redFactor+r*this.greenFactor+n*this.blueFactor-this.baseShift}pack(e){return tm(e,this.getUnpackVector())}getPixels(){return new ss({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(e,r,n){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let a=r*this.dim,h=r*this.dim+this.dim,d=n*this.dim,m=n*this.dim+this.dim;switch(r){case-1:a=h-1;break;case 1:h=a+1}switch(n){case-1:d=m-1;break;case 1:m=d+1}const y=-r*this.dim,w=-n*this.dim;for(let P=d;P<m;P++)for(let I=a;I<h;I++)this.data[this._idx(I,P)]=e.data[this._idx(I+y,P+w)]}}function tm(i,e){const r=e[0],n=e[1],a=e[2],h=e[3],d=Math.min(r,n,a),m=Math.round((i+h)/d);return{r:Math.floor(m*d/r)%256,g:Math.floor(m*d/n)%256,b:Math.floor(m*d/a)%256}}ht("DEMData",em);class jy extends fs{constructor(e,r){super(e,By,r)}_createColorRamp(e){const r={elevationStops:[],colorStops:[]},n=this._transitionablePaint._values["color-relief-color"].value.expression;if(n instanceof Qa&&n._styleExpression.expression instanceof Ui){this.colorRampExpression=n;const d=n._styleExpression.expression;r.elevationStops=d.labels,r.colorStops=[];for(const m of r.elevationStops)r.colorStops.push(d.evaluate({globals:{elevation:m}}))}if(r.elevationStops.length<1&&(r.elevationStops=[0],r.colorStops=[Ut.transparent]),r.elevationStops.length<2&&(r.elevationStops.push(r.elevationStops[0]+1),r.colorStops.push(r.colorStops[0])),r.elevationStops.length<=e)return r;const a={elevationStops:[],colorStops:[]},h=(r.elevationStops.length-1)/(e-1);for(let d=0;d<r.elevationStops.length-.5;d+=h)a.elevationStops.push(r.elevationStops[Math.round(d)]),a.colorStops.push(r.colorStops[Math.round(d)]);return Vr(`Too many colors in specification of ${this.id} color-relief layer, may not render properly. Max possible colors: ${e}, provided: ${r.elevationStops.length}`),a}_colorRampChanged(){return this.colorRampExpression!=this._transitionablePaint._values["color-relief-color"].value.expression}getColorRampTextures(e,r,n){if(this.colorRampTextures&&!this._colorRampChanged())return this.colorRampTextures;const a=this._createColorRamp(r),h=new ss({width:a.colorStops.length,height:1}),d=new ss({width:a.colorStops.length,height:1});for(let m=0;m<a.elevationStops.length;m++){const y=tm(a.elevationStops[m],n);d.setPixel(0,m,new Ut(y.r/255,y.g/255,y.b/255,1)),h.setPixel(0,m,a.colorStops[m])}return this.colorRampTextures={elevationTexture:new lp(e,d,e.gl.RGBA),colorTexture:new lp(e,h,e.gl.RGBA)},this.colorRampTextures}hasOffscreenPass(){return!this.isHidden()&&!!this.colorRampTextures}}const Ny=Jr([{name:"a_pos",components:2,type:"Int16"}],4),{members:Vy}=Ny;function Rh(i,e,r){const n=r.patternDependencies;let a=!1;for(const h of e){const d=h.paint.get(`${i}-pattern`);d.isConstant()||(a=!0);const m=d.constantOr(null);m&&(a=!0,n[m.to]=!0,n[m.from]=!0)}return a}function cp(i,e,r,n,a){const{zoom:h}=n,d=a.patternDependencies;for(const m of e){const y=m.paint.get(`${i}-pattern`).value;if(y.kind!=="constant"){let w=y.evaluate({zoom:h-1},r,{},a.availableImages),P=y.evaluate({zoom:h},r,{},a.availableImages),I=y.evaluate({zoom:h+1},r,{},a.availableImages);w=w&&w.name?w.name:w,P=P&&P.name?P.name:P,I=I&&I.name?I.name:I,d[w]=!0,d[P]=!0,d[I]=!0,r.patterns[m.id]={min:w,mid:P,max:I}}}return r}function rm(i,e,r,n,a){let h;if(a===(function(d,m,y,w){let P=0;for(let I=m,C=y-w;I<y;I+=w)P+=(d[C]-d[I])*(d[I+1]+d[C+1]),C=I;return P})(i,e,r,n)>0)for(let d=e;d<r;d+=n)h=om(d/n|0,i[d],i[d+1],h);else for(let d=r-n;d>=e;d-=n)h=om(d/n|0,i[d],i[d+1],h);return h&&Tl(h,h.next)&&(Qc(h),h=h.next),h}function wa(i,e){if(!i)return i;e||(e=i);let r,n=i;do if(r=!1,n.steiner||!Tl(n,n.next)&&ni(n.prev,n,n.next)!==0)n=n.next;else{if(Qc(n),n=e=n.prev,n===n.next)break;r=!0}while(r||n!==e);return e}function Yc(i,e,r,n,a,h,d){if(!i)return;!d&&h&&(function(y,w,P,I){let C=y;do C.z===0&&(C.z=up(C.x,C.y,w,P,I)),C.prevZ=C.prev,C.nextZ=C.next,C=C.next;while(C!==y);C.prevZ.nextZ=null,C.prevZ=null,(function(D){let F,L=1;do{let B,U=D;D=null;let ee=null;for(F=0;U;){F++;let q=U,H=0;for(let ae=0;ae<L&&(H++,q=q.nextZ,q);ae++);let re=L;for(;H>0||re>0&&q;)H!==0&&(re===0||!q||U.z<=q.z)?(B=U,U=U.nextZ,H--):(B=q,q=q.nextZ,re--),ee?ee.nextZ=B:D=B,B.prevZ=ee,ee=B;U=q}ee.nextZ=null,L*=2}while(F>1)})(C)})(i,n,a,h);let m=i;for(;i.prev!==i.next;){const y=i.prev,w=i.next;if(h?Uy(i,n,a,h):$y(i))e.push(y.i,i.i,w.i),Qc(i),i=w.next,m=w.next;else if((i=w)===m){d?d===1?Yc(i=qy(wa(i),e),e,r,n,a,h,2):d===2&&Gy(i,e,r,n,a,h):Yc(wa(i),e,r,n,a,h,1);break}}}function $y(i){const e=i.prev,r=i,n=i.next;if(ni(e,r,n)>=0)return!1;const a=e.x,h=r.x,d=n.x,m=e.y,y=r.y,w=n.y,P=Math.min(a,h,d),I=Math.min(m,y,w),C=Math.max(a,h,d),D=Math.max(m,y,w);let F=n.next;for(;F!==e;){if(F.x>=P&&F.x<=C&&F.y>=I&&F.y<=D&&Jc(a,m,h,y,d,w,F.x,F.y)&&ni(F.prev,F,F.next)>=0)return!1;F=F.next}return!0}function Uy(i,e,r,n){const a=i.prev,h=i,d=i.next;if(ni(a,h,d)>=0)return!1;const m=a.x,y=h.x,w=d.x,P=a.y,I=h.y,C=d.y,D=Math.min(m,y,w),F=Math.min(P,I,C),L=Math.max(m,y,w),B=Math.max(P,I,C),U=up(D,F,e,r,n),ee=up(L,B,e,r,n);let q=i.prevZ,H=i.nextZ;for(;q&&q.z>=U&&H&&H.z<=ee;){if(q.x>=D&&q.x<=L&&q.y>=F&&q.y<=B&&q!==a&&q!==d&&Jc(m,P,y,I,w,C,q.x,q.y)&&ni(q.prev,q,q.next)>=0||(q=q.prevZ,H.x>=D&&H.x<=L&&H.y>=F&&H.y<=B&&H!==a&&H!==d&&Jc(m,P,y,I,w,C,H.x,H.y)&&ni(H.prev,H,H.next)>=0))return!1;H=H.nextZ}for(;q&&q.z>=U;){if(q.x>=D&&q.x<=L&&q.y>=F&&q.y<=B&&q!==a&&q!==d&&Jc(m,P,y,I,w,C,q.x,q.y)&&ni(q.prev,q,q.next)>=0)return!1;q=q.prevZ}for(;H&&H.z<=ee;){if(H.x>=D&&H.x<=L&&H.y>=F&&H.y<=B&&H!==a&&H!==d&&Jc(m,P,y,I,w,C,H.x,H.y)&&ni(H.prev,H,H.next)>=0)return!1;H=H.nextZ}return!0}function qy(i,e){let r=i;do{const n=r.prev,a=r.next.next;!Tl(n,a)&&sm(n,r,r.next,a)&&Kc(n,a)&&Kc(a,n)&&(e.push(n.i,r.i,a.i),Qc(r),Qc(r.next),r=i=a),r=r.next}while(r!==i);return wa(r)}function Gy(i,e,r,n,a,h){let d=i;do{let m=d.next.next;for(;m!==d.prev;){if(d.i!==m.i&&Yy(d,m)){let y=nm(d,m);return d=wa(d,d.next),y=wa(y,y.next),Yc(d,e,r,n,a,h,0),void Yc(y,e,r,n,a,h,0)}m=m.next}d=d.next}while(d!==i)}function Zy(i,e){let r=i.x-e.x;return r===0&&(r=i.y-e.y,r===0)&&(r=(i.next.y-i.y)/(i.next.x-i.x)-(e.next.y-e.y)/(e.next.x-e.x)),r}function Hy(i,e){const r=(function(a,h){let d=h;const m=a.x,y=a.y;let w,P=-1/0;if(Tl(a,d))return d;do{if(Tl(a,d.next))return d.next;if(y<=d.y&&y>=d.next.y&&d.next.y!==d.y){const L=d.x+(y-d.y)*(d.next.x-d.x)/(d.next.y-d.y);if(L<=m&&L>P&&(P=L,w=d.x<d.next.x?d:d.next,L===m))return w}d=d.next}while(d!==h);if(!w)return null;const I=w,C=w.x,D=w.y;let F=1/0;d=w;do{if(m>=d.x&&d.x>=C&&m!==d.x&&im(y<D?m:P,y,C,D,y<D?P:m,y,d.x,d.y)){const L=Math.abs(y-d.y)/(m-d.x);Kc(d,a)&&(L<F||L===F&&(d.x>w.x||d.x===w.x&&Wy(w,d)))&&(w=d,F=L)}d=d.next}while(d!==I);return w})(i,e);if(!r)return e;const n=nm(r,i);return wa(n,n.next),wa(r,r.next)}function Wy(i,e){return ni(i.prev,i,e.prev)<0&&ni(e.next,i,i.next)<0}function up(i,e,r,n,a){return(i=1431655765&((i=858993459&((i=252645135&((i=16711935&((i=(i-r)*a|0)|i<<8))|i<<4))|i<<2))|i<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*a|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Xy(i){let e=i,r=i;do(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next;while(e!==i);return r}function im(i,e,r,n,a,h,d,m){return(a-d)*(e-m)>=(i-d)*(h-m)&&(i-d)*(n-m)>=(r-d)*(e-m)&&(r-d)*(h-m)>=(a-d)*(n-m)}function Jc(i,e,r,n,a,h,d,m){return!(i===d&&e===m)&&im(i,e,r,n,a,h,d,m)}function Yy(i,e){return i.next.i!==e.i&&i.prev.i!==e.i&&!(function(r,n){let a=r;do{if(a.i!==r.i&&a.next.i!==r.i&&a.i!==n.i&&a.next.i!==n.i&&sm(a,a.next,r,n))return!0;a=a.next}while(a!==r);return!1})(i,e)&&(Kc(i,e)&&Kc(e,i)&&(function(r,n){let a=r,h=!1;const d=(r.x+n.x)/2,m=(r.y+n.y)/2;do a.y>m!=a.next.y>m&&a.next.y!==a.y&&d<(a.next.x-a.x)*(m-a.y)/(a.next.y-a.y)+a.x&&(h=!h),a=a.next;while(a!==r);return h})(i,e)&&(ni(i.prev,i,e.prev)||ni(i,e.prev,e))||Tl(i,e)&&ni(i.prev,i,i.next)>0&&ni(e.prev,e,e.next)>0)}function ni(i,e,r){return(e.y-i.y)*(r.x-e.x)-(e.x-i.x)*(r.y-e.y)}function Tl(i,e){return i.x===e.x&&i.y===e.y}function sm(i,e,r,n){const a=Lh(ni(i,e,r)),h=Lh(ni(i,e,n)),d=Lh(ni(r,n,i)),m=Lh(ni(r,n,e));return a!==h&&d!==m||!(a!==0||!Fh(i,r,e))||!(h!==0||!Fh(i,n,e))||!(d!==0||!Fh(r,i,n))||!(m!==0||!Fh(r,e,n))}function Fh(i,e,r){return e.x<=Math.max(i.x,r.x)&&e.x>=Math.min(i.x,r.x)&&e.y<=Math.max(i.y,r.y)&&e.y>=Math.min(i.y,r.y)}function Lh(i){return i>0?1:i<0?-1:0}function Kc(i,e){return ni(i.prev,i,i.next)<0?ni(i,e,i.next)>=0&&ni(i,i.prev,e)>=0:ni(i,e,i.prev)<0||ni(i,i.next,e)<0}function nm(i,e){const r=hp(i.i,i.x,i.y),n=hp(e.i,e.x,e.y),a=i.next,h=e.prev;return i.next=e,e.prev=i,r.next=a,a.prev=r,n.next=r,r.prev=n,h.next=n,n.prev=h,n}function om(i,e,r,n){const a=hp(i,e,r);return n?(a.next=n.next,a.prev=n,n.next.prev=a,n.next=a):(a.prev=a,a.next=a),a}function Qc(i){i.next.prev=i.prev,i.prev.next=i.next,i.prevZ&&(i.prevZ.nextZ=i.nextZ),i.nextZ&&(i.nextZ.prevZ=i.prevZ)}function hp(i,e,r){return{i,x:e,y:r,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class Sl{constructor(e,r){if(r>e)throw new Error("Min granularity must not be greater than base granularity.");this._baseZoomGranularity=e,this._minGranularity=r}getGranularityForZoomLevel(e){return Math.max(Math.floor(this._baseZoomGranularity/(1<<e)),this._minGranularity,1)}}class Oh{constructor(e){this.fill=e.fill,this.line=e.line,this.tile=e.tile,this.stencil=e.stencil,this.circle=e.circle}}Oh.noSubdivision=new Oh({fill:new Sl(0,0),line:new Sl(0,0),tile:new Sl(0,0),stencil:new Sl(0,0),circle:1}),ht("SubdivisionGranularityExpression",Sl),ht("SubdivisionGranularitySetting",Oh);const Pl=-32768,eu=32767;class Jy{constructor(e,r){this._vertexBuffer=[],this._vertexDictionary=new Map,this._used=!1,this._granularity=e,this._granularityCellSize=Ct/e,this._canonical=r}_getKey(e,r){return(e+=32768)<<16|r+32768}_vertexToIndex(e,r){if(e<-32768||r<-32768||e>32767||r>32767)throw new Error("Vertex coordinates are out of signed 16 bit integer range.");const n=0|Math.round(e),a=0|Math.round(r),h=this._getKey(n,a);if(this._vertexDictionary.has(h))return this._vertexDictionary.get(h);const d=this._vertexBuffer.length/2;return this._vertexDictionary.set(h,d),this._vertexBuffer.push(n,a),d}_subdivideTrianglesScanline(e){if(this._granularity<2)return(function(a,h){const d=[];for(let m=0;m<h.length;m+=3){const y=h[m],w=h[m+1],P=h[m+2],I=a[2*y],C=a[2*y+1];(a[2*w]-I)*(a[2*P+1]-C)-(a[2*w+1]-C)*(a[2*P]-I)>0?(d.push(y),d.push(P),d.push(w)):(d.push(y),d.push(w),d.push(P))}return d})(this._vertexBuffer,e);const r=[],n=e.length;for(let a=0;a<n;a+=3){const h=[e[a+0],e[a+1],e[a+2]],d=[this._vertexBuffer[2*e[a+0]+0],this._vertexBuffer[2*e[a+0]+1],this._vertexBuffer[2*e[a+1]+0],this._vertexBuffer[2*e[a+1]+1],this._vertexBuffer[2*e[a+2]+0],this._vertexBuffer[2*e[a+2]+1]];let m=1/0,y=1/0,w=-1/0,P=-1/0;for(let L=0;L<3;L++){const B=d[2*L],U=d[2*L+1];m=Math.min(m,B),w=Math.max(w,B),y=Math.min(y,U),P=Math.max(P,U)}if(m===w||y===P)continue;const I=Math.floor(m/this._granularityCellSize),C=Math.ceil(w/this._granularityCellSize),D=Math.floor(y/this._granularityCellSize),F=Math.ceil(P/this._granularityCellSize);if(I!==C||D!==F)for(let L=D;L<F;L++){const B=this._scanlineGenerateVertexRingForCellRow(L,d,h);Ky(this._vertexBuffer,B,r)}else r.push(...h)}return r}_scanlineGenerateVertexRingForCellRow(e,r,n){const a=e*this._granularityCellSize,h=a+this._granularityCellSize,d=[];for(let m=0;m<3;m++){const y=r[2*m],w=r[2*m+1],P=r[2*(m+1)%6],I=r[(2*(m+1)+1)%6],C=r[2*(m+2)%6],D=r[(2*(m+2)+1)%6],F=P-y,L=I-w,B=F===0,U=L===0,ee=(a-w)/L,q=(h-w)/L,H=Math.min(ee,q),re=Math.max(ee,q);if(!U&&(H>=1||re<=0)||U&&(w<a||w>h)){I>=a&&I<=h&&d.push(n[(m+1)%3]);continue}!U&&H>0&&d.push(this._vertexToIndex(y+F*H,w+L*H));const ae=y+F*Math.max(H,0),be=y+F*Math.min(re,1);B||this._generateIntraEdgeVertices(d,y,w,P,I,ae,be),!U&&re<1&&d.push(this._vertexToIndex(y+F*re,w+L*re)),(U||I>=a&&I<=h)&&d.push(n[(m+1)%3]),!U&&(I<=a||I>=h)&&this._generateInterEdgeVertices(d,y,w,P,I,C,D,be,a,h)}return d}_generateIntraEdgeVertices(e,r,n,a,h,d,m){const y=a-r,w=h-n,P=w===0,I=P?Math.min(r,a):Math.min(d,m),C=P?Math.max(r,a):Math.max(d,m),D=Math.floor(I/this._granularityCellSize)+1,F=Math.ceil(C/this._granularityCellSize)-1;if(P?r<a:d<m)for(let L=D;L<=F;L++){const B=L*this._granularityCellSize;e.push(this._vertexToIndex(B,n+w*(B-r)/y))}else for(let L=F;L>=D;L--){const B=L*this._granularityCellSize;e.push(this._vertexToIndex(B,n+w*(B-r)/y))}}_generateInterEdgeVertices(e,r,n,a,h,d,m,y,w,P){const I=h-n,C=d-a,D=m-h,F=(w-h)/D,L=(P-h)/D,B=Math.min(F,L),U=Math.max(F,L),ee=a+C*B;let q=Math.floor(Math.min(ee,y)/this._granularityCellSize)+1,H=Math.ceil(Math.max(ee,y)/this._granularityCellSize)-1,re=y<ee;const ae=D===0;if(ae&&(m===w||m===P))return;if(ae||B>=1||U<=0){const Le=n-m,De=d+(r-d)*Math.min((w-m)/Le,(P-m)/Le);q=Math.floor(Math.min(De,y)/this._granularityCellSize)+1,H=Math.ceil(Math.max(De,y)/this._granularityCellSize)-1,re=y<De}const be=I>0?P:w;if(re)for(let Le=q;Le<=H;Le++)e.push(this._vertexToIndex(Le*this._granularityCellSize,be));else for(let Le=H;Le>=q;Le--)e.push(this._vertexToIndex(Le*this._granularityCellSize,be))}_generateOutline(e){const r=[];for(const n of e){const a=Ta(n,this._granularity,!0),h=this._pointArrayToIndices(a),d=[];for(let m=1;m<h.length;m++)d.push(h[m-1]),d.push(h[m]);r.push(d)}return r}_handlePoles(e){let r=!1,n=!1;this._canonical&&(this._canonical.y===0&&(r=!0),this._canonical.y===(1<<this._canonical.z)-1&&(n=!0)),(r||n)&&this._fillPoles(e,r,n)}_ensureNoPoleVertices(){const e=this._vertexBuffer;for(let r=0;r<e.length;r+=2){const n=e[r+1];n===Pl&&(e[r+1]=-32767),n===eu&&(e[r+1]=32766)}}_generatePoleQuad(e,r,n,a,h,d){a>h!=(d===Pl)?(e.push(r),e.push(n),e.push(this._vertexToIndex(a,d)),e.push(n),e.push(this._vertexToIndex(h,d)),e.push(this._vertexToIndex(a,d))):(e.push(n),e.push(r),e.push(this._vertexToIndex(a,d)),e.push(this._vertexToIndex(h,d)),e.push(n),e.push(this._vertexToIndex(a,d)))}_fillPoles(e,r,n){const a=this._vertexBuffer,h=Ct,d=e.length;for(let m=2;m<d;m+=3){const y=e[m-2],w=e[m-1],P=e[m],I=a[2*y],C=a[2*y+1],D=a[2*w],F=a[2*w+1],L=a[2*P],B=a[2*P+1];r&&(C===0&&F===0&&this._generatePoleQuad(e,y,w,I,D,Pl),F===0&&B===0&&this._generatePoleQuad(e,w,P,D,L,Pl),B===0&&C===0&&this._generatePoleQuad(e,P,y,L,I,Pl)),n&&(C===h&&F===h&&this._generatePoleQuad(e,y,w,I,D,eu),F===h&&B===h&&this._generatePoleQuad(e,w,P,D,L,eu),B===h&&C===h&&this._generatePoleQuad(e,P,y,L,I,eu))}}_initializeVertices(e){for(let r=0;r<e.length;r+=2)this._vertexToIndex(e[r],e[r+1])}subdividePolygonInternal(e,r){if(this._used)throw new Error("Subdivision: multiple use not allowed.");this._used=!0;const{flattened:n,holeIndices:a}=(function(m){const y=[],w=[];for(const P of m)if(P.length!==0){P!==m[0]&&y.push(w.length/2);for(let I=0;I<P.length;I++)w.push(P[I].x),w.push(P[I].y)}return{flattened:w,holeIndices:y}})(e);let h;this._initializeVertices(n);try{const m=(function(w,P,I=2){const C=P&&P.length,D=C?P[0]*I:w.length;let F=rm(w,0,D,I,!0);const L=[];if(!F||F.next===F.prev)return L;let B,U,ee;if(C&&(F=(function(q,H,re,ae){const be=[];for(let Le=0,De=H.length;Le<De;Le++){const Ne=rm(q,H[Le]*ae,Le<De-1?H[Le+1]*ae:q.length,ae,!1);Ne===Ne.next&&(Ne.steiner=!0),be.push(Xy(Ne))}be.sort(Zy);for(let Le=0;Le<be.length;Le++)re=Hy(be[Le],re);return re})(w,P,F,I)),w.length>80*I){B=w[0],U=w[1];let q=B,H=U;for(let re=I;re<D;re+=I){const ae=w[re],be=w[re+1];ae<B&&(B=ae),be<U&&(U=be),ae>q&&(q=ae),be>H&&(H=be)}ee=Math.max(q-B,H-U),ee=ee!==0?32767/ee:0}return Yc(F,L,I,B,U,ee,0),L})(n,a),y=this._convertIndices(n,m);h=this._subdivideTrianglesScanline(y)}catch(m){console.error(m)}let d=[];return r&&(d=this._generateOutline(e)),this._ensureNoPoleVertices(),this._handlePoles(h),{verticesFlattened:this._vertexBuffer,indicesTriangles:h,indicesLineList:d}}_convertIndices(e,r){const n=[];for(let a=0;a<r.length;a++)n.push(this._vertexToIndex(e[2*r[a]],e[2*r[a]+1]));return n}_pointArrayToIndices(e){const r=[];for(let n=0;n<e.length;n++){const a=e[n];r.push(this._vertexToIndex(a.x,a.y))}return r}}function am(i,e,r,n=!0){return new Jy(r,e).subdividePolygonInternal(i,n)}function Ta(i,e,r=!1){if(!i||i.length<1)return[];if(i.length<2)return[];const n=i[0],a=i[i.length-1],h=r&&(n.x!==a.x||n.y!==a.y);if(e<2)return h?[...i,i[0]]:[...i];const d=Math.floor(Ct/e),m=[];m.push(new $(i[0].x,i[0].y));const y=i.length,w=h?y:y-1;for(let P=0;P<w;P++){const I=i[P],C=P<y-1?i[P+1]:i[0],D=I.x,F=I.y,L=C.x,B=C.y,U=D!==L,ee=F!==B;if(!U&&!ee)continue;const q=L-D,H=B-F,re=Math.abs(q),ae=Math.abs(H);let be=D,Le=F;for(;;){const Ne=q>0?(Math.floor(be/d)+1)*d:(Math.ceil(be/d)-1)*d,tt=H>0?(Math.floor(Le/d)+1)*d:(Math.ceil(Le/d)-1)*d,qe=Math.abs(be-Ne),Re=Math.abs(Le-tt),Ae=Math.abs(be-L),ut=Math.abs(Le-B),lt=U?qe/re:Number.POSITIVE_INFINITY,dt=ee?Re/ae:Number.POSITIVE_INFINITY;if((Ae<=qe||!U)&&(ut<=Re||!ee))break;if(lt<dt&&U||!ee){be=Ne,Le+=H*lt;const nt=new $(be,Math.round(Le));m[m.length-1].x===nt.x&&m[m.length-1].y===nt.y||m.push(nt)}else{be+=q*dt,Le=tt;const nt=new $(Math.round(be),Le);m[m.length-1].x===nt.x&&m[m.length-1].y===nt.y||m.push(nt)}}const De=new $(L,B);m[m.length-1].x===De.x&&m[m.length-1].y===De.y||m.push(De)}return m}function Ky(i,e,r){if(e.length===0)throw new Error("Subdivision vertex ring is empty.");let n=0,a=i[2*e[0]];for(let y=1;y<e.length;y++){const w=i[2*e[y]];w<a&&(a=w,n=y)}const h=e.length;let d=n,m=(d+1)%h;for(;;){const y=d-1>=0?d-1:h-1,w=(m+1)%h,P=i[2*e[y]],I=i[2*e[w]],C=i[2*e[d]],D=i[2*e[d]+1],F=i[2*e[m]+1];let L=!1;if(P<I)L=!0;else if(P>I)L=!1;else{const B=F-D,U=-(i[2*e[m]]-C),ee=D<F?1:-1;((P-C)*B+(i[2*e[y]+1]-D)*U)*ee>((I-C)*B+(i[2*e[w]+1]-D)*U)*ee&&(L=!0)}if(L){const B=e[y],U=e[d],ee=e[m];B!==U&&B!==ee&&U!==ee&&r.push(ee,U,B),d--,d<0&&(d=h-1)}else{const B=e[w],U=e[d],ee=e[m];B!==U&&B!==ee&&U!==ee&&r.push(ee,U,B),m++,m>=h&&(m=0)}if(y===w)break}}function lm(i,e,r,n,a,h,d,m,y){const w=a.length/2,P=d&&m&&y;if(w<it.MAX_VERTEX_ARRAY_LENGTH){const I=e.prepareSegment(w,r,n),C=I.vertexLength;for(let L=0;L<h.length;L+=3)n.emplaceBack(C+h[L],C+h[L+1],C+h[L+2]);let D,F;I.vertexLength+=w,I.primitiveLength+=h.length/3,P&&(F=d.prepareSegment(w,r,m),D=F.vertexLength,F.vertexLength+=w);for(let L=0;L<a.length;L+=2)i(a[L],a[L+1]);if(P)for(let L=0;L<y.length;L++){const B=y[L];for(let U=1;U<B.length;U+=2)m.emplaceBack(D+B[U-1],D+B[U]);F.primitiveLength+=B.length/2}}else(function(I,C,D,F,L,B){const U=[];for(let ae=0;ae<F.length/2;ae++)U.push(-1);const ee={count:0};let q=0,H=I.getOrCreateLatestSegment(C,D),re=H.vertexLength;for(let ae=2;ae<L.length;ae+=3){const be=L[ae-2],Le=L[ae-1],De=L[ae];let Ne=U[be]<q,tt=U[Le]<q,qe=U[De]<q;H.vertexLength+((Ne?1:0)+(tt?1:0)+(qe?1:0))>it.MAX_VERTEX_ARRAY_LENGTH&&(H=I.createNewSegment(C,D),q=ee.count,Ne=!0,tt=!0,qe=!0,re=0);const Re=tu(U,F,B,ee,be,Ne,H),Ae=tu(U,F,B,ee,Le,tt,H),ut=tu(U,F,B,ee,De,qe,H);D.emplaceBack(re+Re-q,re+Ae-q,re+ut-q),H.primitiveLength++}})(e,r,n,a,h,i),P&&(function(I,C,D,F,L,B){const U=[];for(let ae=0;ae<F.length/2;ae++)U.push(-1);const ee={count:0};let q=0,H=I.getOrCreateLatestSegment(C,D),re=H.vertexLength;for(let ae=0;ae<L.length;ae++){const be=L[ae];for(let Le=1;Le<L[ae].length;Le+=2){const De=be[Le-1],Ne=be[Le];let tt=U[De]<q,qe=U[Ne]<q;H.vertexLength+((tt?1:0)+(qe?1:0))>it.MAX_VERTEX_ARRAY_LENGTH&&(H=I.createNewSegment(C,D),q=ee.count,tt=!0,qe=!0,re=0);const Re=tu(U,F,B,ee,De,tt,H),Ae=tu(U,F,B,ee,Ne,qe,H);D.emplaceBack(re+Re-q,re+Ae-q),H.primitiveLength++}}})(d,r,m,a,y,i),e.forceNewSegmentOnNextPrepare(),d?.forceNewSegmentOnNextPrepare()}function tu(i,e,r,n,a,h,d){if(h){const m=n.count;return r(e[2*a],e[2*a+1]),i[a]=n.count,n.count++,d.vertexLength++,m}return i[a]}class dp{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((r=>r.id)),this.index=e.index,this.hasDependencies=!1,this.patternFeatures=[],this.layoutVertexArray=new X,this.indexArray=new Ie,this.indexArray2=new Xe,this.programConfigurations=new Wn(e.layers,e.zoom),this.segments=new it,this.segments2=new it,this.stateDependentLayerIds=this.layers.filter((r=>r.isStateDependent())).map((r=>r.id))}populate(e,r,n){this.hasDependencies=Rh("fill",this.layers,r);const a=this.layers[0].layout.get("fill-sort-key"),h=!a.isConstant(),d=[];for(const{feature:m,id:y,index:w,sourceLayerIndex:P}of e){const I=this.layers[0]._featureFilter.needGeometry,C=Sn(m,I);if(!this.layers[0]._featureFilter.filter(new gr(this.zoom),C,n))continue;const D=h?a.evaluate(C,{},n,r.availableImages):void 0,F={id:y,properties:m.properties,type:m.type,sourceLayerIndex:P,index:w,geometry:I?C.geometry:Tn(m),patterns:{},sortKey:D};d.push(F)}h&&d.sort(((m,y)=>m.sortKey-y.sortKey));for(const m of d){const{geometry:y,index:w,sourceLayerIndex:P}=m;if(this.hasDependencies){const I=cp("fill",this.layers,m,{zoom:this.zoom},r);this.patternFeatures.push(I)}else this.addFeature(m,y,w,n,{},r.subdivisionGranularity);r.featureIndex.insert(e[w].feature,y,w,P,this.index)}}update(e,r,n){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,{imagePositions:n})}addFeatures(e,r,n){for(const a of this.patternFeatures)this.addFeature(a,a.geometry,a.index,r,n,e.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Vy),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,r,n,a,h,d){for(const m of $a(r,500)){const y=am(m,a,d.fill.getGranularityForZoomLevel(a.z)),w=this.layoutVertexArray;lm(((P,I)=>{w.emplaceBack(P,I)}),this.segments,this.layoutVertexArray,this.indexArray,y.verticesFlattened,y.indicesTriangles,this.segments2,this.indexArray2,y.indicesLineList)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,{imagePositions:h,canonical:a})}}let cm,um;ht("FillBucket",dp,{omit:["layers","patternFeatures"]});var Qy={get paint(){return um=um||new qi({"fill-antialias":new bt(Se.paint_fill["fill-antialias"]),"fill-opacity":new Et(Se.paint_fill["fill-opacity"]),"fill-color":new Et(Se.paint_fill["fill-color"]),"fill-outline-color":new Et(Se.paint_fill["fill-outline-color"]),"fill-translate":new bt(Se.paint_fill["fill-translate"]),"fill-translate-anchor":new bt(Se.paint_fill["fill-translate-anchor"]),"fill-pattern":new fa(Se.paint_fill["fill-pattern"])})},get layout(){return cm=cm||new qi({"fill-sort-key":new Et(Se.layout_fill["fill-sort-key"])})}};class e0 extends fs{constructor(e,r){super(e,Qy,r)}recalculate(e,r){super.recalculate(e,r);const n=this.paint._values["fill-outline-color"];n.value.kind==="constant"&&n.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(e){return new dp(e)}queryRadius(){return Dh(this.paint.get("fill-translate"))}queryIntersectsFeature({queryGeometry:e,geometry:r,transform:n,pixelsToTileUnits:a}){return $f(zh(e,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),-n.bearingInRadians,a),r)}isTileClipped(){return!0}}const t0=Jr([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),r0=Jr([{name:"a_centroid",components:2,type:"Int16"}],4),{members:i0}=t0;class ru{constructor(e,r,n,a,h){this.properties={},this.extent=n,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=a,this._values=h,e.readFields(s0,this,r)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const r=e.readVarint()+e.pos,n=[];let a,h=1,d=0,m=0,y=0;for(;e.pos<r;){if(d<=0){const w=e.readVarint();h=7&w,d=w>>3}if(d--,h===1||h===2)m+=e.readSVarint(),y+=e.readSVarint(),h===1&&(a&&n.push(a),a=[]),a&&a.push(new $(m,y));else{if(h!==7)throw new Error(`unknown command ${h}`);a&&a.push(a[0].clone())}}return a&&n.push(a),n}bbox(){const e=this._pbf;e.pos=this._geometry;const r=e.readVarint()+e.pos;let n=1,a=0,h=0,d=0,m=1/0,y=-1/0,w=1/0,P=-1/0;for(;e.pos<r;){if(a<=0){const I=e.readVarint();n=7&I,a=I>>3}if(a--,n===1||n===2)h+=e.readSVarint(),d+=e.readSVarint(),h<m&&(m=h),h>y&&(y=h),d<w&&(w=d),d>P&&(P=d);else if(n!==7)throw new Error(`unknown command ${n}`)}return[m,w,y,P]}toGeoJSON(e,r,n){const a=this.extent*Math.pow(2,n),h=this.extent*e,d=this.extent*r,m=this.loadGeometry();function y(C){return[360*(C.x+h)/a-180,360/Math.PI*Math.atan(Math.exp((1-2*(C.y+d)/a)*Math.PI))-90]}function w(C){return C.map(y)}let P;if(this.type===1){const C=[];for(const F of m)C.push(F[0]);const D=w(C);P=C.length===1?{type:"Point",coordinates:D[0]}:{type:"MultiPoint",coordinates:D}}else if(this.type===2){const C=m.map(w);P=C.length===1?{type:"LineString",coordinates:C[0]}:{type:"MultiLineString",coordinates:C}}else{if(this.type!==3)throw new Error("unknown feature type");{const C=hm(m),D=[];for(const F of C)D.push(F.map(w));P=D.length===1?{type:"Polygon",coordinates:D[0]}:{type:"MultiPolygon",coordinates:D}}}const I={type:"Feature",geometry:P,properties:this.properties};return this.id!=null&&(I.id=this.id),I}}function s0(i,e,r){i===1?e.id=r.readVarint():i===2?(function(n,a){const h=n.readVarint()+n.pos;for(;n.pos<h;){const d=a._keys[n.readVarint()],m=a._values[n.readVarint()];a.properties[d]=m}})(r,e):i===3?e.type=r.readVarint():i===4&&(e._geometry=r.pos)}function hm(i){const e=i.length;if(e<=1)return[i];const r=[];let n,a;for(let h=0;h<e;h++){const d=n0(i[h]);d!==0&&(a===void 0&&(a=d<0),a===d<0?(n&&r.push(n),n=[i[h]]):n&&n.push(i[h]))}return n&&r.push(n),r}function n0(i){let e=0;for(let r,n,a=0,h=i.length,d=h-1;a<h;d=a++)r=i[a],n=i[d],e+=(n.x-r.x)*(r.y+n.y);return e}ru.types=["Unknown","Point","LineString","Polygon"];class o0{constructor(e,r){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(a0,this,r),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const r=this._pbf.readVarint()+this._pbf.pos;return new ru(this._pbf,r,this.extent,this._keys,this._values)}}function a0(i,e,r){i===15?e.version=r.readVarint():i===1?e.name=r.readString():i===5?e.extent=r.readVarint():i===2?e._features.push(r.pos):i===3?e._keys.push(r.readString()):i===4&&e._values.push((function(n){let a=null;const h=n.readVarint()+n.pos;for(;n.pos<h;){const d=n.readVarint()>>3;a=d===1?n.readString():d===2?n.readFloat():d===3?n.readDouble():d===4?n.readVarint64():d===5?n.readVarint():d===6?n.readSVarint():d===7?n.readBoolean():null}if(a==null)throw new Error("unknown feature value");return a})(r))}class dm{constructor(e,r){this.layers=e.readFields(l0,{},r)}}function l0(i,e,r){if(i===3){const n=new o0(r,r.readVarint()+r.pos);n.length&&(e[n.name]=n)}}const pp=Math.pow(2,13);function iu(i,e,r,n,a,h,d,m){i.emplaceBack(e,r,2*Math.floor(n*pp)+d,a*pp*2,h*pp*2,Math.round(m))}class fp{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((r=>r.id)),this.index=e.index,this.hasDependencies=!1,this.layoutVertexArray=new te,this.centroidVertexArray=new W,this.indexArray=new Ie,this.programConfigurations=new Wn(e.layers,e.zoom),this.segments=new it,this.stateDependentLayerIds=this.layers.filter((r=>r.isStateDependent())).map((r=>r.id))}populate(e,r,n){this.features=[],this.hasDependencies=Rh("fill-extrusion",this.layers,r);for(const{feature:a,id:h,index:d,sourceLayerIndex:m}of e){const y=this.layers[0]._featureFilter.needGeometry,w=Sn(a,y);if(!this.layers[0]._featureFilter.filter(new gr(this.zoom),w,n))continue;const P={id:h,sourceLayerIndex:m,index:d,geometry:y?w.geometry:Tn(a),properties:a.properties,type:a.type,patterns:{}};this.hasDependencies?this.features.push(cp("fill-extrusion",this.layers,P,{zoom:this.zoom},r)):this.addFeature(P,P.geometry,d,n,{},r.subdivisionGranularity),r.featureIndex.insert(a,P.geometry,d,m,this.index,!0)}}addFeatures(e,r,n){for(const a of this.features){const{geometry:h}=a;this.addFeature(a,h,a.index,r,n,e.subdivisionGranularity)}}update(e,r,n){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,{imagePositions:n})}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,i0),this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,r0.members,!0),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(e,r,n,a,h,d){for(const m of $a(r,500)){const y={x:0,y:0,sampleCount:0},w=this.layoutVertexArray.length;this.processPolygon(y,a,e,m,d);const P=this.layoutVertexArray.length-w,I=Math.floor(y.x/y.sampleCount),C=Math.floor(y.y/y.sampleCount);for(let D=0;D<P;D++)this.centroidVertexArray.emplaceBack(I,C)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,{imagePositions:h,canonical:a})}processPolygon(e,r,n,a,h){if(a.length<1||pm(a[0]))return;for(const I of a)I.length!==0&&c0(e,I);const d={segment:this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray)},m=h.fill.getGranularityForZoomLevel(r.z),y=ru.types[n.type]==="Polygon";for(const I of a){if(I.length===0||pm(I))continue;const C=Ta(I,m,y);this._generateSideFaces(C,d)}if(!y)return;const w=am(a,r,m,!1),P=this.layoutVertexArray;lm(((I,C)=>{iu(P,I,C,0,0,1,1,0)}),this.segments,this.layoutVertexArray,this.indexArray,w.verticesFlattened,w.indicesTriangles)}_generateSideFaces(e,r){let n=0;for(let a=1;a<e.length;a++){const h=e[a],d=e[a-1];if(u0(h,d))continue;r.segment.vertexLength+4>it.MAX_VERTEX_ARRAY_LENGTH&&(r.segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const m=h.sub(d)._perp()._unit(),y=d.dist(h);n+y>32768&&(n=0),iu(this.layoutVertexArray,h.x,h.y,m.x,m.y,0,0,n),iu(this.layoutVertexArray,h.x,h.y,m.x,m.y,0,1,n),n+=y,iu(this.layoutVertexArray,d.x,d.y,m.x,m.y,0,0,n),iu(this.layoutVertexArray,d.x,d.y,m.x,m.y,0,1,n);const w=r.segment.vertexLength;this.indexArray.emplaceBack(w,w+2,w+1),this.indexArray.emplaceBack(w+1,w+2,w+3),r.segment.vertexLength+=4,r.segment.primitiveLength+=2}}}function c0(i,e){for(let r=0;r<e.length;r++){const n=e[r];r===e.length-1&&e[0].x===n.x&&e[0].y===n.y||(i.x+=n.x,i.y+=n.y,i.sampleCount++)}}function u0(i,e){return i.x===e.x&&(i.x<0||i.x>Ct)||i.y===e.y&&(i.y<0||i.y>Ct)}function pm(i){return i.every((e=>e.x<0))||i.every((e=>e.x>Ct))||i.every((e=>e.y<0))||i.every((e=>e.y>Ct))}let fm;ht("FillExtrusionBucket",fp,{omit:["layers","features"]});var h0={get paint(){return fm=fm||new qi({"fill-extrusion-opacity":new bt(Se["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Et(Se["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new bt(Se["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new bt(Se["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new fa(Se["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Et(Se["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Et(Se["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new bt(Se["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class d0 extends fs{constructor(e,r){super(e,h0,r)}createBucket(e){return new fp(e)}queryRadius(){return Dh(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature({queryGeometry:e,feature:r,featureState:n,geometry:a,transform:h,pixelsToTileUnits:d,pixelPosMatrix:m}){const y=zh(e,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),-h.bearingInRadians,d),w=this.paint.get("fill-extrusion-height").evaluate(r,n),P=this.paint.get("fill-extrusion-base").evaluate(r,n),I=(function(D,F){const L=[];for(const B of D){const U=[B.x,B.y,0,1];Ht(U,U,F),L.push(new $(U[0]/U[3],U[1]/U[3]))}return L})(y,m),C=(function(D,F,L,B){const U=[],ee=[],q=B[8]*F,H=B[9]*F,re=B[10]*F,ae=B[11]*F,be=B[8]*L,Le=B[9]*L,De=B[10]*L,Ne=B[11]*L;for(const tt of D){const qe=[],Re=[];for(const Ae of tt){const ut=Ae.x,lt=Ae.y,dt=B[0]*ut+B[4]*lt+B[12],nt=B[1]*ut+B[5]*lt+B[13],Tt=B[2]*ut+B[6]*lt+B[14],ir=B[3]*ut+B[7]*lt+B[15],Gt=Tt+re,Rr=ir+ae,zi=dt+be,ai=nt+Le,Fr=Tt+De,Ar=ir+Ne,ur=new $((dt+q)/Rr,(nt+H)/Rr);ur.z=Gt/Rr,qe.push(ur);const Gr=new $(zi/Ar,ai/Ar);Gr.z=Fr/Ar,Re.push(Gr)}U.push(qe),ee.push(Re)}return[U,ee]})(a,P,w,m);return(function(D,F,L){let B=1/0;$f(L,F)&&(B=mm(L,F[0]));for(let U=0;U<F.length;U++){const ee=F[U],q=D[U];for(let H=0;H<ee.length-1;H++){const re=ee[H],ae=[re,ee[H+1],q[H+1],q[H],re];vl(L,ae)&&(B=Math.min(B,mm(L,ae)))}}return B!==1/0&&B})(C[0],C[1],I)}}function su(i,e){return i.x*e.x+i.y*e.y}function mm(i,e){if(i.length===1){let r=0;const n=e[r++];let a;for(;!a||n.equals(a);)if(a=e[r++],!a)return 1/0;for(;r<e.length;r++){const h=e[r],d=i[0],m=a.sub(n),y=h.sub(n),w=d.sub(n),P=su(m,m),I=su(m,y),C=su(y,y),D=su(w,m),F=su(w,y),L=P*C-I*I,B=(C*D-I*F)/L,U=(P*F-I*D)/L,ee=n.z*(1-B-U)+a.z*B+h.z*U;if(isFinite(ee))return ee}return 1/0}{let r=1/0;for(const n of e)r=Math.min(r,n.z);return r}}const p0=Jr([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:f0}=p0,m0=Jr([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:g0}=m0,_0=Math.cos(Math.PI/180*37.5),gm=Math.pow(2,14)/.5;class mp{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((r=>r.id)),this.index=e.index,this.hasDependencies=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((r=>{this.gradients[r.id]={}})),this.layoutVertexArray=new le,this.layoutVertexArray2=new Q,this.indexArray=new Ie,this.programConfigurations=new Wn(e.layers,e.zoom),this.segments=new it,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter((r=>r.isStateDependent())).map((r=>r.id))}populate(e,r,n){this.hasDependencies=Rh("line",this.layers,r)||this.hasLineDasharray(this.layers);const a=this.layers[0].layout.get("line-sort-key"),h=!a.isConstant(),d=[];for(const{feature:m,id:y,index:w,sourceLayerIndex:P}of e){const I=this.layers[0]._featureFilter.needGeometry,C=Sn(m,I);if(!this.layers[0]._featureFilter.filter(new gr(this.zoom),C,n))continue;const D=h?a.evaluate(C,{},n):void 0,F={id:y,properties:m.properties,type:m.type,sourceLayerIndex:P,index:w,geometry:I?C.geometry:Tn(m),patterns:{},dashes:{},sortKey:D};d.push(F)}h&&d.sort(((m,y)=>m.sortKey-y.sortKey));for(const m of d){const{geometry:y,index:w,sourceLayerIndex:P}=m;this.hasDependencies?(Rh("line",this.layers,r)?cp("line",this.layers,m,{zoom:this.zoom},r):this.hasLineDasharray(this.layers)&&this.addLineDashDependencies(this.layers,m,this.zoom,r),this.patternFeatures.push(m)):this.addFeature(m,y,w,n,{},{},r.subdivisionGranularity),r.featureIndex.insert(e[w].feature,y,w,P,this.index)}}update(e,r,n,a){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,r,this.stateDependentLayers,{imagePositions:n,dashPositions:a})}addFeatures(e,r,n,a){for(const h of this.patternFeatures)this.addFeature(h,h.geometry,h.index,r,n,a,e.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,g0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,f0),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(e.properties,"mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,r,n,a,h,d,m){const y=this.layers[0].layout,w=y.get("line-join").evaluate(e,{}),P=y.get("line-cap"),I=y.get("line-miter-limit"),C=y.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const D of r)this.addLine(D,e,w,P,I,C,a,m);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,{imagePositions:h,dashPositions:d,canonical:a})}addLine(e,r,n,a,h,d,m,y){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,e=Ta(e,m?y.line.getGranularityForZoomLevel(m.z):1),this.lineClips){this.lineClipsArray.push(this.lineClips);for(let q=0;q<e.length-1;q++)this.totalDistance+=e[q].dist(e[q+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const w=ru.types[r.type]==="Polygon";let P=e.length;for(;P>=2&&e[P-1].equals(e[P-2]);)P--;let I=0;for(;I<P-1&&e[I].equals(e[I+1]);)I++;if(P<(w?3:2))return;n==="bevel"&&(h=1.05);const C=this.overscaling<=16?122880/(512*this.overscaling):0,D=this.segments.prepareSegment(10*P,this.layoutVertexArray,this.indexArray);let F,L,B,U,ee;this.e1=this.e2=-1,w&&(F=e[P-2],ee=e[I].sub(F)._unit()._perp());for(let q=I;q<P;q++){if(B=q===P-1?w?e[I+1]:void 0:e[q+1],B&&e[q].equals(B))continue;ee&&(U=ee),F&&(L=F),F=e[q],ee=B?B.sub(F)._unit()._perp():U,U=U||ee;let H=U.add(ee);H.x===0&&H.y===0||H._unit();const re=U.x*ee.x+U.y*ee.y,ae=H.x*ee.x+H.y*ee.y,be=ae!==0?1/ae:1/0,Le=2*Math.sqrt(2-2*ae),De=ae<_0&&L&&B,Ne=U.x*ee.y-U.y*ee.x>0;if(De&&q>I){const Re=F.dist(L);if(Re>2*C){const Ae=F.sub(F.sub(L)._mult(C/Re)._round());this.updateDistance(L,Ae),this.addCurrentVertex(Ae,U,0,0,D),L=Ae}}const tt=L&&B;let qe=tt?n:w?"butt":a;if(tt&&qe==="round"&&(be<d?qe="miter":be<=2&&(qe="fakeround")),qe==="miter"&&be>h&&(qe="bevel"),qe==="bevel"&&(be>2&&(qe="flipbevel"),be<h&&(qe="miter")),L&&this.updateDistance(L,F),qe==="miter")H._mult(be),this.addCurrentVertex(F,H,0,0,D);else if(qe==="flipbevel"){if(be>100)H=ee.mult(-1);else{const Re=be*U.add(ee).mag()/U.sub(ee).mag();H._perp()._mult(Re*(Ne?-1:1))}this.addCurrentVertex(F,H,0,0,D),this.addCurrentVertex(F,H.mult(-1),0,0,D)}else if(qe==="bevel"||qe==="fakeround"){const Re=-Math.sqrt(be*be-1),Ae=Ne?Re:0,ut=Ne?0:Re;if(L&&this.addCurrentVertex(F,U,Ae,ut,D),qe==="fakeround"){const lt=Math.round(180*Le/Math.PI/20);for(let dt=1;dt<lt;dt++){let nt=dt/lt;if(nt!==.5){const ir=nt-.5;nt+=nt*ir*(nt-1)*((1.0904+re*(re*(3.55645-1.43519*re)-3.2452))*ir*ir+(.848013+re*(.215638*re-1.06021)))}const Tt=ee.sub(U)._mult(nt)._add(U)._unit()._mult(Ne?-1:1);this.addHalfVertex(F,Tt.x,Tt.y,!1,Ne,0,D)}}B&&this.addCurrentVertex(F,ee,-Ae,-ut,D)}else if(qe==="butt")this.addCurrentVertex(F,H,0,0,D);else if(qe==="square"){const Re=L?1:-1;this.addCurrentVertex(F,H,Re,Re,D)}else qe==="round"&&(L&&(this.addCurrentVertex(F,U,0,0,D),this.addCurrentVertex(F,U,1,1,D,!0)),B&&(this.addCurrentVertex(F,ee,-1,-1,D,!0),this.addCurrentVertex(F,ee,0,0,D)));if(De&&q<P-1){const Re=F.dist(B);if(Re>2*C){const Ae=F.add(B.sub(F)._mult(C/Re)._round());this.updateDistance(F,Ae),this.addCurrentVertex(Ae,ee,0,0,D),F=Ae}}}}addCurrentVertex(e,r,n,a,h,d=!1){const m=r.y*a-r.x,y=-r.y-r.x*a;this.addHalfVertex(e,r.x+r.y*n,r.y-r.x*n,d,!1,n,h),this.addHalfVertex(e,m,y,d,!0,-a,h),this.distance>gm/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(e,r,n,a,h,d))}addHalfVertex({x:e,y:r},n,a,h,d,m,y){const w=.5*(this.lineClips?this.scaledDistance*(gm-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((e<<1)+(h?1:0),(r<<1)+(d?1:0),Math.round(63*n)+128,Math.round(63*a)+128,1+(m===0?0:m<0?-1:1)|(63&w)<<2,w>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const P=y.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,P,this.e2),y.primitiveLength++),d?this.e2=P:this.e1=P}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(e,r){this.distance+=e.dist(r),this.updateScaledDistance()}hasLineDasharray(e){for(const r of e){const n=r.paint.get("line-dasharray");if(n&&!n.isConstant())return!0}return!1}addLineDashDependencies(e,r,n,a){for(const h of e){const d=h.paint.get("line-dasharray");if(!d||d.value.kind==="constant")continue;const m=h.layout.get("line-cap")==="round",y={dasharray:d.value.evaluate({zoom:n-1},r,{}),round:m},w={dasharray:d.value.evaluate({zoom:n},r,{}),round:m},P={dasharray:d.value.evaluate({zoom:n+1},r,{}),round:m},I=`${y.dasharray.join(",")},${y.round}`,C=`${w.dasharray.join(",")},${w.round}`,D=`${P.dasharray.join(",")},${P.round}`;a.dashDependencies[I]=y,a.dashDependencies[C]=w,a.dashDependencies[D]=P,r.dashes[h.id]={min:I,mid:C,max:D}}}}let _m,ym;ht("LineBucket",mp,{omit:["layers","patternFeatures"]});var xm={get paint(){return ym=ym||new qi({"line-opacity":new Et(Se.paint_line["line-opacity"]),"line-color":new Et(Se.paint_line["line-color"]),"line-translate":new bt(Se.paint_line["line-translate"]),"line-translate-anchor":new bt(Se.paint_line["line-translate-anchor"]),"line-width":new Et(Se.paint_line["line-width"]),"line-gap-width":new Et(Se.paint_line["line-gap-width"]),"line-offset":new Et(Se.paint_line["line-offset"]),"line-blur":new Et(Se.paint_line["line-blur"]),"line-dasharray":new fa(Se.paint_line["line-dasharray"]),"line-pattern":new fa(Se.paint_line["line-pattern"]),"line-gradient":new dl(Se.paint_line["line-gradient"])})},get layout(){return _m=_m||new qi({"line-cap":new bt(Se.layout_line["line-cap"]),"line-join":new Et(Se.layout_line["line-join"]),"line-miter-limit":new bt(Se.layout_line["line-miter-limit"]),"line-round-limit":new bt(Se.layout_line["line-round-limit"]),"line-sort-key":new Et(Se.layout_line["line-sort-key"])})}};class y0 extends Et{possiblyEvaluate(e,r){return r=new gr(Math.floor(r.zoom),{now:r.now,fadeDuration:r.fadeDuration,zoomHistory:r.zoomHistory,transition:r.transition}),super.possiblyEvaluate(e,r)}evaluate(e,r,n,a){return r=Sr({},r,{zoom:Math.floor(r.zoom)}),super.evaluate(e,r,n,a)}}let Bh;class x0 extends fs{constructor(e,r){super(e,xm,r),this.gradientVersion=0,Bh||(Bh=new y0(xm.paint.properties["line-width"].specification),Bh.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(e){if(e==="line-gradient"){const r=this.gradientExpression();this.stepInterpolant=!!(function(n){return n._styleExpression!==void 0})(r)&&r._styleExpression.expression instanceof mn,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(e,r){super.recalculate(e,r),this.paint._values["line-floorwidth"]=Bh.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e)}createBucket(e){return new mp(e)}queryRadius(e){const r=e,n=vm(wl("line-width",this,r),wl("line-gap-width",this,r)),a=wl("line-offset",this,r);return n/2+Math.abs(a)+Dh(this.paint.get("line-translate"))}queryIntersectsFeature({queryGeometry:e,feature:r,featureState:n,geometry:a,transform:h,pixelsToTileUnits:d}){const m=zh(e,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),-h.bearingInRadians,d),y=d/2*vm(this.paint.get("line-width").evaluate(r,n),this.paint.get("line-gap-width").evaluate(r,n)),w=this.paint.get("line-offset").evaluate(r,n);return w&&(a=(function(P,I){const C=[];for(let D=0;D<P.length;D++){const F=My(P[D]),L=[];for(let B=0;B<F.length;B++){const U=F[B],ee=F[B-1],q=F[B+1],H=B===0?new $(0,0):U.sub(ee)._unit()._perp(),re=B===F.length-1?new $(0,0):q.sub(U)._unit()._perp(),ae=H._add(re)._unit(),be=ae.x*re.x+ae.y*re.y;be!==0&&ae._mult(1/be),L.push(ae._mult(I)._add(U))}C.push(L)}return C})(a,w*d)),(function(P,I,C){for(let D=0;D<I.length;D++){const F=I[D];if(P.length>=3){for(let L=0;L<F.length;L++)if(bl(P,F[L]))return!0}if(Sy(P,F,C))return!0}return!1})(m,a,y)}isTileClipped(){return!0}}function vm(i,e){return e>0?e+2*i:i}const v0=Jr([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),b0=Jr([{name:"a_projected_pos",components:3,type:"Float32"}],4);Jr([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const w0=Jr([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);Jr([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const bm=Jr([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),T0=Jr([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function S0(i,e,r){return i.sections.forEach((n=>{n.text=(function(a,h,d){const m=h.layout.get("text-transform").evaluate(d,{});return m==="uppercase"?a=a.toLocaleUpperCase():m==="lowercase"&&(a=a.toLocaleLowerCase()),vn.applyArabicShaping&&(a=vn.applyArabicShaping(a)),a})(n.text,e,r)})),i}Jr([{name:"triangle",components:3,type:"Uint16"}]),Jr([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),Jr([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),Jr([{type:"Float32",name:"offsetX"}]),Jr([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),Jr([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);var _i=24;const nu={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","⋯":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"},P0={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},E0={40:!0};function wm(i,e,r,n,a,h){if("fontStack"in e){const d=r[e.fontStack],m=d&&d[i];return m?m.metrics.advance*e.scale+a:0}{const d=n[e.imageName];return d?d.displaySize[0]*e.scale*_i/h+a:0}}function Tm(i,e,r,n){const a=Math.pow(i-e,2);return n?i<e?a/2:2*a:a+Math.abs(r)*r}function M0(i,e,r){let n=0;return i===10&&(n-=1e4),r&&(n+=150),i!==40&&i!==65288||(n+=50),e!==41&&e!==65289||(n+=50),n}function Sm(i,e,r,n,a,h){let d=null,m=Tm(e,r,a,h);for(const y of n){const w=Tm(e-y.x,r,a,h)+y.badness;w<=m&&(d=y,m=w)}return{index:i,x:e,priorBreak:d,badness:m}}function Pm(i){return i?Pm(i.priorBreak).concat(i.index):[]}class El{constructor(e="",r=[],n=[]){this.text=e,this.sections=r,this.sectionIndex=n,this.imageSectionID=null}static fromFeature(e,r){const n=new El;for(let a=0;a<e.sections.length;a++){const h=e.sections[a];h.image?n.addImageSection(h):n.addTextSection(h,r)}return n}length(){return[...this.text].length}getSection(e){return this.sections[this.sectionIndex[e]]}getSectionIndex(e){return this.sectionIndex[e]}verticalizePunctuation(){this.text=(function(e){let r="",n={premature:!0,value:void 0};const a=e[Symbol.iterator]();let h=a.next();const d=e[Symbol.iterator]();d.next();let m=d.next();for(;!h.done;)r+=!m.done&&Fc(m.value.codePointAt(0))&&!nu[m.value]||!n.premature&&Fc(n.value.codePointAt(0))&&!nu[n.value]||!nu[h.value]?h.value:nu[h.value],n={value:h.value,premature:!1},h=a.next(),m=d.next();return r})(this.text)}hasZeroWidthSpaces(){return this.text.includes("​")}trim(){const e=this.text.match(/^\s*/),r=e?e[0].length:0,n=this.text.match(/\S\s*$/),a=n?n[0].length-1:0;this.text=this.text.substring(r,this.text.length-a),this.sectionIndex=this.sectionIndex.slice(r,this.sectionIndex.length-a)}substring(e,r){const n=[...this.text].slice(e,r).join(""),a=this.sectionIndex.slice(e,r);return new El(n,this.sections,a)}toCodeUnitIndex(e){return[...this.text].slice(0,e).join("").length}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((e,r)=>Math.max(e,this.sections[r].scale)),0)}getMaxImageSize(e){let r=0,n=0;for(let a=0;a<this.length();a++){const h=this.getSection(a);if("imageName"in h){const d=e[h.imageName];if(!d)continue;const m=d.displaySize;r=Math.max(r,m[0]),n=Math.max(n,m[1])}}return{maxImageWidth:r,maxImageHeight:n}}addTextSection(e,r){this.text+=e.text,this.sections.push({scale:e.scale||1,verticalAlign:e.verticalAlign||"bottom",fontStack:e.fontStack||r});const n=this.sections.length-1;this.sectionIndex.push(...[...e.text].map((()=>n)))}addImageSection(e){const r=e.image?e.image.name:"";if(r.length===0)return void Vr("Can't add FormattedSection with an empty image.");const n=this.getNextImageSectionCharCode();n?(this.text+=String.fromCharCode(n),this.sections.push({scale:1,verticalAlign:e.verticalAlign||"bottom",imageName:r}),this.sectionIndex.push(this.sections.length-1)):Vr("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}determineLineBreaks(e,r,n,a,h){const d=[],m=this.determineAverageLineWidth(e,r,n,a,h),y=this.hasZeroWidthSpaces();let w=0,P=0;const I=this.text[Symbol.iterator]();let C=I.next();const D=this.text[Symbol.iterator]();D.next();let F=D.next();const L=this.text[Symbol.iterator]();L.next(),L.next();let B=L.next();for(;!C.done;){const U=this.getSection(P),ee=C.value.codePointAt(0);if(vh(ee)||(w+=wm(ee,U,n,a,e,h)),!F.done){const q=ha(ee),H=F.value.codePointAt(0);(P0[ee]||q||"imageName"in U||!B.done&&E0[H])&&d.push(Sm(P+1,w,m,d,M0(ee,H,q&&y),!1))}P++,C=I.next(),F=D.next(),B=L.next()}return Pm(Sm(this.length(),w,m,d,0,!0))}determineAverageLineWidth(e,r,n,a,h){let d=0,m=0;for(const y of this.text){const w=this.getSection(m);d+=wm(y.codePointAt(0),w,n,a,e,h),m++}return d/Math.max(1,Math.ceil(d/r))}}const gp=4294967296,Em=1/gp,Mm=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");class jh{constructor(e=new Uint8Array(16)){this.buf=ArrayBuffer.isView(e)?e:new Uint8Array(e),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(e,r,n=this.length){for(;this.pos<n;){const a=this.readVarint(),h=a>>3,d=this.pos;this.type=7&a,e(h,r,this),this.pos===d&&this.skip(a)}return r}readMessage(e,r){return this.readFields(e,r,this.readVarint()+this.pos)}readFixed32(){const e=this.dataView.getUint32(this.pos,!0);return this.pos+=4,e}readSFixed32(){const e=this.dataView.getInt32(this.pos,!0);return this.pos+=4,e}readFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*gp;return this.pos+=8,e}readSFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*gp;return this.pos+=8,e}readFloat(){const e=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,e}readDouble(){const e=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,e}readVarint(e){const r=this.buf;let n,a;return a=r[this.pos++],n=127&a,a<128?n:(a=r[this.pos++],n|=(127&a)<<7,a<128?n:(a=r[this.pos++],n|=(127&a)<<14,a<128?n:(a=r[this.pos++],n|=(127&a)<<21,a<128?n:(a=r[this.pos],n|=(15&a)<<28,(function(h,d,m){const y=m.buf;let w,P;if(P=y[m.pos++],w=(112&P)>>4,P<128||(P=y[m.pos++],w|=(127&P)<<3,P<128)||(P=y[m.pos++],w|=(127&P)<<10,P<128)||(P=y[m.pos++],w|=(127&P)<<17,P<128)||(P=y[m.pos++],w|=(127&P)<<24,P<128)||(P=y[m.pos++],w|=(1&P)<<31,P<128))return Ml(h,w,d);throw new Error("Expected varint not more than 10 bytes")})(n,e,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const e=this.readVarint();return e%2==1?(e+1)/-2:e/2}readBoolean(){return!!this.readVarint()}readString(){const e=this.readVarint()+this.pos,r=this.pos;return this.pos=e,e-r>=12&&Mm?Mm.decode(this.buf.subarray(r,e)):(function(n,a,h){let d="",m=a;for(;m<h;){const y=n[m];let w,P,I,C=null,D=y>239?4:y>223?3:y>191?2:1;if(m+D>h)break;D===1?y<128&&(C=y):D===2?(w=n[m+1],(192&w)==128&&(C=(31&y)<<6|63&w,C<=127&&(C=null))):D===3?(w=n[m+1],P=n[m+2],(192&w)==128&&(192&P)==128&&(C=(15&y)<<12|(63&w)<<6|63&P,(C<=2047||C>=55296&&C<=57343)&&(C=null))):D===4&&(w=n[m+1],P=n[m+2],I=n[m+3],(192&w)==128&&(192&P)==128&&(192&I)==128&&(C=(15&y)<<18|(63&w)<<12|(63&P)<<6|63&I,(C<=65535||C>=1114112)&&(C=null))),C===null?(C=65533,D=1):C>65535&&(C-=65536,d+=String.fromCharCode(C>>>10&1023|55296),C=56320|1023&C),d+=String.fromCharCode(C),m+=D}return d})(this.buf,r,e)}readBytes(){const e=this.readVarint()+this.pos,r=this.buf.subarray(this.pos,e);return this.pos=e,r}readPackedVarint(e=[],r){const n=this.readPackedEnd();for(;this.pos<n;)e.push(this.readVarint(r));return e}readPackedSVarint(e=[]){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readSVarint());return e}readPackedBoolean(e=[]){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readBoolean());return e}readPackedFloat(e=[]){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readFloat());return e}readPackedDouble(e=[]){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readDouble());return e}readPackedFixed32(e=[]){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readFixed32());return e}readPackedSFixed32(e=[]){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readSFixed32());return e}readPackedFixed64(e=[]){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readFixed64());return e}readPackedSFixed64(e=[]){const r=this.readPackedEnd();for(;this.pos<r;)e.push(this.readSFixed64());return e}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(e){const r=7&e;if(r===0)for(;this.buf[this.pos++]>127;);else if(r===2)this.pos=this.readVarint()+this.pos;else if(r===5)this.pos+=4;else{if(r!==1)throw new Error(`Unimplemented type: ${r}`);this.pos+=8}}writeTag(e,r){this.writeVarint(e<<3|r)}realloc(e){let r=this.length||16;for(;r<this.pos+e;)r*=2;if(r!==this.length){const n=new Uint8Array(r);n.set(this.buf),this.buf=n,this.dataView=new DataView(n.buffer),this.length=r}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeSFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*Em),!0),this.pos+=8}writeSFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*Em),!0),this.pos+=8}writeVarint(e){(e=+e||0)>268435455||e<0?(function(r,n){let a,h;if(r>=0?(a=r%4294967296|0,h=r/4294967296|0):(a=~(-r%4294967296),h=~(-r/4294967296),4294967295^a?a=a+1|0:(a=0,h=h+1|0)),r>=18446744073709552e3||r<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");n.realloc(10),(function(d,m,y){y.buf[y.pos++]=127&d|128,d>>>=7,y.buf[y.pos++]=127&d|128,d>>>=7,y.buf[y.pos++]=127&d|128,d>>>=7,y.buf[y.pos++]=127&d|128,y.buf[y.pos]=127&(d>>>=7)})(a,0,n),(function(d,m){const y=(7&d)<<4;m.buf[m.pos++]|=y|((d>>>=3)?128:0),d&&(m.buf[m.pos++]=127&d|((d>>>=7)?128:0),d&&(m.buf[m.pos++]=127&d|((d>>>=7)?128:0),d&&(m.buf[m.pos++]=127&d|((d>>>=7)?128:0),d&&(m.buf[m.pos++]=127&d|((d>>>=7)?128:0),d&&(m.buf[m.pos++]=127&d)))))})(h,n)})(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))}writeSVarint(e){this.writeVarint(e<0?2*-e-1:2*e)}writeBoolean(e){this.writeVarint(+e)}writeString(e){e=String(e),this.realloc(4*e.length),this.pos++;const r=this.pos;this.pos=(function(a,h,d){for(let m,y,w=0;w<h.length;w++){if(m=h.charCodeAt(w),m>55295&&m<57344){if(!y){m>56319||w+1===h.length?(a[d++]=239,a[d++]=191,a[d++]=189):y=m;continue}if(m<56320){a[d++]=239,a[d++]=191,a[d++]=189,y=m;continue}m=y-55296<<10|m-56320|65536,y=null}else y&&(a[d++]=239,a[d++]=191,a[d++]=189,y=null);m<128?a[d++]=m:(m<2048?a[d++]=m>>6|192:(m<65536?a[d++]=m>>12|224:(a[d++]=m>>18|240,a[d++]=m>>12&63|128),a[d++]=m>>6&63|128),a[d++]=63&m|128)}return d})(this.buf,e,this.pos);const n=this.pos-r;n>=128&&Im(r,n,this),this.pos=r-1,this.writeVarint(n),this.pos+=n}writeFloat(e){this.realloc(4),this.dataView.setFloat32(this.pos,e,!0),this.pos+=4}writeDouble(e){this.realloc(8),this.dataView.setFloat64(this.pos,e,!0),this.pos+=8}writeBytes(e){const r=e.length;this.writeVarint(r),this.realloc(r);for(let n=0;n<r;n++)this.buf[this.pos++]=e[n]}writeRawMessage(e,r){this.pos++;const n=this.pos;e(r,this);const a=this.pos-n;a>=128&&Im(n,a,this),this.pos=n-1,this.writeVarint(a),this.pos+=a}writeMessage(e,r,n){this.writeTag(e,2),this.writeRawMessage(r,n)}writePackedVarint(e,r){r.length&&this.writeMessage(e,I0,r)}writePackedSVarint(e,r){r.length&&this.writeMessage(e,A0,r)}writePackedBoolean(e,r){r.length&&this.writeMessage(e,D0,r)}writePackedFloat(e,r){r.length&&this.writeMessage(e,C0,r)}writePackedDouble(e,r){r.length&&this.writeMessage(e,k0,r)}writePackedFixed32(e,r){r.length&&this.writeMessage(e,z0,r)}writePackedSFixed32(e,r){r.length&&this.writeMessage(e,R0,r)}writePackedFixed64(e,r){r.length&&this.writeMessage(e,F0,r)}writePackedSFixed64(e,r){r.length&&this.writeMessage(e,L0,r)}writeBytesField(e,r){this.writeTag(e,2),this.writeBytes(r)}writeFixed32Field(e,r){this.writeTag(e,5),this.writeFixed32(r)}writeSFixed32Field(e,r){this.writeTag(e,5),this.writeSFixed32(r)}writeFixed64Field(e,r){this.writeTag(e,1),this.writeFixed64(r)}writeSFixed64Field(e,r){this.writeTag(e,1),this.writeSFixed64(r)}writeVarintField(e,r){this.writeTag(e,0),this.writeVarint(r)}writeSVarintField(e,r){this.writeTag(e,0),this.writeSVarint(r)}writeStringField(e,r){this.writeTag(e,2),this.writeString(r)}writeFloatField(e,r){this.writeTag(e,5),this.writeFloat(r)}writeDoubleField(e,r){this.writeTag(e,1),this.writeDouble(r)}writeBooleanField(e,r){this.writeVarintField(e,+r)}}function Ml(i,e,r){return r?4294967296*e+(i>>>0):4294967296*(e>>>0)+(i>>>0)}function Im(i,e,r){const n=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));r.realloc(n);for(let a=r.pos-1;a>=i;a--)r.buf[a+n]=r.buf[a]}function I0(i,e){for(let r=0;r<i.length;r++)e.writeVarint(i[r])}function A0(i,e){for(let r=0;r<i.length;r++)e.writeSVarint(i[r])}function C0(i,e){for(let r=0;r<i.length;r++)e.writeFloat(i[r])}function k0(i,e){for(let r=0;r<i.length;r++)e.writeDouble(i[r])}function D0(i,e){for(let r=0;r<i.length;r++)e.writeBoolean(i[r])}function z0(i,e){for(let r=0;r<i.length;r++)e.writeFixed32(i[r])}function R0(i,e){for(let r=0;r<i.length;r++)e.writeSFixed32(i[r])}function F0(i,e){for(let r=0;r<i.length;r++)e.writeFixed64(i[r])}function L0(i,e){for(let r=0;r<i.length;r++)e.writeSFixed64(i[r])}function O0(i,e,r){i===1&&r.readMessage(B0,e)}function B0(i,e,r){if(i===3){const{id:n,bitmap:a,width:h,height:d,left:m,top:y,advance:w}=r.readMessage(j0,{});e.push({id:n,bitmap:new Xc({width:h+6,height:d+6},a),metrics:{width:h,height:d,left:m,top:y,advance:w}})}}function j0(i,e,r){i===1?e.id=r.readVarint():i===2?e.bitmap=r.readBytes():i===3?e.width=r.readVarint():i===4?e.height=r.readVarint():i===5?e.left=r.readSVarint():i===6?e.top=r.readSVarint():i===7&&(e.advance=r.readVarint())}function Am(i){let e=0,r=0;for(const d of i)e+=d.w*d.h,r=Math.max(r,d.w);i.sort(((d,m)=>m.h-d.h));const n=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),r),h:1/0}];let a=0,h=0;for(const d of i)for(let m=n.length-1;m>=0;m--){const y=n[m];if(!(d.w>y.w||d.h>y.h)){if(d.x=y.x,d.y=y.y,h=Math.max(h,d.y+d.h),a=Math.max(a,d.x+d.w),d.w===y.w&&d.h===y.h){const w=n.pop();w&&m<n.length&&(n[m]=w)}else d.h===y.h?(y.x+=d.w,y.w-=d.w):d.w===y.w?(y.y+=d.h,y.h-=d.h):(n.push({x:y.x+d.w,y:y.y,w:y.w-d.w,h:d.h}),y.y+=d.h,y.h-=d.h);break}}return{w:a,h,fill:e/(a*h)||0}}class _p{constructor(e,{pixelRatio:r,version:n,stretchX:a,stretchY:h,content:d,textFitWidth:m,textFitHeight:y}){this.paddedRect=e,this.pixelRatio=r,this.stretchX=a,this.stretchY=h,this.content=d,this.version=n,this.textFitWidth=m,this.textFitHeight=y}get tl(){return[this.paddedRect.x+1,this.paddedRect.y+1]}get br(){return[this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio]}}class Cm{constructor(e,r){const n={},a={};this.haveRenderCallbacks=[];const h=[];this.addImages(e,n,h),this.addImages(r,a,h);const{w:d,h:m}=Am(h),y=new ss({width:d||1,height:m||1});for(const w in e){const P=e[w],I=n[w].paddedRect;ss.copy(P.data,y,{x:0,y:0},{x:I.x+1,y:I.y+1},P.data)}for(const w in r){const P=r[w],I=a[w].paddedRect,C=I.x+1,D=I.y+1,F=P.data.width,L=P.data.height;ss.copy(P.data,y,{x:0,y:0},{x:C,y:D},P.data),ss.copy(P.data,y,{x:0,y:L-1},{x:C,y:D-1},{width:F,height:1}),ss.copy(P.data,y,{x:0,y:0},{x:C,y:D+L},{width:F,height:1}),ss.copy(P.data,y,{x:F-1,y:0},{x:C-1,y:D},{width:1,height:L}),ss.copy(P.data,y,{x:0,y:0},{x:C+F,y:D},{width:1,height:L})}this.image=y,this.iconPositions=n,this.patternPositions=a}addImages(e,r,n){for(const a in e){const h=e[a],d={x:0,y:0,w:h.data.width+2,h:h.data.height+2};n.push(d),r[a]=new _p(d,h),h.hasRenderCallback&&this.haveRenderCallbacks.push(a)}}patchUpdatedImages(e,r){e.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const n in e.updatedImages)this.patchUpdatedImage(this.iconPositions[n],e.getImage(n),r),this.patchUpdatedImage(this.patternPositions[n],e.getImage(n),r)}patchUpdatedImage(e,r,n){if(!e||!r||e.version===r.version)return;e.version=r.version;const[a,h]=e.tl;n.update(r.data,void 0,{x:a,y:h})}}var Io;function Nh(i,e,r,n,a,h,d,m,y,w,P,I,C,D,F){const L=El.fromFeature(i,a);let B;I===S.az.vertical&&L.verticalizePunctuation();let U=L.determineLineBreaks(w,h,e,n,D);const{processBidirectionalText:ee,processStyledBidirectionalText:q}=vn;if(ee&&L.sections.length===1){B=[],U=U.map((be=>L.toCodeUnitIndex(be)));const ae=ee(L.toString(),U);for(const be of ae){const Le=[...be].map((()=>0));B.push(new El(be,L.sections,Le))}}else if(q){B=[],U=U.map((De=>L.toCodeUnitIndex(De)));let ae=0;const be=[];for(const De of L.text)be.push(...Array(De.length).fill(L.sectionIndex[ae])),ae++;const Le=q(L.text,be,U);for(const De of Le){const Ne=[];let tt="";for(const qe of De[0])Ne.push(De[1][tt.length]),tt+=qe;B.push(new El(De[0],L.sections,Ne))}}else B=(function(ae,be){const Le=[];let De=0;for(const Ne of be)Le.push(ae.substring(De,Ne)),De=Ne;return De<ae.length()&&Le.push(ae.substring(De,ae.length())),Le})(L,U);const H=[],re={positionedLines:H,text:L.toString(),top:P[1],bottom:P[1],left:P[0],right:P[0],writingMode:I,iconsInText:!1,verticalizable:!1};return(function(ae,be,Le,De,Ne,tt,qe,Re,Ae,ut,lt,dt){let nt=0,Tt=0,ir=0,Gt=0;const Rr=Re==="right"?1:Re==="left"?0:.5,zi=_i/dt;let ai=0;for(const ur of Ne){ur.trim();const Gr=ur.getMaxScale(),Qr={positionedGlyphs:[],lineOffset:0};ae.positionedLines[ai]=Qr;const Er=Qr.positionedGlyphs;let ns=0;if(!ur.length()){Tt+=tt,++ai;continue}const Ri=N0(De,ur,zi);let os=0;for(const vi of ur.text){const jr=ur.getSection(os),li=vi.codePointAt(0),Zr=V0(Ae,lt,li),bi={glyph:li,imageName:null,x:nt,y:Tt+-17,vertical:Zr,scale:1,fontStack:"",sectionIndex:ur.getSectionIndex(os),metrics:null,rect:null};let Jn;if("fontStack"in jr){if(Jn=$0(jr,li,Zr,Ri,be,Le),!Jn)continue;bi.fontStack=jr.fontStack}else{if(ae.iconsInText=!0,jr.scale*=zi,Jn=U0(jr,Zr,Gr,Ri,De),!Jn)continue;ns=Math.max(ns,Jn.imageOffset),bi.imageName=jr.imageName}const{rect:en,metrics:du,baselineOffset:zo}=Jn;bi.y+=zo,bi.scale=jr.scale,bi.metrics=du,bi.rect=en,Er.push(bi),Zr?(ae.verticalizable=!0,nt+=("imageName"in jr?du.advance:_i)*jr.scale+ut):nt+=du.advance*jr.scale+ut,os++}Er.length!==0&&(ir=Math.max(nt-ut,ir),q0(Er,0,Er.length-1,Rr)),nt=0,Qr.lineOffset=Math.max(ns,(Gr-1)*_i);const qs=tt*Gr+ns;Tt+=qs,Gt=Math.max(qs,Gt),++ai}const{horizontalAlign:Fr,verticalAlign:Ar}=yp(qe);(function(ur,Gr,Qr,Er,ns,Ri,os,qs,vi){const jr=(Gr-Qr)*ns;let li=0;li=Ri!==os?-qs*Er- -17:-Er*vi*os+.5*os;for(const Zr of ur)for(const bi of Zr.positionedGlyphs)bi.x+=jr,bi.y+=li})(ae.positionedLines,Rr,Fr,Ar,ir,Gt,tt,Tt,Ne.length),ae.top+=-Ar*Tt,ae.bottom=ae.top+Tt,ae.left+=-Fr*ir,ae.right=ae.left+ir})(re,e,r,n,B,d,m,y,I,w,C,F),!(function(ae){for(const be of ae)if(be.positionedGlyphs.length!==0)return!1;return!0})(H)&&re}function yp(i){let e=.5,r=.5;switch(i){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(i){case"bottom":case"bottom-right":case"bottom-left":r=1;break;case"top":case"top-right":case"top-left":r=0}return{horizontalAlign:e,verticalAlign:r}}function N0(i,e,r){const n=e.getMaxScale()*_i,{maxImageWidth:a,maxImageHeight:h}=e.getMaxImageSize(i),d=Math.max(n,h*r);return{verticalLineContentWidth:Math.max(n,a*r),horizontalLineContentHeight:d}}function km(i){switch(i){case"top":return 0;case"center":return .5;default:return 1}}function V0(i,e,r){return!(i===S.az.horizontal||!e&&!Rc(r)||e&&(vh(r)||(n=r,new RegExp("\\p{sc=Arab}","u").test(String.fromCodePoint(n)))));var n}function $0(i,e,r,n,a,h){const d=h[i.fontStack],m=(function(w,P,I,C){if(w&&w.rect)return w;const D=P[I.fontStack],F=D&&D[C];return F?{rect:null,metrics:F.metrics}:null})(d&&d[e],a,i,e);if(m===null)return null;let y;if(r)y=n.verticalLineContentWidth-i.scale*_i;else{const w=km(i.verticalAlign);y=(n.horizontalLineContentHeight-i.scale*_i)*w}return{rect:m.rect,metrics:m.metrics,baselineOffset:y}}function U0(i,e,r,n,a){const h=a[i.imageName];if(!h)return null;const d=h.paddedRect,m=h.displaySize,y={width:m[0],height:m[1],left:1,top:-3,advance:e?m[1]:m[0]};let w;if(e)w=n.verticalLineContentWidth-m[1]*i.scale;else{const P=km(i.verticalAlign);w=(n.horizontalLineContentHeight-m[1]*i.scale)*P}return{rect:d,metrics:y,baselineOffset:w,imageOffset:(e?m[0]:m[1])*i.scale-_i*r}}function q0(i,e,r,n){if(n===0)return;const a=i[r],h=(i[r].x+a.metrics.advance*a.scale)*n;for(let d=e;d<=r;d++)i[d].x-=h}function G0(i,e,r){const{horizontalAlign:n,verticalAlign:a}=yp(r),h=e[0]-i.displaySize[0]*n,d=e[1]-i.displaySize[1]*a;return{image:i,top:d,bottom:d+i.displaySize[1],left:h,right:h+i.displaySize[0]}}function Dm(i){var e,r;let n=i.left,a=i.top,h=i.right-n,d=i.bottom-a;const m=(e=i.image.textFitWidth)!==null&&e!==void 0?e:"stretchOrShrink",y=(r=i.image.textFitHeight)!==null&&r!==void 0?r:"stretchOrShrink",w=(i.image.content[2]-i.image.content[0])/(i.image.content[3]-i.image.content[1]);if(y==="proportional"){if(m==="stretchOnly"&&h/d<w||m==="proportional"){const P=Math.ceil(d*w);n*=P/h,h=P}}else if(m==="proportional"&&y==="stretchOnly"&&w!==0&&h/d>w){const P=Math.ceil(h/w);a*=P/d,d=P}return{x1:n,y1:a,x2:n+h,y2:a+d}}function zm(i,e,r,n,a,h){const d=i.image;let m;if(d.content){const B=d.content,U=d.pixelRatio||1;m=[B[0]/U,B[1]/U,d.displaySize[0]-B[2]/U,d.displaySize[1]-B[3]/U]}const y=e.left*h,w=e.right*h;let P,I,C,D;r==="width"||r==="both"?(D=a[0]+y-n[3],I=a[0]+w+n[1]):(D=a[0]+(y+w-d.displaySize[0])/2,I=D+d.displaySize[0]);const F=e.top*h,L=e.bottom*h;return r==="height"||r==="both"?(P=a[1]+F-n[0],C=a[1]+L+n[2]):(P=a[1]+(F+L-d.displaySize[1])/2,C=P+d.displaySize[1]),{image:d,top:P,right:I,bottom:C,left:D,collisionPadding:m}}ht("ImagePosition",_p),ht("ImageAtlas",Cm),S.az=void 0,(Io=S.az||(S.az={}))[Io.none=0]="none",Io[Io.horizontal=1]="horizontal",Io[Io.vertical=2]="vertical",Io[Io.horizontalOnly=3]="horizontalOnly";const Xn=128,Ao=32640;function Rm(i,e){const{expression:r}=e;if(r.kind==="constant")return{kind:"constant",layoutSize:r.evaluate(new gr(i+1))};if(r.kind==="source")return{kind:"source"};{const{zoomStops:n,interpolationType:a}=r;let h=0;for(;h<n.length&&n[h]<=i;)h++;h=Math.max(0,h-1);let d=h;for(;d<n.length&&n[d]<i+1;)d++;d=Math.min(n.length-1,d);const m=n[h],y=n[d];return r.kind==="composite"?{kind:"composite",minZoom:m,maxZoom:y,interpolationType:a}:{kind:"camera",minZoom:m,maxZoom:y,minSize:r.evaluate(new gr(m)),maxSize:r.evaluate(new gr(y)),interpolationType:a}}}function xp(i,e,r){let n="never";const a=i.get(e);return a?n=a:i.get(r)&&(n="always"),n}const Z0=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Vh(i,e,r,n,a,h,d,m,y,w,P,I,C){const D=m?Math.min(Ao,Math.round(m[0])):0,F=m?Math.min(Ao,Math.round(m[1])):0;i.emplaceBack(e,r,Math.round(32*n),Math.round(32*a),h,d,(D<<1)+(y?1:0),F,16*w,16*P,256*I,256*C)}function vp(i,e,r){i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r),i.emplaceBack(e.x,e.y,r)}function H0(i){for(const e of i.sections)if(Th(e.text))return!0;return!1}class bp{constructor(e){this.layoutVertexArray=new ie,this.indexArray=new Ie,this.programConfigurations=e,this.segments=new it,this.dynamicLayoutVertexArray=new pe,this.opacityVertexArray=new Ce,this.hasVisibleVertices=!1,this.placedSymbolArray=new _}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(e,r,n,a){this.isEmpty()||(n&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,v0.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,r),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,b0.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,Z0,!0),this.opacityVertexBuffer.itemSize=1),(n||a)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}ht("SymbolBuffers",bp);class wp{constructor(e,r,n){this.layoutVertexArray=new e,this.layoutAttributes=r,this.indexArray=new n,this.segments=new it,this.collisionVertexArray=new Me}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,w0.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}ht("CollisionBuffers",wp);class Il{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((d=>d.id)),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasDependencies=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[];const r=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Rm(this.zoom,r["text-size"]),this.iconSizeData=Rm(this.zoom,r["icon-size"]);const n=this.layers[0].layout,a=n.get("symbol-sort-key"),h=n.get("symbol-z-order");this.canOverlap=xp(n,"text-overlap","text-allow-overlap")!=="never"||xp(n,"icon-overlap","icon-allow-overlap")!=="never"||n.get("text-ignore-placement")||n.get("icon-ignore-placement"),this.sortFeaturesByKey=h!=="viewport-y"&&!a.isConstant(),this.sortFeaturesByY=(h==="viewport-y"||h==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,n.get("symbol-placement")==="point"&&(this.writingModes=n.get("text-writing-mode").map((d=>S.az[d]))),this.stateDependentLayerIds=this.layers.filter((d=>d.isStateDependent())).map((d=>d.id)),this.sourceID=e.sourceID}createArrays(){this.text=new bp(new Wn(this.layers,this.zoom,(e=>/^text/.test(e)))),this.icon=new bp(new Wn(this.layers,this.zoom,(e=>/^icon/.test(e)))),this.glyphOffsetArray=new M,this.lineVertexArray=new A,this.symbolInstances=new T,this.textAnchorOffsets=new z}calculateGlyphDependencies(e,r,n,a,h){for(const d of e)if(r[d.codePointAt(0)]=!0,(n||a)&&h){const m=nu[d];m&&(r[m.codePointAt(0)]=!0)}}populate(e,r,n){const a=this.layers[0],h=a.layout,d=h.get("text-font"),m=h.get("text-field"),y=h.get("icon-image"),w=(m.value.kind!=="constant"||m.value.value instanceof Ji&&!m.value.value.isEmpty()||m.value.value.toString().length>0)&&(d.value.kind!=="constant"||d.value.value.length>0),P=y.value.kind!=="constant"||!!y.value.value||Object.keys(y.parameters).length>0,I=h.get("symbol-sort-key");if(this.features=[],!w&&!P)return;const C=r.iconDependencies,D=r.glyphDependencies,F=r.availableImages,L=new gr(this.zoom);for(const{feature:B,id:U,index:ee,sourceLayerIndex:q}of e){const H=a._featureFilter.needGeometry,re=Sn(B,H);if(!a._featureFilter.filter(L,re,n))continue;let ae,be;if(H||(re.geometry=Tn(B)),w){const De=a.getValueAndResolveTokens("text-field",re,n,F),Ne=Ji.factory(De),tt=this.hasRTLText=this.hasRTLText||H0(Ne);(!tt||vn.getRTLTextPluginStatus()==="unavailable"||tt&&vn.isParsed())&&(ae=S0(Ne,a,re))}if(P){const De=a.getValueAndResolveTokens("icon-image",re,n,F);be=De instanceof rs?De:rs.fromString(De)}if(!ae&&!be)continue;const Le=this.sortFeaturesByKey?I.evaluate(re,{},n):void 0;if(this.features.push({id:U,text:ae,icon:be,index:ee,sourceLayerIndex:q,geometry:re.geometry,properties:B.properties,type:ru.types[B.type],sortKey:Le}),be&&(C[be.name]=!0),ae){const De=d.evaluate(re,{},n).join(","),Ne=h.get("text-rotation-alignment")!=="viewport"&&h.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(S.az.vertical)>=0;for(const tt of ae.sections)if(tt.image)C[tt.image.name]=!0;else{const qe=Eo(ae.toString()),Re=tt.fontStack||De,Ae=D[Re]=D[Re]||{};this.calculateGlyphDependencies(tt.text,Ae,Ne,this.allowVerticalPlacement,qe)}}}h.get("symbol-placement")==="line"&&(this.features=(function(B){const U={},ee={},q=[];let H=0;function re(De){q.push(B[De]),H++}function ae(De,Ne,tt){const qe=ee[De];return delete ee[De],ee[Ne]=qe,q[qe].geometry[0].pop(),q[qe].geometry[0]=q[qe].geometry[0].concat(tt[0]),qe}function be(De,Ne,tt){const qe=U[Ne];return delete U[Ne],U[De]=qe,q[qe].geometry[0].shift(),q[qe].geometry[0]=tt[0].concat(q[qe].geometry[0]),qe}function Le(De,Ne,tt){const qe=tt?Ne[0][Ne[0].length-1]:Ne[0][0];return`${De}:${qe.x}:${qe.y}`}for(let De=0;De<B.length;De++){const Ne=B[De],tt=Ne.geometry,qe=Ne.text?Ne.text.toString():null;if(!qe){re(De);continue}const Re=Le(qe,tt),Ae=Le(qe,tt,!0);if(Re in ee&&Ae in U&&ee[Re]!==U[Ae]){const ut=be(Re,Ae,tt),lt=ae(Re,Ae,q[ut].geometry);delete U[Re],delete ee[Ae],ee[Le(qe,q[lt].geometry,!0)]=lt,q[ut].geometry=null}else Re in ee?ae(Re,Ae,tt):Ae in U?be(Re,Ae,tt):(re(De),U[Re]=H-1,ee[Ae]=H-1)}return q.filter((De=>De.geometry))})(this.features)),this.sortFeaturesByKey&&this.features.sort(((B,U)=>B.sortKey-U.sortKey))}update(e,r,n){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(e,r,this.layers,{imagePositions:n}),this.icon.programConfigurations.updatePaintArrays(e,r,this.layers,{imagePositions:n}))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,r){const n=this.lineVertexArray.length;if(e.segment!==void 0){let a=e.dist(r[e.segment+1]),h=e.dist(r[e.segment]);const d={};for(let m=e.segment+1;m<r.length;m++)d[m]={x:r[m].x,y:r[m].y,tileUnitDistanceFromAnchor:a},m<r.length-1&&(a+=r[m+1].dist(r[m]));for(let m=e.segment||0;m>=0;m--)d[m]={x:r[m].x,y:r[m].y,tileUnitDistanceFromAnchor:h},m>0&&(h+=r[m-1].dist(r[m]));for(let m=0;m<r.length;m++){const y=d[m];this.lineVertexArray.emplaceBack(y.x,y.y,y.tileUnitDistanceFromAnchor)}}return{lineStartIndex:n,lineLength:this.lineVertexArray.length-n}}addSymbols(e,r,n,a,h,d,m,y,w,P,I,C){const D=e.indexArray,F=e.layoutVertexArray,L=e.segments.prepareSegment(4*r.length,F,D,this.canOverlap?d.sortKey:void 0),B=this.glyphOffsetArray.length,U=L.vertexLength,ee=this.allowVerticalPlacement&&m===S.az.vertical?Math.PI/2:0,q=d.text&&d.text.sections;for(let H=0;H<r.length;H++){const{tl:re,tr:ae,bl:be,br:Le,tex:De,pixelOffsetTL:Ne,pixelOffsetBR:tt,minFontScaleX:qe,minFontScaleY:Re,glyphOffset:Ae,isSDF:ut,sectionIndex:lt}=r[H],dt=L.vertexLength,nt=Ae[1];Vh(F,y.x,y.y,re.x,nt+re.y,De.x,De.y,n,ut,Ne.x,Ne.y,qe,Re),Vh(F,y.x,y.y,ae.x,nt+ae.y,De.x+De.w,De.y,n,ut,tt.x,Ne.y,qe,Re),Vh(F,y.x,y.y,be.x,nt+be.y,De.x,De.y+De.h,n,ut,Ne.x,tt.y,qe,Re),Vh(F,y.x,y.y,Le.x,nt+Le.y,De.x+De.w,De.y+De.h,n,ut,tt.x,tt.y,qe,Re),vp(e.dynamicLayoutVertexArray,y,ee),D.emplaceBack(dt,dt+2,dt+1),D.emplaceBack(dt+1,dt+2,dt+3),L.vertexLength+=4,L.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Ae[0]),H!==r.length-1&&lt===r[H+1].sectionIndex||e.programConfigurations.populatePaintArrays(F.length,d,d.index,{imagePositions:{},canonical:C,formattedSection:q&&q[lt]})}e.placedSymbolArray.emplaceBack(y.x,y.y,B,this.glyphOffsetArray.length-B,U,w,P,y.segment,n?n[0]:0,n?n[1]:0,a[0],a[1],m,0,!1,0,I)}_addCollisionDebugVertex(e,r,n,a,h,d){return r.emplaceBack(0,0),e.emplaceBack(n.x,n.y,a,h,Math.round(d.x),Math.round(d.y))}addCollisionDebugVertices(e,r,n,a,h,d,m){const y=h.segments.prepareSegment(4,h.layoutVertexArray,h.indexArray),w=y.vertexLength,P=h.layoutVertexArray,I=h.collisionVertexArray,C=m.anchorX,D=m.anchorY;this._addCollisionDebugVertex(P,I,d,C,D,new $(e,r)),this._addCollisionDebugVertex(P,I,d,C,D,new $(n,r)),this._addCollisionDebugVertex(P,I,d,C,D,new $(n,a)),this._addCollisionDebugVertex(P,I,d,C,D,new $(e,a)),y.vertexLength+=4;const F=h.indexArray;F.emplaceBack(w,w+1),F.emplaceBack(w+1,w+2),F.emplaceBack(w+2,w+3),F.emplaceBack(w+3,w),y.primitiveLength+=4}addDebugCollisionBoxes(e,r,n,a){for(let h=e;h<r;h++){const d=this.collisionBoxArray.get(h);this.addCollisionDebugVertices(d.x1,d.y1,d.x2,d.y2,a?this.textCollisionBox:this.iconCollisionBox,d.anchorPoint,n)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new wp(Pe,bm.members,Xe),this.iconCollisionBox=new wp(Pe,bm.members,Xe);for(let e=0;e<this.symbolInstances.length;e++){const r=this.symbolInstances.get(e);this.addDebugCollisionBoxes(r.textBoxStartIndex,r.textBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.verticalTextBoxStartIndex,r.verticalTextBoxEndIndex,r,!0),this.addDebugCollisionBoxes(r.iconBoxStartIndex,r.iconBoxEndIndex,r,!1),this.addDebugCollisionBoxes(r.verticalIconBoxStartIndex,r.verticalIconBoxEndIndex,r,!1)}}_deserializeCollisionBoxesForSymbol(e,r,n,a,h,d,m,y,w){const P={};for(let I=r;I<n;I++){const C=e.get(I);P.textBox={x1:C.x1,y1:C.y1,x2:C.x2,y2:C.y2,anchorPointX:C.anchorPointX,anchorPointY:C.anchorPointY},P.textFeatureIndex=C.featureIndex;break}for(let I=a;I<h;I++){const C=e.get(I);P.verticalTextBox={x1:C.x1,y1:C.y1,x2:C.x2,y2:C.y2,anchorPointX:C.anchorPointX,anchorPointY:C.anchorPointY},P.verticalTextFeatureIndex=C.featureIndex;break}for(let I=d;I<m;I++){const C=e.get(I);P.iconBox={x1:C.x1,y1:C.y1,x2:C.x2,y2:C.y2,anchorPointX:C.anchorPointX,anchorPointY:C.anchorPointY},P.iconFeatureIndex=C.featureIndex;break}for(let I=y;I<w;I++){const C=e.get(I);P.verticalIconBox={x1:C.x1,y1:C.y1,x2:C.x2,y2:C.y2,anchorPointX:C.anchorPointX,anchorPointY:C.anchorPointY},P.verticalIconFeatureIndex=C.featureIndex;break}return P}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let r=0;r<this.symbolInstances.length;r++){const n=this.symbolInstances.get(r);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,n.textBoxStartIndex,n.textBoxEndIndex,n.verticalTextBoxStartIndex,n.verticalTextBoxEndIndex,n.iconBoxStartIndex,n.iconBoxEndIndex,n.verticalIconBoxStartIndex,n.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(e,r){const n=e.placedSymbolArray.get(r),a=n.vertexStartIndex+4*n.numGlyphs;for(let h=n.vertexStartIndex;h<a;h+=4)e.indexArray.emplaceBack(h,h+2,h+1),e.indexArray.emplaceBack(h+1,h+2,h+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const r=Math.sin(e),n=Math.cos(e),a=[],h=[],d=[];for(let m=0;m<this.symbolInstances.length;++m){d.push(m);const y=this.symbolInstances.get(m);a.push(0|Math.round(r*y.anchorX+n*y.anchorY)),h.push(y.featureIndex)}return d.sort(((m,y)=>a[m]-a[y]||h[y]-h[m])),d}addToSortKeyRanges(e,r){const n=this.sortKeyRanges[this.sortKeyRanges.length-1];n&&n.sortKey===r?n.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:r,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const r of this.symbolInstanceIndexes){const n=this.symbolInstances.get(r);this.featureSortOrder.push(n.featureIndex),[n.rightJustifiedTextSymbolIndex,n.centerJustifiedTextSymbolIndex,n.leftJustifiedTextSymbolIndex].forEach(((a,h,d)=>{a>=0&&d.indexOf(a)===h&&this.addIndicesForPlacedSymbol(this.text,a)})),n.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,n.verticalPlacedTextSymbolIndex),n.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,n.placedIconSymbolIndex),n.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,n.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Fm,Lm;ht("SymbolBucket",Il,{omit:["layers","collisionBoxArray","features","compareText"]}),Il.MAX_GLYPHS=65535,Il.addDynamicAttributes=vp;var Tp={get paint(){return Lm=Lm||new qi({"icon-opacity":new Et(Se.paint_symbol["icon-opacity"]),"icon-color":new Et(Se.paint_symbol["icon-color"]),"icon-halo-color":new Et(Se.paint_symbol["icon-halo-color"]),"icon-halo-width":new Et(Se.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Et(Se.paint_symbol["icon-halo-blur"]),"icon-translate":new bt(Se.paint_symbol["icon-translate"]),"icon-translate-anchor":new bt(Se.paint_symbol["icon-translate-anchor"]),"text-opacity":new Et(Se.paint_symbol["text-opacity"]),"text-color":new Et(Se.paint_symbol["text-color"],{runtimeType:Pi,getOverride:i=>i.textColor,hasOverride:i=>!!i.textColor}),"text-halo-color":new Et(Se.paint_symbol["text-halo-color"]),"text-halo-width":new Et(Se.paint_symbol["text-halo-width"]),"text-halo-blur":new Et(Se.paint_symbol["text-halo-blur"]),"text-translate":new bt(Se.paint_symbol["text-translate"]),"text-translate-anchor":new bt(Se.paint_symbol["text-translate-anchor"])})},get layout(){return Fm=Fm||new qi({"symbol-placement":new bt(Se.layout_symbol["symbol-placement"]),"symbol-spacing":new bt(Se.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new bt(Se.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Et(Se.layout_symbol["symbol-sort-key"]),"symbol-z-order":new bt(Se.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new bt(Se.layout_symbol["icon-allow-overlap"]),"icon-overlap":new bt(Se.layout_symbol["icon-overlap"]),"icon-ignore-placement":new bt(Se.layout_symbol["icon-ignore-placement"]),"icon-optional":new bt(Se.layout_symbol["icon-optional"]),"icon-rotation-alignment":new bt(Se.layout_symbol["icon-rotation-alignment"]),"icon-size":new Et(Se.layout_symbol["icon-size"]),"icon-text-fit":new bt(Se.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new bt(Se.layout_symbol["icon-text-fit-padding"]),"icon-image":new Et(Se.layout_symbol["icon-image"]),"icon-rotate":new Et(Se.layout_symbol["icon-rotate"]),"icon-padding":new Et(Se.layout_symbol["icon-padding"]),"icon-keep-upright":new bt(Se.layout_symbol["icon-keep-upright"]),"icon-offset":new Et(Se.layout_symbol["icon-offset"]),"icon-anchor":new Et(Se.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new bt(Se.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new bt(Se.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new bt(Se.layout_symbol["text-rotation-alignment"]),"text-field":new Et(Se.layout_symbol["text-field"]),"text-font":new Et(Se.layout_symbol["text-font"]),"text-size":new Et(Se.layout_symbol["text-size"]),"text-max-width":new Et(Se.layout_symbol["text-max-width"]),"text-line-height":new bt(Se.layout_symbol["text-line-height"]),"text-letter-spacing":new Et(Se.layout_symbol["text-letter-spacing"]),"text-justify":new Et(Se.layout_symbol["text-justify"]),"text-radial-offset":new Et(Se.layout_symbol["text-radial-offset"]),"text-variable-anchor":new bt(Se.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new Et(Se.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new Et(Se.layout_symbol["text-anchor"]),"text-max-angle":new bt(Se.layout_symbol["text-max-angle"]),"text-writing-mode":new bt(Se.layout_symbol["text-writing-mode"]),"text-rotate":new Et(Se.layout_symbol["text-rotate"]),"text-padding":new bt(Se.layout_symbol["text-padding"]),"text-keep-upright":new bt(Se.layout_symbol["text-keep-upright"]),"text-transform":new Et(Se.layout_symbol["text-transform"]),"text-offset":new Et(Se.layout_symbol["text-offset"]),"text-allow-overlap":new bt(Se.layout_symbol["text-allow-overlap"]),"text-overlap":new bt(Se.layout_symbol["text-overlap"]),"text-ignore-placement":new bt(Se.layout_symbol["text-ignore-placement"]),"text-optional":new bt(Se.layout_symbol["text-optional"])})}};class Om{constructor(e){if(e.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=e.property.overrides?e.property.overrides.runtimeType:Wr,this.defaultValue=e}evaluate(e){if(e.formattedSection){const r=this.defaultValue.property.overrides;if(r&&r.hasOverride(e.formattedSection))return r.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}ht("FormatSectionOverride",Om,{omit:["defaultValue"]});class $h extends fs{constructor(e,r){super(e,Tp,r)}recalculate(e,r){if(super.recalculate(e,r),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const n=this.layout.get("text-writing-mode");if(n){const a=[];for(const h of n)a.indexOf(h)<0&&a.push(h);this.layout._values["text-writing-mode"]=a}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(e,r,n,a){const h=this.layout.get(e).evaluate(r,{},n,a),d=this._unevaluatedLayout._values[e];return d.isDataDriven()||bo(d.value)||!h?h:(function(m,y){return y.replace(/{([^{}]+)}/g,((w,P)=>m&&P in m?String(m[P]):""))})(r.properties,h)}createBucket(e){return new Il(e)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const e of Tp.paint.overridableProperties){if(!$h.hasPaintOverride(this.layout,e))continue;const r=this.paint.get(e),n=new Om(r),a=new wc(n,r.property.specification);let h=null;h=r.value.kind==="constant"||r.value.kind==="source"?new Qa("source",a):new Tc("composite",a,r.value.zoomStops),this.paint._values[e]=new Ps(r.property,h,r.parameters)}}_handleOverridablePaintPropertyUpdate(e,r,n){return!(!this.layout||r.isDataDriven()||n.isDataDriven())&&$h.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,r){const n=e.get("text-field"),a=Tp.paint.properties[r];let h=!1;const d=m=>{for(const y of m)if(a.overrides&&a.overrides.hasOverride(y))return void(h=!0)};if(n.value.kind==="constant"&&n.value.value instanceof Ji)d(n.value.value.sections);else if(n.value.kind==="source"||n.value.kind==="composite"){const m=w=>{h||(w instanceof Ns&&Xr(w.value)===G?d(w.value.sections):w instanceof Ho?d(w.sections):w.eachChild(m))},y=n.value;y._styleExpression&&m(y._styleExpression.expression)}return h}}let Bm;var W0={get paint(){return Bm=Bm||new qi({"background-color":new bt(Se.paint_background["background-color"]),"background-pattern":new hl(Se.paint_background["background-pattern"]),"background-opacity":new bt(Se.paint_background["background-opacity"])})}};class X0 extends fs{constructor(e,r){super(e,W0,r)}}class Y0 extends fs{constructor(e,r){super(e,{},r),this.onAdd=n=>{this.implementation.onAdd&&this.implementation.onAdd(n,n.painter.context.gl)},this.onRemove=n=>{this.implementation.onRemove&&this.implementation.onRemove(n,n.painter.context.gl)},this.implementation=e}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class J0{constructor(e){this._methodToThrottle=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._methodToThrottle()}),0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const K0={once:!0},Sp=63710088e-1;class Co{constructor(e,r){if(isNaN(e)||isNaN(r))throw new Error(`Invalid LngLat object: (${e}, ${r})`);if(this.lng=+e,this.lat=+r,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Co(ii(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const r=Math.PI/180,n=this.lat*r,a=e.lat*r,h=Math.sin(n)*Math.sin(a)+Math.cos(n)*Math.cos(a)*Math.cos((e.lng-this.lng)*r);return Sp*Math.acos(Math.min(h,1))}static convert(e){if(e instanceof Co)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new Co(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new Co(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const jm=2*Math.PI*Sp;function Nm(i){return jm*Math.cos(i*Math.PI/180)}function Vm(i){return(180+i)/360}function $m(i){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+i*Math.PI/360)))/360}function Um(i,e){return i/Nm(e)}function qm(i){return 360*i-180}function Uh(i){return 360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90}function Gm(i,e){return i*Nm(Uh(e))}class ou{constructor(e,r,n=0){this.x=+e,this.y=+r,this.z=+n}static fromLngLat(e,r=0){const n=Co.convert(e);return new ou(Vm(n.lng),$m(n.lat),Um(r,n.lat))}toLngLat(){return new Co(qm(this.x),Uh(this.y))}toAltitude(){return Gm(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/jm*(e=Uh(this.y),1/Math.cos(e*Math.PI/180));var e}}function Zm(i,e,r){var n=2*Math.PI*6378137/256/Math.pow(2,r);return[i*n-2*Math.PI*6378137/2,e*n-2*Math.PI*6378137/2]}class Pp{constructor(e,r,n){if(!(function(a,h,d){return!(a<0||a>25||d<0||d>=Math.pow(2,a)||h<0||h>=Math.pow(2,a))})(e,r,n))throw new Error(`x=${r}, y=${n}, z=${e} outside of bounds. 0<=x<${Math.pow(2,e)}, 0<=y<${Math.pow(2,e)} 0<=z<=25 `);this.z=e,this.x=r,this.y=n,this.key=Al(0,e,e,r,n)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,r,n){const a=(function(d,m,y){var w=Zm(256*d,256*(m=Math.pow(2,y)-m-1),y),P=Zm(256*(d+1),256*(m+1),y);return w[0]+","+w[1]+","+P[0]+","+P[1]})(this.x,this.y,this.z),h=(function(d,m,y){let w,P="";for(let I=d;I>0;I--)w=1<<I-1,P+=(m&w?1:0)+(y&w?2:0);return P})(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(n==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,r>1?"@2x":"").replace(/{quadkey}/g,h).replace(/{bbox-epsg-3857}/g,a)}isChildOf(e){const r=this.z-e.z;return r>0&&e.x===this.x>>r&&e.y===this.y>>r}getTilePoint(e){const r=Math.pow(2,this.z);return new $((e.x*r-this.x)*Ct,(e.y*r-this.y)*Ct)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Hm{constructor(e,r){this.wrap=e,this.canonical=r,this.key=Al(e,r.z,r.z,r.x,r.y)}}class Is{constructor(e,r,n,a,h){if(this.terrainRttPosMatrix32f=null,e<n)throw new Error(`overscaledZ should be >= z; overscaledZ = ${e}; z = ${n}`);this.overscaledZ=e,this.wrap=r,this.canonical=new Pp(n,+a,+h),this.key=Al(r,e,n,a,h)}clone(){return new Is(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const r=this.canonical.z-e;return e>this.canonical.z?new Is(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Is(e,this.wrap,e,this.canonical.x>>r,this.canonical.y>>r)}isOverscaled(){return this.overscaledZ>this.canonical.z}calculateScaledKey(e,r){if(e>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${e}; overscaledZ = ${this.overscaledZ}`);const n=this.canonical.z-e;return e>this.canonical.z?Al(this.wrap*+r,e,this.canonical.z,this.canonical.x,this.canonical.y):Al(this.wrap*+r,e,e,this.canonical.x>>n,this.canonical.y>>n)}isChildOf(e){if(e.wrap!==this.wrap||this.overscaledZ-e.overscaledZ<=0)return!1;if(e.overscaledZ===0)return this.overscaledZ>0;const r=this.canonical.z-e.canonical.z;return!(r<0)&&e.canonical.x===this.canonical.x>>r&&e.canonical.y===this.canonical.y>>r}children(e){if(this.overscaledZ>=e)return[new Is(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const r=this.canonical.z+1,n=2*this.canonical.x,a=2*this.canonical.y;return[new Is(r,this.wrap,r,n,a),new Is(r,this.wrap,r,n+1,a),new Is(r,this.wrap,r,n,a+1),new Is(r,this.wrap,r,n+1,a+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Is(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Is(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Hm(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(e){return this.canonical.getTilePoint(new ou(e.x-this.wrap,e.y))}}function Al(i,e,r,n,a){(i*=2)<0&&(i=-1*i-1);const h=1<<r;return(h*h*i+h*a+n).toString(36)+r.toString(36)+e.toString(36)}function Ep(i,e){return e?i.properties[e]:i.id}function Q0(i,e){const r={id:i.id};if(e.removeAllProperties&&(delete i.removeProperties,delete i.addOrUpdateProperties,delete e.removeProperties),e.removeProperties)for(const n of e.removeProperties){const a=i.addOrUpdateProperties.findIndex((h=>h.key===n));a>-1&&i.addOrUpdateProperties.splice(a,1)}return(i.removeAllProperties||e.removeAllProperties)&&(r.removeAllProperties=!0),(i.removeProperties||e.removeProperties)&&(r.removeProperties=[...i.removeProperties||[],...e.removeProperties||[]]),(i.addOrUpdateProperties||e.addOrUpdateProperties)&&(r.addOrUpdateProperties=[...i.addOrUpdateProperties||[],...e.addOrUpdateProperties||[]]),(i.newGeometry||e.newGeometry)&&(r.newGeometry=e.newGeometry||i.newGeometry),r}function Wm(i){var e,r;if(!i)return{};const n={};return n.removeAll=i.removeAll,n.remove=new Set(i.remove||[]),n.add=new Map((e=i.add)===null||e===void 0?void 0:e.map((a=>[a.id,a]))),n.update=new Map((r=i.update)===null||r===void 0?void 0:r.map((a=>[a.id,a]))),n}ht("CanonicalTileID",Pp),ht("OverscaledTileID",Is,{omit:["terrainRttPosMatrix32f"]});class Sa{constructor(){this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0}extend(e){return this.minX=Math.min(this.minX,e.x),this.minY=Math.min(this.minY,e.y),this.maxX=Math.max(this.maxX,e.x),this.maxY=Math.max(this.maxY,e.y),this}expandBy(e){return this.minX-=e,this.minY-=e,this.maxX+=e,this.maxY+=e,(this.minX>this.maxX||this.minY>this.maxY)&&(this.minX=1/0,this.maxX=-1/0,this.minY=1/0,this.maxY=-1/0),this}shrinkBy(e){return this.expandBy(-e)}map(e){const r=new Sa;return r.extend(e(new $(this.minX,this.minY))),r.extend(e(new $(this.maxX,this.minY))),r.extend(e(new $(this.minX,this.maxY))),r.extend(e(new $(this.maxX,this.maxY))),r}static fromPoints(e){const r=new Sa;for(const n of e)r.extend(n);return r}contains(e){return e.x>=this.minX&&e.x<=this.maxX&&e.y>=this.minY&&e.y<=this.maxY}empty(){return this.minX>this.maxX}width(){return this.maxX-this.minX}height(){return this.maxY-this.minY}covers(e){return!this.empty()&&!e.empty()&&e.minX>=this.minX&&e.maxX<=this.maxX&&e.minY>=this.minY&&e.maxY<=this.maxY}intersects(e){return!this.empty()&&!e.empty()&&e.minX<=this.maxX&&e.maxX>=this.minX&&e.minY<=this.maxY&&e.maxY>=this.minY}}class Xm{constructor(e){this._stringToNumber={},this._numberToString=[];for(let r=0;r<e.length;r++){const n=e[r];this._stringToNumber[n]=r,this._numberToString[r]=n}}encode(e){return this._stringToNumber[e]}decode(e){if(e>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${e} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[e]}}class Ym{constructor(e,r,n,a,h){this.type="Feature",this._vectorTileFeature=e,this._x=n,this._y=a,this._z=r,this.properties=e.properties,this.id=h}projectPoint(e,r,n,a){return[360*(e.x+r)/a-180,360/Math.PI*Math.atan(Math.exp((1-2*(e.y+n)/a)*Math.PI))-90]}projectLine(e,r,n,a){return e.map((h=>this.projectPoint(h,r,n,a)))}get geometry(){if(this._geometry)return this._geometry;const e=this._vectorTileFeature,r=e.extent*Math.pow(2,this._z),n=e.extent*this._x,a=e.extent*this._y,h=e.loadGeometry();switch(e.type){case 1:{const d=[];for(const y of h)d.push(y[0]);const m=this.projectLine(d,n,a,r);this._geometry=d.length===1?{type:"Point",coordinates:m[0]}:{type:"MultiPoint",coordinates:m};break}case 2:{const d=h.map((m=>this.projectLine(m,n,a,r)));this._geometry=d.length===1?{type:"LineString",coordinates:d[0]}:{type:"MultiLineString",coordinates:d};break}case 3:{const d=hm(h),m=[];for(const y of d)m.push(y.map((w=>this.projectLine(w,n,a,r))));this._geometry=m.length===1?{type:"Polygon",coordinates:m[0]}:{type:"MultiPolygon",coordinates:m};break}default:throw new Error(`unknown feature type: ${e.type}`)}return this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={geometry:this.geometry};for(const r in this)r!=="_geometry"&&r!=="_vectorTileFeature"&&r!=="_x"&&r!=="_y"&&r!=="_z"&&(e[r]=this[r]);return e}}class Cl{_name;dataBuffer;nullabilityBuffer;_size;constructor(e,r,n){this._name=e,this.dataBuffer=r,typeof n=="number"?this._size=n:(this.nullabilityBuffer=n,this._size=n.size())}getValue(e){return this.nullabilityBuffer&&!this.nullabilityBuffer.get(e)?null:this.getValueFromBuffer(e)}has(e){return this.nullabilityBuffer&&this.nullabilityBuffer.get(e)||!this.nullabilityBuffer}get name(){return this._name}get size(){return this._size}}class qh extends Cl{}class Mp extends qh{getValueFromBuffer(e){return this.dataBuffer[e]}}class Ip extends qh{getValueFromBuffer(e){return this.dataBuffer[e]}}class Jm extends Cl{delta;constructor(e,r,n,a){super(e,r,a),this.delta=n}}class Ap extends Jm{constructor(e,r,n,a){super(e,Int32Array.of(r),n,a)}getValueFromBuffer(e){return this.dataBuffer[0]+e*this.delta}}class Cp extends Cl{constructor(e,r,n){super(e,Int32Array.of(r),n)}getValueFromBuffer(e){return this.dataBuffer[0]}}class ex{_name;_geometryVector;_idVector;_propertyVectors;_extent;propertyVectorsMap;constructor(e,r,n,a,h=4096){this._name=e,this._geometryVector=r,this._idVector=n,this._propertyVectors=a,this._extent=h}get name(){return this._name}get idVector(){return this._idVector}get geometryVector(){return this._geometryVector}get propertyVectors(){return this._propertyVectors}getPropertyVector(e){return this.propertyVectorsMap||(this.propertyVectorsMap=new Map(this._propertyVectors.map((r=>[r.name,r])))),this.propertyVectorsMap.get(e)}*[Symbol.iterator](){const e=this.geometryVector[Symbol.iterator]();let r=0;for(;r<this.numFeatures;){let n;this.idVector&&(n=this.containsMaxSaveIntegerValues(this.idVector)?Number(this.idVector.getValue(r)):this.idVector.getValue(r));const a=e?.next().value,h={};for(const d of this.propertyVectors){if(!d)continue;const m=d.name,y=d.getValue(r);y!==null&&(h[m]=y)}r++,yield{id:n,geometry:a,properties:h}}}get numFeatures(){return this.geometryVector.numGeometries}get extent(){return this._extent}getFeatures(){const e=[],r=this.geometryVector.getGeometries();for(let n=0;n<this.numFeatures;n++){let a;this.idVector&&(a=this.containsMaxSaveIntegerValues(this.idVector)?Number(this.idVector.getValue(n)):this.idVector.getValue(n));const h={coordinates:r[n],type:this.geometryVector.geometryType(n)},d={};for(const m of this.propertyVectors){if(!m)continue;const y=m.name,w=m.getValue(n);w!==null&&(d[y]=w)}e.push({id:a,geometry:h,properties:d})}return e}containsMaxSaveIntegerValues(e){return e instanceof Mp||e instanceof Cp&&e instanceof Ap||e instanceof Ip}}class tx{value;constructor(e){this.value=e}get(){return this.value}set(e){this.value=e}increment(){return this.value++}add(e){this.value+=e}}var Yt,Yn,ki,Ks,Pa,gs,yi,xi,Km,As;function Mi(i,e,r){const n=new Int32Array(r);let a=0,h=e.get();for(let d=0;d<n.length;d++){let m=i[h++],y=127&m;m<128||(m=i[h++],y|=(127&m)<<7,m<128||(m=i[h++],y|=(127&m)<<14,m<128||(m=i[h++],y|=(127&m)<<21,m<128||(m=i[h++],y|=(15&m)<<28)))),n[a++]=y}return e.set(h),n}function Gh(i,e,r){const n=new BigInt64Array(r);for(let a=0;a<n.length;a++)n[a]=ix(i,e);return n}function rx(i,e){let r,n;return n=i[e.get()],e.increment(),r=127&n,n<128?r:(n=i[e.get()],e.increment(),r|=(127&n)<<7,n<128?r:(n=i[e.get()],e.increment(),r|=(127&n)<<14,n<128?r:(n=i[e.get()],e.increment(),r|=(127&n)<<21,n<128?r:(n=i[e.get()],r|=(15&n)<<28,(function(a,h,d){let m,y;if(y=h[d.get()],d.increment(),m=(112&y)>>4,y<128||(y=h[d.get()],d.increment(),m|=(127&y)<<3,y<128)||(y=h[d.get()],d.increment(),m|=(127&y)<<10,y<128)||(y=h[d.get()],d.increment(),m|=(127&y)<<17,y<128)||(y=h[d.get()],d.increment(),m|=(127&y)<<24,y<128)||(y=h[d.get()],d.increment(),m|=(1&y)<<31,y<128))return 4294967296*m+(a>>>0);throw new Error("Expected varint not more than 10 bytes")})(r,i,e)))))}function Qm(i,e,r,n){throw new Error("FastPFor is not implemented yet.")}function Ea(i){return i>>>1^-(1&i)}function kl(i){return i>>1n^-(1n&i)}function ix(i,e){let r=0n,n=0,a=e.get();for(;a<i.length;){const h=i[a++];if(r|=BigInt(127&h)<<BigInt(n),!(128&h))break;if(n+=7,n>=64)throw new Error("Varint too long")}return e.set(a),r}function eg(i,e,r){const n=new Int32Array(r);let a=0;for(let h=0;h<e;h++){const d=i[h];n.fill(i[h+e],a,a+d),a+=d}return n}function tg(i,e,r){const n=new BigInt64Array(r);let a=0;for(let h=0;h<e;h++){const d=Number(i[h]);n.fill(i[h+e],a,a+d),a+=d}return n}function rg(i,e,r){const n=new Float64Array(r);let a=0;for(let h=0;h<e;h++){const d=i[h];n.fill(i[h+e],a,a+d),a+=d}return n}function kp(i){const e=i.length/4*4;let r=1;if(e>=4)for(let n=i[0];r<e-4;r+=4)n=i[r]+=n,n=i[r+1]+=n,n=i[r+2]+=n,n=i[r+3]+=n;for(;r!=i.length;)i[r]+=i[r-1],++r}function ig(i){i[0]=i[0]>>>1^-(1&i[0]),i[1]=i[1]>>>1^-(1&i[1]);const e=i.length/4*4;let r=2;if(e>=4)for(;r<e-4;r+=4){const n=i[r],a=i[r+1],h=i[r+2],d=i[r+3];i[r]=(n>>>1^-(1&n))+i[r-2],i[r+1]=(a>>>1^-(1&a))+i[r-1],i[r+2]=(h>>>1^-(1&h))+i[r],i[r+3]=(d>>>1^-(1&d))+i[r+1]}for(;r!=i.length;r+=2)i[r]=(i[r]>>>1^-(1&i[r]))+i[r-2],i[r+1]=(i[r+1]>>>1^-(1&i[r+1]))+i[r-1]}(function(i){i.NONE="NONE",i.DELTA="DELTA",i.COMPONENTWISE_DELTA="COMPONENTWISE_DELTA",i.RLE="RLE",i.MORTON="MORTON",i.PDE="PDE"})(Yt||(Yt={})),(function(i){i.NONE="NONE",i.FAST_PFOR="FAST_PFOR",i.VARINT="VARINT",i.ALP="ALP"})(Yn||(Yn={})),(function(i){i.PRESENT="PRESENT",i.DATA="DATA",i.OFFSET="OFFSET",i.LENGTH="LENGTH"})(ki||(ki={}));class Dp{_dictionaryType;_offsetType;_lengthType;constructor(e,r,n){this._dictionaryType=e,this._offsetType=r,this._lengthType=n}get dictionaryType(){return this._dictionaryType}get offsetType(){return this._offsetType}get lengthType(){return this._lengthType}}function es(i,e){const r=(function(n,a){const h=n[a.get()],d=Object.values(ki)[h>>4];let m=null;switch(d){case ki.DATA:m=new Dp(Object.values(Ks)[15&h]);break;case ki.OFFSET:m=new Dp(null,Object.values(Pa)[15&h]);break;case ki.LENGTH:m=new Dp(null,null,Object.values(gs)[15&h])}a.increment();const y=n[a.get()],w=Object.values(Yt)[y>>5],P=Object.values(Yt)[y>>2&7],I=Object.values(Yn)[3&y];a.increment();const C=Mi(n,a,2),D=C[0];return{physicalStreamType:d,logicalStreamType:m,logicalLevelTechnique1:w,logicalLevelTechnique2:P,physicalLevelTechnique:I,numValues:D,byteLength:C[1],decompressedCount:D}})(i,e);return r.logicalLevelTechnique1===Yt.MORTON?(function(n,a,h){const d=Mi(a,h,2);return{physicalStreamType:n.physicalStreamType,logicalStreamType:n.logicalStreamType,logicalLevelTechnique1:n.logicalLevelTechnique1,logicalLevelTechnique2:n.logicalLevelTechnique2,physicalLevelTechnique:n.physicalLevelTechnique,numValues:n.numValues,byteLength:n.byteLength,decompressedCount:n.decompressedCount,numBits:d[0],coordinateShift:d[1]}})(r,i,e):Yt.RLE!==r.logicalLevelTechnique1&&Yt.RLE!==r.logicalLevelTechnique2||Yn.NONE===r.physicalLevelTechnique?r:(function(n,a,h){const d=Mi(a,h,2);return{physicalStreamType:n.physicalStreamType,logicalStreamType:n.logicalStreamType,logicalLevelTechnique1:n.logicalLevelTechnique1,logicalLevelTechnique2:n.logicalLevelTechnique2,physicalLevelTechnique:n.physicalLevelTechnique,numValues:n.numValues,byteLength:n.byteLength,decompressedCount:d[1],runs:d[0],numRleValues:d[1]}})(r,i,e)}(function(i){i.NONE="NONE",i.SINGLE="SINGLE",i.SHARED="SHARED",i.VERTEX="VERTEX",i.MORTON="MORTON",i.FSST="FSST"})(Ks||(Ks={})),(function(i){i.VERTEX="VERTEX",i.INDEX="INDEX",i.STRING="STRING",i.KEY="KEY"})(Pa||(Pa={})),(function(i){i.VAR_BINARY="VAR_BINARY",i.GEOMETRIES="GEOMETRIES",i.PARTS="PARTS",i.RINGS="RINGS",i.TRIANGLES="TRIANGLES",i.SYMBOL="SYMBOL",i.DICTIONARY="DICTIONARY"})(gs||(gs={})),(function(i){i[i.FLAT=0]="FLAT",i[i.CONST=1]="CONST",i[i.SEQUENCE=2]="SEQUENCE",i[i.DICTIONARY=3]="DICTIONARY",i[i.FSST_DICTIONARY=4]="FSST_DICTIONARY"})(yi||(yi={}));class Qs{values;_size;constructor(e,r){this.values=e,this._size=r}get(e){const r=Math.floor(e/8);return(this.values[r]>>e%8&1)==1}set(e,r){const n=Math.floor(e/8);this.values[n]=this.values[n]|(r?1:0)<<e%8}getInt(e){const r=Math.floor(e/8);return this.values[r]>>e%8&1}size(){return this._size}getBuffer(){return this.values}}function ts(i,e,r,n,a){return(function(h,d,m){switch(d.logicalLevelTechnique1){case Yt.DELTA:return d.logicalLevelTechnique2===Yt.RLE?(function(y,w,P){const I=new Int32Array(P);let C=0,D=0;for(let F=0;F<w;F++){const L=y[F],B=Ea(y[F+w]);for(let U=0;U<L;U++)D+=B,I[C++]=D}return I})(h,d.runs,d.numRleValues):((function(y){y[0]=y[0]>>>1^-(1&y[0]);const w=y.length/4*4;let P=1;if(w>=4)for(;P<w-4;P+=4){const I=y[P],C=y[P+1],D=y[P+2],F=y[P+3];y[P]=(I>>>1^-(1&I))+y[P-1],y[P+1]=(C>>>1^-(1&C))+y[P],y[P+2]=(D>>>1^-(1&D))+y[P+1],y[P+3]=(F>>>1^-(1&F))+y[P+2]}for(;P!=y.length;++P)y[P]=(y[P]>>>1^-(1&y[P]))+y[P-1]})(h),h);case Yt.RLE:return(function(y,w,P){return P?(function(I,C,D){const F=new Int32Array(D);let L=0;for(let B=0;B<C;B++){const U=I[B];let ee=I[B+C];ee=ee>>>1^-(1&ee),F.fill(ee,L,L+U),L+=U}return F})(y,w.runs,w.numRleValues):eg(y,w.runs,w.numRleValues)})(h,d,m);case Yt.MORTON:return kp(h),h;case Yt.COMPONENTWISE_DELTA:return ig(h),h;case Yt.NONE:return m&&(function(y){for(let w=0;w<y.length;w++){const P=y[w];y[w]=P>>>1^-(1&P)}})(h),h;default:throw new Error(`The specified Logical level technique is not supported: ${d.logicalLevelTechnique1}`)}})(Zh(i,e,r),r,n)}function ko(i,e,r){return(function(n,a){if(a.logicalLevelTechnique1===Yt.DELTA&&a.logicalLevelTechnique2===Yt.NONE)return(function(d){const m=new Int32Array(d.length+1);m[0]=0,m[1]=Ea(d[0]);let y=m[1],w=2;for(;w!=m.length;++w){const P=d[w-1];y+=P>>>1^-(1&P),m[w]=m[w-1]+y}return m})(n);if(a.logicalLevelTechnique1===Yt.RLE&&a.logicalLevelTechnique2===Yt.NONE)return(function(d,m,y){const w=new Int32Array(y+1);w[0]=0;let P=1,I=w[0];for(let C=0;C<m;C++){const D=d[C],F=d[C+m];for(let L=P;L<P+D;L++)w[L]=F+I,I=w[L];P+=D}return w})(n,a.runs,a.numRleValues);if(a.logicalLevelTechnique1===Yt.NONE&&a.logicalLevelTechnique2===Yt.NONE){(function(d){let m=0;for(let y=0;y<d.length;y++)d[y]+=m,m=d[y]})(n);const h=new Int32Array(a.numValues+1);return h[0]=0,h.set(n,1),h}if(a.logicalLevelTechnique1===Yt.DELTA&&a.logicalLevelTechnique2===Yt.RLE){const h=(function(d,m,y){const w=new Int32Array(y+1);w[0]=0;let P=1,I=w[0];for(let C=0;C<m;C++){const D=d[C];let F=d[C+m];F=F>>>1^-(1&F);for(let L=P;L<P+D;L++)w[L]=F+I,I=w[L];P+=D}return w})(n,a.runs,a.numRleValues);return kp(h),h}throw new Error("Only delta encoding is supported for transforming length to offset streams yet.")})(Zh(i,e,r),r)}function Zh(i,e,r){const n=r.physicalLevelTechnique;if(n===Yn.FAST_PFOR)return Qm();if(n===Yn.VARINT)return Mi(i,e,r.numValues);if(n===Yn.NONE){const a=e.get();e.add(r.byteLength);const h=i.subarray(a,e.get());return new Int32Array(h)}throw new Error("Specified physicalLevelTechnique is not supported (yet).")}function zp(i,e,r,n){const a=Zh(i,e,r);if(a.length===1){const h=a[0];return n?Ea(h):h}return n?(function(h){return Ea(h[1])})(a):(function(h){return h[1]})(a)}function sg(i,e,r){return(function(n){if(n.length==2){const a=Ea(n[1]);return[a,a]}return[Ea(n[2]),Ea(n[3])]})(Zh(i,e,r))}function ng(i,e,r){return(function(n){if(n.length==2){const a=kl(n[1]);return[a,a]}return[kl(n[2]),kl(n[3])]})(Gh(i,e,r.numValues))}function og(i,e,r,n){return(function(a,h,d){switch(h.logicalLevelTechnique1){case Yt.DELTA:return h.logicalLevelTechnique2===Yt.RLE?(function(m,y,w){const P=new BigInt64Array(w);let I=0,C=0n;for(let D=0;D<y;D++){const F=Number(m[D]),L=kl(m[D+y]);for(let B=0;B<F;B++)C+=L,P[I++]=C}return P})(a,h.runs,h.numRleValues):((function(m){m[0]=m[0]>>1n^-(1n&m[0]);const y=m.length/4*4;let w=1;if(y>=4)for(;w<y-4;w+=4){const P=m[w],I=m[w+1],C=m[w+2],D=m[w+3];m[w]=(P>>1n^-(1n&P))+m[w-1],m[w+1]=(I>>1n^-(1n&I))+m[w],m[w+2]=(C>>1n^-(1n&C))+m[w+1],m[w+3]=(D>>1n^-(1n&D))+m[w+2]}for(;w!=m.length;++w)m[w]=(m[w]>>1n^-(1n&m[w]))+m[w-1]})(a),a);case Yt.RLE:return(function(m,y,w){return w?(function(P,I,C){const D=new BigInt64Array(C);let F=0;for(let L=0;L<I;L++){const B=Number(P[L]);let U=P[L+I];U=U>>1n^-(1n&U),D.fill(U,F,F+B),F+=B}return D})(m,y.runs,y.numRleValues):tg(m,y.runs,y.numRleValues)})(a,h,d);case Yt.NONE:return d&&(function(m){for(let y=0;y<m.length;y++){const w=m[y];m[y]=w>>1n^-(1n&w)}})(a),a;default:throw new Error(`The specified Logical level technique is not supported: ${h.logicalLevelTechnique1}`)}})(Gh(i,e,r.numValues),r,n)}function ag(i,e,r,n){const a=Gh(i,e,r.numValues);if(a.length===1){const h=a[0];return n?kl(h):h}return n?(function(h){return kl(h[1])})(a):(function(h){return h[1]})(a)}function Rp(i,e,r,n,a){return(function(h,d,m,y){switch(d.logicalLevelTechnique1){case Yt.DELTA:return d.logicalLevelTechnique2===Yt.RLE&&(h=eg(h,d.runs,d.numRleValues)),(function(w,P){const I=new Int32Array(w.size());let C=0;w.get(0)?(I[0]=w.get(0)?P[0]>>>1^-(1&P[0]):0,C=1):I[0]=0;let D=1;for(;D!=I.length;++D)I[D]=w.get(D)?I[D-1]+(P[C]>>>1^-(1&P[C++])):I[D-1];return I})(y,h);case Yt.RLE:return(function(w,P,I,C){const D=P;return I?(function(F,L,B){const U=new Int32Array(F.size());let ee=0;for(let q=0;q<B;q++){const H=L[q];let re=L[q+B];re=re>>>1^-(1&re);for(let ae=ee;ae<ee+H;ae++)F.get(ae)?U[ae]=re:(U[ae]=0,ee++);ee+=H}return U})(C,w,D.runs):(function(F,L,B){const U=new Int32Array(F.size());let ee=0;for(let q=0;q<B;q++){const H=L[q],re=L[q+B];for(let ae=ee;ae<ee+H;ae++)F.get(ae)?U[ae]=re:(U[ae]=0,ee++);ee+=H}return U})(C,w,D.runs)})(h,d,m,y);case Yt.MORTON:return kp(h),h;case Yt.COMPONENTWISE_DELTA:return ig(h),h;case Yt.NONE:return h=m?(function(w,P){const I=new Int32Array(w.size());let C=0,D=0;for(;D!=I.length;++D)if(w.get(D)){const F=P[C++];I[D]=F>>>1^-(1&F)}else I[D]=0;return I})(y,h):(function(w,P){const I=new Int32Array(w.size());let C=0,D=0;for(;D!=I.length;++D)I[D]=w.get(D)?P[C++]:0;return I})(y,h),h;default:throw new Error("The specified Logical level technique is not supported")}})(r.physicalLevelTechnique===Yn.FAST_PFOR?Qm():Mi(i,e,r.numValues),r,n,a)}function Hh(i,e,r,n){const a=i.logicalLevelTechnique1;if(a===Yt.RLE)return i.runs===1?yi.CONST:yi.FLAT;const h=e instanceof Qs?e.size():e;if(a===Yt.DELTA&&i.logicalLevelTechnique2===Yt.RLE){const d=i.runs,m=2;if(i.numRleValues!==h)return yi.FLAT;if(d===1)return yi.SEQUENCE;if(d===2){const y=n.get();let w;if(i.physicalLevelTechnique===Yn.VARINT)w=Mi(r,n,4);else{const P=n.get();w=new Int32Array(r.buffer,r.byteOffset+P,4)}if(n.set(y),w[2]===m&&w[3]===m)return yi.SEQUENCE}}return i.numValues===1?yi.CONST:yi.FLAT}class lg extends qh{getValueFromBuffer(e){return this.dataBuffer[e]}}class cg extends Jm{constructor(e,r,n,a){super(e,BigInt64Array.of(r),n,a)}getValueFromBuffer(e){return this.dataBuffer[0]+BigInt(e)*this.delta}}class Dl{_geometryOffsets;_partOffsets;_ringOffsets;constructor(e,r,n){this._geometryOffsets=e,this._partOffsets=r,this._ringOffsets=n}get geometryOffsets(){return this._geometryOffsets}get partOffsets(){return this._partOffsets}get ringOffsets(){return this._ringOffsets}}function Fp(i,e,r){return{x:ug(i,e)-r,y:ug(i>>1,e)-r}}function ug(i,e){let r=0;for(let n=0;n<e;n++)r|=(i&1<<2*n)>>n;return r}(function(i){i[i.POINT=0]="POINT",i[i.LINESTRING=1]="LINESTRING",i[i.POLYGON=2]="POLYGON",i[i.MULTIPOINT=3]="MULTIPOINT",i[i.MULTILINESTRING=4]="MULTILINESTRING",i[i.MULTIPOLYGON=5]="MULTIPOLYGON"})(xi||(xi={})),(function(i){i[i.POINT=0]="POINT",i[i.LINESTRING=1]="LINESTRING",i[i.POLYGON=2]="POLYGON"})(Km||(Km={})),(function(i){i[i.MORTON=0]="MORTON",i[i.VEC_2=1]="VEC_2",i[i.VEC_3=2]="VEC_3"})(As||(As={}));class sx{createPoint(e){return[[e]]}createMultiPoint(e){return e.map((r=>[r]))}createLineString(e){return[e]}createMultiLineString(e){return e}createPolygon(e,r){return[e].concat(r)}createMultiPolygon(e){return e.flat()}}function hg(i){const e=new Array(i.numGeometries);let r=1,n=1,a=1,h=0;const d=new sx;let m=0,y=0;const w=i.mortonSettings,P=i.topologyVector,I=P.geometryOffsets,C=P.partOffsets,D=P.ringOffsets,F=i.vertexOffsets,L=i.containsPolygonGeometry(),B=i.vertexBuffer;for(let U=0;U<i.numGeometries;U++){const ee=i.geometryType(U);if(ee===xi.POINT){if(F&&F.length!==0)if(i.vertexBufferType===As.VEC_2){const q=2*F[y++],H=new $(B[q],B[q+1]);e[h++]=d.createPoint(H)}else{const q=Fp(B[F[y++]],w.numBits,w.coordinateShift),H=new $(q.x,q.y);e[h++]=d.createPoint(H)}else{const q=new $(B[m++],B[m++]);e[h++]=d.createPoint(q)}I&&a++,C&&r++,D&&n++}else if(ee===xi.MULTIPOINT){const q=I[a]-I[a-1];a++;const H=new Array(q);if(F&&F.length!==0){for(let re=0;re<q;re++){const ae=2*F[y++];H[re]=new $(B[ae],B[ae+1])}e[h++]=d.createMultiPoint(H)}else{for(let re=0;re<q;re++){const ae=B[m++],be=B[m++];H[re]=new $(ae,be)}e[h++]=d.createMultiPoint(H)}}else if(ee===xi.LINESTRING){let q,H=0;L?(H=D[n]-D[n-1],n++):H=C[r]-C[r-1],r++,F&&F.length!==0?(q=i.vertexBufferType===As.VEC_2?Op(B,F,y,H,!1):Bp(B,F,y,H,!1,w),y+=H):(q=Lp(B,m,H,!1),m+=2*H),e[h++]=d.createLineString(q),I&&a++}else if(ee===xi.POLYGON){const q=C[r]-C[r-1];r++;const H=new Array(q-1);let re=D[n]-D[n-1];if(n++,F&&F.length!==0){const ae=i.vertexBufferType===As.VEC_2?Xh(B,F,y,re):Yh(B,F,y,re,0,w);y+=re;for(let be=0;be<H.length;be++)re=D[n]-D[n-1],n++,H[be]=i.vertexBufferType===As.VEC_2?Xh(B,F,y,re):Yh(B,F,y,re,0,w),y+=re;e[h++]=d.createPolygon(ae,H)}else{const ae=Wh(B,m,re);m+=2*re;for(let be=0;be<H.length;be++)re=D[n]-D[n-1],n++,H[be]=Wh(B,m,re),m+=2*re;e[h++]=d.createPolygon(ae,H)}I&&a++}else if(ee===xi.MULTILINESTRING){const q=I[a]-I[a-1];a++;const H=new Array(q);if(F&&F.length!==0){for(let re=0;re<q;re++){let ae=0;L?(ae=D[n]-D[n-1],n++):ae=C[r]-C[r-1],r++;const be=i.vertexBufferType===As.VEC_2?Op(B,F,y,ae,!1):Bp(B,F,y,ae,!1,w);H[re]=be,y+=ae}e[h++]=d.createMultiLineString(H)}else{for(let re=0;re<q;re++){let ae=0;L?(ae=D[n]-D[n-1],n++):ae=C[r]-C[r-1],r++,H[re]=Lp(B,m,ae,!1),m+=2*ae}e[h++]=d.createMultiLineString(H)}}else{if(ee!==xi.MULTIPOLYGON)throw new Error("The specified geometry type is currently not supported.");{const q=I[a]-I[a-1];a++;const H=new Array(q);let re=0;if(F&&F.length!==0){for(let ae=0;ae<q;ae++){const be=C[r]-C[r-1];r++;const Le=new Array(be-1);re=D[n]-D[n-1],n++;const De=i.vertexBufferType===As.VEC_2?Xh(B,F,y,re):Yh(B,F,y,re,0,w);y+=re;for(let Ne=0;Ne<Le.length;Ne++)re=D[n]-D[n-1],n++,Le[Ne]=i.vertexBufferType===As.VEC_2?Xh(B,F,y,re):Yh(B,F,y,re,0,w),y+=re;H[ae]=d.createPolygon(De,Le)}e[h++]=d.createMultiPolygon(H)}else{for(let ae=0;ae<q;ae++){const be=C[r]-C[r-1];r++;const Le=new Array(be-1);re=D[n]-D[n-1],n++;const De=Wh(B,m,re);m+=2*re;for(let Ne=0;Ne<Le.length;Ne++){const tt=D[n]-D[n-1];n++,Le[Ne]=Wh(B,m,tt),m+=2*tt}H[ae]=d.createPolygon(De,Le)}e[h++]=d.createMultiPolygon(H)}}}}return e}function Wh(i,e,r){return Lp(i,e,r,!0)}function Xh(i,e,r,n){return Op(i,e,r,n,!0)}function Yh(i,e,r,n,a,h){return Bp(i,e,r,n,!0,h)}function Lp(i,e,r,n){const a=new Array(n?r+1:r);for(let h=0;h<2*r;h+=2)a[h/2]=new $(i[e+h],i[e+h+1]);return n&&(a[a.length-1]=a[0]),a}function Op(i,e,r,n,a){const h=new Array(a?n+1:n);for(let d=0;d<2*n;d+=2){const m=2*e[r+d/2];h[d/2]=new $(i[m],i[m+1])}return a&&(h[h.length-1]=h[0]),h}function Bp(i,e,r,n,a,h){const d=new Array(a?n+1:n);for(let m=0;m<n;m++){const y=Fp(i[e[r+m]],h.numBits,h.coordinateShift);d[m]=new $(y.x,y.y)}return a&&(d[d.length-1]=d[0]),d}class dg{_vertexBufferType;_topologyVector;_vertexOffsets;_vertexBuffer;_mortonSettings;constructor(e,r,n,a,h){this._vertexBufferType=e,this._topologyVector=r,this._vertexOffsets=n,this._vertexBuffer=a,this._mortonSettings=h}get vertexBufferType(){return this._vertexBufferType}get topologyVector(){return this._topologyVector}get vertexOffsets(){return this._vertexOffsets}get vertexBuffer(){return this._vertexBuffer}*[Symbol.iterator](){const e=hg(this);let r=0;for(;r<this.numGeometries;)yield{coordinates:e[r],type:this.geometryType(r)},r++}getSimpleEncodedVertex(e){const r=this.vertexOffsets?2*this.vertexOffsets[e]:2*e;return[this.vertexBuffer[r],this.vertexBuffer[r+1]]}getVertex(e){if(this.vertexOffsets&&this.mortonSettings){const n=Fp(this.vertexBuffer[this.vertexOffsets[e]],this.mortonSettings.numBits,this.mortonSettings.coordinateShift);return[n.x,n.y]}const r=this.vertexOffsets?2*this.vertexOffsets[e]:2*e;return[this.vertexBuffer[r],this.vertexBuffer[r+1]]}getGeometries(){return hg(this)}get mortonSettings(){return this._mortonSettings}}class pg extends dg{_numGeometries;_geometryType;constructor(e,r,n,a,h,d,m){super(n,a,h,d,m),this._numGeometries=e,this._geometryType=r}geometryType(e){return this._geometryType}get numGeometries(){return this._numGeometries}containsPolygonGeometry(){return this._geometryType===xi.POLYGON||this._geometryType===xi.MULTIPOLYGON}containsSingleGeometryType(){return!0}}class fg extends dg{_geometryTypes;constructor(e,r,n,a,h,d){super(e,n,a,h,d),this._geometryTypes=r}geometryType(e){return this._geometryTypes[e]}get numGeometries(){return this._geometryTypes.length}containsPolygonGeometry(){for(let e=0;e<this.numGeometries;e++)if(this.geometryType(e)===xi.POLYGON||this.geometryType(e)===xi.MULTIPOLYGON)return!0;return!1}containsSingleGeometryType(){return!1}}class mg{_triangleOffsets;_indexBuffer;_vertexBuffer;_topologyVector;constructor(e,r,n,a){this._triangleOffsets=e,this._indexBuffer=r,this._vertexBuffer=n,this._topologyVector=a}get triangleOffsets(){return this._triangleOffsets}get indexBuffer(){return this._indexBuffer}get vertexBuffer(){return this._vertexBuffer}get topologyVector(){return this._topologyVector}getGeometries(){if(!this._topologyVector)throw new Error("Cannot convert GpuVector to coordinates without topology information");const e=new Array(this.numGeometries),r=this._topologyVector,n=r.partOffsets,a=r.ringOffsets,h=r.geometryOffsets;let d=0,m=1,y=1,w=1;for(let P=0;P<this.numGeometries;P++)switch(this.geometryType(P)){case xi.POLYGON:{const I=n[m]-n[m-1];m++;const C=[];for(let D=0;D<I;D++){const F=a[y]-a[y-1];y++;const L=[];for(let B=0;B<F;B++){const U=this._vertexBuffer[d++],ee=this._vertexBuffer[d++];L.push(new $(U,ee))}L.length>0&&L.push(L[0]),C.push(L)}e[P]=C,h&&w++}break;case xi.MULTIPOLYGON:{const I=h[w]-h[w-1];w++;const C=[];for(let D=0;D<I;D++){const F=n[m]-n[m-1];m++;for(let L=0;L<F;L++){const B=a[y]-a[y-1];y++;const U=[];for(let ee=0;ee<B;ee++){const q=this._vertexBuffer[d++],H=this._vertexBuffer[d++];U.push(new $(q,H))}U.length>0&&U.push(U[0]),C.push(U)}}e[P]=C}}return e}[Symbol.iterator](){return null}}function gg(i,e,r,n,a,h){return new nx(i,e,r,n,a,h)}class nx extends mg{_numGeometries;_geometryType;constructor(e,r,n,a,h,d){super(n,a,h,d),this._numGeometries=e,this._geometryType=r}geometryType(e){return this._geometryType}get numGeometries(){return this._numGeometries}containsSingleGeometryType(){return!0}}function _g(i,e,r,n,a){return new ox(i,e,r,n,a)}class ox extends mg{_geometryTypes;constructor(e,r,n,a,h){super(r,n,a,h),this._geometryTypes=e}geometryType(e){return this._geometryTypes[e]}get numGeometries(){return this._geometryTypes.length}containsSingleGeometryType(){return!1}}function ax(i,e,r,n,a){const h=es(i,r);let d=null,m=null,y=null,w=null,P=null,I=null,C=null,D=null;if(Hh(h,n,i,r)===yi.CONST){const L=zp(i,r,h,!1);for(let B=0;B<e-1;B++){const U=es(i,r);switch(U.physicalStreamType){case ki.LENGTH:switch(U.logicalStreamType.lengthType){case gs.GEOMETRIES:d=ko(i,r,U);break;case gs.PARTS:m=ko(i,r,U);break;case gs.RINGS:y=ko(i,r,U);break;case gs.TRIANGLES:C=ko(i,r,U)}break;case ki.OFFSET:switch(U.logicalStreamType.offsetType){case Pa.VERTEX:w=ts(i,r,U,!1);break;case Pa.INDEX:D=ts(i,r,U,!1)}break;case ki.DATA:Ks.VERTEX===U.logicalStreamType.dictionaryType?P=ts(i,r,U,!0):(I={numBits:U.numBits,coordinateShift:U.coordinateShift},P=ts(i,r,U,!1))}}return D!==null?d!=null||m!=null?gg(n,L,C,D,P,new Dl(d,m,y)):gg(n,L,C,D,P):I===null?(function(B,U,ee,q,H){return new pg(B,U,As.VEC_2,ee,q,H)})(n,L,new Dl(d,m,y),w,P):(function(B,U,ee,q,H,re){return new pg(B,U,As.MORTON,ee,q,H,re)})(n,L,new Dl(d,m,y),w,P,I)}const F=ts(i,r,h,!1);for(let L=0;L<e-1;L++){const B=es(i,r);switch(B.physicalStreamType){case ki.LENGTH:switch(B.logicalStreamType.lengthType){case gs.GEOMETRIES:d=ts(i,r,B,!1);break;case gs.PARTS:m=ts(i,r,B,!1);break;case gs.RINGS:y=ts(i,r,B,!1);break;case gs.TRIANGLES:C=ko(i,r,B)}break;case ki.OFFSET:switch(B.logicalStreamType.offsetType){case Pa.VERTEX:w=ts(i,r,B,!1);break;case Pa.INDEX:D=ts(i,r,B,!1)}break;case ki.DATA:Ks.VERTEX===B.logicalStreamType.dictionaryType?P=ts(i,r,B,!0):(I={numBits:B.numBits,coordinateShift:B.coordinateShift},P=ts(i,r,B,!1))}}return D!==null&&m===null?_g(F,C,D,P):(d!==null?(d=jp(F,d,2),m!==null&&y!==null?(m=yg(F,d,m,!1),y=(function(L,B,U,ee){const q=new Int32Array(U[U.length-1]+1);let H=0;q[0]=H;let re=1,ae=1,be=0;for(let Le=0;Le<L.length;Le++){const De=L[Le],Ne=B[Le+1]-B[Le];if(De!==0&&De!==3)for(let tt=0;tt<Ne;tt++){const qe=U[re]-U[re-1];re++;for(let Re=0;Re<qe;Re++)H=q[ae++]=H+ee[be++]}else for(let tt=0;tt<Ne;tt++)q[ae++]=++H,re++}return q})(F,d,m,y)):m!==null&&(m=(function(L,B,U){const ee=new Int32Array(B[B.length-1]+1);let q=0;ee[0]=q;let H=1,re=0;for(let ae=0;ae<L.length;ae++){const be=L[ae],Le=B[ae+1]-B[ae];if(be===4||be===1)for(let De=0;De<Le;De++)q=ee[H++]=q+U[re++];else for(let De=0;De<Le;De++)ee[H++]=++q}return ee})(F,d,m))):m!==null&&y!==null?(m=jp(F,m,1),y=yg(F,m,y,!0)):m!==null&&(m=jp(F,m,0)),D!==null?_g(F,C,D,P,new Dl(d,m,y)):I===null?(function(L,B,U,ee){return new fg(As.VEC_2,L,B,U,ee)})(F,new Dl(d,m,y),w,P):(function(L,B,U,ee,q){return new fg(As.MORTON,L,B,U,ee,q)})(F,new Dl(d,m,y),w,P,I))}function jp(i,e,r){const n=new Int32Array(i.length+1);let a=0;n[0]=a;let h=0;for(let d=0;d<i.length;d++)a=n[d+1]=a+(i[d]>r?e[h++]:1);return n}function yg(i,e,r,n){const a=new Int32Array(e[e.length-1]+1);let h=0;a[0]=h;let d=1,m=0;for(let y=0;y<i.length;y++){const w=i[y],P=e[y+1]-e[y];if(w===5||w===2||n&&(w===4||w===1))for(let I=0;I<P;I++)h=a[d++]=h+r[m++];else for(let I=0;I<P;I++)a[d++]=++h}return a}class lx extends Cl{dataVector;constructor(e,r,n){super(e,r.getBuffer(),n),this.dataVector=r}getValueFromBuffer(e){return this.dataVector.get(e)}}class cx extends qh{getValueFromBuffer(e){return this.dataBuffer[e]}}class xg extends Cl{constructor(e,r,n){super(e,BigInt64Array.of(r),n)}getValueFromBuffer(e){return this.dataBuffer[0]}}function au(i,e,r){return vg(i,Math.ceil(e/8),r)}function vg(i,e,r){const n=new Uint8Array(e);let a=0;for(;a<e;){const h=i[r.increment()];if(h<=127){const d=h+3,m=i[r.increment()],y=a+d;n.fill(m,a,y),a=y}else{const d=256-h;for(let m=0;m<d;m++)n[a++]=i[r.increment()]}}return n}const ux=new TextDecoder;function Np(i,e,r){return r-e>=12?ux.decode(i.subarray(e,r)):(function(n,a,h){let d="",m=a;for(;m<h;){const y=n[m];let w,P,I,C=null,D=y>239?4:y>223?3:y>191?2:1;if(m+D>h)break;D===1?y<128&&(C=y):D===2?(w=n[m+1],(192&w)==128&&(C=(31&y)<<6|63&w,C<=127&&(C=null))):D===3?(w=n[m+1],P=n[m+2],(192&w)==128&&(192&P)==128&&(C=(15&y)<<12|(63&w)<<6|63&P,(C<=2047||C>=55296&&C<=57343)&&(C=null))):D===4&&(w=n[m+1],P=n[m+2],I=n[m+3],(192&w)==128&&(192&P)==128&&(192&I)==128&&(C=(15&y)<<18|(63&w)<<12|(63&P)<<6|63&I,(C<=65535||C>=1114112)&&(C=null))),C===null?(C=65533,D=1):C>65535&&(C-=65536,d+=String.fromCharCode(C>>>10&1023|55296),C=56320|1023&C),d+=String.fromCharCode(C),m+=D}return d})(i,e,r)}class Vp extends Cl{offsetBuffer;constructor(e,r,n,a){super(e,n,a),this.offsetBuffer=r}}class bg extends Vp{textEncoder;constructor(e,r,n,a){super(e,r,n,a??r.length-1),this.textEncoder=new TextEncoder}getValueFromBuffer(e){return Np(this.dataBuffer,this.offsetBuffer[e],this.offsetBuffer[e+1])}}class zl extends Vp{indexBuffer;textEncoder;constructor(e,r,n,a,h){super(e,n,a,h??r.length),this.indexBuffer=r,this.indexBuffer=r,this.textEncoder=new TextEncoder}getValueFromBuffer(e){const r=this.indexBuffer[e];return Np(this.dataBuffer,this.offsetBuffer[r],this.offsetBuffer[r+1])}}class wg extends Vp{indexBuffer;symbolOffsetBuffer;symbolTableBuffer;textEncoder;symbolLengthBuffer;lengthBuffer;decodedDictionary;constructor(e,r,n,a,h,d,m){super(e,n,a,m),this.indexBuffer=r,this.symbolOffsetBuffer=h,this.symbolTableBuffer=d,this.textEncoder=new TextEncoder}getValueFromBuffer(e){this.decodedDictionary==null&&(this.symbolLengthBuffer==null&&(this.symbolLengthBuffer=this.offsetToLengthBuffer(this.symbolOffsetBuffer),this.lengthBuffer=this.offsetToLengthBuffer(this.offsetBuffer)),this.decodedDictionary=(function(n,a,h){const d=[],m=new Array(a.length).fill(0);for(let y=1;y<a.length;y++)m[y]=m[y-1]+a[y-1];for(let y=0;y<h.length;y++)if(h[y]===255)d.push(h[++y]);else{const w=a[h[y]],P=m[h[y]];for(let I=0;I<w;I++)d.push(n[P+I])}return new Uint8Array(d)})(this.symbolTableBuffer,this.symbolLengthBuffer,this.dataBuffer));const r=this.indexBuffer[e];return Np(this.decodedDictionary,this.offsetBuffer[r],this.offsetBuffer[r+1])}offsetToLengthBuffer(e){const r=new Uint32Array(e.length-1);let n=e[0];for(let a=1;a<e.length;a++){const h=e[a];r[a-1]=h-n,n=h}return r}}function hx(i,e,r,n,a,h){return r.type==="scalarType"?(function(d,m,y,w,P,I){let C=null,D=0;if(d===0)return null;if(I.nullable){const L=es(m,y);D=L.numValues;const B=y.get(),U=au(m,D,y);y.set(B+L.byteLength),C=new Qs(U,L.numValues)}const F=C??w;switch(P.physicalType){case 4:case 3:return(function(L,B,U,ee,q){const H=es(L,B),re=Hh(H,q,L,B),ae=ee.physicalType===3;if(re===yi.FLAT){const be=lu(q)?Rp(L,B,H,ae,q):ts(L,B,H,ae);return new Mp(U.name,be,q)}if(re===yi.SEQUENCE){const be=sg(L,B,H);return new Ap(U.name,be[0],be[1],H.numRleValues)}{const be=zp(L,B,H,ae);return new Cp(U.name,be,q)}})(m,y,I,P,F);case 9:return(function(L,B,U,ee,q){let H=null,re=null,ae=null,be=null,Le=null,De=null,Ne=null,tt=null;for(let qe=0;qe<ee;qe++){const Re=es(B,U);if(Re.byteLength!==0)switch(Re.physicalStreamType){case ki.PRESENT:{const Ae=au(B,Re.numValues,U);De=new Qs(Ae,Re.numValues);break}case ki.OFFSET:re=q!=null||De!=null?Rp(B,U,Re,!1,q??De):ts(B,U,Re,!1);break;case ki.LENGTH:{const Ae=ko(B,U,Re);gs.DICTIONARY===Re.logicalStreamType.lengthType?H=Ae:gs.SYMBOL===Re.logicalStreamType.lengthType?be=Ae:Ne=Ae;break}case ki.DATA:{const Ae=B.subarray(U.get(),U.get()+Re.byteLength);U.add(Re.byteLength);const ut=Re.logicalStreamType.dictionaryType;Ks.FSST===ut?Le=Ae:Ks.SINGLE===ut||Ks.SHARED===ut?ae=Ae:Ks.NONE===ut&&(tt=Ae);break}}}return(function(qe,Re,Ae,ut,lt,dt,nt){return Re?new wg(qe,Ae,ut,lt,dt,Re,nt):null})(L,Le,re,H,ae,be,q??De)??(function(qe,Re,Ae,ut,lt){return Re?lt?new zl(qe,Ae,ut,Re,lt):new zl(qe,Ae,ut,Re):null})(L,ae,re,H,q??De)??(function(qe,Re,Ae,ut,lt){if(!Re||!Ae)return null;if(ut)return lt?new zl(qe,ut,Re,Ae,lt):new zl(qe,ut,Re,Ae);if(lt&&lt.size()!==Re.length-1){const dt=new Int32Array(lt.size());let nt=0;for(let Tt=0;Tt<lt.size();Tt++)dt[Tt]=lt.get(Tt)?nt++:0;return new zl(qe,dt,Re,Ae,lt)}return lt?new bg(qe,Re,Ae,lt):new bg(qe,Re,Ae)})(L,Ne,tt,re,q??De)})(I.name,m,y,I.nullable?d-1:d,C);case 0:return(function(L,B,U,ee,q){const H=es(L,B),re=H.numValues,ae=B.get(),be=lu(q)?(function(De,Ne,tt,qe){const Re=vg(De,Math.ceil(Ne/8),tt),Ae=new Qs(Re,Ne),ut=qe.size(),lt=new Qs(new Uint8Array(ut),ut);let dt=0;for(let nt=0;nt<qe.size();nt++){const Tt=!!qe.get(nt)&&Ae.get(dt++);lt.set(nt,Tt)}return lt.getBuffer()})(L,re,B,q):au(L,re,B);B.set(ae+H.byteLength);const Le=new Qs(be,re);return new lx(U.name,Le,q)})(m,y,I,0,F);case 6:case 5:return(function(L,B,U,ee,q){const H=es(L,B),re=Hh(H,ee,L,B),ae=q.physicalType===5;if(re===yi.FLAT){const be=lu(ee)?(function(Le,De,Ne,tt,qe){return(function(Re,Ae,ut,lt){switch(Ae.logicalLevelTechnique1){case Yt.DELTA:return Ae.logicalLevelTechnique2===Yt.RLE&&(Re=tg(Re,Ae.runs,Ae.numRleValues)),(function(dt,nt){const Tt=new BigInt64Array(dt.size());let ir=0;dt.get(0)?(Tt[0]=dt.get(0)?nt[0]>>1n^-(1n&nt[0]):0n,ir=1):Tt[0]=0n;let Gt=1;for(;Gt!=Tt.length;++Gt)Tt[Gt]=dt.get(Gt)?Tt[Gt-1]+(nt[ir]>>1n^-(1n&nt[ir++])):Tt[Gt-1];return Tt})(lt,Re);case Yt.RLE:return(function(dt,nt,Tt,ir){const Gt=nt;return Tt?(function(Rr,zi,ai){const Fr=new BigInt64Array(Rr.size());let Ar=0;for(let ur=0;ur<ai;ur++){const Gr=Number(zi[ur]);let Qr=zi[ur+ai];Qr=Qr>>1n^-(1n&Qr);for(let Er=Ar;Er<Ar+Gr;Er++)Rr.get(Er)?Fr[Er]=Qr:(Fr[Er]=0n,Ar++);Ar+=Gr}return Fr})(ir,dt,Gt.runs):(function(Rr,zi,ai){const Fr=new BigInt64Array(Rr.size());let Ar=0;for(let ur=0;ur<ai;ur++){const Gr=Number(zi[ur]),Qr=zi[ur+ai];for(let Er=Ar;Er<Ar+Gr;Er++)Rr.get(Er)?Fr[Er]=Qr:(Fr[Er]=0n,Ar++);Ar+=Gr}return Fr})(ir,dt,Gt.runs)})(Re,Ae,ut,lt);case Yt.NONE:return Re=ut?(function(dt,nt){const Tt=new BigInt64Array(dt.size());let ir=0,Gt=0;for(;Gt!=Tt.length;++Gt)if(dt.get(Gt)){const Rr=nt[ir++];Tt[Gt]=Rr>>1n^-(1n&Rr)}else Tt[Gt]=0n;return Tt})(lt,Re):(function(dt,nt){const Tt=new BigInt64Array(dt.size());let ir=0,Gt=0;for(;Gt!=Tt.length;++Gt)Tt[Gt]=dt.get(Gt)?nt[ir++]:0n;return Tt})(lt,Re),Re;default:throw new Error("The specified Logical level technique is not supported")}})(Gh(Le,De,Ne.numValues),Ne,tt,qe)})(L,B,H,ae,ee):og(L,B,H,ae);return new lg(U.name,be,ee)}if(re===yi.SEQUENCE){const be=ng(L,B,H);return new cg(U.name,be[0],be[1],H.numRleValues)}{const be=ag(L,B,H,ae);return new xg(U.name,be,ee)}})(m,y,I,F,P);case 7:return(function(L,B,U,ee){const q=es(L,B),H=lu(ee)?(function(re,ae,be,Le){const De=ae.get(),Ne=De+Le*Float32Array.BYTES_PER_ELEMENT,tt=new Uint8Array(re.subarray(De,Ne)).buffer,qe=new Float32Array(tt);ae.set(Ne);const Re=be.size(),Ae=new Float32Array(Re);let ut=0;for(let lt=0;lt<Re;lt++)Ae[lt]=be.get(lt)?qe[ut++]:0;return Ae})(L,B,ee,q.numValues):(function(re,ae,be){const Le=ae.get(),De=Le+be*Float32Array.BYTES_PER_ELEMENT,Ne=new Uint8Array(re.subarray(Le,De)).buffer,tt=new Float32Array(Ne);return ae.set(De),tt})(L,B,q.numValues);return new cx(U.name,H,ee)})(m,y,I,F);case 8:return(function(L,B,U,ee){const q=es(L,B),H=lu(ee)?(function(re,ae,be,Le){const De=ae.get(),Ne=De+Le*Float64Array.BYTES_PER_ELEMENT,tt=new Uint8Array(re.subarray(De,Ne)).buffer,qe=new Float64Array(tt);ae.set(Ne);const Re=be.size(),Ae=new Float64Array(Re);let ut=0;for(let lt=0;lt<Re;lt++)Ae[lt]=be.get(lt)?qe[ut++]:0;return Ae})(L,B,ee,q.numValues):(function(re,ae,be){const Le=ae.get(),De=Le+be*Float64Array.BYTES_PER_ELEMENT,Ne=new Uint8Array(re.subarray(Le,De)).buffer,tt=new Float64Array(Ne);return ae.set(De),tt})(L,B,q.numValues);return new Ip(U.name,H,ee)})(m,y,I,F);default:throw new Error(`The specified data type for the field is currently not supported: ${P}`)}})(n,i,e,a,r.scalarType,r):n!=1?null:(function(d,m,y,w){let P=null,I=null,C=null,D=null,F=!1;for(;!F;){const ee=es(d,m);switch(ee.physicalStreamType){case ki.LENGTH:gs.DICTIONARY===ee.logicalStreamType.lengthType?P=ko(d,m,ee):C=ko(d,m,ee);break;case ki.DATA:Ks.SINGLE===ee.logicalStreamType.dictionaryType||Ks.SHARED===ee.logicalStreamType.dictionaryType?(I=d.subarray(m.get(),m.get()+ee.byteLength),F=!0):D=d.subarray(m.get(),m.get()+ee.byteLength),m.add(ee.byteLength)}}const L=y.complexType.children,B=[];let U=0;for(const ee of L){const q=Mi(d,m,1)[0];if(q==0)continue;const H=`${y.name}${ee.name==="default"?"":":"+ee.name}`;if(q!==2||ee.type!=="scalarField"||ee.scalarField.physicalType!==9)throw new Error("Currently only optional string fields are implemented for a struct.");const re=es(d,m),ae=au(d,re.numValues,m),be=es(d,m),Le=be.decompressedCount!==w?Rp(d,m,be,!1,new Qs(ae,re.numValues)):ts(d,m,be,!1);B[U++]=D?new wg(H,Le,P,I,C,D,new Qs(ae,re.numValues)):new zl(H,Le,P,I,new Qs(ae,re.numValues))}return B})(i,e,r,a)}function lu(i){return i instanceof Qs}function dx(i){if(i.name==="id")return!1;if(i.type==="scalarType"){const e=i.scalarType;if(e.type==="physicalType")switch(e.physicalType){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:default:return!1;case 9:return!0}else if(e.type==="logicalType")return!1}else if(i.type==="complexType"){const e=i.complexType;if(e.type==="physicalType")switch(e.physicalType){case 0:case 1:return!0;default:return!1}}return console.warn("Unexpected column type in hasStreamCount",i),!1}const px=new TextDecoder;function Tg(i,e){const r=Mi(i,e,1)[0];if(r===0)return"";const n=e.get(),a=i.subarray(n,n+r);return e.add(r),px.decode(a)}function Sg(i,e){const r=Mi(i,e,1)[0]>>>0,n=!!(4&r),a=!!(2&r),h=Mi(i,e,1)[0]>>>0,d={};if(1&r&&(d.nullable=!0),a){const m={};if(n?(m.type="logicalType",m.logicalType=h):(m.type="physicalType",m.physicalType=h),8&r){const y=Mi(i,e,1)[0]>>>0;m.children=new Array(y);for(let w=0;w<y;w++)m.children[w]=Sg(i,e)}d.type="complexField",d.complexField=m}else{const m={};n?(m.type="logicalType",m.logicalType=h):(m.type="physicalType",m.physicalType=h),d.type="scalarField",d.scalarField=m}return d}function fx(i,e){const r=Mi(i,e,1)[0]>>>0,n=(function(a){switch(a){case 0:case 1:case 2:case 3:{const h={};h.nullable=!!(1&a),h.columnScope=0;const d={};return d.physicalType=a>1?6:4,d.type="physicalType",h.scalarType=d,h.type="scalarType",h}case 4:{const h={nullable:!1,columnScope:0},d={type:"physicalType",physicalType:0};return h.type="complexType",h.complexType=d,h}case 30:{const h={nullable:!1,columnScope:0},d={type:"physicalType",physicalType:1};return h.type="complexType",h.complexType=d,h}default:return(function(h){let d=null;switch(h){case 10:case 11:d=0;break;case 12:case 13:d=1;break;case 14:case 15:d=2;break;case 16:case 17:d=3;break;case 18:case 19:d=4;break;case 20:case 21:d=5;break;case 22:case 23:d=6;break;case 24:case 25:d=7;break;case 26:case 27:d=8;break;case 28:case 29:d=9;break;default:return null}const m={};m.nullable=!!(1&h),m.columnScope=0;const y={type:"physicalType"};return y.physicalType=d,m.type="scalarType",m.scalarType=y,m})(a)}})(r);if(!n)throw new Error(`Unsupported column type code: ${r}`);if((function(a){return a>=10})(r)?n.name=Tg(i,e):r>=0&&r<=3?n.name="id":r===4&&(n.name="geometry"),(function(a){return a===30})(r)){const a=Mi(i,e,1)[0]>>>0,h=n.complexType;h.children=new Array(a);for(let d=0;d<a;d++)h.children[d]=Sg(i,e)}return n}function mx(i,e){const r={featureTables:[]},n={};n.name=Tg(i,e);const a=Mi(i,e,1)[0]>>>0,h=Mi(i,e,1)[0]>>>0;n.columns=new Array(h);for(let d=0;d<h;d++)n.columns[d]=fx(i,e);return r.featureTables.push(n),[r,a]}function gx(i,e,r,n,a,h,d=!1){const m=e.scalarType.physicalType,y=Hh(a,h,i,r);if(m===4)switch(y){case yi.FLAT:{const w=ts(i,r,a,!1);return new Mp(n,w,h)}case yi.SEQUENCE:{const w=sg(i,r,a);return new Ap(n,w[0],w[1],a.numRleValues)}case yi.CONST:{const w=zp(i,r,a,!1);return new Cp(n,w,h)}}else switch(y){case yi.FLAT:{if(d){const P=(function(I,C,D,F){const L=(function(B,U,ee){const q=new Float64Array(U);for(let H=0;H<U;H++)q[H]=rx(B,ee);return q})(I,D.numValues,C);return(function(B,U,ee){switch(U.logicalLevelTechnique1){case Yt.DELTA:return U.logicalLevelTechnique2===Yt.RLE&&(B=rg(B,U.runs,U.numRleValues)),(function(q){q[0]=q[0]%2==1?(q[0]+1)/-2:q[0]/2;const H=q.length/4*4;let re=1;if(H>=4)for(;re<H-4;re+=4){const ae=q[re],be=q[re+1],Le=q[re+2],De=q[re+3];q[re]=(ae%2==1?(ae+1)/-2:ae/2)+q[re-1],q[re+1]=(be%2==1?(be+1)/-2:be/2)+q[re],q[re+2]=(Le%2==1?(Le+1)/-2:Le/2)+q[re+1],q[re+3]=(De%2==1?(De+1)/-2:De/2)+q[re+2]}for(;re!=q.length;++re)q[re]=(q[re]%2==1?(q[re]+1)/-2:q[re]/2)+q[re-1]})(B),B;case Yt.RLE:return(function(q,H,re){return rg(q,H.runs,H.numRleValues)})(B,U);case Yt.NONE:return B;default:throw new Error(`The specified Logical level technique is not supported: ${U.logicalLevelTechnique1}`)}})(L,D)})(i,r,a);return new Ip(n,P,h)}const w=og(i,r,a,!1);return new lg(n,w,h)}case yi.SEQUENCE:{const w=ng(i,r,a);return new cg(n,w[0],w[1],a.numRleValues)}case yi.CONST:{const w=ag(i,r,a,!1);return new xg(n,w,h)}}throw new Error("Vector type not supported for id column.")}class _x{constructor(e,r){var n;switch(this._featureData=e,this.properties=this._featureData.properties||{},(n=this._featureData.geometry)===null||n===void 0?void 0:n.type){case xi.POINT:case xi.MULTIPOINT:this.type=1;break;case xi.LINESTRING:case xi.MULTILINESTRING:this.type=2;break;case xi.POLYGON:case xi.MULTIPOLYGON:this.type=3;break;default:this.type=0}this.extent=r,this.id=Number(this._featureData.id)}loadGeometry(){const e=[];for(const r of this._featureData.geometry.coordinates){const n=[];for(const a of r)n.push(new $(a.x,a.y));e.push(n)}return e}}class yx{constructor(e){this.features=[],this.featureTable=e,this.name=e.name,this.extent=e.extent,this.version=2,this.features=e.getFeatures(),this.length=this.features.length}feature(e){return new _x(this.features[e],this.extent)}}class Pg{constructor(e){this.layers={};const r=(function(n,a,h=!0){const d=new tx(0),m=[];for(;d.get()<n.length;){const y=Mi(n,d,1)[0]>>>0,w=d.get()+y;if(w>n.length)throw new Error(`Block overruns tile: ${w} > ${n.length}`);if(Mi(n,d,1)[0]>>>0!=1){d.set(w);continue}const P=mx(n,d),I=P[1],C=P[0].featureTables[0];let D=null,F=null;const L=[];let B=0;for(const ee of C.columns){const q=ee.name;if(q==="id"){let H=null;if(ee.nullable){const ae=es(n,d),be=d.get(),Le=au(n,ae.numValues,d);d.set(be+ae.byteLength),H=new Qs(Le,ae.numValues)}const re=es(n,d);B=re.decompressedCount,D=gx(n,ee,d,q,re,H??B,h)}else if(q==="geometry"){const H=Mi(n,d,1)[0];if(B===0){const re=d.get();B=es(n,d).decompressedCount,d.set(re)}F=ax(n,H,d,B)}else{const H=dx(ee)?Mi(n,d,1)[0]:1;if(H===0&&ee.type==="scalarType")continue;const re=hx(n,d,ee,H,B);if(re)if(Array.isArray(re))for(const ae of re)L.push(ae);else L.push(re)}}const U=new ex(C.name,F,D,L,I);m.push(U),d.set(w)}return m})(new Uint8Array(e));this.layers=r.reduce(((n,a)=>Object.assign(Object.assign({},n),{[a.name]:new yx(a)})),{})}}class xx{constructor(e,r){this.feature=e,this.type=e.type,this.properties=e.tags?e.tags:{},this.extent=r,"id"in e&&(typeof e.id=="string"?this.id=parseInt(e.id,10):typeof e.id!="number"||isNaN(e.id)||(this.id=e.id))}loadGeometry(){const e=[],r=this.feature.type===1?[this.feature.geometry]:this.feature.geometry;for(const n of r){const a=[];for(const h of n)a.push(new $(h[0],h[1]));e.push(a)}return e}}const cu="_geojsonTileLayer";function vx(i,e){e.writeVarintField(15,i.version||1),e.writeStringField(1,i.name||""),e.writeVarintField(5,i.extent||4096);const r={keys:[],values:[],keycache:{},valuecache:{}};for(let h=0;h<i.length;h++)r.feature=i.feature(h),e.writeMessage(2,bx,r);const n=r.keys;for(const h of n)e.writeStringField(3,h);const a=r.values;for(const h of a)e.writeMessage(4,Sx,h)}function bx(i,e){if(!i.feature)return;const r=i.feature;r.id!==void 0&&e.writeVarintField(1,r.id),e.writeMessage(2,wx,i),e.writeVarintField(3,r.type),e.writeMessage(4,Tx,r)}function wx(i,e){for(const r in i.feature?.properties){let n=i.feature.properties[r],a=i.keycache[r];if(n==null)continue;a===void 0&&(i.keys.push(r),a=i.keys.length-1,i.keycache[r]=a),e.writeVarint(a),typeof n!="string"&&typeof n!="boolean"&&typeof n!="number"&&(n=JSON.stringify(n));const h=typeof n+":"+n;let d=i.valuecache[h];d===void 0&&(i.values.push(n),d=i.values.length-1,i.valuecache[h]=d),e.writeVarint(d)}}function $p(i,e){return(e<<3)+(7&i)}function Eg(i){return i<<1^i>>31}function Tx(i,e){const r=i.loadGeometry(),n=i.type;let a=0,h=0;for(const d of r){let m=1;n===1&&(m=d.length),e.writeVarint($p(1,m));const y=n===3?d.length-1:d.length;for(let w=0;w<y;w++){w===1&&n!==1&&e.writeVarint($p(2,y-1));const P=d[w].x-a,I=d[w].y-h;e.writeVarint(Eg(P)),e.writeVarint(Eg(I)),a+=P,h+=I}i.type===3&&e.writeVarint($p(7,1))}}function Sx(i,e){const r=typeof i;r==="string"?e.writeStringField(1,i):r==="boolean"?e.writeBooleanField(7,i):r==="number"&&(i%1!=0?e.writeDoubleField(3,i):i<0?e.writeSVarintField(6,i):e.writeVarintField(5,i))}class Mg{constructor(e,r){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new So(Ct,16,0),this.grid3D=new So(Ct,16,0),this.featureIndexArray=new V,this.promoteId=r}insert(e,r,n,a,h,d){const m=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(n,a,h);const y=d?this.grid3D:this.grid;for(let w=0;w<r.length;w++){const P=r[w],I=[1/0,1/0,-1/0,-1/0];for(let C=0;C<P.length;C++){const D=P[C];I[0]=Math.min(I[0],D.x),I[1]=Math.min(I[1],D.y),I[2]=Math.max(I[2],D.x),I[3]=Math.max(I[3],D.y)}I[0]<Ct&&I[1]<Ct&&I[2]>=0&&I[3]>=0&&y.insert(m,I[0],I[1],I[2],I[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=this.encoding!=="mlt"?new dm(new jh(this.rawTileData)).layers:new Pg(this.rawTileData).layers,this.sourceLayerCoder=new Xm(this.vtLayers?Object.keys(this.vtLayers).sort():[cu])),this.vtLayers}query(e,r,n,a){this.loadVTLayers();const h=e.params,d=Ct/e.tileSize/e.scale,m=ea(h.filter,h.globalState),y=e.queryGeometry,w=e.queryPadding*d,P=Sa.fromPoints(y),I=this.grid.query(P.minX-w,P.minY-w,P.maxX+w,P.maxY+w),C=Sa.fromPoints(e.cameraQueryGeometry).expandBy(w),D=this.grid3D.query(C.minX,C.minY,C.maxX,C.maxY,((B,U,ee,q)=>(function(H,re,ae,be,Le){for(const Ne of H)if(re<=Ne.x&&ae<=Ne.y&&be>=Ne.x&&Le>=Ne.y)return!0;const De=[new $(re,ae),new $(re,Le),new $(be,Le),new $(be,ae)];if(H.length>2){for(const Ne of De)if(bl(H,Ne))return!0}for(let Ne=0;Ne<H.length-1;Ne++)if(Ey(H[Ne],H[Ne+1],De))return!0;return!1})(e.cameraQueryGeometry,B-w,U-w,ee+w,q+w)));for(const B of D)I.push(B);I.sort(Px);const F={};let L;for(let B=0;B<I.length;B++){const U=I[B];if(U===L)continue;L=U;const ee=this.featureIndexArray.get(U);let q=null;this.loadMatchingFeature(F,ee.bucketIndex,ee.sourceLayerIndex,ee.featureIndex,m,h.layers,h.availableImages,r,n,a,((H,re,ae)=>(q||(q=Tn(H)),re.queryIntersectsFeature({queryGeometry:y,feature:H,featureState:ae,geometry:q,zoom:this.z,transform:e.transform,pixelsToTileUnits:d,pixelPosMatrix:e.pixelPosMatrix,unwrappedTileID:this.tileID.toUnwrapped(),getElevation:e.getElevation}))))}return F}loadMatchingFeature(e,r,n,a,h,d,m,y,w,P,I){const C=this.bucketLayerIDs[r];if(d&&!C.some((B=>d.has(B))))return;const D=this.sourceLayerCoder.decode(n),F=this.vtLayers[D].feature(a);if(h.needGeometry){const B=Sn(F,!0);if(!h.filter(new gr(this.tileID.overscaledZ),B,this.tileID.canonical))return}else if(!h.filter(new gr(this.tileID.overscaledZ),F))return;const L=this.getId(F,D);for(let B=0;B<C.length;B++){const U=C[B];if(d&&!d.has(U))continue;const ee=y[U];if(!ee)continue;let q={};L&&P&&(q=P.getState(ee.sourceLayer||cu,L));const H=Sr({},w[U]);H.paint=Ig(H.paint,ee.paint,F,q,m),H.layout=Ig(H.layout,ee.layout,F,q,m);const re=!I||I(F,ee,q);if(!re)continue;const ae=new Ym(F,this.z,this.x,this.y,L);ae.layer=H;let be=e[U];be===void 0&&(be=e[U]=[]),be.push({featureIndex:a,feature:ae,intersectionZ:re})}}lookupSymbolFeatures(e,r,n,a,h,d,m,y){const w={};this.loadVTLayers();const P=ea(h.filterSpec,h.globalState);for(const I of e)this.loadMatchingFeature(w,n,a,I,P,d,m,y,r);return w}hasLayer(e){for(const r of this.bucketLayerIDs)for(const n of r)if(e===n)return!0;return!1}getId(e,r){var n;let a=e.id;return this.promoteId&&(a=e.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[r]],typeof a=="boolean"&&(a=Number(a)),a===void 0&&(!((n=e.properties)===null||n===void 0)&&n.cluster)&&this.promoteId&&(a=Number(e.properties.cluster_id))),a}}function Ig(i,e,r,n,a){return Lr(i,((h,d)=>{const m=e instanceof pa?e.get(d):null;return m&&m.evaluate?m.evaluate(r,n,a):m}))}function Px(i,e){return e-i}function Ag(i,e,r,n,a){const h=[];for(let d=0;d<i.length;d++){const m=i[d];let y;for(let w=0;w<m.length-1;w++){let P=m[w],I=m[w+1];P.x<e&&I.x<e||(P.x<e?P=new $(e,P.y+(e-P.x)/(I.x-P.x)*(I.y-P.y))._round():I.x<e&&(I=new $(e,P.y+(e-P.x)/(I.x-P.x)*(I.y-P.y))._round()),P.y<r&&I.y<r||(P.y<r?P=new $(P.x+(r-P.y)/(I.y-P.y)*(I.x-P.x),r)._round():I.y<r&&(I=new $(P.x+(r-P.y)/(I.y-P.y)*(I.x-P.x),r)._round()),P.x>=n&&I.x>=n||(P.x>=n?P=new $(n,P.y+(n-P.x)/(I.x-P.x)*(I.y-P.y))._round():I.x>=n&&(I=new $(n,P.y+(n-P.x)/(I.x-P.x)*(I.y-P.y))._round()),P.y>=a&&I.y>=a||(P.y>=a?P=new $(P.x+(a-P.y)/(I.y-P.y)*(I.x-P.x),a)._round():I.y>=a&&(I=new $(P.x+(a-P.y)/(I.y-P.y)*(I.x-P.x),a)._round()),y&&P.equals(y[y.length-1])||(y=[P],h.push(y)),y.push(I)))))}}return h}function Cg(i,e,r,n,a){switch(e){case 1:return(function(h,d,m,y){const w=[];for(const P of h)for(const I of P){const C=y===0?I.x:I.y;C>=d&&C<=m&&w.push([I])}return w})(i,r,n,a);case 2:return kg(i,r,n,a,!1);case 3:return kg(i,r,n,a,!0)}return[]}function Ex(i,e,r,n,a){const h=n===0?Mx:Ix;let d=[];const m=[];for(let P=0;P<i.length-1;P++){const I=i[P],C=i[P+1],D=n===0?I.x:I.y,F=n===0?C.x:C.y;let L=!1;D<e?F>e&&d.push(h(I,C,e)):D>r?F<r&&d.push(h(I,C,r)):d.push(I),F<e&&D>=e&&(d.push(h(I,C,e)),L=!0),F>r&&D<=r&&(d.push(h(I,C,r)),L=!0),!a&&L&&(m.push(d),d=[])}const y=i.length-1,w=n===0?i[y].x:i[y].y;return w>=e&&w<=r&&d.push(i[y]),a&&d.length>0&&!d[0].equals(d[d.length-1])&&d.push(new $(d[0].x,d[0].y)),d.length>0&&m.push(d),m}function kg(i,e,r,n,a){const h=[];for(const d of i){const m=Ex(d,e,r,n,a);m.length>0&&h.push(...m)}return h}function Mx(i,e,r){return new $(r,i.y+(r-i.x)/(e.x-i.x)*(e.y-i.y))}function Ix(i,e,r){return new $(i.x+(r-i.y)/(e.y-i.y)*(e.x-i.x),r)}ht("FeatureIndex",Mg,{omit:["rawTileData","sourceLayerCoder"]});class Do extends ${constructor(e,r,n,a){super(e,r),this.angle=n,a!==void 0&&(this.segment=a)}clone(){return new Do(this.x,this.y,this.angle,this.segment)}}function Dg(i,e,r,n,a){if(e.segment===void 0||r===0)return!0;let h=e,d=e.segment+1,m=0;for(;m>-r/2;){if(d--,d<0)return!1;m-=i[d].dist(h),h=i[d]}m+=i[d].dist(i[d+1]),d++;const y=[];let w=0;for(;m<r/2;){const P=i[d],I=i[d+1];if(!I)return!1;let C=i[d-1].angleTo(P)-P.angleTo(I);for(C=Math.abs((C+3*Math.PI)%(2*Math.PI)-Math.PI),y.push({distance:m,angleDelta:C}),w+=C;m-y[0].distance>n;)w-=y.shift().angleDelta;if(w>a)return!1;d++,m+=P.dist(I)}return!0}function zg(i){let e=0;for(let r=0;r<i.length-1;r++)e+=i[r].dist(i[r+1]);return e}function Rg(i,e,r){return i?.6*e*r:0}function Fg(i,e){return Math.max(i?i.right-i.left:0,e?e.right-e.left:0)}function Ax(i,e,r,n,a,h){const d=Rg(r,a,h),m=Fg(r,n)*h;let y=0;const w=zg(i)/2;for(let P=0;P<i.length-1;P++){const I=i[P],C=i[P+1],D=I.dist(C);if(y+D>w){const F=(w-y)/D,L=kr.number(I.x,C.x,F),B=kr.number(I.y,C.y,F),U=new Do(L,B,C.angleTo(I),P);return U._round(),!d||Dg(i,U,m,d,e)?U:void 0}y+=D}}function Cx(i,e,r,n,a,h,d,m,y){const w=Rg(n,h,d),P=Fg(n,a),I=P*d,C=i[0].x===0||i[0].x===y||i[0].y===0||i[0].y===y;return e-I<e/4&&(e=I+e/4),Lg(i,C?e/2*m%e:(P/2+2*h)*d*m%e,e,w,r,I,C,!1,y)}function Lg(i,e,r,n,a,h,d,m,y){const w=h/2,P=zg(i);let I=0,C=e-r,D=[];for(let F=0;F<i.length-1;F++){const L=i[F],B=i[F+1],U=L.dist(B),ee=B.angleTo(L);for(;C+r<I+U;){C+=r;const q=(C-I)/U,H=kr.number(L.x,B.x,q),re=kr.number(L.y,B.y,q);if(H>=0&&H<y&&re>=0&&re<y&&C-w>=0&&C+w<=P){const ae=new Do(H,re,ee,F);ae._round(),n&&!Dg(i,ae,h,n,a)||D.push(ae)}}I+=U}return m||D.length||d||(D=Lg(i,I/2,r,n,a,h,d,!0,y)),D}function Og(i,e,r,n){const a=[],h=i.image,d=h.pixelRatio,m=h.paddedRect.w-2,y=h.paddedRect.h-2;let w={x1:i.left,y1:i.top,x2:i.right,y2:i.bottom};const P=h.stretchX||[[0,m]],I=h.stretchY||[[0,y]],C=(Ae,ut)=>Ae+ut[1]-ut[0],D=P.reduce(C,0),F=I.reduce(C,0),L=m-D,B=y-F;let U=0,ee=D,q=0,H=F,re=0,ae=L,be=0,Le=B;if(h.content&&n){const Ae=h.content,ut=Ae[2]-Ae[0],lt=Ae[3]-Ae[1];(h.textFitWidth||h.textFitHeight)&&(w=Dm(i)),U=Jh(P,0,Ae[0]),q=Jh(I,0,Ae[1]),ee=Jh(P,Ae[0],Ae[2]),H=Jh(I,Ae[1],Ae[3]),re=Ae[0]-U,be=Ae[1]-q,ae=ut-ee,Le=lt-H}const De=w.x1,Ne=w.y1,tt=w.x2-De,qe=w.y2-Ne,Re=(Ae,ut,lt,dt)=>{const nt=Kh(Ae.stretch-U,ee,tt,De),Tt=Qh(Ae.fixed-re,ae,Ae.stretch,D),ir=Kh(ut.stretch-q,H,qe,Ne),Gt=Qh(ut.fixed-be,Le,ut.stretch,F),Rr=Kh(lt.stretch-U,ee,tt,De),zi=Qh(lt.fixed-re,ae,lt.stretch,D),ai=Kh(dt.stretch-q,H,qe,Ne),Fr=Qh(dt.fixed-be,Le,dt.stretch,F),Ar=new $(nt,ir),ur=new $(Rr,ir),Gr=new $(Rr,ai),Qr=new $(nt,ai),Er=new $(Tt/d,Gt/d),ns=new $(zi/d,Fr/d),Ri=e*Math.PI/180;if(Ri){const vi=Math.sin(Ri),jr=Math.cos(Ri),li=[jr,-vi,vi,jr];Ar._matMult(li),ur._matMult(li),Qr._matMult(li),Gr._matMult(li)}const os=Ae.stretch+Ae.fixed,qs=ut.stretch+ut.fixed;return{tl:Ar,tr:ur,bl:Qr,br:Gr,tex:{x:h.paddedRect.x+1+os,y:h.paddedRect.y+1+qs,w:lt.stretch+lt.fixed-os,h:dt.stretch+dt.fixed-qs},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Er,pixelOffsetBR:ns,minFontScaleX:ae/d/tt,minFontScaleY:Le/d/qe,isSDF:r}};if(n&&(h.stretchX||h.stretchY)){const Ae=Bg(P,L,D),ut=Bg(I,B,F);for(let lt=0;lt<Ae.length-1;lt++){const dt=Ae[lt],nt=Ae[lt+1];for(let Tt=0;Tt<ut.length-1;Tt++)a.push(Re(dt,ut[Tt],nt,ut[Tt+1]))}}else a.push(Re({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:m+1},{fixed:0,stretch:y+1}));return a}function Jh(i,e,r){let n=0;for(const a of i)n+=Math.max(e,Math.min(r,a[1]))-Math.max(e,Math.min(r,a[0]));return n}function Bg(i,e,r){const n=[{fixed:-1,stretch:0}];for(const[a,h]of i){const d=n[n.length-1];n.push({fixed:a-d.stretch,stretch:d.stretch}),n.push({fixed:a-d.stretch,stretch:d.stretch+(h-a)})}return n.push({fixed:e+1,stretch:r}),n}function Kh(i,e,r,n){return i/e*r+n}function Qh(i,e,r,n){return i-e*r/n}ht("Anchor",Do);class ed{constructor(e,r,n,a,h,d,m,y,w,P){var I;if(this.boxStartIndex=e.length,w){let C=d.top,D=d.bottom;const F=d.collisionPadding;F&&(C-=F[1],D+=F[3]);let L=D-C;L>0&&(L=Math.max(10,L),this.circleDiameter=L)}else{const C=!((I=d.image)===null||I===void 0)&&I.content&&(d.image.textFitWidth||d.image.textFitHeight)?Dm(d):{x1:d.left,y1:d.top,x2:d.right,y2:d.bottom};C.y1=C.y1*m-y[0],C.y2=C.y2*m+y[2],C.x1=C.x1*m-y[3],C.x2=C.x2*m+y[1];const D=d.collisionPadding;if(D&&(C.x1-=D[0]*m,C.y1-=D[1]*m,C.x2+=D[2]*m,C.y2+=D[3]*m),P){const F=new $(C.x1,C.y1),L=new $(C.x2,C.y1),B=new $(C.x1,C.y2),U=new $(C.x2,C.y2),ee=P*Math.PI/180;F._rotate(ee),L._rotate(ee),B._rotate(ee),U._rotate(ee),C.x1=Math.min(F.x,L.x,B.x,U.x),C.x2=Math.max(F.x,L.x,B.x,U.x),C.y1=Math.min(F.y,L.y,B.y,U.y),C.y2=Math.max(F.y,L.y,B.y,U.y)}e.emplaceBack(r.x,r.y,C.x1,C.y1,C.x2,C.y2,n,a,h)}this.boxEndIndex=e.length}}class kx{constructor(e=[],r=(n,a)=>n<a?-1:n>a?1:0){if(this.data=e,this.length=this.data.length,this.compare=r,this.length>0)for(let n=(this.length>>1)-1;n>=0;n--)this._down(n)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],r=this.data.pop();return--this.length>0&&(this.data[0]=r,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:r,compare:n}=this,a=r[e];for(;e>0;){const h=e-1>>1,d=r[h];if(n(a,d)>=0)break;r[e]=d,e=h}r[e]=a}_down(e){const{data:r,compare:n}=this,a=this.length>>1,h=r[e];for(;e<a;){let d=1+(e<<1);const m=d+1;if(m<this.length&&n(r[m],r[d])<0&&(d=m),n(r[d],h)>=0)break;r[e]=r[d],e=d}r[e]=h}}function Dx(i,e=1,r=!1){const n=Sa.fromPoints(i[0]),a=Math.min(n.width(),n.height());let h=a/2;const d=new kx([],zx),{minX:m,minY:y,maxX:w,maxY:P}=n;if(a===0)return new $(m,y);for(let D=m;D<w;D+=a)for(let F=y;F<P;F+=a)d.push(new Rl(D+h,F+h,h,i));let I=(function(D){let F=0,L=0,B=0;const U=D[0];for(let ee=0,q=U.length,H=q-1;ee<q;H=ee++){const re=U[ee],ae=U[H],be=re.x*ae.y-ae.x*re.y;L+=(re.x+ae.x)*be,B+=(re.y+ae.y)*be,F+=3*be}return new Rl(L/F,B/F,0,D)})(i),C=d.length;for(;d.length;){const D=d.pop();(D.d>I.d||!I.d)&&(I=D,r&&console.log("found best %d after %d probes",Math.round(1e4*D.d)/1e4,C)),D.max-I.d<=e||(h=D.h/2,d.push(new Rl(D.p.x-h,D.p.y-h,h,i)),d.push(new Rl(D.p.x+h,D.p.y-h,h,i)),d.push(new Rl(D.p.x-h,D.p.y+h,h,i)),d.push(new Rl(D.p.x+h,D.p.y+h,h,i)),C+=4)}return r&&(console.log(`num probes: ${C}`),console.log(`best distance: ${I.d}`)),I.p}function zx(i,e){return e.max-i.max}function Rl(i,e,r,n){this.p=new $(i,e),this.h=r,this.d=(function(a,h){let d=!1,m=1/0;for(let y=0;y<h.length;y++){const w=h[y];for(let P=0,I=w.length,C=I-1;P<I;C=P++){const D=w[P],F=w[C];D.y>a.y!=F.y>a.y&&a.x<(F.x-D.x)*(a.y-D.y)/(F.y-D.y)+D.x&&(d=!d),m=Math.min(m,Uf(a,D,F))}}return(d?1:-1)*Math.sqrt(m)})(this.p,n),this.max=this.d+this.h*Math.SQRT2}var Di;S.aP=void 0,(Di=S.aP||(S.aP={}))[Di.center=1]="center",Di[Di.left=2]="left",Di[Di.right=3]="right",Di[Di.top=4]="top",Di[Di.bottom=5]="bottom",Di[Di["top-left"]=6]="top-left",Di[Di["top-right"]=7]="top-right",Di[Di["bottom-left"]=8]="bottom-left",Di[Di["bottom-right"]=9]="bottom-right";const Up=Number.POSITIVE_INFINITY;function jg(i,e){return e[1]!==Up?(function(r,n,a){let h=0,d=0;switch(n=Math.abs(n),a=Math.abs(a),r){case"top-right":case"top-left":case"top":d=a-7;break;case"bottom-right":case"bottom-left":case"bottom":d=7-a}switch(r){case"top-right":case"bottom-right":case"right":h=-n;break;case"top-left":case"bottom-left":case"left":h=n}return[h,d]})(i,e[0],e[1]):(function(r,n){let a=0,h=0;n<0&&(n=0);const d=n/Math.SQRT2;switch(r){case"top-right":case"top-left":h=d-7;break;case"bottom-right":case"bottom-left":h=7-d;break;case"bottom":h=7-n;break;case"top":h=n-7}switch(r){case"top-right":case"bottom-right":a=-d;break;case"top-left":case"bottom-left":a=d;break;case"left":a=n;break;case"right":a=-n}return[a,h]})(i,e[0])}function Ng(i,e,r){var n;const a=i.layout,h=(n=a.get("text-variable-anchor-offset"))===null||n===void 0?void 0:n.evaluate(e,{},r);if(h){const m=h.values,y=[];for(let w=0;w<m.length;w+=2){const P=y[w]=m[w],I=m[w+1].map((C=>C*_i));P.startsWith("top")?I[1]-=7:P.startsWith("bottom")&&(I[1]+=7),y[w+1]=I}return new Vi(y)}const d=a.get("text-variable-anchor");if(d){let m;m=i._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[a.get("text-radial-offset").evaluate(e,{},r)*_i,Up]:a.get("text-offset").evaluate(e,{},r).map((w=>w*_i));const y=[];for(const w of d)y.push(w,jg(w,m));return new Vi(y)}return null}function qp(i){switch(i){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Rx(i,e,r,n,a,h,d,m,y,w,P,I){let C=h.textMaxSize.evaluate(e,{});C===void 0&&(C=d);const D=i.layers[0].layout,F=D.get("icon-offset").evaluate(e,{},P),L=$g(r.horizontal),B=d/24,U=i.tilePixelRatio*B,ee=i.tilePixelRatio*C/24,q=i.tilePixelRatio*m,H=i.tilePixelRatio*D.get("symbol-spacing"),re=D.get("text-padding")*i.tilePixelRatio,ae=(function(lt,dt,nt,Tt=1){const ir=lt.get("icon-padding").evaluate(dt,{},nt),Gt=ir&&ir.values;return[Gt[0]*Tt,Gt[1]*Tt,Gt[2]*Tt,Gt[3]*Tt]})(D,e,P,i.tilePixelRatio),be=D.get("text-max-angle")/180*Math.PI,Le=D.get("text-rotation-alignment")!=="viewport"&&D.get("symbol-placement")!=="point",De=D.get("icon-rotation-alignment")==="map"&&D.get("symbol-placement")!=="point",Ne=D.get("symbol-placement"),tt=H/2,qe=D.get("icon-text-fit");let Re;n&&qe!=="none"&&(i.allowVerticalPlacement&&r.vertical&&(Re=zm(n,r.vertical,qe,D.get("icon-text-fit-padding"),F,B)),L&&(n=zm(n,L,qe,D.get("icon-text-fit-padding"),F,B)));const Ae=P?I.line.getGranularityForZoomLevel(P.z):1,ut=(lt,dt)=>{dt.x<0||dt.x>=Ct||dt.y<0||dt.y>=Ct||(function(nt,Tt,ir,Gt,Rr,zi,ai,Fr,Ar,ur,Gr,Qr,Er,ns,Ri,os,qs,vi,jr,li,Zr,bi,Jn,en,du){const zo=nt.addToLineVertexArray(Tt,ir);let Ma,Fl,Ll,Ol,Zg=0,Hg=0,Wg=0,Xg=0,Kp=-1,Qp=-1;const Kn={};let Yg=Kr("");if(nt.allowVerticalPlacement&&Gt.vertical){const Gi=Fr.layout.get("text-rotate").evaluate(Zr,{},en)+90;Ll=new ed(Ar,Tt,ur,Gr,Qr,Gt.vertical,Er,ns,Ri,Gi),ai&&(Ol=new ed(Ar,Tt,ur,Gr,Qr,ai,qs,vi,Ri,Gi))}if(Rr){const Gi=Fr.layout.get("icon-rotate").evaluate(Zr,{}),Cs=Fr.layout.get("icon-text-fit")!=="none",Ia=Og(Rr,Gi,Jn,Cs),rn=ai?Og(ai,Gi,Jn,Cs):void 0;Fl=new ed(Ar,Tt,ur,Gr,Qr,Rr,qs,vi,!1,Gi),Zg=4*Ia.length;const Aa=nt.iconSizeData;let Pn=null;Aa.kind==="source"?(Pn=[Xn*Fr.layout.get("icon-size").evaluate(Zr,{})],Pn[0]>Ao&&Vr(`${nt.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):Aa.kind==="composite"&&(Pn=[Xn*bi.compositeIconSizes[0].evaluate(Zr,{},en),Xn*bi.compositeIconSizes[1].evaluate(Zr,{},en)],(Pn[0]>Ao||Pn[1]>Ao)&&Vr(`${nt.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),nt.addSymbols(nt.icon,Ia,Pn,li,jr,Zr,S.az.none,Tt,zo.lineStartIndex,zo.lineLength,-1,en),Kp=nt.icon.placedSymbolArray.length-1,rn&&(Hg=4*rn.length,nt.addSymbols(nt.icon,rn,Pn,li,jr,Zr,S.az.vertical,Tt,zo.lineStartIndex,zo.lineLength,-1,en),Qp=nt.icon.placedSymbolArray.length-1)}const Jg=Object.keys(Gt.horizontal);for(const Gi of Jg){const Cs=Gt.horizontal[Gi];if(!Ma){Yg=Kr(Cs.text);const rn=Fr.layout.get("text-rotate").evaluate(Zr,{},en);Ma=new ed(Ar,Tt,ur,Gr,Qr,Cs,Er,ns,Ri,rn)}const Ia=Cs.positionedLines.length===1;if(Wg+=Vg(nt,Tt,Cs,zi,Fr,Ri,Zr,os,zo,Gt.vertical?S.az.horizontal:S.az.horizontalOnly,Ia?Jg:[Gi],Kn,Kp,bi,en),Ia)break}Gt.vertical&&(Xg+=Vg(nt,Tt,Gt.vertical,zi,Fr,Ri,Zr,os,zo,S.az.vertical,["vertical"],Kn,Qp,bi,en));const Ox=Ma?Ma.boxStartIndex:nt.collisionBoxArray.length,Bx=Ma?Ma.boxEndIndex:nt.collisionBoxArray.length,jx=Ll?Ll.boxStartIndex:nt.collisionBoxArray.length,Nx=Ll?Ll.boxEndIndex:nt.collisionBoxArray.length,Vx=Fl?Fl.boxStartIndex:nt.collisionBoxArray.length,$x=Fl?Fl.boxEndIndex:nt.collisionBoxArray.length,Ux=Ol?Ol.boxStartIndex:nt.collisionBoxArray.length,qx=Ol?Ol.boxEndIndex:nt.collisionBoxArray.length;let tn=-1;const rd=(Gi,Cs)=>Gi&&Gi.circleDiameter?Math.max(Gi.circleDiameter,Cs):Cs;tn=rd(Ma,tn),tn=rd(Ll,tn),tn=rd(Fl,tn),tn=rd(Ol,tn);const Kg=tn>-1?1:0;Kg&&(tn*=du/_i),nt.glyphOffsetArray.length>=Il.MAX_GLYPHS&&Vr("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Zr.sortKey!==void 0&&nt.addToSortKeyRanges(nt.symbolInstances.length,Zr.sortKey);const Gx=Ng(Fr,Zr,en),[Zx,Hx]=(function(Gi,Cs){const Ia=Gi.length,rn=Cs?.values;if(rn?.length>0)for(let Aa=0;Aa<rn.length;Aa+=2){const Pn=rn[Aa+1];Gi.emplaceBack(S.aP[rn[Aa]],Pn[0],Pn[1])}return[Ia,Gi.length]})(nt.textAnchorOffsets,Gx);nt.symbolInstances.emplaceBack(Tt.x,Tt.y,Kn.right>=0?Kn.right:-1,Kn.center>=0?Kn.center:-1,Kn.left>=0?Kn.left:-1,Kn.vertical||-1,Kp,Qp,Yg,Ox,Bx,jx,Nx,Vx,$x,Ux,qx,ur,Wg,Xg,Zg,Hg,Kg,0,Er,tn,Zx,Hx)})(i,dt,lt,r,n,a,Re,i.layers[0],i.collisionBoxArray,e.index,e.sourceLayerIndex,i.index,U,[re,re,re,re],Le,y,q,ae,De,F,e,h,w,P,d)};if(Ne==="line")for(const lt of Ag(e.geometry,0,0,Ct,Ct)){const dt=Ta(lt,Ae),nt=Cx(dt,H,be,r.vertical||L,n,24,ee,i.overscaling,Ct);for(const Tt of nt)L&&Fx(i,L.text,tt,Tt)||ut(dt,Tt)}else if(Ne==="line-center"){for(const lt of e.geometry)if(lt.length>1){const dt=Ta(lt,Ae),nt=Ax(dt,be,r.vertical||L,n,24,ee);nt&&ut(dt,nt)}}else if(e.type==="Polygon")for(const lt of $a(e.geometry,0)){const dt=Dx(lt,16);ut(Ta(lt[0],Ae,!0),new Do(dt.x,dt.y,0))}else if(e.type==="LineString")for(const lt of e.geometry){const dt=Ta(lt,Ae);ut(dt,new Do(dt[0].x,dt[0].y,0))}else if(e.type==="Point")for(const lt of e.geometry)for(const dt of lt)ut([dt],new Do(dt.x,dt.y,0))}function Vg(i,e,r,n,a,h,d,m,y,w,P,I,C,D,F){const L=(function(ee,q,H,re,ae,be,Le,De){const Ne=re.layout.get("text-rotate").evaluate(be,{})*Math.PI/180,tt=[];for(const qe of q.positionedLines)for(const Re of qe.positionedGlyphs){if(!Re.rect)continue;const Ae=Re.rect||{};let ut=4,lt=!0,dt=1,nt=0;const Tt=(ae||De)&&Re.vertical,ir=Re.metrics.advance*Re.scale/2;if(De&&q.verticalizable&&(nt=qe.lineOffset/2-(Re.imageName?-(_i-Re.metrics.width*Re.scale)/2:(Re.scale-1)*_i)),Re.imageName){const vi=Le[Re.imageName];lt=vi.sdf,dt=vi.pixelRatio,ut=1/dt}const Gt=ae?[Re.x+ir,Re.y]:[0,0];let Rr=ae?[0,0]:[Re.x+ir+H[0],Re.y+H[1]-nt],zi=[0,0];Tt&&(zi=Rr,Rr=[0,0]);const ai=Re.metrics.isDoubleResolution?2:1,Fr=(Re.metrics.left-ut)*Re.scale-ir+Rr[0],Ar=(-Re.metrics.top-ut)*Re.scale+Rr[1],ur=Fr+Ae.w/ai*Re.scale/dt,Gr=Ar+Ae.h/ai*Re.scale/dt,Qr=new $(Fr,Ar),Er=new $(ur,Ar),ns=new $(Fr,Gr),Ri=new $(ur,Gr);if(Tt){const vi=new $(-ir,ir- -17),jr=-Math.PI/2,li=12-ir,Zr=new $(22-li,-(Re.imageName?li:0)),bi=new $(...zi);Qr._rotateAround(jr,vi)._add(Zr)._add(bi),Er._rotateAround(jr,vi)._add(Zr)._add(bi),ns._rotateAround(jr,vi)._add(Zr)._add(bi),Ri._rotateAround(jr,vi)._add(Zr)._add(bi)}if(Ne){const vi=Math.sin(Ne),jr=Math.cos(Ne),li=[jr,-vi,vi,jr];Qr._matMult(li),Er._matMult(li),ns._matMult(li),Ri._matMult(li)}const os=new $(0,0),qs=new $(0,0);tt.push({tl:Qr,tr:Er,bl:ns,br:Ri,tex:Ae,writingMode:q.writingMode,glyphOffset:Gt,sectionIndex:Re.sectionIndex,isSDF:lt,pixelOffsetTL:os,pixelOffsetBR:qs,minFontScaleX:0,minFontScaleY:0})}return tt})(0,r,m,a,h,d,n,i.allowVerticalPlacement),B=i.textSizeData;let U=null;B.kind==="source"?(U=[Xn*a.layout.get("text-size").evaluate(d,{})],U[0]>Ao&&Vr(`${i.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):B.kind==="composite"&&(U=[Xn*D.compositeTextSizes[0].evaluate(d,{},F),Xn*D.compositeTextSizes[1].evaluate(d,{},F)],(U[0]>Ao||U[1]>Ao)&&Vr(`${i.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),i.addSymbols(i.text,L,U,m,h,d,w,e,y.lineStartIndex,y.lineLength,C,F);for(const ee of P)I[ee]=i.text.placedSymbolArray.length-1;return 4*L.length}function $g(i){for(const e in i)return i[e];return null}function Fx(i,e,r,n){const a=i.compareText;if(e in a){const h=a[e];for(let d=h.length-1;d>=0;d--)if(n.dist(h[d])<r)return!0}else a[e]=[];return a[e].push(n),!1}const Ug=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Gp{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[r,n]=new Uint8Array(e,0,2);if(r!==219)throw new Error("Data does not appear to be in a KDBush format.");const a=n>>4;if(a!==1)throw new Error(`Got v${a} data when expected v1.`);const h=Ug[15&n];if(!h)throw new Error("Unrecognized array type.");const[d]=new Uint16Array(e,2,1),[m]=new Uint32Array(e,4,1);return new Gp(m,d,h,e)}constructor(e,r=64,n=Float64Array,a){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+r,2),65535),this.ArrayType=n,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const h=Ug.indexOf(this.ArrayType),d=2*e*this.ArrayType.BYTES_PER_ELEMENT,m=e*this.IndexArrayType.BYTES_PER_ELEMENT,y=(8-m%8)%8;if(h<0)throw new Error(`Unexpected typed array class: ${n}.`);a&&a instanceof ArrayBuffer?(this.data=a,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+m+y,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+d+m+y),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+m+y,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+h]),new Uint16Array(this.data,2,1)[0]=r,new Uint32Array(this.data,4,1)[0]=e)}add(e,r){const n=this._pos>>1;return this.ids[n]=n,this.coords[this._pos++]=e,this.coords[this._pos++]=r,n}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return Zp(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,r,n,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:h,coords:d,nodeSize:m}=this,y=[0,h.length-1,0],w=[];for(;y.length;){const P=y.pop()||0,I=y.pop()||0,C=y.pop()||0;if(I-C<=m){for(let B=C;B<=I;B++){const U=d[2*B],ee=d[2*B+1];U>=e&&U<=n&&ee>=r&&ee<=a&&w.push(h[B])}continue}const D=C+I>>1,F=d[2*D],L=d[2*D+1];F>=e&&F<=n&&L>=r&&L<=a&&w.push(h[D]),(P===0?e<=F:r<=L)&&(y.push(C),y.push(D-1),y.push(1-P)),(P===0?n>=F:a>=L)&&(y.push(D+1),y.push(I),y.push(1-P))}return w}within(e,r,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:h,nodeSize:d}=this,m=[0,a.length-1,0],y=[],w=n*n;for(;m.length;){const P=m.pop()||0,I=m.pop()||0,C=m.pop()||0;if(I-C<=d){for(let B=C;B<=I;B++)Gg(h[2*B],h[2*B+1],e,r)<=w&&y.push(a[B]);continue}const D=C+I>>1,F=h[2*D],L=h[2*D+1];Gg(F,L,e,r)<=w&&y.push(a[D]),(P===0?e-n<=F:r-n<=L)&&(m.push(C),m.push(D-1),m.push(1-P)),(P===0?e+n>=F:r+n>=L)&&(m.push(D+1),m.push(I),m.push(1-P))}return y}}function Zp(i,e,r,n,a,h){if(a-n<=r)return;const d=n+a>>1;qg(i,e,d,n,a,h),Zp(i,e,r,n,d-1,1-h),Zp(i,e,r,d+1,a,1-h)}function qg(i,e,r,n,a,h){for(;a>n;){if(a-n>600){const w=a-n+1,P=r-n+1,I=Math.log(w),C=.5*Math.exp(2*I/3),D=.5*Math.sqrt(I*C*(w-C)/w)*(P-w/2<0?-1:1);qg(i,e,r,Math.max(n,Math.floor(r-P*C/w+D)),Math.min(a,Math.floor(r+(w-P)*C/w+D)),h)}const d=e[2*r+h];let m=n,y=a;for(uu(i,e,n,r),e[2*a+h]>d&&uu(i,e,n,a);m<y;){for(uu(i,e,m,y),m++,y--;e[2*m+h]<d;)m++;for(;e[2*y+h]>d;)y--}e[2*n+h]===d?uu(i,e,n,y):(y++,uu(i,e,y,a)),y<=r&&(n=y+1),r<=y&&(a=y-1)}}function uu(i,e,r,n){Hp(i,r,n),Hp(e,2*r,2*n),Hp(e,2*r+1,2*n+1)}function Hp(i,e,r){const n=i[e];i[e]=i[r],i[r]=n}function Gg(i,e,r,n){const a=i-r,h=e-n;return a*a+h*h}var Wp;S.cH=void 0,(Wp=S.cH||(S.cH={})).create="create",Wp.load="load",Wp.fullLoad="fullLoad";let td=null,hu=[];const Xp=1e3/60,Yp="loadTime",Jp="fullLoadTime",Lx={mark(i){performance.mark(i)},frame(i){const e=i;td!=null&&hu.push(e-td),td=e},clearMetrics(){td=null,hu=[],performance.clearMeasures(Yp),performance.clearMeasures(Jp);for(const i in S.cH)performance.clearMarks(S.cH[i])},getPerformanceMetrics(){performance.measure(Yp,S.cH.create,S.cH.load),performance.measure(Jp,S.cH.create,S.cH.fullLoad);const i=performance.getEntriesByName(Yp)[0].duration,e=performance.getEntriesByName(Jp)[0].duration,r=hu.length,n=1/(hu.reduce(((h,d)=>h+d),0)/r/1e3),a=hu.filter((h=>h>Xp)).reduce(((h,d)=>h+(d-Xp)/Xp),0);return{loadTime:i,fullLoadTime:e,fps:n,percentDroppedFrames:a/(r+a)*100,totalFrames:r}}};S.$=ge,S.A=At,S.B=To,S.C=mi,S.D=bt,S.E=er,S.F=function([i,e,r]){return e+=90,e*=Math.PI/180,r*=Math.PI/180,{x:i*Math.cos(e)*Math.sin(r),y:i*Math.sin(e)*Math.sin(r),z:i*Math.cos(r)}},S.G=kr,S.H=gr,S.I=_p,S.J=xh,S.K=function(i){if(Mr==null){const e=i.navigator?i.navigator.userAgent:null;Mr=!!i.safari||!(!e||!(/\b(iPad|iPhone|iPod)\b/.test(e)||e.match("Safari")&&!e.match("Chrome")))}return Mr},S.L=class{constructor(i,e){this.target=i,this.mapId=e,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new J0((()=>this.process())),this.subscription=_s(this.target,"message",(r=>this.receive(r)),!1),this.globalScope=Ni(self)?i:window}registerMessageHandler(i,e){this.messageHandlers[i]=e}unregisterMessageHandler(i){delete this.messageHandlers[i]}sendAsync(i,e){return new Promise(((r,n)=>{const a=Math.round(1e18*Math.random()).toString(36).substring(0,10),h=e?_s(e.signal,"abort",(()=>{h?.unsubscribe(),delete this.resolveRejects[a];const y={id:a,type:"<cancel>",origin:location.origin,targetMapId:i.targetMapId,sourceMapId:this.mapId};this.target.postMessage(y)}),K0):null;this.resolveRejects[a]={resolve:y=>{h?.unsubscribe(),r(y)},reject:y=>{h?.unsubscribe(),n(y)}};const d=[],m=Object.assign(Object.assign({},i),{id:a,sourceMapId:this.mapId,origin:location.origin,data:ca(i.data,d)});this.target.postMessage(m,{transfer:d})}))}receive(i){const e=i.data,r=e.id;if(!(e.origin!=="file://"&&location.origin!=="file://"&&e.origin!=="resource://android"&&location.origin!=="resource://android"&&e.origin!==location.origin||e.targetMapId&&this.mapId!==e.targetMapId)){if(e.type==="<cancel>"){delete this.tasks[r];const n=this.abortControllers[r];return delete this.abortControllers[r],void(n&&n.abort())}if(Ni(self)||e.mustQueue)return this.tasks[r]=e,this.taskQueue.push(r),void this.invoker.trigger();this.processTask(r,e)}}process(){if(this.taskQueue.length===0)return;const i=this.taskQueue.shift(),e=this.tasks[i];delete this.tasks[i],this.taskQueue.length>0&&this.invoker.trigger(),e&&this.processTask(i,e)}processTask(i,e){return l(this,void 0,void 0,(function*(){if(e.type==="<response>"){const a=this.resolveRejects[i];return delete this.resolveRejects[i],a?void(e.error?a.reject(ua(e.error)):a.resolve(ua(e.data))):void 0}if(!this.messageHandlers[e.type])return void this.completeTask(i,new Error(`Could not find a registered handler for ${e.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const r=ua(e.data),n=new AbortController;this.abortControllers[i]=n;try{const a=yield this.messageHandlers[e.type](e.sourceMapId,r,n);this.completeTask(i,null,a)}catch(a){this.completeTask(i,a)}}))}completeTask(i,e,r){const n=[];delete this.abortControllers[i];const a={id:i,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:e?ca(e):null,data:ca(r,n)};this.target.postMessage(a,{transfer:n})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},S.M=_e,S.N=function(){var i=new At(16);return At!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i},S.O=function(i,e,r){var n,a,h,d,m,y,w,P,I,C,D,F,L=r[0],B=r[1],U=r[2];return e===i?(i[12]=e[0]*L+e[4]*B+e[8]*U+e[12],i[13]=e[1]*L+e[5]*B+e[9]*U+e[13],i[14]=e[2]*L+e[6]*B+e[10]*U+e[14],i[15]=e[3]*L+e[7]*B+e[11]*U+e[15]):(a=e[1],h=e[2],d=e[3],m=e[4],y=e[5],w=e[6],P=e[7],I=e[8],C=e[9],D=e[10],F=e[11],i[0]=n=e[0],i[1]=a,i[2]=h,i[3]=d,i[4]=m,i[5]=y,i[6]=w,i[7]=P,i[8]=I,i[9]=C,i[10]=D,i[11]=F,i[12]=n*L+m*B+I*U+e[12],i[13]=a*L+y*B+C*U+e[13],i[14]=h*L+w*B+D*U+e[14],i[15]=d*L+P*B+F*U+e[15]),i},S.P=$,S.Q=function(i,e,r){var n=r[0],a=r[1],h=r[2];return i[0]=e[0]*n,i[1]=e[1]*n,i[2]=e[2]*n,i[3]=e[3]*n,i[4]=e[4]*a,i[5]=e[5]*a,i[6]=e[6]*a,i[7]=e[7]*a,i[8]=e[8]*h,i[9]=e[9]*h,i[10]=e[10]*h,i[11]=e[11]*h,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i},S.R=ss,S.S=function(i,e,r){var n=e[0],a=e[1],h=e[2],d=e[3],m=e[4],y=e[5],w=e[6],P=e[7],I=e[8],C=e[9],D=e[10],F=e[11],L=e[12],B=e[13],U=e[14],ee=e[15],q=r[0],H=r[1],re=r[2],ae=r[3];return i[0]=q*n+H*m+re*I+ae*L,i[1]=q*a+H*y+re*C+ae*B,i[2]=q*h+H*w+re*D+ae*U,i[3]=q*d+H*P+re*F+ae*ee,i[4]=(q=r[4])*n+(H=r[5])*m+(re=r[6])*I+(ae=r[7])*L,i[5]=q*a+H*y+re*C+ae*B,i[6]=q*h+H*w+re*D+ae*U,i[7]=q*d+H*P+re*F+ae*ee,i[8]=(q=r[8])*n+(H=r[9])*m+(re=r[10])*I+(ae=r[11])*L,i[9]=q*a+H*y+re*C+ae*B,i[10]=q*h+H*w+re*D+ae*U,i[11]=q*d+H*P+re*F+ae*ee,i[12]=(q=r[12])*n+(H=r[13])*m+(re=r[14])*I+(ae=r[15])*L,i[13]=q*a+H*y+re*C+ae*B,i[14]=q*h+H*w+re*D+ae*U,i[15]=q*d+H*P+re*F+ae*ee,i},S.T=lp,S.U=function(i,e){const r={};for(let n=0;n<e.length;n++){const a=e[n];a in i&&(r[a]=i[a])}return r},S.V=Co,S.W=ii,S.X=$m,S.Y=Vm,S.Z=ce,S._=l,S.a=Z,S.a$=pt,S.a0=Pt,S.a1=un,S.a2=Is,S.a3=qm,S.a4=Uh,S.a5=Ct,S.a6=function(i,e,r){if(!i)return e||{};if(!e)return i||{};const n=Wm(i),a=Wm(e);(function(d,m){m.removeAll&&(d.add.clear(),d.update.clear(),d.remove.clear(),m.remove.clear());for(const y of m.remove)d.add.delete(y),d.update.delete(y);for(const[y,w]of m.update){const P=d.update.get(y);P&&(m.update.set(y,Q0(P,w)),d.update.delete(y))}})(n,a);const h={};if((n.removeAll||a.removeAll)&&(h.removeAll=!0),h.remove=new Set([...n.remove,...a.remove]),h.add=new Map([...n.add,...a.add]),h.update=new Map([...n.update,...a.update]),h.remove.size&&h.add.size)for(const d of h.add.keys())h.remove.delete(d);return(function(d){const m={};return d.removeAll&&(m.removeAll=d.removeAll),d.remove&&(m.remove=Array.from(d.remove)),d.add&&(m.add=Array.from(d.add.values())),d.update&&(m.update=Array.from(d.update.values())),m})(h)},S.a7=function(i,e){const r=new Map;if(i==null||i.type==null)return r;if(i.type==="Feature"){const n=Ep(i,e);return n==null?void 0:(r.set(n,i),r)}if(i.type==="FeatureCollection"){const n=new Set;for(const a of i.features){const h=Ep(a,e);if(h==null||n.has(h))return;n.add(h),r.set(h,a)}return r}},S.a8=function(i,e,r){var n,a;const h=[];if(e.removeAll)i.clear();else if(e.remove)for(const d of e.remove){const m=i.get(d);m&&(h.push(m.geometry),i.delete(d))}if(e.add)for(const d of e.add){const m=Ep(d,r);if(m==null)continue;const y=i.get(m);y&&h.push(y.geometry),h.push(d.geometry),i.set(m,d)}if(e.update)for(const d of e.update){const m=i.get(d.id);if(!m)continue;const y=!!d.newGeometry,w=d.removeAllProperties||((n=d.removeProperties)===null||n===void 0?void 0:n.length)>0||((a=d.addOrUpdateProperties)===null||a===void 0?void 0:a.length)>0;if(!y&&!w)continue;h.push(m.geometry);const P=Object.assign({},m);if(i.set(d.id,P),y&&(h.push(d.newGeometry),P.geometry=d.newGeometry),w){if(P.properties=d.removeAllProperties?{}:Object.assign({},P.properties||{}),d.removeProperties)for(const I of d.removeProperties)delete P.properties[I];if(d.addOrUpdateProperties)for(const{key:I,value:C}of d.addOrUpdateProperties)P.properties[I]=C}}return h},S.a9=ou,S.aA=function(i,{uSize:e,uSizeT:r},{lowerSize:n,upperSize:a}){return i.kind==="source"?n/Xn:i.kind==="composite"?kr.number(n/Xn,a/Xn,r):e},S.aB=function(i,e){var r=e[0],n=e[1],a=e[2],h=e[3],d=e[4],m=e[5],y=e[6],w=e[7],P=e[8],I=e[9],C=e[10],D=e[11],F=e[12],L=e[13],B=e[14],U=e[15],ee=r*m-n*d,q=r*y-a*d,H=r*w-h*d,re=n*y-a*m,ae=n*w-h*m,be=a*w-h*y,Le=P*L-I*F,De=P*B-C*F,Ne=P*U-D*F,tt=I*B-C*L,qe=I*U-D*L,Re=C*U-D*B,Ae=ee*Re-q*qe+H*tt+re*Ne-ae*De+be*Le;return Ae?(i[0]=(m*Re-y*qe+w*tt)*(Ae=1/Ae),i[1]=(a*qe-n*Re-h*tt)*Ae,i[2]=(L*be-B*ae+U*re)*Ae,i[3]=(C*ae-I*be-D*re)*Ae,i[4]=(y*Ne-d*Re-w*De)*Ae,i[5]=(r*Re-a*Ne+h*De)*Ae,i[6]=(B*H-F*be-U*q)*Ae,i[7]=(P*be-C*H+D*q)*Ae,i[8]=(d*qe-m*Ne+w*Le)*Ae,i[9]=(n*Ne-r*qe-h*Le)*Ae,i[10]=(F*ae-L*H+U*ee)*Ae,i[11]=(I*H-P*ae-D*ee)*Ae,i[12]=(m*De-d*tt-y*Le)*Ae,i[13]=(r*tt-n*De+a*Le)*Ae,i[14]=(L*q-F*re-B*ee)*Ae,i[15]=(P*re-I*q+C*ee)*Ae,i):null},S.aC=Wt,S.aD=function(i){var e=i[0],r=i[1];return Math.sqrt(e*e+r*r)},S.aE=function(i){return i[0]=0,i[1]=0,i},S.aF=function(i,e,r){return i[0]=e[0]*r,i[1]=e[1]*r,i},S.aG=vp,S.aH=Ht,S.aI=function(i,e,r,n){const a=e.y-i.y,h=e.x-i.x,d=n.y-r.y,m=n.x-r.x,y=d*h-m*a;if(y===0)return null;const w=(m*(i.y-r.y)-d*(i.x-r.x))/y;return new $(i.x+w*h,i.y+w*a)},S.aJ=Ag,S.aK=vl,S.aL=function(i){let e=1/0,r=1/0,n=-1/0,a=-1/0;for(const h of i)e=Math.min(e,h.x),r=Math.min(r,h.y),n=Math.max(n,h.x),a=Math.max(a,h.y);return[e,r,n,a]},S.aM=_i,S.aN=Kt,S.aO=function(i,e,r,n,a=!1){if(!r[0]&&!r[1])return[0,0];const h=a?n==="map"?-i.bearingInRadians:0:n==="viewport"?i.bearingInRadians:0;if(h){const d=Math.sin(h),m=Math.cos(h);r=[r[0]*m-r[1]*d,r[0]*d+r[1]*m]}return[a?r[0]:Kt(e,r[0],i.zoom),a?r[1]:Kt(e,r[1],i.zoom)]},S.aQ=xp,S.aR=qp,S.aS=yp,S.aT=Gp,S.aU=Jr,S.aV=Oh,S.aW=W,S.aX=it,S.aY=Ie,S.aZ=Ai,S.a_=Gm,S.aa=Sa,S.ab=25,S.ac=Pp,S.ad=i=>{const e=window.document.createElement("video");return e.muted=!0,new Promise((r=>{e.onloadstart=()=>{r(e)};for(const n of i){const a=window.document.createElement("source");Oe(n)||(e.crossOrigin="Anonymous"),a.src=n,e.appendChild(a)}}))},S.ae=Ze,S.af=function(){return Vt++},S.ag=u,S.ah=Il,S.ai=cu,S.aj=ea,S.ak=Sn,S.al=Ym,S.am=function(i){const e={};if(i.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((r,n,a,h)=>{const d=a||h;return e[n]=!d||d.toLowerCase(),""})),e["max-age"]){const r=parseInt(e["max-age"],10);isNaN(r)?delete e["max-age"]:e["max-age"]=r}return e},S.an=Bi,S.ao=85.051129,S.ap=Ti,S.aq=function(i){return Math.pow(2,i)},S.ar=Fe,S.as=Um,S.at=function(i){return Math.log(i)/Math.LN2},S.au=function(i){var e=i[0],r=i[1];return e*e+r*r},S.av=function(i){if(!i.length)return new Set;const e=Math.max(...i.map((y=>y.canonical.z)));let r=1/0,n=-1/0,a=1/0,h=-1/0;const d=[];for(const y of i){const{x:w,y:P,z:I}=y.canonical,C=Math.pow(2,e-I),D=w*C,F=P*C;d.push({id:y,x:D,y:F}),D<r&&(r=D),D>n&&(n=D),F<a&&(a=F),F>h&&(h=F)}const m=new Set;for(const y of d)y.x!==r&&y.x!==n&&y.y!==a&&y.y!==h||m.add(y.id);return m},S.aw=function(i,e){const r=Math.abs(2*i.wrap)-+(i.wrap<0),n=Math.abs(2*e.wrap)-+(e.wrap<0);return i.overscaledZ-e.overscaledZ||n-r||e.canonical.y-i.canonical.y||e.canonical.x-i.canonical.x},S.ax=class{constructor(i,e){this.max=i,this.onRemove=e,this.reset()}reset(){for(const i in this.data)for(const e of this.data[i])e.timeout&&clearTimeout(e.timeout),this.onRemove(e.value);return this.data={},this.order=[],this}add(i,e,r){const n=i.wrapped().key;this.data[n]===void 0&&(this.data[n]=[]);const a={value:e,timeout:void 0};if(r!==void 0&&(a.timeout=setTimeout((()=>{this.remove(i,a)}),r)),this.data[n].push(a),this.order.push(n),this.order.length>this.max){const h=this._getAndRemoveByKey(this.order[0]);h&&this.onRemove(h)}return this}has(i){return i.wrapped().key in this.data}getAndRemove(i){return this.has(i)?this._getAndRemoveByKey(i.wrapped().key):null}_getAndRemoveByKey(i){const e=this.data[i].shift();return e.timeout&&clearTimeout(e.timeout),this.data[i].length===0&&delete this.data[i],this.order.splice(this.order.indexOf(i),1),e.value}getByKey(i){const e=this.data[i];return e?e[0].value:null}get(i){return this.has(i)?this.data[i.wrapped().key][0].value:null}remove(i,e){if(!this.has(i))return this;const r=i.wrapped().key,n=e===void 0?0:this.data[r].indexOf(e),a=this.data[r][n];return this.data[r].splice(n,1),a.timeout&&clearTimeout(a.timeout),this.data[r].length===0&&delete this.data[r],this.onRemove(a.value),this.order.splice(this.order.indexOf(r),1),this}setMaxSize(i){for(this.max=i;this.order.length>this.max;){const e=this._getAndRemoveByKey(this.order[0]);e&&this.onRemove(e)}return this}filter(i){const e=[];for(const r in this.data)for(const n of this.data[r])i(n.value)||e.push(n);for(const r of e)this.remove(r.value.tileID,r)}},S.ay=function(i,e){let r=0,n=0;if(i.kind==="constant")n=i.layoutSize;else if(i.kind!=="source"){const{interpolationType:a,minZoom:h,maxZoom:d}=i,m=a?Bi(Ui.interpolationFactor(a,e,h,d),0,1):0;i.kind==="camera"?n=kr.number(i.minSize,i.maxSize,m):r=m}return{uSizeT:r,uSize:n}},S.b=js,S.b$=Hn,S.b0=Ge,S.b1=function(i){var e=new At(3);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e},S.b2=function(i,e,r){return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],i},S.b3=function(i,e){var r=e[0],n=e[1],a=e[2],h=r*r+n*n+a*a;return h>0&&(h=1/Math.sqrt(h)),i[0]=e[0]*h,i[1]=e[1]*h,i[2]=e[2]*h,i},S.b4=vt,S.b5=function(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]},S.b6=function(i,e,r){return i[0]=e[0]*r[0],i[1]=e[1]*r[1],i[2]=e[2]*r[2],i[3]=e[3]*r[3],i},S.b7=Ye,S.b8=function(i,e,r){const n=e[0]*r[0]+e[1]*r[1]+e[2]*r[2];return n===0?null:(-(i[0]*r[0]+i[1]*r[1]+i[2]*r[2])-r[3])/n},S.b9=Zt,S.bA=function(i,e,r,n){return i[0]=e[0]+r[0]*n,i[1]=e[1]+r[1]*n,i[2]=e[2]+r[2]*n,i},S.bB=Jt,S.bC=function(i,e,r){var n=r[0],a=r[1],h=r[2],d=r[3],m=e[0],y=e[1],w=e[2],P=a*w-h*y,I=h*m-n*w,C=n*y-a*m;return i[0]=m+d*(P+=P)+a*(C+=C)-h*(I+=I),i[1]=y+d*I+h*P-n*C,i[2]=w+d*C+n*I-a*P,i},S.bD=function(i,e,r){const n=(function(y){var w=y[3],P=y[4],I=y[5],C=y[6],D=y[7],F=y[8];return y[0]*(F*P-I*D)+y[1]*(-F*w+I*C)+y[2]*(D*w-P*C)})([i[0],i[1],i[2],e[0],e[1],e[2],r[0],r[1],r[2]]);if(n===0)return null;const a=vt([],[e[0],e[1],e[2]],[r[0],r[1],r[2]]),h=vt([],[r[0],r[1],r[2]],[i[0],i[1],i[2]]),d=vt([],[i[0],i[1],i[2]],[e[0],e[1],e[2]]),m=pt([],a,-i[3]);return Ge(m,m,pt([],h,-e[3])),Ge(m,m,pt([],d,-r[3])),pt(m,m,1/n),m},S.bE=Sp,S.bF=function(){return new Float64Array(4)},S.bG=function(i,e,r,n){var a=[],h=[];return a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],h[0]=a[0]*Math.cos(n)-a[1]*Math.sin(n),h[1]=a[0]*Math.sin(n)+a[1]*Math.cos(n),h[2]=a[2],i[0]=h[0]+r[0],i[1]=h[1]+r[1],i[2]=h[2]+r[2],i},S.bH=function(i,e,r,n){var a=[],h=[];return a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],h[0]=a[0],h[1]=a[1]*Math.cos(n)-a[2]*Math.sin(n),h[2]=a[1]*Math.sin(n)+a[2]*Math.cos(n),i[0]=h[0]+r[0],i[1]=h[1]+r[1],i[2]=h[2]+r[2],i},S.bI=function(i,e,r,n){var a=[],h=[];return a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],h[0]=a[2]*Math.sin(n)+a[0]*Math.cos(n),h[1]=a[1],h[2]=a[2]*Math.cos(n)-a[0]*Math.sin(n),i[0]=h[0]+r[0],i[1]=h[1]+r[1],i[2]=h[2]+r[2],i},S.bJ=function(i,e,r){var n=Math.sin(r),a=Math.cos(r),h=e[0],d=e[1],m=e[2],y=e[3],w=e[8],P=e[9],I=e[10],C=e[11];return e!==i&&(i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=h*a-w*n,i[1]=d*a-P*n,i[2]=m*a-I*n,i[3]=y*a-C*n,i[8]=h*n+w*a,i[9]=d*n+P*a,i[10]=m*n+I*a,i[11]=y*n+C*a,i},S.bK=function(i,e){const r=Nt(i,360),n=Nt(e,360),a=n-r,h=n>r?a-360:a+360;return Math.abs(a)<Math.abs(h)?a:h},S.bL=function(i){return i[0]=0,i[1]=0,i[2]=0,i},S.bM=function(i,e,r,n){const a=Math.sqrt(i*i+e*e),h=Math.sqrt(r*r+n*n);i/=a,e/=a,r/=h,n/=h;const d=Math.acos(i*r+e*n);return-e*r+i*n>0?d:-d},S.bN=function(i,e){const r=Nt(i,2*Math.PI),n=Nt(e,2*Math.PI);return Math.min(Math.abs(r-n),Math.abs(r-n+2*Math.PI),Math.abs(r-n-2*Math.PI))},S.bO=function(){const i={},e=Se.$version;for(const r in Se.$root){const n=Se.$root[r];if(n.required){let a=null;a=r==="version"?e:n.type==="array"?[]:{},a!=null&&(i[r]=a)}}return i},S.bP=Ee,S.bQ=zc,S.bR=function i(e,r){if(Array.isArray(e)){if(!Array.isArray(r)||e.length!==r.length)return!1;for(let n=0;n<e.length;n++)if(!i(e[n],r[n]))return!1;return!0}if(typeof e=="object"&&e!==null&&r!==null){if(typeof r!="object"||Object.keys(e).length!==Object.keys(r).length)return!1;for(const n in e)if(!i(e[n],r[n]))return!1;return!0}return e===r},S.bS=function(i){i=i.slice();const e=Object.create(null);for(let r=0;r<i.length;r++)e[i[r].id]=i[r];for(let r=0;r<i.length;r++)"ref"in i[r]&&(i[r]=ui(i[r],e[i[r].ref]));return i},S.bT=function(i,e){if(i.type==="custom")return new Y0(i,e);switch(i.type){case"background":return new X0(i,e);case"circle":return new zy(i,e);case"color-relief":return new jy(i,e);case"fill":return new e0(i,e);case"fill-extrusion":return new d0(i,e);case"heatmap":return new Fy(i,e);case"hillshade":return new Oy(i,e);case"line":return new x0(i,e);case"raster":return new Qd(i,e);case"symbol":return new $h(i,e)}},S.bU=i=>i.type==="raster",S.bV=Zi,S.bW=function(i,e){if(!i)return[{command:"setStyle",args:[e]}];let r=[];try{if(!Dt(i.version,e.version))return[{command:"setStyle",args:[e]}];Dt(i.center,e.center)||r.push({command:"setCenter",args:[e.center]}),Dt(i.state,e.state)||r.push({command:"setGlobalState",args:[e.state]}),Dt(i.centerAltitude,e.centerAltitude)||r.push({command:"setCenterAltitude",args:[e.centerAltitude]}),Dt(i.zoom,e.zoom)||r.push({command:"setZoom",args:[e.zoom]}),Dt(i.bearing,e.bearing)||r.push({command:"setBearing",args:[e.bearing]}),Dt(i.pitch,e.pitch)||r.push({command:"setPitch",args:[e.pitch]}),Dt(i.roll,e.roll)||r.push({command:"setRoll",args:[e.roll]}),Dt(i.sprite,e.sprite)||r.push({command:"setSprite",args:[e.sprite]}),Dt(i.glyphs,e.glyphs)||r.push({command:"setGlyphs",args:[e.glyphs]}),Dt(i.transition,e.transition)||r.push({command:"setTransition",args:[e.transition]}),Dt(i.light,e.light)||r.push({command:"setLight",args:[e.light]}),Dt(i.terrain,e.terrain)||r.push({command:"setTerrain",args:[e.terrain]}),Dt(i.sky,e.sky)||r.push({command:"setSky",args:[e.sky]}),Dt(i.projection,e.projection)||r.push({command:"setProjection",args:[e.projection]});const n={},a=[];(function(d,m,y,w){let P;for(P in m=m||{},d=d||{})Object.prototype.hasOwnProperty.call(d,P)&&(Object.prototype.hasOwnProperty.call(m,P)||cr(P,y,w));for(P in m)Object.prototype.hasOwnProperty.call(m,P)&&(Object.prototype.hasOwnProperty.call(d,P)?Dt(d[P],m[P])||(d[P].type==="geojson"&&m[P].type==="geojson"&&ar(d,m,P)?or(y,{command:"setGeoJSONSourceData",args:[P,m[P].data]}):mr(P,m,y,w)):Hr(P,m,y))})(i.sources,e.sources,a,n);const h=[];i.layers&&i.layers.forEach((d=>{"source"in d&&n[d.source]?r.push({command:"removeLayer",args:[d.id]}):h.push(d)})),r=r.concat(a),(function(d,m,y){m=m||[];const w=(d=d||[]).map(ys),P=m.map(ys),I=d.reduce(xs,{}),C=m.reduce(xs,{}),D=w.slice(),F=Object.create(null);let L,B,U,ee,q;for(let H=0,re=0;H<w.length;H++)L=w[H],Object.prototype.hasOwnProperty.call(C,L)?re++:(or(y,{command:"removeLayer",args:[L]}),D.splice(D.indexOf(L,re),1));for(let H=0,re=0;H<P.length;H++)L=P[P.length-1-H],D[D.length-1-H]!==L&&(Object.prototype.hasOwnProperty.call(I,L)?(or(y,{command:"removeLayer",args:[L]}),D.splice(D.lastIndexOf(L,D.length-re),1)):re++,ee=D[D.length-H],or(y,{command:"addLayer",args:[C[L],ee]}),D.splice(D.length-H,0,L),F[L]=!0);for(let H=0;H<P.length;H++)if(L=P[H],B=I[L],U=C[L],!F[L]&&!Dt(B,U))if(Dt(B.source,U.source)&&Dt(B["source-layer"],U["source-layer"])&&Dt(B.type,U.type)){for(q in Cr(B.layout,U.layout,y,L,null,"setLayoutProperty"),Cr(B.paint,U.paint,y,L,null,"setPaintProperty"),Dt(B.filter,U.filter)||or(y,{command:"setFilter",args:[L,U.filter]}),Dt(B.minzoom,U.minzoom)&&Dt(B.maxzoom,U.maxzoom)||or(y,{command:"setLayerZoomRange",args:[L,U.minzoom,U.maxzoom]}),B)Object.prototype.hasOwnProperty.call(B,q)&&q!=="layout"&&q!=="paint"&&q!=="filter"&&q!=="metadata"&&q!=="minzoom"&&q!=="maxzoom"&&(q.indexOf("paint.")===0?Cr(B[q],U[q],y,L,q.slice(6),"setPaintProperty"):Dt(B[q],U[q])||or(y,{command:"setLayerProperty",args:[L,q,U[q]]}));for(q in U)Object.prototype.hasOwnProperty.call(U,q)&&!Object.prototype.hasOwnProperty.call(B,q)&&q!=="layout"&&q!=="paint"&&q!=="filter"&&q!=="metadata"&&q!=="minzoom"&&q!=="maxzoom"&&(q.indexOf("paint.")===0?Cr(B[q],U[q],y,L,q.slice(6),"setPaintProperty"):Dt(B[q],U[q])||or(y,{command:"setLayerProperty",args:[L,q,U[q]]}))}else or(y,{command:"removeLayer",args:[L]}),ee=D[D.lastIndexOf(L)+1],or(y,{command:"addLayer",args:[U,ee]})})(h,e.layers,r)}catch(n){console.warn("Unable to compute style diff:",n),r=[{command:"setStyle",args:[e]}]}return r},S.bX=function(i){const e=[],r=i.id;return r===void 0&&e.push({message:`layers.${r}: missing required property "id"`}),i.render===void 0&&e.push({message:`layers.${r}: missing required method "render"`}),i.renderingMode&&i.renderingMode!=="2d"&&i.renderingMode!=="3d"&&e.push({message:`layers.${r}: property "renderingMode" must be either "2d" or "3d"`}),e},S.bY=Lr,S.bZ=cn,S.b_=class extends Qi{constructor(i,e){super(i,e),this.current=0}set(i){this.current!==i&&(this.current=i,this.gl.uniform1i(this.location,i))}},S.ba=function(i,e,r){return i[0]=e[0]*r,i[1]=e[1]*r,i[2]=e[2]*r,i[3]=e[3]*r,i},S.bb=function(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]},S.bc=Hm,S.bd=Al,S.be=function(i,e,r,n,a){var h=1/Math.tan(e/2);if(i[0]=h/r,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=h,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,a!=null&&a!==1/0){var d=1/(n-a);i[10]=(a+n)*d,i[14]=2*a*n*d}else i[10]=-1,i[14]=-2*n;return i},S.bf=function(i){var e=new At(16);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],e},S.bg=function(i,e,r){var n=Math.sin(r),a=Math.cos(r),h=e[0],d=e[1],m=e[2],y=e[3],w=e[4],P=e[5],I=e[6],C=e[7];return e!==i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=h*a+w*n,i[1]=d*a+P*n,i[2]=m*a+I*n,i[3]=y*a+C*n,i[4]=w*a-h*n,i[5]=P*a-d*n,i[6]=I*a-m*n,i[7]=C*a-y*n,i},S.bh=function(i,e,r){var n=Math.sin(r),a=Math.cos(r),h=e[4],d=e[5],m=e[6],y=e[7],w=e[8],P=e[9],I=e[10],C=e[11];return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[4]=h*a+w*n,i[5]=d*a+P*n,i[6]=m*a+I*n,i[7]=y*a+C*n,i[8]=w*a-h*n,i[9]=P*a-d*n,i[10]=I*a-m*n,i[11]=C*a-y*n,i},S.bi=function(){const i=new Float32Array(16);return Fe(i),i},S.bj=function(){const i=new Float64Array(16);return Fe(i),i},S.bk=function(){return new Float64Array(16)},S.bl=function(i,e,r){const n=new Float64Array(4);return Jt(n,i,e-90,r),n},S.bm=function(i,e,r,n){var a,h,d,m,y,w=e[0],P=e[1],I=e[2],C=e[3],D=r[0],F=r[1],L=r[2],B=r[3];return(h=w*D+P*F+I*L+C*B)<0&&(h=-h,D=-D,F=-F,L=-L,B=-B),1-h>xt?(a=Math.acos(h),d=Math.sin(a),m=Math.sin((1-n)*a)/d,y=Math.sin(n*a)/d):(m=1-n,y=n),i[0]=m*w+y*D,i[1]=m*P+y*F,i[2]=m*I+y*L,i[3]=m*C+y*B,i},S.bn=function(i){const e=new Float64Array(9);(function(h,d){var m=d[0],y=d[1],w=d[2],P=d[3],I=m+m,C=y+y,D=w+w,F=m*I,L=y*I,B=y*C,U=w*I,ee=w*C,q=w*D,H=P*I,re=P*C,ae=P*D;h[0]=1-B-q,h[3]=L-ae,h[6]=U+re,h[1]=L+ae,h[4]=1-F-q,h[7]=ee-H,h[2]=U-re,h[5]=ee+H,h[8]=1-F-B})(e,i);const r=Ai(-Math.asin(Bi(e[2],-1,1)));let n,a;return Math.hypot(e[5],e[8])<.001?(n=0,a=-Ai(Math.atan2(e[3],e[4]))):(n=Ai(e[5]===0&&e[8]===0?0:Math.atan2(e[5],e[8])),a=Ai(e[1]===0&&e[0]===0?0:Math.atan2(e[1],e[0]))),{roll:n,pitch:r+90,bearing:a}},S.bo=function(i,e){return i.roll==e.roll&&i.pitch==e.pitch&&i.bearing==e.bearing},S.bp=Ut,S.bq=Zn,S.br=Pl,S.bs=eu,S.bt=Sl,S.bu=hr,S.bv=us,S.bw=$i,S.bx=function(i,e,r,n,a){return hr(n,a,Bi((i-e)/(r-e),0,1))},S.by=Nt,S.bz=function(){return new Float64Array(3)},S.c=he,S.c$=function(i,e,r,n,a){return l(this,void 0,void 0,(function*(){if(Pt())try{return yield un(i,e,r,n,a)}catch{}return(function(h,d,m,y,w){const P=h.width,I=h.height;Hi&&Wi||(Hi=new OffscreenCanvas(P,I),Wi=Hi.getContext("2d",{willReadFrequently:!0})),Hi.width=P,Hi.height=I,Wi.drawImage(h,0,0,P,I);const C=Wi.getImageData(d,m,y,w);return Wi.clearRect(0,0,P,I),C.data})(i,e,r,n,a)}))},S.c0=class extends Qi{constructor(i,e){super(i,e),this.current=ms}set(i){if(i[12]!==this.current[12]||i[0]!==this.current[0])return this.current=i,void this.gl.uniformMatrix4fv(this.location,!1,i);for(let e=1;e<16;e++)if(i[e]!==this.current[e]){this.current=i,this.gl.uniformMatrix4fv(this.location,!1,i);break}}},S.c1=ba,S.c2=class extends Qi{constructor(i,e){super(i,e),this.current=[0,0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]&&i[2]===this.current[2]||(this.current=i,this.gl.uniform3f(this.location,i[0],i[1],i[2]))}},S.c3=class extends Qi{constructor(i,e){super(i,e),this.current=[0,0]}set(i){i[0]===this.current[0]&&i[1]===this.current[1]||(this.current=i,this.gl.uniform2f(this.location,i[0],i[1]))}},S.c4=Qt,S.c5=function(i,e){var r=Math.sin(e),n=Math.cos(e);return i[0]=n,i[1]=r,i[2]=0,i[3]=-r,i[4]=n,i[5]=0,i[6]=0,i[7]=0,i[8]=1,i},S.c6=function(i,e,r){var n=e[0],a=e[1],h=e[2];return i[0]=n*r[0]+a*r[3]+h*r[6],i[1]=n*r[1]+a*r[4]+h*r[7],i[2]=n*r[2]+a*r[5]+h*r[8],i},S.c7=function(i,e,r,n,a,h,d){var m=1/(e-r),y=1/(n-a),w=1/(h-d);return i[0]=-2*m,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*y,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*w,i[11]=0,i[12]=(e+r)*m,i[13]=(a+n)*y,i[14]=(d+h)*w,i[15]=1,i},S.c8=class extends Qi{constructor(i,e){super(i,e),this.current=new Array}set(i){if(i!=this.current){this.current=i;const e=new Float32Array(4*i.length);for(let r=0;r<i.length;r++)e[4*r]=i[r].r,e[4*r+1]=i[r].g,e[4*r+2]=i[r].b,e[4*r+3]=i[r].a;this.gl.uniform4fv(this.location,e)}}},S.c9=class extends Qi{constructor(i,e){super(i,e),this.current=new Array}set(i){if(i!=this.current){this.current=i;const e=new Float32Array(i);this.gl.uniform1fv(this.location,e)}}},S.cA=function(i,e){return ve[e]&&"touches"in i},S.cB=function(i){return ve[i]||N[i]},S.cC=function(i,e,r){var n=e[0],a=e[1];return i[0]=r[0]*n+r[4]*a+r[12],i[1]=r[1]*n+r[5]*a+r[13],i},S.cD=function(i,e){const{x:r,y:n}=ou.fromLngLat(e);return!(i<0||i>25||n<0||n>=1||r<0||r>=1)},S.cE=function(i,e){return i[0]=e[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=e[2],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},S.cF=class extends pl{},S.cG=Lx,S.cI=de,S.cJ=function(i,e){he.REGISTERED_PROTOCOLS[i]=e},S.cK=function(i){delete he.REGISTERED_PROTOCOLS[i]},S.cL=function(i,e){const r={};for(let a=0;a<i.length;a++){const h=e&&e[i[a].id]||lh(i[a]);e&&(e[i[a].id]=h);let d=r[h];d||(d=r[h]=[]),d.push(i[a])}const n=[];for(const a in r)n.push(r[a]);return n},S.cM=ht,S.cN=Xm,S.cO=Mg,S.cP=Cm,S.cQ=function(i){i.bucket.createArrays(),i.bucket.tilePixelRatio=Ct/(512*i.bucket.overscaling),i.bucket.compareText={},i.bucket.iconsNeedLinear=!1;const e=i.bucket.layers[0],r=e.layout,n=e._unevaluatedLayout._values,a={layoutIconSize:n["icon-size"].possiblyEvaluate(new gr(i.bucket.zoom+1),i.canonical),layoutTextSize:n["text-size"].possiblyEvaluate(new gr(i.bucket.zoom+1),i.canonical),textMaxSize:n["text-size"].possiblyEvaluate(new gr(18))};if(i.bucket.textSizeData.kind==="composite"){const{minZoom:w,maxZoom:P}=i.bucket.textSizeData;a.compositeTextSizes=[n["text-size"].possiblyEvaluate(new gr(w),i.canonical),n["text-size"].possiblyEvaluate(new gr(P),i.canonical)]}if(i.bucket.iconSizeData.kind==="composite"){const{minZoom:w,maxZoom:P}=i.bucket.iconSizeData;a.compositeIconSizes=[n["icon-size"].possiblyEvaluate(new gr(w),i.canonical),n["icon-size"].possiblyEvaluate(new gr(P),i.canonical)]}const h=r.get("text-line-height")*_i,d=r.get("text-rotation-alignment")!=="viewport"&&r.get("symbol-placement")!=="point",m=r.get("text-keep-upright"),y=r.get("text-size");for(const w of i.bucket.features){const P=r.get("text-font").evaluate(w,{},i.canonical).join(","),I=y.evaluate(w,{},i.canonical),C=a.layoutTextSize.evaluate(w,{},i.canonical),D=a.layoutIconSize.evaluate(w,{},i.canonical),F={horizontal:{},vertical:void 0},L=w.text;let B,U=[0,0];if(L){const H=L.toString(),re=r.get("text-letter-spacing").evaluate(w,{},i.canonical)*_i,ae=Jd(H)?re:0,be=r.get("text-anchor").evaluate(w,{},i.canonical),Le=Ng(e,w,i.canonical);if(!Le){const qe=r.get("text-radial-offset").evaluate(w,{},i.canonical);U=qe?jg(be,[qe*_i,Up]):r.get("text-offset").evaluate(w,{},i.canonical).map((Re=>Re*_i))}let De=d?"center":r.get("text-justify").evaluate(w,{},i.canonical);const Ne=r.get("symbol-placement")==="point"?r.get("text-max-width").evaluate(w,{},i.canonical)*_i:1/0,tt=()=>{i.bucket.allowVerticalPlacement&&Eo(H)&&(F.vertical=Nh(L,i.glyphMap,i.glyphPositions,i.imagePositions,P,Ne,h,be,"left",ae,U,S.az.vertical,!0,C,I))};if(!d&&Le){const qe=new Set;if(De==="auto")for(let Ae=0;Ae<Le.values.length;Ae+=2)qe.add(qp(Le.values[Ae]));else qe.add(De);let Re=!1;for(const Ae of qe)if(!F.horizontal[Ae])if(Re)F.horizontal[Ae]=F.horizontal[0];else{const ut=Nh(L,i.glyphMap,i.glyphPositions,i.imagePositions,P,Ne,h,"center",Ae,ae,U,S.az.horizontal,!1,C,I);ut&&(F.horizontal[Ae]=ut,Re=ut.positionedLines.length===1)}tt()}else{De==="auto"&&(De=qp(be));const qe=Nh(L,i.glyphMap,i.glyphPositions,i.imagePositions,P,Ne,h,be,De,ae,U,S.az.horizontal,!1,C,I);qe&&(F.horizontal[De]=qe),tt(),Eo(H)&&d&&m&&(F.vertical=Nh(L,i.glyphMap,i.glyphPositions,i.imagePositions,P,Ne,h,be,De,ae,U,S.az.vertical,!1,C,I))}}let ee=!1;if(w.icon&&w.icon.name){const H=i.imageMap[w.icon.name];H&&(B=G0(i.imagePositions[w.icon.name],r.get("icon-offset").evaluate(w,{},i.canonical),r.get("icon-anchor").evaluate(w,{},i.canonical)),ee=!!H.sdf,i.bucket.sdfIcons===void 0?i.bucket.sdfIcons=ee:i.bucket.sdfIcons!==ee&&Vr("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(H.pixelRatio!==i.bucket.pixelRatio||r.get("icon-rotate").constantOr(1)!==0)&&(i.bucket.iconsNeedLinear=!0))}const q=$g(F.horizontal)||F.vertical;i.bucket.iconsInText=!!q&&q.iconsInText,(q||B)&&Rx(i.bucket,w,F,B,i.imageMap,a,C,D,U,ee,i.canonical,i.subdivisionGranularity)}i.showCollisionBoxes&&i.bucket.generateCollisionDebugBuffers()},S.cR=dp,S.cS=fp,S.cT=mp,S.cU=function(i){const e=new jh;return(function(r,n){for(const a in r.layers)n.writeMessage(3,vx,r.layers[a])})(i,e),e.finish()},S.cV=function(i,e,r,n,a,h){let d=Cg(i,e,r,a,0);return d=Cg(d,e,n,h,1),d},S.cW=class{constructor(i){this.maxEntries=i,this.map=new Map}get(i){const e=this.map.get(i);return e!==void 0&&(this.map.delete(i),this.map.set(i,e)),e}set(i,e){if(this.map.has(i))this.map.delete(i);else if(this.map.size>=this.maxEntries){const r=this.map.keys().next().value;this.map.delete(r)}this.map.set(i,e)}clear(){this.map.clear()}},S.cX=dm,S.cY=jh,S.cZ=Pg,S.c_=class{constructor(i){this._marks={start:[i.url,"start"].join("#"),end:[i.url,"end"].join("#"),measure:i.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let i=performance.getEntriesByName(this._marks.measure);return i.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),i=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),i}},S.ca=class extends qn{},S.cb=T0,S.cc=class extends va{},S.cd=ap,S.ce=function(i){return i<=1?1:Math.pow(2,Math.ceil(Math.log(i)/Math.LN2))},S.cf=Jf,S.cg=function(i,e,r){var n=e[0],a=e[1],h=e[2],d=r[3]*n+r[7]*a+r[11]*h+r[15];return i[0]=(r[0]*n+r[4]*a+r[8]*h+r[12])/(d=d||1),i[1]=(r[1]*n+r[5]*a+r[9]*h+r[13])/d,i[2]=(r[2]*n+r[6]*a+r[10]*h+r[14])/d,i},S.ch=class extends Nc{},S.ci=class extends t{},S.cj=function(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]&&i[3]===e[3]&&i[4]===e[4]&&i[5]===e[5]&&i[6]===e[6]&&i[7]===e[7]&&i[8]===e[8]&&i[9]===e[9]&&i[10]===e[10]&&i[11]===e[11]&&i[12]===e[12]&&i[13]===e[13]&&i[14]===e[14]&&i[15]===e[15]},S.ck=function(i,e){var r=i[0],n=i[1],a=i[2],h=i[3],d=i[4],m=i[5],y=i[6],w=i[7],P=i[8],I=i[9],C=i[10],D=i[11],F=i[12],L=i[13],B=i[14],U=i[15],ee=e[0],q=e[1],H=e[2],re=e[3],ae=e[4],be=e[5],Le=e[6],De=e[7],Ne=e[8],tt=e[9],qe=e[10],Re=e[11],Ae=e[12],ut=e[13],lt=e[14],dt=e[15];return Math.abs(r-ee)<=xt*Math.max(1,Math.abs(r),Math.abs(ee))&&Math.abs(n-q)<=xt*Math.max(1,Math.abs(n),Math.abs(q))&&Math.abs(a-H)<=xt*Math.max(1,Math.abs(a),Math.abs(H))&&Math.abs(h-re)<=xt*Math.max(1,Math.abs(h),Math.abs(re))&&Math.abs(d-ae)<=xt*Math.max(1,Math.abs(d),Math.abs(ae))&&Math.abs(m-be)<=xt*Math.max(1,Math.abs(m),Math.abs(be))&&Math.abs(y-Le)<=xt*Math.max(1,Math.abs(y),Math.abs(Le))&&Math.abs(w-De)<=xt*Math.max(1,Math.abs(w),Math.abs(De))&&Math.abs(P-Ne)<=xt*Math.max(1,Math.abs(P),Math.abs(Ne))&&Math.abs(I-tt)<=xt*Math.max(1,Math.abs(I),Math.abs(tt))&&Math.abs(C-qe)<=xt*Math.max(1,Math.abs(C),Math.abs(qe))&&Math.abs(D-Re)<=xt*Math.max(1,Math.abs(D),Math.abs(Re))&&Math.abs(F-Ae)<=xt*Math.max(1,Math.abs(F),Math.abs(Ae))&&Math.abs(L-ut)<=xt*Math.max(1,Math.abs(L),Math.abs(ut))&&Math.abs(B-lt)<=xt*Math.max(1,Math.abs(B),Math.abs(lt))&&Math.abs(U-dt)<=xt*Math.max(1,Math.abs(U),Math.abs(dt))},S.cl=function(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i},S.cm=i=>i.type==="symbol",S.cn=i=>i.type==="circle",S.co=i=>i.type==="heatmap",S.cp=i=>i.type==="line",S.cq=i=>i.type==="fill",S.cr=i=>i.type==="fill-extrusion",S.cs=i=>i.type==="hillshade",S.ct=i=>i.type==="color-relief",S.cu=i=>i.type==="background",S.cv=i=>i.type==="custom",S.cw=Os,S.cx=function(i,e,r){const n=Xt(e.x-r.x,e.y-r.y),a=Xt(i.x-r.x,i.y-r.y),h=Math.atan2(n[0]*a[1]-n[1]*a[0],(function(d,m){return d[0]*m[0]+d[1]*m[1]})(n,a));return Ai(h)},S.cy=ci,S.cz=function(i,e){return N[e]&&(i instanceof MouseEvent||i instanceof WheelEvent)},S.d=Oe,S.d0=em,S.d1=oe,S.d2=class{constructor(i,e){this.layers={[cu]:this},this.name=cu,this.version=e?e.version:1,this.extent=e?e.extent:4096,this.length=i.length,this.features=i}feature(i){return new xx(this.features[i],this.extent)}},S.d3=Qo,S.d4=vn,S.e=Sr,S.f=i=>l(void 0,void 0,void 0,(function*(){if(i.byteLength===0)return createImageBitmap(new ImageData(1,1));const e=new Blob([new Uint8Array(i)],{type:"image/png"});try{return createImageBitmap(e)}catch(r){throw new Error(`Could not load image because of ${r.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}})),S.g=Te,S.h=i=>new Promise(((e,r)=>{const n=new Image;n.onload=()=>{e(n),URL.revokeObjectURL(n.src),n.onload=null,window.requestAnimationFrame((()=>{n.src=Ws}))},n.onerror=()=>r(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const a=new Blob([new Uint8Array(i)],{type:"image/png"});n.src=i.byteLength?URL.createObjectURL(a):Ws})),S.i=Ni,S.j=(i,e)=>Ue(Sr(i,{type:"json"}),e),S.k=nr,S.l=kt,S.m=Ue,S.n=(i,e)=>Ue(Sr(i,{type:"arrayBuffer"}),e),S.o=function(i){return new jh(i).readFields(O0,[])},S.p=Am,S.q=function(i){return/[\u02EA\u02EB\u1100-\u11FF\u2E80-\u2FDF\u3000-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFE10-\uFE1F\uFE30-\uFE4F\uFF00-\uFFEF]|\uD81B[\uDFE0-\uDFFF]|[\uD81C-\uD822\uD840-\uD868\uD86A-\uD86D\uD86F-\uD872\uD874-\uD879\uD880-\uD883\uD885-\uD88C][\uDC00-\uDFFF]|\uD823[\uDC00-\uDCD5\uDCFF-\uDD1E\uDD80-\uDDF2]|\uD82B[\uDFF0-\uDFFF]|\uD82C[\uDC00-\uDEFB]|\uD83C[\uDE00-\uDEFF]|\uD869[\uDC00-\uDEDF\uDF00-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEAD\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0\uDFF0-\uDFFF]|\uD87B[\uDC00-\uDE5D]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A\uDF50-\uDFFF]|\uD88D[\uDC00-\uDC79]/gim.test(String.fromCodePoint(i))},S.r=Xc,S.s=_s,S.t=qi,S.u=Se,S.v=aa,S.w=Vr,S.x=Bc,S.y=la,S.z=da})),E("worker",["./shared"],(function(S){class l{constructor(N,j){this.keyCache={},N&&this.replace(N,j)}replace(N,j){this._layerConfigs={},this._layers={},this.update(N,[],j)}update(N,j,Z){for(const he of N){this._layerConfigs[he.id]=he;const Te=this._layers[he.id]=S.bT(he,Z);Te._featureFilter=S.aj(Te.filter,Z),this.keyCache[he.id]&&delete this.keyCache[he.id]}for(const he of j)delete this.keyCache[he],delete this._layerConfigs[he],delete this._layers[he];this.familiesBySource={};const ce=S.cL(Object.values(this._layerConfigs),this.keyCache);for(const he of ce){const Te=he.map((at=>this._layers[at.id])),_e=Te[0];if(_e.isHidden())continue;const de=_e.source||"";let Ee=this.familiesBySource[de];Ee||(Ee=this.familiesBySource[de]={});const Ue=_e.sourceLayer||S.ai;let Oe=Ee[Ue];Oe||(Oe=Ee[Ue]=[]),Oe.push(Te)}}}class ${constructor(N){const j={},Z=[];for(const _e in N){const de=N[_e],Ee=j[_e]={};for(const Ue in de){const Oe=de[+Ue];if(!Oe||Oe.bitmap.width===0||Oe.bitmap.height===0)continue;const at={x:0,y:0,w:Oe.bitmap.width+2,h:Oe.bitmap.height+2};Z.push(at),Ee[Ue]={rect:at,metrics:Oe.metrics}}}const{w:ce,h:he}=S.p(Z),Te=new S.r({width:ce||1,height:he||1});for(const _e in N){const de=N[_e];for(const Ee in de){const Ue=de[+Ee];if(!Ue||Ue.bitmap.width===0||Ue.bitmap.height===0)continue;const Oe=j[_e][Ee].rect;S.r.copy(Ue.bitmap,Te,{x:0,y:0},{x:Oe.x+1,y:Oe.y+1},Ue.bitmap)}}this.image=Te,this.positions=j}}S.cM("GlyphAtlas",$);class oe{constructor(N){this.tileID=new S.a2(N.tileID.overscaledZ,N.tileID.wrap,N.tileID.canonical.z,N.tileID.canonical.x,N.tileID.canonical.y),this.uid=N.uid,this.zoom=N.zoom,this.pixelRatio=N.pixelRatio,this.tileSize=N.tileSize,this.source=N.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=N.showCollisionBoxes,this.collectResourceTiming=!!N.collectResourceTiming,this.returnDependencies=!!N.returnDependencies,this.promoteId=N.promoteId,this.inFlightDependencies=[]}parse(N,j,Z,ce,he){return S._(this,void 0,void 0,(function*(){this.status="parsing",this.data=N,this.collisionBoxArray=new S.ag;const Te=new S.cN(Object.keys(N.layers).sort()),_e=new S.cO(this.tileID,this.promoteId);_e.bucketLayerIDs=[];const de={},Ee={featureIndex:_e,iconDependencies:{},patternDependencies:{},glyphDependencies:{},dashDependencies:{},availableImages:Z,subdivisionGranularity:he},Ue=j.familiesBySource[this.source];for(const ar in Ue){const Cr=N.layers[ar];if(!Cr)continue;Cr.version===1&&S.w(`Vector tile source "${this.source}" layer "${ar}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const ys=Te.encode(ar),xs=[];for(let Ze=0;Ze<Cr.length;Ze++){const fi=Cr.feature(Ze),Si=_e.getId(fi,ar);xs.push({feature:fi,id:Si,index:Ze,sourceLayerIndex:ys})}for(const Ze of Ue[ar]){const fi=Ze[0];fi.source!==this.source&&S.w(`layer.source = ${fi.source} does not equal this.source = ${this.source}`),fi.isHidden(this.zoom,!0)||(me(Ze,this.zoom,Z),(de[fi.id]=fi.createBucket({index:_e.bucketLayerIDs.length,layers:Ze,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:ys,sourceID:this.source})).populate(xs,Ee,this.tileID.canonical),_e.bucketLayerIDs.push(Ze.map((Si=>Si.id))))}}const Oe=S.bY(Ee.glyphDependencies,(ar=>Object.keys(ar).map(Number)));this.inFlightDependencies.forEach((ar=>ar?.abort())),this.inFlightDependencies=[];let at=Promise.resolve({});if(Object.keys(Oe).length){const ar=new AbortController;this.inFlightDependencies.push(ar),at=ce.sendAsync({type:"GG",data:{stacks:Oe,source:this.source,tileID:this.tileID,type:"glyphs"}},ar)}const ft=Object.keys(Ee.iconDependencies);let kt=Promise.resolve({});if(ft.length){const ar=new AbortController;this.inFlightDependencies.push(ar),kt=ce.sendAsync({type:"GI",data:{icons:ft,source:this.source,tileID:this.tileID,type:"icons"}},ar)}const nr=Object.keys(Ee.patternDependencies);let er=Promise.resolve({});if(nr.length){const ar=new AbortController;this.inFlightDependencies.push(ar),er=ce.sendAsync({type:"GI",data:{icons:nr,source:this.source,tileID:this.tileID,type:"patterns"}},ar)}const Se=Ee.dashDependencies;let dr=Promise.resolve({});if(Object.keys(Se).length){const ar=new AbortController;this.inFlightDependencies.push(ar),dr=ce.sendAsync({type:"GDA",data:{dashes:Se}},ar)}const[ui,Dt,or,Hr]=yield Promise.all([at,kt,er,dr]),cr=new $(ui),mr=new S.cP(Dt,or);for(const ar in de){const Cr=de[ar];Cr instanceof S.ah?(me(Cr.layers,this.zoom,Z),S.cQ({bucket:Cr,glyphMap:ui,glyphPositions:cr.positions,imageMap:Dt,imagePositions:mr.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical,subdivisionGranularity:Ee.subdivisionGranularity})):Cr.hasDependencies&&(Cr instanceof S.cR||Cr instanceof S.cS||Cr instanceof S.cT)&&(me(Cr.layers,this.zoom,Z),Cr.addFeatures(Ee,this.tileID.canonical,mr.patternPositions,Hr))}return this.status="done",{buckets:Object.values(de).filter((ar=>!ar.isEmpty())),featureIndex:_e,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:cr.image,imageAtlas:mr,dashPositions:Hr,glyphMap:this.returnDependencies?ui:null,iconMap:this.returnDependencies?Dt:null,glyphPositions:this.returnDependencies?cr.positions:null}}))}}function me(ve,N,j){const Z=new S.H(N);for(const ce of ve)ce.recalculate(Z,j)}class we{constructor(N,j,Z,ce,he){this.type=N,this.properties=Z||{},this.extent=he,this.pointsArray=j,this.id=ce}loadGeometry(){return this.pointsArray.map((N=>N.map((j=>new S.P(j.x,j.y)))))}}class ye{constructor(N,j,Z){this.version=2,this._myFeatures=N,this.name=j,this.length=N.length,this.extent=Z}feature(N){return this._myFeatures[N]}}class ze{constructor(){this.layers={}}addLayer(N){this.layers[N.name]=N}}function Ke(ve){let N=S.cU(ve);return N.byteOffset===0&&N.byteLength===N.buffer.byteLength||(N=new Uint8Array(N)),{vectorTile:ve,rawData:N.buffer}}function ot(ve,N,j){const{extent:Z}=ve,ce=Math.pow(2,j.z-N.z),he=(j.x-N.x*ce)*Z,Te=(j.y-N.y*ce)*Z,_e=[];for(let de=0;de<ve.length;de++){const Ee=ve.feature(de);let Ue=Ee.loadGeometry();for(const at of Ue)for(const ft of at)ft.x=ft.x*ce-he,ft.y=ft.y*ce-Te;const Oe=128;Ue=S.cV(Ue,Ee.type,-Oe,-Oe,Z+Oe,Z+Oe),Ue.length!==0&&_e.push(new we(Ee.type,Ue,Ee.properties,Ee.id,Z))}return new ye(_e,ve.name,Z)}class ge{constructor(N,j,Z){this.actor=N,this.layerIndex=j,this.availableImages=Z,this.fetching={},this.loading={},this.loaded={},this.overzoomedTileResultCache=new S.cW(1e3)}loadVectorTile(N,j){return S._(this,void 0,void 0,(function*(){const Z=yield S.n(N.request,j);try{return{vectorTile:N.encoding!=="mlt"?new S.cX(new S.cY(Z.data)):new S.cZ(Z.data),rawData:Z.data,cacheControl:Z.cacheControl,expires:Z.expires}}catch(ce){const he=new Uint8Array(Z.data);let Te=`Unable to parse the tile at ${N.request.url}, `;throw Te+=he[0]===31&&he[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${ce.message}`,new Error(Te)}}))}loadTile(N){return S._(this,void 0,void 0,(function*(){const{uid:j,overzoomParameters:Z}=N;Z&&(N.request=Z.overzoomRequest);const ce=!!(N&&N.request&&N.request.collectResourceTiming)&&new S.c_(N.request),he=new oe(N);this.loading[j]=he;const Te=new AbortController;he.abort=Te;try{const _e=yield this.loadVectorTile(N,Te);if(delete this.loading[j],!_e)return null;if(Z){const at=this._getOverzoomTile(N,_e.vectorTile);_e.rawData=at.rawData,_e.vectorTile=at.vectorTile}const de=_e.rawData,Ee={};_e.expires&&(Ee.expires=_e.expires),_e.cacheControl&&(Ee.cacheControl=_e.cacheControl);const Ue={};if(ce){const at=ce.finish();at&&(Ue.resourceTiming=JSON.parse(JSON.stringify(at)))}he.vectorTile=_e.vectorTile;const Oe=he.parse(_e.vectorTile,this.layerIndex,this.availableImages,this.actor,N.subdivisionGranularity);this.loaded[j]=he,this.fetching[j]={rawTileData:de,cacheControl:Ee,resourceTiming:Ue};try{const at=yield Oe;return S.e({rawTileData:de.slice(0),encoding:N.encoding},at,Ee,Ue)}finally{delete this.fetching[j]}}catch(_e){throw delete this.loading[j],he.status="done",this.loaded[j]=he,_e}}))}_getOverzoomTile(N,j){const{tileID:Z,source:ce,overzoomParameters:he}=N,{maxZoomTileID:Te}=he,_e=`${Te.key}_${Z.key}`,de=this.overzoomedTileResultCache.get(_e);if(de)return de;const Ee=new ze,Ue=this.layerIndex.familiesBySource[ce];for(const at in Ue){const ft=j.layers[at];if(!ft)continue;const kt=ot(ft,Te,Z.canonical);kt.length>0&&Ee.addLayer(kt)}const Oe=Ke(Ee);return this.overzoomedTileResultCache.set(_e,Oe),Oe}reloadTile(N){return S._(this,void 0,void 0,(function*(){const j=N.uid;if(!this.loaded||!this.loaded[j])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const Z=this.loaded[j];if(Z.showCollisionBoxes=N.showCollisionBoxes,Z.status==="parsing"){const ce=yield Z.parse(Z.vectorTile,this.layerIndex,this.availableImages,this.actor,N.subdivisionGranularity);let he;if(this.fetching[j]){const{rawTileData:Te,cacheControl:_e,resourceTiming:de}=this.fetching[j];delete this.fetching[j],he=S.e({rawTileData:Te.slice(0),encoding:N.encoding},ce,_e,de)}else he=ce;return he}if(Z.status==="done"&&Z.vectorTile)return Z.parse(Z.vectorTile,this.layerIndex,this.availableImages,this.actor,N.subdivisionGranularity)}))}abortTile(N){return S._(this,void 0,void 0,(function*(){const j=this.loading,Z=N.uid;j&&j[Z]&&j[Z].abort&&(j[Z].abort.abort(),delete j[Z])}))}removeTile(N){return S._(this,void 0,void 0,(function*(){this.loaded&&this.loaded[N.uid]&&delete this.loaded[N.uid]}))}}class Pt{constructor(){this.loaded={}}loadTile(N){return S._(this,void 0,void 0,(function*(){const{uid:j,encoding:Z,rawImageData:ce,redFactor:he,greenFactor:Te,blueFactor:_e,baseShift:de}=N,Ee=ce.width+2,Ue=ce.height+2,Oe=S.b(ce)?new S.R({width:Ee,height:Ue},yield S.c$(ce,-1,-1,Ee,Ue)):ce,at=new S.d0(j,Oe,Z,he,Te,_e,de);return this.loaded=this.loaded||{},this.loaded[j]=at,at}))}removeTile(N){const j=this.loaded,Z=N.uid;j&&j[Z]&&delete j[Z]}}var xt,At,Qt=(function(){if(At)return xt;function ve(j,Z){if(j.length!==0){N(j[0],Z);for(var ce=1;ce<j.length;ce++)N(j[ce],!Z)}}function N(j,Z){for(var ce=0,he=0,Te=0,_e=j.length,de=_e-1;Te<_e;de=Te++){var Ee=(j[Te][0]-j[de][0])*(j[de][1]+j[Te][1]),Ue=ce+Ee;he+=Math.abs(ce)>=Math.abs(Ee)?ce-Ue+Ee:Ee-Ue+ce,ce=Ue}ce+he>=0!=!!Z&&j.reverse()}return At=1,xt=function j(Z,ce){var he,Te=Z&&Z.type;if(Te==="FeatureCollection")for(he=0;he<Z.features.length;he++)j(Z.features[he],ce);else if(Te==="GeometryCollection")for(he=0;he<Z.geometries.length;he++)j(Z.geometries[he],ce);else if(Te==="Feature")j(Z.geometry,ce);else if(Te==="Polygon")ve(Z.coordinates,ce);else if(Te==="MultiPolygon")for(he=0;he<Z.coordinates.length;he++)ve(Z.coordinates[he],ce);return Z}})(),Fe=S.d1(Qt);const st={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:ve=>ve},Ye=Math.fround||(He=new Float32Array(1),ve=>(He[0]=+ve,He[0]));var He;class Ge{constructor(N){this.options=Object.assign(Object.create(st),N),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(N){const{log:j,minZoom:Z,maxZoom:ce}=this.options;j&&console.time("total time");const he=`prepare ${N.length} points`;j&&console.time(he),this.points=N;const Te=[];for(let de=0;de<N.length;de++){const Ee=N[de];if(!Ee.geometry)continue;const[Ue,Oe]=Ee.geometry.coordinates,at=Ye(Qe(Ue)),ft=Ye(Zt(Oe));Te.push(at,ft,1/0,de,-1,1),this.options.reduce&&Te.push(0)}let _e=this.trees[ce+1]=this._createTree(Te);j&&console.timeEnd(he);for(let de=ce;de>=Z;de--){const Ee=+Date.now();_e=this.trees[de]=this._createTree(this._cluster(_e,de)),j&&console.log("z%d: %d clusters in %dms",de,_e.numItems,+Date.now()-Ee)}return j&&console.timeEnd("total time"),this}getClusters(N,j){let Z=((N[0]+180)%360+360)%360-180;const ce=Math.max(-90,Math.min(90,N[1]));let he=N[2]===180?180:((N[2]+180)%360+360)%360-180;const Te=Math.max(-90,Math.min(90,N[3]));if(N[2]-N[0]>=360)Z=-180,he=180;else if(Z>he){const Oe=this.getClusters([Z,ce,180,Te],j),at=this.getClusters([-180,ce,he,Te],j);return Oe.concat(at)}const _e=this.trees[this._limitZoom(j)],de=_e.range(Qe(Z),Zt(Te),Qe(he),Zt(ce)),Ee=_e.data,Ue=[];for(const Oe of de){const at=this.stride*Oe;Ue.push(Ee[at+5]>1?pt(Ee,at,this.clusterProps):this.points[Ee[at+3]])}return Ue}getChildren(N){const j=this._getOriginId(N),Z=this._getOriginZoom(N),ce="No cluster with the specified id.",he=this.trees[Z];if(!he)throw new Error(ce);const Te=he.data;if(j*this.stride>=Te.length)throw new Error(ce);const _e=this.options.radius/(this.options.extent*Math.pow(2,Z-1)),de=he.within(Te[j*this.stride],Te[j*this.stride+1],_e),Ee=[];for(const Ue of de){const Oe=Ue*this.stride;Te[Oe+4]===N&&Ee.push(Te[Oe+5]>1?pt(Te,Oe,this.clusterProps):this.points[Te[Oe+3]])}if(Ee.length===0)throw new Error(ce);return Ee}getLeaves(N,j,Z){const ce=[];return this._appendLeaves(ce,N,j=j||10,Z=Z||0,0),ce}getTile(N,j,Z){const ce=this.trees[this._limitZoom(N)],he=Math.pow(2,N),{extent:Te,radius:_e}=this.options,de=_e/Te,Ee=(Z-de)/he,Ue=(Z+1+de)/he,Oe={features:[]};return this._addTileFeatures(ce.range((j-de)/he,Ee,(j+1+de)/he,Ue),ce.data,j,Z,he,Oe),j===0&&this._addTileFeatures(ce.range(1-de/he,Ee,1,Ue),ce.data,he,Z,he,Oe),j===he-1&&this._addTileFeatures(ce.range(0,Ee,de/he,Ue),ce.data,-1,Z,he,Oe),Oe.features.length?Oe:null}getClusterExpansionZoom(N){let j=this._getOriginZoom(N)-1;for(;j<=this.options.maxZoom;){const Z=this.getChildren(N);if(j++,Z.length!==1)break;N=Z[0].properties.cluster_id}return j}_appendLeaves(N,j,Z,ce,he){const Te=this.getChildren(j);for(const _e of Te){const de=_e.properties;if(de&&de.cluster?he+de.point_count<=ce?he+=de.point_count:he=this._appendLeaves(N,de.cluster_id,Z,ce,he):he<ce?he++:N.push(_e),N.length===Z)break}return he}_createTree(N){const j=new S.aT(N.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Z=0;Z<N.length;Z+=this.stride)j.add(N[Z],N[Z+1]);return j.finish(),j.data=N,j}_addTileFeatures(N,j,Z,ce,he,Te){for(const _e of N){const de=_e*this.stride,Ee=j[de+5]>1;let Ue,Oe,at;if(Ee)Ue=vt(j,de,this.clusterProps),Oe=j[de],at=j[de+1];else{const nr=this.points[j[de+3]];Ue=nr.properties;const[er,Se]=nr.geometry.coordinates;Oe=Qe(er),at=Zt(Se)}const ft={type:1,geometry:[[Math.round(this.options.extent*(Oe*he-Z)),Math.round(this.options.extent*(at*he-ce))]],tags:Ue};let kt;kt=Ee||this.options.generateId?j[de+3]:this.points[j[de+3]].id,kt!==void 0&&(ft.id=kt),Te.features.push(ft)}}_limitZoom(N){return Math.max(this.options.minZoom,Math.min(Math.floor(+N),this.options.maxZoom+1))}_cluster(N,j){const{radius:Z,extent:ce,reduce:he,minPoints:Te}=this.options,_e=Z/(ce*Math.pow(2,j)),de=N.data,Ee=[],Ue=this.stride;for(let Oe=0;Oe<de.length;Oe+=Ue){if(de[Oe+2]<=j)continue;de[Oe+2]=j;const at=de[Oe],ft=de[Oe+1],kt=N.within(de[Oe],de[Oe+1],_e),nr=de[Oe+5];let er=nr;for(const Se of kt){const dr=Se*Ue;de[dr+2]>j&&(er+=de[dr+5])}if(er>nr&&er>=Te){let Se,dr=at*nr,ui=ft*nr,Dt=-1;const or=(Oe/Ue<<5)+(j+1)+this.points.length;for(const Hr of kt){const cr=Hr*Ue;if(de[cr+2]<=j)continue;de[cr+2]=j;const mr=de[cr+5];dr+=de[cr]*mr,ui+=de[cr+1]*mr,de[cr+4]=or,he&&(Se||(Se=this._map(de,Oe,!0),Dt=this.clusterProps.length,this.clusterProps.push(Se)),he(Se,this._map(de,cr)))}de[Oe+4]=or,Ee.push(dr/er,ui/er,1/0,or,-1,er),he&&Ee.push(Dt)}else{for(let Se=0;Se<Ue;Se++)Ee.push(de[Oe+Se]);if(er>1)for(const Se of kt){const dr=Se*Ue;if(!(de[dr+2]<=j)){de[dr+2]=j;for(let ui=0;ui<Ue;ui++)Ee.push(de[dr+ui])}}}}return Ee}_getOriginId(N){return N-this.points.length>>5}_getOriginZoom(N){return(N-this.points.length)%32}_map(N,j,Z){if(N[j+5]>1){const Te=this.clusterProps[N[j+6]];return Z?Object.assign({},Te):Te}const ce=this.points[N[j+3]].properties,he=this.options.map(ce);return Z&&he===ce?Object.assign({},he):he}}function pt(ve,N,j){return{type:"Feature",id:ve[N+3],properties:vt(ve,N,j),geometry:{type:"Point",coordinates:[(Z=ve[N],360*(Z-.5)),Ht(ve[N+1])]}};var Z}function vt(ve,N,j){const Z=ve[N+5],ce=Z>=1e4?`${Math.round(Z/1e3)}k`:Z>=1e3?Math.round(Z/100)/10+"k":Z,he=ve[N+6],Te=he===-1?{}:Object.assign({},j[he]);return Object.assign(Te,{cluster:!0,cluster_id:ve[N+3],point_count:Z,point_count_abbreviated:ce})}function Qe(ve){return ve/360+.5}function Zt(ve){const N=Math.sin(ve*Math.PI/180),j=.5-.25*Math.log((1+N)/(1-N))/Math.PI;return j<0?0:j>1?1:j}function Ht(ve){const N=(180-360*ve)*Math.PI/180;return 360*Math.atan(Math.exp(N))/Math.PI-90}function rt(ve,N,j,Z){let ce=Z;const he=N+(j-N>>1);let Te,_e=j-N;const de=ve[N],Ee=ve[N+1],Ue=ve[j],Oe=ve[j+1];for(let at=N+3;at<j;at+=3){const ft=Jt(ve[at],ve[at+1],de,Ee,Ue,Oe);if(ft>ce)Te=at,ce=ft;else if(ft===ce){const kt=Math.abs(at-he);kt<_e&&(Te=at,_e=kt)}}ce>Z&&(Te-N>3&&rt(ve,N,Te,Z),ve[Te+2]=ce,j-Te>3&&rt(ve,Te,j,Z))}function Jt(ve,N,j,Z,ce,he){let Te=ce-j,_e=he-Z;if(Te!==0||_e!==0){const de=((ve-j)*Te+(N-Z)*_e)/(Te*Te+_e*_e);de>1?(j=ce,Z=he):de>0&&(j+=Te*de,Z+=_e*de)}return Te=ve-j,_e=N-Z,Te*Te+_e*_e}function Wt(ve,N,j,Z){const ce={id:ve??null,type:N,geometry:j,tags:Z,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(N==="Point"||N==="MultiPoint"||N==="LineString")Xt(ce,j);else if(N==="Polygon")Xt(ce,j[0]);else if(N==="MultiLineString")for(const he of j)Xt(ce,he);else if(N==="MultiPolygon")for(const he of j)Xt(ce,he[0]);return ce}function Xt(ve,N){for(let j=0;j<N.length;j+=3)ve.minX=Math.min(ve.minX,N[j]),ve.minY=Math.min(ve.minY,N[j+1]),ve.maxX=Math.max(ve.maxX,N[j]),ve.maxY=Math.max(ve.maxY,N[j+1])}function Ct(ve,N,j,Z){if(!N.geometry)return;const ce=N.geometry.coordinates;if(ce&&ce.length===0)return;const he=N.geometry.type,Te=Math.pow(j.tolerance/((1<<j.maxZoom)*j.extent),2);let _e=[],de=N.id;if(j.promoteId?de=N.properties[j.promoteId]:j.generateId&&(de=Z||0),he==="Point")Kt(ce,_e);else if(he==="MultiPoint")for(const Ee of ce)Kt(Ee,_e);else if(he==="LineString")Nt(ce,_e,Te,!1);else if(he==="MultiLineString"){if(j.lineMetrics){for(const Ee of ce)_e=[],Nt(Ee,_e,Te,!1),ve.push(Wt(de,"LineString",_e,N.properties));return}hr(ce,_e,Te,!1)}else if(he==="Polygon")hr(ce,_e,Te,!0);else{if(he!=="MultiPolygon"){if(he==="GeometryCollection"){for(const Ee of N.geometry.geometries)Ct(ve,{id:de,geometry:Ee,properties:N.properties},j,Z);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const Ee of ce){const Ue=[];hr(Ee,Ue,Te,!0),_e.push(Ue)}}ve.push(Wt(de,he,_e,N.properties))}function Kt(ve,N){N.push(us(ve[0]),Os(ve[1]),0)}function Nt(ve,N,j,Z){let ce,he,Te=0;for(let de=0;de<ve.length;de++){const Ee=us(ve[de][0]),Ue=Os(ve[de][1]);N.push(Ee,Ue,0),de>0&&(Te+=Z?(ce*Ue-Ee*he)/2:Math.sqrt(Math.pow(Ee-ce,2)+Math.pow(Ue-he,2))),ce=Ee,he=Ue}const _e=N.length-3;N[2]=1,rt(N,0,_e,j),N[_e+2]=1,N.size=Math.abs(Te),N.start=0,N.end=N.size}function hr(ve,N,j,Z){for(let ce=0;ce<ve.length;ce++){const he=[];Nt(ve[ce],he,j,Z),N.push(he)}}function us(ve){return ve/360+.5}function Os(ve){const N=Math.sin(ve*Math.PI/180),j=.5-.25*Math.log((1+N)/(1-N))/Math.PI;return j<0?0:j>1?1:j}function ci(ve,N,j,Z,ce,he,Te,_e){if(Z/=N,he>=(j/=N)&&Te<Z)return ve;if(Te<j||he>=Z)return null;const de=[];for(const Ee of ve){const Ue=Ee.geometry;let Oe=Ee.type;const at=ce===0?Ee.minX:Ee.minY,ft=ce===0?Ee.maxX:Ee.maxY;if(at>=j&&ft<Z){de.push(Ee);continue}if(ft<j||at>=Z)continue;let kt=[];if(Oe==="Point"||Oe==="MultiPoint")Bi(Ue,kt,j,Z,ce);else if(Oe==="LineString")ii(Ue,kt,j,Z,ce,!1,_e.lineMetrics);else if(Oe==="MultiLineString")Vt(Ue,kt,j,Z,ce,!1);else if(Oe==="Polygon")Vt(Ue,kt,j,Z,ce,!0);else if(Oe==="MultiPolygon")for(const nr of Ue){const er=[];Vt(nr,er,j,Z,ce,!0),er.length&&kt.push(er)}if(kt.length){if(_e.lineMetrics&&Oe==="LineString"){for(const nr of kt)de.push(Wt(Ee.id,Oe,nr,Ee.tags));continue}Oe!=="LineString"&&Oe!=="MultiLineString"||(kt.length===1?(Oe="LineString",kt=kt[0]):Oe="MultiLineString"),Oe!=="Point"&&Oe!=="MultiPoint"||(Oe=kt.length===3?"Point":"MultiPoint"),de.push(Wt(Ee.id,Oe,kt,Ee.tags))}}return de.length?de:null}function Bi(ve,N,j,Z,ce){for(let he=0;he<ve.length;he+=3){const Te=ve[he+ce];Te>=j&&Te<=Z&&Lr(N,ve[he],ve[he+1],ve[he+2])}}function ii(ve,N,j,Z,ce,he,Te){let _e=Sr(ve);const de=ce===0?cn:Zi;let Ee,Ue,Oe=ve.start;for(let er=0;er<ve.length-3;er+=3){const Se=ve[er],dr=ve[er+1],ui=ve[er+2],Dt=ve[er+3],or=ve[er+4],Hr=ce===0?Se:dr,cr=ce===0?Dt:or;let mr=!1;Te&&(Ee=Math.sqrt(Math.pow(Se-Dt,2)+Math.pow(dr-or,2))),Hr<j?cr>j&&(Ue=de(_e,Se,dr,Dt,or,j),Te&&(_e.start=Oe+Ee*Ue)):Hr>Z?cr<Z&&(Ue=de(_e,Se,dr,Dt,or,Z),Te&&(_e.start=Oe+Ee*Ue)):Lr(_e,Se,dr,ui),cr<j&&Hr>=j&&(Ue=de(_e,Se,dr,Dt,or,j),mr=!0),cr>Z&&Hr<=Z&&(Ue=de(_e,Se,dr,Dt,or,Z),mr=!0),!he&&mr&&(Te&&(_e.end=Oe+Ee*Ue),N.push(_e),_e=Sr(ve)),Te&&(Oe+=Ee)}let at=ve.length-3;const ft=ve[at],kt=ve[at+1],nr=ce===0?ft:kt;nr>=j&&nr<=Z&&Lr(_e,ft,kt,ve[at+2]),at=_e.length-3,he&&at>=3&&(_e[at]!==_e[0]||_e[at+1]!==_e[1])&&Lr(_e,_e[0],_e[1],_e[2]),_e.length&&N.push(_e)}function Sr(ve){const N=[];return N.size=ve.size,N.start=ve.start,N.end=ve.end,N}function Vt(ve,N,j,Z,ce,he){for(const Te of ve)ii(Te,N,j,Z,ce,he,!1)}function Lr(ve,N,j,Z){ve.push(N,j,Z)}function cn(ve,N,j,Z,ce,he){const Te=(he-N)/(Z-N);return Lr(ve,he,j+(ce-j)*Te,1),Te}function Zi(ve,N,j,Z,ce,he){const Te=(he-j)/(ce-j);return Lr(ve,N+(Z-N)*Te,he,1),Te}function Bs(ve,N){const j=[];for(let Z=0;Z<ve.length;Z++){const ce=ve[Z],he=ce.type;let Te;if(he==="Point"||he==="MultiPoint"||he==="LineString")Te=Vr(ce.geometry,N);else if(he==="MultiLineString"||he==="Polygon"){Te=[];for(const _e of ce.geometry)Te.push(Vr(_e,N))}else if(he==="MultiPolygon"){Te=[];for(const _e of ce.geometry){const de=[];for(const Ee of _e)de.push(Vr(Ee,N));Te.push(de)}}j.push(Wt(ce.id,he,Te,ce.tags))}return j}function Vr(ve,N){const j=[];j.size=ve.size,ve.start!==void 0&&(j.start=ve.start,j.end=ve.end);for(let Z=0;Z<ve.length;Z+=3)j.push(ve[Z]+N,ve[Z+1],ve[Z+2]);return j}function ji(ve,N){if(ve.transformed)return ve;const j=1<<ve.z,Z=ve.x,ce=ve.y;for(const he of ve.features){const Te=he.geometry,_e=he.type;if(he.geometry=[],_e===1)for(let de=0;de<Te.length;de+=2)he.geometry.push(Ni(Te[de],Te[de+1],N,j,Z,ce));else for(let de=0;de<Te.length;de++){const Ee=[];for(let Ue=0;Ue<Te[de].length;Ue+=2)Ee.push(Ni(Te[de][Ue],Te[de][Ue+1],N,j,Z,ce));he.geometry.push(Ee)}}return ve.transformed=!0,ve}function Ni(ve,N,j,Z,ce,he){return[Math.round(j*(ve*Z-ce)),Math.round(j*(N*Z-he))]}function Mr(ve,N,j,Z,ce){const he=N===ce.maxZoom?0:ce.tolerance/((1<<N)*ce.extent),Te={features:[],numPoints:0,numSimplified:0,numFeatures:ve.length,source:null,x:j,y:Z,z:N,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const _e of ve)js(Te,_e,he,ce);return Te}function js(ve,N,j,Z){const ce=N.geometry,he=N.type,Te=[];if(ve.minX=Math.min(ve.minX,N.minX),ve.minY=Math.min(ve.minY,N.minY),ve.maxX=Math.max(ve.maxX,N.maxX),ve.maxY=Math.max(ve.maxY,N.maxY),he==="Point"||he==="MultiPoint")for(let _e=0;_e<ce.length;_e+=3)Te.push(ce[_e],ce[_e+1]),ve.numPoints++,ve.numSimplified++;else if(he==="LineString")Ws(Te,ce,ve,j,!1,!1);else if(he==="MultiLineString"||he==="Polygon")for(let _e=0;_e<ce.length;_e++)Ws(Te,ce[_e],ve,j,he==="Polygon",_e===0);else if(he==="MultiPolygon")for(let _e=0;_e<ce.length;_e++){const de=ce[_e];for(let Ee=0;Ee<de.length;Ee++)Ws(Te,de[Ee],ve,j,!0,Ee===0)}if(Te.length){let _e=N.tags||null;if(he==="LineString"&&Z.lineMetrics){_e={};for(const Ee in N.tags)_e[Ee]=N.tags[Ee];_e.mapbox_clip_start=ce.start/ce.size,_e.mapbox_clip_end=ce.end/ce.size}const de={geometry:Te,type:he==="Polygon"||he==="MultiPolygon"?3:he==="LineString"||he==="MultiLineString"?2:1,tags:_e};N.id!==null&&(de.id=N.id),ve.features.push(de)}}function Ws(ve,N,j,Z,ce,he){const Te=Z*Z;if(Z>0&&N.size<(ce?Te:Z))return void(j.numPoints+=N.length/3);const _e=[];for(let de=0;de<N.length;de+=3)(Z===0||N[de+2]>Te)&&(j.numSimplified++,_e.push(N[de],N[de+1])),j.numPoints++;ce&&(function(de,Ee){let Ue=0;for(let Oe=0,at=de.length,ft=at-2;Oe<at;ft=Oe,Oe+=2)Ue+=(de[Oe]-de[ft])*(de[Oe+1]+de[ft+1]);if(Ue>0===Ee)for(let Oe=0,at=de.length;Oe<at/2;Oe+=2){const ft=de[Oe],kt=de[Oe+1];de[Oe]=de[at-2-Oe],de[Oe+1]=de[at-1-Oe],de[at-2-Oe]=ft,de[at-1-Oe]=kt}})(_e,he),ve.push(_e)}const un={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Hi{constructor(N,j){const Z=(j=this.options=(function(he,Te){for(const _e in Te)he[_e]=Te[_e];return he})(Object.create(un),j)).debug;if(Z&&console.time("preprocess data"),j.maxZoom<0||j.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(j.promoteId&&j.generateId)throw new Error("promoteId and generateId cannot be used together.");let ce=(function(he,Te){const _e=[];if(he.type==="FeatureCollection")for(let de=0;de<he.features.length;de++)Ct(_e,he.features[de],Te,de);else Ct(_e,he.type==="Feature"?he:{geometry:he},Te);return _e})(N,j);this.tiles={},this.tileCoords=[],Z&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",j.indexMaxZoom,j.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ce=(function(he,Te){const _e=Te.buffer/Te.extent;let de=he;const Ee=ci(he,1,-1-_e,_e,0,-1,2,Te),Ue=ci(he,1,1-_e,2+_e,0,-1,2,Te);return(Ee||Ue)&&(de=ci(he,1,-_e,1+_e,0,-1,2,Te)||[],Ee&&(de=Bs(Ee,1).concat(de)),Ue&&(de=de.concat(Bs(Ue,-1)))),de})(ce,j),ce.length&&this.splitTile(ce,0,0,0),Z&&(ce.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(N,j,Z,ce,he,Te,_e){const de=[N,j,Z,ce],Ee=this.options,Ue=Ee.debug;for(;de.length;){ce=de.pop(),Z=de.pop(),j=de.pop(),N=de.pop();const Oe=1<<j,at=Wi(j,Z,ce);let ft=this.tiles[at];if(!ft&&(Ue>1&&console.time("creation"),ft=this.tiles[at]=Mr(N,j,Z,ce,Ee),this.tileCoords.push({z:j,x:Z,y:ce}),Ue)){Ue>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",j,Z,ce,ft.numFeatures,ft.numPoints,ft.numSimplified),console.timeEnd("creation"));const mr=`z${j}`;this.stats[mr]=(this.stats[mr]||0)+1,this.total++}if(ft.source=N,he==null){if(j===Ee.indexMaxZoom||ft.numPoints<=Ee.indexMaxPoints)continue}else{if(j===Ee.maxZoom||j===he)continue;if(he!=null){const mr=he-j;if(Z!==Te>>mr||ce!==_e>>mr)continue}}if(ft.source=null,N.length===0)continue;Ue>1&&console.time("clipping");const kt=.5*Ee.buffer/Ee.extent,nr=.5-kt,er=.5+kt,Se=1+kt;let dr=null,ui=null,Dt=null,or=null,Hr=ci(N,Oe,Z-kt,Z+er,0,ft.minX,ft.maxX,Ee),cr=ci(N,Oe,Z+nr,Z+Se,0,ft.minX,ft.maxX,Ee);N=null,Hr&&(dr=ci(Hr,Oe,ce-kt,ce+er,1,ft.minY,ft.maxY,Ee),ui=ci(Hr,Oe,ce+nr,ce+Se,1,ft.minY,ft.maxY,Ee),Hr=null),cr&&(Dt=ci(cr,Oe,ce-kt,ce+er,1,ft.minY,ft.maxY,Ee),or=ci(cr,Oe,ce+nr,ce+Se,1,ft.minY,ft.maxY,Ee),cr=null),Ue>1&&console.timeEnd("clipping"),de.push(dr||[],j+1,2*Z,2*ce),de.push(ui||[],j+1,2*Z,2*ce+1),de.push(Dt||[],j+1,2*Z+1,2*ce),de.push(or||[],j+1,2*Z+1,2*ce+1)}}getTile(N,j,Z){N=+N,j=+j,Z=+Z;const ce=this.options,{extent:he,debug:Te}=ce;if(N<0||N>24)return null;const _e=1<<N,de=Wi(N,j=j+_e&_e-1,Z);if(this.tiles[de])return ji(this.tiles[de],he);Te>1&&console.log("drilling down to z%d-%d-%d",N,j,Z);let Ee,Ue=N,Oe=j,at=Z;for(;!Ee&&Ue>0;)Ue--,Oe>>=1,at>>=1,Ee=this.tiles[Wi(Ue,Oe,at)];return Ee&&Ee.source?(Te>1&&(console.log("found parent tile z%d-%d-%d",Ue,Oe,at),console.time("drilling down")),this.splitTile(Ee.source,Ue,Oe,at,N,j,Z),Te>1&&console.timeEnd("drilling down"),this.tiles[de]?ji(this.tiles[de],he):null):null}}function Wi(ve,N,j){return 32*((1<<ve)*j+N)+ve}class _s extends ge{constructor(N,j,Z,ce=Ti){super(N,j,Z),this._dataUpdateable=new Map,this._createGeoJSONIndex=ce}loadVectorTile(N,j){return S._(this,void 0,void 0,(function*(){const Z=N.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const ce=this._geoJSONIndex.getTile(Z.z,Z.x,Z.y);return ce?Ke(new S.d2(ce.features,{version:2,extent:S.a5})):null}))}loadData(N){return S._(this,void 0,void 0,(function*(){var j;(j=this._pendingRequest)===null||j===void 0||j.abort();const Z=this._startPerformance(N);this._pendingRequest=new AbortController;try{(!this._pendingData||N.request||N.data||N.dataDiff)&&(this._pendingData=this.loadAndProcessGeoJSON(N,this._pendingRequest));const ce=yield this._pendingData;this._geoJSONIndex=this._createGeoJSONIndex(ce,N),this.loaded={};const he={};return N.request&&(he.data=ce),this._finishPerformance(Z,N,he),he}catch(ce){if(delete this._pendingRequest,S.Z(ce))return{abandoned:!0};throw ce}}))}_startPerformance(N){var j;if(!((j=N?.request)===null||j===void 0)&&j.collectResourceTiming)return new S.c_(N.request)}_finishPerformance(N,j,Z){if(!N)return;const ce=N.finish();ce&&(Z.resourceTiming={},Z.resourceTiming[j.source]=JSON.parse(JSON.stringify(ce)))}getData(){return S._(this,void 0,void 0,(function*(){return this._pendingData}))}reloadTile(N){const j=this.loaded;return j&&j[N.uid]?super.reloadTile(N):this.loadTile(N)}loadAndProcessGeoJSON(N,j){return S._(this,void 0,void 0,(function*(){let Z;if(N.request?Z=yield this.loadGeoJSONFromUrl(N.request,N.promoteId,j):N.data?Z=this._loadGeoJSONFromObject(N.data,N.promoteId):N.dataDiff&&(Z=this._loadGeoJSONFromDiff(N.dataDiff,N.promoteId,N.source)),delete this._pendingRequest,typeof Z!="object")throw new Error(`Input data given to '${N.source}' is not a valid GeoJSON object.`);return Fe(Z,!0),N.filter&&(Z=this._filterGeoJSON(Z,N.filter)),Z}))}loadGeoJSONFromUrl(N,j,Z){return S._(this,void 0,void 0,(function*(){const ce=yield S.j(N,Z);return this._dataUpdateable=S.a7(ce.data,j),ce.data}))}_loadGeoJSONFromObject(N,j){return this._dataUpdateable=S.a7(N,j),N}_loadGeoJSONFromDiff(N,j,Z){if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${Z}`);S.a8(this._dataUpdateable,N,j);const ce=Array.from(this._dataUpdateable.values());return this._toFeatureCollection(ce)}_filterGeoJSON(N,j){const Z=S.d3(j,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Z.result==="error")throw new Error(Z.value.map((he=>`${he.key}: ${he.message}`)).join(", "));const ce=N.features.filter((he=>Z.value.evaluate({zoom:0},he)));return this._toFeatureCollection(ce)}_toFeatureCollection(N){return{type:"FeatureCollection",features:N}}removeSource(N){return S._(this,void 0,void 0,(function*(){this._pendingRequest&&this._pendingRequest.abort()}))}getClusterExpansionZoom(N){return this._geoJSONIndex.getClusterExpansionZoom(N.clusterId)}getClusterChildren(N){return this._geoJSONIndex.getChildren(N.clusterId)}getClusterLeaves(N){return this._geoJSONIndex.getLeaves(N.clusterId,N.limit,N.offset)}}function Ti(ve,N){return N.cluster?new Ge((function({superclusterOptions:j,clusterProperties:Z}){if(!Z||!j)return j;const ce={},he={},Te={accumulated:null,zoom:0},_e={properties:null},de=Object.keys(Z);for(const Ee of de){const[Ue,Oe]=Z[Ee],at=S.d3(Oe),ft=S.d3(typeof Ue=="string"?[Ue,["accumulated"],["get",Ee]]:Ue);ce[Ee]=at.value,he[Ee]=ft.value}return j.map=Ee=>{_e.properties=Ee;const Ue={};for(const Oe of de)Ue[Oe]=ce[Oe].evaluate(Te,_e);return Ue},j.reduce=(Ee,Ue)=>{_e.properties=Ue;for(const Oe of de)Te.accumulated=Ee[Oe],Ee[Oe]=he[Oe].evaluate(Te,_e)},j})(N)).load(ve.features):(function(j,Z){return new Hi(j,Z)})(ve,N.geojsonVtOptions)}class Ai{constructor(N){this.self=N,this.actor=new S.L(N),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.globalStates=new Map,this.self.registerWorkerSource=(j,Z)=>{if(this.externalWorkerSourceTypes[j])throw new Error(`Worker source with name "${j}" already registered.`);this.externalWorkerSourceTypes[j]=Z},this.self.addProtocol=S.cJ,this.self.removeProtocol=S.cK,this.self.registerRTLTextPlugin=j=>{S.d4.setMethods(j)},this.actor.registerMessageHandler("LDT",((j,Z)=>this._getDEMWorkerSource(j,Z.source).loadTile(Z))),this.actor.registerMessageHandler("RDT",((j,Z)=>S._(this,void 0,void 0,(function*(){this._getDEMWorkerSource(j,Z.source).removeTile(Z)})))),this.actor.registerMessageHandler("GCEZ",((j,Z)=>S._(this,void 0,void 0,(function*(){return this._getWorkerSource(j,Z.type,Z.source).getClusterExpansionZoom(Z)})))),this.actor.registerMessageHandler("GCC",((j,Z)=>S._(this,void 0,void 0,(function*(){return this._getWorkerSource(j,Z.type,Z.source).getClusterChildren(Z)})))),this.actor.registerMessageHandler("GCL",((j,Z)=>S._(this,void 0,void 0,(function*(){return this._getWorkerSource(j,Z.type,Z.source).getClusterLeaves(Z)})))),this.actor.registerMessageHandler("LD",((j,Z)=>this._getWorkerSource(j,Z.type,Z.source).loadData(Z))),this.actor.registerMessageHandler("GD",((j,Z)=>this._getWorkerSource(j,Z.type,Z.source).getData())),this.actor.registerMessageHandler("LT",((j,Z)=>this._getWorkerSource(j,Z.type,Z.source).loadTile(Z))),this.actor.registerMessageHandler("RT",((j,Z)=>this._getWorkerSource(j,Z.type,Z.source).reloadTile(Z))),this.actor.registerMessageHandler("AT",((j,Z)=>this._getWorkerSource(j,Z.type,Z.source).abortTile(Z))),this.actor.registerMessageHandler("RMT",((j,Z)=>this._getWorkerSource(j,Z.type,Z.source).removeTile(Z))),this.actor.registerMessageHandler("RS",((j,Z)=>S._(this,void 0,void 0,(function*(){if(!this.workerSources[j]||!this.workerSources[j][Z.type]||!this.workerSources[j][Z.type][Z.source])return;const ce=this.workerSources[j][Z.type][Z.source];delete this.workerSources[j][Z.type][Z.source],ce.removeSource!==void 0&&ce.removeSource(Z)})))),this.actor.registerMessageHandler("RM",(j=>S._(this,void 0,void 0,(function*(){delete this.layerIndexes[j],delete this.availableImages[j],delete this.workerSources[j],delete this.demWorkerSources[j],this.globalStates.delete(j)})))),this.actor.registerMessageHandler("SR",((j,Z)=>S._(this,void 0,void 0,(function*(){this.referrer=Z})))),this.actor.registerMessageHandler("SRPS",((j,Z)=>this._syncRTLPluginState(j,Z))),this.actor.registerMessageHandler("IS",((j,Z)=>S._(this,void 0,void 0,(function*(){this.self.importScripts(Z)})))),this.actor.registerMessageHandler("SI",((j,Z)=>this._setImages(j,Z))),this.actor.registerMessageHandler("UL",((j,Z)=>S._(this,void 0,void 0,(function*(){this._getLayerIndex(j).update(Z.layers,Z.removedIds,this._getGlobalState(j))})))),this.actor.registerMessageHandler("UGS",((j,Z)=>S._(this,void 0,void 0,(function*(){const ce=this._getGlobalState(j);for(const he in Z)ce[he]=Z[he]})))),this.actor.registerMessageHandler("SL",((j,Z)=>S._(this,void 0,void 0,(function*(){this._getLayerIndex(j).replace(Z,this._getGlobalState(j))}))))}_getGlobalState(N){let j=this.globalStates.get(N);return j||(j={},this.globalStates.set(N,j)),j}_setImages(N,j){return S._(this,void 0,void 0,(function*(){this.availableImages[N]=j;for(const Z in this.workerSources[N]){const ce=this.workerSources[N][Z];for(const he in ce)ce[he].availableImages=j}}))}_syncRTLPluginState(N,j){return S._(this,void 0,void 0,(function*(){return yield S.d4.syncState(j,this.self.importScripts)}))}_getAvailableImages(N){let j=this.availableImages[N];return j||(j=[]),j}_getLayerIndex(N){let j=this.layerIndexes[N];return j||(j=this.layerIndexes[N]=new l),j}_getWorkerSource(N,j,Z){if(this.workerSources[N]||(this.workerSources[N]={}),this.workerSources[N][j]||(this.workerSources[N][j]={}),!this.workerSources[N][j][Z]){const ce={sendAsync:(he,Te)=>(he.targetMapId=N,this.actor.sendAsync(he,Te))};switch(j){case"vector":this.workerSources[N][j][Z]=new ge(ce,this._getLayerIndex(N),this._getAvailableImages(N));break;case"geojson":this.workerSources[N][j][Z]=new _s(ce,this._getLayerIndex(N),this._getAvailableImages(N));break;default:this.workerSources[N][j][Z]=new this.externalWorkerSourceTypes[j](ce,this._getLayerIndex(N),this._getAvailableImages(N))}}return this.workerSources[N][j][Z]}_getDEMWorkerSource(N,j){return this.demWorkerSources[N]||(this.demWorkerSources[N]={}),this.demWorkerSources[N][j]||(this.demWorkerSources[N][j]=new Pt),this.demWorkerSources[N][j]}}return S.i(self)&&(self.worker=new Ai(self)),Ai})),E("index",["exports","./shared"],(function(S,l){var $="5.15.0";function oe(){var p=new l.A(4);return l.A!=Float32Array&&(p[1]=0,p[2]=0),p[0]=1,p[3]=1,p}let me,we,ye;const ze={frame(p,t,s){const o=requestAnimationFrame((f=>{u(),t(f)})),{unsubscribe:u}=l.s(p.signal,"abort",(()=>{u(),cancelAnimationFrame(o),s(new l.a(p.signal.reason))}),!1)},frameAsync(p){return new Promise(((t,s)=>{this.frame(p,t,s)}))},getImageData(p,t=0){return this.getImageCanvasContext(p).getImageData(-t,-t,p.width+2*t,p.height+2*t)},getImageCanvasContext(p){const t=window.document.createElement("canvas"),s=t.getContext("2d",{willReadFrequently:!0});if(!s)throw new Error("failed to create canvas 2d context");return t.width=p.width,t.height=p.height,s.drawImage(p,0,0,p.width,p.height),s},resolveURL:p=>(me||(me=document.createElement("a")),me.href=p,me.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return ye!==void 0?ye:!!matchMedia&&(we==null&&(we=matchMedia("(prefers-reduced-motion: reduce)")),we.matches)},set prefersReducedMotion(p){ye=p}},Ke=new class{constructor(){this._realTime=typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),this._frozenAt=null}getCurrentTime(){return this._frozenAt!==null?this._frozenAt:this._realTime()}setNow(p){this._frozenAt=p}restoreNow(){this._frozenAt=null}isFrozen(){return this._frozenAt!==null}};function ot(){return Ke.getCurrentTime()}class ge{static testProp(t){if(!ge.docStyle)return t[0];for(let s=0;s<t.length;s++)if(t[s]in ge.docStyle)return t[s];return t[0]}static create(t,s,o){const u=window.document.createElement(t);return s!==void 0&&(u.className=s),o&&o.appendChild(u),u}static createNS(t,s){return window.document.createElementNS(t,s)}static disableDrag(){ge.docStyle&&ge.selectProp&&(ge.userSelect=ge.docStyle[ge.selectProp],ge.docStyle[ge.selectProp]="none")}static enableDrag(){ge.docStyle&&ge.selectProp&&(ge.docStyle[ge.selectProp]=ge.userSelect)}static setTransform(t,s){t.style[ge.transformProp]=s}static addEventListener(t,s,o,u={}){t.addEventListener(s,o,"passive"in u?u:u.capture)}static removeEventListener(t,s,o,u={}){t.removeEventListener(s,o,"passive"in u?u:u.capture)}static suppressClickInternal(t){t.preventDefault(),t.stopPropagation(),window.removeEventListener("click",ge.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",ge.suppressClickInternal,!0),window.setTimeout((()=>{window.removeEventListener("click",ge.suppressClickInternal,!0)}),0)}static getScale(t){const s=t.getBoundingClientRect();return{x:s.width/t.offsetWidth||1,y:s.height/t.offsetHeight||1,boundingClientRect:s}}static getPoint(t,s,o){const u=s.boundingClientRect;return new l.P((o.clientX-u.left)/s.x-t.clientLeft,(o.clientY-u.top)/s.y-t.clientTop)}static mousePos(t,s){const o=ge.getScale(t);return ge.getPoint(t,o,s)}static touchPos(t,s){const o=[],u=ge.getScale(t);for(let f=0;f<s.length;f++)o.push(ge.getPoint(t,u,s[f]));return o}static mouseButton(t){return t.button}static remove(t){t.parentNode&&t.parentNode.removeChild(t)}static sanitize(t){const s=new DOMParser().parseFromString(t,"text/html").body||document.createElement("body"),o=s.querySelectorAll("script");for(const u of o)u.remove();return ge.clean(s),s.innerHTML}static isPossiblyDangerous(t,s){const o=s.replace(/\s+/g,"").toLowerCase();return!(!["src","href","xlink:href"].includes(t)||!o.includes("javascript:")&&!o.includes("data:"))||!!t.startsWith("on")||void 0}static clean(t){const s=t.children;for(const o of s)ge.removeAttributes(o),ge.clean(o)}static removeAttributes(t){for(const{name:s,value:o}of t.attributes)ge.isPossiblyDangerous(s,o)&&t.removeAttribute(s)}}ge.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,ge.selectProp=ge.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),ge.transformProp=ge.testProp(["transform","WebkitTransform"]);const Pt={supported:!1,testSupport:function(p){!Qt&&At&&(Fe?st(p):xt=p)}};let xt,At,Qt=!1,Fe=!1;function st(p){const t=p.createTexture();p.bindTexture(p.TEXTURE_2D,t);try{if(p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,At),p.isContextLost())return;Pt.supported=!0}catch{}p.deleteTexture(t),Qt=!0}var Ye;typeof document<"u"&&(At=document.createElement("img"),At.onload=()=>{xt&&st(xt),xt=null,Fe=!0},At.onerror=()=>{Qt=!0,xt=null},At.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),(function(p){let t,s,o,u;p.resetRequestQueue=()=>{t=[],s=0,o=0,u={}},p.addThrottleControl=T=>{const M=o++;return u[M]=T,M},p.removeThrottleControl=T=>{delete u[T],_()},p.getImage=(T,M,A=!0)=>new Promise(((R,z)=>{Pt.supported&&(T.headers||(T.headers={}),T.headers.accept="image/webp,*/*"),l.e(T,{type:"image"}),t.push({abortController:M,requestParameters:T,supportImageRefresh:A,state:"queued",onError:O=>{z(O)},onSuccess:O=>{R(O)}}),_()}));const f=T=>l._(this,void 0,void 0,(function*(){T.state="running";const{requestParameters:M,supportImageRefresh:A,onError:R,onSuccess:z,abortController:O}=T,V=A===!1&&!l.i(self)&&!l.g(M.url)&&(!M.headers||Object.keys(M.headers).reduce(((X,te)=>X&&te==="accept"),!0));s++;const W=V?b(M,O):l.m(M,O);try{const X=yield W;delete T.abortController,T.state="completed",X.data instanceof HTMLImageElement||l.b(X.data)?z(X):X.data&&z({data:yield(Y=X.data,typeof createImageBitmap=="function"?l.f(Y):l.h(Y)),cacheControl:X.cacheControl,expires:X.expires})}catch(X){delete T.abortController,R(X)}finally{s--,_()}var Y})),_=()=>{const T=(()=>{for(const M of Object.keys(u))if(u[M]())return!0;return!1})()?l.c.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:l.c.MAX_PARALLEL_IMAGE_REQUESTS;for(let M=s;M<T&&t.length>0;M++){const A=t.shift();A.abortController.signal.aborted?M--:f(A)}},b=(T,M)=>new Promise(((A,R)=>{const z=new Image,O=T.url,V=T.credentials;V&&V==="include"?z.crossOrigin="use-credentials":(V&&V==="same-origin"||!l.d(O))&&(z.crossOrigin="anonymous"),M.signal.addEventListener("abort",(()=>{z.src="",R(new l.a(M.signal.reason))})),z.fetchPriority="high",z.onload=()=>{z.onerror=z.onload=null,A({data:z})},z.onerror=()=>{z.onerror=z.onload=null,M.signal.aborted||R(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},z.src=O}))})(Ye||(Ye={})),Ye.resetRequestQueue();class He{constructor(t){this._transformRequestFn=t??null}transformRequest(t,s){return this._transformRequestFn&&this._transformRequestFn(t,s)||{url:t}}setTransformRequest(t){this._transformRequestFn=t}}function Ge(p){const t=[];if(typeof p=="string")t.push({id:"default",url:p});else if(p&&p.length>0){const s=[];for(const{id:o,url:u}of p){const f=`${o}${u}`;s.indexOf(f)===-1&&(s.push(f),t.push({id:o,url:u}))}}return t}function pt(p,t,s){try{const o=new URL(p);return o.pathname+=`${t}${s}`,o.toString()}catch{throw new Error(`Invalid sprite URL "${p}", must be absolute. Modify style specification directly or use TransformStyleFunction to correct the issue dynamically`)}}function vt(p){const{userImage:t}=p;return!!(t&&t.render&&t.render())&&(p.data.replace(new Uint8Array(t.data.buffer)),!0)}class Qe extends l.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new l.R({width:1,height:1}),this.dirty=!0}destroy(){this.atlasTexture&&(this.atlasTexture.destroy(),this.atlasTexture=null);for(const t of Object.keys(this.images))this.removeImage(t);this.patterns={},this.atlasImage=new l.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(t){if(this.loaded!==t&&(this.loaded=t,t)){for(const{ids:s,promiseResolve:o}of this.requestors)o(this._getImagesForIds(s));this.requestors=[]}}getImage(t){const s=this.images[t];if(s&&!s.data&&s.spriteData){const o=s.spriteData;s.data=new l.R({width:o.width,height:o.height},o.context.getImageData(o.x,o.y,o.width,o.height).data),s.spriteData=null}return s}addImage(t,s){if(this.images[t])throw new Error(`Image id ${t} already exist, use updateImage instead`);this._validate(t,s)&&(this.images[t]=s)}_validate(t,s){let o=!0;const u=s.data||s.spriteData;return this._validateStretch(s.stretchX,u&&u.width)||(this.fire(new l.k(new Error(`Image "${t}" has invalid "stretchX" value`))),o=!1),this._validateStretch(s.stretchY,u&&u.height)||(this.fire(new l.k(new Error(`Image "${t}" has invalid "stretchY" value`))),o=!1),this._validateContent(s.content,s)||(this.fire(new l.k(new Error(`Image "${t}" has invalid "content" value`))),o=!1),o}_validateStretch(t,s){if(!t)return!0;let o=0;for(const u of t){if(u[0]<o||u[1]<u[0]||s<u[1])return!1;o=u[1]}return!0}_validateContent(t,s){if(!t)return!0;if(t.length!==4)return!1;const o=s.spriteData,u=o&&o.width||s.data.width,f=o&&o.height||s.data.height;return!(t[0]<0||u<t[0]||t[1]<0||f<t[1]||t[2]<0||u<t[2]||t[3]<0||f<t[3]||t[2]<t[0]||t[3]<t[1])}updateImage(t,s,o=!0){const u=this.getImage(t);if(o&&(u.data.width!==s.data.width||u.data.height!==s.data.height))throw new Error(`size mismatch between old image (${u.data.width}x${u.data.height}) and new image (${s.data.width}x${s.data.height}).`);s.version=u.version+1,this.images[t]=s,this.updatedImages[t]=!0}removeImage(t){const s=this.images[t];delete this.images[t],delete this.patterns[t],s.userImage&&s.userImage.onRemove&&s.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(t){return new Promise(((s,o)=>{let u=!0;if(!this.isLoaded())for(const f of t)this.images[f]||(u=!1);this.isLoaded()||u?s(this._getImagesForIds(t)):this.requestors.push({ids:t,promiseResolve:s})}))}_getImagesForIds(t){const s={};for(const o of t){let u=this.getImage(o);u||(this.fire(new l.l("styleimagemissing",{id:o})),u=this.getImage(o)),u?s[o]={data:u.data.clone(),pixelRatio:u.pixelRatio,sdf:u.sdf,version:u.version,stretchX:u.stretchX,stretchY:u.stretchY,content:u.content,textFitWidth:u.textFitWidth,textFitHeight:u.textFitHeight,hasRenderCallback:!!(u.userImage&&u.userImage.render)}:l.w(`Image "${o}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return s}getPixelSize(){const{width:t,height:s}=this.atlasImage;return{width:t,height:s}}getPattern(t){const s=this.patterns[t],o=this.getImage(t);if(!o)return null;if(s&&s.position.version===o.version)return s.position;if(s)s.position.version=o.version;else{const u={w:o.data.width+2,h:o.data.height+2,x:0,y:0},f=new l.I(u,o);this.patterns[t]={bin:u,position:f}}return this._updatePatternAtlas(),this.patterns[t].position}bind(t){const s=t.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new l.T(t,this.atlasImage,s.RGBA),this.atlasTexture.bind(s.LINEAR,s.CLAMP_TO_EDGE)}_updatePatternAtlas(){const t=[];for(const f in this.patterns)t.push(this.patterns[f].bin);const{w:s,h:o}=l.p(t),u=this.atlasImage;u.resize({width:s||1,height:o||1});for(const f in this.patterns){const{bin:_}=this.patterns[f],b=_.x+1,T=_.y+1,M=this.getImage(f).data,A=M.width,R=M.height;l.R.copy(M,u,{x:0,y:0},{x:b,y:T},{width:A,height:R}),l.R.copy(M,u,{x:0,y:R-1},{x:b,y:T-1},{width:A,height:1}),l.R.copy(M,u,{x:0,y:0},{x:b,y:T+R},{width:A,height:1}),l.R.copy(M,u,{x:A-1,y:0},{x:b-1,y:T},{width:1,height:R}),l.R.copy(M,u,{x:0,y:0},{x:b+A,y:T},{width:1,height:R})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(t){for(const s of t){if(this.callbackDispatchedThisFrame[s])continue;this.callbackDispatchedThisFrame[s]=!0;const o=this.getImage(s);o||l.w(`Image with ID: "${s}" was not found`),vt(o)&&this.updateImage(s,o)}}cloneImages(){const t={};for(const s in this.images){const o=this.images[s];t[s]=Object.assign(Object.assign({},o),{data:o.data?o.data.clone():null})}return t}}const Zt=1e20;function Ht(p,t,s,o,u,f,_,b,T){for(let M=t;M<t+o;M++)rt(p,s*f+M,f,u,_,b,T);for(let M=s;M<s+u;M++)rt(p,M*f+t,1,o,_,b,T)}function rt(p,t,s,o,u,f,_){f[0]=0,_[0]=-Zt,_[1]=Zt,u[0]=p[t];for(let b=1,T=0,M=0;b<o;b++){u[b]=p[t+b*s];const A=b*b;do{const R=f[T];M=(u[b]-u[R]+A-R*R)/(b-R)/2}while(M<=_[T]&&--T>-1);T++,f[T]=b,_[T]=M,_[T+1]=Zt}for(let b=0,T=0;b<o;b++){for(;_[T+1]<b;)T++;const M=f[T],A=b-M;p[t+b*s]=u[M]+A*A}}const Jt=l.v.layout_symbol["text-font"].default.join(",");class Wt{constructor(t,s,o){this.requestManager=t,this.localIdeographFontFamily=s,this.entries={},this.lang=o}setURL(t){this.url=t}getGlyphs(t){return l._(this,void 0,void 0,(function*(){const s=[];for(const f in t)for(const _ of t[f])s.push(this._getAndCacheGlyphsPromise(f,_));const o=yield Promise.all(s),u={};for(const{stack:f,id:_,glyph:b}of o)u[f]||(u[f]={}),u[f][_]=b&&{id:b.id,bitmap:b.bitmap.clone(),metrics:b.metrics};return u}))}_getAndCacheGlyphsPromise(t,s){return l._(this,void 0,void 0,(function*(){let o=this.entries[t];o||(o=this.entries[t]={glyphs:{},requests:{},ranges:{}});let u=o.glyphs[s];return u!==void 0?{stack:t,id:s,glyph:u}:!this.url||this._charUsesLocalIdeographFontFamily(s)?(u=o.glyphs[s]=this._drawGlyph(o,t,s),{stack:t,id:s,glyph:u}):yield this._downloadAndCacheRangePromise(t,s)}))}_downloadAndCacheRangePromise(t,s){return l._(this,void 0,void 0,(function*(){const o=this.entries[t],u=Math.floor(s/256);if(o.ranges[u])return{stack:t,id:s,glyph:null};if(!o.requests[u]){const f=Wt.loadGlyphRange(t,u,this.url,this.requestManager);o.requests[u]=f}try{const f=yield o.requests[u];for(const _ in f)o.glyphs[+_]=f[+_];return o.ranges[u]=!0,{stack:t,id:s,glyph:f[s]||null}}catch(f){const _=o.glyphs[s]=this._drawGlyph(o,t,s);return this._warnOnMissingGlyphRange(_,u,s,f),{stack:t,id:s,glyph:_}}}))}_warnOnMissingGlyphRange(t,s,o,u){const f=256*s,_=f+255,b=o.toString(16).padStart(4,"0").toUpperCase();l.w(`Unable to load glyph range ${s}, ${f}-${_}. Rendering codepoint U+${b} locally instead. ${u}`)}_charUsesLocalIdeographFontFamily(t){return!!this.localIdeographFontFamily&&l.q(t)}_drawGlyph(t,s,o){const u=s===Jt&&this.localIdeographFontFamily!==""&&this._charUsesLocalIdeographFontFamily(o),f=u?"ideographTinySDF":"tinySDF";t[f]||(t[f]=this._createTinySDF(u?this.localIdeographFontFamily:s));const _=t[f].draw(String.fromCodePoint(o));return{id:o,bitmap:new l.r({width:_.width||60,height:_.height||60},_.data),metrics:{width:_.glyphWidth/2||24,height:_.glyphHeight/2||24,left:_.glyphLeft/2+.5||0,top:_.glyphTop/2-27.5||-8,advance:_.glyphAdvance/2||24,isDoubleResolution:!0}}}_createTinySDF(t){const s=t?t.split(","):[];s.push("sans-serif");const o=s.map((u=>/[-\w]+/.test(u)?u:`'${CSS.escape(u)}'`)).join(",");return new Wt.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:o,fontWeight:this._fontWeight(s[0]),fontStyle:this._fontStyle(s[0]),lang:this.lang})}_fontStyle(t){return/italic/i.test(t)?"italic":/oblique/i.test(t)?"oblique":"normal"}_fontWeight(t){const s={thin:100,hairline:100,"extra light":200,"ultra light":200,light:300,normal:400,regular:400,medium:500,semibold:600,demibold:600,bold:700,"extra bold":800,"ultra bold":800,black:900,heavy:900,"extra black":950,"ultra black":950};let o;for(const[u,f]of Object.entries(s))new RegExp(`\\b${u}\\b`,"i").test(t)&&(o=`${f}`);return o}destroy(){for(const t in this.entries){const s=this.entries[t];s.tinySDF&&(s.tinySDF=null),s.ideographTinySDF&&(s.ideographTinySDF=null),s.glyphs={},s.requests={},s.ranges={}}this.entries={}}}Wt.loadGlyphRange=function(p,t,s,o){return l._(this,void 0,void 0,(function*(){const u=256*t,f=u+255,_=o.transformRequest(s.replace("{fontstack}",p).replace("{range}",`${u}-${f}`),"Glyphs"),b=yield l.n(_,new AbortController);if(!b||!b.data)throw new Error(`Could not load glyph range. range: ${t}, ${u}-${f}`);const T={};for(const M of l.o(b.data))T[M.id]=M;return T}))},Wt.TinySDF=class{constructor({fontSize:p=24,buffer:t=3,radius:s=8,cutoff:o=.25,fontFamily:u="sans-serif",fontWeight:f="normal",fontStyle:_="normal",lang:b=null}={}){this.buffer=t,this.cutoff=o,this.radius=s,this.lang=b;const T=this.size=p+4*t,M=this._createCanvas(T),A=this.ctx=M.getContext("2d",{willReadFrequently:!0});A.font=`${_} ${f} ${p}px ${u}`,A.textBaseline="alphabetic",A.textAlign="left",A.fillStyle="black",this.gridOuter=new Float64Array(T*T),this.gridInner=new Float64Array(T*T),this.f=new Float64Array(T),this.z=new Float64Array(T+1),this.v=new Uint16Array(T)}_createCanvas(p){const t=document.createElement("canvas");return t.width=t.height=p,t}draw(p){const{width:t,actualBoundingBoxAscent:s,actualBoundingBoxDescent:o,actualBoundingBoxLeft:u,actualBoundingBoxRight:f}=this.ctx.measureText(p),_=Math.ceil(s),b=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(f-u))),T=Math.min(this.size-this.buffer,_+Math.ceil(o)),M=b+2*this.buffer,A=T+2*this.buffer,R=Math.max(M*A,0),z=new Uint8ClampedArray(R),O={data:z,width:M,height:A,glyphWidth:b,glyphHeight:T,glyphTop:_,glyphLeft:0,glyphAdvance:t};if(b===0||T===0)return O;const{ctx:V,buffer:W,gridInner:Y,gridOuter:X}=this;this.lang&&(V.lang=this.lang),V.clearRect(W,W,b,T),V.fillText(p,W,W+_);const te=V.getImageData(W,W,b,T);X.fill(Zt,0,R),Y.fill(0,0,R);for(let le=0;le<T;le++)for(let Q=0;Q<b;Q++){const ne=te.data[4*(le*b+Q)+3]/255;if(ne===0)continue;const ue=(le+W)*M+Q+W;if(ne===1)X[ue]=0,Y[ue]=Zt;else{const ie=.5-ne;X[ue]=ie>0?ie*ie:0,Y[ue]=ie<0?ie*ie:0}}Ht(X,0,0,M,A,M,this.f,this.v,this.z),Ht(Y,W,W,b,T,M,this.f,this.v,this.z);for(let le=0;le<R;le++){const Q=Math.sqrt(X[le])-Math.sqrt(Y[le]);z[le]=Math.round(255-255*(Q/this.radius+this.cutoff))}return O}};class Xt{constructor(){this.specification=l.u.light.position}possiblyEvaluate(t,s){return l.F(t.expression.evaluate(s))}interpolate(t,s,o){return{x:l.G.number(t.x,s.x,o),y:l.G.number(t.y,s.y,o),z:l.G.number(t.z,s.z,o)}}}let Ct;class Kt extends l.E{constructor(t){super(),Ct=Ct||new l.t({anchor:new l.D(l.u.light.anchor),position:new Xt,color:new l.D(l.u.light.color),intensity:new l.D(l.u.light.intensity)}),this._transitionable=new l.x(Ct,void 0),this.setLight(t),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,s={}){if(!this._validate(l.y,t,s))for(const o in t){const u=t[o];o.endsWith(l.z)?this._transitionable.setTransition(o.slice(0,-l.z.length),u):this._transitionable.setValue(o,u)}}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,s,o){return(!o||o.validate!==!1)&&l.B(this,t.call(l.C,{value:s,style:{glyphs:!0,sprite:!0},styleSpec:l.u}))}}const Nt=new l.t({"sky-color":new l.D(l.u.sky["sky-color"]),"horizon-color":new l.D(l.u.sky["horizon-color"]),"fog-color":new l.D(l.u.sky["fog-color"]),"fog-ground-blend":new l.D(l.u.sky["fog-ground-blend"]),"horizon-fog-blend":new l.D(l.u.sky["horizon-fog-blend"]),"sky-horizon-blend":new l.D(l.u.sky["sky-horizon-blend"]),"atmosphere-blend":new l.D(l.u.sky["atmosphere-blend"])});class hr extends l.E{constructor(t){super(),this._transitionable=new l.x(Nt,void 0),this.setSky(t),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new l.H(0))}setSky(t,s={}){if(!this._validate(l.J,t,s)){t||(t={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(const o in t){const u=t[o];o.endsWith(l.z)?this._transitionable.setTransition(o.slice(0,-l.z.length),u):this._transitionable.setValue(o,u)}}}getSky(){return this._transitionable.serialize()}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,s,o={}){return o?.validate!==!1&&l.B(this,t.call(l.C,l.e({value:s,style:{glyphs:!0,sprite:!0},styleSpec:l.u})))}calculateFogBlendOpacity(t){return t<60?0:t<70?(t-60)/10:1}}class us{constructor(t,s){this.width=t,this.height=s,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(t,s){const o=t.join(",")+String(s);return this.dashEntry[o]||(this.dashEntry[o]=this.addDash(t,s)),this.dashEntry[o]}getDashRanges(t,s,o){const u=[];let f=t.length%2==1?-t[t.length-1]*o:0,_=t[0]*o,b=!0;u.push({left:f,right:_,isDash:b,zeroLength:t[0]===0});let T=t[0];for(let M=1;M<t.length;M++){b=!b;const A=t[M];f=T*o,T+=A,_=T*o,u.push({left:f,right:_,isDash:b,zeroLength:A===0})}return u}addRoundDash(t,s,o){const u=s/2;for(let f=-o;f<=o;f++){const _=this.width*(this.nextRow+o+f);let b=0,T=t[b];for(let M=0;M<this.width;M++){M/T.right>1&&(T=t[++b]);const A=Math.abs(M-T.left),R=Math.abs(M-T.right),z=Math.min(A,R);let O;const V=f/o*(u+1);if(T.isDash){const W=u-Math.abs(V);O=Math.sqrt(z*z+W*W)}else O=u-Math.sqrt(z*z+V*V);this.data[_+M]=Math.max(0,Math.min(255,O+128))}}}addRegularDash(t){for(let b=t.length-1;b>=0;--b){const T=t[b],M=t[b+1];T.zeroLength?t.splice(b,1):M&&M.isDash===T.isDash&&(M.left=T.left,t.splice(b,1))}const s=t[0],o=t[t.length-1];s.isDash===o.isDash&&(s.left=o.left-this.width,o.right=s.right+this.width);const u=this.width*this.nextRow;let f=0,_=t[f];for(let b=0;b<this.width;b++){b/_.right>1&&(_=t[++f]);const T=Math.abs(b-_.left),M=Math.abs(b-_.right),A=Math.min(T,M);this.data[u+b]=Math.max(0,Math.min(255,(_.isDash?A:-A)+128))}}addDash(t,s){const o=s?7:0,u=2*o+1;if(this.nextRow+u>this.height)return l.w("LineAtlas out of space"),null;let f=0;for(let b=0;b<t.length;b++)f+=t[b];if(f!==0){const b=this.width/f,T=this.getDashRanges(t,this.width,b);s?this.addRoundDash(T,b,o):this.addRegularDash(T)}const _={y:this.nextRow+o,height:2*o,width:f};return this.nextRow+=u,this.dirty=!0,_}bind(t){const s=t.gl;this.texture?(s.bindTexture(s.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,s.texSubImage2D(s.TEXTURE_2D,0,0,0,this.width,this.height,s.ALPHA,s.UNSIGNED_BYTE,this.data))):(this.texture=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this.texture),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texImage2D(s.TEXTURE_2D,0,s.ALPHA,this.width,this.height,0,s.ALPHA,s.UNSIGNED_BYTE,this.data))}}const Os="maplibre_preloaded_worker_pool";class ci{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<ci.workerCount;)this.workers.push(new Worker(l.c.WORKER_URL));return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.numActive()===0&&(this.workers.forEach((s=>{s.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[Os]}numActive(){return Object.keys(this.active).length}}const Bi=Math.floor(ze.hardwareConcurrency/2);let ii,Sr;function Vt(){return ii||(ii=new ci),ii}ci.workerCount=l.K(globalThis)?Math.max(Math.min(Bi,3),1):1;class Lr{constructor(t,s){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=s;const o=this.workerPool.acquire(s);for(let u=0;u<o.length;u++){const f=new l.L(o[u],s);f.name=`Worker ${u}`,this.actors.push(f)}if(!this.actors.length)throw new Error("No actors found")}broadcast(t,s){const o=[];for(const u of this.actors)o.push(u.sendAsync({type:t,data:s}));return Promise.all(o)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(t=!0){this.actors.forEach((s=>{s.remove()})),this.actors=[],t&&this.workerPool.release(this.id)}registerMessageHandler(t,s){for(const o of this.actors)o.registerMessageHandler(t,s)}unregisterMessageHandler(t){for(const s of this.actors)s.unregisterMessageHandler(t)}}function cn(){return Sr||(Sr=new Lr(Vt(),l.M),Sr.registerMessageHandler("GR",((p,t,s)=>l.m(t,s)))),Sr}function Zi(p,t){const s=l.N();return l.O(s,s,[1,1,0]),l.Q(s,s,[.5*p.width,.5*p.height,1]),p.calculatePosMatrix?l.S(s,s,p.calculatePosMatrix(t.toUnwrapped())):s}function Bs(p,t,s,o,u,f,_){var b;const T=(function(z,O,V){if(z)for(const W of z){const Y=O[W];if(Y&&Y.source===V&&Y.type==="fill-extrusion")return!0}else for(const W in O){const Y=O[W];if(Y.source===V&&Y.type==="fill-extrusion")return!0}return!1})((b=u?.layers)!==null&&b!==void 0?b:null,t,p.id),M=f.maxPitchScaleFactor(),A=p.tilesIn(o,M,T);A.sort(Vr);const R=[];for(const z of A)R.push({wrappedTileID:z.tileID.wrapped().key,queryResults:z.tile.queryRenderedFeatures(t,s,p.getState(),z.queryGeometry,z.cameraQueryGeometry,z.scale,u,f,M,Zi(f,z.tileID),_?(O,V)=>_(z.tileID,O,V):void 0)});return(function(z,O){for(const V in z)for(const W of z[V])ji(W,O);return z})((function(z){const O={},V={};for(const W of z){const Y=W.queryResults,X=W.wrappedTileID,te=V[X]=V[X]||{};for(const le in Y){const Q=Y[le],ne=te[le]=te[le]||{},ue=O[le]=O[le]||[];for(const ie of Q)ne[ie.featureIndex]||(ne[ie.featureIndex]=!0,ue.push(ie))}}return O})(R),p)}function Vr(p,t){const s=p.tileID,o=t.tileID;return s.overscaledZ-o.overscaledZ||s.canonical.y-o.canonical.y||s.wrap-o.wrap||s.canonical.x-o.canonical.x}function ji(p,t){const s=p.feature,o=t.getFeatureState(s.layer["source-layer"],s.id);s.source=s.layer.source,s.layer["source-layer"]&&(s.sourceLayer=s.layer["source-layer"]),s.state=o}function Ni(p,t,s){return l._(this,void 0,void 0,(function*(){let o=p;if(p.url?o=(yield l.j(t.transformRequest(p.url,"Source"),s)).data:yield ze.frameAsync(s),!o)return null;const u=l.U(l.e(o,p),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in o&&o.vector_layers&&(u.vectorLayerIds=o.vector_layers.map((f=>f.id))),u}))}class Mr{constructor(t,s){t&&(s?this.setSouthWest(t).setNorthEast(s):Array.isArray(t)&&(t.length===4?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1])))}setNorthEast(t){return this._ne=t instanceof l.V?new l.V(t.lng,t.lat):l.V.convert(t),this}setSouthWest(t){return this._sw=t instanceof l.V?new l.V(t.lng,t.lat):l.V.convert(t),this}extend(t){const s=this._sw,o=this._ne;let u,f;if(t instanceof l.V)u=t,f=t;else{if(!(t instanceof Mr))return Array.isArray(t)?t.length===4||t.every(Array.isArray)?this.extend(Mr.convert(t)):this.extend(l.V.convert(t)):t&&("lng"in t||"lon"in t)&&"lat"in t?this.extend(l.V.convert(t)):this;if(u=t._sw,f=t._ne,!u||!f)return this}return s||o?(s.lng=Math.min(u.lng,s.lng),s.lat=Math.min(u.lat,s.lat),o.lng=Math.max(f.lng,o.lng),o.lat=Math.max(f.lat,o.lat)):(this._sw=new l.V(u.lng,u.lat),this._ne=new l.V(f.lng,f.lat)),this}getCenter(){return new l.V((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new l.V(this.getWest(),this.getNorth())}getSouthEast(){return new l.V(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:s,lat:o}=l.V.convert(t);let u=this._sw.lng<=s&&s<=this._ne.lng;return this._sw.lng>this._ne.lng&&(u=this._sw.lng>=s&&s>=this._ne.lng),this._sw.lat<=o&&o<=this._ne.lat&&u}intersects(t){if(!((t=Mr.convert(t)).getNorth()>=this.getSouth()&&t.getSouth()<=this.getNorth()))return!1;const s=Math.abs(this.getEast()-this.getWest()),o=Math.abs(t.getEast()-t.getWest());if(s>=360||o>=360)return!0;const u=l.W(this.getWest(),-180,180),f=l.W(this.getEast(),-180,180),_=l.W(t.getWest(),-180,180),b=l.W(t.getEast(),-180,180),T=u>=f,M=_>=b;return!(!T||!M)||(T?b>=u||_<=f:M?f>=_||u<=b:_<=f&&b>=u)}static convert(t){return t instanceof Mr?t:t&&new Mr(t)}static fromLngLat(t,s=0){const o=360*s/40075017,u=o/Math.cos(Math.PI/180*t.lat);return new Mr(new l.V(t.lng-u,t.lat-o),new l.V(t.lng+u,t.lat+o))}adjustAntiMeridian(){const t=new l.V(this._sw.lng,this._sw.lat),s=new l.V(this._ne.lng,this._ne.lat);return new Mr(t,t.lng>s.lng?new l.V(s.lng+360,s.lat):s)}}class js{constructor(t,s,o){this.bounds=Mr.convert(this.validateBounds(t)),this.minzoom=s||0,this.maxzoom=o||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const s=Math.pow(2,t.z),o=Math.floor(l.Y(this.bounds.getWest())*s),u=Math.floor(l.X(this.bounds.getNorth())*s),f=Math.ceil(l.Y(this.bounds.getEast())*s),_=Math.ceil(l.X(this.bounds.getSouth())*s);return t.x>=o&&t.x<f&&t.y>=u&&t.y<_}}class Ws extends l.E{constructor(t,s,o,u){if(super(),this.id=t,this.dispatcher=o,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,l.e(this,l.U(s,["url","scheme","tileSize","promoteId","encoding"])),this._options=l.e({type:"vector"},s),this._collectResourceTiming=s.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(u)}load(){return l._(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new l.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const t=yield Ni(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.tileManagers[this.id].clearTiles(),t&&(l.e(this,t),t.bounds&&(this.tileBounds=new js(t.bounds,this.minzoom,this.maxzoom)),this.fire(new l.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.l("data",{dataType:"source",sourceDataType:"content"})))}catch(t){this._tileJSONRequest=null,this._loaded=!0,l.Z(t)||this.fire(new l.k(t))}}))}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}setSourceProperty(t){this._tileJSONRequest&&this._tileJSONRequest.abort(),t(),this.load()}setTiles(t){return this.setSourceProperty((()=>{this._options.tiles=t})),this}setUrl(t){return this.setSourceProperty((()=>{this.url=t,this._options.url=t})),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return l.e({},this._options)}loadTile(t){return l._(this,void 0,void 0,(function*(){const s=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),o={request:this.map._requestManager.transformRequest(s,"Tile"),uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity,encoding:this.encoding,overzoomParameters:this._getOverzoomParameters(t)};o.request.collectResourceTiming=this._collectResourceTiming;let u="RT";if(t.actor&&t.state!=="expired"){if(t.state==="loading")return new Promise(((f,_)=>{t.reloadPromise={resolve:f,reject:_}}))}else t.actor=this.dispatcher.getActor(),u="LT";t.abortController=new AbortController;try{const f=yield t.actor.sendAsync({type:u,data:o},t.abortController);if(delete t.abortController,t.aborted)return;this._afterTileLoadWorkerResponse(t,f)}catch(f){if(delete t.abortController,t.aborted)return;if(f&&f.status!==404)throw f;this._afterTileLoadWorkerResponse(t,null)}}))}_getOverzoomParameters(t){if(t.tileID.canonical.z<=this.maxzoom||this.map._zoomLevelsToOverscale===void 0)return;const s=t.tileID.scaledTo(this.maxzoom).canonical,o=s.url(this.tiles,this.map.getPixelRatio(),this.scheme);return{maxZoomTileID:s,overzoomRequest:this.map._requestManager.transformRequest(o,"Tile")}}_afterTileLoadWorkerResponse(t,s){if(s&&s.resourceTiming&&(t.resourceTiming=s.resourceTiming),s&&this.map._refreshExpiredTiles&&t.setExpiryData(s),t.loadVectorData(s,this.map.painter),t.reloadPromise){const o=t.reloadPromise;t.reloadPromise=null,this.loadTile(t).then(o.resolve).catch(o.reject)}}abortTile(t){return l._(this,void 0,void 0,(function*(){t.abortController&&(t.abortController.abort(),delete t.abortController),t.actor&&(yield t.actor.sendAsync({type:"AT",data:{uid:t.uid,type:this.type,source:this.id}}))}))}unloadTile(t){return l._(this,void 0,void 0,(function*(){t.unloadVectorData(),t.actor&&(yield t.actor.sendAsync({type:"RMT",data:{uid:t.uid,type:this.type,source:this.id}}))}))}hasTransition(){return!1}}class un extends l.E{constructor(t,s,o,u){super(),this.id=t,this.dispatcher=o,this.setEventedParent(u),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=l.e({type:"raster"},s),l.e(this,l.U(s,["url","scheme","tileSize"]))}load(){return l._(this,arguments,void 0,(function*(t=!1){this._loaded=!1,this.fire(new l.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const s=yield Ni(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,s&&(l.e(this,s),s.bounds&&(this.tileBounds=new js(s.bounds,this.minzoom,this.maxzoom)),this.fire(new l.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new l.l("data",{dataType:"source",sourceDataType:"content",sourceDataChanged:t})))}catch(s){this._tileJSONRequest=null,this._loaded=!0,l.Z(s)||this.fire(new l.k(s))}}))}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(t){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),t(),this.load(!0)}setTiles(t){return this.setSourceProperty((()=>{this._options.tiles=t})),this}setUrl(t){return this.setSourceProperty((()=>{this.url=t,this._options.url=t})),this}serialize(){return l.e({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t){return l._(this,void 0,void 0,(function*(){const s=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);t.abortController=new AbortController;try{const o=yield Ye.getImage(this.map._requestManager.transformRequest(s,"Tile"),t.abortController,this.map._refreshExpiredTiles);if(delete t.abortController,t.aborted)return void(t.state="unloaded");if(o&&o.data){this.map._refreshExpiredTiles&&(o.cacheControl||o.expires)&&t.setExpiryData({cacheControl:o.cacheControl,expires:o.expires});const u=this.map.painter.context,f=u.gl,_=o.data;t.texture=this.map.painter.getTileTexture(_.width),t.texture?t.texture.update(_,{useMipmap:!0}):(t.texture=new l.T(u,_,f.RGBA,{useMipmap:!0}),t.texture.bind(f.LINEAR,f.CLAMP_TO_EDGE,f.LINEAR_MIPMAP_NEAREST)),t.state="loaded"}}catch(o){if(delete t.abortController,t.aborted)t.state="unloaded";else if(o)throw t.state="errored",o}}))}abortTile(t){return l._(this,void 0,void 0,(function*(){t.abortController&&(t.abortController.abort(),delete t.abortController)}))}unloadTile(t){return l._(this,void 0,void 0,(function*(){t.texture&&this.map.painter.saveTileTexture(t.texture)}))}hasTransition(){return!1}}class Hi extends un{constructor(t,s,o,u){super(t,s,o,u),this.type="raster-dem",this.maxzoom=22,this._options=l.e({type:"raster-dem"},s),this.encoding=s.encoding||"mapbox",this.redFactor=s.redFactor,this.greenFactor=s.greenFactor,this.blueFactor=s.blueFactor,this.baseShift=s.baseShift}loadTile(t){return l._(this,void 0,void 0,(function*(){const s=t.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),o=this.map._requestManager.transformRequest(s,"Tile");t.neighboringTiles=this._getNeighboringTiles(t.tileID),t.abortController=new AbortController;try{const u=yield Ye.getImage(o,t.abortController,this.map._refreshExpiredTiles);if(delete t.abortController,t.aborted)return void(t.state="unloaded");if(u&&u.data){const f=u.data;this.map._refreshExpiredTiles&&(u.cacheControl||u.expires)&&t.setExpiryData({cacheControl:u.cacheControl,expires:u.expires});const _=l.b(f)&&l.$()?f:yield this.readImageNow(f),b={type:this.type,uid:t.uid,source:this.id,rawImageData:_,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!t.actor||t.state==="expired"){t.actor=this.dispatcher.getActor();const T=yield t.actor.sendAsync({type:"LDT",data:b});t.dem=T,t.needsHillshadePrepare=!0,t.needsTerrainPrepare=!0,t.state="loaded"}}}catch(u){if(delete t.abortController,t.aborted)t.state="unloaded";else if(u)throw t.state="errored",u}}))}readImageNow(t){return l._(this,void 0,void 0,(function*(){if(typeof VideoFrame<"u"&&l.a0()){const s=t.width+2,o=t.height+2;try{return new l.R({width:s,height:o},yield l.a1(t,-1,-1,s,o))}catch{}}return ze.getImageData(t,1)}))}_getNeighboringTiles(t){const s=t.canonical,o=Math.pow(2,s.z),u=(s.x-1+o)%o,f=s.x===0?t.wrap-1:t.wrap,_=(s.x+1+o)%o,b=s.x+1===o?t.wrap+1:t.wrap,T={};return T[new l.a2(t.overscaledZ,f,s.z,u,s.y).key]={backfilled:!1},T[new l.a2(t.overscaledZ,b,s.z,_,s.y).key]={backfilled:!1},s.y>0&&(T[new l.a2(t.overscaledZ,f,s.z,u,s.y-1).key]={backfilled:!1},T[new l.a2(t.overscaledZ,t.wrap,s.z,s.x,s.y-1).key]={backfilled:!1},T[new l.a2(t.overscaledZ,b,s.z,_,s.y-1).key]={backfilled:!1}),s.y+1<o&&(T[new l.a2(t.overscaledZ,f,s.z,u,s.y+1).key]={backfilled:!1},T[new l.a2(t.overscaledZ,t.wrap,s.z,s.x,s.y+1).key]={backfilled:!1},T[new l.a2(t.overscaledZ,b,s.z,_,s.y+1).key]={backfilled:!1}),T}unloadTile(t){return l._(this,void 0,void 0,(function*(){t.demTexture&&this.map.painter.saveTileTexture(t.demTexture),t.fbo&&(t.fbo.destroy(),delete t.fbo),t.dem&&delete t.dem,delete t.neighboringTiles,t.state="unloaded",t.actor&&(yield t.actor.sendAsync({type:"RDT",data:{type:this.type,uid:t.uid,source:this.id}}))}))}}function Wi(p){return p.type==="GeometryCollection"?p.geometries.map((t=>t.coordinates)).flat(1/0):p.coordinates.flat(1/0)}function _s(p){const t=new Mr;let s;switch(p.type){case"FeatureCollection":s=p.features.map((o=>Wi(o.geometry))).flat(1/0);break;case"Feature":s=Wi(p.geometry);break;default:s=Wi(p)}if(s.length==0)return t;for(let o=0;o<s.length-1;o+=2)t.extend([s[o],s[o+1]]);return t}class Ti extends l.E{constructor(t,s,o,u){super(),this.id=t,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._isUpdatingWorker=!1,this._pendingWorkerUpdate={data:s.data},this.actor=o.getActor(),this.setEventedParent(u),this._data=typeof s.data=="string"?{url:s.data}:{geojson:s.data},this._options=l.e({},s),this._collectResourceTiming=s.collectResourceTiming,s.maxzoom!==void 0&&(this.maxzoom=s.maxzoom),s.type&&(this.type=s.type),s.attribution&&(this.attribution=s.attribution),this.promoteId=s.promoteId,s.clusterMaxZoom!==void 0&&this.maxzoom<=s.clusterMaxZoom&&l.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${s.clusterMaxZoom}".`),this.workerOptions=l.e({source:this.id,cluster:s.cluster||!1,geojsonVtOptions:{buffer:this._pixelsToTileUnits(s.buffer!==void 0?s.buffer:128),tolerance:this._pixelsToTileUnits(s.tolerance!==void 0?s.tolerance:.375),extent:l.a5,maxZoom:this.maxzoom,lineMetrics:s.lineMetrics||!1,generateId:s.generateId||!1},superclusterOptions:{maxZoom:this._getClusterMaxZoom(s.clusterMaxZoom),minPoints:Math.max(2,s.clusterMinPoints||2),extent:l.a5,radius:this._pixelsToTileUnits(s.clusterRadius||50),log:!1,generateId:s.generateId||!1},clusterProperties:s.clusterProperties,filter:s.filter},s.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}_hasPendingWorkerUpdate(){return this._pendingWorkerUpdate.data!==void 0||this._pendingWorkerUpdate.diff!==void 0||this._pendingWorkerUpdate.optionsChanged}_pixelsToTileUnits(t){return t*(l.a5/this.tileSize)}_getClusterMaxZoom(t){const s=t?Math.round(t):this.maxzoom-1;return Number.isInteger(t)||t===void 0||l.w(`Integer expected for option 'clusterMaxZoom': provided value "${t}" rounded to "${s}"`),s}load(){return l._(this,void 0,void 0,(function*(){yield this._updateWorkerData()}))}onAdd(t){this.map=t,this.load()}setData(t,s){this._data=typeof t=="string"?{url:t}:{geojson:t},this._pendingWorkerUpdate={data:t};const o=this._updateWorkerData();return s?o:this}updateData(t,s){this._pendingWorkerUpdate.diff=l.a6(this._pendingWorkerUpdate.diff,t);const o=this._updateWorkerData();return s?o:this}getData(){return l._(this,void 0,void 0,(function*(){const t=l.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:t})}))}getBounds(){return l._(this,void 0,void 0,(function*(){return _s(yield this.getData())}))}setClusterOptions(t){return this.workerOptions.cluster=t.cluster,t.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=this._pixelsToTileUnits(t.clusterRadius)),t.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=this._getClusterMaxZoom(t.clusterMaxZoom)),this._pendingWorkerUpdate.optionsChanged=!0,this._updateWorkerData(),this}getClusterExpansionZoom(t){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:t,source:this.id}})}getClusterChildren(t){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:t,source:this.id}})}getClusterLeaves(t,s,o){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:t,limit:s,offset:o}})}_updateWorkerData(){return l._(this,void 0,void 0,(function*(){if(this._isUpdatingWorker)return;if(!this._hasPendingWorkerUpdate())return void l.w(`No pending worker updates for GeoJSONSource ${this.id}.`);const{data:t,diff:s}=this._pendingWorkerUpdate,o=l.e({type:this.type},this.workerOptions);t!==void 0?(typeof t=="string"?(o.request=this.map._requestManager.transformRequest(ze.resolveURL(t),"Source"),o.request.collectResourceTiming=this._collectResourceTiming):o.data=t,this._pendingWorkerUpdate.data=void 0):s&&(o.dataDiff=s,this._pendingWorkerUpdate.diff=void 0),this._pendingWorkerUpdate.optionsChanged=void 0,this._isUpdatingWorker=!0,this.fire(new l.l("dataloading",{dataType:"source"}));try{const u=yield this.actor.sendAsync({type:"LD",data:o});if(this._isUpdatingWorker=!1,this._removed||u.abandoned)return void this.fire(new l.l("dataabort",{dataType:"source"}));u.data&&(this._data={geojson:u.data});const f=this._applyDiffToSource(s),_=this._getShouldReloadTileOptions(f);let b=null;u.resourceTiming&&u.resourceTiming[this.id]&&(b=u.resourceTiming[this.id].slice(0));const T={dataType:"source"};this._collectResourceTiming&&b&&b.length>0&&l.e(T,{resourceTiming:b}),this.fire(new l.l("data",Object.assign(Object.assign({},T),{sourceDataType:"metadata"}))),this.fire(new l.l("data",Object.assign(Object.assign({},T),{sourceDataType:"content",shouldReloadTileOptions:_})))}catch(u){if(this._isUpdatingWorker=!1,this._removed)return void this.fire(new l.l("dataabort",{dataType:"source"}));this.fire(new l.k(u))}finally{this._hasPendingWorkerUpdate()&&this._updateWorkerData()}}))}_applyDiffToSource(t){if(!t)return;const s=typeof this.promoteId=="string"?this.promoteId:void 0;if(!this._data.url&&!this._data.updateable){const u=l.a7(this._data.geojson,s);if(!u)throw new Error(`GeoJSONSource "${this.id}": GeoJSON data is not compatible with updateData`);this._data={updateable:u}}if(!this._data.updateable)return;const o=l.a8(this._data.updateable,t,s);return t.removeAll||this._options.cluster?void 0:o}_getShouldReloadTileOptions(t){if(t)return{affectedBounds:t.filter(Boolean).map((s=>_s(s)))}}shouldReloadTile(t,{affectedBounds:s}){if(t.state==="loading")return!0;if(t.state==="unloaded")return!1;const{buffer:o,extent:u}=this.workerOptions.geojsonVtOptions,f=(function({x:_,y:b,z:T},M=0){const A=l.a3((_-M)/Math.pow(2,T)),R=l.a4((b+1+M)/Math.pow(2,T)),z=l.a3((_+1+M)/Math.pow(2,T)),O=l.a4((b-M)/Math.pow(2,T));return new Mr([A,R],[z,O])})(t.tileID.canonical,o/u);for(const _ of s)if(f.intersects(_))return!0;return!1}loaded(){return!this._isUpdatingWorker&&!this._hasPendingWorkerUpdate()}loadTile(t){return l._(this,void 0,void 0,(function*(){const s=t.actor?"RT":"LT";t.actor=this.actor;const o={type:this.type,uid:t.uid,tileID:t.tileID,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};t.abortController=new AbortController;const u=yield this.actor.sendAsync({type:s,data:o},t.abortController);delete t.abortController,t.unloadVectorData(),t.aborted||t.loadVectorData(u,this.map.painter,s==="RT")}))}abortTile(t){return l._(this,void 0,void 0,(function*(){t.abortController&&(t.abortController.abort(),delete t.abortController),t.aborted=!0}))}unloadTile(t){return l._(this,void 0,void 0,(function*(){t.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:t.uid,type:this.type,source:this.id}})}))}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return l.e({},this._options,{type:this.type,data:this._data.updateable?{type:"FeatureCollection",features:Array.from(this._data.updateable.values())}:this._data.url||this._data.geojson})}hasTransition(){return!1}}class Ai extends l.E{constructor(t,s,o,u){super(),this.flippedWindingOrder=!1,this.id=t,this.dispatcher=o,this.coordinates=s.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(u),this.options=s}load(t){return l._(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new l.l("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const s=yield Ye.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,s&&s.data&&(this.image=s.data,t&&(this.coordinates=t),this._finishLoading())}catch(s){this._request=null,this._loaded=!0,l.Z(s)||this.fire(new l.k(s))}}))}loaded(){return this._loaded}updateImage(t){return t.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=t.url,this.load(t.coordinates).finally((()=>{this.texture=null})),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new l.l("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(t){this.coordinates=t;const s=t.map(l.a9.fromLngLat);var o;return this.tileID=(function(u){const f=l.aa.fromPoints(u),_=f.width(),b=f.height(),T=Math.max(_,b),M=Math.max(0,Math.floor(-Math.log(T)/Math.LN2)),A=Math.pow(2,M);return new l.ac(M,Math.floor((f.minX+f.maxX)/2*A),Math.floor((f.minY+f.maxY)/2*A))})(s),this.terrainTileRanges=this._getOverlappingTileRanges(s),this.minzoom=this.maxzoom=this.tileID.z,this.tileCoords=s.map((u=>this.tileID.getTilePoint(u)._round())),this.flippedWindingOrder=((o=this.tileCoords)[1].x-o[0].x)*(o[2].y-o[0].y)-(o[1].y-o[0].y)*(o[2].x-o[0].x)<0,this.fire(new l.l("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const t=this.map.painter.context,s=t.gl;this.texture||(this.texture=new l.T(t,this.image,s.RGBA),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE));let o=!1;for(const u in this.tiles){const f=this.tiles[u];f.state!=="loaded"&&(f.state="loaded",f.texture=this.texture,o=!0)}o&&this.fire(new l.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(t){return l._(this,void 0,void 0,(function*(){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={}):t.state="errored"}))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}_getOverlappingTileRanges(t){const{minX:s,minY:o,maxX:u,maxY:f}=l.aa.fromPoints(t),_={};for(let b=0;b<=l.ab;b++){const T=Math.pow(2,b),M=Math.floor(s*T),A=Math.floor(o*T),R=Math.floor(u*T),z=Math.floor(f*T);_[b]={minTileX:M,minTileY:A,maxTileX:R,maxTileY:z}}return _}}class ve extends Ai{constructor(t,s,o,u){super(t,s,o,u),this.roundZoom=!0,this.type="video",this.options=s}load(){return l._(this,void 0,void 0,(function*(){this._loaded=!1;const t=this.options;this.urls=[];for(const s of t.urls)this.urls.push(this.map._requestManager.transformRequest(s,"Source").url);try{const s=yield l.ad(this.urls);if(this._loaded=!0,!s)return;this.video=s,this.video.loop=!0,this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading()}catch(s){this.fire(new l.k(s))}}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(t){if(this.video){const s=this.video.seekable;t<s.start(0)||t>s.end(0)?this.fire(new l.k(new l.ae(`sources.${this.id}`,null,`Playback for this video can be set only between the ${s.start(0)} and ${s.end(0)}-second mark.`))):this.video.currentTime=t}}getVideo(){return this.video}onAdd(t){this.map||(this.map=t,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const t=this.map.painter.context,s=t.gl;this.texture?this.video.paused||(this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE),s.texSubImage2D(s.TEXTURE_2D,0,0,0,s.RGBA,s.UNSIGNED_BYTE,this.video)):(this.texture=new l.T(t,this.video,s.RGBA),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE));let o=!1;for(const u in this.tiles){const f=this.tiles[u];f.state!=="loaded"&&(f.state="loaded",f.texture=this.texture,o=!0)}o&&this.fire(new l.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class N extends Ai{constructor(t,s,o,u){super(t,s,o,u),s.coordinates?Array.isArray(s.coordinates)&&s.coordinates.length===4&&!s.coordinates.some((f=>!Array.isArray(f)||f.length!==2||f.some((_=>typeof _!="number"))))||this.fire(new l.k(new l.ae(`sources.${t}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new l.k(new l.ae(`sources.${t}`,null,'missing required property "coordinates"'))),s.animate&&typeof s.animate!="boolean"&&this.fire(new l.k(new l.ae(`sources.${t}`,null,'optional "animate" property must be a boolean value'))),s.canvas?typeof s.canvas=="string"||s.canvas instanceof HTMLCanvasElement||this.fire(new l.k(new l.ae(`sources.${t}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new l.k(new l.ae(`sources.${t}`,null,'missing required property "canvas"'))),this.options=s,this.animate=s.animate===void 0||s.animate}load(){return l._(this,void 0,void 0,(function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new l.k(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}))}getCanvas(){return this.canvas}onAdd(t){this.map=t,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let t=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,t=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,t=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const s=this.map.painter.context,o=s.gl;this.texture?(t||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):(this.texture=new l.T(s,this.canvas,o.RGBA,{premultiply:!0}),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE));let u=!1;for(const f in this.tiles){const _=this.tiles[f];_.state!=="loaded"&&(_.state="loaded",_.texture=this.texture,u=!0)}u&&this.fire(new l.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",animate:this.animate,canvas:this.options.canvas,coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const t of[this.canvas.width,this.canvas.height])if(isNaN(t)||t<=0)return!0;return!1}}const j={},Z=p=>{switch(p){case"geojson":return Ti;case"image":return Ai;case"raster":return un;case"raster-dem":return Hi;case"vector":return Ws;case"video":return ve;case"canvas":return N}return j[p]},ce="RTLPluginLoaded";class he extends l.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=cn()}_syncState(t){return this.status=t,this.dispatcher.broadcast("SRPS",{pluginStatus:t,pluginURL:this.url}).catch((s=>{throw this.status="error",s}))}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(t){return l._(this,arguments,void 0,(function*(s,o=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=ze.resolveURL(s),!this.url)throw new Error(`requested url ${s} is invalid`);if(this.status==="unavailable"){if(!o)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()}))}_requestImport(){return l._(this,void 0,void 0,(function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new l.l(ce))}))}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let Te=null;function _e(){return Te||(Te=new he),Te}var de,Ee;(function(p){p[p.Base=0]="Base",p[p.Parent=1]="Parent"})(de||(de={})),(function(p){p[p.Departing=0]="Departing",p[p.Incoming=1]="Incoming"})(Ee||(Ee={}));class Ue{constructor(t,s){this.timeAdded=0,this.fadeEndTime=0,this.fadeOpacity=1,this.tileID=t,this.uid=l.af(),this.uses=0,this.tileSize=s,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}isRenderable(t){return this.hasData()&&(!this.fadeEndTime||this.fadeOpacity>0)&&(t||!this.holdingForSymbolFade())}setCrossFadeLogic({fadingRole:t,fadingDirection:s,fadingParentID:o,fadeEndTime:u}){this.resetFadeLogic(),this.fadingRole=t,this.fadingDirection=s,this.fadingParentID=o,this.fadeEndTime=u}setSelfFadeLogic(t){this.resetFadeLogic(),this.selfFading=!0,this.fadeEndTime=t}resetFadeLogic(){this.fadingRole=null,this.fadingDirection=null,this.fadingParentID=null,this.selfFading=!1,this.timeAdded=ot(),this.fadeEndTime=0,this.fadeOpacity=1}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(t){this.demTexture&&t.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(t,s,o){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData,this.latestFeatureIndex.encoding=t.encoding):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData,this.latestFeatureIndex.encoding=this.latestEncoding)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=(function(u,f){const _={};if(!f)return _;for(const b of u){const T=b.layerIds.map((M=>f.getLayer(M))).filter(Boolean);if(T.length!==0){b.layers=T,b.stateDependentLayerIds&&(b.stateDependentLayers=b.stateDependentLayerIds.map((M=>T.filter((A=>A.id===M))[0])));for(const M of T)_[M.id]=b}}return _})(t.buckets,s?.style),this.hasSymbolBuckets=!1;for(const u in this.buckets){const f=this.buckets[u];if(f instanceof l.ah){if(this.hasSymbolBuckets=!0,!o)break;f.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const u in this.buckets){const f=this.buckets[u];if(f instanceof l.ah&&f.hasRTLText){this.hasRTLText=!0,_e().lazyLoad();break}}this.queryPadding=0;for(const u in this.buckets){const f=this.buckets[u];this.queryPadding=Math.max(this.queryPadding,s.style.getLayer(u).queryRadius(f))}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),this.dashPositions=t.dashPositions}else this.collisionBoxArray=new l.ag}unloadVectorData(){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.dashPositions&&(this.dashPositions=null),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(t){return this.buckets[t.id]}upload(t){for(const o in this.buckets){const u=this.buckets[o];u.uploadPending()&&u.upload(t)}const s=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new l.T(t,this.imageAtlas.image,s.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new l.T(t,this.glyphAtlasImage,s.ALPHA),this.glyphAtlasImage=null)}prepare(t){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture)}queryRenderedFeatures(t,s,o,u,f,_,b,T,M,A,R){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:u,cameraQueryGeometry:f,scale:_,tileSize:this.tileSize,pixelPosMatrix:A,transform:T,params:b,queryPadding:this.queryPadding*M,getElevation:R},t,s,o):{}}querySourceFeatures(t,s){const o=this.latestFeatureIndex;if(!o||!o.rawTileData)return;const u=o.loadVTLayers(),f=s&&s.sourceLayer?s.sourceLayer:"",_=u[l.ai]||u[f];if(!_)return;const b=l.aj(s?.filter,s?.globalState),{z:T,x:M,y:A}=this.tileID.canonical,R={z:T,x:M,y:A};for(let z=0;z<_.length;z++){const O=_.feature(z);if(b.needGeometry){const Y=l.ak(O,!0);if(!b.filter(new l.H(this.tileID.overscaledZ),Y,this.tileID.canonical))continue}else if(!b.filter(new l.H(this.tileID.overscaledZ),O))continue;const V=o.getId(O,f),W=new l.al(O,T,M,A,V);W.tile=R,t.push(W)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const s=this.expirationTime;if(t.cacheControl){const o=l.am(t.cacheControl);o["max-age"]&&(this.expirationTime=Date.now()+1e3*o["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const o=Date.now();let u=!1;if(this.expirationTime>o)u=!1;else if(s)if(this.expirationTime<s)u=!0;else{const f=this.expirationTime-s;f?this.expirationTime=o+Math.max(f,3e4):u=!0}else u=!0;u?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(t,s){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(t).length===0)return;const o=this.latestFeatureIndex.loadVTLayers();for(const u in this.buckets){if(!s.style.hasLayer(u))continue;const f=this.buckets[u],_=f.layers[0].sourceLayer||l.ai,b=o[_],T=t[_];if(!b||!T||Object.keys(T).length===0)continue;f.update(T,b,this.imageAtlas&&this.imageAtlas.patternPositions||{},this.dashPositions||{});const M=s&&s.style&&s.style.getLayer(u);M&&(this.queryPadding=Math.max(this.queryPadding,M.queryRadius(f)))}}holdingForSymbolFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<ot()}clearSymbolFadeHold(){this.symbolFadeHoldUntil=void 0}setSymbolHoldDuration(t){this.symbolFadeHoldUntil=ot()+t}setDependencies(t,s){const o={};for(const u of s)o[u]=!0;this.dependencies[t]=o}hasDependency(t,s){for(const o of t){const u=this.dependencies[o];if(u){for(const f of s)if(u[f])return!0}}return!1}}class Oe{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,s,o){const u=String(s);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][u]=this.stateChanges[t][u]||{},l.e(this.stateChanges[t][u],o),this.deletedStates[t]===null){this.deletedStates[t]={};for(const f in this.state[t])f!==u&&(this.deletedStates[t][f]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][u]===null){this.deletedStates[t][u]={};for(const f in this.state[t][u])o[f]||(this.deletedStates[t][u][f]=null)}else for(const f in o)this.deletedStates[t]&&this.deletedStates[t][u]&&this.deletedStates[t][u][f]===null&&delete this.deletedStates[t][u][f]}removeFeatureState(t,s,o){if(this.deletedStates[t]===null)return;const u=String(s);if(this.deletedStates[t]=this.deletedStates[t]||{},o&&s!==void 0)this.deletedStates[t][u]!==null&&(this.deletedStates[t][u]=this.deletedStates[t][u]||{},this.deletedStates[t][u][o]=null);else if(s!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][u])for(o in this.deletedStates[t][u]={},this.stateChanges[t][u])this.deletedStates[t][u][o]=null;else this.deletedStates[t][u]=null;else this.deletedStates[t]=null}getState(t,s){const o=String(s),u=l.e({},(this.state[t]||{})[o],(this.stateChanges[t]||{})[o]);if(this.deletedStates[t]===null)return{};if(this.deletedStates[t]){const f=this.deletedStates[t][s];if(f===null)return{};for(const _ in f)delete u[_]}return u}initializeTileState(t,s){t.setFeatureState(this.state,s)}coalesceChanges(t,s){const o={};for(const u in this.stateChanges){this.state[u]=this.state[u]||{};const f={};for(const _ in this.stateChanges[u])this.state[u][_]||(this.state[u][_]={}),l.e(this.state[u][_],this.stateChanges[u][_]),f[_]=this.state[u][_];o[u]=f}for(const u in this.deletedStates){this.state[u]=this.state[u]||{};const f={};if(this.deletedStates[u]===null)for(const _ in this.state[u])f[_]={},this.state[u][_]={};else for(const _ in this.deletedStates[u]){if(this.deletedStates[u][_]===null)this.state[u][_]={};else for(const b of Object.keys(this.deletedStates[u][_]))delete this.state[u][_][b];f[_]=this.state[u][_]}o[u]=o[u]||{},l.e(o[u],f)}this.stateChanges={},this.deletedStates={},Object.keys(o).length!==0&&t.setFeatureState(o,s)}}const at=89.25;function ft(p,t){const s=l.an(t.lat,-l.ao,l.ao);return new l.P(l.Y(t.lng)*p,l.X(s)*p)}function kt(p,t){return new l.a9(t.x/p,t.y/p).toLngLat()}function nr(p){return p.cameraToCenterDistance*Math.min(.85*Math.tan(l.ap(90-p.pitch)),Math.tan(l.ap(at-p.pitch)))}function er(p,t){const s=p.canonical,o=t/l.aq(s.z),u=s.x+Math.pow(2,s.z)*p.wrap,f=l.ar(new Float64Array(16));return l.O(f,f,[u*o,s.y*o,0]),l.Q(f,f,[o/l.a5,o/l.a5,1]),f}function Se(p,t,s,o,u){const f=l.a9.fromLngLat(p,t),_=u*l.as(1,p.lat),{x:b,y:T,z:M}=dr(s,o);return new l.a9(f.x+_*-b,f.y+_*-T,f.z+_*-M)}function dr(p,t){const s=l.ap(p),o=l.ap(t),u=Math.cos(-s),f=Math.sin(s);return{x:f*Math.sin(o),y:-f*Math.cos(o),z:u}}function ui(p,t,s){const o=t.intersectsFrustum(p);if(!s||o===0)return o;const u=t.intersectsPlane(s);return u===0?0:o===2&&u===2?2:1}function Dt(p,t,s){let o=0;const u=(s-t)/10;for(let f=0;f<10;f++)o+=u*Math.pow(Math.cos(t+(f+.5)/10*(s-t)),p);return o}function or(p,t){return function(s,o,u,f,_){const b=2*((p-1)/l.at(Math.cos(l.ap(at-_))/Math.cos(l.ap(at)))-1),T=Math.acos(u/f),M=2*Dt(b-1,0,l.ap(_/2)),A=Math.min(l.ap(at),T+l.ap(_/2)),R=Dt(b-1,Math.min(A,T-l.ap(_/2)),A),z=Math.atan(o/u),O=Math.hypot(o,u);let V=s;return V+=l.at(f/O/Math.max(.5,Math.cos(l.ap(_/2)))),V+=b*l.at(Math.cos(z))/2,V-=l.at(Math.max(1,R/M/t))/2,V}}const Hr=or(9.314,3);function cr(p,t){const s=(t.roundZoom?Math.round:Math.floor)(p.zoom+l.at(p.tileSize/t.tileSize));return Math.max(0,s)}function mr(p,t){const s=p.getCameraFrustum(),o=p.getClippingPlane(),u=p.screenPointToMercatorCoordinate(p.getCameraPoint()),f=l.a9.fromLngLat(p.center,p.elevation);u.z=f.z+Math.cos(p.pitchInRadians)*p.cameraToCenterDistance/p.worldSize;const _=p.getCoveringTilesDetailsProvider(),b=_.allowVariableZoom(p,t),T=cr(p,t),M=t.minzoom||0,A=t.maxzoom!==void 0?t.maxzoom:p.maxZoom,R=Math.min(Math.max(0,T),A),z=Math.pow(2,R),O=[z*u.x,z*u.y,0],V=[z*f.x,z*f.y,0],W=Math.hypot(f.x-u.x,f.y-u.y),Y=Math.abs(f.z-u.z),X=Math.hypot(W,Y),te=ne=>({zoom:0,x:0,y:0,wrap:ne,fullyVisible:!1}),le=[],Q=[];if(p.renderWorldCopies&&_.allowWorldCopies())for(let ne=1;ne<=3;ne++)le.push(te(-ne)),le.push(te(ne));for(le.push(te(0));le.length>0;){const ne=le.pop(),ue=ne.x,ie=ne.y;let pe=ne.fullyVisible;const Ce={x:ue,y:ie,z:ne.zoom},Pe=_.getTileBoundingVolume(Ce,ne.wrap,p.elevation,t);if(!pe){const Je=ui(s,Pe,o);if(Je===0)continue;pe=Je===2}const Me=_.distanceToTile2d(u.x,u.y,Ce,Pe);let Ie=T;b&&(Ie=(t.calculateTileZoom||Hr)(p.zoom+l.at(p.tileSize/t.tileSize),Me,Y,X,p.fov)),Ie=(t.roundZoom?Math.round:Math.floor)(Ie),Ie=Math.max(0,Ie);const Xe=Math.min(Ie,A);if(ne.wrap=_.getWrap(f,Ce,ne.wrap),ne.zoom>=Xe){if(ne.zoom<M)continue;const Je=R-ne.zoom,$e=O[0]-.5-(ue<<Je),it=O[1]-.5-(ie<<Je),Ft=t.reparseOverscaled?Math.max(ne.zoom,Ie):ne.zoom;Q.push({tileID:new l.a2(ne.zoom===A?Ft:ne.zoom,ne.wrap,ne.zoom,ue,ie),distanceSq:l.au([V[0]-.5-ue,V[1]-.5-ie]),tileDistanceToCamera:Math.sqrt($e*$e+it*it)})}else for(let Je=0;Je<4;Je++)le.push({zoom:ne.zoom+1,x:(ue<<1)+Je%2,y:(ie<<1)+(Je>>1),wrap:ne.wrap,fullyVisible:pe})}return Q.sort(((ne,ue)=>ne.distanceSq-ue.distanceSq)).map((ne=>ne.tileID))}const ar=l.aa.fromPoints([new l.P(0,0),new l.P(l.a5,l.a5)]);function Cr(p){return p==="raster"||p==="image"||p==="video"}function ys(p,t,s,o,u,f,_){if(!t.hasData())return!1;const{tileID:b,fadingRole:T,fadingDirection:M,fadingParentID:A}=t;if(T===de.Base&&M===Ee.Incoming&&A)return s[A.key]=A,!0;const R=Math.max(b.overscaledZ-u,f);for(let z=b.overscaledZ-1;z>=R;z--){const O=b.scaledTo(z),V=p.getLoadedTile(O);if(V)return t.setCrossFadeLogic({fadingRole:de.Base,fadingDirection:Ee.Incoming,fadingParentID:V.tileID,fadeEndTime:o+_}),V.setCrossFadeLogic({fadingRole:de.Parent,fadingDirection:Ee.Departing,fadeEndTime:o+_}),s[O.key]=O,!0}return!1}function xs(p,t,s,o,u,f){if(!t.hasData())return!1;const _=t.tileID.children(u);let b=Ze(p,t,_,s,o,u,f);if(b)return!0;for(const T of _)Ze(p,t,T.children(u),s,o,u,f)&&(b=!0);return b}function Ze(p,t,s,o,u,f,_){if(s[0].overscaledZ>=f)return!1;let b=!1;for(const T of s){const M=p.getLoadedTile(T);if(!M)continue;const{fadingRole:A,fadingDirection:R,fadingParentID:z}=M;A===de.Base&&R===Ee.Departing&&z||(M.setCrossFadeLogic({fadingRole:de.Base,fadingDirection:Ee.Departing,fadingParentID:t.tileID,fadeEndTime:u+_}),t.setCrossFadeLogic({fadingRole:de.Parent,fadingDirection:Ee.Incoming,fadeEndTime:u+_})),o[T.key]=T,b=!0}return b}function fi(p,t,s,o){const u=p.tileID;return!!p.selfFading||!p.hasData()&&!!t.has(u)&&(p.setSelfFadeLogic(s+o),!0)}function Si(p,t){var s;p.needsHillshadePrepare=!0,p.needsTerrainPrepare=!0;let o=t.tileID.canonical.x-p.tileID.canonical.x;const u=t.tileID.canonical.y-p.tileID.canonical.y,f=Math.pow(2,p.tileID.canonical.z),_=t.tileID.key;o===0&&u===0||Math.abs(u)>1||(Math.abs(o)>1&&(Math.abs(o+f)===1?o+=f:Math.abs(o-f)===1&&(o-=f)),t.dem&&p.dem&&(p.dem.backfillBorder(t.dem,o,u),!((s=p.neighboringTiles)===null||s===void 0)&&s[_]&&(p.neighboringTiles[_].backfilled=!0)))}class io{constructor(){this._tiles={}}handleWrapJump(t){const s={};for(const o in this._tiles){const u=this._tiles[o];u.tileID=u.tileID.unwrapTo(u.tileID.wrap+t),s[u.tileID.key]=u}this._tiles=s}setFeatureState(t,s){for(const o in this._tiles)this._tiles[o].setFeatureState(t,s)}getAllTiles(){return Object.values(this._tiles)}getAllIds(t=!1){return t?Object.values(this._tiles).map((s=>s.tileID)).sort(l.aw).map((s=>s.key)):Object.keys(this._tiles)}getTileById(t){return this._tiles[t]}setTile(t,s){this._tiles[t]=s}deleteTileById(t){delete this._tiles[t]}getLoadedTile(t){const s=this.getTileById(t.key);return s?.hasData()?s:null}isIdRenderable(t,s=!1){var o;return(o=this.getTileById(t))===null||o===void 0?void 0:o.isRenderable(s)}getRenderableIds(t=0,s){const o=[];for(const u of this.getAllIds())this.isIdRenderable(u,s)&&o.push(this.getTileById(u));return s?o.sort(((u,f)=>{const _=u.tileID,b=f.tileID,T=new l.P(_.canonical.x,_.canonical.y)._rotate(-t),M=new l.P(b.canonical.x,b.canonical.y)._rotate(-t);return _.overscaledZ-b.overscaledZ||M.y-T.y||M.x-T.x})).map((u=>u.tileID.key)):o.map((u=>u.tileID)).sort(l.aw).map((u=>u.key))}}class Wr extends l.E{constructor(t,s,o){super(),this.id=t,this.dispatcher=o,this.on("data",(u=>this._dataHandler(u))),this.on("dataloading",(()=>{this._sourceErrored=!1})),this.on("error",(()=>{this._sourceErrored=this._source.loaded()})),this._source=((u,f,_,b)=>{const T=new(Z(f.type))(u,f,_,b);if(T.id!==u)throw new Error(`Expected Source id to be ${u} instead of ${T.id}`);return T})(t,s,o,this),this._inViewTiles=new io,this._outOfViewCache=new l.ax(0,(u=>this._unloadTile(u))),this._timers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._rasterFadeDuration=0,this._maxFadingAncestorLevels=5,this._state=new Oe,this._didEmitContent=!1,this._updated=!1}onAdd(t){this.map=t,this._maxTileCacheSize=t?t._maxTileCacheSize:null,this._maxTileCacheZoomLevels=t?t._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(t)}onRemove(t){for(const s of this._inViewTiles.getAllTiles())s.unloadVectorData();this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(t),this._inViewTiles=new io}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const t of this._inViewTiles.getAllTiles())if(t.state!=="loaded"&&t.state!=="errored")return!1;return!0}getSource(){return this._source}getState(){return this._state}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(t,s,o){return l._(this,void 0,void 0,(function*(){try{yield this._source.loadTile(t),this._tileLoaded(t,s,o)}catch(u){t.state="errored",u.status!==404?this._source.fire(new l.k(u,{tile:t})):this.update(this.transform,this.terrain)}}))}_unloadTile(t){this._source.unloadTile&&this._source.unloadTile(t)}_abortTile(t){this._source.abortTile&&this._source.abortTile(t),this._source.fire(new l.l("dataabort",{tile:t,coord:t.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._inViewTiles,this.map?this.map.painter:null);for(const s of this._inViewTiles.getAllTiles())s.upload(t),s.prepare(this.map.style.imageManager)}getIds(){return this._inViewTiles.getAllIds(!0)}getRenderableIds(t){var s;return this._inViewTiles.getRenderableIds((s=this.transform)===null||s===void 0?void 0:s.bearingInRadians,t)}hasRenderableParent(t){const s=t.overscaledZ-1;if(s>=this._source.minzoom){const o=this.getLoadedTile(t.scaledTo(s));if(o)return this._inViewTiles.isIdRenderable(o.tileID.key)}return!1}reload(t,s=void 0){if(this._paused)this._shouldReloadOnResume=!0;else{this._outOfViewCache.reset();for(const o of this._inViewTiles.getAllIds()){const u=this._inViewTiles.getTileById(o);s&&!this._source.shouldReloadTile(u,s)||(t?this._reloadTile(o,"expired"):u.state!=="errored"&&this._reloadTile(o,"reloading"))}}}_reloadTile(t,s){return l._(this,void 0,void 0,(function*(){const o=this._inViewTiles.getTileById(t);o&&(o.state!=="loading"&&(o.state=s),yield this._loadTile(o,t,s))}))}_tileLoaded(t,s,o){t.timeAdded=ot(),t.selfFading&&(t.fadeEndTime=t.timeAdded+this._rasterFadeDuration),o==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(s,t),this.getSource().type==="raster-dem"&&t.dem&&(function(u,f){var _,b;const T=f.getRenderableIds();for(const M of T){if(!u.neighboringTiles||!u.neighboringTiles[M])continue;const A=f.getTileById(M);u.neighboringTiles[M].backfilled||Si(u,A),!((b=(_=A.neighboringTiles)===null||_===void 0?void 0:_[u.tileID.key])===null||b===void 0)&&b.backfilled||Si(A,u)}})(t,this._inViewTiles),this._state.initializeTileState(t,this.map?this.map.painter:null),t.aborted||this._source.fire(new l.l("data",{dataType:"source",tile:t,coord:t.tileID}))}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._inViewTiles.getTileById(t)}_retainLoadedChildren(t,s){const o=this._getLoadedDescendents(s),u=new Set;for(const f of s){const _=o[f.key];if(!_?.length){u.add(f);continue}const b=f.overscaledZ+Wr.maxOverzooming,T=_.filter((R=>R.tileID.overscaledZ<=b));if(!T.length){u.add(f);continue}const M=Math.min(...T.map((R=>R.tileID.overscaledZ))),A=T.filter((R=>R.tileID.overscaledZ===M)).map((R=>R.tileID));for(const R of A)t[R.key]=R;this._areDescendentsComplete(A,M,f.overscaledZ)||u.add(f)}return u}_getLoadedDescendents(t){var s;const o={};for(const u of this._inViewTiles.getAllTiles().filter((f=>f.hasData())))for(const f of t)u.tileID.isChildOf(f)&&(o[s=f.key]||(o[s]=[])).push(u);return o}_areDescendentsComplete(t,s,o){return t.length===1&&t[0].isOverscaled()?t[0].overscaledZ===s:Math.pow(4,s-o)===t.length}getLoadedTile(t){return this._inViewTiles.getLoadedTile(t)}updateCacheSize(t){const s=Math.ceil(t.width/this._source.tileSize)+1,o=Math.ceil(t.height/this._source.tileSize)+1,u=Math.floor(s*o*(this._maxTileCacheZoomLevels===null?l.c.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),f=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,u):u;this._outOfViewCache.setMaxSize(f)}handleWrapJump(t){const s=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);this._prevLng=t,s&&(this._inViewTiles.handleWrapJump(s),this._resetTileReloadTimers())}update(t,s){if(!this._sourceLoaded||this._paused)return;let o;this.transform=t,this.terrain=s,this.updateCacheSize(t),this.handleWrapJump(this.transform.center.lng),this.used||this.usedForTerrain?this._source.tileID?o=t.getVisibleUnwrappedCoordinates(this._source.tileID).map((T=>new l.a2(T.canonical.z,T.wrap,T.canonical.z,T.canonical.x,T.canonical.y))):(o=mr(t,{tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.type==="vector"&&this.map._zoomLevelsToOverscale!==void 0?t.maxZoom-this.map._zoomLevelsToOverscale:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:s,calculateTileZoom:this._source.calculateTileZoom}),this._source.hasTile&&(o=o.filter((T=>this._source.hasTile(T))))):o=[],this.usedForTerrain&&(o=this._addTerrainIdealTiles(o));const u=o.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,u&&this.fire(new l.l("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const f=cr(t,this._source),_=this._updateRetainedTiles(o,f),b=Cr(this._source.type);b&&this._rasterFadeDuration>0&&!s&&(function(T,M,A,R,z,O,V){const W=ot(),Y=l.av(M);for(const X of M){const te=T.getTileById(X.key);te.fadingDirection!==Ee.Departing&&te.fadeOpacity!==0||te.resetFadeLogic(),ys(T,te,A,W,R,z,V)||xs(T,te,A,W,O,V)||fi(te,Y,W,V)||te.resetFadeLogic()}})(this._inViewTiles,o,_,this._maxFadingAncestorLevels,this._source.minzoom,this._source.maxzoom,this._rasterFadeDuration),b?this._cleanUpRasterTiles(_):this._cleanUpVectorTiles(_)}_cleanUpRasterTiles(t){for(const s of this._inViewTiles.getAllIds())t[s]||this._removeTile(s)}_cleanUpVectorTiles(t){for(const s of this._inViewTiles.getAllIds()){const o=this._inViewTiles.getTileById(s);t[s]?o.clearSymbolFadeHold():o.hasSymbolBuckets?o.holdingForSymbolFade()?o.symbolFadeFinished()&&this._removeTile(s):o.setSymbolHoldDuration(this.map._fadeDuration):this._removeTile(s)}}_addTerrainIdealTiles(t){const s=[];for(const o of t)if(o.canonical.z>this._source.minzoom){const u=o.scaledTo(o.canonical.z-1);s.push(u);const f=o.scaledTo(Math.max(this._source.minzoom,Math.min(o.canonical.z,5)));s.push(f)}return t.concat(s)}releaseSymbolFadeTiles(){for(const t of this._inViewTiles.getAllIds())this._inViewTiles.getTileById(t).holdingForSymbolFade()&&this._removeTile(t)}_updateRetainedTiles(t,s){var o;const u=new Set;for(const M of t)this._addTile(M).hasData()||u.add(M);const f=t.reduce(((M,A)=>(M[A.key]=A,M)),{}),_=this._retainLoadedChildren(f,u),b={},T=Math.max(s-Wr.maxUnderzooming,this._source.minzoom);for(const M of _){let A=this._inViewTiles.getTileById(M.key),R=A?.wasRequested();for(let z=M.overscaledZ-1;z>=T;--z){const O=M.scaledTo(z);if(b[O.key])break;if(b[O.key]=!0,A=this.getTile(O),!A&&R&&(A=this._addTile(O)),A){const V=A.hasData();if((V||!(!((o=this.map)===null||o===void 0)&&o.cancelPendingTileRequestsWhileZooming)||R)&&(f[O.key]=O),R=A.wasRequested(),V)break}}}return f}_addTile(t){let s=this._inViewTiles.getTileById(t.key);if(s)return s;s=this._outOfViewCache.getAndRemove(t),s&&(s.resetFadeLogic(),this._setTileReloadTimer(t.key,s),s.tileID=t,this._state.initializeTileState(s,this.map?this.map.painter:null));const o=s;return s||(s=new Ue(t,this._source.tileSize*t.overscaleFactor()),this._loadTile(s,t.key,s.state)),s.uses++,this._inViewTiles.setTile(t.key,s),o||this._source.fire(new l.l("dataloading",{tile:s,coord:s.tileID,dataType:"source"})),s}_setTileReloadTimer(t,s){this._clearTileReloadTimer(t);const o=s.getExpiryTimeout();o&&(this._timers[t]=setTimeout((()=>{this._reloadTile(t,"expired"),delete this._timers[t]}),o))}_clearTileReloadTimer(t){const s=this._timers[t];s&&(clearTimeout(s),delete this._timers[t])}_resetTileReloadTimers(){for(const t in this._timers)clearTimeout(this._timers[t]),delete this._timers[t];for(const t of this._inViewTiles.getAllIds()){const s=this._inViewTiles.getTileById(t);this._setTileReloadTimer(t,s)}}refreshTiles(t){for(const s of this._inViewTiles.getAllIds()){const o=this._inViewTiles.getTileById(s);(this._inViewTiles.isIdRenderable(s)||o.state=="errored")&&t.some((u=>u.equals(o.tileID.canonical)))&&this._reloadTile(s,"expired")}}_removeTile(t){const s=this._inViewTiles.getTileById(t);s&&(s.uses--,this._inViewTiles.deleteTileById(t),this._clearTileReloadTimer(t),s.uses>0||(s.hasData()&&s.state!=="reloading"?this._outOfViewCache.add(s.tileID,s,s.getExpiryTimeout()):(s.aborted=!0,this._abortTile(s),this._unloadTile(s))))}_dataHandler(t){t.dataType==="source"&&(t.sourceDataType!=="metadata"?t.sourceDataType==="content"&&this._sourceLoaded&&!this._paused&&(this.reload(t.sourceDataChanged,t.shouldReloadTileOptions),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0):this._sourceLoaded=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t of this._inViewTiles.getAllIds())this._removeTile(t);this._outOfViewCache.reset()}tilesIn(t,s,o){const u=[],f=this.transform;if(!f)return u;const _=f.getCoveringTilesDetailsProvider().allowWorldCopies(),b=o?f.getCameraQueryGeometry(t):t,T=O=>f.screenPointToMercatorCoordinate(O,this.terrain),M=this.transformBbox(t,T,!_),A=this.transformBbox(b,T,!_),R=this.getIds(),z=l.aa.fromPoints(A);for(let O=0;O<R.length;O++){const V=this._inViewTiles.getTileById(R[O]);if(V.holdingForSymbolFade())continue;const W=_?[V.tileID]:[V.tileID.unwrapTo(-1),V.tileID.unwrapTo(0)],Y=Math.pow(2,f.zoom-V.tileID.overscaledZ),X=s*V.queryPadding*l.a5/V.tileSize/Y;for(const te of W){const le=z.map((Q=>te.getTilePoint(new l.a9(Q.x,Q.y))));if(le.expandBy(X),le.intersects(ar)){const Q=M.map((ue=>te.getTilePoint(ue))),ne=A.map((ue=>te.getTilePoint(ue)));u.push({tile:V,tileID:_?te:te.unwrapTo(0),queryGeometry:Q,cameraQueryGeometry:ne,scale:Y})}}}return u}transformBbox(t,s,o){let u=t.map(s);if(o){const f=l.aa.fromPoints(t);f.shrinkBy(.001*Math.min(f.width(),f.height()));const _=f.map(s);l.aa.fromPoints(u).covers(_)||(u=u.map((b=>b.x>.5?new l.a9(b.x-1,b.y,b.z):b)))}return u}getVisibleCoordinates(t){const s=this.getRenderableIds(t).map((o=>this._inViewTiles.getTileById(o).tileID));return this.transform&&this.transform.populateCache(s),s}hasTransition(){return!!this._source.hasTransition()||!(!Cr(this._source.type)||!(function(t,s){if(s<=0)return!1;const o=ot();for(const u of t.getAllTiles())if(u.fadeEndTime>=o)return!0;return!1})(this._inViewTiles,this._rasterFadeDuration))}setRasterFadeDuration(t){this._rasterFadeDuration=t}setFeatureState(t,s,o){this._state.updateState(t=t||l.ai,s,o)}removeFeatureState(t,s,o){this._state.removeFeatureState(t=t||l.ai,s,o)}getFeatureState(t,s){return this._state.getState(t=t||l.ai,s)}setDependencies(t,s,o){const u=this._inViewTiles.getTileById(t);u&&u.setDependencies(s,o)}reloadTilesForDependencies(t,s){for(const o of this._inViewTiles.getAllIds())this._inViewTiles.getTileById(o).hasDependency(t,s)&&this._reloadTile(o,"reloading");this._outOfViewCache.filter((o=>!o.hasDependency(t,s)))}areTilesLoaded(){for(const t of this._inViewTiles.getAllTiles())if(t.state!=="loaded"&&t.state!=="errored")return!1;return!0}}Wr.maxUnderzooming=10,Wr.maxOverzooming=3;class et{constructor(t,s){this.reset(t,s)}reset(t,s){this.points=t||[],this._distances=[0];for(let o=1;o<this.points.length;o++)this._distances[o]=this._distances[o-1]+this.points[o].dist(this.points[o-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(s||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=l.an(t,0,1);let s=1,o=this._distances[s];const u=t*this.paddedLength+this.padding;for(;o<u&&s<this._distances.length;)o=this._distances[++s];const f=s-1,_=this._distances[f],b=o-_,T=b>0?(u-_)/b:0;return this.points[f].mult(1-T).add(this.points[s].mult(T))}}function Rt(p,t){let s=!0;return p==="always"||p!=="never"&&t!=="never"||(s=!1),s}class Lt{constructor(t,s,o){const u=this.boxCells=[],f=this.circleCells=[];this.xCellCount=Math.ceil(t/o),this.yCellCount=Math.ceil(s/o);for(let _=0;_<this.xCellCount*this.yCellCount;_++)u.push([]),f.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=s,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/s,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,s,o,u,f){this._forEachCell(s,o,u,f,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(s),this.bboxes.push(o),this.bboxes.push(u),this.bboxes.push(f)}insertCircle(t,s,o,u){this._forEachCell(s-u,o-u,s+u,o+u,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(s),this.circles.push(o),this.circles.push(u)}_insertBoxCell(t,s,o,u,f,_){this.boxCells[f].push(_)}_insertCircleCell(t,s,o,u,f,_){this.circleCells[f].push(_)}_query(t,s,o,u,f,_,b){if(o<0||t>this.width||u<0||s>this.height)return[];const T=[];if(t<=0&&s<=0&&this.width<=o&&this.height<=u){if(f)return[{key:null,x1:t,y1:s,x2:o,y2:u}];for(let M=0;M<this.boxKeys.length;M++)T.push({key:this.boxKeys[M],x1:this.bboxes[4*M],y1:this.bboxes[4*M+1],x2:this.bboxes[4*M+2],y2:this.bboxes[4*M+3]});for(let M=0;M<this.circleKeys.length;M++){const A=this.circles[3*M],R=this.circles[3*M+1],z=this.circles[3*M+2];T.push({key:this.circleKeys[M],x1:A-z,y1:R-z,x2:A+z,y2:R+z})}}else this._forEachCell(t,s,o,u,this._queryCell,T,{hitTest:f,overlapMode:_,seenUids:{box:{},circle:{}}},b);return T}query(t,s,o,u){return this._query(t,s,o,u,!1,null)}hitTest(t,s,o,u,f,_){return this._query(t,s,o,u,!0,f,_).length>0}hitTestCircle(t,s,o,u,f){const _=t-o,b=t+o,T=s-o,M=s+o;if(b<0||_>this.width||M<0||T>this.height)return!1;const A=[];return this._forEachCell(_,T,b,M,this._queryCellCircle,A,{hitTest:!0,overlapMode:u,circle:{x:t,y:s,radius:o},seenUids:{box:{},circle:{}}},f),A.length>0}_queryCell(t,s,o,u,f,_,b,T){const{seenUids:M,hitTest:A,overlapMode:R}=b,z=this.boxCells[f];if(z!==null){const V=this.bboxes;for(const W of z)if(!M.box[W]){M.box[W]=!0;const Y=4*W,X=this.boxKeys[W];if(t<=V[Y+2]&&s<=V[Y+3]&&o>=V[Y+0]&&u>=V[Y+1]&&(!T||T(X))&&(!A||!Rt(R,X.overlapMode))&&(_.push({key:X,x1:V[Y],y1:V[Y+1],x2:V[Y+2],y2:V[Y+3]}),A))return!0}}const O=this.circleCells[f];if(O!==null){const V=this.circles;for(const W of O)if(!M.circle[W]){M.circle[W]=!0;const Y=3*W,X=this.circleKeys[W];if(this._circleAndRectCollide(V[Y],V[Y+1],V[Y+2],t,s,o,u)&&(!T||T(X))&&(!A||!Rt(R,X.overlapMode))){const te=V[Y],le=V[Y+1],Q=V[Y+2];if(_.push({key:X,x1:te-Q,y1:le-Q,x2:te+Q,y2:le+Q}),A)return!0}}}return!1}_queryCellCircle(t,s,o,u,f,_,b,T){const{circle:M,seenUids:A,overlapMode:R}=b,z=this.boxCells[f];if(z!==null){const V=this.bboxes;for(const W of z)if(!A.box[W]){A.box[W]=!0;const Y=4*W,X=this.boxKeys[W];if(this._circleAndRectCollide(M.x,M.y,M.radius,V[Y+0],V[Y+1],V[Y+2],V[Y+3])&&(!T||T(X))&&!Rt(R,X.overlapMode))return _.push(!0),!0}}const O=this.circleCells[f];if(O!==null){const V=this.circles;for(const W of O)if(!A.circle[W]){A.circle[W]=!0;const Y=3*W,X=this.circleKeys[W];if(this._circlesCollide(V[Y],V[Y+1],V[Y+2],M.x,M.y,M.radius)&&(!T||T(X))&&!Rt(R,X.overlapMode))return _.push(!0),!0}}}_forEachCell(t,s,o,u,f,_,b,T){const M=this._convertToXCellCoord(t),A=this._convertToYCellCoord(s),R=this._convertToXCellCoord(o),z=this._convertToYCellCoord(u);for(let O=M;O<=R;O++)for(let V=A;V<=z;V++)if(f.call(this,t,s,o,u,this.xCellCount*V+O,_,b,T))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,s,o,u,f,_){const b=u-t,T=f-s,M=o+_;return M*M>b*b+T*T}_circleAndRectCollide(t,s,o,u,f,_,b){const T=(_-u)/2,M=Math.abs(t-(u+T));if(M>T+o)return!1;const A=(b-f)/2,R=Math.abs(s-(f+A));if(R>A+o)return!1;if(M<=T||R<=A)return!0;const z=M-T,O=R-A;return z*z+O*O<=o*o}}function Pi(p,t,s){const o=l.N();if(!p){const{vecSouth:R,vecEast:z}=vs(t),O=oe();O[0]=z[0],O[1]=z[1],O[2]=R[0],O[3]=R[1],u=O,(A=(_=(f=O)[0])*(M=f[3])-(T=f[2])*(b=f[1]))&&(u[0]=M*(A=1/A),u[1]=-b*A,u[2]=-T*A,u[3]=_*A),o[0]=O[0],o[1]=O[1],o[4]=O[2],o[5]=O[3]}var u,f,_,b,T,M,A;return l.Q(o,o,[1/s,1/s,1]),o}function Cn(p,t,s,o){if(p){const u=l.N();if(!t){const{vecSouth:f,vecEast:_}=vs(s);u[0]=_[0],u[1]=_[1],u[4]=f[0],u[5]=f[1]}return l.Q(u,u,[o,o,1]),u}return s.pixelsToClipSpaceMatrix}function vs(p){const t=Math.cos(p.rollInRadians),s=Math.sin(p.rollInRadians),o=Math.cos(p.pitchInRadians),u=Math.cos(p.bearingInRadians),f=Math.sin(p.bearingInRadians),_=l.aC();_[0]=-u*o*s-f*t,_[1]=-f*o*s+u*t;const b=l.aD(_);b<1e-9?l.aE(_):l.aF(_,_,1/b);const T=l.aC();T[0]=u*o*t-f*s,T[1]=f*o*t+u*s;const M=l.aD(T);return M<1e-9?l.aE(T):l.aF(T,T,1/M),{vecEast:T,vecSouth:_}}function Mt(p,t,s,o){let u;o?(u=[p,t,o(p,t),1],l.aH(u,u,s)):(u=[p,t,0,1],Fa(u,u,s));const f=u[3];return{point:new l.P(u[0]/f,u[1]/f),signedDistanceFromCamera:f,isOccluded:!1}}function hn(p,t){return .5+p/t*.5}function G(p,t){return p.x>=-t[0]&&p.x<=t[0]&&p.y>=-t[1]&&p.y<=t[1]}function K(p,t,s,o,u,f,_,b,T,M,A,R,z){const O=s?p.textSizeData:p.iconSizeData,V=l.ay(O,t.transform.zoom),W=[256/t.width*2+1,256/t.height*2+1],Y=s?p.text.dynamicLayoutVertexArray:p.icon.dynamicLayoutVertexArray;Y.clear();const X=p.lineVertexArray,te=s?p.text.placedSymbolArray:p.icon.placedSymbolArray,le=t.transform.width/t.transform.height;let Q=!1;for(let ne=0;ne<te.length;ne++){const ue=te.get(ne);if(ue.hidden||ue.writingMode===l.az.vertical&&!Q){Yi(ue.numGlyphs,Y);continue}Q=!1;const ie=new l.P(ue.anchorX,ue.anchorY),pe={getElevation:z,pitchedLabelPlaneMatrix:o,lineVertexArray:X,pitchWithMap:f,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:t.transform,tileAnchorPoint:ie,unwrappedTileID:T,width:M,height:A,translation:R},Ce=Ve(ue.anchorX,ue.anchorY,pe);if(!G(Ce.point,W)){Yi(ue.numGlyphs,Y);continue}const Pe=hn(t.transform.cameraToCenterDistance,Ce.signedDistanceFromCamera),Me=l.aA(O,V,ue),Ie=f?Me*t.transform.getPitchedTextCorrection(ue.anchorX,ue.anchorY,T)/Pe:Me*Pe,Xe=fe({projectionContext:pe,pitchedLabelPlaneMatrixInverse:u,symbol:ue,fontSize:Ie,flip:!1,keepUpright:_,glyphOffsetArray:p.glyphOffsetArray,dynamicLayoutVertexArray:Y,aspectRatio:le,rotateToLine:b});Q=Xe.useVertical,(Xe.notEnoughRoom||Q||Xe.needsFlipping&&fe({projectionContext:pe,pitchedLabelPlaneMatrixInverse:u,symbol:ue,fontSize:Ie,flip:!0,keepUpright:_,glyphOffsetArray:p.glyphOffsetArray,dynamicLayoutVertexArray:Y,aspectRatio:le,rotateToLine:b}).notEnoughRoom)&&Yi(ue.numGlyphs,Y)}s?p.text.dynamicLayoutVertexBuffer.updateData(Y):p.icon.dynamicLayoutVertexBuffer.updateData(Y)}function J(p,t,s,o,u,f,_,b){const T=f.glyphStartIndex+f.numGlyphs,M=f.lineStartIndex,A=f.lineStartIndex+f.lineLength,R=t.getoffsetX(f.glyphStartIndex),z=t.getoffsetX(T-1),O=sr(p*R,s,o,u,f.segment,M,A,b,_);if(!O)return null;const V=sr(p*z,s,o,u,f.segment,M,A,b,_);return V?b.projectionCache.anyProjectionOccluded?null:{first:O,last:V}:null}function se(p,t,s,o){return p===l.az.horizontal&&Math.abs(s.y-t.y)>Math.abs(s.x-t.x)*o?{useVertical:!0}:(p===l.az.vertical?t.y<s.y:t.x>s.x)?{needsFlipping:!0}:null}function fe(p){const{projectionContext:t,pitchedLabelPlaneMatrixInverse:s,symbol:o,fontSize:u,flip:f,keepUpright:_,glyphOffsetArray:b,dynamicLayoutVertexArray:T,aspectRatio:M,rotateToLine:A}=p,R=u/24,z=o.lineOffsetX*R,O=o.lineOffsetY*R;let V;if(o.numGlyphs>1){const W=o.glyphStartIndex+o.numGlyphs,Y=o.lineStartIndex,X=o.lineStartIndex+o.lineLength,te=J(R,b,z,O,f,o,A,t);if(!te)return{notEnoughRoom:!0};const le=ke(te.first.point.x,te.first.point.y,t,s),Q=ke(te.last.point.x,te.last.point.y,t,s);if(_&&!f){const ne=se(o.writingMode,le,Q,M);if(ne)return ne}V=[te.first];for(let ne=o.glyphStartIndex+1;ne<W-1;ne++){const ue=sr(R*b.getoffsetX(ne),z,O,f,o.segment,Y,X,t,A);if(!ue)return{notEnoughRoom:!0};V.push(ue)}V.push(te.last)}else{if(_&&!f){const Y=Be(t.tileAnchorPoint.x,t.tileAnchorPoint.y,t).point,X=o.lineStartIndex+o.segment+1,te=new l.P(t.lineVertexArray.getx(X),t.lineVertexArray.gety(X)),le=Be(te.x,te.y,t),Q=le.signedDistanceFromCamera>0?le.point:xe(t.tileAnchorPoint,te,Y,1,t),ne=ke(Y.x,Y.y,t,s),ue=ke(Q.x,Q.y,t,s),ie=se(o.writingMode,ne,ue,M);if(ie)return ie}const W=sr(R*b.getoffsetX(o.glyphStartIndex),z,O,f,o.segment,o.lineStartIndex,o.lineStartIndex+o.lineLength,t,A);if(!W||t.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};V=[W]}for(const W of V)l.aG(T,W.point,W.angle);return{}}function xe(p,t,s,o,u){const f=p.add(p.sub(t)._unit()),_=Be(f.x,f.y,u).point,b=s.sub(_);return s.add(b._mult(o/b.mag()))}function je(p,t,s){const o=t.projectionCache;if(o.projections[p])return o.projections[p];const u=new l.P(t.lineVertexArray.getx(p),t.lineVertexArray.gety(p)),f=Be(u.x,u.y,t);if(f.signedDistanceFromCamera>0)return o.projections[p]=f.point,o.anyProjectionOccluded=o.anyProjectionOccluded||f.isOccluded,f.point;const _=p-s.direction;return xe(s.distanceFromAnchor===0?t.tileAnchorPoint:new l.P(t.lineVertexArray.getx(_),t.lineVertexArray.gety(_)),u,s.previousVertex,s.absOffsetX-s.distanceFromAnchor+1,t)}function Be(p,t,s){const o=p+s.translation[0],u=t+s.translation[1];let f;return s.pitchWithMap?(f=Mt(o,u,s.pitchedLabelPlaneMatrix,s.getElevation),f.isOccluded=!1):(f=s.transform.projectTileCoordinates(o,u,s.unwrappedTileID,s.getElevation),f.point.x=(.5*f.point.x+.5)*s.width,f.point.y=(.5*-f.point.y+.5)*s.height),f}function ke(p,t,s,o){if(s.pitchWithMap){const u=[p,t,0,1];return l.aH(u,u,o),s.transform.projectTileCoordinates(u[0]/u[3],u[1]/u[3],s.unwrappedTileID,s.getElevation).point}return{x:p/s.width*2-1,y:1-t/s.height*2}}function Ve(p,t,s){return s.transform.projectTileCoordinates(p,t,s.unwrappedTileID,s.getElevation)}function wt(p,t,s){return p._unit()._perp()._mult(t*s)}function $t(p,t,s,o,u,f,_,b,T){if(b.projectionCache.offsets[p])return b.projectionCache.offsets[p];const M=s.add(t);if(p+T.direction<o||p+T.direction>=u)return b.projectionCache.offsets[p]=M,M;const A=je(p+T.direction,b,T),R=wt(A.sub(s),_,T.direction),z=s.add(R),O=A.add(R);return b.projectionCache.offsets[p]=l.aI(f,M,z,O)||M,b.projectionCache.offsets[p]}function sr(p,t,s,o,u,f,_,b,T){const M=o?p-t:p+t;let A=M>0?1:-1,R=0;o&&(A*=-1,R=Math.PI),A<0&&(R+=Math.PI);let z,O=A>0?f+u:f+u+1;b.projectionCache.cachedAnchorPoint?z=b.projectionCache.cachedAnchorPoint:(z=Be(b.tileAnchorPoint.x,b.tileAnchorPoint.y,b).point,b.projectionCache.cachedAnchorPoint=z);let V,W,Y=z,X=z,te=0,le=0;const Q=Math.abs(M),ne=[];let ue;for(;te+le<=Q;){if(O+=A,O<f||O>=_)return null;te+=le,X=Y,W=V;const Ce={absOffsetX:Q,direction:A,distanceFromAnchor:te,previousVertex:X};if(Y=je(O,b,Ce),s===0)ne.push(X),ue=Y.sub(X);else{let Pe;const Me=Y.sub(X);Pe=Me.mag()===0?wt(je(O+A,b,Ce).sub(Y),s,A):wt(Me,s,A),W||(W=X.add(Pe)),V=$t(O,Pe,Y,f,_,W,s,b,Ce),ne.push(W),ue=V.sub(W)}le=ue.mag()}const ie=ue._mult((Q-te)/le)._add(W||X),pe=R+Math.atan2(Y.y-X.y,Y.x-X.x);return ne.push(ie),{point:ie,angle:T?pe:0,path:ne}}const Xi=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function Yi(p,t){for(let s=0;s<p;s++){const o=t.length;t.resize(o+4),t.float32.set(Xi,3*o)}}function Fa(p,t,s){const o=t[0],u=t[1];return p[0]=s[0]*o+s[4]*u+s[12],p[1]=s[1]*o+s[5]*u+s[13],p[3]=s[3]*o+s[7]*u+s[15],p}const $r=100;class Au{constructor(t,s=new Lt(t.width+200,t.height+200,25),o=new Lt(t.width+200,t.height+200,25)){this.transform=t,this.grid=s,this.ignoredGrid=o,this.pitchFactor=Math.cos(t.pitch*Math.PI/180)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+$r,this.screenBottomBoundary=t.height+$r,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(t,s,o,u,f,_,b,T,M,A,R,z){const O=this.projectAndGetPerspectiveRatio(t.anchorPointX+T[0],t.anchorPointY+T[1],f,A,z),V=o*O.perspectiveRatio;let W;if(_||b)W=this._projectCollisionBox(t,V,u,f,_,b,T,O,A,R,z);else{const ue=O.x+(R?R.x*V:0),ie=O.y+(R?R.y*V:0);W={allPointsOccluded:!1,box:[ue+t.x1*V,ie+t.y1*V,ue+t.x2*V,ie+t.y2*V]}}const[Y,X,te,le]=W.box,Q=_?W.allPointsOccluded:O.isOccluded;let ne=Q;return ne||(ne=O.perspectiveRatio<this.perspectiveRatioCutoff),ne||(ne=!this.isInsideGrid(Y,X,te,le)),ne||s!=="always"&&this.grid.hitTest(Y,X,te,le,s,M)?{box:[Y,X,te,le],placeable:!1,offscreen:!1,occluded:Q}:{box:[Y,X,te,le],placeable:!0,offscreen:this.isOffscreen(Y,X,te,le),occluded:Q}}placeCollisionCircles(t,s,o,u,f,_,b,T,M,A,R,z,O,V){const W=[],Y=new l.P(s.anchorX,s.anchorY),X=this.getPerspectiveRatio(Y.x,Y.y,_,V),te=(M?f*this.transform.getPitchedTextCorrection(s.anchorX,s.anchorY,_)/X:f*X)/l.aM,le={getElevation:V,pitchedLabelPlaneMatrix:b,lineVertexArray:o,pitchWithMap:M,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:this.transform,tileAnchorPoint:Y,unwrappedTileID:_,width:this.transform.width,height:this.transform.height,translation:O},Q=J(te,u,s.lineOffsetX*te,s.lineOffsetY*te,!1,s,!1,le);let ne=!1,ue=!1,ie=!0;if(Q){const pe=.5*R*X+z,Ce=new l.P(-100,-100),Pe=new l.P(this.screenRightBoundary,this.screenBottomBoundary),Me=new et,Ie=Q.first,Xe=Q.last;let Je=[];for(let Ft=Ie.path.length-1;Ft>=1;Ft--)Je.push(Ie.path[Ft]);for(let Ft=1;Ft<Xe.path.length;Ft++)Je.push(Xe.path[Ft]);const $e=2.5*pe;if(M){const Ft=this.projectPathToScreenSpace(Je,le);Je=Ft.some((pr=>pr.signedDistanceFromCamera<=0))?[]:Ft.map((pr=>pr.point))}let it=[];if(Je.length>0){const Ft=Je[0].clone(),pr=Je[0].clone();for(let Ir=1;Ir<Je.length;Ir++)Ft.x=Math.min(Ft.x,Je[Ir].x),Ft.y=Math.min(Ft.y,Je[Ir].y),pr.x=Math.max(pr.x,Je[Ir].x),pr.y=Math.max(pr.y,Je[Ir].y);it=Ft.x>=Ce.x&&pr.x<=Pe.x&&Ft.y>=Ce.y&&pr.y<=Pe.y?[Je]:pr.x<Ce.x||Ft.x>Pe.x||pr.y<Ce.y||Ft.y>Pe.y?[]:l.aJ([Je],Ce.x,Ce.y,Pe.x,Pe.y)}for(const Ft of it){Me.reset(Ft,.25*pe);let pr=0;pr=Me.length<=.5*pe?1:Math.ceil(Me.paddedLength/$e)+1;for(let Ir=0;Ir<pr;Ir++){const vr=Ir/Math.max(pr-1,1),Dr=Me.lerp(vr),br=Dr.x+$r,qr=Dr.y+$r;W.push(br,qr,pe,0);const zr=br-pe,gi=qr-pe,si=br+pe,Kr=qr+pe;if(ie=ie&&this.isOffscreen(zr,gi,si,Kr),ue=ue||this.isInsideGrid(zr,gi,si,Kr),t!=="always"&&this.grid.hitTestCircle(br,qr,pe,t,A)&&(ne=!0,!T))return{circles:[],offscreen:!1,collisionDetected:ne}}}}return{circles:!T&&ne||!ue||X<this.perspectiveRatioCutoff?[]:W,offscreen:ie,collisionDetected:ne}}projectPathToScreenSpace(t,s){const o=(function(u,f){const _=l.N();return l.aB(_,f.pitchedLabelPlaneMatrix),u.map((b=>{const T=Mt(b.x,b.y,_,f.getElevation),M=f.transform.projectTileCoordinates(T.point.x,T.point.y,f.unwrappedTileID,f.getElevation);return M.point.x=(.5*M.point.x+.5)*f.width,M.point.y=(.5*-M.point.y+.5)*f.height,M}))})(t,s);return(function(u){let f=0,_=0,b=0,T=0;for(let M=0;M<u.length;M++)u[M].isOccluded?(b=M+1,T=0):(T++,T>_&&(_=T,f=b));return u.slice(f,f+_)})(o)}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const s=[],o=new l.aa;for(const R of t){const z=new l.P(R.x+$r,R.y+$r);o.extend(z),s.push(z)}const{minX:u,minY:f,maxX:_,maxY:b}=o,T=this.grid.query(u,f,_,b).concat(this.ignoredGrid.query(u,f,_,b)),M={},A={};for(const R of T){const z=R.key;if(M[z.bucketInstanceId]===void 0&&(M[z.bucketInstanceId]={}),M[z.bucketInstanceId][z.featureIndex])continue;const O=[new l.P(R.x1,R.y1),new l.P(R.x2,R.y1),new l.P(R.x2,R.y2),new l.P(R.x1,R.y2)];l.aK(s,O)&&(M[z.bucketInstanceId][z.featureIndex]=!0,A[z.bucketInstanceId]===void 0&&(A[z.bucketInstanceId]=[]),A[z.bucketInstanceId].push(z.featureIndex))}return A}insertCollisionBox(t,s,o,u,f,_){(o?this.ignoredGrid:this.grid).insert({bucketInstanceId:u,featureIndex:f,collisionGroupID:_,overlapMode:s},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,s,o,u,f,_){const b=o?this.ignoredGrid:this.grid,T={bucketInstanceId:u,featureIndex:f,collisionGroupID:_,overlapMode:s};for(let M=0;M<t.length;M+=4)b.insertCircle(T,t[M],t[M+1],t[M+2])}projectAndGetPerspectiveRatio(t,s,o,u,f){if(f){let _;u?(_=[t,s,u(t,s),1],l.aH(_,_,f)):(_=[t,s,0,1],Fa(_,_,f));const b=_[3];return{x:(_[0]/b+1)/2*this.transform.width+$r,y:(-_[1]/b+1)/2*this.transform.height+$r,perspectiveRatio:.5+this.transform.cameraToCenterDistance/b*.5,isOccluded:!1,signedDistanceFromCamera:b}}{const _=this.transform.projectTileCoordinates(t,s,o,u);return{x:(_.point.x+1)/2*this.transform.width+$r,y:(1-_.point.y)/2*this.transform.height+$r,perspectiveRatio:.5+this.transform.cameraToCenterDistance/_.signedDistanceFromCamera*.5,isOccluded:_.isOccluded,signedDistanceFromCamera:_.signedDistanceFromCamera}}}getPerspectiveRatio(t,s,o,u){const f=this.transform.projectTileCoordinates(t,s,o,u);return .5+this.transform.cameraToCenterDistance/f.signedDistanceFromCamera*.5}isOffscreen(t,s,o,u){return o<$r||t>=this.screenRightBoundary||u<$r||s>this.screenBottomBoundary}isInsideGrid(t,s,o,u){return o>=0&&t<this.gridRightBoundary&&u>=0&&s<this.gridBottomBoundary}getViewportMatrix(){const t=l.ar([]);return l.O(t,t,[-100,-100,0]),t}_projectCollisionBox(t,s,o,u,f,_,b,T,M,A,R){let z=1,O=0,V=0,W=1;const Y=t.anchorPointX+b[0],X=t.anchorPointY+b[1];if(_&&!f){const Je=this.projectAndGetPerspectiveRatio(Y+1,X,u,M,R),$e=Je.x-T.x,it=Math.atan((Je.y-T.y)/$e)+($e<0?Math.PI:0),Ft=Math.sin(it),pr=Math.cos(it);z=pr,O=Ft,V=-Ft,W=pr}else if(!_&&f){const Je=vs(this.transform);z=Je.vecEast[0],O=Je.vecEast[1],V=Je.vecSouth[0],W=Je.vecSouth[1]}let te=T.x,le=T.y,Q=s;f&&(te=Y,le=X,Q=Math.pow(2,-(this.transform.zoom-o.overscaledZ)),Q*=this.transform.getPitchedTextCorrection(Y,X,u),A||(Q*=l.an(.5+T.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))),A&&(te+=z*A.x*Q+V*A.y*Q,le+=O*A.x*Q+W*A.y*Q);const ne=t.x1*Q,ue=t.x2*Q,ie=(ne+ue)/2,pe=t.y1*Q,Ce=t.y2*Q,Pe=(pe+Ce)/2,Me=[{offsetX:ne,offsetY:pe},{offsetX:ie,offsetY:pe},{offsetX:ue,offsetY:pe},{offsetX:ue,offsetY:Pe},{offsetX:ue,offsetY:Ce},{offsetX:ie,offsetY:Ce},{offsetX:ne,offsetY:Ce},{offsetX:ne,offsetY:Pe}];let Ie=[];for(const{offsetX:Je,offsetY:$e}of Me)Ie.push(new l.P(te+z*Je+V*$e,le+O*Je+W*$e));let Xe=!1;if(f){const Je=Ie.map(($e=>this.projectAndGetPerspectiveRatio($e.x,$e.y,u,M,R)));Xe=Je.some(($e=>!$e.isOccluded)),Ie=Je.map(($e=>new l.P($e.x,$e.y)))}else Xe=!0;return{box:l.aL(Ie),allPointsOccluded:!Xe}}}class Cu{constructor(t,s,o,u){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?s:-s))):u&&o?1:0,this.placed=o}isHidden(){return this.opacity===0&&!this.placed}}class Vo{constructor(t,s,o,u,f){this.text=new Cu(t?t.text:null,s,o,f),this.icon=new Cu(t?t.icon:null,s,u,f)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class ku{constructor(t,s,o){this.text=t,this.icon=s,this.skipFade=o}}class Du{constructor(t,s,o,u,f){this.bucketInstanceId=t,this.featureIndex=s,this.sourceLayerIndex=o,this.bucketIndex=u,this.tileID=f}}class zu{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const s=++this.maxGroupID;this.collisionGroups[t]={ID:s,predicate:o=>o.collisionGroupID===s}}return this.collisionGroups[t]}}function La(p,t,s,o,u){const{horizontalAlign:f,verticalAlign:_}=l.aS(p);return new l.P(-(f-.5)*t+o[0]*u,-(_-.5)*s+o[1]*u)}class Kl{constructor(t,s,o,u,f){this.transform=t.clone(),this.terrain=s,this.collisionIndex=new Au(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=o,this.retainedQueryData={},this.collisionGroups=new zu(u),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=f,f&&(f.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(t){const s=this.terrain;return s?(o,u)=>s.getElevation(t,o,u):null}getBucketParts(t,s,o,u){const f=o.getBucket(s),_=o.latestFeatureIndex;if(!f||!_||s.id!==f.layerIds[0])return;const b=o.collisionBoxArray,T=f.layers[0].layout,M=f.layers[0].paint,A=Math.pow(2,this.transform.zoom-o.tileID.overscaledZ),R=o.tileSize/l.a5,z=o.tileID.toUnwrapped(),O=T.get("text-rotation-alignment")==="map",V=l.aN(o,1,this.transform.zoom),W=l.aO(this.collisionIndex.transform,o,M.get("text-translate"),M.get("text-translate-anchor")),Y=l.aO(this.collisionIndex.transform,o,M.get("icon-translate"),M.get("icon-translate-anchor")),X=Pi(O,this.transform,V);this.retainedQueryData[f.bucketInstanceId]=new Du(f.bucketInstanceId,_,f.sourceLayerIndex,f.index,o.tileID);const te={bucket:f,layout:T,translationText:W,translationIcon:Y,unwrappedTileID:z,pitchedLabelPlaneMatrix:X,scale:A,textPixelRatio:R,holdingForFade:o.holdingForSymbolFade(),collisionBoxArray:b,partiallyEvaluatedTextSize:l.ay(f.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(f.sourceID)};if(u)for(const le of f.sortKeyRanges){const{sortKey:Q,symbolInstanceStart:ne,symbolInstanceEnd:ue}=le;t.push({sortKey:Q,symbolInstanceStart:ne,symbolInstanceEnd:ue,parameters:te})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:f.symbolInstances.length,parameters:te})}attemptAnchorPlacement(t,s,o,u,f,_,b,T,M,A,R,z,O,V,W,Y,X,te,le,Q){const ne=l.aP[t.textAnchor],ue=[t.textOffset0,t.textOffset1],ie=La(ne,o,u,ue,f),pe=this.collisionIndex.placeCollisionBox(s,z,T,M,A,b,_,Y,R.predicate,le,ie,Q);if((!te||this.collisionIndex.placeCollisionBox(te,z,T,M,A,b,_,X,R.predicate,le,ie,Q).placeable)&&pe.placeable){let Ce;if(this.prevPlacement&&this.prevPlacement.variableOffsets[O.crossTileID]&&this.prevPlacement.placements[O.crossTileID]&&this.prevPlacement.placements[O.crossTileID].text&&(Ce=this.prevPlacement.variableOffsets[O.crossTileID].anchor),O.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[O.crossTileID]={textOffset:ue,width:o,height:u,anchor:ne,textBoxScale:f,prevAnchor:Ce},this.markUsedJustification(V,ne,O,W),V.allowVerticalPlacement&&(this.markUsedOrientation(V,W,O),this.placedOrientations[O.crossTileID]=W),{shift:ie,placedGlyphBoxes:pe}}}placeLayerBucketPart(t,s,o){const{bucket:u,layout:f,translationText:_,translationIcon:b,unwrappedTileID:T,pitchedLabelPlaneMatrix:M,textPixelRatio:A,holdingForFade:R,collisionBoxArray:z,partiallyEvaluatedTextSize:O,collisionGroup:V}=t.parameters,W=f.get("text-optional"),Y=f.get("icon-optional"),X=l.aQ(f,"text-overlap","text-allow-overlap"),te=X==="always",le=l.aQ(f,"icon-overlap","icon-allow-overlap"),Q=le==="always",ne=f.get("text-rotation-alignment")==="map",ue=f.get("text-pitch-alignment")==="map",ie=f.get("icon-text-fit")!=="none",pe=f.get("symbol-z-order")==="viewport-y",Ce=te&&(Q||!u.hasIconData()||Y),Pe=Q&&(te||!u.hasTextData()||W);!u.collisionArrays&&z&&u.deserializeCollisionBoxes(z);const Me=this.retainedQueryData[u.bucketInstanceId].tileID,Ie=this._getTerrainElevationFunc(Me),Xe=this.transform.getFastPathSimpleProjectionMatrix(Me),Je=($e,it,Ft)=>{var pr,Ir;if(s[$e.crossTileID])return;if(R)return void(this.placements[$e.crossTileID]=new ku(!1,!1,!1));let vr=!1,Dr=!1,br=!0,qr=null,zr={box:null,placeable:!1,offscreen:null,occluded:!1},gi={placeable:!1},si=null,Kr=null,Ei=null,bn=0,Js=0,$s=0;it.textFeatureIndex?bn=it.textFeatureIndex:$e.useRuntimeCollisionCircles&&(bn=$e.featureIndex),it.verticalTextFeatureIndex&&(Js=it.verticalTextFeatureIndex);const Qi=it.textBox;if(Qi){const ms=Pr=>{let wr=l.az.horizontal;if(u.allowVerticalPlacement&&!Pr&&this.prevPlacement){const hi=this.prevPlacement.placedOrientations[$e.crossTileID];hi&&(this.placedOrientations[$e.crossTileID]=hi,wr=hi,this.markUsedOrientation(u,wr,$e))}return wr},Us=(Pr,wr)=>{if(u.allowVerticalPlacement&&$e.numVerticalGlyphVertices>0&&it.verticalTextBox){for(const hi of u.writingModes)if(hi===l.az.vertical?(zr=wr(),gi=zr):zr=Pr(),zr&&zr.placeable)break}else zr=Pr()},Es=$e.textAnchorOffsetStartIndex,Ms=$e.textAnchorOffsetEndIndex;if(Ms===Es){const Pr=(wr,hi)=>{const di=this.collisionIndex.placeCollisionBox(wr,X,A,Me,T,ue,ne,_,V.predicate,Ie,void 0,Xe);return di&&di.placeable&&(this.markUsedOrientation(u,hi,$e),this.placedOrientations[$e.crossTileID]=hi),di};Us((()=>Pr(Qi,l.az.horizontal)),(()=>{const wr=it.verticalTextBox;return u.allowVerticalPlacement&&$e.numVerticalGlyphVertices>0&&wr?Pr(wr,l.az.vertical):{box:null,offscreen:null}})),ms(zr&&zr.placeable)}else{let Pr=l.aP[(Ir=(pr=this.prevPlacement)===null||pr===void 0?void 0:pr.variableOffsets[$e.crossTileID])===null||Ir===void 0?void 0:Ir.anchor];const wr=(di,Ih,Ah)=>{const Wn=di.x2-di.x1,tp=di.y2-di.y1,Ch=$e.textBoxScale,Zc=ie&&le==="never"?Ih:null;let wn=null,Tn=X==="never"?1:2,Sn="never";Pr&&Tn++;for(let Hc=0;Hc<Tn;Hc++){for(let Wc=Es;Wc<Ms;Wc++){const xl=u.textAnchorOffsets.get(Wc);if(Pr&&xl.textAnchor!==Pr)continue;const vl=this.attemptAnchorPlacement(xl,di,Wn,tp,Ch,ne,ue,A,Me,T,V,Sn,$e,u,Ah,_,b,Zc,Ie);if(vl&&(wn=vl.placedGlyphBoxes,wn&&wn.placeable))return vr=!0,qr=vl.shift,wn}Pr?Pr=null:Sn=X}return o&&!wn&&(wn={box:this.collisionIndex.placeCollisionBox(Qi,"always",A,Me,T,ue,ne,_,V.predicate,Ie,void 0,Xe).box,offscreen:!1,placeable:!1,occluded:!1}),wn};Us((()=>wr(Qi,it.iconBox,l.az.horizontal)),(()=>{const di=it.verticalTextBox;return u.allowVerticalPlacement&&(!zr||!zr.placeable)&&$e.numVerticalGlyphVertices>0&&di?wr(di,it.verticalIconBox,l.az.vertical):{box:null,occluded:!0,offscreen:null}})),zr&&(vr=zr.placeable,br=zr.offscreen);const hi=ms(zr&&zr.placeable);if(!vr&&this.prevPlacement){const di=this.prevPlacement.variableOffsets[$e.crossTileID];di&&(this.variableOffsets[$e.crossTileID]=di,this.markUsedJustification(u,di.anchor,$e,hi))}}}if(si=zr,vr=si&&si.placeable,br=si&&si.offscreen,$e.useRuntimeCollisionCircles&&$e.centerJustifiedTextSymbolIndex>=0){const ms=u.text.placedSymbolArray.get($e.centerJustifiedTextSymbolIndex),Us=l.aA(u.textSizeData,O,ms),Es=f.get("text-padding");Kr=this.collisionIndex.placeCollisionCircles(X,ms,u.lineVertexArray,u.glyphOffsetArray,Us,T,M,o,ue,V.predicate,$e.collisionCircleDiameter,Es,_,Ie),Kr.circles.length&&Kr.collisionDetected&&!o&&l.w("Collisions detected, but collision boxes are not shown"),vr=te||Kr.circles.length>0&&!Kr.collisionDetected,br=br&&Kr.offscreen}if(it.iconFeatureIndex&&($s=it.iconFeatureIndex),it.iconBox){const ms=Us=>this.collisionIndex.placeCollisionBox(Us,le,A,Me,T,ue,ne,b,V.predicate,Ie,ie&&qr?qr:void 0,Xe);gi&&gi.placeable&&it.verticalIconBox?(Ei=ms(it.verticalIconBox),Dr=Ei.placeable):(Ei=ms(it.iconBox),Dr=Ei.placeable),br=br&&Ei.offscreen}const Zn=W||$e.numHorizontalGlyphVertices===0&&$e.numVerticalGlyphVertices===0,ba=Y||$e.numIconVertices===0;Zn||ba?ba?Zn||(Dr=Dr&&vr):vr=Dr&&vr:Dr=vr=Dr&&vr;const Hn=Dr&&Ei.placeable;if(vr&&si.placeable&&this.collisionIndex.insertCollisionBox(si.box,X,f.get("text-ignore-placement"),u.bucketInstanceId,gi&&gi.placeable&&Js?Js:bn,V.ID),Hn&&this.collisionIndex.insertCollisionBox(Ei.box,le,f.get("icon-ignore-placement"),u.bucketInstanceId,$s,V.ID),Kr&&vr&&this.collisionIndex.insertCollisionCircles(Kr.circles,X,f.get("text-ignore-placement"),u.bucketInstanceId,bn,V.ID),o&&this.storeCollisionData(u.bucketInstanceId,Ft,it,si,Ei,Kr),$e.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(u.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[$e.crossTileID]=new ku((vr||Ce)&&!si?.occluded,(Dr||Pe)&&!Ei?.occluded,br||u.justReloaded),s[$e.crossTileID]=!0};if(pe){if(t.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const $e=u.getSortedSymbolIndexes(-this.transform.bearingInRadians);for(let it=$e.length-1;it>=0;--it){const Ft=$e[it];Je(u.symbolInstances.get(Ft),u.collisionArrays[Ft],Ft)}}else for(let $e=t.symbolInstanceStart;$e<t.symbolInstanceEnd;$e++)Je(u.symbolInstances.get($e),u.collisionArrays[$e],$e);u.justReloaded=!1}storeCollisionData(t,s,o,u,f,_){if(o.textBox||o.iconBox){let b,T;this.collisionBoxArrays.has(t)?b=this.collisionBoxArrays.get(t):(b=new Map,this.collisionBoxArrays.set(t,b)),b.has(s)?T=b.get(s):(T={text:null,icon:null},b.set(s,T)),o.textBox&&(T.text=u.box),o.iconBox&&(T.icon=f.box)}if(_){let b=this.collisionCircleArrays[t];b===void 0&&(b=this.collisionCircleArrays[t]=[]);for(let T=0;T<_.circles.length;T+=4)b.push(_.circles[T+0]-$r),b.push(_.circles[T+1]-$r),b.push(_.circles[T+2]),b.push(_.collisionDetected?1:0)}}markUsedJustification(t,s,o,u){let f;f=u===l.az.vertical?o.verticalPlacedTextSymbolIndex:{left:o.leftJustifiedTextSymbolIndex,center:o.centerJustifiedTextSymbolIndex,right:o.rightJustifiedTextSymbolIndex}[l.aR(s)];const _=[o.leftJustifiedTextSymbolIndex,o.centerJustifiedTextSymbolIndex,o.rightJustifiedTextSymbolIndex,o.verticalPlacedTextSymbolIndex];for(const b of _)b>=0&&(t.text.placedSymbolArray.get(b).crossTileID=f>=0&&b!==f?0:o.crossTileID)}markUsedOrientation(t,s,o){const u=s===l.az.horizontal||s===l.az.horizontalOnly?s:0,f=s===l.az.vertical?s:0,_=[o.leftJustifiedTextSymbolIndex,o.centerJustifiedTextSymbolIndex,o.rightJustifiedTextSymbolIndex];for(const b of _)t.text.placedSymbolArray.get(b).placedOrientation=u;o.verticalPlacedTextSymbolIndex&&(t.text.placedSymbolArray.get(o.verticalPlacedTextSymbolIndex).placedOrientation=f)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const s=this.prevPlacement;let o=!1;this.prevZoomAdjustment=s?s.zoomAdjustment(this.transform.zoom):0;const u=s?s.symbolFadeChange(t):1,f=s?s.opacities:{},_=s?s.variableOffsets:{},b=s?s.placedOrientations:{};for(const T in this.placements){const M=this.placements[T],A=f[T];A?(this.opacities[T]=new Vo(A,u,M.text,M.icon),o=o||M.text!==A.text.placed||M.icon!==A.icon.placed):(this.opacities[T]=new Vo(null,u,M.text,M.icon,M.skipFade),o=o||M.text||M.icon)}for(const T in f){const M=f[T];if(!this.opacities[T]){const A=new Vo(M,u,!1,!1);A.isHidden()||(this.opacities[T]=A,o=o||M.text.placed||M.icon.placed)}}for(const T in _)this.variableOffsets[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.variableOffsets[T]=_[T]);for(const T in b)this.placedOrientations[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.placedOrientations[T]=b[T]);if(s&&s.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");o?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=s?s.lastPlacementChangeTime:t)}updateLayerOpacities(t,s){const o={};for(const u of s){const f=u.getBucket(t);f&&u.latestFeatureIndex&&t.id===f.layerIds[0]&&this.updateBucketOpacities(f,u.tileID,o,u.collisionBoxArray)}}updateBucketOpacities(t,s,o,u){t.hasTextData()&&(t.text.opacityVertexArray.clear(),t.text.hasVisibleVertices=!1),t.hasIconData()&&(t.icon.opacityVertexArray.clear(),t.icon.hasVisibleVertices=!1),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const f=t.layers[0],_=f.layout,b=new Vo(null,0,!1,!1,!0),T=_.get("text-allow-overlap"),M=_.get("icon-allow-overlap"),A=f._unevaluatedLayout.hasValue("text-variable-anchor")||f._unevaluatedLayout.hasValue("text-variable-anchor-offset"),R=_.get("text-rotation-alignment")==="map",z=_.get("text-pitch-alignment")==="map",O=_.get("icon-text-fit")!=="none",V=new Vo(null,0,T&&(M||!t.hasIconData()||_.get("icon-optional")),M&&(T||!t.hasTextData()||_.get("text-optional")),!0);!t.collisionArrays&&u&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(u);const W=(X,te,le)=>{for(let Q=0;Q<te/4;Q++)X.opacityVertexArray.emplaceBack(le);X.hasVisibleVertices=X.hasVisibleVertices||le!==Uo},Y=this.collisionBoxArrays.get(t.bucketInstanceId);for(let X=0;X<t.symbolInstances.length;X++){const te=t.symbolInstances.get(X),{numHorizontalGlyphVertices:le,numVerticalGlyphVertices:Q,crossTileID:ne}=te;let ue=this.opacities[ne];o[ne]?ue=b:ue||(ue=V,this.opacities[ne]=ue),o[ne]=!0;const ie=te.numIconVertices>0,pe=this.placedOrientations[te.crossTileID],Ce=pe===l.az.vertical,Pe=pe===l.az.horizontal||pe===l.az.horizontalOnly;if(le>0||Q>0){const Ie=rc(ue.text);W(t.text,le,Ce?Uo:Ie),W(t.text,Q,Pe?Uo:Ie);const Xe=ue.text.isHidden();[te.rightJustifiedTextSymbolIndex,te.centerJustifiedTextSymbolIndex,te.leftJustifiedTextSymbolIndex].forEach((it=>{it>=0&&(t.text.placedSymbolArray.get(it).hidden=Xe||Ce?1:0)})),te.verticalPlacedTextSymbolIndex>=0&&(t.text.placedSymbolArray.get(te.verticalPlacedTextSymbolIndex).hidden=Xe||Pe?1:0);const Je=this.variableOffsets[te.crossTileID];Je&&this.markUsedJustification(t,Je.anchor,te,pe);const $e=this.placedOrientations[te.crossTileID];$e&&(this.markUsedJustification(t,"left",te,$e),this.markUsedOrientation(t,$e,te))}if(ie){const Ie=rc(ue.icon),Xe=!(O&&te.verticalPlacedIconSymbolIndex&&Ce);te.placedIconSymbolIndex>=0&&(W(t.icon,te.numIconVertices,Xe?Ie:Uo),t.icon.placedSymbolArray.get(te.placedIconSymbolIndex).hidden=ue.icon.isHidden()),te.verticalPlacedIconSymbolIndex>=0&&(W(t.icon,te.numVerticalIconVertices,Xe?Uo:Ie),t.icon.placedSymbolArray.get(te.verticalPlacedIconSymbolIndex).hidden=ue.icon.isHidden())}const Me=Y&&Y.has(X)?Y.get(X):{text:null,icon:null};if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const Ie=t.collisionArrays[X];if(Ie){let Xe=new l.P(0,0);if(Ie.textBox||Ie.verticalTextBox){let Je=!0;if(A){const $e=this.variableOffsets[ne];$e?(Xe=La($e.anchor,$e.width,$e.height,$e.textOffset,$e.textBoxScale),R&&Xe._rotate(z?-this.transform.bearingInRadians:this.transform.bearingInRadians)):Je=!1}if(Ie.textBox||Ie.verticalTextBox){let $e;Ie.textBox&&($e=Ce),Ie.verticalTextBox&&($e=Pe),Ql(t.textCollisionBox.collisionVertexArray,ue.text.placed,!Je||$e,Me.text,Xe.x,Xe.y)}}if(Ie.iconBox||Ie.verticalIconBox){const Je=!!(!Pe&&Ie.verticalIconBox);let $e;Ie.iconBox&&($e=Je),Ie.verticalIconBox&&($e=!Je),Ql(t.iconCollisionBox.collisionVertexArray,ue.icon.placed,$e,Me.icon,O?Xe.x:0,O?Xe.y:0)}}}}if(t.sortFeatures(-this.transform.bearingInRadians),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.text.opacityVertexArray.length!==t.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${t.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${t.text.layoutVertexArray.length}) / 4`);if(t.icon.opacityVertexArray.length!==t.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${t.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${t.icon.layoutVertexArray.length}) / 4`);t.bucketInstanceId in this.collisionCircleArrays&&(t.collisionCircleArray=this.collisionCircleArrays[t.bucketInstanceId],delete this.collisionCircleArrays[t.bucketInstanceId])}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,s){const o=this.zoomAtLastRecencyCheck===s?1-this.zoomAdjustment(s):1;return this.zoomAtLastRecencyCheck=s,this.commitTime+this.fadeDuration*o>t}setStale(){this.stale=!0}}function Ql(p,t,s,o,u,f){o&&o.length!==0||(o=[0,0,0,0]);const _=o[0]-$r,b=o[1]-$r,T=o[2]-$r,M=o[3]-$r;p.emplaceBack(t?1:0,s?1:0,u||0,f||0,_,b),p.emplaceBack(t?1:0,s?1:0,u||0,f||0,T,b),p.emplaceBack(t?1:0,s?1:0,u||0,f||0,T,M),p.emplaceBack(t?1:0,s?1:0,u||0,f||0,_,M)}const ec=Math.pow(2,25),tc=Math.pow(2,24),Cd=Math.pow(2,17),$o=Math.pow(2,16),Oa=Math.pow(2,9),Ru=Math.pow(2,8),so=Math.pow(2,1);function rc(p){if(p.opacity===0&&!p.placed)return 0;if(p.opacity===1&&p.placed)return 4294967295;const t=p.placed?1:0,s=Math.floor(127*p.opacity);return s*ec+t*tc+s*Cd+t*$o+s*Oa+t*Ru+s*so+t}const Uo=0;class dn{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&!t.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(t,s,o,u,f){const _=this._bucketParts;for(;this._currentTileIndex<t.length;)if(s.getBucketParts(_,u,t[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,f())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,_.sort(((b,T)=>b.sortKey-T.sortKey)));this._currentPartIndex<_.length;)if(s.placeLayerBucketPart(_[this._currentPartIndex],this._seenCrossTileIDs,o),this._currentPartIndex++,f())return!0;return!1}}class no{constructor(t,s,o,u,f,_,b,T){this.placement=new Kl(t,s,_,b,T),this._currentPlacementIndex=o.length-1,this._forceFullPlacement=u,this._showCollisionBoxes=f,this._done=!1}isDone(){return this._done}continuePlacement(t,s,o){const u=ot(),f=()=>!this._forceFullPlacement&&ot()-u>2;for(;this._currentPlacementIndex>=0;){const _=s[t[this._currentPlacementIndex]],b=this.placement.collisionIndex.transform.zoom;if(_.type==="symbol"&&(!_.minzoom||_.minzoom<=b)&&(!_.maxzoom||_.maxzoom>b)){if(this._inProgressLayer||(this._inProgressLayer=new dn(_)),this._inProgressLayer.continuePlacement(o[_.source],this.placement,this._showCollisionBoxes,_,f))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Ut=512/l.a5/2;class ic{constructor(t,s,o){this.tileID=t,this.bucketInstanceId=o,this._symbolsByKey={};const u=new Map;for(let f=0;f<s.length;f++){const _=s.get(f),b=_.key,T=u.get(b);T?T.push(_):u.set(b,[_])}for(const[f,_]of u){const b={positions:_.map((T=>({x:Math.floor(T.anchorX*Ut),y:Math.floor(T.anchorY*Ut)}))),crossTileIDs:_.map((T=>T.crossTileID))};if(b.positions.length>128){const T=new l.aT(b.positions.length,16,Uint16Array);for(const{x:M,y:A}of b.positions)T.add(M,A);T.finish(),delete b.positions,b.index=T}this._symbolsByKey[f]=b}}getScaledCoordinates(t,s){const{x:o,y:u,z:f}=this.tileID.canonical,{x:_,y:b,z:T}=s.canonical,M=Ut/Math.pow(2,T-f),A=(b*l.a5+t.anchorY)*M,R=u*l.a5*Ut;return{x:Math.floor((_*l.a5+t.anchorX)*M-o*l.a5*Ut),y:Math.floor(A-R)}}findMatches(t,s,o){const u=this.tileID.canonical.z<s.canonical.z?1:Math.pow(2,this.tileID.canonical.z-s.canonical.z);for(let f=0;f<t.length;f++){const _=t.get(f);if(_.crossTileID)continue;const b=this._symbolsByKey[_.key];if(!b)continue;const T=this.getScaledCoordinates(_,s);if(b.index){const M=b.index.range(T.x-u,T.y-u,T.x+u,T.y+u).sort();for(const A of M){const R=b.crossTileIDs[A];if(!o[R]){o[R]=!0,_.crossTileID=R;break}}}else if(b.positions)for(let M=0;M<b.positions.length;M++){const A=b.positions[M],R=b.crossTileIDs[M];if(Math.abs(A.x-T.x)<=u&&Math.abs(A.y-T.y)<=u&&!o[R]){o[R]=!0,_.crossTileID=R;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map((({crossTileIDs:t})=>t))}}class kd{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class sc{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const s=Math.round((t-this.lng)/360);if(s!==0)for(const o in this.indexes){const u=this.indexes[o],f={};for(const _ in u){const b=u[_];b.tileID=b.tileID.unwrapTo(b.tileID.wrap+s),f[b.tileID.key]=b}this.indexes[o]=f}this.lng=t}addBucket(t,s,o){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===s.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let f=0;f<s.symbolInstances.length;f++)s.symbolInstances.get(f).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]={});const u=this.usedCrossTileIDs[t.overscaledZ];for(const f in this.indexes){const _=this.indexes[f];if(Number(f)>t.overscaledZ)for(const b in _){const T=_[b];T.tileID.isChildOf(t)&&T.findMatches(s.symbolInstances,t,u)}else{const b=_[t.scaledTo(Number(f)).key];b&&b.findMatches(s.symbolInstances,t,u)}}for(let f=0;f<s.symbolInstances.length;f++){const _=s.symbolInstances.get(f);_.crossTileID||(_.crossTileID=o.generate(),u[_.crossTileID]=!0)}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new ic(t,s.symbolInstances,s.bucketInstanceId),!0}removeBucketCrossTileIDs(t,s){for(const o of s.getCrossTileIDsLists())for(const u of o)delete this.usedCrossTileIDs[t][u]}removeStaleBuckets(t){let s=!1;for(const o in this.indexes){const u=this.indexes[o];for(const f in u)t[u[f].bucketInstanceId]||(this.removeBucketCrossTileIDs(o,u[f]),delete u[f],s=!0)}return s}}class Ji{constructor(){this.layerIndexes={},this.crossTileIDs=new kd,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,s,o){let u=this.layerIndexes[t.id];u===void 0&&(u=this.layerIndexes[t.id]=new sc);let f=!1;const _={};u.handleWrapJump(o);for(const b of s){const T=b.getBucket(t);T&&t.id===T.layerIds[0]&&(T.bucketInstanceId||(T.bucketInstanceId=++this.maxBucketInstanceId),u.addBucket(b.tileID,T,this.crossTileIDs)&&(f=!0),_[T.bucketInstanceId]=!0)}return u.removeStaleBuckets(_)&&(f=!0),f}pruneUnusedLayers(t){const s={};t.forEach((o=>{s[o]=!0}));for(const o in this.layerIndexes)s[o]||delete this.layerIndexes[o]}}var Ci="void main() {fragColor=vec4(1.0);}";const Or={prelude:zt(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
out highp vec4 fragColor;`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}mat3 rotationMatrixFromAxisAngle(vec3 u,float angle) {float c=cos(angle);float s=sin(angle);float c2=1.0-c;return mat3(u.x*u.x*c2+      c,u.x*u.y*c2-u.z*s,u.x*u.z*c2+u.y*s,u.y*u.x*c2+u.z*s,u.y*u.y*c2+    c,u.y*u.z*c2-u.x*s,u.z*u.x*c2-u.y*s,u.z*u.y*c2+u.x*s,u.z*u.z*c2+    c
);}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
#ifdef GLOBE
if ((pos.y <-32767.5) || (pos.y > 32766.5)) {return 0.0;}
#endif
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}const float PI=3.141592653589793;uniform mat4 u_projection_matrix;`),projectionMercator:zt("","float projectLineThickness(float tileY) {return 1.0;}float projectCircleRadius(float tileY) {return 1.0;}vec4 projectTile(vec2 p) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);return result;}vec4 projectTile(vec2 p,vec2 rawPos) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);if (rawPos.y <-32767.5 || rawPos.y > 32766.5) {result.z=-10000000.0;}return result;}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_projection_matrix*vec4(posInTile,elevation,1.0);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {return projectTileWithElevation(posInTile,elevation);}"),projectionGlobe:zt("",`#define GLOBE_RADIUS 6371008.8
uniform highp vec4 u_projection_tile_mercator_coords;uniform highp vec4 u_projection_clipping_plane;uniform highp float u_projection_transition;uniform mat4 u_projection_fallback_matrix;vec3 globeRotateVector(vec3 vec,vec2 angles) {vec3 axisRight=vec3(vec.z,0.0,-vec.x);vec3 axisUp=cross(axisRight,vec);axisRight=normalize(axisRight);axisUp=normalize(axisUp);vec2 t=tan(angles);return normalize(vec+axisRight*t.x+axisUp*t.y);}mat3 globeGetRotationMatrix(vec3 spherePos) {vec3 axisRight=vec3(spherePos.z,0.0,-spherePos.x);vec3 axisDown=cross(axisRight,spherePos);axisRight=normalize(axisRight);axisDown=normalize(axisDown);return mat3(axisRight,axisDown,spherePos
);}float circumferenceRatioAtTileY(float tileY) {float mercator_pos_y=u_projection_tile_mercator_coords.y+u_projection_tile_mercator_coords.w*tileY;float spherical_y=2.0*atan(exp(PI-(mercator_pos_y*PI*2.0)))-PI*0.5;return cos(spherical_y);}float projectLineThickness(float tileY) {float thickness=1.0/circumferenceRatioAtTileY(tileY); 
if (u_projection_transition < 0.999) {return mix(1.0,thickness,u_projection_transition);} else {return thickness;}}vec3 projectToSphere(vec2 translatedPos,vec2 rawPos) {vec2 mercator_pos=u_projection_tile_mercator_coords.xy+u_projection_tile_mercator_coords.zw*translatedPos;vec2 spherical;spherical.x=mercator_pos.x*PI*2.0+PI;spherical.y=2.0*atan(exp(PI-(mercator_pos.y*PI*2.0)))-PI*0.5;float len=cos(spherical.y);vec3 pos=vec3(sin(spherical.x)*len,sin(spherical.y),cos(spherical.x)*len
);if (rawPos.y <-32767.5) {pos=vec3(0.0,1.0,0.0);}if (rawPos.y > 32766.5) {pos=vec3(0.0,-1.0,0.0);}return pos;}vec3 projectToSphere(vec2 posInTile) {return projectToSphere(posInTile,vec2(0.0,0.0));}float globeComputeClippingZ(vec3 spherePos) {return (1.0-(dot(spherePos,u_projection_clipping_plane.xyz)+u_projection_clipping_plane.w));}vec4 interpolateProjection(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);globePosition.z=globeComputeClippingZ(elevatedPos)*globePosition.w;if (u_projection_transition > 0.999) {return globePosition;}vec4 flatPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);const float z_globeness_threshold=0.2;vec4 result=globePosition;result.z=mix(0.0,globePosition.z,clamp((u_projection_transition-z_globeness_threshold)/(1.0-z_globeness_threshold),0.0,1.0));result.xyw=mix(flatPosition.xyw,globePosition.xyw,u_projection_transition);if ((posInTile.y <-32767.5) || (posInTile.y > 32766.5)) {result=globePosition;const float poles_hidden_anim_percentage=0.02;result.z=mix(globePosition.z,100.0,pow(max((1.0-u_projection_transition)/poles_hidden_anim_percentage,0.0),8.0));}return result;}vec4 interpolateProjectionFor3D(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);if (u_projection_transition > 0.999) {return globePosition;}vec4 fallbackPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);return mix(fallbackPosition,globePosition,u_projection_transition);}vec4 projectTile(vec2 posInTile) {return interpolateProjection(posInTile,projectToSphere(posInTile),0.0);}vec4 projectTile(vec2 posInTile,vec2 rawPos) {return interpolateProjection(posInTile,projectToSphere(posInTile,rawPos),0.0);}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return interpolateProjection(posInTile,projectToSphere(posInTile),elevation);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {vec3 spherePos=projectToSphere(posInTile,posInTile);return interpolateProjectionFor3D(posInTile,spherePos,elevation);}`),background:zt(`uniform vec4 u_color;uniform float u_opacity;void main() {fragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),backgroundPattern:zt(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;void main() {gl_Position=projectTile(a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:zt(`in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));fragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);const float epsilon=0.5/255.0;if (fragColor.r < epsilon && fragColor.g < epsilon && fragColor.b < epsilon && fragColor.a < epsilon) {discard;}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform highp float u_globe_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;uniform vec2 u_translate;in vec2 a_pos;out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 pos_raw=a_pos+32768.0;vec2 extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);vec2 circle_center=floor(pos_raw/8.0)+u_translate;float ele=get_elevation(circle_center);v_visibility=calculate_visibility(projectTileWithElevation(circle_center,ele));if (u_pitch_with_map) {
#ifdef GLOBE
vec3 center_vector=projectToSphere(circle_center);
#endif
float angle_scale=u_globe_extrude_scale;vec2 corner_position=circle_center;if (u_scale_with_map) {angle_scale*=(radius+stroke_width);corner_position+=extrude*u_extrude_scale*(radius+stroke_width);} else {
#ifdef GLOBE
vec4 projected_center=interpolateProjection(circle_center,center_vector,ele);
#else
vec4 projected_center=projectTileWithElevation(circle_center,ele);
#endif
corner_position+=extrude*u_extrude_scale*(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);angle_scale*=(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);}
#ifdef GLOBE
vec2 angles=extrude*angle_scale;vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(corner_position,corner_vector,ele);
#else
gl_Position=projectTileWithElevation(corner_position,ele);
#endif
} else {gl_Position=projectTileWithElevation(circle_center,ele);if (gl_Position.z/gl_Position.w > 1.0) {gl_Position.xy=vec2(10000.0);}if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:zt(Ci,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),heatmap:zt(`uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);fragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;uniform highp float u_globe_extrude_scale;in vec2 a_pos;out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 pos_raw=a_pos+32768.0;vec2 unscaled_extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 circle_center=floor(pos_raw/8.0);
#ifdef GLOBE
vec2 angles=v_extrude*radius*u_globe_extrude_scale;vec3 center_vector=projectToSphere(circle_center);vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(circle_center+extrude,corner_vector,0.0);
#else
gl_Position=projectTileFor3D(circle_center+extrude,get_elevation(circle_center));
#endif
}`),heatmapTexture:zt(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));fragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:zt("in float v_placed;in float v_notUsed;void main() {float alpha=0.5;fragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {fragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {fragColor*=.1;}}","in vec2 a_anchor_pos;in vec2 a_placed;in vec2 a_box_real;uniform vec2 u_pixel_extrude_scale;out float v_placed;out float v_notUsed;void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:zt("in float v_radius;in vec2 v_extrude;in float v_collision;void main() {float alpha=0.5;float stroke_radius=0.9;float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);fragColor=color*alpha*opacity_t;}","in vec2 a_pos;in float a_radius;in vec2 a_flags;uniform vec2 u_viewport_size;out float v_radius;out vec2 v_extrude;out float v_collision;void main() {float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_collision=collision;gl_Position=vec4((a_pos/u_viewport_size*2.0-1.0)*vec2(1.0,-1.0),0.0,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),colorRelief:zt(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;uniform vec4 u_unpack;uniform sampler2D u_elevation_stops;uniform sampler2D u_color_stops;uniform int u_color_ramp_size;uniform float u_opacity;in vec2 v_pos;float getElevation(vec2 coord) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}float getElevationStop(int stop) {float x=(float(stop)+0.5)/float(u_color_ramp_size);vec4 data=texture(u_elevation_stops,vec2(x,0))*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {float el=getElevation(v_pos);int r=(u_color_ramp_size-1);int l=0;float el_l=getElevationStop(l);float el_r=getElevationStop(r);while(r-l > 1){int m=(r+l)/2;float el_m=getElevationStop(m);if(el < el_m){r=m;el_r=el_m;}else
{l=m;el_l=el_m;}}float x=(float(l)+(el-el_l)/(el_r-el_l)+0.5)/float(u_color_ramp_size);fragColor=u_opacity*texture(u_color_stops,vec2(x,0));
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_dimension;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_pos/8192.0)*scale+epsilon;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),debug:zt("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);fragColor=mix(u_color,overlay_color,overlay_color.a);}","in vec2 a_pos;out vec2 v_uv;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=projectTileWithElevation(a_pos*u_overlay_scale,get_elevation(a_pos));}"),depth:zt(Ci,`in vec2 a_pos;void main() {
#ifdef GLOBE
gl_Position=projectTileFor3D(a_pos,0.0);
#else
gl_Position=u_projection_matrix*vec4(a_pos,0.0,1.0);
#endif
}`),fill:zt(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
fragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_fill_translate;in vec2 a_pos;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);}`),fillOutline:zt(`in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=outline_color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillOutlinePattern:zt(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;in vec2 v_pos_a;in vec2 v_pos_b;in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillPattern:zt(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:zt(`in vec4 v_color;void main() {fragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
out vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;vec3 normalForLighting=normal/16384.0;float directional=clamp(dot(normalForLighting,u_lightpos),0.0,1.0);
#ifdef GLOBE
mat3 rotMatrix=globeGetRotationMatrix(spherePos);normalForLighting=rotMatrix*normalForLighting;directional=mix(directional,clamp(dot(normalForLighting,u_lightpos_globe),0.0,1.0),u_projection_transition);
#endif
directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:zt(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;in vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);fragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
#ifdef GLOBE
out vec3 v_sphere_pos;
#endif
out vec2 v_pos_a;out vec2 v_pos_b;out vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);v_sphere_pos=elevatedPos;gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,elevation*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:zt(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack);}void main() {vec2 epsilon=1.0/u_dimension;float tileSize=u_dimension.x-2.0;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))*tileSize/pow(2.0,exaggeration+(28.2562-u_zoom));fragColor=clamp(vec4(deriv.x/8.0+0.5,deriv.y/8.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:zt(`uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform float u_exaggeration;uniform vec4 u_accent;uniform int u_method;uniform float u_altitudes[NUM_ILLUMINATION_SOURCES];uniform float u_azimuths[NUM_ILLUMINATION_SOURCES];uniform vec4 u_shadows[NUM_ILLUMINATION_SOURCES];uniform vec4 u_highlights[NUM_ILLUMINATION_SOURCES];
#define PI 3.141592653589793
#define STANDARD 0
#define COMBINED 1
#define IGOR 2
#define MULTIDIRECTIONAL 3
#define BASIC 4
float get_aspect(vec2 deriv){return deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);}void igor_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float aspect=get_aspect(deriv);float azimuth=u_azimuths[0]+PI;float slope_stength=atan(length(deriv))*2.0/PI;float aspect_strength=1.0-abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);float shadow_strength=slope_stength*aspect_strength;float highlight_strength=slope_stength*(1.0-aspect_strength);fragColor=u_shadows[0]*shadow_strength+u_highlights[0]*highlight_strength;}void standard_hillshade(vec2 deriv){float azimuth=u_azimuths[0]+PI;float slope=atan(0.625*length(deriv));float aspect=get_aspect(deriv);float intensity=u_exaggeration;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadows[0],u_highlights[0],shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);fragColor=accent_color*(1.0-shade_color.a)+shade_color;}void basic_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor=u_highlights[0]*(2.0*shade-1.0);}else
{fragColor=u_shadows[0]*(1.0-2.0*shade);}}void multidirectional_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;fragColor=vec4(0,0,0,0);for(int i=0; i < NUM_ILLUMINATION_SOURCES; i++){float cos_alt=cos(u_altitudes[i]);float sin_alt=sin(u_altitudes[i]);float cos_az=-cos(u_azimuths[i]);float sin_az=-sin(u_azimuths[i]);float cang=(sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv));float shade=clamp(cang,0.0,1.0);if(shade > 0.5){fragColor+=u_highlights[i]*(2.0*shade-1.0)/float(NUM_ILLUMINATION_SOURCES);}else
{fragColor+=u_shadows[i]*(1.0-2.0*shade)/float(NUM_ILLUMINATION_SOURCES);}}}void combined_hillshade(vec2 deriv){deriv=deriv*u_exaggeration*2.0;float azimuth=u_azimuths[0]+PI;float cos_az=cos(azimuth);float sin_az=sin(azimuth);float cos_alt=cos(u_altitudes[0]);float sin_alt=sin(u_altitudes[0]);float cang=acos((sin_alt-(deriv.y*cos_az*cos_alt-deriv.x*sin_az*cos_alt))/sqrt(1.0+dot(deriv,deriv)));cang=clamp(cang,0.0,PI/2.0);float shade=cang*atan(length(deriv))*4.0/PI/PI;float highlight=(PI/2.0-cang)*atan(length(deriv))*4.0/PI/PI;fragColor=u_shadows[0]*shade+u_highlights[0]*highlight;}void main() {vec4 pixel=texture(u_image,v_pos);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));vec2 deriv=((pixel.rg*8.0)-4.0)/scaleFactor;if (u_method==BASIC) {basic_hillshade(deriv);} else if (u_method==COMBINED) {combined_hillshade(deriv);} else if (u_method==IGOR) {igor_hillshade(deriv);} else if (u_method==MULTIDIRECTIONAL) {multidirectional_hillshade(deriv);} else if (u_method==STANDARD) {standard_hillshade(deriv);} else {standard_hillshade(deriv);}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);v_pos=a_pos/8192.0;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),line:zt(`uniform lowp float u_device_pixel_ratio;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp float v_linesofar;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:zt(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:zt(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture(u_image,pos_a),texture(u_image,pos_b),u_fade);fragColor=color*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:zt(`uniform lowp float u_device_pixel_ratio;uniform lowp float u_lineatlas_width;uniform sampler2D u_image;uniform float u_mix;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture(u_image,v_tex_a).a;float sdfdist_b=texture(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfgamma=(u_lineatlas_width/256.0/u_device_pixel_ratio)/min(dasharray_from.w,dasharray_to.w);alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_tileratio;uniform float u_crossfade_from;uniform float u_crossfade_to;uniform float u_lineatlas_height;out vec2 v_normal;out vec2 v_width2;out vec2 v_tex_a;out vec2 v_tex_b;out float v_gamma_scale;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
float u_patternscale_a_x=u_tileratio/dasharray_from.w/u_crossfade_from;float u_patternscale_a_y=-dasharray_from.z/2.0/u_lineatlas_height;float u_patternscale_b_x=u_tileratio/dasharray_to.w/u_crossfade_to;float u_patternscale_b_y=-dasharray_to.z/2.0/u_lineatlas_height;v_tex_a=vec2(a_linesofar*u_patternscale_a_x/floorwidth,normal.y*u_patternscale_a_y+(float(dasharray_from.y)+0.5)/u_lineatlas_height);v_tex_b=vec2(a_linesofar*u_patternscale_b_x/floorwidth,normal.y*u_patternscale_b_y+(float(dasharray_to.y)+0.5)/u_lineatlas_height);v_width2=vec2(outset,inset);}`),lineGradientSDF:zt(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform sampler2D u_image_dash;uniform float u_mix;uniform lowp float u_lineatlas_width;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);float sdfdist_a=texture(u_image_dash,v_tex_a).a;float sdfdist_b=texture(u_image_dash,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfgamma=(u_lineatlas_width/256.0)/min(dasharray_from.w,dasharray_to.w);float dash_alpha=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*dash_alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;uniform float u_tileratio;uniform float u_crossfade_from;uniform float u_crossfade_to;uniform float u_lineatlas_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;out vec2 v_tex_a;out vec2 v_tex_b;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define mediump vec4 dasharray_from
#pragma mapbox: define mediump vec4 dasharray_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 dasharray_from
#pragma mapbox: initialize mediump vec4 dasharray_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;float texel_height=1.0/u_image_height;float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
float u_patternscale_a_x=u_tileratio/dasharray_from.w/u_crossfade_from;float u_patternscale_a_y=-dasharray_from.z/2.0/u_lineatlas_height;float u_patternscale_b_x=u_tileratio/dasharray_to.w/u_crossfade_to;float u_patternscale_b_y=-dasharray_to.z/2.0/u_lineatlas_height;v_tex_a=vec2(a_linesofar*u_patternscale_a_x/floorwidth,normal.y*u_patternscale_a_y+(float(dasharray_from.y)+0.5)/u_lineatlas_height);v_tex_b=vec2(a_linesofar*u_patternscale_b_x/floorwidth,normal.y*u_patternscale_b_y+(float(dasharray_to.y)+0.5)/u_lineatlas_height);v_width2=vec2(outset,inset);}`),raster:zt(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;in vec2 v_pos0;in vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture(u_image0,v_pos0);vec4 color1=texture(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);fragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;uniform vec4 u_coords_top;uniform vec4 u_coords_bottom;in vec2 a_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {vec2 fractionalPos=a_pos/8192.0;vec2 position=mix(mix(u_coords_top.xy,u_coords_top.zw,fractionalPos.x),mix(u_coords_bottom.xy,u_coords_bottom.zw,fractionalPos.x),fractionalPos.y);gl_Position=projectTile(position,position);v_pos0=((fractionalPos-0.5)/u_buffer_scale)+0.5;
#ifdef GLOBE
if (a_pos.y <-32767.5) {v_pos0.y=0.0;}if (a_pos.y > 32766.5) {v_pos0.y=1.0;}
#endif
v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),symbolIcon:zt(`uniform sampler2D u_texture;in vec2 v_tex;in float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;fragColor=texture(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_tex;out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:zt(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:zt(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;fragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map && !u_is_along_line) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:zt("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;uniform bool u_is_globe_mode;in vec2 v_texture_pos;in float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture(u_texture,vec2(v_texture_pos.x,1.0-v_texture_pos.y));if (!u_is_globe_mode && v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);fragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {fragColor=surface_color;}}","in vec3 a_pos3d;uniform mat4 u_fog_matrix;uniform float u_ele_delta;out vec2 v_texture_pos;out float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:zt("in float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {fragColor=pack(v_depth);}","in vec3 a_pos3d;uniform float u_ele_delta;out float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:zt("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;in vec2 v_texture_pos;void main() {vec4 rgba=texture(u_texture,v_texture_pos);fragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","in vec3 a_pos3d;uniform float u_ele_delta;out vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);}"),projectionErrorMeasurement:zt("in vec4 v_output_error_encoded;void main() {fragColor=v_output_error_encoded;}","in vec2 a_pos;uniform highp float u_input;uniform highp float u_output_expected;out vec4 v_output_error_encoded;void main() {float real_output=2.0*atan(exp(PI-(u_input*PI*2.0)))-PI*0.5;float error=real_output-u_output_expected;float abs_error=abs(error)*128.0;v_output_error_encoded.x=min(floor(abs_error*256.0),255.0)/255.0;abs_error-=v_output_error_encoded.x;v_output_error_encoded.y=min(floor(abs_error*65536.0),255.0)/255.0;abs_error-=v_output_error_encoded.x/255.0;v_output_error_encoded.z=min(floor(abs_error*16777216.0),255.0)/255.0;v_output_error_encoded.w=error >=0.0 ? 1.0 : 0.0;gl_Position=vec4(a_pos,0.0,1.0);}"),atmosphere:zt(`in vec3 view_direction;uniform vec3 u_sun_pos;uniform vec3 u_globe_position;uniform float u_globe_radius;uniform float u_atmosphere_blend;/**Shader use from https:*Made some change to adapt to MapLibre Globe geometry*/const float PI=3.141592653589793;const int iSteps=5;const int jSteps=3;/*radius of the planet*/const float EARTH_RADIUS=6371e3;/*radius of the atmosphere*/const float ATMOS_RADIUS=6471e3;vec2 rsi(vec3 r0,vec3 rd,float sr) {float a=dot(rd,rd);float b=2.0*dot(rd,r0);float c=dot(r0,r0)-(sr*sr);float d=(b*b)-4.0*a*c;if (d < 0.0) return vec2(1e5,-1e5);return vec2((-b-sqrt(d))/(2.0*a),(-b+sqrt(d))/(2.0*a));}vec4 atmosphere(vec3 r,vec3 r0,vec3 pSun,float iSun,float rPlanet,float rAtmos,vec3 kRlh,float kMie,float shRlh,float shMie,float g) {pSun=normalize(pSun);r=normalize(r);vec2 p=rsi(r0,r,rAtmos);if (p.x > p.y) {return vec4(0.0,0.0,0.0,1.0);}if (p.x < 0.0) {p.x=0.0;}vec3 pos=r0+r*p.x;vec2 p2=rsi(r0,r,rPlanet);if (p2.x <=p2.y && p2.x > 0.0) {p.y=min(p.y,p2.x);}float iStepSize=(p.y-p.x)/float(iSteps);float iTime=p.x+iStepSize*0.5;vec3 totalRlh=vec3(0,0,0);vec3 totalMie=vec3(0,0,0);float iOdRlh=0.0;float iOdMie=0.0;float mu=dot(r,pSun);float mumu=mu*mu;float gg=g*g;float pRlh=3.0/(16.0*PI)*(1.0+mumu);float pMie=3.0/(8.0*PI)*((1.0-gg)*(mumu+1.0))/(pow(1.0+gg-2.0*mu*g,1.5)*(2.0+gg));for (int i=0; i < iSteps; i++) {vec3 iPos=r0+r*iTime;float iHeight=length(iPos)-rPlanet;float odStepRlh=exp(-iHeight/shRlh)*iStepSize;float odStepMie=exp(-iHeight/shMie)*iStepSize;iOdRlh+=odStepRlh;iOdMie+=odStepMie;float jStepSize=rsi(iPos,pSun,rAtmos).y/float(jSteps);float jTime=jStepSize*0.5;float jOdRlh=0.0;float jOdMie=0.0;for (int j=0; j < jSteps; j++) {vec3 jPos=iPos+pSun*jTime;float jHeight=length(jPos)-rPlanet;jOdRlh+=exp(-jHeight/shRlh)*jStepSize;jOdMie+=exp(-jHeight/shMie)*jStepSize;jTime+=jStepSize;}vec3 attn=exp(-(kMie*(iOdMie+jOdMie)+kRlh*(iOdRlh+jOdRlh)));totalRlh+=odStepRlh*attn;totalMie+=odStepMie*attn;iTime+=iStepSize;}float opacity=exp(-(length(kRlh)*length(totalRlh)+kMie*length(totalMie)));vec3 color=iSun*(pRlh*kRlh*totalRlh+pMie*kMie*totalMie);return vec4(color,opacity);}void main() {vec3 scale_camera_pos=-u_globe_position*EARTH_RADIUS/u_globe_radius;vec4 color=atmosphere(normalize(view_direction),scale_camera_pos,u_sun_pos,22.0,EARTH_RADIUS,ATMOS_RADIUS,vec3(5.5e-6,13.0e-6,22.4e-6),21e-6,8e3,1.2e3,0.758
);color.rgb=1.0-exp(-1.0*color.rgb);color=pow(color,vec4(1.0/2.2));fragColor=vec4(color.rgb,1.0-color.a)*u_atmosphere_blend;}`,"in vec2 a_pos;uniform mat4 u_inv_proj_matrix;out vec3 view_direction;void main() {view_direction=(u_inv_proj_matrix*vec4(a_pos,0.0,1.0)).xyz;gl_Position=vec4(a_pos,0.0,1.0);}"),sky:zt("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform vec2 u_horizon;uniform vec2 u_horizon_normal;uniform float u_sky_horizon_blend;uniform float u_sky_blend;void main() {float x=gl_FragCoord.x;float y=gl_FragCoord.y;float blend=(y-u_horizon.y)*u_horizon_normal.y+(x-u_horizon.x)*u_horizon_normal.x;if (blend > 0.0) {if (blend < u_sky_horizon_blend) {fragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {fragColor=u_sky_color;}}fragColor=mix(fragColor,vec4(vec3(0.0),0.0),u_sky_blend);}","in vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function zt(p,t){const s=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,o=t.match(/in ([\w]+) ([\w]+)/g),u=p.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),f=t.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),_=f?f.concat(u):u,b={};return{fragmentSource:p=p.replace(s,((T,M,A,R,z)=>(b[z]=!0,M==="define"?`
#ifndef HAS_UNIFORM_u_${z}
in ${A} ${R} ${z};
#else
uniform ${A} ${R} u_${z};
#endif
`:`
#ifdef HAS_UNIFORM_u_${z}
    ${A} ${R} ${z} = u_${z};
#endif
`))),vertexSource:t=t.replace(s,((T,M,A,R,z)=>{const O=R==="float"?"vec2":"vec4",V=z.match(/color/)?"color":O;return b[z]?M==="define"?`
#ifndef HAS_UNIFORM_u_${z}
uniform lowp float u_${z}_t;
in ${A} ${O} a_${z};
out ${A} ${R} ${z};
#else
uniform ${A} ${R} u_${z};
#endif
`:V==="vec4"?`
#ifndef HAS_UNIFORM_u_${z}
    ${z} = a_${z};
#else
    ${A} ${R} ${z} = u_${z};
#endif
`:`
#ifndef HAS_UNIFORM_u_${z}
    ${z} = unpack_mix_${V}(a_${z}, u_${z}_t);
#else
    ${A} ${R} ${z} = u_${z};
#endif
`:M==="define"?`
#ifndef HAS_UNIFORM_u_${z}
uniform lowp float u_${z}_t;
in ${A} ${O} a_${z};
#else
uniform ${A} ${R} u_${z};
#endif
`:V==="vec4"?`
#ifndef HAS_UNIFORM_u_${z}
    ${A} ${R} ${z} = a_${z};
#else
    ${A} ${R} ${z} = u_${z};
#endif
`:`
#ifndef HAS_UNIFORM_u_${z}
    ${A} ${R} ${z} = unpack_mix_${V}(a_${z}, u_${z}_t);
#else
    ${A} ${R} ${z} = u_${z};
#endif
`})),staticAttributes:o,staticUniforms:_}}class yr{constructor(t,s,o){this.vertexBuffer=t,this.indexBuffer=s,this.segments=o}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}var pn=l.aU([{name:"a_pos",type:"Int16",components:2}]);const Vi="#define PROJECTION_MERCATOR",rs="mercator";class $i{constructor(){this._cachedMesh=null}get name(){return"mercator"}get useSubdivision(){return!1}get shaderVariantName(){return rs}get shaderDefine(){return Vi}get shaderPreludeCode(){return Or.projectionMercator}get vertexShaderPreludeCode(){return Or.projectionMercator.vertexSource}get subdivisionGranularity(){return l.aV.noSubdivision}get useGlobeControls(){return!1}get transitionState(){return 0}get latitudeErrorCorrectionRadians(){return 0}destroy(){}updateGPUdependent(t){}getMeshFromTileID(t,s,o,u,f){if(this._cachedMesh)return this._cachedMesh;const _=new l.aW;_.emplaceBack(0,0),_.emplaceBack(l.a5,0),_.emplaceBack(0,l.a5),_.emplaceBack(l.a5,l.a5);const b=t.createVertexBuffer(_,pn.members),T=l.aX.simpleSegment(0,0,4,2),M=new l.aY;M.emplaceBack(1,0,2),M.emplaceBack(1,2,3);const A=t.createIndexBuffer(M);return this._cachedMesh=new yr(b,A,T),this._cachedMesh}recalculate(){}hasTransition(){return!1}setErrorQueryLatitudeDegrees(t){}}class oo{constructor(t=0,s=0,o=0,u=0){if(isNaN(t)||t<0||isNaN(s)||s<0||isNaN(o)||o<0||isNaN(u)||u<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=s,this.left=o,this.right=u}interpolate(t,s,o){return s.top!=null&&t.top!=null&&(this.top=l.G.number(t.top,s.top,o)),s.bottom!=null&&t.bottom!=null&&(this.bottom=l.G.number(t.bottom,s.bottom,o)),s.left!=null&&t.left!=null&&(this.left=l.G.number(t.left,s.left,o)),s.right!=null&&t.right!=null&&(this.right=l.G.number(t.right,s.right,o)),this}getCenter(t,s){const o=l.an((this.left+t-this.right)/2,0,t),u=l.an((this.top+s-this.bottom)/2,0,s);return new l.P(o,u)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new oo(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function fn(p,t){if(!p.renderWorldCopies||p.lngRange)return;const s=t.lng-p.center.lng;t.lng+=s>180?-360:s<-180?360:0}function Xr(p){return Math.max(0,Math.floor(p))}class kn{constructor(t,s){var o;this.applyConstrain=(u,f)=>this._constrainOverride!==null?this._constrainOverride(u,f):this._callbacks.defaultConstrain(u,f),this._callbacks=t,this._tileSize=512,this._renderWorldCopies=s?.renderWorldCopies===void 0||!!s?.renderWorldCopies,this._minZoom=s?.minZoom||0,this._maxZoom=s?.maxZoom||22,this._minPitch=s?.minPitch==null?0:s?.minPitch,this._maxPitch=s?.maxPitch==null?60:s?.maxPitch,this._constrainOverride=(o=s?.constrainOverride)!==null&&o!==void 0?o:null,this.setMaxBounds(),this._width=0,this._height=0,this._center=new l.V(0,0),this._elevation=0,this._zoom=0,this._tileZoom=Xr(this._zoom),this._scale=l.aq(this._zoom),this._bearingInRadians=0,this._fovInRadians=.6435011087932844,this._pitchInRadians=0,this._rollInRadians=0,this._unmodified=!0,this._edgeInsets=new oo,this._minElevationForCurrentTile=0,this._autoCalculateNearFarZ=!0}apply(t,s,o){this._constrainOverride=t.constrainOverride,this._latRange=t.latRange,this._lngRange=t.lngRange,this._width=t.width,this._height=t.height,this._center=t.center,this._elevation=t.elevation,this._minElevationForCurrentTile=t.minElevationForCurrentTile,this._zoom=t.zoom,this._tileZoom=Xr(this._zoom),this._scale=l.aq(this._zoom),this._bearingInRadians=t.bearingInRadians,this._fovInRadians=t.fovInRadians,this._pitchInRadians=t.pitchInRadians,this._rollInRadians=t.rollInRadians,this._unmodified=t.unmodified,this._edgeInsets=new oo(t.padding.top,t.padding.bottom,t.padding.left,t.padding.right),this._minZoom=t.minZoom,this._maxZoom=t.maxZoom,this._minPitch=t.minPitch,this._maxPitch=t.maxPitch,this._renderWorldCopies=t.renderWorldCopies,this._cameraToCenterDistance=t.cameraToCenterDistance,this._nearZ=t.nearZ,this._farZ=t.farZ,this._autoCalculateNearFarZ=!o&&t.autoCalculateNearFarZ,s&&this.constrainInternal(),this._calcMatrices()}get pixelsToClipSpaceMatrix(){return this._pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._clipSpaceToPixelsMatrix}get minElevationForCurrentTile(){return this._minElevationForCurrentTile}setMinElevationForCurrentTile(t){this._minElevationForCurrentTile=t}get tileSize(){return this._tileSize}get tileZoom(){return this._tileZoom}get scale(){return this._scale}get width(){return this._width}get height(){return this._height}get bearingInRadians(){return this._bearingInRadians}get lngRange(){return this._lngRange}get latRange(){return this._latRange}get pixelsToGLUnits(){return this._pixelsToGLUnits}get minZoom(){return this._minZoom}setMinZoom(t){this._minZoom!==t&&(this._minZoom=t,this.setZoom(this.applyConstrain(this._center,this.zoom).zoom))}get maxZoom(){return this._maxZoom}setMaxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.setZoom(this.applyConstrain(this._center,this.zoom).zoom))}get minPitch(){return this._minPitch}setMinPitch(t){this._minPitch!==t&&(this._minPitch=t,this.setPitch(Math.max(this.pitch,t)))}get maxPitch(){return this._maxPitch}setMaxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.setPitch(Math.min(this.pitch,t)))}get renderWorldCopies(){return this._renderWorldCopies}setRenderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get constrainOverride(){return this._constrainOverride}setConstrainOverride(t){t===void 0&&(t=null),this._constrainOverride!==t&&(this._constrainOverride=t,this.constrainInternal(),this._calcMatrices())}get worldSize(){return this._tileSize*this._scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new l.P(this._width,this._height)}get bearing(){return this._bearingInRadians/Math.PI*180}setBearing(t){const s=l.W(t,-180,180)*Math.PI/180;var o,u,f,_,b,T,M,A,R;this._bearingInRadians!==s&&(this._unmodified=!1,this._bearingInRadians=s,this._calcMatrices(),this._rotationMatrix=oe(),o=this._rotationMatrix,f=-this._bearingInRadians,_=(u=this._rotationMatrix)[0],b=u[1],T=u[2],M=u[3],A=Math.sin(f),R=Math.cos(f),o[0]=_*R+T*A,o[1]=b*R+M*A,o[2]=_*-A+T*R,o[3]=b*-A+M*R)}get rotationMatrix(){return this._rotationMatrix}get pitchInRadians(){return this._pitchInRadians}get pitch(){return this._pitchInRadians/Math.PI*180}setPitch(t){const s=l.an(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitchInRadians!==s&&(this._unmodified=!1,this._pitchInRadians=s,this._calcMatrices())}get rollInRadians(){return this._rollInRadians}get roll(){return this._rollInRadians/Math.PI*180}setRoll(t){const s=t/180*Math.PI;this._rollInRadians!==s&&(this._unmodified=!1,this._rollInRadians=s,this._calcMatrices())}get fovInRadians(){return this._fovInRadians}get fov(){return l.aZ(this._fovInRadians)}setFov(t){t=l.an(t,.1,150),this.fov!==t&&(this._unmodified=!1,this._fovInRadians=l.ap(t),this._calcMatrices())}get zoom(){return this._zoom}setZoom(t){const s=this.applyConstrain(this._center,t).zoom;this._zoom!==s&&(this._unmodified=!1,this._zoom=s,this._tileZoom=Math.max(0,Math.floor(s)),this._scale=l.aq(s),this.constrainInternal(),this._calcMatrices())}get center(){return this._center}setCenter(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this.constrainInternal(),this._calcMatrices())}get elevation(){return this._elevation}setElevation(t){t!==this._elevation&&(this._elevation=t,this.constrainInternal(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}setPadding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this._width,this._height)}get pixelsPerMeter(){return this._pixelPerMeter}get unmodified(){return this._unmodified}get cameraToCenterDistance(){return this._cameraToCenterDistance}get nearZ(){return this._nearZ}get farZ(){return this._farZ}get autoCalculateNearFarZ(){return this._autoCalculateNearFarZ}overrideNearFarZ(t,s){this._autoCalculateNearFarZ=!1,this._nearZ=t,this._farZ=s,this._calcMatrices()}clearNearFarZOverride(){this._autoCalculateNearFarZ=!0,this._calcMatrices()}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,s,o){this._unmodified=!1,this._edgeInsets.interpolate(t,s,o),this.constrainInternal(),this._calcMatrices()}resize(t,s,o=!0){this._width=t,this._height=s,o&&this.constrainInternal(),this._calcMatrices()}getMaxBounds(){return this._latRange&&this._latRange.length===2&&this._lngRange&&this._lngRange.length===2?new Mr([this._lngRange[0],this._latRange[0]],[this._lngRange[1],this._latRange[1]]):null}setMaxBounds(t){t?(this._lngRange=[t.getWest(),t.getEast()],this._latRange=[t.getSouth(),t.getNorth()],this.constrainInternal()):(this._lngRange=null,this._latRange=[-l.ao,l.ao])}getCameraQueryGeometry(t,s){if(s.length===1)return[s[0],t];{const{minX:o,minY:u,maxX:f,maxY:_}=l.aa.fromPoints(s).extend(t);return[new l.P(o,u),new l.P(f,u),new l.P(f,_),new l.P(o,_),new l.P(o,u)]}}constrainInternal(){if(!this.center||!this._width||!this._height||this._constraining)return;this._constraining=!0;const t=this._unmodified,{center:s,zoom:o}=this.applyConstrain(this.center,this.zoom);this.setCenter(s),this.setZoom(o),this._unmodified=t,this._constraining=!1}_calcMatrices(){if(this._width&&this._height){this._pixelsToGLUnits=[2/this._width,-2/this._height];let t=l.ar(new Float64Array(16));l.Q(t,t,[this._width/2,-this._height/2,1]),l.O(t,t,[1,-1,0]),this._clipSpaceToPixelsMatrix=t,t=l.ar(new Float64Array(16)),l.Q(t,t,[1,-1,1]),l.O(t,t,[-1,-1,0]),l.Q(t,t,[2/this._width,2/this._height,1]),this._pixelsToClipSpaceMatrix=t,this._cameraToCenterDistance=.5/Math.tan(this.fovInRadians/2)*this._height}this._callbacks.calcMatrices()}calculateCenterFromCameraLngLatAlt(t,s,o,u){const f=o!==void 0?o:this.bearing,_=u=u!==void 0?u:this.pitch,{distanceToCenter:b,clampedElevation:T}=this._distanceToCenterFromAltElevationPitch(s,this.elevation,_),{x:M,y:A}=dr(_,f),R=l.a9.fromLngLat(t,s);let z,O,V=l.a_(1,R.y),W=0;do{if(W+=1,W>10)break;O=b/V,z=new l.a9(R.x+M*O,R.y+A*O),V=1/z.meterInMercatorCoordinateUnits()}while(Math.abs(b-O*V)>1e-12);return{center:z.toLngLat(),elevation:T,zoom:l.at(this.height/2/Math.tan(this.fovInRadians/2)/O/this.tileSize)}}recalculateZoomAndCenter(t){if(this.elevation-t==0)return;const s=1/this.worldSize,o=l.as(1,this.center.lat)*this.worldSize,u=l.a9.fromLngLat(this.center,this.elevation),f=u.x/s,_=u.y/s,b=u.z/s,T=this.pitch,M=this.bearing,{x:A,y:R,z}=dr(T,M),O=this.cameraToCenterDistance,V=f+O*-A,W=_+O*-R,Y=b+O*z,{distanceToCenter:X,clampedElevation:te}=this._distanceToCenterFromAltElevationPitch(Y/o,t,T),le=X*o,Q=new l.a9((V+A*le)*s,(W+R*le)*s,0).toLngLat(),ne=l.as(1,Q.lat),ue=l.at(this.height/2/Math.tan(this.fovInRadians/2)/X/ne/this.tileSize);this._elevation=te,this._center=Q,this.setZoom(ue)}_distanceToCenterFromAltElevationPitch(t,s,o){const u=-Math.cos(l.ap(o)),f=t-s;let _,b=s;return u*f>=0||Math.abs(u)<.1?(_=1e4,b=t+_*u):_=-f/u,{distanceToCenter:_,clampedElevation:b}}getCameraPoint(){const t=Math.tan(this.pitchInRadians)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new l.P(t*Math.sin(this.rollInRadians),t*Math.cos(this.rollInRadians)))}getCameraAltitude(){return Math.cos(this.pitchInRadians)*this._cameraToCenterDistance/this._pixelPerMeter+this.elevation}getCameraLngLat(){const t=l.as(1,this.center.lat)*this.worldSize;return Se(this.center,this.elevation,this.pitch,this.bearing,this.cameraToCenterDistance/t).toLngLat()}getMercatorTileCoordinates(t){if(!t)return[0,0,1,1];const s=t.canonical.z>=0?1<<t.canonical.z:Math.pow(2,t.canonical.z);return[t.canonical.x/s,t.canonical.y/s,1/s/l.a5,1/s/l.a5]}}class Ns{constructor(t,s){this.min=t,this.max=s,this.center=l.a$([],l.b0([],this.min,this.max),.5)}quadrant(t){const s=[t%2==0,t<2],o=l.b1(this.min),u=l.b1(this.max);for(let f=0;f<s.length;f++)o[f]=s[f]?this.min[f]:this.center[f],u[f]=s[f]?this.center[f]:this.max[f];return u[2]=this.max[2],new Ns(o,u)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}intersectsFrustum(t){let s=!0;for(let o=0;o<t.planes.length;o++){const u=this.intersectsPlane(t.planes[o]);if(u===0)return 0;u===1&&(s=!1)}return s?2:t.aabb.min[0]>this.max[0]||t.aabb.min[1]>this.max[1]||t.aabb.min[2]>this.max[2]||t.aabb.max[0]<this.min[0]||t.aabb.max[1]<this.min[1]||t.aabb.max[2]<this.min[2]?0:1}intersectsPlane(t){let s=t[3],o=t[3];for(let u=0;u<3;u++)t[u]>0?(s+=t[u]*this.min[u],o+=t[u]*this.max[u]):(o+=t[u]*this.min[u],s+=t[u]*this.max[u]);return s>=0?2:o<0?0:1}}class Ba{distanceToTile2d(t,s,o,u){const f=u.distanceX([t,s]),_=u.distanceY([t,s]);return Math.hypot(f,_)}getWrap(t,s,o){return o}getTileBoundingVolume(t,s,o,u){var f,_;let b=0,T=0;if(u?.terrain){const A=new l.a2(t.z,s,t.z,t.x,t.y),R=u.terrain.getMinMaxElevation(A);b=(f=R.minElevation)!==null&&f!==void 0?f:Math.min(0,o),T=(_=R.maxElevation)!==null&&_!==void 0?_:Math.max(0,o)}const M=1<<t.z;return new Ns([s+t.x/M,t.y/M,b],[s+(t.x+1)/M,(t.y+1)/M,T])}allowVariableZoom(t,s){const o=t.fov*(Math.abs(Math.cos(t.rollInRadians))*t.height+Math.abs(Math.sin(t.rollInRadians))*t.width)/t.height,u=l.an(78.5-o/2,0,60);return!!s.terrain||t.pitch>u}allowWorldCopies(){return!0}prepareNextFrame(){}}class Ki{constructor(t,s,o){this.points=t,this.planes=s,this.aabb=o}static fromInvProjectionMatrix(t,s=1,o=0,u,f){const _=f?[[6,5,4],[0,1,2],[0,3,7],[2,1,5],[3,2,6],[0,4,5]]:[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]],b=Math.pow(2,o),T=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((z=>(function(O,V,W,Y){const X=l.aH([],O,V),te=1/X[3]/W*Y;return l.b6(X,X,[te,te,1/X[3],te])})(z,t,s,b)));u&&(function(z,O,V,W){const Y=W?4:0,X=W?0:4;let te=0;const le=[],Q=[];for(let ie=0;ie<4;ie++){const pe=l.b2([],z[ie+X],z[ie+Y]),Ce=l.b7(pe);l.a$(pe,pe,1/Ce),le.push(Ce),Q.push(pe)}for(let ie=0;ie<4;ie++){const pe=l.b8(z[ie+Y],Q[ie],V);te=pe!==null&&pe>=0?Math.max(te,pe):Math.max(te,le[ie])}const ne=(function(ie,pe){const Ce=l.b2([],ie[pe[0]],ie[pe[1]]),Pe=l.b2([],ie[pe[2]],ie[pe[1]]),Me=[0,0,0,0];return l.b3(Me,l.b4([],Ce,Pe)),Me[3]=-l.b5(Me,ie[pe[0]]),Me})(z,O),ue=(function(ie,pe){const Ce=l.b9(ie),Pe=l.ba([],ie,1/Ce),Me=l.b2([],pe,l.a$([],Pe,l.b5(pe,Pe))),Ie=l.b9(Me);if(Ie>0){const Xe=Math.sqrt(1-Pe[3]*Pe[3]),Je=l.a$([],Pe,-Pe[3]),$e=l.b0([],Je,l.a$([],Me,Xe/Ie));return l.bb(pe,$e)}return null})(V,ne);if(ue!==null){const ie=ue/l.b5(Q[0],ne);te=Math.min(te,ie)}for(let ie=0;ie<4;ie++){const pe=Math.min(te,le[ie]);z[ie+X]=[z[ie+Y][0]+Q[ie][0]*pe,z[ie+Y][1]+Q[ie][1]*pe,z[ie+Y][2]+Q[ie][2]*pe,1]}})(T,_[0],u,f);const M=_.map((z=>{const O=l.b2([],T[z[0]],T[z[1]]),V=l.b2([],T[z[2]],T[z[1]]),W=l.b3([],l.b4([],O,V)),Y=-l.b5(W,T[z[1]]);return W.concat(Y)})),A=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],R=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(const z of T)for(let O=0;O<3;O++)A[O]=Math.min(A[O],z[O]),R[O]=Math.max(R[O],z[O]);return new Ki(T,M,new Ns(A,R))}}class Dn{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(t){this._helper.setMinZoom(t)}setMaxZoom(t){this._helper.setMaxZoom(t)}setMinPitch(t){this._helper.setMinPitch(t)}setMaxPitch(t){this._helper.setMaxPitch(t)}setRenderWorldCopies(t){this._helper.setRenderWorldCopies(t)}setBearing(t){this._helper.setBearing(t)}setPitch(t){this._helper.setPitch(t)}setRoll(t){this._helper.setRoll(t)}setFov(t){this._helper.setFov(t)}setZoom(t){this._helper.setZoom(t)}setCenter(t){this._helper.setCenter(t)}setElevation(t){this._helper.setElevation(t)}setMinElevationForCurrentTile(t){this._helper.setMinElevationForCurrentTile(t)}setPadding(t){this._helper.setPadding(t)}interpolatePadding(t,s,o){return this._helper.interpolatePadding(t,s,o)}isPaddingEqual(t){return this._helper.isPaddingEqual(t)}resize(t,s,o=!0){this._helper.resize(t,s,o)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(t){this._helper.setMaxBounds(t)}setConstrainOverride(t){this._helper.setConstrainOverride(t)}overrideNearFarZ(t,s){this._helper.overrideNearFarZ(t,s)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(t){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),t)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(t,s){}constructor(t){this._posMatrixCache=new Map,this._alignedPosMatrixCache=new Map,this._fogMatrixCacheF32=new Map,this.defaultConstrain=(s,o)=>{o=l.an(+o,this.minZoom,this.maxZoom);const u={center:new l.V(s.lng,s.lat),zoom:o};let f=this._helper._lngRange;if(!this._helper._renderWorldCopies&&f===null){const Q=179.9999999999;f=[-Q,Q]}const _=this.tileSize*l.aq(u.zoom);let b=0,T=_,M=0,A=_,R=0,z=0;const{x:O,y:V}=this.size;if(this._helper._latRange){const Q=this._helper._latRange;b=l.X(Q[1])*_,T=l.X(Q[0])*_,T-b<V&&(R=V/(T-b))}f&&(M=l.W(l.Y(f[0])*_,0,_),A=l.W(l.Y(f[1])*_,0,_),A<M&&(A+=_),A-M<O&&(z=O/(A-M)));const{x:W,y:Y}=ft(_,s);let X,te;const le=Math.max(z||0,R||0);if(le){const Q=new l.P(z?(A+M)/2:W,R?(T+b)/2:Y);return u.center=kt(_,Q).wrap(),u.zoom+=l.at(le),u}if(this._helper._latRange){const Q=V/2;Y-Q<b&&(te=b+Q),Y+Q>T&&(te=T-Q)}if(f){const Q=(M+A)/2;let ne=W;this._helper._renderWorldCopies&&(ne=l.W(W,Q-_/2,Q+_/2));const ue=O/2;ne-ue<M&&(X=M+ue),ne+ue>A&&(X=A-ue)}if(X!==void 0||te!==void 0){const Q=new l.P(X??W,te??Y);u.center=kt(_,Q).wrap()}return u},this.applyConstrain=(s,o)=>this._helper.applyConstrain(s,o),this._helper=new kn({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(s,o)=>this.defaultConstrain(s,o)},t),this._coveringTilesDetailsProvider=new Ba}clone(){const t=new Dn;return t.apply(this),t}apply(t,s,o){this._helper.apply(t,s,o)}get cameraPosition(){return this._cameraPosition}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._viewProjMatrix}get inverseProjectionMatrix(){return this._invProjMatrix}get mercatorMatrix(){return this._mercatorMatrix}getVisibleUnwrappedCoordinates(t){const s=[new l.bc(0,t)];if(this._helper._renderWorldCopies){const o=this.screenPointToMercatorCoordinate(new l.P(0,0)),u=this.screenPointToMercatorCoordinate(new l.P(this._helper._width,0)),f=this.screenPointToMercatorCoordinate(new l.P(this._helper._width,this._helper._height)),_=this.screenPointToMercatorCoordinate(new l.P(0,this._helper._height)),b=Math.floor(Math.min(o.x,u.x,f.x,_.x)),T=Math.floor(Math.max(o.x,u.x,f.x,_.x)),M=1;for(let A=b-M;A<=T+M;A++)A!==0&&s.push(new l.bc(A,t))}return s}getCameraFrustum(){return Ki.fromInvProjectionMatrix(this._invViewProjMatrix,this.worldSize)}getClippingPlane(){return null}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(t){const s=this.screenPointToLocation(this.centerPoint,t),o=t?t.getElevationForLngLatZoom(s,this._helper._tileZoom):0;this._helper.recalculateZoomAndCenter(o)}setLocationAtPoint(t,s){const o=l.as(this.elevation,this.center.lat),u=this.screenPointToMercatorCoordinateAtZ(s,o),f=this.screenPointToMercatorCoordinateAtZ(this.centerPoint,o),_=l.a9.fromLngLat(t),b=new l.a9(_.x-(u.x-f.x),_.y-(u.y-f.y));this.setCenter(b?.toLngLat()),this._helper._renderWorldCopies&&this.setCenter(this.center.wrap())}locationToScreenPoint(t,s){return s?this.coordinatePoint(l.a9.fromLngLat(t),s.getElevationForLngLat(t,this),this._pixelMatrix3D):this.coordinatePoint(l.a9.fromLngLat(t))}screenPointToLocation(t,s){var o;return(o=this.screenPointToMercatorCoordinate(t,s))===null||o===void 0?void 0:o.toLngLat()}screenPointToMercatorCoordinate(t,s){if(s){const o=s.pointCoordinate(t);if(o!=null)return o}return this.screenPointToMercatorCoordinateAtZ(t)}screenPointToMercatorCoordinateAtZ(t,s){const o=s||0,u=[t.x,t.y,0,1],f=[t.x,t.y,1,1];l.aH(u,u,this._pixelMatrixInverse),l.aH(f,f,this._pixelMatrixInverse);const _=u[3],b=f[3],T=u[1]/_,M=f[1]/b,A=u[2]/_,R=f[2]/b,z=A===R?0:(o-A)/(R-A);return new l.a9(l.G.number(u[0]/_,f[0]/b,z)/this.worldSize,l.G.number(T,M,z)/this.worldSize,o)}coordinatePoint(t,s=0,o=this._pixelMatrix){const u=[t.x*this.worldSize,t.y*this.worldSize,s,1];return l.aH(u,u,o),new l.P(u[0]/u[3],u[1]/u[3])}getBounds(){const t=Math.max(0,this._helper._height/2-nr(this));return new Mr().extend(this.screenPointToLocation(new l.P(0,t))).extend(this.screenPointToLocation(new l.P(this._helper._width,t))).extend(this.screenPointToLocation(new l.P(this._helper._width,this._helper._height))).extend(this.screenPointToLocation(new l.P(0,this._helper._height)))}isPointOnMapSurface(t,s){return s?s.pointCoordinate(t)!=null:t.y>this.height/2-nr(this)}calculatePosMatrix(t,s=!1,o){var u;const f=(u=t.key)!==null&&u!==void 0?u:l.bd(t.wrap,t.canonical.z,t.canonical.z,t.canonical.x,t.canonical.y),_=s?this._alignedPosMatrixCache:this._posMatrixCache;if(_.has(f)){const M=_.get(f);return o?M.f32:M.f64}const b=er(t,this.worldSize);l.S(b,s?this._alignedProjMatrix:this._viewProjMatrix,b);const T={f64:b,f32:new Float32Array(b)};return _.set(f,T),o?T.f32:T.f64}calculateFogMatrix(t){const s=t.key,o=this._fogMatrixCacheF32;if(o.has(s))return o.get(s);const u=er(t,this.worldSize);return l.S(u,this._fogMatrix,u),o.set(s,new Float32Array(u)),o.get(s)}calculateCenterFromCameraLngLatAlt(t,s,o,u){return this._helper.calculateCenterFromCameraLngLatAlt(t,s,o,u)}_calculateNearFarZIfNeeded(t,s,o){if(!this._helper.autoCalculateNearFarZ)return;const u=Math.min(this.elevation,this.minElevationForCurrentTile,this.getCameraAltitude()-100),f=t-u*this._helper._pixelPerMeter/Math.cos(s),_=u<0?f:t,b=Math.PI/2+this.pitchInRadians,T=l.ap(this.fov)*(Math.abs(Math.cos(l.ap(this.roll)))*this.height+Math.abs(Math.sin(l.ap(this.roll)))*this.width)/this.height*(.5+o.y/this.height),M=Math.sin(T)*_/Math.sin(l.an(Math.PI-b-T,.01,Math.PI-.01)),A=nr(this),R=Math.atan(A/this._helper.cameraToCenterDistance),z=l.ap(.75),O=R>z?2*R*(.5+o.y/(2*A)):z,V=Math.sin(O)*_/Math.sin(l.an(Math.PI-b-O,.01,Math.PI-.01)),W=Math.min(M,V);this._helper._farZ=1.01*(Math.cos(Math.PI/2-s)*W+_),this._helper._nearZ=this._helper._height/50}_calcMatrices(){if(!this._helper._height)return;const t=this.centerOffset,s=ft(this.worldSize,this.center),o=s.x,u=s.y;this._helper._pixelPerMeter=l.as(1,this.center.lat)*this.worldSize;const f=l.ap(Math.min(this.pitch,at)),_=Math.max(this._helper.cameraToCenterDistance/2,this._helper.cameraToCenterDistance+this._helper._elevation*this._helper._pixelPerMeter/Math.cos(f));let b;this._calculateNearFarZIfNeeded(_,f,t),b=new Float64Array(16),l.be(b,this.fovInRadians,this._helper._width/this._helper._height,this._helper._nearZ,this._helper._farZ),this._invProjMatrix=new Float64Array(16),l.aB(this._invProjMatrix,b),b[8]=2*-t.x/this._helper._width,b[9]=2*t.y/this._helper._height,this._projectionMatrix=l.bf(b),l.Q(b,b,[1,-1,1]),l.O(b,b,[0,0,-this._helper.cameraToCenterDistance]),l.bg(b,b,-this.rollInRadians),l.bh(b,b,this.pitchInRadians),l.bg(b,b,-this.bearingInRadians),l.O(b,b,[-o,-u,0]),this._mercatorMatrix=l.Q([],b,[this.worldSize,this.worldSize,this.worldSize]),l.Q(b,b,[1,1,this._helper._pixelPerMeter]),this._pixelMatrix=l.S(new Float64Array(16),this.clipSpaceToPixelsMatrix,b),l.O(b,b,[0,0,-this.elevation]),this._viewProjMatrix=b,this._invViewProjMatrix=l.aB([],b);const T=[0,0,-1,1];l.aH(T,T,this._invViewProjMatrix),this._cameraPosition=[T[0]/T[3],T[1]/T[3],T[2]/T[3]],this._fogMatrix=new Float64Array(16),l.be(this._fogMatrix,this.fovInRadians,this.width/this.height,_,this._helper._farZ),this._fogMatrix[8]=2*-t.x/this.width,this._fogMatrix[9]=2*t.y/this.height,l.Q(this._fogMatrix,this._fogMatrix,[1,-1,1]),l.O(this._fogMatrix,this._fogMatrix,[0,0,-this.cameraToCenterDistance]),l.bg(this._fogMatrix,this._fogMatrix,-this.rollInRadians),l.bh(this._fogMatrix,this._fogMatrix,this.pitchInRadians),l.bg(this._fogMatrix,this._fogMatrix,-this.bearingInRadians),l.O(this._fogMatrix,this._fogMatrix,[-o,-u,0]),l.Q(this._fogMatrix,this._fogMatrix,[1,1,this._helper._pixelPerMeter]),l.O(this._fogMatrix,this._fogMatrix,[0,0,-this.elevation]),this._pixelMatrix3D=l.S(new Float64Array(16),this.clipSpaceToPixelsMatrix,b);const M=this._helper._width%2/2,A=this._helper._height%2/2,R=Math.cos(this.bearingInRadians),z=Math.sin(-this.bearingInRadians),O=o-Math.round(o)+R*M+z*A,V=u-Math.round(u)+R*A+z*M,W=new Float64Array(b);if(l.O(W,W,[O>.5?O-1:O,V>.5?V-1:V,0]),this._alignedProjMatrix=W,b=l.aB(new Float64Array(16),this._pixelMatrix),!b)throw new Error("failed to invert matrix");this._pixelMatrixInverse=b,this._clearMatrixCaches()}_clearMatrixCaches(){this._posMatrixCache.clear(),this._alignedPosMatrixCache.clear(),this._fogMatrixCacheF32.clear()}maxPitchScaleFactor(){if(!this._pixelMatrixInverse)return 1;const t=this.screenPointToMercatorCoordinate(new l.P(0,0)),s=[t.x*this.worldSize,t.y*this.worldSize,0,1];return l.aH(s,s,this._pixelMatrix)[3]/this._helper.cameraToCenterDistance}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){const t=l.as(1,this.center.lat)*this.worldSize;return Se(this.center,this.elevation,this.pitch,this.bearing,this._helper.cameraToCenterDistance/t).toLngLat()}lngLatToCameraDepth(t,s){const o=l.a9.fromLngLat(t),u=[o.x*this.worldSize,o.y*this.worldSize,s,1];return l.aH(u,u,this._viewProjMatrix),u[2]/u[3]}getProjectionData(t){const{overscaledTileID:s,aligned:o,applyTerrainMatrix:u}=t,f=this._helper.getMercatorTileCoordinates(s),_=s?this.calculatePosMatrix(s,o,!0):null;let b;return b=s&&s.terrainRttPosMatrix32f&&u?s.terrainRttPosMatrix32f:_||l.bi(),{mainMatrix:b,tileMercatorCoords:f,clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:b}}isLocationOccluded(t){return!1}getPixelScale(){return 1}getCircleRadiusCorrection(){return 1}getPitchedTextCorrection(t,s,o){return 1}transformLightDirection(t){return l.b1(t)}getRayDirectionFromPixel(t){throw new Error("Not implemented.")}projectTileCoordinates(t,s,o,u){const f=this.calculatePosMatrix(o);let _;u?(_=[t,s,u(t,s),1],l.aH(_,_,f)):(_=[t,s,0,1],Fa(_,_,f));const b=_[3];return{point:new l.P(_[0]/b,_[1]/b),signedDistanceFromCamera:b,isOccluded:!1}}populateCache(t){for(const s of t)this.calculatePosMatrix(s)}getMatrixForModel(t,s){const o=l.a9.fromLngLat(t,s),u=o.meterInMercatorCoordinateUnits(),f=l.bj();return l.O(f,f,[o.x,o.y,o.z]),l.bg(f,f,Math.PI),l.bh(f,f,Math.PI/2),l.Q(f,f,[-u,u,u]),f}getProjectionDataForCustomLayer(t=!0){const s=new l.a2(0,0,0,0,0),o=this.getProjectionData({overscaledTileID:s,applyGlobeMatrix:t}),u=er(s,this.worldSize);l.S(u,this._viewProjMatrix,u),o.tileMercatorCoords=[0,0,1,1];const f=[l.a5,l.a5,this.worldSize/this._helper.pixelsPerMeter],_=l.bk();return l.Q(_,u,f),o.fallbackMatrix=_,o.mainMatrix=_,o}getFastPathSimpleProjectionMatrix(t){return this.calculatePosMatrix(t)}}function Xs(){l.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}function Fu(p){if(p.useSlerp)if(p.k<1){const t=l.bl(p.startEulerAngles.roll,p.startEulerAngles.pitch,p.startEulerAngles.bearing),s=l.bl(p.endEulerAngles.roll,p.endEulerAngles.pitch,p.endEulerAngles.bearing),o=new Float64Array(4);l.bm(o,t,s,p.k);const u=l.bn(o);p.tr.setRoll(u.roll),p.tr.setPitch(u.pitch),p.tr.setBearing(u.bearing)}else p.tr.setRoll(p.endEulerAngles.roll),p.tr.setPitch(p.endEulerAngles.pitch),p.tr.setBearing(p.endEulerAngles.bearing);else p.tr.setRoll(l.G.number(p.startEulerAngles.roll,p.endEulerAngles.roll,p.k)),p.tr.setPitch(l.G.number(p.startEulerAngles.pitch,p.endEulerAngles.pitch,p.k)),p.tr.setBearing(l.G.number(p.startEulerAngles.bearing,p.endEulerAngles.bearing,p.k))}function nc(p,t,s,o,u){const f=u.padding,_=ft(u.worldSize,s.getNorthWest()),b=ft(u.worldSize,s.getNorthEast()),T=ft(u.worldSize,s.getSouthEast()),M=ft(u.worldSize,s.getSouthWest()),A=l.ap(-o),R=_.rotate(A),z=b.rotate(A),O=T.rotate(A),V=M.rotate(A),W=new l.P(Math.max(R.x,z.x,V.x,O.x),Math.max(R.y,z.y,V.y,O.y)),Y=new l.P(Math.min(R.x,z.x,V.x,O.x),Math.min(R.y,z.y,V.y,O.y)),X=W.sub(Y),te=(u.width-(f.left+f.right+t.left+t.right))/X.x,le=(u.height-(f.top+f.bottom+t.top+t.bottom))/X.y;if(le<0||te<0)return void Xs();const Q=Math.min(l.at(u.scale*Math.min(te,le)),p.maxZoom),ne=l.P.convert(p.offset),ue=new l.P((t.left-t.right)/2,(t.top-t.bottom)/2).rotate(l.ap(o)),ie=ne.add(ue).mult(u.scale/l.aq(Q));return{center:kt(u.worldSize,_.add(T).div(2).sub(ie)),zoom:Q,bearing:o}}class zn{get useGlobeControls(){return!1}handlePanInertia(t,s){const o=t.mag(),u=Math.abs(nr(s));return{easingOffset:t.mult(Math.min(.75*u/o,1)),easingCenter:s.center}}handleMapControlsRollPitchBearingZoom(t,s){t.bearingDelta&&s.setBearing(s.bearing+t.bearingDelta),t.pitchDelta&&s.setPitch(s.pitch+t.pitchDelta),t.rollDelta&&s.setRoll(s.roll+t.rollDelta),t.zoomDelta&&s.setZoom(s.zoom+t.zoomDelta)}handleMapControlsPan(t,s,o){t.around.distSqr(s.centerPoint)<.01||s.setLocationAtPoint(o,t.around)}cameraForBoxAndBearing(t,s,o,u,f){return nc(t,s,o,u,f)}handleJumpToCenterZoom(t,s){t.zoom!==(s.zoom!==void 0?+s.zoom:t.zoom)&&t.setZoom(+s.zoom),s.center!==void 0&&t.setCenter(l.V.convert(s.center))}handleEaseTo(t,s){const o=t.zoom,u=t.padding,f={roll:t.roll,pitch:t.pitch,bearing:t.bearing},_={roll:s.roll===void 0?t.roll:s.roll,pitch:s.pitch===void 0?t.pitch:s.pitch,bearing:s.bearing===void 0?t.bearing:s.bearing},b=s.zoom!==void 0,T=!t.isPaddingEqual(s.padding);let M=!1;const A=b?+s.zoom:t.zoom;let R=t.centerPoint.add(s.offsetAsPoint);const z=t.screenPointToLocation(R),{center:O,zoom:V}=t.applyConstrain(l.V.convert(s.center||z),A??o);fn(t,O);const W=ft(t.worldSize,z),Y=ft(t.worldSize,O).sub(W),X=l.aq(V-o);return M=V!==o,{easeFunc:te=>{if(M&&t.setZoom(l.G.number(o,V,te)),l.bo(f,_)||Fu({startEulerAngles:f,endEulerAngles:_,tr:t,k:te,useSlerp:f.roll!=_.roll}),T&&(t.interpolatePadding(u,s.padding,te),R=t.centerPoint.add(s.offsetAsPoint)),s.around)t.setLocationAtPoint(s.around,s.aroundPoint);else{const le=l.aq(t.zoom-o),Q=V>o?Math.min(2,X):Math.max(.5,X),ne=Math.pow(Q,1-te),ue=kt(t.worldSize,W.add(Y.mult(te*ne)).mult(le));t.setLocationAtPoint(t.renderWorldCopies?ue.wrap():ue,R)}},isZooming:M,elevationCenter:O}}handleFlyTo(t,s){const o=s.zoom!==void 0,u=t.zoom,f=t.applyConstrain(l.V.convert(s.center||s.locationAtOffset),o?+s.zoom:u),_=f.center,b=f.zoom;fn(t,_);const T=ft(t.worldSize,s.locationAtOffset),M=ft(t.worldSize,_).sub(T),A=M.mag(),R=l.aq(b-u);let z;if(s.minZoom!==void 0){const O=Math.min(+s.minZoom,u,b),V=t.applyConstrain(_,O).zoom;z=l.aq(V-u)}return{easeFunc:(O,V,W,Y)=>{t.setZoom(O===1?b:u+l.at(V));const X=O===1?_:kt(t.worldSize,T.add(M.mult(W)).mult(V));t.setLocationAtPoint(t.renderWorldCopies?X.wrap():X,Y)},scaleOfZoom:R,targetCenter:_,scaleOfMinZoom:z,pixelPathLength:A}}}class xr{constructor(t,s,o){this.blendFunction=t,this.blendColor=s,this.mask=o}}xr.Replace=[1,0],xr.disabled=new xr(xr.Replace,l.bp.transparent,[!1,!1,!1,!1]),xr.unblended=new xr(xr.Replace,l.bp.transparent,[!0,!0,!0,!0]),xr.alphaBlended=new xr([1,771],l.bp.transparent,[!0,!0,!0,!0]);const ao=2305;class tr{constructor(t,s,o){this.enable=t,this.mode=s,this.frontFace=o}}tr.disabled=new tr(!1,1029,ao),tr.backCCW=new tr(!0,1029,ao),tr.frontCCW=new tr(!0,1028,ao);class jt{constructor(t,s,o){this.func=t,this.mask=s,this.range=o}}jt.ReadOnly=!1,jt.ReadWrite=!0,jt.disabled=new jt(519,jt.ReadOnly,[0,1]);const lo=7680;class rr{constructor(t,s,o,u,f,_){this.test=t,this.ref=s,this.mask=o,this.fail=u,this.depthFail=f,this.pass=_}}rr.disabled=new rr({func:519,mask:0},0,0,lo,lo,lo);const qo=new WeakMap;function hs(p){var t;if(qo.has(p))return qo.get(p);{const s=(t=p.getParameter(p.VERSION))===null||t===void 0?void 0:t.startsWith("WebGL 2.0");return qo.set(p,s),s}}class co{get awaitingQuery(){return!!this._readbackQueue}constructor(t){this._readbackWaitFrames=4,this._measureWaitFrames=6,this._texWidth=1,this._texHeight=1,this._measuredError=0,this._updateCount=0,this._lastReadbackFrame=-1e3,this._readbackQueue=null,this._cachedRenderContext=t;const s=t.context,o=s.gl;this._texFormat=o.RGBA,this._texType=o.UNSIGNED_BYTE;const u=new l.aW;u.emplaceBack(-1,-1),u.emplaceBack(2,-1),u.emplaceBack(-1,2);const f=new l.aY;f.emplaceBack(0,1,2),this._fullscreenTriangle=new yr(s.createVertexBuffer(u,pn.members),s.createIndexBuffer(f),l.aX.simpleSegment(0,0,u.length,f.length)),this._resultBuffer=new Uint8Array(4),s.activeTexture.set(o.TEXTURE1);const _=o.createTexture();o.bindTexture(o.TEXTURE_2D,_),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texImage2D(o.TEXTURE_2D,0,this._texFormat,this._texWidth,this._texHeight,0,this._texFormat,this._texType,null),this._fbo=s.createFramebuffer(this._texWidth,this._texHeight,!1,!1),this._fbo.colorAttachment.set(_),hs(o)&&(this._pbo=o.createBuffer(),o.bindBuffer(o.PIXEL_PACK_BUFFER,this._pbo),o.bufferData(o.PIXEL_PACK_BUFFER,4,o.STREAM_READ),o.bindBuffer(o.PIXEL_PACK_BUFFER,null))}destroy(){const t=this._cachedRenderContext.context.gl;this._fullscreenTriangle.destroy(),this._fbo.destroy(),t.deleteBuffer(this._pbo),this._fullscreenTriangle=null,this._fbo=null,this._pbo=null,this._resultBuffer=null}updateErrorLoop(t,s){const o=this._updateCount;return this._readbackQueue?o>=this._readbackQueue.frameNumberIssued+this._readbackWaitFrames&&this._tryReadback():o>=this._lastReadbackFrame+this._measureWaitFrames&&this._renderErrorTexture(t,s),this._updateCount++,this._measuredError}_bindFramebuffer(){const t=this._cachedRenderContext.context,s=t.gl;t.activeTexture.set(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,this._fbo.colorAttachment.get()),t.bindFramebuffer.set(this._fbo.framebuffer)}_renderErrorTexture(t,s){const o=this._cachedRenderContext.context,u=o.gl;if(this._bindFramebuffer(),o.viewport.set([0,0,this._texWidth,this._texHeight]),o.clear({color:l.bp.transparent}),this._cachedRenderContext.useProgram("projectionErrorMeasurement").draw(o,u.TRIANGLES,jt.disabled,rr.disabled,xr.unblended,tr.disabled,((f,_)=>({u_input:f,u_output_expected:_}))(t,s),null,null,"$clipping",this._fullscreenTriangle.vertexBuffer,this._fullscreenTriangle.indexBuffer,this._fullscreenTriangle.segments),this._pbo&&hs(u)){u.bindBuffer(u.PIXEL_PACK_BUFFER,this._pbo),u.readBuffer(u.COLOR_ATTACHMENT0),u.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,0),u.bindBuffer(u.PIXEL_PACK_BUFFER,null);const f=u.fenceSync(u.SYNC_GPU_COMMANDS_COMPLETE,0);u.flush(),this._readbackQueue={frameNumberIssued:this._updateCount,sync:f}}else this._readbackQueue={frameNumberIssued:this._updateCount,sync:null}}_tryReadback(){const t=this._cachedRenderContext.context.gl;if(this._pbo&&this._readbackQueue&&hs(t)){const s=t.clientWaitSync(this._readbackQueue.sync,0,0);if(s===t.WAIT_FAILED)return l.w("WebGL2 clientWaitSync failed."),this._readbackQueue=null,void(this._lastReadbackFrame=this._updateCount);if(s===t.TIMEOUT_EXPIRED)return;t.bindBuffer(t.PIXEL_PACK_BUFFER,this._pbo),t.getBufferSubData(t.PIXEL_PACK_BUFFER,0,this._resultBuffer,0,4),t.bindBuffer(t.PIXEL_PACK_BUFFER,null)}else this._bindFramebuffer(),t.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,this._resultBuffer);this._readbackQueue=null,this._measuredError=co._parseRGBA8float(this._resultBuffer),this._lastReadbackFrame=this._updateCount}static _parseRGBA8float(t){let s=0;return s+=t[0]/256,s+=t[1]/65536,s+=t[2]/16777216,t[3]<127&&(s=-s),s/128}}const mn=l.a5/128;function Lu(p,t){const s=p.granularity!==void 0?Math.max(p.granularity,1):1,o=s+(p.generateBorders?2:0),u=s+(p.extendToNorthPole||p.generateBorders?1:0)+(p.extendToSouthPole||p.generateBorders?1:0),f=o+1,_=u+1,b=p.generateBorders?-1:0,T=p.generateBorders||p.extendToNorthPole?-1:0,M=s+(p.generateBorders?1:0),A=s+(p.generateBorders||p.extendToSouthPole?1:0),R=f*_,z=o*u*6,O=f*_>65536;if(O&&t==="16bit")throw new Error("Granularity is too large and meshes would not fit inside 16 bit vertex indices.");const V=O||t==="32bit",W=new Int16Array(2*R);let Y=0;for(let le=T;le<=A;le++)for(let Q=b;Q<=M;Q++){let ne=Q/s*l.a5;Q===-1&&(ne=-mn),Q===s+1&&(ne=l.a5+mn);let ue=le/s*l.a5;le===-1&&(ue=p.extendToNorthPole?l.br:-mn),le===s+1&&(ue=p.extendToSouthPole?l.bs:l.a5+mn),W[Y++]=ne,W[Y++]=ue}const X=V?new Uint32Array(z):new Uint16Array(z);let te=0;for(let le=0;le<u;le++)for(let Q=0;Q<o;Q++){const ne=Q+1+le*f,ue=Q+(le+1)*f,ie=Q+1+(le+1)*f;X[te++]=Q+le*f,X[te++]=ue,X[te++]=ne,X[te++]=ne,X[te++]=ue,X[te++]=ie}return{vertices:W.buffer.slice(0),indices:X.buffer.slice(0),uses32bitIndices:V}}const Go=new l.aV({fill:new l.bt(128,2),line:new l.bt(512,0),tile:new l.bt(128,32),stencil:new l.bt(128,1),circle:3});class oc{constructor(){this._tileMeshCache={},this._errorCorrectionUsable=0,this._errorMeasurementLastValue=0,this._errorCorrectionPreviousValue=0,this._errorMeasurementLastChangeTime=-1e3}get name(){return"vertical-perspective"}get transitionState(){return 1}get useSubdivision(){return!0}get shaderVariantName(){return"globe"}get shaderDefine(){return"#define GLOBE"}get shaderPreludeCode(){return Or.projectionGlobe}get vertexShaderPreludeCode(){return Or.projectionMercator.vertexSource}get subdivisionGranularity(){return Go}get useGlobeControls(){return!0}get latitudeErrorCorrectionRadians(){return this._errorCorrectionUsable}destroy(){this._errorMeasurement&&this._errorMeasurement.destroy()}updateGPUdependent(t){this._errorMeasurement||(this._errorMeasurement=new co(t));const s=l.X(this._errorQueryLatitudeDegrees),o=2*Math.atan(Math.exp(Math.PI-s*Math.PI*2))-.5*Math.PI,u=this._errorMeasurement.updateErrorLoop(s,o),f=ot();u!==this._errorMeasurementLastValue&&(this._errorCorrectionPreviousValue=this._errorCorrectionUsable,this._errorMeasurementLastValue=u,this._errorMeasurementLastChangeTime=f);const _=Math.min(Math.max((f-this._errorMeasurementLastChangeTime)/1e3/.5,0),1);this._errorCorrectionUsable=l.bu(this._errorCorrectionPreviousValue,-this._errorMeasurementLastValue,l.bv(_))}_getMeshKey(t){return`${t.granularity.toString(36)}_${t.generateBorders?"b":""}${t.extendToNorthPole?"n":""}${t.extendToSouthPole?"s":""}`}getMeshFromTileID(t,s,o,u,f){const _=(f==="stencil"?Go.stencil:Go.tile).getGranularityForZoomLevel(s.z);return this._getMesh(t,{granularity:_,generateBorders:o,extendToNorthPole:s.y===0&&u,extendToSouthPole:s.y===(1<<s.z)-1&&u})}_getMesh(t,s){const o=this._getMeshKey(s);if(o in this._tileMeshCache)return this._tileMeshCache[o];const u=(function(f,_){const b=Lu(_,"16bit"),T=l.aW.deserialize({arrayBuffer:b.vertices,length:b.vertices.byteLength/2/2}),M=l.aY.deserialize({arrayBuffer:b.indices,length:b.indices.byteLength/2/3});return new yr(f.createVertexBuffer(T,pn.members),f.createIndexBuffer(M),l.aX.simpleSegment(0,0,T.length,M.length))})(t,s);return this._tileMeshCache[o]=u,u}recalculate(t){}hasTransition(){const t=ot();let s=!1;return s=s||(t-this._errorMeasurementLastChangeTime)/1e3<.7,s=s||this._errorMeasurement&&this._errorMeasurement.awaitingQuery,s}setErrorQueryLatitudeDegrees(t){this._errorQueryLatitudeDegrees=t}}const Dd=new l.t({type:new l.D(l.u.projection.type)});class Ou extends l.E{constructor(t){super(),this._transitionable=new l.x(Dd,void 0),this.setProjection(t),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new l.H(0)),this._mercatorProjection=new $i,this._verticalPerspectiveProjection=new oc}get transitionState(){const t=this.properties.get("type");if(typeof t=="string"&&t==="mercator")return 0;if(typeof t=="string"&&t==="vertical-perspective")return 1;if(t instanceof l.bw){if(t.from==="vertical-perspective"&&t.to==="mercator")return 1-t.transition;if(t.from==="mercator"&&t.to==="vertical-perspective")return t.transition}return 1}get useGlobeRendering(){return this.transitionState>0}get latitudeErrorCorrectionRadians(){return this._verticalPerspectiveProjection.latitudeErrorCorrectionRadians}get currentProjection(){return this.useGlobeRendering?this._verticalPerspectiveProjection:this._mercatorProjection}get name(){return"globe"}get useSubdivision(){return this.currentProjection.useSubdivision}get shaderVariantName(){return this.currentProjection.shaderVariantName}get shaderDefine(){return this.currentProjection.shaderDefine}get shaderPreludeCode(){return this.currentProjection.shaderPreludeCode}get vertexShaderPreludeCode(){return this.currentProjection.vertexShaderPreludeCode}get subdivisionGranularity(){return this.currentProjection.subdivisionGranularity}get useGlobeControls(){return this.transitionState>0}destroy(){this._mercatorProjection.destroy(),this._verticalPerspectiveProjection.destroy()}updateGPUdependent(t){this._mercatorProjection.updateGPUdependent(t),this._verticalPerspectiveProjection.updateGPUdependent(t)}getMeshFromTileID(t,s,o,u,f){return this.currentProjection.getMeshFromTileID(t,s,o,u,f)}setProjection(t){this._transitionable.setValue("type",t?.type||"mercator")}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()||this.currentProjection.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}setErrorQueryLatitudeDegrees(t){this._verticalPerspectiveProjection.setErrorQueryLatitudeDegrees(t),this._mercatorProjection.setErrorQueryLatitudeDegrees(t)}}function Ui(p){const t=Rn(p.worldSize,p.center.lat);return 2*Math.PI*t}function Vs(p,t,s,o,u){const f=1/(1<<u),_=t/l.a5*f+o*f,b=l.by((p/l.a5*f+s*f)*Math.PI*2+Math.PI,2*Math.PI),T=2*Math.atan(Math.exp(Math.PI-_*Math.PI*2))-.5*Math.PI,M=Math.cos(T),A=new Float64Array(3);return A[0]=Math.sin(b)*M,A[1]=Math.sin(T),A[2]=Math.cos(b)*M,A}function kr(p){return(function(t,s){const o=Math.cos(s),u=new Float64Array(3);return u[0]=Math.sin(t)*o,u[1]=Math.sin(s),u[2]=Math.cos(t)*o,u})(p.lng*Math.PI/180,p.lat*Math.PI/180)}function Rn(p,t){return p/(2*Math.PI)/Math.cos(t*Math.PI/180)}function ac(p){const t=Math.asin(p[1])/Math.PI*180,s=Math.sqrt(p[0]*p[0]+p[2]*p[2]);if(s>1e-6){const o=p[0]/s,u=Math.acos(p[2]/s),f=(o>0?u:-u)/Math.PI*180;return new l.V(l.W(f,-180,180),t)}return new l.V(0,t)}function Zo(p){return Math.cos(p*Math.PI/180)}function Ur(p,t){const s=Zo(p),o=Zo(t);return l.at(o/s)}function Bu(p,t){const s=p.rotate(t.bearingInRadians),o=t.zoom+Ur(t.center.lat,0),u=l.bu(1/Zo(t.center.lat),1/Zo(Math.min(Math.abs(t.center.lat),60)),l.bx(o,7,3,0,1)),f=360/Ui({worldSize:t.worldSize,center:{lat:t.center.lat}});return new l.V(t.center.lng-s.x*f*u,l.an(t.center.lat+s.y*f,-l.ao,l.ao))}function lc(p){const t=.5*p,s=Math.sin(t),o=Math.cos(t);return Math.log(s+o)-Math.log(o-s)}function ju(p,t,s,o){const u=p.lat+s*o;if(Math.abs(s)>1){const f=(Math.sign(p.lat+s)!==Math.sign(p.lat)?-Math.abs(p.lat):Math.abs(p.lat))*Math.PI/180,_=Math.abs(p.lat+s)*Math.PI/180,b=lc(f+o*(_-f)),T=lc(f),M=lc(_);return new l.V(p.lng+t*((b-T)/(M-T)),u)}return new l.V(p.lng+t*o,u)}class zd{constructor(t){this._cachePrevious=new Map,this._cache=new Map,this._hadAnyChanges=!1,this._boundingVolumeFactory=t}swapBuffers(){if(!this._hadAnyChanges)return;const t=this._cachePrevious;this._cachePrevious=this._cache,this._cache=t,this._cache.clear(),this._hadAnyChanges=!1}getTileBoundingVolume(t,s,o,u){const f=`${t.z}_${t.x}_${t.y}_${u?.terrain?"t":""}`,_=this._cache.get(f);if(_)return _;const b=this._cachePrevious.get(f);if(b)return this._cache.set(f,b),b;const T=this._boundingVolumeFactory(t,s,o,u);return this._cache.set(f,T),this._hadAnyChanges=!0,T}}class uo{constructor(t,s,o,u){this.min=o,this.max=u,this.points=t,this.planes=s}static fromAabb(t,s){const o=[];for(let u=0;u<8;u++)o.push([1&~u?t[0]:s[0],(u>>1&1)==1?s[1]:t[1],(u>>2&1)==1?s[2]:t[2]]);return new uo(o,[[-1,0,0,s[0]],[1,0,0,-t[0]],[0,-1,0,s[1]],[0,1,0,-t[1]],[0,0,-1,s[2]],[0,0,1,-t[2]]],t,s)}static fromCenterSizeAngles(t,s,o){const u=l.bB([],o[0],o[1],o[2]),f=l.bC([],[s[0],0,0],u),_=l.bC([],[0,s[1],0],u),b=l.bC([],[0,0,s[2]],u),T=[...t],M=[...t];for(let R=0;R<8;R++)for(let z=0;z<3;z++){const O=t[z]+f[z]*(1&~R?-1:1)+_[z]*((R>>1&1)==1?1:-1)+b[z]*((R>>2&1)==1?1:-1);T[z]=Math.min(T[z],O),M[z]=Math.max(M[z],O)}const A=[];for(let R=0;R<8;R++){const z=[...t];l.b0(z,z,l.a$([],f,1&~R?-1:1)),l.b0(z,z,l.a$([],_,(R>>1&1)==1?1:-1)),l.b0(z,z,l.a$([],b,(R>>2&1)==1?1:-1)),A.push(z)}return new uo(A,[[...f,-l.b5(f,A[0])],[..._,-l.b5(_,A[0])],[...b,-l.b5(b,A[0])],[-f[0],-f[1],-f[2],-l.b5(f,A[7])],[-_[0],-_[1],-_[2],-l.b5(_,A[7])],[-b[0],-b[1],-b[2],-l.b5(b,A[7])]],T,M)}intersectsFrustum(t){let s=!0;const o=this.points.length,u=this.planes.length,f=t.planes.length,_=t.points.length;for(let b=0;b<f;b++){const T=t.planes[b];let M=0;for(let A=0;A<o;A++){const R=this.points[A];T[0]*R[0]+T[1]*R[1]+T[2]*R[2]+T[3]>=0&&M++}if(M===0)return 0;M<o&&(s=!1)}if(s)return 2;for(let b=0;b<u;b++){const T=this.planes[b];let M=0;for(let A=0;A<_;A++){const R=t.points[A];T[0]*R[0]+T[1]*R[1]+T[2]*R[2]+T[3]>=0&&M++}if(M===0)return 0}return 1}intersectsPlane(t){const s=this.points.length;let o=0;for(let u=0;u<s;u++){const f=this.points[u];t[0]*f[0]+t[1]*f[1]+t[2]*f[2]+t[3]>=0&&o++}return o===s?2:o===0?0:1}}function ja(p,t,s){const o=p-t;return o<0?-o:Math.max(0,o-s)}function ho(p,t,s,o,u){const f=p-s;let _;return _=f<0?Math.min(-f,1+f-u):f>1?Math.min(Math.max(f-u,0),1-f):0,Math.max(_,ja(t,o,u))}class cc{constructor(){this._boundingVolumeCache=new zd(this._computeTileBoundingVolume)}prepareNextFrame(){this._boundingVolumeCache.swapBuffers()}distanceToTile2d(t,s,o,u){const f=1<<o.z,_=1/f,b=o.x/f,T=o.y/f;let M=2;return M=Math.min(M,ho(t,s,b,T,_)),M=Math.min(M,ho(t,s,b+.5,-T-_,_)),M=Math.min(M,ho(t,s,b+.5,2-T-_,_)),M}getWrap(t,s,o){const u=1<<s.z,f=1/u,_=s.x/u,b=ja(t.x,_,f),T=ja(t.x,_-1,f),M=ja(t.x,_+1,f),A=Math.min(b,T,M);return A===M?1:A===T?-1:0}allowVariableZoom(t,s){return cr(t,s)>4}allowWorldCopies(){return!1}getTileBoundingVolume(t,s,o,u){return this._boundingVolumeCache.getTileBoundingVolume(t,s,o,u)}_computeTileBoundingVolume(t,s,o,u){var f,_;let b=0,T=0;if(u?.terrain){const M=new l.a2(t.z,s,t.z,t.x,t.y),A=u.terrain.getMinMaxElevation(M);b=(f=A.minElevation)!==null&&f!==void 0?f:Math.min(0,o),T=(_=A.maxElevation)!==null&&_!==void 0?_:Math.max(0,o)}if(b/=l.bE,T/=l.bE,b+=1,T+=1,t.z<=0)return uo.fromAabb([-T,-T,-T],[T,T,T]);if(t.z===1)return uo.fromAabb([t.x===0?-T:0,t.y===0?0:-T,-T],[t.x===0?0:T,t.y===0?T:0,T]);{const M=[Vs(0,0,t.x,t.y,t.z),Vs(l.a5,0,t.x,t.y,t.z),Vs(l.a5,l.a5,t.x,t.y,t.z),Vs(0,l.a5,t.x,t.y,t.z)],A=[];for(const Me of M)A.push(l.a$([],Me,T));if(T!==b)for(const Me of M)A.push(l.a$([],Me,b));t.y===0&&A.push([0,1,0]),t.y===(1<<t.z)-1&&A.push([0,-1,0]);const R=[1,1,1],z=[-1,-1,-1];for(const Me of A)for(let Ie=0;Ie<3;Ie++)R[Ie]=Math.min(R[Ie],Me[Ie]),z[Ie]=Math.max(z[Ie],Me[Ie]);const O=Vs(l.a5/2,l.a5/2,t.x,t.y,t.z),V=l.b4([],[0,1,0],O);l.b3(V,V);const W=l.b4([],O,V);l.b3(W,W);const Y=l.b4([],M[2],M[1]);l.b3(Y,Y);const X=l.b4([],M[0],M[3]);l.b3(X,X),A.push(l.a$([],O,T)),t.y>=(1<<t.z)/2&&A.push(l.a$([],Vs(l.a5/2,0,t.x,t.y,t.z),T)),t.y<(1<<t.z)/2&&A.push(l.a$([],Vs(l.a5/2,l.a5,t.x,t.y,t.z),T));const te=Ho(O,A),le=Ho(W,A),Q=[-O[0],-O[1],-O[2],te.max],ne=[O[0],O[1],O[2],-te.min],ue=[-W[0],-W[1],-W[2],le.max],ie=[W[0],W[1],W[2],-le.min],pe=[...Y,0],Ce=[...X,0],Pe=[];return t.y===0?Pe.push(l.bD(Ce,pe,Q),l.bD(Ce,pe,ne)):Pe.push(l.bD(ue,pe,Q),l.bD(ue,pe,ne),l.bD(ue,Ce,Q),l.bD(ue,Ce,ne)),t.y===(1<<t.z)-1?Pe.push(l.bD(Ce,pe,Q),l.bD(Ce,pe,ne)):Pe.push(l.bD(ie,pe,Q),l.bD(ie,pe,ne),l.bD(ie,Ce,Q),l.bD(ie,Ce,ne)),new uo(Pe,[Q,ne,ue,ie,pe,Ce],R,z)}}}function Ho(p,t){let s=1/0,o=-1/0;for(const u of t){const f=l.b5(p,u);s=Math.min(s,f),o=Math.max(o,f)}return{min:s,max:o}}class po{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(t){this._helper.setMinZoom(t)}setMaxZoom(t){this._helper.setMaxZoom(t)}setMinPitch(t){this._helper.setMinPitch(t)}setMaxPitch(t){this._helper.setMaxPitch(t)}setRenderWorldCopies(t){this._helper.setRenderWorldCopies(t)}setBearing(t){this._helper.setBearing(t)}setPitch(t){this._helper.setPitch(t)}setRoll(t){this._helper.setRoll(t)}setFov(t){this._helper.setFov(t)}setZoom(t){this._helper.setZoom(t)}setCenter(t){this._helper.setCenter(t)}setElevation(t){this._helper.setElevation(t)}setMinElevationForCurrentTile(t){this._helper.setMinElevationForCurrentTile(t)}setPadding(t){this._helper.setPadding(t)}interpolatePadding(t,s,o){return this._helper.interpolatePadding(t,s,o)}isPaddingEqual(t){return this._helper.isPaddingEqual(t)}resize(t,s){this._helper.resize(t,s)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(t){this._helper.setMaxBounds(t)}setConstrainOverride(t){this._helper.setConstrainOverride(t)}overrideNearFarZ(t,s){this._helper.overrideNearFarZ(t,s)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(t){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),t)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(t){}constructor(t){this._cachedClippingPlane=l.bF(),this._projectionMatrix=l.bj(),this._globeViewProjMatrix32f=l.bi(),this._globeViewProjMatrixNoCorrection=l.bj(),this._globeViewProjMatrixNoCorrectionInverted=l.bj(),this._globeProjMatrixInverted=l.bj(),this._cameraPosition=l.bz(),this._globeLatitudeErrorCorrectionRadians=0,this.defaultConstrain=(s,o)=>{const u=l.an(s.lat,-l.ao,l.ao),f=l.an(+o,this.minZoom+Ur(0,u),this.maxZoom);return{center:new l.V(s.lng,u),zoom:f}},this.applyConstrain=(s,o)=>this._helper.applyConstrain(s,o),this._helper=new kn({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(s,o)=>this.defaultConstrain(s,o)},t),this._coveringTilesDetailsProvider=new cc}clone(){const t=new po;return t.apply(this),t}apply(t,s){this._globeLatitudeErrorCorrectionRadians=s||0,this._helper.apply(t)}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._globeViewProjMatrixNoCorrection}get inverseProjectionMatrix(){return this._globeProjMatrixInverted}get cameraPosition(){const t=l.bz();return t[0]=this._cameraPosition[0],t[1]=this._cameraPosition[1],t[2]=this._cameraPosition[2],t}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}getProjectionData(t){const{overscaledTileID:s,applyGlobeMatrix:o}=t,u=this._helper.getMercatorTileCoordinates(s);return{mainMatrix:this._globeViewProjMatrix32f,tileMercatorCoords:u,clippingPlane:this._cachedClippingPlane,projectionTransition:o?1:0,fallbackMatrix:this._globeViewProjMatrix32f}}_computeClippingPlane(t){const s=this.pitchInRadians,o=this.cameraToCenterDistance/t,u=Math.sin(s)*o,f=Math.cos(s)*o+1,_=1/Math.sqrt(u*u+f*f)*1;let b=-u,T=f;const M=Math.sqrt(b*b+T*T);b/=M,T/=M;const A=[0,b,T];l.bG(A,A,[0,0,0],-this.bearingInRadians),l.bH(A,A,[0,0,0],-1*this.center.lat*Math.PI/180),l.bI(A,A,[0,0,0],this.center.lng*Math.PI/180);const R=1/l.b7(A);return l.a$(A,A,R),[...A,-_*R]}isLocationOccluded(t){return!this.isSurfacePointVisible(kr(t))}transformLightDirection(t){const s=this._helper._center.lng*Math.PI/180,o=this._helper._center.lat*Math.PI/180,u=Math.cos(o),f=[Math.sin(s)*u,Math.sin(o),Math.cos(s)*u],_=[f[2],0,-f[0]],b=[0,0,0];l.b4(b,_,f),l.b3(_,_),l.b3(b,b);const T=[0,0,0];return l.b3(T,[_[0]*t[0]+b[0]*t[1]+f[0]*t[2],_[1]*t[0]+b[1]*t[1]+f[1]*t[2],_[2]*t[0]+b[2]*t[1]+f[2]*t[2]]),T}getPixelScale(){return 1/Math.cos(this._helper._center.lat*Math.PI/180)}getCircleRadiusCorrection(){return Math.cos(this._helper._center.lat*Math.PI/180)}getPitchedTextCorrection(t,s,o){const u=(function(b,T,M){const A=1/(1<<M.z);return new l.a9(b/l.a5*A+M.x*A,T/l.a5*A+M.y*A)})(t,s,o.canonical),f=(_=u.y,[l.by(u.x*Math.PI*2+Math.PI,2*Math.PI),2*Math.atan(Math.exp(Math.PI-_*Math.PI*2))-.5*Math.PI]);var _;return this.getCircleRadiusCorrection()/Math.cos(f[1])}projectTileCoordinates(t,s,o,u){const f=o.canonical,_=Vs(t,s,f.x,f.y,f.z),b=1+(u?u(t,s):0)/l.bE,T=[_[0]*b,_[1]*b,_[2]*b,1];l.aH(T,T,this._globeViewProjMatrixNoCorrection);const M=this._cachedClippingPlane,A=M[0]*_[0]+M[1]*_[1]+M[2]*_[2]+M[3]<0;return{point:new l.P(T[0]/T[3],T[1]/T[3]),signedDistanceFromCamera:T[3],isOccluded:A}}_calcMatrices(){if(!this._helper._width||!this._helper._height)return;const t=Rn(this.worldSize,this.center.lat),s=l.bk(),o=l.bk();this._helper.autoCalculateNearFarZ&&(this._helper._nearZ=.5,this._helper._farZ=this.cameraToCenterDistance+2*t),l.be(s,this.fovInRadians,this.width/this.height,this._helper._nearZ,this._helper._farZ);const u=this.centerOffset;s[8]=2*-u.x/this._helper._width,s[9]=2*u.y/this._helper._height,this._projectionMatrix=l.bf(s),this._globeProjMatrixInverted=l.bk(),l.aB(this._globeProjMatrixInverted,s),l.O(s,s,[0,0,-this.cameraToCenterDistance]),l.bg(s,s,this.rollInRadians),l.bh(s,s,-this.pitchInRadians),l.bg(s,s,this.bearingInRadians),l.O(s,s,[0,0,-t]);const f=l.bz();f[0]=t,f[1]=t,f[2]=t,l.bh(o,s,this.center.lat*Math.PI/180),l.bJ(o,o,-this.center.lng*Math.PI/180),l.Q(o,o,f),this._globeViewProjMatrixNoCorrection=o,l.bh(s,s,this.center.lat*Math.PI/180-this._globeLatitudeErrorCorrectionRadians),l.bJ(s,s,-this.center.lng*Math.PI/180),l.Q(s,s,f),this._globeViewProjMatrix32f=new Float32Array(s),this._globeViewProjMatrixNoCorrectionInverted=l.bk(),l.aB(this._globeViewProjMatrixNoCorrectionInverted,o);const _=l.bz();this._cameraPosition=l.bz(),this._cameraPosition[2]=this.cameraToCenterDistance/t,l.bG(this._cameraPosition,this._cameraPosition,_,-this.rollInRadians),l.bH(this._cameraPosition,this._cameraPosition,_,this.pitchInRadians),l.bG(this._cameraPosition,this._cameraPosition,_,-this.bearingInRadians),l.b0(this._cameraPosition,this._cameraPosition,[0,0,1]),l.bH(this._cameraPosition,this._cameraPosition,_,-this.center.lat*Math.PI/180),l.bI(this._cameraPosition,this._cameraPosition,_,this.center.lng*Math.PI/180),this._cachedClippingPlane=this._computeClippingPlane(t);const b=l.bf(this._globeViewProjMatrixNoCorrectionInverted);l.Q(b,b,[1,1,-1]),this._cachedFrustum=Ki.fromInvProjectionMatrix(b,1,0,this._cachedClippingPlane,!0)}calculateFogMatrix(t){l.w("calculateFogMatrix is not supported on globe projection.");const s=l.bk();return l.ar(s),s}getVisibleUnwrappedCoordinates(t){return[new l.bc(0,t)]}getCameraFrustum(){return this._cachedFrustum}getClippingPlane(){return this._cachedClippingPlane}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(t){t&&l.w("terrain is not fully supported on vertical perspective projection."),this._helper.recalculateZoomAndCenter(0)}maxPitchScaleFactor(){return 1}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(t,s){if(!this._globeViewProjMatrixNoCorrection)return 1;const o=kr(t);l.a$(o,o,1+s/l.bE);const u=l.bF();return l.aH(u,[o[0],o[1],o[2],1],this._globeViewProjMatrixNoCorrection),u[2]/u[3]}populateCache(t){}getBounds(){const t=.5*this.width,s=.5*this.height,o=[new l.P(0,0),new l.P(t,0),new l.P(this.width,0),new l.P(this.width,s),new l.P(this.width,this.height),new l.P(t,this.height),new l.P(0,this.height),new l.P(0,s)],u=[];for(const R of o)u.push(this.unprojectScreenPoint(R));let f=0,_=0,b=0,T=0;const M=this.center;for(const R of u){const z=l.bK(M.lng,R.lng),O=l.bK(M.lat,R.lat);z<_&&(_=z),z>f&&(f=z),O<T&&(T=O),O>b&&(b=O)}const A=[M.lng+_,M.lat+T,M.lng+f,M.lat+b];return this.isSurfacePointOnScreen([0,1,0])&&(A[3]=90,A[0]=-180,A[2]=180),this.isSurfacePointOnScreen([0,-1,0])&&(A[1]=-90,A[0]=-180,A[2]=180),new Mr(A)}calculateCenterFromCameraLngLatAlt(t,s,o,u){return this._helper.calculateCenterFromCameraLngLatAlt(t,s,o,u)}setLocationAtPoint(t,s){const o=kr(this.unprojectScreenPoint(s)),u=kr(t),f=l.bz();l.bL(f);const _=l.bz();l.bI(_,o,f,-this.center.lng*Math.PI/180),l.bH(_,_,f,this.center.lat*Math.PI/180);const b=u[0]*u[0]+u[2]*u[2],T=_[0]*_[0];if(b<T)return;const M=Math.sqrt(b-T),A=-M,R=l.bM(u[0],u[2],_[0],M),z=l.bM(u[0],u[2],_[0],A),O=l.bz();l.bI(O,u,f,-R);const V=l.bM(O[1],O[2],_[1],_[2]),W=l.bz();l.bI(W,u,f,-z);const Y=l.bM(W[1],W[2],_[1],_[2]),X=.5*Math.PI,te=V>=-X&&V<=X,le=Y>=-X&&Y<=X;let Q,ne;if(te&&le){const Ce=this.center.lng*Math.PI/180,Pe=this.center.lat*Math.PI/180;l.bN(R,Ce)+l.bN(V,Pe)<l.bN(z,Ce)+l.bN(Y,Pe)?(Q=R,ne=V):(Q=z,ne=Y)}else if(te)Q=R,ne=V;else{if(!le)return;Q=z,ne=Y}const ue=Q/Math.PI*180,ie=ne/Math.PI*180,pe=this.center.lat;this.setCenter(new l.V(ue,l.an(ie,-90,90))),this.setZoom(this.zoom+Ur(pe,this.center.lat))}locationToScreenPoint(t,s){const o=kr(t);if(s){const u=s.getElevationForLngLatZoom(t,this._helper._tileZoom);l.a$(o,o,1+u/l.bE)}return this._projectSurfacePointToScreen(o)}_projectSurfacePointToScreen(t){const s=l.bF();return l.aH(s,[...t,1],this._globeViewProjMatrixNoCorrection),s[0]/=s[3],s[1]/=s[3],new l.P((.5*s[0]+.5)*this.width,(.5*-s[1]+.5)*this.height)}screenPointToMercatorCoordinate(t,s){if(s){const o=s.pointCoordinate(t);if(o)return o}return l.a9.fromLngLat(this.unprojectScreenPoint(t))}screenPointToLocation(t,s){var o;return(o=this.screenPointToMercatorCoordinate(t,s))===null||o===void 0?void 0:o.toLngLat()}isPointOnMapSurface(t,s){const o=this._cameraPosition,u=this.getRayDirectionFromPixel(t);return!!this.rayPlanetIntersection(o,u)}getRayDirectionFromPixel(t){const s=l.bF();s[0]=t.x/this.width*2-1,s[1]=-1*(t.y/this.height*2-1),s[2]=1,s[3]=1,l.aH(s,s,this._globeViewProjMatrixNoCorrectionInverted),s[0]/=s[3],s[1]/=s[3],s[2]/=s[3];const o=l.bz();o[0]=s[0]-this._cameraPosition[0],o[1]=s[1]-this._cameraPosition[1],o[2]=s[2]-this._cameraPosition[2];const u=l.bz();return l.b3(u,o),u}isSurfacePointVisible(t){const s=this._cachedClippingPlane;return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]+s[3]>=0}isSurfacePointOnScreen(t){if(!this.isSurfacePointVisible(t))return!1;const s=l.bF();return l.aH(s,[...t,1],this._globeViewProjMatrixNoCorrection),s[0]/=s[3],s[1]/=s[3],s[2]/=s[3],s[0]>-1&&s[0]<1&&s[1]>-1&&s[1]<1&&s[2]>-1&&s[2]<1}rayPlanetIntersection(t,s){const o=l.b5(t,s),u=l.bz(),f=l.bz();l.a$(f,s,o),l.b2(u,t,f);const _=1-l.b5(u,u);if(_<0)return null;const b=l.b5(t,t)-1,T=-o+(o<0?1:-1)*Math.sqrt(_),M=b/T,A=T;return{tMin:Math.min(M,A),tMax:Math.max(M,A)}}unprojectScreenPoint(t){const s=this._cameraPosition,o=this.getRayDirectionFromPixel(t),u=this.rayPlanetIntersection(s,o);if(u){const A=l.bz();l.b0(A,s,[o[0]*u.tMin,o[1]*u.tMin,o[2]*u.tMin]);const R=l.bz();return l.b3(R,A),ac(R)}const f=this._cachedClippingPlane,_=f[0]*o[0]+f[1]*o[1]+f[2]*o[2],b=-l.bb(f,s)/_,T=l.bz();if(b>0)l.b0(T,s,[o[0]*b,o[1]*b,o[2]*b]);else{const A=l.bz();l.b0(A,s,[2*o[0],2*o[1],2*o[2]]);const R=l.bb(this._cachedClippingPlane,A);l.b2(T,A,[this._cachedClippingPlane[0]*R,this._cachedClippingPlane[1]*R,this._cachedClippingPlane[2]*R])}const M=(function(A){const R=l.bz();return R[0]=A[0]*-A[3],R[1]=A[1]*-A[3],R[2]=A[2]*-A[3],{center:R,radius:Math.sqrt(1-A[3]*A[3])}})(f);return ac((function(A,R,z){const O=l.bz();l.b2(O,z,A);const V=l.bz();return l.bA(V,A,O,R/l.b9(O)),V})(M.center,M.radius,T))}getMatrixForModel(t,s){const o=l.V.convert(t),u=1/l.bE,f=l.bj();return l.bJ(f,f,o.lng/180*Math.PI),l.bh(f,f,-o.lat/180*Math.PI),l.O(f,f,[0,0,1+s/l.bE]),l.bh(f,f,.5*Math.PI),l.Q(f,f,[u,u,u]),f}getProjectionDataForCustomLayer(t=!0){const s=this.getProjectionData({overscaledTileID:new l.a2(0,0,0,0,0),applyGlobeMatrix:t});return s.tileMercatorCoords=[0,0,1,1],s}getFastPathSimpleProjectionMatrix(t){}}class fo{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(t){this._helper.setMinZoom(t)}setMaxZoom(t){this._helper.setMaxZoom(t)}setMinPitch(t){this._helper.setMinPitch(t)}setMaxPitch(t){this._helper.setMaxPitch(t)}setRenderWorldCopies(t){this._helper.setRenderWorldCopies(t)}setBearing(t){this._helper.setBearing(t)}setPitch(t){this._helper.setPitch(t)}setRoll(t){this._helper.setRoll(t)}setFov(t){this._helper.setFov(t)}setZoom(t){this._helper.setZoom(t)}setCenter(t){this._helper.setCenter(t)}setElevation(t){this._helper.setElevation(t)}setMinElevationForCurrentTile(t){this._helper.setMinElevationForCurrentTile(t)}setPadding(t){this._helper.setPadding(t)}interpolatePadding(t,s,o){return this._helper.interpolatePadding(t,s,o)}isPaddingEqual(t){return this._helper.isPaddingEqual(t)}resize(t,s,o=!0){this._helper.resize(t,s,o)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(t){this._helper.setMaxBounds(t)}setConstrainOverride(t){this._helper.setConstrainOverride(t)}overrideNearFarZ(t,s){this._helper.overrideNearFarZ(t,s)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(t){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),t)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get constrainOverride(){return this._helper.constrainOverride}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}get isGlobeRendering(){return this._globeness>0}setTransitionState(t,s){this._globeness=t,this._globeLatitudeErrorCorrectionRadians=s,this._calcMatrices(),this._verticalPerspectiveTransform.getCoveringTilesDetailsProvider().prepareNextFrame(),this._mercatorTransform.getCoveringTilesDetailsProvider().prepareNextFrame()}get currentTransform(){return this.isGlobeRendering?this._verticalPerspectiveTransform:this._mercatorTransform}constructor(t){this._globeLatitudeErrorCorrectionRadians=0,this._globeness=1,this.defaultConstrain=(s,o)=>this.currentTransform.defaultConstrain(s,o),this.applyConstrain=(s,o)=>this._helper.applyConstrain(s,o),this._helper=new kn({calcMatrices:()=>{this._calcMatrices()},defaultConstrain:(s,o)=>this.defaultConstrain(s,o)},t),this._globeness=1,this._mercatorTransform=new Dn,this._verticalPerspectiveTransform=new po}clone(){const t=new fo;return t._globeness=this._globeness,t._globeLatitudeErrorCorrectionRadians=this._globeLatitudeErrorCorrectionRadians,t.apply(this),t}apply(t){this._helper.apply(t),this._mercatorTransform.apply(this),this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians)}get projectionMatrix(){return this.currentTransform.projectionMatrix}get modelViewProjectionMatrix(){return this.currentTransform.modelViewProjectionMatrix}get inverseProjectionMatrix(){return this.currentTransform.inverseProjectionMatrix}get cameraPosition(){return this.currentTransform.cameraPosition}getProjectionData(t){const s=this._mercatorTransform.getProjectionData(t),o=this._verticalPerspectiveTransform.getProjectionData(t);return{mainMatrix:this.isGlobeRendering?o.mainMatrix:s.mainMatrix,clippingPlane:o.clippingPlane,tileMercatorCoords:o.tileMercatorCoords,projectionTransition:t.applyGlobeMatrix?this._globeness:0,fallbackMatrix:s.fallbackMatrix}}isLocationOccluded(t){return this.currentTransform.isLocationOccluded(t)}transformLightDirection(t){return this.currentTransform.transformLightDirection(t)}getPixelScale(){return l.bu(this._mercatorTransform.getPixelScale(),this._verticalPerspectiveTransform.getPixelScale(),this._globeness)}getCircleRadiusCorrection(){return l.bu(this._mercatorTransform.getCircleRadiusCorrection(),this._verticalPerspectiveTransform.getCircleRadiusCorrection(),this._globeness)}getPitchedTextCorrection(t,s,o){const u=this._mercatorTransform.getPitchedTextCorrection(t,s,o),f=this._verticalPerspectiveTransform.getPitchedTextCorrection(t,s,o);return l.bu(u,f,this._globeness)}projectTileCoordinates(t,s,o,u){return this.currentTransform.projectTileCoordinates(t,s,o,u)}_calcMatrices(){this._helper._width&&this._helper._height&&(this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians),this._helper._nearZ=this._verticalPerspectiveTransform.nearZ,this._helper._farZ=this._verticalPerspectiveTransform.farZ,this._mercatorTransform.apply(this,!0,this.isGlobeRendering),this._helper._nearZ=this._mercatorTransform.nearZ,this._helper._farZ=this._mercatorTransform.farZ)}calculateFogMatrix(t){return this.currentTransform.calculateFogMatrix(t)}getVisibleUnwrappedCoordinates(t){return this.currentTransform.getVisibleUnwrappedCoordinates(t)}getCameraFrustum(){return this.currentTransform.getCameraFrustum()}getClippingPlane(){return this.currentTransform.getClippingPlane()}getCoveringTilesDetailsProvider(){return this.currentTransform.getCoveringTilesDetailsProvider()}recalculateZoomAndCenter(t){this._mercatorTransform.recalculateZoomAndCenter(t),this._verticalPerspectiveTransform.recalculateZoomAndCenter(t)}maxPitchScaleFactor(){return this._mercatorTransform.maxPitchScaleFactor()}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(t,s){return this.currentTransform.lngLatToCameraDepth(t,s)}populateCache(t){this._mercatorTransform.populateCache(t),this._verticalPerspectiveTransform.populateCache(t)}getBounds(){return this.currentTransform.getBounds()}calculateCenterFromCameraLngLatAlt(t,s,o,u){return this._helper.calculateCenterFromCameraLngLatAlt(t,s,o,u)}setLocationAtPoint(t,s){if(!this.isGlobeRendering)return this._mercatorTransform.setLocationAtPoint(t,s),void this.apply(this._mercatorTransform);this._verticalPerspectiveTransform.setLocationAtPoint(t,s),this.apply(this._verticalPerspectiveTransform)}locationToScreenPoint(t,s){return this.currentTransform.locationToScreenPoint(t,s)}screenPointToMercatorCoordinate(t,s){return this.currentTransform.screenPointToMercatorCoordinate(t,s)}screenPointToLocation(t,s){return this.currentTransform.screenPointToLocation(t,s)}isPointOnMapSurface(t,s){return this.currentTransform.isPointOnMapSurface(t,s)}getRayDirectionFromPixel(t){return this._verticalPerspectiveTransform.getRayDirectionFromPixel(t)}getMatrixForModel(t,s){return this.currentTransform.getMatrixForModel(t,s)}getProjectionDataForCustomLayer(t=!0){const s=this._mercatorTransform.getProjectionDataForCustomLayer(t);if(!this.isGlobeRendering)return s;const o=this._verticalPerspectiveTransform.getProjectionDataForCustomLayer(t);return o.fallbackMatrix=s.mainMatrix,o}getFastPathSimpleProjectionMatrix(t){return this.currentTransform.getFastPathSimpleProjectionMatrix(t)}}class oi{get useGlobeControls(){return!0}handlePanInertia(t,s){const o=Bu(t,s);return Math.abs(o.lng-s.center.lng)>180&&(o.lng=s.center.lng+179.5*Math.sign(o.lng-s.center.lng)),{easingCenter:o,easingOffset:new l.P(0,0)}}handleMapControlsRollPitchBearingZoom(t,s){const o=t.around,u=s.screenPointToLocation(o);t.bearingDelta&&s.setBearing(s.bearing+t.bearingDelta),t.pitchDelta&&s.setPitch(s.pitch+t.pitchDelta),t.rollDelta&&s.setRoll(s.roll+t.rollDelta);const f=s.zoom;t.zoomDelta&&s.setZoom(s.zoom+t.zoomDelta);const _=s.zoom-f;if(_===0)return;const b=l.bK(s.center.lng,u.lng),T=b/(Math.abs(b/180)+1),M=l.bK(s.center.lat,u.lat),A=s.getRayDirectionFromPixel(o),R=s.cameraPosition,z=-1*l.b5(R,A),O=l.bz();l.b0(O,R,[A[0]*z,A[1]*z,A[2]*z]);const V=l.b7(O)-1,W=Math.exp(.5*-Math.max(V-.3,0)),Y=Rn(s.worldSize,s.center.lat)/Math.min(s.width,s.height),X=l.bx(Y,.9,.5,1,.25),te=(1-l.aq(-_))*Math.min(W,X),le=s.center.lat,Q=s.zoom,ne=new l.V(s.center.lng+T*te,l.an(s.center.lat+M*te,-l.ao,l.ao));s.setLocationAtPoint(u,o);const ue=s.center,ie=l.bx(Math.abs(b),45,85,0,1),pe=l.bx(Y,.75,.35,0,1),Ce=Math.pow(Math.max(ie,pe),.25),Pe=l.bK(ue.lng,ne.lng),Me=l.bK(ue.lat,ne.lat);s.setCenter(new l.V(ue.lng+Pe*Ce,ue.lat+Me*Ce).wrap()),s.setZoom(Q+Ur(le,s.center.lat))}handleMapControlsPan(t,s,o){if(!t.panDelta)return;const u=s.center.lat,f=s.zoom;s.setCenter(Bu(t.panDelta,s).wrap()),s.setZoom(f+Ur(u,s.center.lat))}cameraForBoxAndBearing(t,s,o,u,f){const _=nc(t,s,o,u,f),b=s.left/f.width*2-1,T=(f.width-s.right)/f.width*2-1,M=s.top/f.height*-2+1,A=(f.height-s.bottom)/f.height*-2+1,R=l.bK(o.getWest(),o.getEast())<0,z=R?o.getEast():o.getWest(),O=R?o.getWest():o.getEast(),V=Math.max(o.getNorth(),o.getSouth()),W=Math.min(o.getNorth(),o.getSouth()),Y=z+.5*l.bK(z,O),X=V+.5*l.bK(V,W),te=f.clone();te.setCenter(_.center),te.setBearing(_.bearing),te.setPitch(0),te.setRoll(0),te.setZoom(_.zoom);const le=te.modelViewProjectionMatrix,Q=[kr(o.getNorthWest()),kr(o.getNorthEast()),kr(o.getSouthWest()),kr(o.getSouthEast()),kr(new l.V(O,X)),kr(new l.V(z,X)),kr(new l.V(Y,V)),kr(new l.V(Y,W))],ne=kr(_.center);let ue=Number.POSITIVE_INFINITY;for(const ie of Q)b<0&&(ue=oi.getLesserNonNegativeNonNull(ue,oi.solveVectorScale(ie,ne,le,"x",b))),T>0&&(ue=oi.getLesserNonNegativeNonNull(ue,oi.solveVectorScale(ie,ne,le,"x",T))),M>0&&(ue=oi.getLesserNonNegativeNonNull(ue,oi.solveVectorScale(ie,ne,le,"y",M))),A<0&&(ue=oi.getLesserNonNegativeNonNull(ue,oi.solveVectorScale(ie,ne,le,"y",A)));if(Number.isFinite(ue)&&ue!==0)return _.zoom=te.zoom+l.at(ue),_;Xs()}handleJumpToCenterZoom(t,s){const o=t.center.lat,u=t.applyConstrain(s.center?l.V.convert(s.center):t.center,t.zoom).center;t.setCenter(u.wrap());const f=s.zoom!==void 0?+s.zoom:t.zoom+Ur(o,u.lat);t.zoom!==f&&t.setZoom(f)}handleEaseTo(t,s){const o=t.zoom,u=t.center,f=t.padding,_={roll:t.roll,pitch:t.pitch,bearing:t.bearing},b={roll:s.roll===void 0?t.roll:s.roll,pitch:s.pitch===void 0?t.pitch:s.pitch,bearing:s.bearing===void 0?t.bearing:s.bearing},T=s.zoom!==void 0,M=!t.isPaddingEqual(s.padding);let A=!1;const R=s.center?l.V.convert(s.center):u,z=t.applyConstrain(R,o).center;fn(t,z);const O=t.clone();O.setCenter(z),O.setZoom(T?+s.zoom:o+Ur(u.lat,R.lat)),O.setBearing(s.bearing);const V=new l.P(l.an(t.centerPoint.x+s.offsetAsPoint.x,0,t.width),l.an(t.centerPoint.y+s.offsetAsPoint.y,0,t.height));O.setLocationAtPoint(z,V);const W=(s.offset&&s.offsetAsPoint.mag())>0?O.center:z,Y=T?+s.zoom:o+Ur(u.lat,W.lat),X=o+Ur(u.lat,0),te=Y+Ur(W.lat,0),le=l.bK(u.lng,W.lng),Q=l.bK(u.lat,W.lat),ne=l.aq(te-X);return A=Y!==o,{easeFunc:ue=>{if(l.bo(_,b)||Fu({startEulerAngles:_,endEulerAngles:b,tr:t,k:ue,useSlerp:_.roll!=b.roll}),M&&t.interpolatePadding(f,s.padding,ue),s.around)l.w("Easing around a point is not supported under globe projection."),t.setLocationAtPoint(s.around,s.aroundPoint);else{const ie=te>X?Math.min(2,ne):Math.max(.5,ne),pe=Math.pow(ie,1-ue),Ce=ju(u,le,Q,ue*pe);t.setCenter(Ce.wrap())}if(A){const ie=l.G.number(X,te,ue)+Ur(0,t.center.lat);t.setZoom(ie)}},isZooming:A,elevationCenter:W}}handleFlyTo(t,s){const o=s.zoom!==void 0,u=t.center,f=t.zoom,_=t.padding,b=!t.isPaddingEqual(s.padding),T=t.applyConstrain(l.V.convert(s.center||s.locationAtOffset),f).center,M=o?+s.zoom:t.zoom+Ur(t.center.lat,T.lat),A=t.clone();A.setCenter(T),A.setZoom(M),A.setBearing(s.bearing);const R=new l.P(l.an(t.centerPoint.x+s.offsetAsPoint.x,0,t.width),l.an(t.centerPoint.y+s.offsetAsPoint.y,0,t.height));A.setLocationAtPoint(T,R);const z=A.center;fn(t,z);const O=(function(Q,ne,ue){const ie=kr(ne),pe=kr(ue),Ce=l.b5(ie,pe),Pe=Math.acos(Ce),Me=Ui(Q);return Pe/(2*Math.PI)*Me})(t,u,z),V=f+Ur(u.lat,0),W=M+Ur(z.lat,0),Y=l.aq(W-V);let X;if(typeof s.minZoom=="number"){const Q=+s.minZoom+Ur(z.lat,0),ne=Math.min(Q,V,W)+Ur(0,z.lat),ue=t.applyConstrain(z,ne).zoom+Ur(z.lat,0);X=l.aq(ue-V)}const te=l.bK(u.lng,z.lng),le=l.bK(u.lat,z.lat);return{easeFunc:(Q,ne,ue,ie)=>{const pe=ju(u,te,le,ue);b&&t.interpolatePadding(_,s.padding,Q);const Ce=Q===1?z:pe;t.setCenter(Ce.wrap());const Pe=V+l.at(ne);t.setZoom(Q===1?M:Pe+Ur(0,Ce.lat))},scaleOfZoom:Y,targetCenter:z,scaleOfMinZoom:X,pixelPathLength:O}}static solveVectorScale(t,s,o,u,f){const _=u==="x"?[o[0],o[4],o[8],o[12]]:[o[1],o[5],o[9],o[13]],b=[o[3],o[7],o[11],o[15]],T=t[0]*_[0]+t[1]*_[1]+t[2]*_[2],M=t[0]*b[0]+t[1]*b[1]+t[2]*b[2],A=s[0]*_[0]+s[1]*_[1]+s[2]*_[2],R=s[0]*b[0]+s[1]*b[1]+s[2]*b[2];return A+f*M===T+f*R||b[3]*(T-A)+_[3]*(R-M)+T*R==A*M?null:(A+_[3]-f*R-f*b[3])/(A-T-f*R+f*M)}static getLesserNonNegativeNonNull(t,s){return s!==null&&s>=0&&s<t?s:t}}class Nu{constructor(t){this._globe=t,this._mercatorCameraHelper=new zn,this._verticalPerspectiveCameraHelper=new oi}get useGlobeControls(){return this._globe.useGlobeRendering}get currentHelper(){return this.useGlobeControls?this._verticalPerspectiveCameraHelper:this._mercatorCameraHelper}handlePanInertia(t,s){return this.currentHelper.handlePanInertia(t,s)}handleMapControlsRollPitchBearingZoom(t,s){return this.currentHelper.handleMapControlsRollPitchBearingZoom(t,s)}handleMapControlsPan(t,s,o){this.currentHelper.handleMapControlsPan(t,s,o)}cameraForBoxAndBearing(t,s,o,u,f){return this.currentHelper.cameraForBoxAndBearing(t,s,o,u,f)}handleJumpToCenterZoom(t,s){this.currentHelper.handleJumpToCenterZoom(t,s)}handleEaseTo(t,s){return this.currentHelper.handleEaseTo(t,s)}handleFlyTo(t,s){return this.currentHelper.handleFlyTo(t,s)}}const mo=(p,t)=>l.B(p,t&&t.filter((s=>s.identifier!=="source.canvas"))),Wo=l.bO();class Fn extends l.E{constructor(t,s={}){var o,u;super(),this._rtlPluginLoaded=()=>{for(const _ in this.tileManagers){const b=this.tileManagers[_].getSource().type;b!=="vector"&&b!=="geojson"||this.tileManagers[_].reload()}},this.map=t,this.dispatcher=new Lr(Vt(),t._getMapId()),this.dispatcher.registerMessageHandler("GG",((_,b)=>this.getGlyphs(_,b))),this.dispatcher.registerMessageHandler("GI",((_,b)=>this.getImages(_,b))),this.dispatcher.registerMessageHandler("GDA",((_,b)=>this.getDashes(_,b))),this.imageManager=new Qe,this.imageManager.setEventedParent(this);const f=((o=t._container)===null||o===void 0?void 0:o.lang)||typeof document<"u"&&((u=document.documentElement)===null||u===void 0?void 0:u.lang)||void 0;this.glyphManager=new Wt(t._requestManager,s.localIdeographFontFamily,f),this.lineAtlas=new us(256,512),this.crossTileSymbolIndex=new Ji,this._setInitialValues(),this._resetUpdates(),this.dispatcher.broadcast("SR",l.bP()),_e().on(ce,this._rtlPluginLoaded),this.on("data",(_=>{if(_.dataType!=="source"||_.sourceDataType!=="metadata")return;const b=this.tileManagers[_.sourceId];if(!b)return;const T=b.getSource();if(T&&T.vectorLayerIds)for(const M in this._layers){const A=this._layers[M];A.source===T.id&&this._validateLayer(A)}}))}_setInitialValues(){var t;this._spritesImagesIds={},this._layers={},this._order=[],this.tileManagers={},this.zoomHistory=new l.bQ,this._availableImages=[],this._globalState={},this._serializedLayers={},this.stylesheet=null,this.light=null,this.sky=null,this.projection&&(this.projection.destroy(),delete this.projection),this._loaded=!1,this._changed=!1,this._updatedLayers={},this._updatedSources={},this._changedImages={},this._glyphsDidChange=!1,this._updatedPaintProps={},this._layerOrderChanged=!1,this.crossTileSymbolIndex=new(((t=this.crossTileSymbolIndex)===null||t===void 0?void 0:t.constructor)||Object),this.pauseablePlacement=void 0,this.placement=void 0,this.z=0}setGlobalStateProperty(t,s){var o,u,f;this._checkLoaded();const _=s===null?(f=(u=(o=this.stylesheet.state)===null||o===void 0?void 0:o[t])===null||u===void 0?void 0:u.default)!==null&&f!==void 0?f:null:s;if(l.bR(_,this._globalState[t]))return this;this._globalState[t]=_,this._applyGlobalStateChanges([t])}getGlobalState(){return this._globalState}setGlobalState(t){this._checkLoaded();const s=[];for(const o in t)!l.bR(this._globalState[o],t[o].default)&&(s.push(o),this._globalState[o]=t[o].default);this._applyGlobalStateChanges(s)}_applyGlobalStateChanges(t){if(t.length===0)return;const s=new Set,o={};for(const u of t){o[u]=this._globalState[u];for(const f in this._layers){const _=this._layers[f],b=_.getLayoutAffectingGlobalStateRefs(),T=_.getPaintAffectingGlobalStateRefs(),M=_.getVisibilityAffectingGlobalStateRefs();if(b.has(u)&&s.add(_.source),T.has(u))for(const{name:A,value:R}of T.get(u))this._updatePaintProperty(_,A,R);M?.has(u)&&(_.recalculateVisibility(),this._updateLayer(_))}}this.dispatcher.broadcast("UGS",o);for(const u in this.tileManagers)s.has(u)&&(this._reloadSource(u),this._changed=!0)}loadURL(t,s={},o){this.fire(new l.l("dataloading",{dataType:"style"})),s.validate=typeof s.validate!="boolean"||s.validate;const u=this.map._requestManager.transformRequest(t,"Style");this._loadStyleRequest=new AbortController;const f=this._loadStyleRequest;l.j(u,this._loadStyleRequest).then((_=>{this._loadStyleRequest=null,this._load(_.data,s,o)})).catch((_=>{this._loadStyleRequest=null,_&&!f.signal.aborted&&this.fire(new l.k(_))}))}loadJSON(t,s={},o){this.fire(new l.l("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,ze.frameAsync(this._frameRequest).then((()=>{this._frameRequest=null,s.validate=s.validate!==!1,this._load(t,s,o)})).catch((()=>{}))}loadEmpty(){this.fire(new l.l("dataloading",{dataType:"style"})),this._load(Wo,{validate:!1})}_load(t,s,o){var u,f;let _=s.transformStyle?s.transformStyle(o,t):t;if(!s.validate||!mo(this,l.C(_))){_=Object.assign({},_),this._loaded=!0,this.stylesheet=_;for(const b in _.sources)this.addSource(b,_.sources[b],{validate:!1});_.sprite?this._loadSprite(_.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(_.glyphs),this._createLayers(),this.light=new Kt(this.stylesheet.light),this._setProjectionInternal(((u=this.stylesheet.projection)===null||u===void 0?void 0:u.type)||"mercator"),this.sky=new hr(this.stylesheet.sky),this.map.setTerrain((f=this.stylesheet.terrain)!==null&&f!==void 0?f:null),this.fire(new l.l("data",{dataType:"style"})),this.fire(new l.l("style.load"))}}_createLayers(){var t,s,o;const u=l.bS(this.stylesheet.layers);this.setGlobalState((t=this.stylesheet.state)!==null&&t!==void 0?t:null),this.dispatcher.broadcast("SL",u),this._order=u.map((f=>f.id)),this._layers={},this._serializedLayers=null;for(const f of u){const _=l.bT(f,this._globalState);if(_.setEventedParent(this,{layer:{id:f.id}}),this._layers[f.id]=_,l.bU(_)&&this.tileManagers[_.source]){const b=(o=(s=f.paint)===null||s===void 0?void 0:s["raster-fade-duration"])!==null&&o!==void 0?o:_.paint.get("raster-fade-duration");this.tileManagers[_.source].setRasterFadeDuration(b)}}}_loadSprite(t,s=!1,o=void 0){this.imageManager.setLoaded(!1);const u=new AbortController;let f;this._spriteRequest=u,(function(_,b,T,M){return l._(this,void 0,void 0,(function*(){const A=Ge(_),R=T>1?"@2x":"",z={},O={};for(const{id:V,url:W}of A){const Y=b.transformRequest(pt(W,R,".json"),"SpriteJSON");z[V]=l.j(Y,M);const X=b.transformRequest(pt(W,R,".png"),"SpriteImage");O[V]=Ye.getImage(X,M)}return yield Promise.all([...Object.values(z),...Object.values(O)]),(function(V,W){return l._(this,void 0,void 0,(function*(){const Y={};for(const X in V){Y[X]={};const te=ze.getImageCanvasContext((yield W[X]).data),le=(yield V[X]).data;for(const Q in le){const{width:ne,height:ue,x:ie,y:pe,sdf:Ce,pixelRatio:Pe,stretchX:Me,stretchY:Ie,content:Xe,textFitWidth:Je,textFitHeight:$e}=le[Q];Y[X][Q]={data:null,pixelRatio:Pe,sdf:Ce,stretchX:Me,stretchY:Ie,content:Xe,textFitWidth:Je,textFitHeight:$e,spriteData:{width:ne,height:ue,x:ie,y:pe,context:te}}}}return Y}))})(z,O)}))})(t,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then((_=>{if(this._spriteRequest=null,_)for(const b in _){this._spritesImagesIds[b]=[];const T=this._spritesImagesIds[b]?this._spritesImagesIds[b].filter((M=>!(M in _))):[];for(const M of T)this.imageManager.removeImage(M),this._changedImages[M]=!0;for(const M in _[b]){const A=b==="default"?M:`${b}:${M}`;this._spritesImagesIds[b].push(A),A in this.imageManager.images?this.imageManager.updateImage(A,_[b][M],!1):this.imageManager.addImage(A,_[b][M]),s&&(this._changedImages[A]=!0)}}})).catch((_=>{this._spriteRequest=null,f=_,u.signal.aborted||this.fire(new l.k(f))})).finally((()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),s&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new l.l("data",{dataType:"style"})),o&&o(f)}))}_unloadSprite(){for(const t of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(t),this._changedImages[t]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new l.l("data",{dataType:"style"}))}_validateLayer(t){const s=this.tileManagers[t.source];if(!s)return;const o=t.sourceLayer;if(!o)return;const u=s.getSource();(u.type==="geojson"||u.vectorLayerIds&&u.vectorLayerIds.indexOf(o)===-1)&&this.fire(new l.k(new Error(`Source layer "${o}" does not exist on source "${u.id}" as specified by style layer "${t.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const t in this.tileManagers)if(!this.tileManagers[t].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(t,s=!1){const o=this._serializedAllLayers();if(!t||t.length===0)return Object.values(s?l.bV(o):o);const u=[];for(const f of t)if(o[f]){const _=s?l.bV(o[f]):o[f];u.push(_)}return u}_serializedAllLayers(){let t=this._serializedLayers;if(t)return t;t=this._serializedLayers={};const s=Object.keys(this._layers);for(const o of s){const u=this._layers[o];u.type!=="custom"&&(t[o]=u.serialize())}return t}hasTransitions(){var t,s,o;if(!((t=this.light)===null||t===void 0)&&t.hasTransition()||!((s=this.sky)===null||s===void 0)&&s.hasTransition()||!((o=this.projection)===null||o===void 0)&&o.hasTransition())return!0;for(const u in this.tileManagers)if(this.tileManagers[u].hasTransition())return!0;for(const u in this._layers)if(this._layers[u].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(t){if(!this._loaded)return;const s=this._changed;if(s){const u=Object.keys(this._updatedLayers),f=Object.keys(this._removedLayers);(u.length||f.length)&&this._updateWorkerLayers(u,f);for(const _ in this._updatedSources){const b=this._updatedSources[_];if(b==="reload")this._reloadSource(_);else{if(b!=="clear")throw new Error(`Invalid action ${b}`);this._clearSource(_)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const _ in this._updatedPaintProps)this._layers[_].updateTransitions(t);this.light.updateTransitions(t),this.sky.updateTransitions(t),this._resetUpdates()}const o={};for(const u in this.tileManagers){const f=this.tileManagers[u];o[u]=f.used,f.used=!1}for(const u of this._order){const f=this._layers[u];f.recalculate(t,this._availableImages),!f.isHidden(t.zoom)&&f.source&&(this.tileManagers[f.source].used=!0)}for(const u in o){const f=this.tileManagers[u];!!o[u]!=!!f.used&&f.fire(new l.l("data",{sourceDataType:"visibility",dataType:"source",sourceId:u}))}this.light.recalculate(t),this.sky.recalculate(t),this.projection.recalculate(t),this.z=t.zoom,s&&this.fire(new l.l("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=Object.keys(this._changedImages);if(t.length){for(const s in this.tileManagers)this.tileManagers[s].reloadTilesForDependencies(["icons","patterns"],t);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const t in this.tileManagers)this.tileManagers[t].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(t,s){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(t,!1),removedIds:s})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(t,s={}){var o;this._checkLoaded();const u=this.serialize();if(t=s.transformStyle?s.transformStyle(u,t):t,((o=s.validate)===null||o===void 0||o)&&mo(this,l.C(t)))return!1;(t=l.bV(t)).layers=l.bS(t.layers);const f=l.bW(u,t),_=this._getOperationsToPerform(f);if(_.unimplemented.length>0)throw new Error(`Unimplemented: ${_.unimplemented.join(", ")}.`);if(_.operations.length===0)return!1;for(const b of _.operations)b();return this.stylesheet=t,this._serializedLayers=null,!0}_getOperationsToPerform(t){const s=[],o=[];for(const u of t)switch(u.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":case"setRoll":continue;case"addLayer":s.push((()=>this.addLayer.apply(this,u.args)));break;case"removeLayer":s.push((()=>this.removeLayer.apply(this,u.args)));break;case"setPaintProperty":s.push((()=>this.setPaintProperty.apply(this,u.args)));break;case"setLayoutProperty":s.push((()=>this.setLayoutProperty.apply(this,u.args)));break;case"setFilter":s.push((()=>this.setFilter.apply(this,u.args)));break;case"addSource":s.push((()=>this.addSource.apply(this,u.args)));break;case"removeSource":s.push((()=>this.removeSource.apply(this,u.args)));break;case"setLayerZoomRange":s.push((()=>this.setLayerZoomRange.apply(this,u.args)));break;case"setLight":s.push((()=>this.setLight.apply(this,u.args)));break;case"setGeoJSONSourceData":s.push((()=>this.setGeoJSONSourceData.apply(this,u.args)));break;case"setGlyphs":s.push((()=>this.setGlyphs.apply(this,u.args)));break;case"setSprite":s.push((()=>this.setSprite.apply(this,u.args)));break;case"setTerrain":s.push((()=>this.map.setTerrain.apply(this,u.args)));break;case"setSky":s.push((()=>this.setSky.apply(this,u.args)));break;case"setProjection":this.setProjection.apply(this,u.args);break;case"setGlobalState":s.push((()=>this.setGlobalState.apply(this,u.args)));break;case"setTransition":s.push((()=>{}));break;default:o.push(u.command)}return{operations:s,unimplemented:o}}addImage(t,s){if(this.getImage(t))return this.fire(new l.k(new Error(`An image named "${t}" already exists.`)));this.imageManager.addImage(t,s),this._afterImageUpdated(t)}updateImage(t,s){this.imageManager.updateImage(t,s)}getImage(t){return this.imageManager.getImage(t)}removeImage(t){if(!this.getImage(t))return this.fire(new l.k(new Error(`An image named "${t}" does not exist.`)));this.imageManager.removeImage(t),this._afterImageUpdated(t)}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(),this._changedImages[t]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new l.l("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(t,s,o={}){if(this._checkLoaded(),this.tileManagers[t]!==void 0)throw new Error(`Source "${t}" already exists.`);if(!s.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(s).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(s.type)>=0&&this._validate(l.C.source,`sources.${t}`,s,null,o))return;this.map&&this.map._collectResourceTiming&&(s.collectResourceTiming=!0);const u=this.tileManagers[t]=new Wr(t,s,this.dispatcher);u.style=this,u.setEventedParent(this,(()=>({isSourceLoaded:u.loaded(),source:u.serialize(),sourceId:t}))),u.onAdd(this.map),this._changed=!0}removeSource(t){if(this._checkLoaded(),this.tileManagers[t]===void 0)throw new Error("There is no source with this ID");for(const o in this._layers)if(this._layers[o].source===t)return this.fire(new l.k(new Error(`Source "${t}" cannot be removed while layer "${o}" is using it.`)));const s=this.tileManagers[t];delete this.tileManagers[t],delete this._updatedSources[t],s.fire(new l.l("data",{sourceDataType:"metadata",dataType:"source",sourceId:t})),s.setEventedParent(null),s.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(t,s){if(this._checkLoaded(),this.tileManagers[t]===void 0)throw new Error(`There is no source with this ID=${t}`);const o=this.tileManagers[t].getSource();if(o.type!=="geojson")throw new Error(`geojsonSource.type is ${o.type}, which is !== 'geojson`);o.setData(s),this._changed=!0}getSource(t){return this.tileManagers[t]&&this.tileManagers[t].getSource()}addLayer(t,s,o={}){this._checkLoaded();const u=t.id;if(this.getLayer(u))return void this.fire(new l.k(new Error(`Layer "${u}" already exists on this map.`)));let f;if(t.type==="custom"){if(mo(this,l.bX(t)))return;f=l.bT(t,this._globalState)}else{if("source"in t&&typeof t.source=="object"&&(this.addSource(u,t.source),t=l.bV(t),t=l.e(t,{source:u})),this._validate(l.C.layer,`layers.${u}`,t,{arrayIndex:-1},o))return;f=l.bT(t,this._globalState),this._validateLayer(f),f.setEventedParent(this,{layer:{id:u}})}const _=s?this._order.indexOf(s):this._order.length;if(s&&_===-1)this.fire(new l.k(new Error(`Cannot add layer "${u}" before non-existing layer "${s}".`)));else{if(this._order.splice(_,0,u),this._layerOrderChanged=!0,this._layers[u]=f,this._removedLayers[u]&&f.source&&f.type!=="custom"){const b=this._removedLayers[u];delete this._removedLayers[u],b.type!==f.type?this._updatedSources[f.source]="clear":(this._updatedSources[f.source]="reload",this.tileManagers[f.source].pause())}this._updateLayer(f),f.onAdd&&f.onAdd(this.map)}}moveLayer(t,s){if(this._checkLoaded(),this._changed=!0,!this._layers[t])return void this.fire(new l.k(new Error(`The layer '${t}' does not exist in the map's style and cannot be moved.`)));if(t===s)return;const o=this._order.indexOf(t);this._order.splice(o,1);const u=s?this._order.indexOf(s):this._order.length;s&&u===-1?this.fire(new l.k(new Error(`Cannot move layer "${t}" before non-existing layer "${s}".`))):(this._order.splice(u,0,t),this._layerOrderChanged=!0)}removeLayer(t){this._checkLoaded();const s=this._layers[t];if(!s)return void this.fire(new l.k(new Error(`Cannot remove non-existing layer "${t}".`)));s.setEventedParent(null);const o=this._order.indexOf(t);this._order.splice(o,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[t]=s,delete this._layers[t],this._serializedLayers&&delete this._serializedLayers[t],delete this._updatedLayers[t],delete this._updatedPaintProps[t],s.onRemove&&s.onRemove(this.map)}getLayer(t){return this._layers[t]}getLayersOrder(){return[...this._order]}hasLayer(t){return t in this._layers}setLayerZoomRange(t,s,o){this._checkLoaded();const u=this.getLayer(t);u?u.minzoom===s&&u.maxzoom===o||(s!=null&&(u.minzoom=s),o!=null&&(u.maxzoom=o),this._updateLayer(u)):this.fire(new l.k(new Error(`Cannot set the zoom range of non-existing layer "${t}".`)))}setFilter(t,s,o={}){this._checkLoaded();const u=this.getLayer(t);if(u){if(!l.bR(u.filter,s))return s==null?(u.setFilter(void 0),void this._updateLayer(u)):void(this._validate(l.C.filter,`layers.${u.id}.filter`,s,null,o)||(u.setFilter(l.bV(s)),this._updateLayer(u)))}else this.fire(new l.k(new Error(`Cannot filter non-existing layer "${t}".`)))}getFilter(t){return l.bV(this.getLayer(t).filter)}setLayoutProperty(t,s,o,u={}){this._checkLoaded();const f=this.getLayer(t);f?l.bR(f.getLayoutProperty(s),o)||(f.setLayoutProperty(s,o,u),this._updateLayer(f)):this.fire(new l.k(new Error(`Cannot style non-existing layer "${t}".`)))}getLayoutProperty(t,s){const o=this.getLayer(t);if(o)return o.getLayoutProperty(s);this.fire(new l.k(new Error(`Cannot get style of non-existing layer "${t}".`)))}setPaintProperty(t,s,o,u={}){this._checkLoaded();const f=this.getLayer(t);f?l.bR(f.getPaintProperty(s),o)||this._updatePaintProperty(f,s,o,u):this.fire(new l.k(new Error(`Cannot style non-existing layer "${t}".`)))}_updatePaintProperty(t,s,o,u={}){t.setPaintProperty(s,o,u)&&this._updateLayer(t),l.bU(t)&&s==="raster-fade-duration"&&this.tileManagers[t.source].setRasterFadeDuration(o),this._changed=!0,this._updatedPaintProps[t.id]=!0,this._serializedLayers=null}getPaintProperty(t,s){return this.getLayer(t).getPaintProperty(s)}setFeatureState(t,s){this._checkLoaded();const o=t.source,u=t.sourceLayer,f=this.tileManagers[o];if(f===void 0)return void this.fire(new l.k(new Error(`The source '${o}' does not exist in the map's style.`)));const _=f.getSource().type;_==="geojson"&&u?this.fire(new l.k(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):_!=="vector"||u?(t.id===void 0&&this.fire(new l.k(new Error("The feature id parameter must be provided."))),f.setFeatureState(u,t.id,s)):this.fire(new l.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(t,s){this._checkLoaded();const o=t.source,u=this.tileManagers[o];if(u===void 0)return void this.fire(new l.k(new Error(`The source '${o}' does not exist in the map's style.`)));const f=u.getSource().type,_=f==="vector"?t.sourceLayer:void 0;f!=="vector"||_?s&&typeof t.id!="string"&&typeof t.id!="number"?this.fire(new l.k(new Error("A feature id is required to remove its specific state property."))):u.removeFeatureState(_,t.id,s):this.fire(new l.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(t){this._checkLoaded();const s=t.source,o=t.sourceLayer,u=this.tileManagers[s];if(u!==void 0)return u.getSource().type!=="vector"||o?(t.id===void 0&&this.fire(new l.k(new Error("The feature id parameter must be provided."))),u.getFeatureState(o,t.id)):void this.fire(new l.k(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new l.k(new Error(`The source '${s}' does not exist in the map's style.`)))}getTransition(){return l.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const t=l.bY(this.tileManagers,(f=>f.serialize())),s=this._serializeByIds(this._order,!0),o=this.map.getTerrain()||void 0,u=this.stylesheet;return l.bZ({version:u.version,name:u.name,metadata:u.metadata,light:u.light,sky:u.sky,center:u.center,zoom:u.zoom,bearing:u.bearing,pitch:u.pitch,sprite:u.sprite,glyphs:u.glyphs,transition:u.transition,projection:u.projection,sources:t,layers:s,terrain:o},(f=>f!==void 0))}_updateLayer(t){this._updatedLayers[t.id]=!0,t.source&&!this._updatedSources[t.source]&&this.tileManagers[t.source].getSource().type!=="raster"&&(this._updatedSources[t.source]="reload",this.tileManagers[t.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(t){const s=_=>this._layers[_].type==="fill-extrusion",o={},u=[];for(let _=this._order.length-1;_>=0;_--){const b=this._order[_];if(s(b)){o[b]=_;for(const T of t){const M=T[b];if(M)for(const A of M)u.push(A)}}}u.sort(((_,b)=>b.intersectionZ-_.intersectionZ));const f=[];for(let _=this._order.length-1;_>=0;_--){const b=this._order[_];if(s(b))for(let T=u.length-1;T>=0;T--){const M=u[T].feature;if(o[M.layer.id]<_)break;f.push(M),u.pop()}else for(const T of t){const M=T[b];if(M)for(const A of M)f.push(A.feature)}}return f}queryRenderedFeatures(t,s,o){s&&s.filter&&this._validate(l.C.filter,"queryRenderedFeatures.filter",s.filter,null,s);const u={};if(s&&s.layers){if(!(Array.isArray(s.layers)||s.layers instanceof Set))return this.fire(new l.k(new Error("parameters.layers must be an Array or a Set of strings"))),[];for(const M of s.layers){const A=this._layers[M];if(!A)return this.fire(new l.k(new Error(`The layer '${M}' does not exist in the map's style and cannot be queried for features.`))),[];u[A.source]=!0}}const f=[];s.availableImages=this._availableImages;const _=this._serializedAllLayers(),b=s.layers instanceof Set?s.layers:Array.isArray(s.layers)?new Set(s.layers):null,T=Object.assign(Object.assign({},s),{layers:b,globalState:this._globalState});for(const M in this.tileManagers)s.layers&&!u[M]||f.push(Bs(this.tileManagers[M],this._layers,_,t,T,o,this.map.terrain?(A,R,z)=>this.map.terrain.getElevation(A,R,z):void 0));return this.placement&&f.push((function(M,A,R,z,O,V,W){const Y={},X=V.queryRenderedSymbols(z),te=[];for(const le of Object.keys(X).map(Number))te.push(W[le]);te.sort(Vr);for(const le of te){const Q=le.featureIndex.lookupSymbolFeatures(X[le.bucketInstanceId],A,le.bucketIndex,le.sourceLayerIndex,{filterSpec:O.filter,globalState:O.globalState},O.layers,O.availableImages,M);for(const ne in Q){const ue=Y[ne]=Y[ne]||[],ie=Q[ne];ie.sort(((pe,Ce)=>{const Pe=le.featureSortOrder;if(Pe){const Me=Pe.indexOf(pe.featureIndex);return Pe.indexOf(Ce.featureIndex)-Me}return Ce.featureIndex-pe.featureIndex}));for(const pe of ie)ue.push(pe)}}return(function(le,Q,ne){for(const ue in le)for(const ie of le[ue])ji(ie,ne[Q[ue].source]);return le})(Y,M,R)})(this._layers,_,this.tileManagers,t,T,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(f)}querySourceFeatures(t,s){s?.filter&&this._validate(l.C.filter,"querySourceFeatures.filter",s.filter,null,s);const o=this.tileManagers[t];return o?(function(u,f){const _=u.getRenderableIds().map((M=>u.getTileByID(M))),b=[],T={};for(let M=0;M<_.length;M++){const A=_[M],R=A.tileID.canonical.key;T[R]||(T[R]=!0,A.querySourceFeatures(b,f))}return b})(o,s?Object.assign(Object.assign({},s),{globalState:this._globalState}):{globalState:this._globalState}):[]}getLight(){return this.light.getLight()}setLight(t,s={}){this._checkLoaded();const o=this.light.getLight();let u=!1;for(const _ in t)if(!l.bR(t[_],o[_])){u=!0;break}if(!u)return;const f={now:ot(),transition:l.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(t,s),this.light.updateTransitions(f)}getProjection(){var t;return(t=this.stylesheet)===null||t===void 0?void 0:t.projection}setProjection(t){if(this._checkLoaded(),this.projection){if(this.projection.name===t.type)return;this.projection.destroy(),delete this.projection}this.stylesheet.projection=t,this._setProjectionInternal(t.type)}getSky(){var t;return(t=this.stylesheet)===null||t===void 0?void 0:t.sky}setSky(t,s={}){this._checkLoaded();const o=this.getSky();let u=!1;if(!t&&!o)return;if(t&&!o)u=!0;else if(!t&&o)u=!0;else for(const _ in t)if(!l.bR(t[_],o[_])){u=!0;break}if(!u)return;const f={now:ot(),transition:l.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=t,this.sky.setSky(t,s),this.sky.updateTransitions(f)}_setProjectionInternal(t){const s=(function(o,u){const f={constrainOverride:u};if(Array.isArray(o)){const _=new Ou({type:o});return{projection:_,transform:new fo(f),cameraHelper:new Nu(_)}}switch(o){case"mercator":return{projection:new $i,transform:new Dn(f),cameraHelper:new zn};case"globe":{const _=new Ou({type:["interpolate",["linear"],["zoom"],11,"vertical-perspective",12,"mercator"]});return{projection:_,transform:new fo(f),cameraHelper:new Nu(_)}}case"vertical-perspective":return{projection:new oc,transform:new po(f),cameraHelper:new oi};default:return l.w(`Unknown projection name: ${o}. Falling back to mercator projection.`),{projection:new $i,transform:new Dn(f),cameraHelper:new zn}}})(t,this.map.transformConstrain);this.projection=s.projection,this.map.migrateProjection(s.transform,s.cameraHelper);for(const o in this.tileManagers)this.tileManagers[o].reload()}_validate(t,s,o,u,f={}){return(!f||f.validate!==!1)&&mo(this,t.call(l.C,l.e({key:s,style:this.serialize(),value:o,styleSpec:l.u},u)))}_remove(t=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),_e().off(ce,this._rtlPluginLoaded);for(const s in this._layers)this._layers[s].setEventedParent(null);for(const s in this.tileManagers){const o=this.tileManagers[s];o.setEventedParent(null),o.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),t&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(t)}_clearSource(t){this.tileManagers[t].clearTiles()}_reloadSource(t){this.tileManagers[t].resume(),this.tileManagers[t].reload()}_updateSources(t){for(const s in this.tileManagers)this.tileManagers[s].update(t,this.map.terrain)}_generateCollisionBoxes(){for(const t in this.tileManagers)this._reloadSource(t)}_updatePlacement(t,s,o,u,f=!1){let _=!1,b=!1;const T={};for(const M of this._order){const A=this._layers[M];if(A.type!=="symbol")continue;if(!T[A.source]){const z=this.tileManagers[A.source];T[A.source]=z.getRenderableIds(!0).map((O=>z.getTileByID(O))).sort(((O,V)=>V.tileID.overscaledZ-O.tileID.overscaledZ||(O.tileID.isLessThan(V.tileID)?-1:1)))}const R=this.crossTileSymbolIndex.addLayer(A,T[A.source],t.center.lng);_=_||R}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((f=f||this._layerOrderChanged||o===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(ot(),t.zoom))&&(this.pauseablePlacement=new no(t,this.map.terrain,this._order,f,s,o,u,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,T),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(ot()),b=!0),_&&this.pauseablePlacement.placement.setStale()),b||_)for(const M of this._order){const A=this._layers[M];A.type==="symbol"&&this.placement.updateLayerOpacities(A,T[A.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(ot())}_releaseSymbolFadeTiles(){for(const t in this.tileManagers)this.tileManagers[t].releaseSymbolFadeTiles()}getImages(t,s){return l._(this,void 0,void 0,(function*(){const o=yield this.imageManager.getImages(s.icons);this._updateTilesForChangedImages();const u=this.tileManagers[s.source];return u&&u.setDependencies(s.tileID.key,s.type,s.icons),o}))}getGlyphs(t,s){return l._(this,void 0,void 0,(function*(){const o=yield this.glyphManager.getGlyphs(s.stacks),u=this.tileManagers[s.source];return u&&u.setDependencies(s.tileID.key,s.type,[""]),o}))}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(t,s={}){this._checkLoaded(),t&&this._validate(l.C.glyphs,"glyphs",t,null,s)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=t,this.glyphManager.entries={},this.glyphManager.setURL(t))}getDashes(t,s){return l._(this,void 0,void 0,(function*(){const o={};for(const[u,f]of Object.entries(s.dashes))o[u]=this.lineAtlas.getDash(f.dasharray,f.round);return o}))}addSprite(t,s,o={},u){this._checkLoaded();const f=[{id:t,url:s}],_=[...Ge(this.stylesheet.sprite),...f];this._validate(l.C.sprite,"sprite",_,null,o)||(this.stylesheet.sprite=_,this._loadSprite(f,!0,u))}removeSprite(t){this._checkLoaded();const s=Ge(this.stylesheet.sprite);if(s.find((o=>o.id===t))){if(this._spritesImagesIds[t])for(const o of this._spritesImagesIds[t])this.imageManager.removeImage(o),this._changedImages[o]=!0;s.splice(s.findIndex((o=>o.id===t)),1),this.stylesheet.sprite=s.length>0?s:void 0,delete this._spritesImagesIds[t],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new l.l("data",{dataType:"style"}))}else this.fire(new l.k(new Error(`Sprite "${t}" doesn't exists on this map.`)))}getSprite(){return Ge(this.stylesheet.sprite)}setSprite(t,s={},o){this._checkLoaded(),t&&this._validate(l.C.sprite,"sprite",t,null,s)||(this.stylesheet.sprite=t,t?this._loadSprite(t,!0,o):(this._unloadSprite(),o&&o(null)))}destroy(){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null);for(const t in this.tileManagers){const s=this.tileManagers[t];s.setEventedParent(null),s.onRemove(this.map)}this.tileManagers={},this.imageManager&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this._availableImages=[],this._spritesImagesIds={}),this.glyphManager&&this.glyphManager.destroy();for(const t in this._layers){const s=this._layers[t];s.setEventedParent(null),s.onRemove&&s.onRemove(this.map)}this._setInitialValues(),this.setEventedParent(null),this.dispatcher.unregisterMessageHandler("GG"),this.dispatcher.unregisterMessageHandler("GI"),this.dispatcher.unregisterMessageHandler("GDA"),this.dispatcher.remove(!0),this._listeners={},this._oneTimeListeners={}}}var Rd=l.aU([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class Na{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(t,s,o,u,f,_,b,T,M){this.context=t;let A=this.boundPaintVertexBuffers.length!==u.length;for(let R=0;!A&&R<u.length;R++)this.boundPaintVertexBuffers[R]!==u[R]&&(A=!0);!this.vao||this.boundProgram!==s||this.boundLayoutVertexBuffer!==o||A||this.boundIndexBuffer!==f||this.boundVertexOffset!==_||this.boundDynamicVertexBuffer!==b||this.boundDynamicVertexBuffer2!==T||this.boundDynamicVertexBuffer3!==M?this.freshBind(s,o,u,f,_,b,T,M):(t.bindVertexArray.set(this.vao),b&&b.bind(),f&&f.dynamicDraw&&f.bind(),T&&T.bind(),M&&M.bind())}freshBind(t,s,o,u,f,_,b,T){const M=t.numAttributes,A=this.context,R=A.gl;this.vao&&this.destroy(),this.vao=A.createVertexArray(),A.bindVertexArray.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=s,this.boundPaintVertexBuffers=o,this.boundIndexBuffer=u,this.boundVertexOffset=f,this.boundDynamicVertexBuffer=_,this.boundDynamicVertexBuffer2=b,this.boundDynamicVertexBuffer3=T,s.enableAttributes(R,t);for(const z of o)z.enableAttributes(R,t);_&&_.enableAttributes(R,t),b&&b.enableAttributes(R,t),T&&T.enableAttributes(R,t),s.bind(),s.setVertexAttribPointers(R,t,f);for(const z of o)z.bind(),z.setVertexAttribPointers(R,t,f);_&&(_.bind(),_.setVertexAttribPointers(R,t,f)),u&&u.bind(),b&&(b.bind(),b.setVertexAttribPointers(R,t,f)),T&&(T.bind(),T.setVertexAttribPointers(R,t,f)),A.currentNumAttributes=M}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const Fd=(p,t,s,o,u)=>({u_texture:0,u_ele_delta:p,u_fog_matrix:t,u_fog_color:s?s.properties.get("fog-color"):l.bp.white,u_fog_ground_blend:s?s.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:u?0:s?s.calculateFogBlendOpacity(o):0,u_horizon_color:s?s.properties.get("horizon-color"):l.bp.white,u_horizon_fog_blend:s?s.properties.get("horizon-fog-blend"):1,u_is_globe_mode:u?1:0}),go={mainMatrix:"u_projection_matrix",tileMercatorCoords:"u_projection_tile_mercator_coords",clippingPlane:"u_projection_clipping_plane",projectionTransition:"u_projection_transition",fallbackMatrix:"u_projection_fallback_matrix"};function Va(p){const t=[];for(let s=0;s<p.length;s++){if(p[s]===null)continue;const o=p[s].split(" ");t.push(o.pop())}return t}class Vu{constructor(t,s,o,u,f,_,b,T,M=[]){const A=t.gl;this.program=A.createProgram();const R=Va(s.staticAttributes),z=o?o.getBinderAttributes():[],O=R.concat(z),V=Or.prelude.staticUniforms?Va(Or.prelude.staticUniforms):[],W=b.staticUniforms?Va(b.staticUniforms):[],Y=s.staticUniforms?Va(s.staticUniforms):[],X=o?o.getBinderUniforms():[],te=V.concat(W).concat(Y).concat(X),le=[];for(const Pe of te)le.indexOf(Pe)<0&&le.push(Pe);const Q=o?o.defines():[];hs(A)&&Q.unshift("#version 300 es"),f&&Q.push("#define OVERDRAW_INSPECTOR;"),_&&Q.push("#define TERRAIN3D;"),T&&Q.push(T),M&&Q.push(...M);let ne=Q.concat(Or.prelude.fragmentSource,b.fragmentSource,s.fragmentSource).join(`
`),ue=Q.concat(Or.prelude.vertexSource,b.vertexSource,s.vertexSource).join(`
`);hs(A)||(ne=(function(Pe){return Pe.replace(/\bin\s/g,"varying ").replace("out highp vec4 fragColor;","").replace(/fragColor/g,"gl_FragColor").replace(/texture\(/g,"texture2D(")})(ne),ue=(function(Pe){return Pe.replace(/\bin\s/g,"attribute ").replace(/\bout\s/g,"varying ").replace(/texture\(/g,"texture2D(")})(ue));const ie=A.createShader(A.FRAGMENT_SHADER);if(A.isContextLost())return void(this.failedToCreate=!0);if(A.shaderSource(ie,ne),A.compileShader(ie),!A.getShaderParameter(ie,A.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${A.getShaderInfoLog(ie)}`);A.attachShader(this.program,ie);const pe=A.createShader(A.VERTEX_SHADER);if(A.isContextLost())return void(this.failedToCreate=!0);if(A.shaderSource(pe,ue),A.compileShader(pe),!A.getShaderParameter(pe,A.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${A.getShaderInfoLog(pe)}`);A.attachShader(this.program,pe),this.attributes={};const Ce={};this.numAttributes=O.length;for(let Pe=0;Pe<this.numAttributes;Pe++)O[Pe]&&(A.bindAttribLocation(this.program,Pe,O[Pe]),this.attributes[O[Pe]]=Pe);if(A.linkProgram(this.program),!A.getProgramParameter(this.program,A.LINK_STATUS))throw new Error(`Program failed to link: ${A.getProgramInfoLog(this.program)}`);A.deleteShader(pe),A.deleteShader(ie);for(let Pe=0;Pe<le.length;Pe++){const Me=le[Pe];if(Me&&!Ce[Me]){const Ie=A.getUniformLocation(this.program,Me);Ie&&(Ce[Me]=Ie)}}this.fixedUniforms=u(t,Ce),this.terrainUniforms=((Pe,Me)=>({u_depth:new l.b_(Pe,Me.u_depth),u_terrain:new l.b_(Pe,Me.u_terrain),u_terrain_dim:new l.bq(Pe,Me.u_terrain_dim),u_terrain_matrix:new l.c0(Pe,Me.u_terrain_matrix),u_terrain_unpack:new l.c1(Pe,Me.u_terrain_unpack),u_terrain_exaggeration:new l.bq(Pe,Me.u_terrain_exaggeration)}))(t,Ce),this.projectionUniforms=((Pe,Me)=>({u_projection_matrix:new l.c0(Pe,Me.u_projection_matrix),u_projection_tile_mercator_coords:new l.c1(Pe,Me.u_projection_tile_mercator_coords),u_projection_clipping_plane:new l.c1(Pe,Me.u_projection_clipping_plane),u_projection_transition:new l.bq(Pe,Me.u_projection_transition),u_projection_fallback_matrix:new l.c0(Pe,Me.u_projection_fallback_matrix)}))(t,Ce),this.binderUniforms=o?o.getUniforms(t,Ce):[]}draw(t,s,o,u,f,_,b,T,M,A,R,z,O,V,W,Y,X,te,le){const Q=t.gl;if(this.failedToCreate)return;if(t.program.set(this.program),t.setDepthMode(o),t.setStencilMode(u),t.setColorMode(f),t.setCullFace(_),T){t.activeTexture.set(Q.TEXTURE2),Q.bindTexture(Q.TEXTURE_2D,T.depthTexture),t.activeTexture.set(Q.TEXTURE3),Q.bindTexture(Q.TEXTURE_2D,T.texture);for(const ue in this.terrainUniforms)this.terrainUniforms[ue].set(T[ue])}if(M)for(const ue in M)this.projectionUniforms[go[ue]].set(M[ue]);if(b)for(const ue in this.fixedUniforms)this.fixedUniforms[ue].set(b[ue]);Y&&Y.setUniforms(t,this.binderUniforms,V,{zoom:W});let ne=0;switch(s){case Q.LINES:ne=2;break;case Q.TRIANGLES:ne=3;break;case Q.LINE_STRIP:ne=1}for(const ue of O.get()){const ie=ue.vaos||(ue.vaos={});(ie[A]||(ie[A]=new Na)).bind(t,this,R,Y?Y.getPaintVertexBuffers():[],z,ue.vertexOffset,X,te,le),Q.drawElements(s,ue.primitiveLength*ne,Q.UNSIGNED_SHORT,ue.primitiveOffset*ne*2)}}}function $u(p,t,s){const o=1/l.aN(s,1,t.transform.tileZoom),u=Math.pow(2,s.tileID.overscaledZ),f=s.tileSize*Math.pow(2,t.transform.tileZoom)/u,_=f*(s.tileID.canonical.x+s.tileID.wrap*u),b=f*s.tileID.canonical.y;return{u_image:0,u_texsize:s.imageAtlasTexture.size,u_scale:[o,p.fromScale,p.toScale],u_fade:p.t,u_pixel_coord_upper:[_>>16,b>>16],u_pixel_coord_lower:[65535&_,65535&b]}}const uc=(p,t,s,o)=>{const u=p.style.light,f=u.properties.get("position"),_=[f.x,f.y,f.z],b=l.c4();u.properties.get("anchor")==="viewport"&&l.c5(b,p.transform.bearingInRadians),l.c6(_,_,b);const T=p.transform.transformLightDirection(_),M=u.properties.get("color");return{u_lightpos:_,u_lightpos_globe:T,u_lightintensity:u.properties.get("intensity"),u_lightcolor:[M.r,M.g,M.b],u_vertical_gradient:+t,u_opacity:s,u_fill_translate:o}},hc=(p,t,s,o,u,f,_)=>l.e(uc(p,t,s,o),$u(f,p,_),{u_height_factor:-Math.pow(2,u.overscaledZ)/_.tileSize/8}),dc=(p,t,s,o)=>l.e($u(t,p,s),{u_fill_translate:o}),Uu=(p,t)=>({u_world:p,u_fill_translate:t}),qu=(p,t,s,o,u)=>l.e(dc(p,t,s,u),{u_world:o}),Gu=(p,t,s,o,u)=>{const f=p.transform;let _,b,T=0;if(s.paint.get("circle-pitch-alignment")==="map"){const M=l.aN(t,1,f.zoom);_=!0,b=[M,M],T=M/(l.a5*Math.pow(2,t.tileID.overscaledZ))*2*Math.PI*u}else _=!1,b=f.pixelsToGLUnits;return{u_camera_to_center_distance:f.cameraToCenterDistance,u_scale_with_map:+(s.paint.get("circle-pitch-scale")==="map"),u_pitch_with_map:+_,u_device_pixel_ratio:p.pixelRatio,u_extrude_scale:b,u_globe_extrude_scale:T,u_translate:o}},Ln=p=>({u_pixel_extrude_scale:[1/p.width,1/p.height]}),Zu=p=>({u_viewport_size:[p.width,p.height]}),pc=(p,t=1)=>({u_color:p,u_overlay:0,u_overlay_scale:t}),_o=(p,t,s,o)=>{const u=l.aN(p,1,t)/(l.a5*Math.pow(2,p.tileID.overscaledZ))*2*Math.PI*o;return{u_extrude_scale:l.aN(p,1,t),u_intensity:s,u_globe_extrude_scale:u}},Hu=(p,t,s,o)=>{const u=l.N();l.c7(u,0,p.width,p.height,0,0,1);const f=p.context.gl;return{u_matrix:u,u_world:[f.drawingBufferWidth,f.drawingBufferHeight],u_image:s,u_color_ramp:o,u_opacity:t.paint.get("heatmap-opacity")}},$a=(p,t,s)=>{const o=s.paint.get("hillshade-accent-color");let u;switch(s.paint.get("hillshade-method")){case"basic":u=4;break;case"combined":u=1;break;case"igor":u=2;break;case"multidirectional":u=3;break;default:u=0}const f=s.getIlluminationProperties();for(let _=0;_<f.directionRadians.length;_++)s.paint.get("hillshade-illumination-anchor")==="viewport"&&(f.directionRadians[_]+=p.transform.bearingInRadians);return{u_image:0,u_latrange:Od(0,t.tileID),u_exaggeration:s.paint.get("hillshade-exaggeration"),u_altitudes:f.altitudeRadians,u_azimuths:f.directionRadians,u_accent:o,u_method:u,u_highlights:f.highlightColor,u_shadows:f.shadowColor}},Ld=(p,t)=>{const s=t.stride,o=l.N();return l.c7(o,0,l.a5,-l.a5,0,0,1),l.O(o,o,[0,-l.a5,0]),{u_matrix:o,u_image:1,u_dimension:[s,s],u_zoom:p.overscaledZ,u_unpack:t.getUnpackVector()}};function Od(p,t){const s=Math.pow(2,t.canonical.z),o=t.canonical.y;return[new l.a9(0,o/s).toLngLat().lat,new l.a9(0,(o+1)/s).toLngLat().lat]}const Wu=(p,t,s=0)=>({u_image:0,u_unpack:t.getUnpackVector(),u_dimension:[t.stride,t.stride],u_elevation_stops:1,u_color_stops:4,u_color_ramp_size:s,u_opacity:p.paint.get("color-relief-opacity")}),Xo=(p,t,s,o)=>{const u=p.transform;return{u_translation:qa(p,t,s),u_ratio:o/l.aN(t,1,u.zoom),u_device_pixel_ratio:p.pixelRatio,u_units_to_pixels:[1/u.pixelsToGLUnits[0],1/u.pixelsToGLUnits[1]]}},Xu=(p,t,s,o,u)=>l.e(Xo(p,t,s,o),{u_image:0,u_image_height:u}),fc=(p,t,s,o,u)=>{const f=p.transform,_=bs(t,f);return{u_translation:qa(p,t,s),u_texsize:t.imageAtlasTexture.size,u_ratio:o/l.aN(t,1,f.zoom),u_device_pixel_ratio:p.pixelRatio,u_image:0,u_scale:[_,u.fromScale,u.toScale],u_fade:u.t,u_units_to_pixels:[1/f.pixelsToGLUnits[0],1/f.pixelsToGLUnits[1]]}},Yu=(p,t,s,o,u)=>{const f=bs(t,p.transform);return l.e(Xo(p,t,s,o),{u_tileratio:f,u_crossfade_from:u.fromScale,u_crossfade_to:u.toScale,u_image:0,u_mix:u.t,u_lineatlas_width:p.lineAtlas.width,u_lineatlas_height:p.lineAtlas.height})},Ua=(p,t,s,o,u,f)=>{const _=bs(t,p.transform);return l.e(Xo(p,t,s,o),{u_image:0,u_image_height:f,u_tileratio:_,u_crossfade_from:u.fromScale,u_crossfade_to:u.toScale,u_image_dash:1,u_mix:u.t,u_lineatlas_width:p.lineAtlas.width,u_lineatlas_height:p.lineAtlas.height})};function bs(p,t){return 1/l.aN(p,1,t.tileZoom)}function qa(p,t,s){return l.aO(p.transform,t,s.paint.get("line-translate"),s.paint.get("line-translate-anchor"))}const mc=(p,t,s,o,u)=>{return{u_tl_parent:p,u_scale_parent:t,u_buffer_scale:1,u_fade_t:s.mix,u_opacity:s.opacity*o.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:o.paint.get("raster-brightness-min"),u_brightness_high:o.paint.get("raster-brightness-max"),u_saturation_factor:(_=o.paint.get("raster-saturation"),_>0?1-1/(1.001-_):-_),u_contrast_factor:(f=o.paint.get("raster-contrast"),f>0?1/(1-f):1+f),u_spin_weights:gc(o.paint.get("raster-hue-rotate")),u_coords_top:[u[0].x,u[0].y,u[1].x,u[1].y],u_coords_bottom:[u[3].x,u[3].y,u[2].x,u[2].y]};var f,_};function gc(p){p*=Math.PI/180;const t=Math.sin(p),s=Math.cos(p);return[(2*s+1)/3,(-Math.sqrt(3)*t-s+1)/3,(Math.sqrt(3)*t-s+1)/3]}const _c=(p,t,s,o,u,f,_,b,T,M,A,R,z)=>{const O=_.transform;return{u_is_size_zoom_constant:+(p==="constant"||p==="source"),u_is_size_feature_constant:+(p==="constant"||p==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:O.cameraToCenterDistance,u_pitch:O.pitch/360*2*Math.PI,u_rotate_symbol:+s,u_aspect_ratio:O.width/O.height,u_fade_change:_.options.fadeDuration?_.symbolFadeChange:1,u_label_plane_matrix:b,u_coord_matrix:T,u_is_text:+A,u_pitch_with_map:+o,u_is_along_line:u,u_is_variable_anchor:f,u_texsize:R,u_texture:0,u_translation:M,u_pitched_scale:z}},Ga=(p,t,s,o,u,f,_,b,T,M,A,R,z,O)=>{const V=_.transform;return l.e(_c(p,t,s,o,u,f,_,b,T,M,A,R,O),{u_gamma_scale:o?Math.cos(V.pitch*Math.PI/180)*V.cameraToCenterDistance:1,u_device_pixel_ratio:_.pixelRatio,u_is_halo:1})},On=(p,t,s,o,u,f,_,b,T,M,A,R,z)=>l.e(Ga(p,t,s,o,u,f,_,b,T,M,!0,A,0,z),{u_texsize_icon:R,u_texture_icon:1}),yc=(p,t)=>({u_opacity:p,u_color:t}),Bd=(p,t,s,o,u)=>l.e((function(f,_,b,T){const M=b.imageManager.getPattern(f.from.toString()),A=b.imageManager.getPattern(f.to.toString()),{width:R,height:z}=b.imageManager.getPixelSize(),O=Math.pow(2,T.tileID.overscaledZ),V=T.tileSize*Math.pow(2,b.transform.tileZoom)/O,W=V*(T.tileID.canonical.x+T.tileID.wrap*O),Y=V*T.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:M.tl,u_pattern_br_a:M.br,u_pattern_tl_b:A.tl,u_pattern_br_b:A.br,u_texsize:[R,z],u_mix:_.t,u_pattern_size_a:M.displaySize,u_pattern_size_b:A.displaySize,u_scale_a:_.fromScale,u_scale_b:_.toScale,u_tile_units_to_pixels:1/l.aN(T,1,b.transform.tileZoom),u_pixel_coord_upper:[W>>16,Y>>16],u_pixel_coord_lower:[65535&W,65535&Y]}})(s,u,t,o),{u_opacity:p}),Ju=(p,t)=>{},jd={fillExtrusion:(p,t)=>({u_lightpos:new l.c2(p,t.u_lightpos),u_lightpos_globe:new l.c2(p,t.u_lightpos_globe),u_lightintensity:new l.bq(p,t.u_lightintensity),u_lightcolor:new l.c2(p,t.u_lightcolor),u_vertical_gradient:new l.bq(p,t.u_vertical_gradient),u_opacity:new l.bq(p,t.u_opacity),u_fill_translate:new l.c3(p,t.u_fill_translate)}),fillExtrusionPattern:(p,t)=>({u_lightpos:new l.c2(p,t.u_lightpos),u_lightpos_globe:new l.c2(p,t.u_lightpos_globe),u_lightintensity:new l.bq(p,t.u_lightintensity),u_lightcolor:new l.c2(p,t.u_lightcolor),u_vertical_gradient:new l.bq(p,t.u_vertical_gradient),u_height_factor:new l.bq(p,t.u_height_factor),u_opacity:new l.bq(p,t.u_opacity),u_fill_translate:new l.c3(p,t.u_fill_translate),u_image:new l.b_(p,t.u_image),u_texsize:new l.c3(p,t.u_texsize),u_pixel_coord_upper:new l.c3(p,t.u_pixel_coord_upper),u_pixel_coord_lower:new l.c3(p,t.u_pixel_coord_lower),u_scale:new l.c2(p,t.u_scale),u_fade:new l.bq(p,t.u_fade)}),fill:(p,t)=>({u_fill_translate:new l.c3(p,t.u_fill_translate)}),fillPattern:(p,t)=>({u_image:new l.b_(p,t.u_image),u_texsize:new l.c3(p,t.u_texsize),u_pixel_coord_upper:new l.c3(p,t.u_pixel_coord_upper),u_pixel_coord_lower:new l.c3(p,t.u_pixel_coord_lower),u_scale:new l.c2(p,t.u_scale),u_fade:new l.bq(p,t.u_fade),u_fill_translate:new l.c3(p,t.u_fill_translate)}),fillOutline:(p,t)=>({u_world:new l.c3(p,t.u_world),u_fill_translate:new l.c3(p,t.u_fill_translate)}),fillOutlinePattern:(p,t)=>({u_world:new l.c3(p,t.u_world),u_image:new l.b_(p,t.u_image),u_texsize:new l.c3(p,t.u_texsize),u_pixel_coord_upper:new l.c3(p,t.u_pixel_coord_upper),u_pixel_coord_lower:new l.c3(p,t.u_pixel_coord_lower),u_scale:new l.c2(p,t.u_scale),u_fade:new l.bq(p,t.u_fade),u_fill_translate:new l.c3(p,t.u_fill_translate)}),circle:(p,t)=>({u_camera_to_center_distance:new l.bq(p,t.u_camera_to_center_distance),u_scale_with_map:new l.b_(p,t.u_scale_with_map),u_pitch_with_map:new l.b_(p,t.u_pitch_with_map),u_extrude_scale:new l.c3(p,t.u_extrude_scale),u_device_pixel_ratio:new l.bq(p,t.u_device_pixel_ratio),u_globe_extrude_scale:new l.bq(p,t.u_globe_extrude_scale),u_translate:new l.c3(p,t.u_translate)}),collisionBox:(p,t)=>({u_pixel_extrude_scale:new l.c3(p,t.u_pixel_extrude_scale)}),collisionCircle:(p,t)=>({u_viewport_size:new l.c3(p,t.u_viewport_size)}),debug:(p,t)=>({u_color:new l.b$(p,t.u_color),u_overlay:new l.b_(p,t.u_overlay),u_overlay_scale:new l.bq(p,t.u_overlay_scale)}),depth:Ju,clippingMask:Ju,heatmap:(p,t)=>({u_extrude_scale:new l.bq(p,t.u_extrude_scale),u_intensity:new l.bq(p,t.u_intensity),u_globe_extrude_scale:new l.bq(p,t.u_globe_extrude_scale)}),heatmapTexture:(p,t)=>({u_matrix:new l.c0(p,t.u_matrix),u_world:new l.c3(p,t.u_world),u_image:new l.b_(p,t.u_image),u_color_ramp:new l.b_(p,t.u_color_ramp),u_opacity:new l.bq(p,t.u_opacity)}),hillshade:(p,t)=>({u_image:new l.b_(p,t.u_image),u_latrange:new l.c3(p,t.u_latrange),u_exaggeration:new l.bq(p,t.u_exaggeration),u_altitudes:new l.c9(p,t.u_altitudes),u_azimuths:new l.c9(p,t.u_azimuths),u_accent:new l.b$(p,t.u_accent),u_method:new l.b_(p,t.u_method),u_shadows:new l.c8(p,t.u_shadows),u_highlights:new l.c8(p,t.u_highlights)}),hillshadePrepare:(p,t)=>({u_matrix:new l.c0(p,t.u_matrix),u_image:new l.b_(p,t.u_image),u_dimension:new l.c3(p,t.u_dimension),u_zoom:new l.bq(p,t.u_zoom),u_unpack:new l.c1(p,t.u_unpack)}),colorRelief:(p,t)=>({u_image:new l.b_(p,t.u_image),u_unpack:new l.c1(p,t.u_unpack),u_dimension:new l.c3(p,t.u_dimension),u_elevation_stops:new l.b_(p,t.u_elevation_stops),u_color_stops:new l.b_(p,t.u_color_stops),u_color_ramp_size:new l.b_(p,t.u_color_ramp_size),u_opacity:new l.bq(p,t.u_opacity)}),line:(p,t)=>({u_translation:new l.c3(p,t.u_translation),u_ratio:new l.bq(p,t.u_ratio),u_device_pixel_ratio:new l.bq(p,t.u_device_pixel_ratio),u_units_to_pixels:new l.c3(p,t.u_units_to_pixels)}),lineGradient:(p,t)=>({u_translation:new l.c3(p,t.u_translation),u_ratio:new l.bq(p,t.u_ratio),u_device_pixel_ratio:new l.bq(p,t.u_device_pixel_ratio),u_units_to_pixels:new l.c3(p,t.u_units_to_pixels),u_image:new l.b_(p,t.u_image),u_image_height:new l.bq(p,t.u_image_height)}),linePattern:(p,t)=>({u_translation:new l.c3(p,t.u_translation),u_texsize:new l.c3(p,t.u_texsize),u_ratio:new l.bq(p,t.u_ratio),u_device_pixel_ratio:new l.bq(p,t.u_device_pixel_ratio),u_image:new l.b_(p,t.u_image),u_units_to_pixels:new l.c3(p,t.u_units_to_pixels),u_scale:new l.c2(p,t.u_scale),u_fade:new l.bq(p,t.u_fade)}),lineSDF:(p,t)=>({u_translation:new l.c3(p,t.u_translation),u_ratio:new l.bq(p,t.u_ratio),u_device_pixel_ratio:new l.bq(p,t.u_device_pixel_ratio),u_units_to_pixels:new l.c3(p,t.u_units_to_pixels),u_image:new l.b_(p,t.u_image),u_mix:new l.bq(p,t.u_mix),u_tileratio:new l.bq(p,t.u_tileratio),u_crossfade_from:new l.bq(p,t.u_crossfade_from),u_crossfade_to:new l.bq(p,t.u_crossfade_to),u_lineatlas_width:new l.bq(p,t.u_lineatlas_width),u_lineatlas_height:new l.bq(p,t.u_lineatlas_height)}),lineGradientSDF:(p,t)=>({u_translation:new l.c3(p,t.u_translation),u_ratio:new l.bq(p,t.u_ratio),u_device_pixel_ratio:new l.bq(p,t.u_device_pixel_ratio),u_units_to_pixels:new l.c3(p,t.u_units_to_pixels),u_image:new l.b_(p,t.u_image),u_image_height:new l.bq(p,t.u_image_height),u_tileratio:new l.bq(p,t.u_tileratio),u_crossfade_from:new l.bq(p,t.u_crossfade_from),u_crossfade_to:new l.bq(p,t.u_crossfade_to),u_image_dash:new l.b_(p,t.u_image_dash),u_mix:new l.bq(p,t.u_mix),u_lineatlas_width:new l.bq(p,t.u_lineatlas_width),u_lineatlas_height:new l.bq(p,t.u_lineatlas_height)}),raster:(p,t)=>({u_tl_parent:new l.c3(p,t.u_tl_parent),u_scale_parent:new l.bq(p,t.u_scale_parent),u_buffer_scale:new l.bq(p,t.u_buffer_scale),u_fade_t:new l.bq(p,t.u_fade_t),u_opacity:new l.bq(p,t.u_opacity),u_image0:new l.b_(p,t.u_image0),u_image1:new l.b_(p,t.u_image1),u_brightness_low:new l.bq(p,t.u_brightness_low),u_brightness_high:new l.bq(p,t.u_brightness_high),u_saturation_factor:new l.bq(p,t.u_saturation_factor),u_contrast_factor:new l.bq(p,t.u_contrast_factor),u_spin_weights:new l.c2(p,t.u_spin_weights),u_coords_top:new l.c1(p,t.u_coords_top),u_coords_bottom:new l.c1(p,t.u_coords_bottom)}),symbolIcon:(p,t)=>({u_is_size_zoom_constant:new l.b_(p,t.u_is_size_zoom_constant),u_is_size_feature_constant:new l.b_(p,t.u_is_size_feature_constant),u_size_t:new l.bq(p,t.u_size_t),u_size:new l.bq(p,t.u_size),u_camera_to_center_distance:new l.bq(p,t.u_camera_to_center_distance),u_pitch:new l.bq(p,t.u_pitch),u_rotate_symbol:new l.b_(p,t.u_rotate_symbol),u_aspect_ratio:new l.bq(p,t.u_aspect_ratio),u_fade_change:new l.bq(p,t.u_fade_change),u_label_plane_matrix:new l.c0(p,t.u_label_plane_matrix),u_coord_matrix:new l.c0(p,t.u_coord_matrix),u_is_text:new l.b_(p,t.u_is_text),u_pitch_with_map:new l.b_(p,t.u_pitch_with_map),u_is_along_line:new l.b_(p,t.u_is_along_line),u_is_variable_anchor:new l.b_(p,t.u_is_variable_anchor),u_texsize:new l.c3(p,t.u_texsize),u_texture:new l.b_(p,t.u_texture),u_translation:new l.c3(p,t.u_translation),u_pitched_scale:new l.bq(p,t.u_pitched_scale)}),symbolSDF:(p,t)=>({u_is_size_zoom_constant:new l.b_(p,t.u_is_size_zoom_constant),u_is_size_feature_constant:new l.b_(p,t.u_is_size_feature_constant),u_size_t:new l.bq(p,t.u_size_t),u_size:new l.bq(p,t.u_size),u_camera_to_center_distance:new l.bq(p,t.u_camera_to_center_distance),u_pitch:new l.bq(p,t.u_pitch),u_rotate_symbol:new l.b_(p,t.u_rotate_symbol),u_aspect_ratio:new l.bq(p,t.u_aspect_ratio),u_fade_change:new l.bq(p,t.u_fade_change),u_label_plane_matrix:new l.c0(p,t.u_label_plane_matrix),u_coord_matrix:new l.c0(p,t.u_coord_matrix),u_is_text:new l.b_(p,t.u_is_text),u_pitch_with_map:new l.b_(p,t.u_pitch_with_map),u_is_along_line:new l.b_(p,t.u_is_along_line),u_is_variable_anchor:new l.b_(p,t.u_is_variable_anchor),u_texsize:new l.c3(p,t.u_texsize),u_texture:new l.b_(p,t.u_texture),u_gamma_scale:new l.bq(p,t.u_gamma_scale),u_device_pixel_ratio:new l.bq(p,t.u_device_pixel_ratio),u_is_halo:new l.b_(p,t.u_is_halo),u_translation:new l.c3(p,t.u_translation),u_pitched_scale:new l.bq(p,t.u_pitched_scale)}),symbolTextAndIcon:(p,t)=>({u_is_size_zoom_constant:new l.b_(p,t.u_is_size_zoom_constant),u_is_size_feature_constant:new l.b_(p,t.u_is_size_feature_constant),u_size_t:new l.bq(p,t.u_size_t),u_size:new l.bq(p,t.u_size),u_camera_to_center_distance:new l.bq(p,t.u_camera_to_center_distance),u_pitch:new l.bq(p,t.u_pitch),u_rotate_symbol:new l.b_(p,t.u_rotate_symbol),u_aspect_ratio:new l.bq(p,t.u_aspect_ratio),u_fade_change:new l.bq(p,t.u_fade_change),u_label_plane_matrix:new l.c0(p,t.u_label_plane_matrix),u_coord_matrix:new l.c0(p,t.u_coord_matrix),u_is_text:new l.b_(p,t.u_is_text),u_pitch_with_map:new l.b_(p,t.u_pitch_with_map),u_is_along_line:new l.b_(p,t.u_is_along_line),u_is_variable_anchor:new l.b_(p,t.u_is_variable_anchor),u_texsize:new l.c3(p,t.u_texsize),u_texsize_icon:new l.c3(p,t.u_texsize_icon),u_texture:new l.b_(p,t.u_texture),u_texture_icon:new l.b_(p,t.u_texture_icon),u_gamma_scale:new l.bq(p,t.u_gamma_scale),u_device_pixel_ratio:new l.bq(p,t.u_device_pixel_ratio),u_is_halo:new l.b_(p,t.u_is_halo),u_translation:new l.c3(p,t.u_translation),u_pitched_scale:new l.bq(p,t.u_pitched_scale)}),background:(p,t)=>({u_opacity:new l.bq(p,t.u_opacity),u_color:new l.b$(p,t.u_color)}),backgroundPattern:(p,t)=>({u_opacity:new l.bq(p,t.u_opacity),u_image:new l.b_(p,t.u_image),u_pattern_tl_a:new l.c3(p,t.u_pattern_tl_a),u_pattern_br_a:new l.c3(p,t.u_pattern_br_a),u_pattern_tl_b:new l.c3(p,t.u_pattern_tl_b),u_pattern_br_b:new l.c3(p,t.u_pattern_br_b),u_texsize:new l.c3(p,t.u_texsize),u_mix:new l.bq(p,t.u_mix),u_pattern_size_a:new l.c3(p,t.u_pattern_size_a),u_pattern_size_b:new l.c3(p,t.u_pattern_size_b),u_scale_a:new l.bq(p,t.u_scale_a),u_scale_b:new l.bq(p,t.u_scale_b),u_pixel_coord_upper:new l.c3(p,t.u_pixel_coord_upper),u_pixel_coord_lower:new l.c3(p,t.u_pixel_coord_lower),u_tile_units_to_pixels:new l.bq(p,t.u_tile_units_to_pixels)}),terrain:(p,t)=>({u_texture:new l.b_(p,t.u_texture),u_ele_delta:new l.bq(p,t.u_ele_delta),u_fog_matrix:new l.c0(p,t.u_fog_matrix),u_fog_color:new l.b$(p,t.u_fog_color),u_fog_ground_blend:new l.bq(p,t.u_fog_ground_blend),u_fog_ground_blend_opacity:new l.bq(p,t.u_fog_ground_blend_opacity),u_horizon_color:new l.b$(p,t.u_horizon_color),u_horizon_fog_blend:new l.bq(p,t.u_horizon_fog_blend),u_is_globe_mode:new l.bq(p,t.u_is_globe_mode)}),terrainDepth:(p,t)=>({u_ele_delta:new l.bq(p,t.u_ele_delta)}),terrainCoords:(p,t)=>({u_texture:new l.b_(p,t.u_texture),u_terrain_coords_id:new l.bq(p,t.u_terrain_coords_id),u_ele_delta:new l.bq(p,t.u_ele_delta)}),projectionErrorMeasurement:(p,t)=>({u_input:new l.bq(p,t.u_input),u_output_expected:new l.bq(p,t.u_output_expected)}),atmosphere:(p,t)=>({u_sun_pos:new l.c2(p,t.u_sun_pos),u_atmosphere_blend:new l.bq(p,t.u_atmosphere_blend),u_globe_position:new l.c2(p,t.u_globe_position),u_globe_radius:new l.bq(p,t.u_globe_radius),u_inv_proj_matrix:new l.c0(p,t.u_inv_proj_matrix)}),sky:(p,t)=>({u_sky_color:new l.b$(p,t.u_sky_color),u_horizon_color:new l.b$(p,t.u_horizon_color),u_horizon:new l.c3(p,t.u_horizon),u_horizon_normal:new l.c3(p,t.u_horizon_normal),u_sky_horizon_blend:new l.bq(p,t.u_sky_horizon_blend),u_sky_blend:new l.bq(p,t.u_sky_blend)})};class Nd{constructor(t,s,o){this.context=t;const u=t.gl;this.buffer=u.createBuffer(),this.dynamicDraw=!!o,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),u.bufferData(u.ELEMENT_ARRAY_BUFFER,s.arrayBuffer,this.dynamicDraw?u.DYNAMIC_DRAW:u.STATIC_DRAW),this.dynamicDraw||delete s.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){const s=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),s.bufferSubData(s.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Ku={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Vd{constructor(t,s,o,u){this.length=s.length,this.attributes=o,this.itemSize=s.bytesPerElement,this.dynamicDraw=u,this.context=t;const f=t.gl;this.buffer=f.createBuffer(),t.bindVertexBuffer.set(this.buffer),f.bufferData(f.ARRAY_BUFFER,s.arrayBuffer,this.dynamicDraw?f.DYNAMIC_DRAW:f.STATIC_DRAW),this.dynamicDraw||delete s.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){if(t.length!==this.length)throw new Error(`Length of new data is ${t.length}, which doesn't match current length of ${this.length}`);const s=this.context.gl;this.bind(),s.bufferSubData(s.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,s){for(let o=0;o<this.attributes.length;o++){const u=s.attributes[this.attributes[o].name];u!==void 0&&t.enableVertexAttribArray(u)}}setVertexAttribPointers(t,s,o){for(let u=0;u<this.attributes.length;u++){const f=this.attributes[u],_=s.attributes[f.name];_!==void 0&&t.vertexAttribPointer(_,f.components,t[Ku[f.type]],!1,this.itemSize,f.offset+this.itemSize*(o||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class lr{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Za extends lr{getDefault(){return l.bp.transparent}set(t){const s=this.current;(t.r!==s.r||t.g!==s.g||t.b!==s.b||t.a!==s.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Ha extends lr{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Wa extends lr{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class xc extends lr{getDefault(){return[!0,!0,!0,!0]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||t[2]!==s[2]||t[3]!==s[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Bn extends lr{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Yo extends lr{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class yo extends lr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const s=this.current;(t.func!==s.func||t.ref!==s.ref||t.mask!==s.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class ds extends lr{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||t[2]!==s[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class Qu extends lr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.STENCIL_TEST):s.disable(s.STENCIL_TEST),this.current=t,this.dirty=!1}}class eh extends lr{getDefault(){return[0,1]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class vc extends lr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST),this.current=t,this.dirty=!1}}class jn extends lr{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Xa extends lr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.BLEND):s.disable(s.BLEND),this.current=t,this.dirty=!1}}class Ya extends lr{getDefault(){const t=this.gl;return[t.ONE,t.ZERO]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||this.dirty)&&(this.gl.blendFunc(t[0],t[1]),this.current=t,this.dirty=!1)}}class Jo extends lr{getDefault(){return l.bp.transparent}set(t){const s=this.current;(t.r!==s.r||t.g!==s.g||t.b!==s.b||t.a!==s.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Ja extends lr{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquation(t),this.current=t,this.dirty=!1)}}class th extends lr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;t?s.enable(s.CULL_FACE):s.disable(s.CULL_FACE),this.current=t,this.dirty=!1}}class xo extends lr{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class vo extends lr{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}class rh extends lr{getDefault(){return null}set(t){(t!==this.current||this.dirty)&&(this.gl.useProgram(t),this.current=t,this.dirty=!1)}}class bc extends lr{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class qt extends lr{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const s=this.current;(t[0]!==s[0]||t[1]!==s[1]||t[2]!==s[2]||t[3]!==s[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Ka extends lr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindFramebuffer(s.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class $d extends lr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindRenderbuffer(s.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class ih extends lr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindTexture(s.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class Ko extends lr{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.bindBuffer(s.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Ud extends lr{getDefault(){return null}set(t){const s=this.gl;s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class qd extends lr{getDefault(){return null}set(t){var s;if(t===this.current&&!this.dirty)return;const o=this.gl;hs(o)?o.bindVertexArray(t):(s=o.getExtension("OES_vertex_array_object"))===null||s===void 0||s.bindVertexArrayOES(t),this.current=t,this.dirty=!1}}class sh extends lr{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class Gd extends lr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class wc extends lr{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const s=this.gl;s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class bo extends lr{constructor(t,s){super(t),this.context=t,this.parent=s}getDefault(){return null}}class Qo extends bo{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const s=this.gl;s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Qa extends bo{set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const s=this.gl;s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Tc extends bo{set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const s=this.gl;s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,t),this.current=t,this.dirty=!1}}const Sc="Framebuffer is not complete";class el{constructor(t,s,o,u,f){this.context=t,this.width=s,this.height=o;const _=t.gl,b=this.framebuffer=_.createFramebuffer();if(this.colorAttachment=new Qo(t,b),u)this.depthAttachment=f?new Tc(t,b):new Qa(t,b);else if(f)throw new Error("Stencil cannot be set without depth");if(_.checkFramebufferStatus(_.FRAMEBUFFER)!==_.FRAMEBUFFER_COMPLETE)throw new Error(Sc)}destroy(){const t=this.context.gl,s=this.colorAttachment.get();if(s&&t.deleteTexture(s),this.depthAttachment){const o=this.depthAttachment.get();o&&t.deleteRenderbuffer(o)}t.deleteFramebuffer(this.framebuffer)}}class tl{constructor(t){var s,o;if(this.gl=t,this.clearColor=new Za(this),this.clearDepth=new Ha(this),this.clearStencil=new Wa(this),this.colorMask=new xc(this),this.depthMask=new Bn(this),this.stencilMask=new Yo(this),this.stencilFunc=new yo(this),this.stencilOp=new ds(this),this.stencilTest=new Qu(this),this.depthRange=new eh(this),this.depthTest=new vc(this),this.depthFunc=new jn(this),this.blend=new Xa(this),this.blendFunc=new Ya(this),this.blendColor=new Jo(this),this.blendEquation=new Ja(this),this.cullFace=new th(this),this.cullFaceSide=new xo(this),this.frontFace=new vo(this),this.program=new rh(this),this.activeTexture=new bc(this),this.viewport=new qt(this),this.bindFramebuffer=new Ka(this),this.bindRenderbuffer=new $d(this),this.bindTexture=new ih(this),this.bindVertexBuffer=new Ko(this),this.bindElementBuffer=new Ud(this),this.bindVertexArray=new qd(this),this.pixelStoreUnpack=new sh(this),this.pixelStoreUnpackPremultiplyAlpha=new Gd(this),this.pixelStoreUnpackFlipY=new wc(this),this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),hs(t)){this.HALF_FLOAT=t.HALF_FLOAT;const u=t.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(s=t.RGBA16F)!==null&&s!==void 0?s:u?.RGBA16F_EXT,this.RGB16F=(o=t.RGB16F)!==null&&o!==void 0?o:u?.RGB16F_EXT,t.getExtension("EXT_color_buffer_float")}else{t.getExtension("EXT_color_buffer_half_float"),t.getExtension("OES_texture_half_float_linear");const u=t.getExtension("OES_texture_half_float");this.HALF_FLOAT=u?.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,s){return new Nd(this,t,s)}createVertexBuffer(t,s,o){return new Vd(this,t,s,o)}createRenderbuffer(t,s,o){const u=this.gl,f=u.createRenderbuffer();return this.bindRenderbuffer.set(f),u.renderbufferStorage(u.RENDERBUFFER,t,s,o),this.bindRenderbuffer.set(null),f}createFramebuffer(t,s,o,u){return new el(this,t,s,o,u)}clear({color:t,depth:s,stencil:o}){const u=this.gl;let f=0;t&&(f|=u.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set([!0,!0,!0,!0])),s!==void 0&&(f|=u.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(s),this.depthMask.set(!0)),o!==void 0&&(f|=u.STENCIL_BUFFER_BIT,this.clearStencil.set(o),this.stencilMask.set(255)),u.clear(f)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){l.bR(t.blendFunction,xr.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor)),this.colorMask.set(t.mask)}createVertexArray(){var t;return hs(this.gl)?this.gl.createVertexArray():(t=this.gl.getExtension("OES_vertex_array_object"))===null||t===void 0?void 0:t.createVertexArrayOES()}deleteVertexArray(t){var s;return hs(this.gl)?this.gl.deleteVertexArray(t):(s=this.gl.getExtension("OES_vertex_array_object"))===null||s===void 0?void 0:s.deleteVertexArrayOES(t)}unbindVAO(){this.bindVertexArray.set(null)}}let gn;function Nn(p,t,s,o,u){const f=p.context,_=p.transform,b=f.gl,T=p.useProgram("collisionBox"),M=[];let A=0,R=0;for(let X=0;X<o.length;X++){const te=o[X],le=t.getTile(te).getBucket(s);if(!le)continue;const Q=u?le.textCollisionBox:le.iconCollisionBox,ne=le.collisionCircleArray;ne.length>0&&(M.push({circleArray:ne,circleOffset:R,coord:te}),A+=ne.length/4,R=A),Q&&T.draw(f,b.LINES,jt.disabled,rr.disabled,p.colorModeForRenderPass(),tr.disabled,Ln(p.transform),p.style.map.terrain&&p.style.map.terrain.getTerrainData(te),_.getProjectionData({overscaledTileID:te,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),s.id,Q.layoutVertexBuffer,Q.indexBuffer,Q.segments,null,p.transform.zoom,null,null,Q.collisionVertexBuffer)}if(!u||!M.length)return;const z=p.useProgram("collisionCircle"),O=new l.ca;O.resize(4*A),O._trim();let V=0;for(const X of M)for(let te=0;te<X.circleArray.length/4;te++){const le=4*te,Q=X.circleArray[le+0],ne=X.circleArray[le+1],ue=X.circleArray[le+2],ie=X.circleArray[le+3];O.emplace(V++,Q,ne,ue,ie,0),O.emplace(V++,Q,ne,ue,ie,1),O.emplace(V++,Q,ne,ue,ie,2),O.emplace(V++,Q,ne,ue,ie,3)}(!gn||gn.length<2*A)&&(gn=(function(X){const te=2*X,le=new l.cc;le.resize(te),le._trim();for(let Q=0;Q<te;Q++){const ne=6*Q;le.uint16[ne+0]=4*Q+0,le.uint16[ne+1]=4*Q+1,le.uint16[ne+2]=4*Q+2,le.uint16[ne+3]=4*Q+2,le.uint16[ne+4]=4*Q+3,le.uint16[ne+5]=4*Q+0}return le})(A));const W=f.createIndexBuffer(gn,!0),Y=f.createVertexBuffer(O,l.cb.members,!0);for(const X of M){const te=Zu(p.transform);z.draw(f,b.TRIANGLES,jt.disabled,rr.disabled,p.colorModeForRenderPass(),tr.disabled,te,p.style.map.terrain&&p.style.map.terrain.getTerrainData(X.coord),null,s.id,Y,W,l.aX.simpleSegment(0,2*X.circleOffset,X.circleArray.length,X.circleArray.length/2),null,p.transform.zoom,null,null,null)}Y.destroy(),W.destroy()}const Pc=l.ar(new Float32Array(16));function Zd(p,t,s,o,u,f){const{horizontalAlign:_,verticalAlign:b}=l.aS(p);return new l.P((-(_-.5)*t/u+o[0])*f,(-(b-.5)*s/u+o[1])*f)}function ea(p,t,s,o,u,f){const _=t.tileAnchorPoint.add(new l.P(t.translation[0],t.translation[1]));if(t.pitchWithMap){let b=o.mult(f);s||(b=b.rotate(-u));const T=_.add(b);return Mt(T.x,T.y,t.pitchedLabelPlaneMatrix,t.getElevation).point}if(s){const b=Be(t.tileAnchorPoint.x+1,t.tileAnchorPoint.y,t).point.sub(p),T=Math.atan(b.y/b.x)+(b.x<0?Math.PI:0);return p.add(o.rotate(T))}return p.add(o)}function Hd(p,t,s,o,u,f,_,b,T,M,A,R){const z=p.text.placedSymbolArray,O=p.text.dynamicLayoutVertexArray,V=p.icon.dynamicLayoutVertexArray,W={};O.clear();for(let Y=0;Y<z.length;Y++){const X=z.get(Y),te=X.hidden||!X.crossTileID||p.allowVerticalPlacement&&!X.placedOrientation?null:o[X.crossTileID];if(te){const le=new l.P(X.anchorX,X.anchorY),Q={getElevation:R,width:u.width,height:u.height,pitchedLabelPlaneMatrix:f,pitchWithMap:s,transform:u,tileAnchorPoint:le,translation:M,unwrappedTileID:A},ne=s?Ve(le.x,le.y,Q):Be(le.x,le.y,Q),ue=hn(u.cameraToCenterDistance,ne.signedDistanceFromCamera);let ie=l.aA(p.textSizeData,b,X)*ue/l.aM;s&&(ie*=p.tilePixelRatio/_);const{width:pe,height:Ce,anchor:Pe,textOffset:Me,textBoxScale:Ie}=te,Xe=Zd(Pe,pe,Ce,Me,Ie,ie),Je=u.getPitchedTextCorrection(le.x+M[0],le.y+M[1],A),$e=ea(ne.point,Q,t,Xe,-u.bearingInRadians,Je),it=p.allowVerticalPlacement&&X.placedOrientation===l.az.vertical?Math.PI/2:0;for(let Ft=0;Ft<X.numGlyphs;Ft++)l.aG(O,$e,it);T&&X.associatedIconIndex>=0&&(W[X.associatedIconIndex]={shiftedAnchor:$e,angle:it})}else Yi(X.numGlyphs,O)}if(T){V.clear();const Y=p.icon.placedSymbolArray;for(let X=0;X<Y.length;X++){const te=Y.get(X);if(te.hidden)Yi(te.numGlyphs,V);else{const le=W[X];if(le)for(let Q=0;Q<te.numGlyphs;Q++)l.aG(V,le.shiftedAnchor,le.angle);else Yi(te.numGlyphs,V)}}p.icon.dynamicLayoutVertexBuffer.updateData(V)}p.text.dynamicLayoutVertexBuffer.updateData(O)}function nh(p,t,s){return s.iconsInText&&t?"symbolTextAndIcon":p?"symbolSDF":"symbolIcon"}function ta(p,t,s,o,u,f,_,b,T,M,A,R,z){const O=p.context,V=O.gl,W=p.transform,Y=b==="map",X=T==="map",te=b!=="viewport"&&s.layout.get("symbol-placement")!=="point",le=Y&&!X&&!te,Q=!s.layout.get("symbol-sort-key").isConstant();let ne=!1;const ue=p.getDepthModeForSublayer(0,jt.ReadOnly),ie=s._unevaluatedLayout.hasValue("text-variable-anchor")||s._unevaluatedLayout.hasValue("text-variable-anchor-offset"),pe=[],Ce=W.getCircleRadiusCorrection();for(const Pe of o){const Me=t.getTile(Pe),Ie=Me.getBucket(s);if(!Ie)continue;const Xe=u?Ie.text:Ie.icon;if(!Xe||!Xe.segments.get().length||!Xe.hasVisibleVertices)continue;const Je=Xe.programConfigurations.get(s.id),$e=u||Ie.sdfIcons,it=u?Ie.textSizeData:Ie.iconSizeData,Ft=X||W.pitch!==0,pr=p.useProgram(nh($e,u,Ie),Je),Ir=l.ay(it,W.zoom),vr=p.style.map.terrain&&p.style.map.terrain.getTerrainData(Pe);let Dr,br,qr,zr,gi=[0,0],si=null;if(u)br=Me.glyphAtlasTexture,qr=V.LINEAR,Dr=Me.glyphAtlasTexture.size,Ie.iconsInText&&(gi=Me.imageAtlasTexture.size,si=Me.imageAtlasTexture,zr=Ft||p.options.rotating||p.options.zooming||it.kind==="composite"||it.kind==="camera"?V.LINEAR:V.NEAREST);else{const Pr=s.layout.get("icon-size").constantOr(0)!==1||Ie.iconsNeedLinear;br=Me.imageAtlasTexture,qr=$e||p.options.rotating||p.options.zooming||Pr||Ft?V.LINEAR:V.NEAREST,Dr=Me.imageAtlasTexture.size}const Kr=l.aN(Me,1,p.transform.zoom),Ei=Pi(Y,p.transform,Kr),bn=l.N();l.aB(bn,Ei);const Js=Cn(X,Y,p.transform,Kr),$s=l.aO(W,Me,f,_),Qi=W.getProjectionData({overscaledTileID:Pe,applyGlobeMatrix:!z,applyTerrainMatrix:!0}),Zn=ie&&Ie.hasTextData(),ba=s.layout.get("icon-text-fit")!=="none"&&Zn&&Ie.hasIconData();if(te){const Pr=p.style.map.terrain?(hi,di)=>p.style.map.terrain.getElevation(Pe,hi,di):null,wr=s.layout.get("text-rotation-alignment")==="map";K(Ie,p,u,Ei,bn,X,M,wr,Pe.toUnwrapped(),W.width,W.height,$s,Pr)}const Hn=u&&ie||ba,ms=te||Hn?Pc:X?Ei:p.transform.clipSpaceToPixelsMatrix,Us=$e&&s.paint.get(u?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Es;Es=$e?Ie.iconsInText?On(it.kind,Ir,le,X,te,Hn,p,ms,Js,$s,Dr,gi,Ce):Ga(it.kind,Ir,le,X,te,Hn,p,ms,Js,$s,u,Dr,0,Ce):_c(it.kind,Ir,le,X,te,Hn,p,ms,Js,$s,u,Dr,Ce);const Ms={program:pr,buffers:Xe,uniformValues:Es,projectionData:Qi,atlasTexture:br,atlasTextureIcon:si,atlasInterpolation:qr,atlasInterpolationIcon:zr,isSDF:$e,hasHalo:Us};if(Q&&Ie.canOverlap){ne=!0;const Pr=Xe.segments.get();for(const wr of Pr)pe.push({segments:new l.aX([wr]),sortKey:wr.sortKey,state:Ms,terrainData:vr})}else pe.push({segments:Xe.segments,sortKey:0,state:Ms,terrainData:vr})}ne&&pe.sort(((Pe,Me)=>Pe.sortKey-Me.sortKey));for(const Pe of pe){const Me=Pe.state;if(O.activeTexture.set(V.TEXTURE0),Me.atlasTexture.bind(Me.atlasInterpolation,V.CLAMP_TO_EDGE),Me.atlasTextureIcon&&(O.activeTexture.set(V.TEXTURE1),Me.atlasTextureIcon&&Me.atlasTextureIcon.bind(Me.atlasInterpolationIcon,V.CLAMP_TO_EDGE)),Me.isSDF){const Ie=Me.uniformValues;Me.hasHalo&&(Ie.u_is_halo=1,rl(Me.buffers,Pe.segments,s,p,Me.program,ue,A,R,Ie,Me.projectionData,Pe.terrainData)),Ie.u_is_halo=0}rl(Me.buffers,Pe.segments,s,p,Me.program,ue,A,R,Me.uniformValues,Me.projectionData,Pe.terrainData)}}function rl(p,t,s,o,u,f,_,b,T,M,A){const R=o.context;u.draw(R,R.gl.TRIANGLES,f,_,b,tr.backCCW,T,A,M,s.id,p.layoutVertexBuffer,p.indexBuffer,t,s.paint,o.transform.zoom,p.programConfigurations.get(s.id),p.dynamicLayoutVertexBuffer,p.opacityVertexBuffer)}function oh(p,t,s,o,u){const f=p.context,_=f.gl,b=rr.disabled,T=new xr([_.ONE,_.ONE],l.bp.transparent,[!0,!0,!0,!0]),M=t.getBucket(s);if(!M)return;const A=o.key;let R=s.heatmapFbos.get(A);R||(R=ra(f,t.tileSize,t.tileSize),s.heatmapFbos.set(A,R)),f.bindFramebuffer.set(R.framebuffer),f.viewport.set([0,0,t.tileSize,t.tileSize]),f.clear({color:l.bp.transparent});const z=M.programConfigurations.get(s.id),O=p.useProgram("heatmap",z,!u),V=p.transform.getProjectionData({overscaledTileID:t.tileID,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),W=p.style.map.terrain.getTerrainData(o);O.draw(f,_.TRIANGLES,jt.disabled,b,T,tr.disabled,_o(t,p.transform.zoom,s.paint.get("heatmap-intensity"),1),W,V,s.id,M.layoutVertexBuffer,M.indexBuffer,M.segments,s.paint,p.transform.zoom,z)}function ah(p,t,s,o,u){const f=p.context,_=f.gl,b=p.transform;f.setColorMode(p.colorModeForRenderPass());const T=il(f,t),M=s.key,A=t.heatmapFbos.get(M);if(!A)return;f.activeTexture.set(_.TEXTURE0),_.bindTexture(_.TEXTURE_2D,A.colorAttachment.get()),f.activeTexture.set(_.TEXTURE1),T.bind(_.LINEAR,_.CLAMP_TO_EDGE);const R=b.getProjectionData({overscaledTileID:s,applyTerrainMatrix:u,applyGlobeMatrix:!o});p.useProgram("heatmapTexture").draw(f,_.TRIANGLES,jt.disabled,rr.disabled,p.colorModeForRenderPass(),tr.disabled,Hu(p,t,0,1),null,R,t.id,p.rasterBoundsBuffer,p.quadTriangleIndexBuffer,p.rasterBoundsSegments,t.paint,b.zoom),A.destroy(),t.heatmapFbos.delete(M)}function ra(p,t,s){var o,u;const f=p.gl,_=f.createTexture();f.bindTexture(f.TEXTURE_2D,_),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);const b=(o=p.HALF_FLOAT)!==null&&o!==void 0?o:f.UNSIGNED_BYTE,T=(u=p.RGBA16F)!==null&&u!==void 0?u:f.RGBA;f.texImage2D(f.TEXTURE_2D,0,T,t,s,0,f.RGBA,b,null);const M=p.createFramebuffer(t,s,!1,!1);return M.colorAttachment.set(_),M}function il(p,t){return t.colorRampTexture||(t.colorRampTexture=new l.T(p,t.colorRamp,p.gl.RGBA)),t.colorRampTexture}function lh(p,t,s,o,u,f,_,b){let T=256;if(u.stepInterpolant){const M=t.getSource().maxzoom,A=_.canonical.z===M?Math.ceil(1<<p.transform.maxZoom-_.canonical.z):1;T=l.an(l.ce(f.maxLineLength/l.a5*1024*A),256,s.maxTextureSize)}return b.gradient=l.cf({expression:u.gradientExpression(),evaluationKey:"lineProgress",resolution:T,image:b.gradient||void 0,clips:f.lineClipsArray}),b.texture?b.texture.update(b.gradient):b.texture=new l.T(s,b.gradient,o.RGBA),b.version=u.gradientVersion,b.texture}function ch(p,t,s,o,u){p.activeTexture.set(t.TEXTURE0),s.imageAtlasTexture.bind(t.LINEAR,t.CLAMP_TO_EDGE),o.updatePaintBuffers(u)}function Yr(p,t,s,o,u,f){(u||p.lineAtlas.dirty)&&(t.activeTexture.set(s.TEXTURE0),p.lineAtlas.bind(t)),o.updatePaintBuffers(f)}function Vn(p,t,s,o,u,f,_){const b=f.gradients[u.id];let T=b.texture;u.gradientVersion!==b.version&&(T=lh(p,t,s,o,u,f,_,b)),s.activeTexture.set(o.TEXTURE0),T.bind(u.stepInterpolant?o.NEAREST:o.LINEAR,o.CLAMP_TO_EDGE)}function is(p,t,s,o,u,f,_,b,T){const M=f.gradients[u.id];let A=M.texture;u.gradientVersion!==M.version&&(A=lh(p,t,s,o,u,f,_,M)),s.activeTexture.set(o.TEXTURE0),A.bind(u.stepInterpolant?o.NEAREST:o.LINEAR,o.CLAMP_TO_EDGE),s.activeTexture.set(o.TEXTURE1),p.lineAtlas.bind(s),b.updatePaintBuffers(T)}function sl(p,t,s,o,u){if(!s||!o||!o.imageAtlas)return;const f=o.imageAtlas.patternPositions;let _=f[s.to.toString()],b=f[s.from.toString()];if(!_&&b&&(_=b),!b&&_&&(b=_),!_||!b){const T=u.getPaintProperty(t);_=f[T],b=f[T]}_&&b&&p.setConstantPatternPositions(_,b)}function ia(p,t,s,o,u,f,_,b){const T=p.context.gl,M="fill-pattern",A=s.paint.get(M),R=A&&A.constantOr(1),z=s.getCrossfadeParameters();let O,V,W,Y,X;const te=p.transform,le=s.paint.get("fill-translate"),Q=s.paint.get("fill-translate-anchor");_?(V=R&&!s.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",O=T.LINES):(V=R?"fillPattern":"fill",O=T.TRIANGLES);const ne=A.constantOr(null);for(const ue of o){const ie=t.getTile(ue);if(R&&!ie.patternsLoaded())continue;const pe=ie.getBucket(s);if(!pe)continue;const Ce=pe.programConfigurations.get(s.id),Pe=p.useProgram(V,Ce),Me=p.style.map.terrain&&p.style.map.terrain.getTerrainData(ue);R&&(p.context.activeTexture.set(T.TEXTURE0),ie.imageAtlasTexture.bind(T.LINEAR,T.CLAMP_TO_EDGE),Ce.updatePaintBuffers(z)),sl(Ce,M,ne,ie,s);const Ie=te.getProjectionData({overscaledTileID:ue,applyGlobeMatrix:!b,applyTerrainMatrix:!0}),Xe=l.aO(te,ie,le,Q);if(_){Y=pe.indexBuffer2,X=pe.segments2;const $e=[T.drawingBufferWidth,T.drawingBufferHeight];W=V==="fillOutlinePattern"&&R?qu(p,z,ie,$e,Xe):Uu($e,Xe)}else Y=pe.indexBuffer,X=pe.segments,W=R?dc(p,z,ie,Xe):{u_fill_translate:Xe};const Je=p.stencilModeForClipping(ue);Pe.draw(p.context,O,u,Je,f,tr.backCCW,W,Me,Ie,s.id,pe.layoutVertexBuffer,Y,X,s.paint,p.transform.zoom,Ce)}}function nl(p,t,s,o,u,f,_,b){const T=p.context,M=T.gl,A="fill-extrusion-pattern",R=s.paint.get(A),z=R.constantOr(1),O=s.getCrossfadeParameters(),V=s.paint.get("fill-extrusion-opacity"),W=R.constantOr(null),Y=p.transform;for(const X of o){const te=t.getTile(X),le=te.getBucket(s);if(!le)continue;const Q=p.style.map.terrain&&p.style.map.terrain.getTerrainData(X),ne=le.programConfigurations.get(s.id),ue=p.useProgram(z?"fillExtrusionPattern":"fillExtrusion",ne);z&&(p.context.activeTexture.set(M.TEXTURE0),te.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),ne.updatePaintBuffers(O));const ie=Y.getProjectionData({overscaledTileID:X,applyGlobeMatrix:!b,applyTerrainMatrix:!0});sl(ne,A,W,te,s);const pe=l.aO(Y,te,s.paint.get("fill-extrusion-translate"),s.paint.get("fill-extrusion-translate-anchor")),Ce=s.paint.get("fill-extrusion-vertical-gradient"),Pe=z?hc(p,Ce,V,pe,X,O,te):uc(p,Ce,V,pe);ue.draw(T,T.gl.TRIANGLES,u,f,_,tr.backCCW,Pe,Q,ie,s.id,le.layoutVertexBuffer,le.indexBuffer,le.segments,s.paint,p.transform.zoom,ne,p.style.map.terrain&&le.centroidVertexBuffer)}}function _n(p,t,s,o,u,f,_,b,T){var M;const A=p.style.projection,R=p.context,z=p.transform,O=R.gl,V=[`#define NUM_ILLUMINATION_SOURCES ${s.paint.get("hillshade-highlight-color").values.length}`],W=p.useProgram("hillshade",null,!1,V),Y=!p.options.moving;for(const X of o){const te=t.getTile(X),le=te.fbo;if(!le)continue;const Q=A.getMeshFromTileID(R,X.canonical,b,!0,"raster"),ne=(M=p.style.map.terrain)===null||M===void 0?void 0:M.getTerrainData(X);R.activeTexture.set(O.TEXTURE0),O.bindTexture(O.TEXTURE_2D,le.colorAttachment.get());const ue=z.getProjectionData({overscaledTileID:X,aligned:Y,applyGlobeMatrix:!T,applyTerrainMatrix:!0});W.draw(R,O.TRIANGLES,f,u[X.overscaledZ],_,tr.backCCW,$a(p,te,s),ne,ue,s.id,Q.vertexBuffer,Q.indexBuffer,Q.segments)}}function sa(p,t,s,o,u,f,_,b,T){var M;const A=p.style.projection,R=p.context,z=p.transform,O=R.gl,V=p.useProgram("colorRelief"),W=!p.options.moving;let Y=!0,X=0;for(const te of o){const le=t.getTile(te),Q=le.dem;if(Y){const Pe=O.getParameter(O.MAX_TEXTURE_SIZE),{elevationTexture:Me,colorTexture:Ie}=s.getColorRampTextures(R,Pe,Q.getUnpackVector());R.activeTexture.set(O.TEXTURE1),Me.bind(O.NEAREST,O.CLAMP_TO_EDGE),R.activeTexture.set(O.TEXTURE4),Ie.bind(O.LINEAR,O.CLAMP_TO_EDGE),Y=!1,X=Me.size[0]}if(!Q||!Q.data)continue;const ne=Q.stride,ue=Q.getPixels();if(R.activeTexture.set(O.TEXTURE0),R.pixelStoreUnpackPremultiplyAlpha.set(!1),le.demTexture=le.demTexture||p.getTileTexture(ne),le.demTexture){const Pe=le.demTexture;Pe.update(ue,{premultiply:!1}),Pe.bind(O.LINEAR,O.CLAMP_TO_EDGE)}else le.demTexture=new l.T(R,ue,O.RGBA,{premultiply:!1}),le.demTexture.bind(O.LINEAR,O.CLAMP_TO_EDGE);const ie=A.getMeshFromTileID(R,te.canonical,b,!0,"raster"),pe=(M=p.style.map.terrain)===null||M===void 0?void 0:M.getTerrainData(te),Ce=z.getProjectionData({overscaledTileID:te,aligned:W,applyGlobeMatrix:!T,applyTerrainMatrix:!0});V.draw(R,O.TRIANGLES,f,u[te.overscaledZ],_,tr.backCCW,Wu(s,le.dem,X),pe,Ce,s.id,ie.vertexBuffer,ie.indexBuffer,ie.segments)}}const $n=[new l.P(0,0),new l.P(l.a5,0),new l.P(l.a5,l.a5),new l.P(0,l.a5)];function wo(p,t,s,o,u,f,_,b,T=!1,M=!1){const A=o[o.length-1].overscaledZ,R=p.context,z=R.gl,O=p.useProgram("raster"),V=p.transform,W=p.style.projection,Y=p.colorModeForRenderPass(),X=!p.options.moving,te=s.paint.get("raster-opacity"),le=s.paint.get("raster-resampling"),Q=s.paint.get("raster-fade-duration"),ne=!!p.style.map.terrain;for(const ue of o){const ie=p.getDepthModeForSublayer(ue.overscaledZ-A,te===1?jt.ReadWrite:jt.ReadOnly,z.LESS),pe=t.getTile(ue),Ce=le==="nearest"?z.NEAREST:z.LINEAR;R.activeTexture.set(z.TEXTURE0),pe.texture.bind(Ce,z.CLAMP_TO_EDGE,z.LINEAR_MIPMAP_NEAREST),R.activeTexture.set(z.TEXTURE1);const{parentTile:Pe,parentScaleBy:Me,parentTopLeft:Ie,fadeValues:Xe}=uh(pe,t,Q,ne);pe.fadeOpacity=Xe.tileOpacity,Pe?(Pe.fadeOpacity=Xe.parentTileOpacity,Pe.texture.bind(Ce,z.CLAMP_TO_EDGE,z.LINEAR_MIPMAP_NEAREST)):pe.texture.bind(Ce,z.CLAMP_TO_EDGE,z.LINEAR_MIPMAP_NEAREST),pe.texture.useMipmap&&R.extTextureFilterAnisotropic&&p.transform.pitch>20&&z.texParameterf(z.TEXTURE_2D,R.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,R.extTextureFilterAnisotropicMax);const Je=p.style.map.terrain&&p.style.map.terrain.getTerrainData(ue),$e=V.getProjectionData({overscaledTileID:ue,aligned:X,applyGlobeMatrix:!M,applyTerrainMatrix:!0}),it=mc(Ie,Me,Xe.fadeMix,s,b),Ft=W.getMeshFromTileID(R,ue.canonical,f,_,"raster");O.draw(R,z.TRIANGLES,ie,u?u[ue.overscaledZ]:rr.disabled,Y,T?tr.frontCCW:tr.backCCW,it,Je,$e,s.id,Ft.vertexBuffer,Ft.indexBuffer,Ft.segments)}}function uh(p,t,s,o){const u={parentTile:null,parentScaleBy:1,parentTopLeft:[0,0],fadeValues:{tileOpacity:1,parentTileOpacity:1,fadeMix:{opacity:1,mix:0}}};if(s===0||o)return u;if(p.fadingParentID){const f=t.getLoadedTile(p.fadingParentID);if(!f)return u;const _=Math.pow(2,f.tileID.overscaledZ-p.tileID.overscaledZ),b=[p.tileID.canonical.x*_%1,p.tileID.canonical.y*_%1],T=(function(M,A,R){const z=ot(),O=(z-A.timeAdded)/R,V=M.fadingDirection===Ee.Incoming,W=l.an((z-M.timeAdded)/R,0,1),Y=l.an(1-O,0,1),X=V?W:Y;return{tileOpacity:X,parentTileOpacity:V?Y:W,fadeMix:{opacity:1,mix:1-X}}})(p,f,s);return{parentTile:f,parentScaleBy:_,parentTopLeft:b,fadeValues:T}}if(p.selfFading){const f=(function(_,b){const T=(ot()-_.timeAdded)/b,M=l.an(T,0,1);return{tileOpacity:M,fadeMix:{opacity:M,mix:0}}})(p,s);return{parentTile:null,parentScaleBy:1,parentTopLeft:[0,0],fadeValues:f}}return u}const hh=new l.bp(1,0,0,1),dh=new l.bp(0,1,0,1),ph=new l.bp(0,0,1,1),fh=new l.bp(1,0,1,1),yn=new l.bp(0,1,1,1);function Ec(p,t,s,o){na(p,0,t+s/2,p.transform.width,s,o)}function Mc(p,t,s,o){na(p,t-s/2,0,s,p.transform.height,o)}function na(p,t,s,o,u,f){const _=p.context,b=_.gl;b.enable(b.SCISSOR_TEST),b.scissor(t*p.pixelRatio,s*p.pixelRatio,o*p.pixelRatio,u*p.pixelRatio),_.clear({color:f}),b.disable(b.SCISSOR_TEST)}function mh(p,t,s){const o=p.context,u=o.gl,f=p.useProgram("debug"),_=jt.disabled,b=rr.disabled,T=p.colorModeForRenderPass(),M="$debug",A=p.style.map.terrain&&p.style.map.terrain.getTerrainData(s);o.activeTexture.set(u.TEXTURE0);const R=t.getTileByID(s.key).latestRawTileData,z=Math.floor((R&&R.byteLength||0)/1024),O=t.getTile(s).tileSize,V=512/Math.min(O,512)*(s.overscaledZ/p.transform.zoom)*.5;let W=s.canonical.toString();s.overscaledZ!==s.canonical.z&&(W+=` => ${s.overscaledZ}`),(function(X,te){X.initDebugOverlayCanvas();const le=X.debugOverlayCanvas,Q=X.context.gl,ne=X.debugOverlayCanvas.getContext("2d");ne.clearRect(0,0,le.width,le.height),ne.shadowColor="white",ne.shadowBlur=2,ne.lineWidth=1.5,ne.strokeStyle="white",ne.textBaseline="top",ne.font="bold 36px Open Sans, sans-serif",ne.fillText(te,5,5),ne.strokeText(te,5,5),X.debugOverlayTexture.update(le),X.debugOverlayTexture.bind(Q.LINEAR,Q.CLAMP_TO_EDGE)})(p,`${W} ${z}kB`);const Y=p.transform.getProjectionData({overscaledTileID:s,applyGlobeMatrix:!0,applyTerrainMatrix:!0});f.draw(o,u.TRIANGLES,_,b,xr.alphaBlended,tr.disabled,pc(l.bp.transparent,V),null,Y,M,p.debugBuffer,p.quadTriangleIndexBuffer,p.debugSegments),f.draw(o,u.LINE_STRIP,_,b,T,tr.disabled,pc(l.bp.red),A,Y,M,p.debugBuffer,p.tileBorderIndexBuffer,p.debugSegments)}function Ic(p,t,s,o){const{isRenderingGlobe:u}=o,f=p.context,_=f.gl,b=p.transform,T=p.colorModeForRenderPass(),M=p.getDepthModeFor3D(),A=p.useProgram("terrain");f.bindFramebuffer.set(null),f.viewport.set([0,0,p.width,p.height]);for(const R of s){const z=t.getTerrainMesh(R.tileID),O=p.renderToTexture.getTexture(R),V=t.getTerrainData(R.tileID);f.activeTexture.set(_.TEXTURE0),_.bindTexture(_.TEXTURE_2D,O.texture);const W=t.getMeshFrameDelta(b.zoom),Y=b.calculateFogMatrix(R.tileID.toUnwrapped()),X=Fd(W,Y,p.style.sky,b.pitch,u),te=b.getProjectionData({overscaledTileID:R.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});A.draw(f,_.TRIANGLES,M,rr.disabled,T,tr.backCCW,X,V,te,"terrain",z.vertexBuffer,z.indexBuffer,z.segments)}}function Ac(p,t){if(!t.mesh){const s=new l.aW;s.emplaceBack(-1,-1),s.emplaceBack(1,-1),s.emplaceBack(1,1),s.emplaceBack(-1,1);const o=new l.aY;o.emplaceBack(0,1,2),o.emplaceBack(0,2,3),t.mesh=new yr(p.createVertexBuffer(s,pn.members),p.createIndexBuffer(o),l.aX.simpleSegment(0,0,s.length,o.length))}return t.mesh}class gh{constructor(t,s){this.context=new tl(t),this.transform=s,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:l.ar(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=Wr.maxOverzooming+Wr.maxUnderzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Ji}resize(t,s,o){if(this.width=Math.floor(t*o),this.height=Math.floor(s*o),this.pixelRatio=o,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const u of this.style._order)this.style._layers[u].resize()}setup(){const t=this.context,s=new l.aW;s.emplaceBack(0,0),s.emplaceBack(l.a5,0),s.emplaceBack(0,l.a5),s.emplaceBack(l.a5,l.a5),this.tileExtentBuffer=t.createVertexBuffer(s,pn.members),this.tileExtentSegments=l.aX.simpleSegment(0,0,4,2);const o=new l.aW;o.emplaceBack(0,0),o.emplaceBack(l.a5,0),o.emplaceBack(0,l.a5),o.emplaceBack(l.a5,l.a5),this.debugBuffer=t.createVertexBuffer(o,pn.members),this.debugSegments=l.aX.simpleSegment(0,0,4,5);const u=new l.ch;u.emplaceBack(0,0,0,0),u.emplaceBack(l.a5,0,l.a5,0),u.emplaceBack(0,l.a5,0,l.a5),u.emplaceBack(l.a5,l.a5,l.a5,l.a5),this.rasterBoundsBuffer=t.createVertexBuffer(u,Rd.members),this.rasterBoundsSegments=l.aX.simpleSegment(0,0,4,2);const f=new l.aW;f.emplaceBack(0,0),f.emplaceBack(l.a5,0),f.emplaceBack(0,l.a5),f.emplaceBack(l.a5,l.a5),this.rasterBoundsBufferPosOnly=t.createVertexBuffer(f,pn.members),this.rasterBoundsSegmentsPosOnly=l.aX.simpleSegment(0,0,4,5);const _=new l.aW;_.emplaceBack(0,0),_.emplaceBack(1,0),_.emplaceBack(0,1),_.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(_,pn.members),this.viewportSegments=l.aX.simpleSegment(0,0,4,2);const b=new l.ci;b.emplaceBack(0),b.emplaceBack(1),b.emplaceBack(3),b.emplaceBack(2),b.emplaceBack(0),this.tileBorderIndexBuffer=t.createIndexBuffer(b);const T=new l.aY;T.emplaceBack(1,0,2),T.emplaceBack(1,2,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(T);const M=this.context.gl;this.stencilClearMode=new rr({func:M.ALWAYS,mask:0},0,255,M.ZERO,M.ZERO,M.ZERO),this.tileExtentMesh=new yr(this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}clearStencil(){const t=this.context,s=t.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const o=l.N();l.c7(o,0,this.width,this.height,0,0,1),l.Q(o,o,[s.drawingBufferWidth,s.drawingBufferHeight,0]);const u={mainMatrix:o,tileMercatorCoords:[0,0,1,1],clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:o};this.useProgram("clippingMask",null,!0).draw(t,s.TRIANGLES,jt.disabled,this.stencilClearMode,xr.disabled,tr.disabled,null,null,u,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(t,s,o){if(this.currentStencilSource===t.source||!t.isTileClipped()||!s||!s.length)return;this.currentStencilSource=t.source,this.nextStencilID+s.length>256&&this.clearStencil();const u=this.context;u.setColorMode(xr.disabled),u.setDepthMode(jt.disabled);const f={};for(const _ of s)f[_.key]=this.nextStencilID++;this._renderTileMasks(f,s,o,!0),this._renderTileMasks(f,s,o,!1),this._tileClippingMaskIDs=f}_renderTileMasks(t,s,o,u){const f=this.context,_=f.gl,b=this.style.projection,T=this.transform,M=this.useProgram("clippingMask");for(const A of s){const R=t[A.key],z=this.style.map.terrain&&this.style.map.terrain.getTerrainData(A),O=b.getMeshFromTileID(this.context,A.canonical,u,!0,"stencil"),V=T.getProjectionData({overscaledTileID:A,applyGlobeMatrix:!o,applyTerrainMatrix:!0});M.draw(f,_.TRIANGLES,jt.disabled,new rr({func:_.ALWAYS,mask:0},R,255,_.KEEP,_.KEEP,_.REPLACE),xr.disabled,o?tr.disabled:tr.backCCW,null,z,V,"$clipping",O.vertexBuffer,O.indexBuffer,O.segments)}}_renderTilesDepthBuffer(){const t=this.context,s=t.gl,o=this.style.projection,u=this.transform,f=this.useProgram("depth"),_=this.getDepthModeFor3D(),b=mr(u,{tileSize:u.tileSize});for(const T of b){const M=this.style.map.terrain&&this.style.map.terrain.getTerrainData(T),A=o.getMeshFromTileID(this.context,T.canonical,!0,!0,"raster"),R=u.getProjectionData({overscaledTileID:T,applyGlobeMatrix:!0,applyTerrainMatrix:!0});f.draw(t,s.TRIANGLES,_,rr.disabled,xr.disabled,tr.backCCW,null,M,R,"$clipping",A.vertexBuffer,A.indexBuffer,A.segments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,s=this.context.gl;return new rr({func:s.NOTEQUAL,mask:255},t,255,s.KEEP,s.KEEP,s.REPLACE)}stencilModeForClipping(t){const s=this.context.gl;return new rr({func:s.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,s.KEEP,s.KEEP,s.REPLACE)}getStencilConfigForOverlapAndUpdateStencilID(t){const s=this.context.gl,o=t.sort(((_,b)=>b.overscaledZ-_.overscaledZ)),u=o[o.length-1].overscaledZ,f=o[0].overscaledZ-u+1;if(f>1){this.currentStencilSource=void 0,this.nextStencilID+f>256&&this.clearStencil();const _={};for(let b=0;b<f;b++)_[b+u]=new rr({func:s.GEQUAL,mask:255},b+this.nextStencilID,255,s.KEEP,s.KEEP,s.REPLACE);return this.nextStencilID+=f,[_,o]}return[{[u]:rr.disabled},o]}stencilConfigForOverlapTwoPass(t){const s=this.context.gl,o=t.sort(((_,b)=>b.overscaledZ-_.overscaledZ)),u=o[o.length-1].overscaledZ,f=o[0].overscaledZ-u+1;if(this.clearStencil(),f>1){const _={},b={};for(let T=0;T<f;T++)_[T+u]=new rr({func:s.GREATER,mask:255},f+1+T,255,s.KEEP,s.KEEP,s.REPLACE),b[T+u]=new rr({func:s.GREATER,mask:255},1+T,255,s.KEEP,s.KEEP,s.REPLACE);return this.nextStencilID=2*f+1,[_,b,o]}return this.nextStencilID=3,[{[u]:new rr({func:s.GREATER,mask:255},2,255,s.KEEP,s.KEEP,s.REPLACE)},{[u]:new rr({func:s.GREATER,mask:255},1,255,s.KEEP,s.KEEP,s.REPLACE)},o]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new xr([t.CONSTANT_COLOR,t.ONE],new l.bp(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?xr.unblended:xr.alphaBlended}getDepthModeForSublayer(t,s,o){if(!this.opaquePassEnabledForLayer())return jt.disabled;const u=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new jt(o||this.context.gl.LEQUAL,s,[u,u])}getDepthModeFor3D(){return new jt(this.context.gl.LEQUAL,jt.ReadWrite,this.depthRangeFor3D)}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(t,s){var o,u;this.style=t,this.options=s,this.lineAtlas=t.lineAtlas,this.imageManager=t.imageManager,this.glyphManager=t.glyphManager,this.symbolFadeChange=t.placement.symbolFadeChange(ot()),this.imageManager.beginFrame();const f=this.style._order,_=this.style.tileManagers,b={},T={},M={},A={isRenderingToTexture:!1,isRenderingGlobe:((o=t.projection)===null||o===void 0?void 0:o.transitionState)>0};for(const z in _){const O=_[z];O.used&&O.prepare(this.context),b[z]=O.getVisibleCoordinates(!1),T[z]=b[z].slice().reverse(),M[z]=O.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let z=0;z<f.length;z++)if(this.style._layers[f[z]].is3D()){this.opaquePassCutoff=z;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const z of f){const O=this.style._layers[z];if(!O.hasOffscreenPass()||O.isHidden(this.transform.zoom))continue;const V=T[O.source];(O.type==="custom"||V.length)&&this.renderLayer(this,_[O.source],O,V,A)}if((u=this.style.projection)===null||u===void 0||u.updateGPUdependent({context:this.context,useProgram:z=>this.useProgram(z)}),this.context.viewport.set([0,0,this.width,this.height]),this.context.bindFramebuffer.set(null),this.context.clear({color:s.showOverdrawInspector?l.bp.black:l.bp.transparent,depth:1}),this.clearStencil(),this.style.sky&&(function(z,O){const V=z.context,W=V.gl,Y=((ue,ie,pe)=>{const Ce=Math.cos(ie.rollInRadians),Pe=Math.sin(ie.rollInRadians),Me=nr(ie),Ie=ie.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}).projectionTransition;return{u_sky_color:ue.properties.get("sky-color"),u_horizon_color:ue.properties.get("horizon-color"),u_horizon:[(ie.width/2-Me*Pe)*pe,(ie.height/2+Me*Ce)*pe],u_horizon_normal:[-Pe,Ce],u_sky_horizon_blend:ue.properties.get("sky-horizon-blend")*ie.height/2*pe,u_sky_blend:Ie}})(O,z.style.map.transform,z.pixelRatio),X=new jt(W.LEQUAL,jt.ReadWrite,[0,1]),te=rr.disabled,le=z.colorModeForRenderPass(),Q=z.useProgram("sky"),ne=Ac(V,O);Q.draw(V,W.TRIANGLES,X,te,le,tr.disabled,Y,null,void 0,"sky",ne.vertexBuffer,ne.indexBuffer,ne.segments)})(this,this.style.sky),this._showOverdrawInspector=s.showOverdrawInspector,this.depthRangeFor3D=[0,1-(t._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=f.length-1;this.currentLayer>=0;this.currentLayer--){const z=this.style._layers[f[this.currentLayer]],O=_[z.source],V=b[z.source];this._renderTileClippingMasks(z,V,!1),this.renderLayer(this,O,z,V,A)}this.renderPass="translucent";let R=!1;for(this.currentLayer=0;this.currentLayer<f.length;this.currentLayer++){const z=this.style._layers[f[this.currentLayer]],O=_[z.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(z,A))continue;this.opaquePassEnabledForLayer()||R||(R=!0,A.isRenderingGlobe&&!this.style.map.terrain&&this._renderTilesDepthBuffer());const V=(z.type==="symbol"?M:T)[z.source];this._renderTileClippingMasks(z,b[z.source],!!this.renderToTexture),this.renderLayer(this,O,z,V,A)}if(A.isRenderingGlobe&&(function(z,O,V){const W=z.context,Y=W.gl,X=z.useProgram("atmosphere"),te=new jt(Y.LEQUAL,jt.ReadOnly,[0,1]),le=z.transform,Q=(function(Ie,Xe){const Je=Ie.properties.get("position"),$e=[-Je.x,-Je.y,-Je.z],it=l.ar(new Float64Array(16));return Ie.properties.get("anchor")==="map"&&(l.bg(it,it,Xe.rollInRadians),l.bh(it,it,-Xe.pitchInRadians),l.bg(it,it,Xe.bearingInRadians),l.bh(it,it,Xe.center.lat*Math.PI/180),l.bJ(it,it,-Xe.center.lng*Math.PI/180)),l.cg($e,$e,it),$e})(V,z.transform),ne=le.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),ue=O.properties.get("atmosphere-blend")*ne.projectionTransition;if(ue===0)return;const ie=Rn(le.worldSize,le.center.lat),pe=le.inverseProjectionMatrix,Ce=new Float64Array(4);Ce[3]=1,l.aH(Ce,Ce,le.modelViewProjectionMatrix),Ce[0]/=Ce[3],Ce[1]/=Ce[3],Ce[2]/=Ce[3],Ce[3]=1,l.aH(Ce,Ce,pe),Ce[0]/=Ce[3],Ce[1]/=Ce[3],Ce[2]/=Ce[3],Ce[3]=1;const Pe=((Ie,Xe,Je,$e,it)=>({u_sun_pos:Ie,u_atmosphere_blend:Xe,u_globe_position:Je,u_globe_radius:$e,u_inv_proj_matrix:it}))(Q,ue,[Ce[0],Ce[1],Ce[2]],ie,pe),Me=Ac(W,O);X.draw(W,Y.TRIANGLES,te,rr.disabled,xr.alphaBlended,tr.disabled,Pe,null,null,"atmosphere",Me.vertexBuffer,Me.indexBuffer,Me.segments)})(this,this.style.sky,this.style.light),this.options.showTileBoundaries){const z=(function(O,V){let W=null;const Y=Object.values(O._layers).flatMap((Q=>Q.source&&!Q.isHidden(V)?[O.tileManagers[Q.source]]:[])),X=Y.filter((Q=>Q.getSource().type==="vector")),te=Y.filter((Q=>Q.getSource().type!=="vector")),le=Q=>{(!W||W.getSource().maxzoom<Q.getSource().maxzoom)&&(W=Q)};return X.forEach((Q=>le(Q))),W||te.forEach((Q=>le(Q))),W})(this.style,this.transform.zoom);z&&(function(O,V,W){for(let Y=0;Y<W.length;Y++)mh(O,V,W[Y])})(this,z,z.getVisibleCoordinates())}this.options.showPadding&&(function(z){const O=z.transform.padding;Ec(z,z.transform.height-(O.top||0),3,hh),Ec(z,O.bottom||0,3,dh),Mc(z,O.left||0,3,ph),Mc(z,z.transform.width-(O.right||0),3,fh);const V=z.transform.centerPoint;(function(W,Y,X,te){na(W,Y-1,X-10,2,20,te),na(W,Y-10,X-1,20,2,te)})(z,V.x,z.transform.height-V.y,yn)})(this),this.context.setDefault()}maybeDrawDepthAndCoords(t){if(!this.style||!this.style.map||!this.style.map.terrain)return;const s=this.terrainFacilitator.matrix,o=this.transform.modelViewProjectionMatrix;let u=this.terrainFacilitator.dirty;u||(u=t?!l.cj(s,o):!l.ck(s,o)),u||(u=this.style.map.terrain.tileManager.anyTilesAfterTime(this.terrainFacilitator.renderTime)),u&&(l.cl(s,o),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,(function(f,_){const b=f.context,T=b.gl,M=f.transform,A=xr.unblended,R=new jt(T.LEQUAL,jt.ReadWrite,[0,1]),z=_.tileManager.getRenderableTiles(),O=f.useProgram("terrainDepth");b.bindFramebuffer.set(_.getFramebuffer("depth").framebuffer),b.viewport.set([0,0,f.width/devicePixelRatio,f.height/devicePixelRatio]),b.clear({color:l.bp.transparent,depth:1});for(const V of z){const W=_.getTerrainMesh(V.tileID),Y=_.getTerrainData(V.tileID),X=M.getProjectionData({overscaledTileID:V.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0}),te={u_ele_delta:_.getMeshFrameDelta(M.zoom)};O.draw(b,T.TRIANGLES,R,rr.disabled,A,tr.backCCW,te,Y,X,"terrain",W.vertexBuffer,W.indexBuffer,W.segments)}b.bindFramebuffer.set(null),b.viewport.set([0,0,f.width,f.height])})(this,this.style.map.terrain),(function(f,_){const b=f.context,T=b.gl,M=f.transform,A=xr.unblended,R=new jt(T.LEQUAL,jt.ReadWrite,[0,1]),z=_.getCoordsTexture(),O=_.tileManager.getRenderableTiles(),V=f.useProgram("terrainCoords");b.bindFramebuffer.set(_.getFramebuffer("coords").framebuffer),b.viewport.set([0,0,f.width/devicePixelRatio,f.height/devicePixelRatio]),b.clear({color:l.bp.transparent,depth:1}),_.coordsIndex=[];for(const W of O){const Y=_.getTerrainMesh(W.tileID),X=_.getTerrainData(W.tileID);b.activeTexture.set(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,z.texture);const te={u_terrain_coords_id:(255-_.coordsIndex.length)/255,u_texture:0,u_ele_delta:_.getMeshFrameDelta(M.zoom)},le=M.getProjectionData({overscaledTileID:W.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});V.draw(b,T.TRIANGLES,R,rr.disabled,A,tr.backCCW,te,X,le,"terrain",Y.vertexBuffer,Y.indexBuffer,Y.segments),_.coordsIndex.push(W.tileID.key)}b.bindFramebuffer.set(null),b.viewport.set([0,0,f.width,f.height])})(this,this.style.map.terrain))}renderLayer(t,s,o,u,f){o.isHidden(this.transform.zoom)||(o.type==="background"||o.type==="custom"||(u||[]).length)&&(this.id=o.id,l.cm(o)?(function(_,b,T,M,A,R){if(_.renderPass!=="translucent")return;const{isRenderingToTexture:z}=R,O=rr.disabled,V=_.colorModeForRenderPass();(T._unevaluatedLayout.hasValue("text-variable-anchor")||T._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&(function(W,Y,X,te,le,Q,ne,ue,ie){const pe=Y.transform,Ce=Y.style.map.terrain,Pe=le==="map",Me=Q==="map";for(const Ie of W){const Xe=te.getTile(Ie),Je=Xe.getBucket(X);if(!Je||!Je.text||!Je.text.segments.get().length)continue;const $e=l.ay(Je.textSizeData,pe.zoom),it=l.aN(Xe,1,Y.transform.zoom),Ft=Pi(Pe,Y.transform,it),pr=X.layout.get("icon-text-fit")!=="none"&&Je.hasIconData();if($e){const Ir=Math.pow(2,pe.zoom-Xe.tileID.overscaledZ),vr=Ce?(Dr,br)=>Ce.getElevation(Ie,Dr,br):null;Hd(Je,Pe,Me,ie,pe,Ft,Ir,$e,pr,l.aO(pe,Xe,ne,ue),Ie.toUnwrapped(),vr)}}})(M,_,T,b,T.layout.get("text-rotation-alignment"),T.layout.get("text-pitch-alignment"),T.paint.get("text-translate"),T.paint.get("text-translate-anchor"),A),T.paint.get("icon-opacity").constantOr(1)!==0&&ta(_,b,T,M,!1,T.paint.get("icon-translate"),T.paint.get("icon-translate-anchor"),T.layout.get("icon-rotation-alignment"),T.layout.get("icon-pitch-alignment"),T.layout.get("icon-keep-upright"),O,V,z),T.paint.get("text-opacity").constantOr(1)!==0&&ta(_,b,T,M,!0,T.paint.get("text-translate"),T.paint.get("text-translate-anchor"),T.layout.get("text-rotation-alignment"),T.layout.get("text-pitch-alignment"),T.layout.get("text-keep-upright"),O,V,z),b.map.showCollisionBoxes&&(Nn(_,b,T,M,!0),Nn(_,b,T,M,!1))})(t,s,o,u,this.style.placement.variableOffsets,f):l.cn(o)?(function(_,b,T,M,A){if(_.renderPass!=="translucent")return;const{isRenderingToTexture:R}=A,z=T.paint.get("circle-opacity"),O=T.paint.get("circle-stroke-width"),V=T.paint.get("circle-stroke-opacity"),W=!T.layout.get("circle-sort-key").isConstant();if(z.constantOr(1)===0&&(O.constantOr(1)===0||V.constantOr(1)===0))return;const Y=_.context,X=Y.gl,te=_.transform,le=_.getDepthModeForSublayer(0,jt.ReadOnly),Q=rr.disabled,ne=_.colorModeForRenderPass(),ue=[],ie=te.getCircleRadiusCorrection();for(let pe=0;pe<M.length;pe++){const Ce=M[pe],Pe=b.getTile(Ce),Me=Pe.getBucket(T);if(!Me)continue;const Ie=T.paint.get("circle-translate"),Xe=T.paint.get("circle-translate-anchor"),Je=l.aO(te,Pe,Ie,Xe),$e=Me.programConfigurations.get(T.id),it=_.useProgram("circle",$e),Ft=Me.layoutVertexBuffer,pr=Me.indexBuffer,Ir=_.style.map.terrain&&_.style.map.terrain.getTerrainData(Ce),vr={programConfiguration:$e,program:it,layoutVertexBuffer:Ft,indexBuffer:pr,uniformValues:Gu(_,Pe,T,Je,ie),terrainData:Ir,projectionData:te.getProjectionData({overscaledTileID:Ce,applyGlobeMatrix:!R,applyTerrainMatrix:!0})};if(W){const Dr=Me.segments.get();for(const br of Dr)ue.push({segments:new l.aX([br]),sortKey:br.sortKey,state:vr})}else ue.push({segments:Me.segments,sortKey:0,state:vr})}W&&ue.sort(((pe,Ce)=>pe.sortKey-Ce.sortKey));for(const pe of ue){const{programConfiguration:Ce,program:Pe,layoutVertexBuffer:Me,indexBuffer:Ie,uniformValues:Xe,terrainData:Je,projectionData:$e}=pe.state;Pe.draw(Y,X.TRIANGLES,le,Q,ne,tr.backCCW,Xe,Je,$e,T.id,Me,Ie,pe.segments,T.paint,_.transform.zoom,Ce)}})(t,s,o,u,f):l.co(o)?(function(_,b,T,M,A){if(T.paint.get("heatmap-opacity")===0)return;const R=_.context,{isRenderingToTexture:z,isRenderingGlobe:O}=A;if(_.style.map.terrain){for(const V of M){const W=b.getTile(V);b.hasRenderableParent(V)||(_.renderPass==="offscreen"?oh(_,W,T,V,O):_.renderPass==="translucent"&&ah(_,T,V,z,O))}R.viewport.set([0,0,_.width,_.height])}else _.renderPass==="offscreen"?(function(V,W,Y,X){const te=V.context,le=te.gl,Q=V.transform,ne=rr.disabled,ue=new xr([le.ONE,le.ONE],l.bp.transparent,[!0,!0,!0,!0]);(function(ie,pe,Ce){const Pe=ie.gl;ie.activeTexture.set(Pe.TEXTURE1),ie.viewport.set([0,0,pe.width/4,pe.height/4]);let Me=Ce.heatmapFbos.get(l.cd);Me?(Pe.bindTexture(Pe.TEXTURE_2D,Me.colorAttachment.get()),ie.bindFramebuffer.set(Me.framebuffer)):(Me=ra(ie,pe.width/4,pe.height/4),Ce.heatmapFbos.set(l.cd,Me))})(te,V,Y),te.clear({color:l.bp.transparent});for(let ie=0;ie<X.length;ie++){const pe=X[ie];if(W.hasRenderableParent(pe))continue;const Ce=W.getTile(pe),Pe=Ce.getBucket(Y);if(!Pe)continue;const Me=Pe.programConfigurations.get(Y.id),Ie=V.useProgram("heatmap",Me),Xe=Q.getProjectionData({overscaledTileID:pe,applyGlobeMatrix:!0,applyTerrainMatrix:!1}),Je=Q.getCircleRadiusCorrection();Ie.draw(te,le.TRIANGLES,jt.disabled,ne,ue,tr.backCCW,_o(Ce,Q.zoom,Y.paint.get("heatmap-intensity"),Je),null,Xe,Y.id,Pe.layoutVertexBuffer,Pe.indexBuffer,Pe.segments,Y.paint,Q.zoom,Me)}te.viewport.set([0,0,V.width,V.height])})(_,b,T,M):_.renderPass==="translucent"&&(function(V,W){const Y=V.context,X=Y.gl;Y.setColorMode(V.colorModeForRenderPass());const te=W.heatmapFbos.get(l.cd);te&&(Y.activeTexture.set(X.TEXTURE0),X.bindTexture(X.TEXTURE_2D,te.colorAttachment.get()),Y.activeTexture.set(X.TEXTURE1),il(Y,W).bind(X.LINEAR,X.CLAMP_TO_EDGE),V.useProgram("heatmapTexture").draw(Y,X.TRIANGLES,jt.disabled,rr.disabled,V.colorModeForRenderPass(),tr.disabled,Hu(V,W,0,1),null,null,W.id,V.viewportBuffer,V.quadTriangleIndexBuffer,V.viewportSegments,W.paint,V.transform.zoom))})(_,T)})(t,s,o,u,f):l.cp(o)?(function(_,b,T,M,A){if(_.renderPass!=="translucent")return;const{isRenderingToTexture:R}=A,z=T.paint.get("line-opacity"),O=T.paint.get("line-width");if(z.constantOr(1)===0||O.constantOr(1)===0)return;const V=_.getDepthModeForSublayer(0,jt.ReadOnly),W=_.colorModeForRenderPass(),Y=T.paint.get("line-dasharray"),X=Y.constantOr(1),te=T.paint.get("line-pattern"),le=te.constantOr(1),Q=T.paint.get("line-gradient"),ne=T.getCrossfadeParameters();let ue;ue=le?"linePattern":X&&Q?"lineGradientSDF":X?"lineSDF":Q?"lineGradient":"line";const ie=_.context,pe=ie.gl,Ce=_.transform;let Pe=!0;for(const Me of M){const Ie=b.getTile(Me);if(le&&!Ie.patternsLoaded())continue;const Xe=Ie.getBucket(T);if(!Xe)continue;const Je=Xe.programConfigurations.get(T.id),$e=_.context.program.get(),it=_.useProgram(ue,Je),Ft=Pe||it.program!==$e,pr=_.style.map.terrain&&_.style.map.terrain.getTerrainData(Me),Ir=te.constantOr(null),vr=Y&&Y.constantOr(null);if(Ir&&Ie.imageAtlas){const gi=Ie.imageAtlas,si=gi.patternPositions[Ir.to.toString()],Kr=gi.patternPositions[Ir.from.toString()];si&&Kr&&Je.setConstantPatternPositions(si,Kr)}else if(vr){const gi=T.layout.get("line-cap")==="round",si=_.lineAtlas.getDash(vr.to,gi),Kr=_.lineAtlas.getDash(vr.from,gi);Je.setConstantDashPositions(si,Kr)}const Dr=Ce.getProjectionData({overscaledTileID:Me,applyGlobeMatrix:!R,applyTerrainMatrix:!0}),br=Ce.getPixelScale();let qr;le?(qr=fc(_,Ie,T,br,ne),ch(ie,pe,Ie,Je,ne)):X&&Q?(qr=Ua(_,Ie,T,br,ne,Xe.lineClipsArray.length),is(_,b,ie,pe,T,Xe,Me,Je,ne)):X?(qr=Yu(_,Ie,T,br,ne),Yr(_,ie,pe,Je,Ft,ne)):Q?(qr=Xu(_,Ie,T,br,Xe.lineClipsArray.length),Vn(_,b,ie,pe,T,Xe,Me)):qr=Xo(_,Ie,T,br);const zr=_.stencilModeForClipping(Me);it.draw(ie,pe.TRIANGLES,V,zr,W,tr.disabled,qr,pr,Dr,T.id,Xe.layoutVertexBuffer,Xe.indexBuffer,Xe.segments,T.paint,_.transform.zoom,Je,Xe.layoutVertexBuffer2),Pe=!1}})(t,s,o,u,f):l.cq(o)?(function(_,b,T,M,A){const R=T.paint.get("fill-color"),z=T.paint.get("fill-opacity");if(z.constantOr(1)===0)return;const{isRenderingToTexture:O}=A,V=_.colorModeForRenderPass(),W=T.paint.get("fill-pattern"),Y=_.opaquePassEnabledForLayer()&&!W.constantOr(1)&&R.constantOr(l.bp.transparent).a===1&&z.constantOr(0)===1?"opaque":"translucent";if(_.renderPass===Y){const X=_.getDepthModeForSublayer(1,_.renderPass==="opaque"?jt.ReadWrite:jt.ReadOnly);ia(_,b,T,M,X,V,!1,O)}if(_.renderPass==="translucent"&&T.paint.get("fill-antialias")){const X=_.getDepthModeForSublayer(T.getPaintProperty("fill-outline-color")?2:0,jt.ReadOnly);ia(_,b,T,M,X,V,!0,O)}})(t,s,o,u,f):l.cr(o)?(function(_,b,T,M,A){const R=T.paint.get("fill-extrusion-opacity");if(R===0)return;const{isRenderingToTexture:z}=A;if(_.renderPass==="translucent"){const O=new jt(_.context.gl.LEQUAL,jt.ReadWrite,_.depthRangeFor3D);if(R!==1||T.paint.get("fill-extrusion-pattern").constantOr(1))nl(_,b,T,M,O,rr.disabled,xr.disabled,z),nl(_,b,T,M,O,_.stencilModeFor3D(),_.colorModeForRenderPass(),z);else{const V=_.colorModeForRenderPass();nl(_,b,T,M,O,rr.disabled,V,z)}}})(t,s,o,u,f):l.cs(o)?(function(_,b,T,M,A){if(_.renderPass!=="offscreen"&&_.renderPass!=="translucent")return;const{isRenderingToTexture:R}=A,z=_.context,O=_.style.projection.useSubdivision,V=_.getDepthModeForSublayer(0,jt.ReadOnly),W=_.colorModeForRenderPass();if(_.renderPass==="offscreen")(function(Y,X,te,le,Q,ne,ue){const ie=Y.context,pe=ie.gl;for(const Ce of te){const Pe=X.getTile(Ce),Me=Pe.dem;if(!Me||!Me.data||!Pe.needsHillshadePrepare)continue;const Ie=Me.dim,Xe=Me.stride,Je=Me.getPixels();if(ie.activeTexture.set(pe.TEXTURE1),ie.pixelStoreUnpackPremultiplyAlpha.set(!1),Pe.demTexture=Pe.demTexture||Y.getTileTexture(Xe),Pe.demTexture){const it=Pe.demTexture;it.update(Je,{premultiply:!1}),it.bind(pe.NEAREST,pe.CLAMP_TO_EDGE)}else Pe.demTexture=new l.T(ie,Je,pe.RGBA,{premultiply:!1}),Pe.demTexture.bind(pe.NEAREST,pe.CLAMP_TO_EDGE);ie.activeTexture.set(pe.TEXTURE0);let $e=Pe.fbo;if(!$e){const it=new l.T(ie,{width:Ie,height:Ie,data:null},pe.RGBA);it.bind(pe.LINEAR,pe.CLAMP_TO_EDGE),$e=Pe.fbo=ie.createFramebuffer(Ie,Ie,!0,!1),$e.colorAttachment.set(it.texture)}ie.bindFramebuffer.set($e.framebuffer),ie.viewport.set([0,0,Ie,Ie]),Y.useProgram("hillshadePrepare").draw(ie,pe.TRIANGLES,Q,ne,ue,tr.disabled,Ld(Pe.tileID,Me),null,null,le.id,Y.rasterBoundsBuffer,Y.quadTriangleIndexBuffer,Y.rasterBoundsSegments),Pe.needsHillshadePrepare=!1}})(_,b,M,T,V,rr.disabled,W),z.viewport.set([0,0,_.width,_.height]);else if(_.renderPass==="translucent")if(O){const[Y,X,te]=_.stencilConfigForOverlapTwoPass(M);_n(_,b,T,te,Y,V,W,!1,R),_n(_,b,T,te,X,V,W,!0,R)}else{const[Y,X]=_.getStencilConfigForOverlapAndUpdateStencilID(M);_n(_,b,T,X,Y,V,W,!1,R)}})(t,s,o,u,f):l.ct(o)?(function(_,b,T,M,A){if(_.renderPass!=="translucent"||!M.length)return;const{isRenderingToTexture:R}=A,z=_.style.projection.useSubdivision,O=_.getDepthModeForSublayer(0,jt.ReadOnly),V=_.colorModeForRenderPass();if(z){const[W,Y,X]=_.stencilConfigForOverlapTwoPass(M);sa(_,b,T,X,W,O,V,!1,R),sa(_,b,T,X,Y,O,V,!0,R)}else{const[W,Y]=_.getStencilConfigForOverlapAndUpdateStencilID(M);sa(_,b,T,Y,W,O,V,!1,R)}})(t,s,o,u,f):l.bU(o)?(function(_,b,T,M,A){if(_.renderPass!=="translucent"||T.paint.get("raster-opacity")===0||!M.length)return;const{isRenderingToTexture:R}=A,z=b.getSource(),O=_.style.projection.useSubdivision;if(z instanceof Ai)wo(_,b,T,M,null,!1,!1,z.tileCoords,z.flippedWindingOrder,R);else if(O){const[V,W,Y]=_.stencilConfigForOverlapTwoPass(M);wo(_,b,T,Y,V,!1,!0,$n,!1,R),wo(_,b,T,Y,W,!0,!0,$n,!1,R)}else{const[V,W]=_.getStencilConfigForOverlapAndUpdateStencilID(M);wo(_,b,T,W,V,!1,!0,$n,!1,R)}})(t,s,o,u,f):l.cu(o)?(function(_,b,T,M,A){const R=T.paint.get("background-color"),z=T.paint.get("background-opacity");if(z===0)return;const{isRenderingToTexture:O}=A,V=_.context,W=V.gl,Y=_.style.projection,X=_.transform,te=X.tileSize,le=T.paint.get("background-pattern");if(_.isPatternMissing(le))return;const Q=!le&&R.a===1&&z===1&&_.opaquePassEnabledForLayer()?"opaque":"translucent";if(_.renderPass!==Q)return;const ne=rr.disabled,ue=_.getDepthModeForSublayer(0,Q==="opaque"?jt.ReadWrite:jt.ReadOnly),ie=_.colorModeForRenderPass(),pe=_.useProgram(le?"backgroundPattern":"background"),Ce=M||mr(X,{tileSize:te,terrain:_.style.map.terrain});le&&(V.activeTexture.set(W.TEXTURE0),_.imageManager.bind(_.context));const Pe=T.getCrossfadeParameters();for(const Me of Ce){const Ie=X.getProjectionData({overscaledTileID:Me,applyGlobeMatrix:!O,applyTerrainMatrix:!0}),Xe=le?Bd(z,_,le,{tileID:Me,tileSize:te},Pe):yc(z,R),Je=_.style.map.terrain&&_.style.map.terrain.getTerrainData(Me),$e=Y.getMeshFromTileID(V,Me.canonical,!1,!0,"raster");pe.draw(V,W.TRIANGLES,ue,ne,ie,tr.backCCW,Xe,Je,Ie,T.id,$e.vertexBuffer,$e.indexBuffer,$e.segments)}})(t,0,o,u,f):l.cv(o)&&(function(_,b,T,M){const{isRenderingGlobe:A}=M,R=_.context,z=T.implementation,O=_.style.projection,V=_.transform,W=V.getProjectionDataForCustomLayer(A),Y={farZ:V.farZ,nearZ:V.nearZ,fov:V.fov*Math.PI/180,modelViewProjectionMatrix:V.modelViewProjectionMatrix,projectionMatrix:V.projectionMatrix,shaderData:{variantName:O.shaderVariantName,vertexShaderPrelude:`const float PI = 3.141592653589793;
uniform mat4 u_projection_matrix;
${O.shaderPreludeCode.vertexSource}`,define:O.shaderDefine},defaultProjectionData:W},X=z.renderingMode?z.renderingMode:"2d";if(_.renderPass==="offscreen"){const te=z.prerender;te&&(_.setCustomLayerDefaults(),R.setColorMode(_.colorModeForRenderPass()),te.call(z,R.gl,Y),R.setDirty(),_.setBaseState())}else if(_.renderPass==="translucent"){_.setCustomLayerDefaults(),R.setColorMode(_.colorModeForRenderPass()),R.setStencilMode(rr.disabled);const te=X==="3d"?_.getDepthModeFor3D():_.getDepthModeForSublayer(0,jt.ReadOnly);R.setDepthMode(te),z.render(R.gl,Y),R.setDirty(),_.setBaseState(),R.bindFramebuffer.set(null)}})(t,0,o,f))}saveTileTexture(t){const s=this._tileTextures[t.size[0]];s?s.push(t):this._tileTextures[t.size[0]]=[t]}getTileTexture(t){const s=this._tileTextures[t];return s&&s.length>0?s.pop():null}isPatternMissing(t){if(!t)return!1;if(!t.from||!t.to)return!0;const s=this.imageManager.getPattern(t.from.toString()),o=this.imageManager.getPattern(t.to.toString());return!s||!o}useProgram(t,s,o=!1,u=[]){this.cache=this.cache||{};const f=!!this.style.map.terrain,_=this.style.projection,b=o?Or.projectionMercator:_.shaderPreludeCode,T=o?Vi:_.shaderDefine,M=t+(s?s.cacheKey:"")+`/${o?rs:_.shaderVariantName}`+(this._showOverdrawInspector?"/overdraw":"")+(f?"/terrain":"")+(u?`/${u.join("/")}`:"");return this.cache[M]||(this.cache[M]=new Vu(this.context,Or[t],s,jd[t],this._showOverdrawInspector,f,b,T,u)),this.cache[M]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new l.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){var t,s;if(this._tileTextures){for(const o in this._tileTextures){const u=this._tileTextures[o];if(u)for(const f of u)f.destroy()}this._tileTextures={}}if(this.tileExtentBuffer&&this.tileExtentBuffer.destroy(),this.debugBuffer&&this.debugBuffer.destroy(),this.rasterBoundsBuffer&&this.rasterBoundsBuffer.destroy(),this.rasterBoundsBufferPosOnly&&this.rasterBoundsBufferPosOnly.destroy(),this.viewportBuffer&&this.viewportBuffer.destroy(),this.tileBorderIndexBuffer&&this.tileBorderIndexBuffer.destroy(),this.quadTriangleIndexBuffer&&this.quadTriangleIndexBuffer.destroy(),this.tileExtentMesh&&((t=this.tileExtentMesh.vertexBuffer)===null||t===void 0||t.destroy()),this.tileExtentMesh&&((s=this.tileExtentMesh.indexBuffer)===null||s===void 0||s.destroy()),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this.cache){for(const o in this.cache){const u=this.cache[o];u&&u.program&&this.context.gl.deleteProgram(u.program)}this.cache={}}this.context&&this.context.setDefault()}overLimit(){const{drawingBufferWidth:t,drawingBufferHeight:s}=this.context.gl;return this.width!==t||this.height!==s}}function Cc(p,t){let s,o=!1,u=null,f=null;const _=()=>{u=null,o&&(p.apply(f,s),u=setTimeout(_,t),o=!1)};return(...b)=>(o=!0,f=this,s=b,u||_(),u)}class kc{constructor(t){this._getCurrentHash=()=>{const s=window.location.hash.replace("#","");if(this._hashName){let o;return s.split("&").map((u=>u.split("="))).forEach((u=>{u[0]===this._hashName&&(o=u)})),(o&&o[1]||"").split("/")}return s.split("/")},this._onHashChange=()=>{const s=this._getCurrentHash();if(!this._isValidHash(s))return!1;const o=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(s[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+s[2],+s[1]],zoom:+s[0],bearing:o,pitch:+(s[4]||0)}),!0},this._updateHashUnthrottled=()=>{const s=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,s)},this._removeHash=()=>{const s=this._getCurrentHash();if(s.length===0)return;const o=s.join("/");let u=o;u.split("&").length>0&&(u=u.split("&")[0]),this._hashName&&(u=`${this._hashName}=${o}`);let f=window.location.hash.replace(u,"");f.startsWith("#&")?f=f.slice(0,1)+f.slice(2):f==="#"&&(f="");let _=window.location.href.replace(/(#.+)?$/,f);_=_.replace("&&","&"),window.history.replaceState(window.history.state,null,_)},this._updateHash=Cc(this._updateHashUnthrottled,300),this._hashName=t&&encodeURIComponent(t)}addTo(t){return this._map=t,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(t){const s=this._map.getCenter(),o=Math.round(100*this._map.getZoom())/100,u=Math.ceil((o*Math.LN2+Math.log(512/360/.5))/Math.LN10),f=Math.pow(10,u),_=Math.round(s.lng*f)/f,b=Math.round(s.lat*f)/f,T=this._map.getBearing(),M=this._map.getPitch();let A="";if(A+=t?`/${_}/${b}/${o}`:`${o}/${b}/${_}`,(T||M)&&(A+="/"+Math.round(10*T)/10),M&&(A+=`/${Math.round(M)}`),this._hashName){const R=this._hashName;let z=!1;const O=window.location.hash.slice(1).split("&").map((V=>{const W=V.split("=")[0];return W===R?(z=!0,`${W}=${A}`):V})).filter((V=>V));return z||O.push(`${R}=${A}`),`#${O.join("&")}`}return`#${A}`}_isValidHash(t){if(t.length<3||t.some(isNaN))return!1;try{new l.V(+t[2],+t[1])}catch{return!1}const s=+t[0],o=+(t[3]||0),u=+(t[4]||0);return s>=this._map.getMinZoom()&&s<=this._map.getMaxZoom()&&o>=-180&&o<=180&&u>=this._map.getMinPitch()&&u<=this._map.getMaxPitch()}}const xn={linearity:.3,easing:l.cw(0,0,.3,1)},_h=l.e({deceleration:2500,maxSpeed:1400},xn),ps=l.e({deceleration:20,maxSpeed:1400},xn),ws=l.e({deceleration:1e3,maxSpeed:360},xn),yh=l.e({deceleration:1e3,maxSpeed:90},xn),Ts=l.e({deceleration:1e3,maxSpeed:360},xn);class Wd{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:ot(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,s=ot();for(;t.length>0&&s-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const s={zoom:0,bearing:0,pitch:0,roll:0,pan:new l.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:f}of this._inertiaBuffer)s.zoom+=f.zoomDelta||0,s.bearing+=f.bearingDelta||0,s.pitch+=f.pitchDelta||0,s.roll+=f.rollDelta||0,f.panDelta&&s.pan._add(f.panDelta),f.around&&(s.around=f.around),f.pinchAround&&(s.pinchAround=f.pinchAround);const o=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,u={};if(s.pan.mag()){const f=aa(s.pan.mag(),o,l.e({},_h,t||{})),_=s.pan.mult(f.amount/s.pan.mag()),b=this._map.cameraHelper.handlePanInertia(_,this._map.transform);u.center=b.easingCenter,u.offset=b.easingOffset,oa(u,f)}if(s.zoom){const f=aa(s.zoom,o,ps);u.zoom=this._map.transform.zoom+f.amount,oa(u,f)}if(s.bearing){const f=aa(s.bearing,o,ws);u.bearing=this._map.transform.bearing+l.an(f.amount,-179,179),oa(u,f)}if(s.pitch){const f=aa(s.pitch,o,yh);u.pitch=this._map.transform.pitch+f.amount,oa(u,f)}if(s.roll){const f=aa(s.roll,o,Ts);u.roll=this._map.transform.roll+l.an(f.amount,-179,179),oa(u,f)}if(u.zoom||u.bearing){const f=s.pinchAround===void 0?s.around:s.pinchAround;u.around=f?this._map.unproject(f):this._map.getCenter()}return this.clear(),l.e(u,{noMoveStart:!0})}}function oa(p,t){(!p.duration||p.duration<t.duration)&&(p.duration=t.duration,p.easing=t.easing)}function aa(p,t,s){const{maxSpeed:o,linearity:u,deceleration:f}=s,_=l.an(p*u/(t/1e3),-o,o),b=Math.abs(_)/(f*u);return{easing:s.easing,duration:1e3*b,amount:_*(b/2)}}class mi extends l.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,s,o,u={}){o=o instanceof MouseEvent?o:new MouseEvent(t,o);const f=ge.mousePos(s.getCanvas(),o),_=s.unproject(f);super(t,l.e({point:f,lngLat:_,originalEvent:o},u)),this._defaultPrevented=!1,this.target=s}}class la extends l.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,s,o){const u=t==="touchend"?o.changedTouches:o.touches,f=ge.touchPos(s.getCanvasContainer(),u),_=f.map((T=>s.unproject(T))),b=f.reduce(((T,M,A,R)=>T.add(M.div(R.length))),new l.P(0,0));super(t,{points:f,point:b,lngLats:_,lngLat:s.unproject(b),originalEvent:o}),this._defaultPrevented=!1}}class xh extends l.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,s,o){super(t,{originalEvent:o}),this._defaultPrevented=!1}}class Xd{constructor(t,s){this._map=t,this._clickTolerance=s.clickTolerance}reset(){delete this._mousedownPos}wheel(t){return this._firePreventable(new xh(t.type,this._map,t))}mousedown(t,s){return this._mousedownPos=s,this._firePreventable(new mi(t.type,this._map,t))}mouseup(t){this._map.fire(new mi(t.type,this._map,t))}click(t,s){this._mousedownPos&&this._mousedownPos.dist(s)>=this._clickTolerance||this._map.fire(new mi(t.type,this._map,t))}dblclick(t){return this._firePreventable(new mi(t.type,this._map,t))}mouseover(t){this._map.fire(new mi(t.type,this._map,t))}mouseout(t){this._map.fire(new mi(t.type,this._map,t))}touchstart(t){return this._firePreventable(new la(t.type,this._map,t))}touchmove(t){this._map.fire(new la(t.type,this._map,t))}touchend(t){this._map.fire(new la(t.type,this._map,t))}touchcancel(t){this._map.fire(new la(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Yd{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(t){this._map.fire(new mi(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new mi("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._ignoreContextMenu||this._map.fire(new mi(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class To{constructor(t){this._map=t}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(t){return this.transform.screenPointToLocation(l.P.convert(t),this._map.terrain)}}class So{constructor(t,s){this._map=t,this._tr=new To(t),this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=s.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,s){this.isEnabled()&&t.shiftKey&&t.button===0&&(ge.disableDrag(),this._startPos=this._lastPos=s,this._active=!0)}mousemoveWindow(t,s){if(!this._active)return;const o=s;if(this._lastPos.equals(o)||!this._box&&o.dist(this._startPos)<this._clickTolerance)return;const u=this._startPos;this._lastPos=o,this._box||(this._box=ge.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",t));const f=Math.min(u.x,o.x),_=Math.max(u.x,o.x),b=Math.min(u.y,o.y),T=Math.max(u.y,o.y);ge.setTransform(this._box,`translate(${f}px,${b}px)`),this._box.style.width=_-f+"px",this._box.style.height=T-b+"px"}mouseupWindow(t,s){if(!this._active||t.button!==0)return;const o=this._startPos,u=s;if(this.reset(),ge.suppressClick(),o.x!==u.x||o.y!==u.y)return this._map.fire(new l.l("boxzoomend",{originalEvent:t})),{cameraAnimation:f=>f.fitScreenCoordinates(o,u,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",t)}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(ge.remove(this._box),this._box=null),ge.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(t,s){return this._map.fire(new l.l(t,{originalEvent:s}))}}function Ss(p,t){if(p.length!==t.length)throw new Error(`The number of touches and points are not equal - touches ${p.length}, points ${t.length}`);const s={};for(let o=0;o<p.length;o++)s[p[o].identifier]=t[o];return s}class ht{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(t,s,o){(this.centroid||o.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=t.timeStamp),o.length===this.numTouches&&(this.centroid=(function(u){const f=new l.P(0,0);for(const _ of u)f._add(_);return f.div(u.length)})(s),this.touches=Ss(o,s)))}touchmove(t,s,o){if(this.aborted||!this.centroid)return;const u=Ss(o,s);for(const f in this.touches){const _=u[f];(!_||_.dist(this.touches[f])>30)&&(this.aborted=!0)}}touchend(t,s,o){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),o.length===0){const u=!this.aborted&&this.centroid;if(this.reset(),u)return u}}}class ol{constructor(t){this.singleTap=new ht(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(t,s,o){this.singleTap.touchstart(t,s,o)}touchmove(t,s,o){this.singleTap.touchmove(t,s,o)}touchend(t,s,o){const u=this.singleTap.touchend(t,s,o);if(u){const f=t.timeStamp-this.lastTime<500,_=!this.lastTap||this.lastTap.dist(u)<30;if(f&&_||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=u,this.count===this.numTaps)return this.reset(),u}}}class Dc{constructor(t){this._tr=new To(t),this._zoomIn=new ol({numTouches:1,numTaps:2}),this._zoomOut=new ol({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,s,o){this._zoomIn.touchstart(t,s,o),this._zoomOut.touchstart(t,s,o)}touchmove(t,s,o){this._zoomIn.touchmove(t,s,o),this._zoomOut.touchmove(t,s,o)}touchend(t,s,o){const u=this._zoomIn.touchend(t,s,o),f=this._zoomOut.touchend(t,s,o),_=this._tr;return u?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:_.zoom+1,around:_.unproject(u)},{originalEvent:t})}):f?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:_.zoom-1,around:_.unproject(f)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Po{constructor(t){this._enabled=!!t.enable,this._moveStateManager=t.moveStateManager,this._clickTolerance=t.clickTolerance||1,this._moveFunction=t.move,this._activateOnStart=!!t.activateOnStart,t.assignEvents(this),this.reset()}reset(t){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(t)}_move(...t){const s=this._moveFunction(...t);if(s.bearingDelta||s.pitchDelta||s.rollDelta||s.around||s.panDelta)return this._active=!0,s}dragStart(t,s){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(t)&&(this._moveStateManager.startMove(t),this._lastPoint=Array.isArray(s)?s[0]:s,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(t,s){if(!this.isEnabled())return;const o=this._lastPoint;if(!o)return;if(t.preventDefault(),!this._moveStateManager.isValidMoveEvent(t))return void this.reset(t);const u=Array.isArray(s)?s[0]:s;return!this._moved&&u.dist(o)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=u,this._move(o,u))}dragEnd(t){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(t)&&(this._moved&&ge.suppressClick(),this.reset(t))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const ca=0,ua=2,zc={[ca]:1,[ua]:2};class ha{constructor(t){this._correctEvent=t.checkCorrectEvent}startMove(t){const s=ge.mouseButton(t);this._eventButton=s}endMove(t){delete this._eventButton}isValidStartEvent(t){return this._correctEvent(t)}isValidMoveEvent(t){return!(function(s,o){const u=zc[o];return s.buttons===void 0||(s.buttons&u)!==u})(t,this._eventButton)}isValidEndEvent(t){return ge.mouseButton(t)===this._eventButton}}class Rc{constructor(){this._firstTouch=void 0}_isOneFingerTouch(t){return t.targetTouches.length===1}_isSameTouchEvent(t){return t.targetTouches[0].identifier===this._firstTouch}startMove(t){this._firstTouch=t.targetTouches[0].identifier}endMove(t){delete this._firstTouch}isValidStartEvent(t){return this._isOneFingerTouch(t)}isValidMoveEvent(t){return this._isOneFingerTouch(t)&&this._isSameTouchEvent(t)}isValidEndEvent(t){return this._isOneFingerTouch(t)&&this._isSameTouchEvent(t)}}class vh{constructor(t=new ha({checkCorrectEvent:()=>!0}),s=new Rc){this.mouseMoveStateManager=t,this.oneFingerTouchMoveStateManager=s}_executeRelevantHandler(t,s,o){return t instanceof MouseEvent?s(t):typeof TouchEvent<"u"&&t instanceof TouchEvent?o(t):void 0}startMove(t){this._executeRelevantHandler(t,(s=>this.mouseMoveStateManager.startMove(s)),(s=>this.oneFingerTouchMoveStateManager.startMove(s)))}endMove(t){this._executeRelevantHandler(t,(s=>this.mouseMoveStateManager.endMove(s)),(s=>this.oneFingerTouchMoveStateManager.endMove(s)))}isValidStartEvent(t){return this._executeRelevantHandler(t,(s=>this.mouseMoveStateManager.isValidStartEvent(s)),(s=>this.oneFingerTouchMoveStateManager.isValidStartEvent(s)))}isValidMoveEvent(t){return this._executeRelevantHandler(t,(s=>this.mouseMoveStateManager.isValidMoveEvent(s)),(s=>this.oneFingerTouchMoveStateManager.isValidMoveEvent(s)))}isValidEndEvent(t){return this._executeRelevantHandler(t,(s=>this.mouseMoveStateManager.isValidEndEvent(s)),(s=>this.oneFingerTouchMoveStateManager.isValidEndEvent(s)))}}const Eo=p=>{p.mousedown=p.dragStart,p.mousemoveWindow=p.dragMove,p.mouseup=p.dragEnd,p.contextmenu=t=>{t.preventDefault()}};class Jd{constructor(t,s){this._clickTolerance=t.clickTolerance||1,this._map=s,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new l.P(0,0)}_shouldBePrevented(t){return t<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(t,s,o){return this._calculateTransform(t,s,o)}touchmove(t,s,o){if(this._active){if(!this._shouldBePrevented(o.length))return t.preventDefault(),this._calculateTransform(t,s,o);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",t)}}touchend(t,s,o){this._calculateTransform(t,s,o),this._active&&this._shouldBePrevented(o.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,s,o){o.length>0&&(this._active=!0);const u=Ss(o,s),f=new l.P(0,0),_=new l.P(0,0);let b=0;for(const M in u){const A=u[M],R=this._touches[M];R&&(f._add(A),_._add(A.sub(R)),b++,u[M]=A)}if(this._touches=u,this._shouldBePrevented(b)||!_.mag())return;const T=_.div(b);return this._sum._add(T),this._sum.mag()<this._clickTolerance?void 0:{around:f.div(b),panDelta:T}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class al{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(t,s,o){this._firstTwoTouches||o.length<2||(this._firstTwoTouches=[o[0].identifier,o[1].identifier],this._start([s[0],s[1]]))}touchmove(t,s,o){if(!this._firstTwoTouches)return;t.preventDefault();const[u,f]=this._firstTwoTouches,_=ll(o,s,u),b=ll(o,s,f);if(!_||!b)return;const T=this._aroundCenter?null:_.add(b).div(2);return this._move([_,b],T,t)}touchend(t,s,o){if(!this._firstTwoTouches)return;const[u,f]=this._firstTwoTouches,_=ll(o,s,u),b=ll(o,s,f);_&&b||(this._active&&ge.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function ll(p,t,s){for(let o=0;o<p.length;o++)if(p[o].identifier===s)return t[o]}function bh(p,t){return Math.log(p/t)/Math.LN2}class Fc extends al{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,s){const o=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(bh(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:bh(this._distance,o),pinchAround:s}}}function wh(p,t){return 180*p.angleWith(t)/Math.PI}class Lc extends al{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,s,o){const u=this._vector;if(this._vector=t[0].sub(t[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:wh(this._vector,u),pinchAround:s}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const s=25/(Math.PI*this._minDiameter)*360,o=wh(t,this._startVector);return Math.abs(o)<s}}function Oc(p){return Math.abs(p.y)>Math.abs(p.x)}class Th extends al{constructor(t){super(),this._currentTouchCount=0,this._map=t}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(t,s,o){super.touchstart(t,s,o),this._currentTouchCount=o.length}_start(t){this._lastPoints=t,Oc(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,s,o){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const u=t[0].sub(this._lastPoints[0]),f=t[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(u,f,o.timeStamp),this._valid?(this._lastPoints=t,this._active=!0,{pitchDelta:(u.y+f.y)/2*-.5}):void 0}gestureBeginsVertically(t,s,o){if(this._valid!==void 0)return this._valid;const u=t.mag()>=2,f=s.mag()>=2;if(!u&&!f)return;if(!u||!f)return this._firstMove===void 0&&(this._firstMove=o),o-this._firstMove<100&&void 0;const _=t.y>0==s.y>0;return Oc(t)&&Oc(s)&&_}}const vn={panStep:100,bearingStep:15,pitchStep:10};class gr{constructor(t){this._tr=new To(t);const s=vn;this._panStep=s.panStep,this._bearingStep=s.bearingStep,this._pitchStep=s.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let s=0,o=0,u=0,f=0,_=0;switch(t.keyCode){case 61:case 107:case 171:case 187:s=1;break;case 189:case 109:case 173:s=-1;break;case 37:t.shiftKey?o=-1:(t.preventDefault(),f=-1);break;case 39:t.shiftKey?o=1:(t.preventDefault(),f=1);break;case 38:t.shiftKey?u=1:(t.preventDefault(),_=-1);break;case 40:t.shiftKey?u=-1:(t.preventDefault(),_=1);break;default:return}return this._rotationDisabled&&(o=0,u=0),{cameraAnimation:b=>{const T=this._tr;b.easeTo({duration:300,easeId:"keyboardHandler",easing:Kd,zoom:s?Math.round(T.zoom)+s*(t.shiftKey?2:1):T.zoom,bearing:T.bearing+o*this._bearingStep,pitch:T.pitch+u*this._pitchStep,offset:[-f*this._panStep,-_*this._panStep],center:T.center},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Kd(p){return p*(2-p)}const da=4.000244140625,cl=1/450;class ul{constructor(t,s){this._onTimeout=o=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(o)},this._map=t,this._tr=new To(t),this._triggerRenderFrame=s,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=cl}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(t){return!!this._map.cooperativeGestures.isEnabled()&&!(t.ctrlKey||this._map.cooperativeGestures.isBypassed(t))}wheel(t){if(!this.isEnabled())return;if(this._shouldBePrevented(t))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",t);let s=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const o=ot(),u=o-(this._lastWheelEventTime||0);this._lastWheelEventTime=o,s!==0&&s%da==0?this._type="wheel":s!==0&&Math.abs(s)<4?this._type="trackpad":u>400?(this._type=null,this._lastValue=s,this._timeout=setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(u*s)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,s+=this._lastValue)),t.shiftKey&&s&&(s/=4),this._type&&(this._lastWheelEvent=t,this._delta-=s,this._active||this._start(t)),t.preventDefault()}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const s=ge.mousePos(this._map.getCanvas(),t),o=this._tr;this._aroundPoint=this._aroundCenter?o.transform.locationToScreenPoint(l.V.convert(o.center)):s,this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._tr.transform;if(typeof this._lastExpectedZoom=="number"){const b=t.zoom-this._lastExpectedZoom;typeof this._startZoom=="number"&&(this._startZoom+=b),typeof this._targetZoom=="number"&&(this._targetZoom+=b)}if(this._delta!==0){const b=this._type==="wheel"&&Math.abs(this._delta)>da?this._wheelZoomRate:this._defaultZoomRate;let T=2/(1+Math.exp(-Math.abs(this._delta*b)));this._delta<0&&T!==0&&(T=1/T);const M=typeof this._targetZoom!="number"?t.scale:l.aq(this._targetZoom);this._targetZoom=t.applyConstrain(t.getCameraLngLat(),l.at(M*T)).zoom,this._type==="wheel"&&(this._startZoom=t.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const s=typeof this._targetZoom!="number"?t.zoom:this._targetZoom,o=this._startZoom,u=this._easing;let f,_=!1;if(this._type==="wheel"&&o&&u){const b=ot()-this._lastWheelEventTime,T=Math.min((b+5)/200,1),M=u(T);f=l.G.number(o,s,M),T<1?this._frameId||(this._frameId=!0):_=!0}else f=s,_=!0;return this._active=!0,_&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._lastExpectedZoom,delete this._finishTimeout}),200)),this._lastExpectedZoom=f,{noInertia:!0,needsRenderFrame:!_,zoomDelta:f-t.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let s=l.cy;if(this._prevEase){const o=this._prevEase,u=(ot()-o.start)/o.duration,f=o.easing(u+.01)-o.easing(u),_=.27/Math.sqrt(f*f+1e-4)*.01,b=Math.sqrt(.0729-_*_);s=l.cw(_,b,.25,1)}return this._prevEase={start:ot(),duration:t,easing:s},s}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,delete this._lastExpectedZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class Bc{constructor(t,s){this._clickZoom=t,this._tapZoom=s}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Sh{constructor(t){this._tr=new To(t),this.reset()}reset(){this._active=!1}dblclick(t,s){return t.preventDefault(),{cameraAnimation:o=>{o.easeTo({duration:300,zoom:this._tr.zoom+(t.shiftKey?-1:1),around:this._tr.unproject(s)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ph{constructor(){this._tap=new ol({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(t,s,o){if(!this._swipePoint)if(this._tapTime){const u=s[0],f=t.timeStamp-this._tapTime<500,_=this._tapPoint.dist(u)<30;f&&_?o.length>0&&(this._swipePoint=u,this._swipeTouch=o[0].identifier):this.reset()}else this._tap.touchstart(t,s,o)}touchmove(t,s,o){if(this._tapTime){if(this._swipePoint){if(o[0].identifier!==this._swipeTouch)return;const u=s[0],f=u.y-this._swipePoint.y;return this._swipePoint=u,t.preventDefault(),this._active=!0,{zoomDelta:f/128}}}else this._tap.touchmove(t,s,o)}touchend(t,s,o){if(this._tapTime)this._swipePoint&&o.length===0&&this.reset();else{const u=this._tap.touchend(t,s,o);u&&(this._tapTime=t.timeStamp,this._tapPoint=u)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Eh{constructor(t,s,o){this._el=t,this._mousePan=s,this._touchPan=o}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Ps{constructor(t,s,o,u){this._pitchWithRotate=t.pitchWithRotate,this._rollEnabled=t.rollEnabled,this._mouseRotate=s,this._mousePitch=o,this._mouseRoll=u}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable(),this._rollEnabled&&this._mouseRoll.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable(),this._mouseRoll.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())&&(!this._rollEnabled||this._mouseRoll.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()||this._mouseRoll.isActive()}}class pa{constructor(t,s,o,u){this._el=t,this._touchZoom=s,this._touchRotate=o,this._tapDragZoom=u,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class bt{constructor(t,s){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=t,this._options=s,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const t=this._map.getCanvasContainer();t.classList.add("maplibregl-cooperative-gestures"),this._container=ge.create("div","maplibregl-cooperative-gesture-screen",t);let s=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(s=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const o=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),u=document.createElement("div");u.className="maplibregl-desktop-message",u.textContent=s,this._container.appendChild(u);const f=document.createElement("div");f.className="maplibregl-mobile-message",f.textContent=o,this._container.appendChild(f),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(ge.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(t){return t[this._bypassKey]}notifyGestureBlocked(t,s){this._enabled&&(this._map.fire(new l.l("cooperativegestureprevented",{gestureType:t,originalEvent:s})),this._container.classList.add("maplibregl-show"),setTimeout((()=>{this._container.classList.remove("maplibregl-show")}),100))}}const Et=p=>p.zoom||p.drag||p.roll||p.pitch||p.rotate;class fa extends l.l{}function hl(p){return p.panDelta&&p.panDelta.mag()||p.zoomDelta||p.bearingDelta||p.pitchDelta||p.rollDelta}class dl{constructor(t,s){this.handleWindowEvent=u=>{this.handleEvent(u,`${u.type}Window`)},this.handleEvent=(u,f)=>{if(u.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const _=u.type==="renderFrame"?void 0:u,b={needsRenderFrame:!1},T={},M={};for(const{handlerName:z,handler:O,allowed:V}of this._handlers){if(!O.isEnabled())continue;let W;if(this._blockedByActive(M,V,z))O.reset();else if(O[f||u.type]){if(l.cz(u,f||u.type)){const Y=ge.mousePos(this._map.getCanvas(),u);W=O[f||u.type](u,Y)}else if(l.cA(u,f||u.type)){const Y=this._getMapTouches(u.touches),X=ge.touchPos(this._map.getCanvas(),Y);W=O[f||u.type](u,X,Y)}else l.cB(f||u.type)||(W=O[f||u.type](u));this.mergeHandlerResult(b,T,W,z,_),W&&W.needsRenderFrame&&this._triggerRenderFrame()}(W||O.isActive())&&(M[z]=O)}const A={};for(const z in this._previousActiveHandlers)M[z]||(A[z]=_);this._previousActiveHandlers=M,(Object.keys(A).length||hl(b))&&(this._changes.push([b,T,A]),this._triggerRenderFrame()),(Object.keys(M).length||hl(b))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:R}=b;R&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],R(this._map))},this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Wd(t),this._bearingSnap=s.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(s);const o=this._el;this._listeners=[[o,"touchstart",{passive:!0}],[o,"touchmove",{passive:!1}],[o,"touchend",void 0],[o,"touchcancel",void 0],[o,"mousedown",void 0],[o,"mousemove",void 0],[o,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[o,"mouseover",void 0],[o,"mouseout",void 0],[o,"dblclick",void 0],[o,"click",void 0],[o,"keydown",{capture:!1}],[o,"keyup",void 0],[o,"wheel",{passive:!1}],[o,"contextmenu",void 0],[window,"blur",void 0]];for(const[u,f,_]of this._listeners)ge.addEventListener(u,f,u===document?this.handleWindowEvent:this.handleEvent,_)}destroy(){for(const[t,s,o]of this._listeners)ge.removeEventListener(t,s,t===document?this.handleWindowEvent:this.handleEvent,o)}_addDefaultHandlers(t){const s=this._map,o=s.getCanvasContainer();this._add("mapEvent",new Xd(s,t));const u=s.boxZoom=new So(s,t);this._add("boxZoom",u),t.interactive&&t.boxZoom&&u.enable();const f=s.cooperativeGestures=new bt(s,t.cooperativeGestures);this._add("cooperativeGestures",f),t.cooperativeGestures&&f.enable();const _=new Dc(s),b=new Sh(s);s.doubleClickZoom=new Bc(b,_),this._add("tapZoom",_),this._add("clickZoom",b),t.interactive&&t.doubleClickZoom&&s.doubleClickZoom.enable();const T=new Ph;this._add("tapDragZoom",T);const M=s.touchPitch=new Th(s);this._add("touchPitch",M),t.interactive&&t.touchPitch&&s.touchPitch.enable(t.touchPitch);const A=()=>s.project(s.getCenter()),R=(function({enable:Q,clickTolerance:ne,aroundCenter:ue=!0,minPixelCenterThreshold:ie=100,rotateDegreesPerPixelMoved:pe=.8},Ce){const Pe=new ha({checkCorrectEvent:Me=>ge.mouseButton(Me)===0&&Me.ctrlKey||ge.mouseButton(Me)===2&&!Me.ctrlKey});return new Po({clickTolerance:ne,move:(Me,Ie)=>{const Xe=Ce();if(ue&&Math.abs(Xe.y-Me.y)>ie)return{bearingDelta:l.cx(new l.P(Me.x,Ie.y),Ie,Xe)};let Je=(Ie.x-Me.x)*pe;return ue&&Ie.y<Xe.y&&(Je=-Je),{bearingDelta:Je}},moveStateManager:Pe,enable:Q,assignEvents:Eo})})(t,A),z=(function({enable:Q,clickTolerance:ne,pitchDegreesPerPixelMoved:ue=-.5}){const ie=new ha({checkCorrectEvent:pe=>ge.mouseButton(pe)===0&&pe.ctrlKey||ge.mouseButton(pe)===2});return new Po({clickTolerance:ne,move:(pe,Ce)=>({pitchDelta:(Ce.y-pe.y)*ue}),moveStateManager:ie,enable:Q,assignEvents:Eo})})(t),O=(function({enable:Q,clickTolerance:ne,rollDegreesPerPixelMoved:ue=.3},ie){const pe=new ha({checkCorrectEvent:Ce=>ge.mouseButton(Ce)===2&&Ce.ctrlKey});return new Po({clickTolerance:ne,move:(Ce,Pe)=>{const Me=ie();let Ie=(Pe.x-Ce.x)*ue;return Pe.y<Me.y&&(Ie=-Ie),{rollDelta:Ie}},moveStateManager:pe,enable:Q,assignEvents:Eo})})(t,A);s.dragRotate=new Ps(t,R,z,O),this._add("mouseRotate",R,["mousePitch"]),this._add("mousePitch",z,["mouseRotate","mouseRoll"]),this._add("mouseRoll",O,["mousePitch"]),t.interactive&&t.dragRotate&&s.dragRotate.enable();const V=(function({enable:Q,clickTolerance:ne}){const ue=new ha({checkCorrectEvent:ie=>ge.mouseButton(ie)===0&&!ie.ctrlKey});return new Po({clickTolerance:ne,move:(ie,pe)=>({around:pe,panDelta:pe.sub(ie)}),activateOnStart:!0,moveStateManager:ue,enable:Q,assignEvents:Eo})})(t),W=new Jd(t,s);s.dragPan=new Eh(o,V,W),this._add("mousePan",V),this._add("touchPan",W,["touchZoom","touchRotate"]),t.interactive&&t.dragPan&&s.dragPan.enable(t.dragPan);const Y=new Lc,X=new Fc;s.touchZoomRotate=new pa(o,X,Y,T),this._add("touchRotate",Y,["touchPan","touchZoom"]),this._add("touchZoom",X,["touchPan","touchRotate"]),t.interactive&&t.touchZoomRotate&&s.touchZoomRotate.enable(t.touchZoomRotate),this._add("blockableMapEvent",new Yd(s));const te=s.scrollZoom=new ul(s,(()=>this._triggerRenderFrame()));this._add("scrollZoom",te,["mousePan"]),t.interactive&&t.scrollZoom&&s.scrollZoom.enable(t.scrollZoom);const le=s.keyboard=new gr(s);this._add("keyboard",le),t.interactive&&t.keyboard&&s.keyboard.enable()}_add(t,s,o){this._handlers.push({handlerName:t,handler:s,allowed:o}),this._handlersById[t]=s}stop(t){if(!this._updatingCamera){for(const{handler:s}of this._handlers)s.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[]}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Et(this._eventsInProgress)||this.isZooming()}_blockedByActive(t,s,o){for(const u in t)if(u!==o&&(!s||s.indexOf(u)<0))return!0;return!1}_getMapTouches(t){const s=[];for(const o of t)this._el.contains(o.target)&&s.push(o);return s}mergeHandlerResult(t,s,o,u,f){if(!o)return;l.e(t,o);const _={handlerName:u,originalEvent:o.originalEvent||f};o.zoomDelta!==void 0&&(s.zoom=_),o.panDelta!==void 0&&(s.drag=_),o.rollDelta!==void 0&&(s.roll=_),o.pitchDelta!==void 0&&(s.pitch=_),o.bearingDelta!==void 0&&(s.rotate=_)}_applyChanges(){const t={},s={},o={};for(const[u,f,_]of this._changes)u.panDelta&&(t.panDelta=(t.panDelta||new l.P(0,0))._add(u.panDelta)),u.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+u.zoomDelta),u.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+u.bearingDelta),u.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+u.pitchDelta),u.rollDelta&&(t.rollDelta=(t.rollDelta||0)+u.rollDelta),u.around!==void 0&&(t.around=u.around),u.pinchAround!==void 0&&(t.pinchAround=u.pinchAround),u.noInertia&&(t.noInertia=u.noInertia),l.e(s,f),l.e(o,_);this._updateMapTransform(t,s,o),this._changes=[]}_updateMapTransform(t,s,o){const u=this._map,f=u._getTransformForUpdate(),_=u.terrain;if(!(hl(t)||_&&this._terrainMovement))return this._fireEvents(s,o,!0);u._stop(!0);let{panDelta:b,zoomDelta:T,bearingDelta:M,pitchDelta:A,rollDelta:R,around:z,pinchAround:O}=t;O!==void 0&&(z=O),z=z||u.transform.centerPoint,_&&!f.isPointOnMapSurface(z)&&(z=f.centerPoint);const V={panDelta:b,zoomDelta:T,rollDelta:R,pitchDelta:A,bearingDelta:M,around:z};this._map.cameraHelper.useGlobeControls&&!f.isPointOnMapSurface(z)&&(z=f.centerPoint);const W=z.distSqr(f.centerPoint)<.01?f.center:f.screenPointToLocation(b?z.sub(b):z);this._handleMapControls({terrain:_,tr:f,deltasForHelper:V,preZoomAroundLoc:W,combinedEventsInProgress:s,panDelta:b}),u._applyUpdatedTransform(f),this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(s,o,!0)}_handleMapControls({terrain:t,tr:s,deltasForHelper:o,preZoomAroundLoc:u,combinedEventsInProgress:f,panDelta:_}){const b=this._map.cameraHelper;if(b.handleMapControlsRollPitchBearingZoom(o,s),t)return b.useGlobeControls?(this._terrainMovement||!f.drag&&!f.zoom||(this._terrainMovement=!0,this._map._elevationFreeze=!0),void b.handleMapControlsPan(o,s,u)):this._terrainMovement||!f.drag&&!f.zoom?void(f.drag&&this._terrainMovement&&_?s.setCenter(s.screenPointToLocation(s.centerPoint.sub(_))):b.handleMapControlsPan(o,s,u)):(this._terrainMovement=!0,this._map._elevationFreeze=!0,void b.handleMapControlsPan(o,s,u));b.handleMapControlsPan(o,s,u)}_fireEvents(t,s,o){const u=Et(this._eventsInProgress),f=Et(t),_={};for(const R in t){const{originalEvent:z}=t[R];this._eventsInProgress[R]||(_[`${R}start`]=z),this._eventsInProgress[R]=t[R]}!u&&f&&this._fireEvent("movestart",f.originalEvent);for(const R in _)this._fireEvent(R,_[R]);f&&this._fireEvent("move",f.originalEvent);for(const R in t){const{originalEvent:z}=t[R];this._fireEvent(R,z)}const b={};let T;for(const R in this._eventsInProgress){const{handlerName:z,originalEvent:O}=this._eventsInProgress[R];this._handlersById[z].isActive()||(delete this._eventsInProgress[R],T=s[z]||O,b[`${R}end`]=T)}for(const R in b)this._fireEvent(R,b[R]);const M=Et(this._eventsInProgress),A=(u||f)&&!M;if(A&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const R=this._map._getTransformForUpdate();this._map.getCenterClampedToGround()&&R.recalculateZoomAndCenter(this._map.terrain),this._map._applyUpdatedTransform(R)}if(o&&A){this._updatingCamera=!0;const R=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),z=O=>O!==0&&-this._bearingSnap<O&&O<this._bearingSnap;!R||!R.essential&&ze.prefersReducedMotion?(this._map.fire(new l.l("moveend",{originalEvent:T})),z(this._map.getBearing())&&this._map.resetNorth()):(z(R.bearing||this._map.getBearing())&&(R.bearing=0),R.freezeElevation=!0,this._map.easeTo(R,{originalEvent:T})),this._updatingCamera=!1}}_fireEvent(t,s){this._map.fire(new l.l(t,s?{originalEvent:s}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((t=>{delete this._frameId,this.handleEvent(new fa("renderFrame",{timeStamp:t})),this._applyChanges()}))}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class qi extends l.E{constructor(t,s,o){super(),this._renderFrameCallback=()=>{const u=Math.min((ot()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(u)),u<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=o.bearingSnap,this.cameraHelper=s,this.on("moveend",(()=>{delete this._requestedCameraState}))}migrateProjection(t,s){t.apply(this.transform),this.transform=t,this.cameraHelper=s}getCenter(){return new l.V(this.transform.center.lng,this.transform.center.lat)}setCenter(t,s){return this.jumpTo({center:t},s)}getCenterElevation(){return this.transform.elevation}setCenterElevation(t,s){return this.jumpTo({elevation:t},s),this}getCenterClampedToGround(){return this._centerClampedToGround}setCenterClampedToGround(t){this._centerClampedToGround=t}panBy(t,s,o){return t=l.P.convert(t).mult(-1),this.panTo(this.transform.center,l.e({offset:t},s),o)}panTo(t,s,o){return this.easeTo(l.e({center:t},s),o)}getZoom(){return this.transform.zoom}setZoom(t,s){return this.jumpTo({zoom:t},s),this}zoomTo(t,s,o){return this.easeTo(l.e({zoom:t},s),o)}zoomIn(t,s){return this.zoomTo(this.getZoom()+1,t,s),this}zoomOut(t,s){return this.zoomTo(this.getZoom()-1,t,s),this}getVerticalFieldOfView(){return this.transform.fov}setVerticalFieldOfView(t,s){return t!=this.transform.fov&&(this.transform.setFov(t),this.fire(new l.l("movestart",s)).fire(new l.l("move",s)).fire(new l.l("moveend",s))),this}getBearing(){return this.transform.bearing}setBearing(t,s){return this.jumpTo({bearing:t},s),this}getPadding(){return this.transform.padding}setPadding(t,s){return this.jumpTo({padding:t},s),this}rotateTo(t,s,o){return this.easeTo(l.e({bearing:t},s),o)}resetNorth(t,s){return this.rotateTo(0,l.e({duration:1e3},t),s),this}resetNorthPitch(t,s){return this.easeTo(l.e({bearing:0,pitch:0,roll:0,duration:1e3},t),s),this}snapToNorth(t,s){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,s):this}getPitch(){return this.transform.pitch}setPitch(t,s){return this.jumpTo({pitch:t},s),this}getRoll(){return this.transform.roll}setRoll(t,s){return this.jumpTo({roll:t},s),this}cameraForBounds(t,s){t=Mr.convert(t).adjustAntiMeridian();const o=s&&s.bearing||0;return this._cameraForBoxAndBearing(t.getNorthWest(),t.getSouthEast(),o,s)}_cameraForBoxAndBearing(t,s,o,u){const f={top:0,bottom:0,right:0,left:0};if(typeof(u=l.e({padding:f,offset:[0,0],maxZoom:this.transform.maxZoom},u)).padding=="number"){const M=u.padding;u.padding={top:M,bottom:M,right:M,left:M}}const _=l.e(f,u.padding);u.padding=_;const b=this.transform,T=new Mr(t,s);return this.cameraHelper.cameraForBoxAndBearing(u,_,T,o,b)}fitBounds(t,s,o){return this._fitInternal(this.cameraForBounds(t,s),s,o)}fitScreenCoordinates(t,s,o,u,f){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.screenPointToLocation(l.P.convert(t)),this.transform.screenPointToLocation(l.P.convert(s)),o,u),u,f)}_fitInternal(t,s,o){return t?(delete(s=l.e(t,s)).padding,s.linear?this.easeTo(s,o):this.flyTo(s,o)):this}jumpTo(t,s){this.stop();const o=this._getTransformForUpdate();let u=!1,f=!1,_=!1;const b=o.zoom;this.cameraHelper.handleJumpToCenterZoom(o,t);const T=o.zoom!==b;return"elevation"in t&&o.elevation!==+t.elevation&&o.setElevation(+t.elevation),"bearing"in t&&o.bearing!==+t.bearing&&(u=!0,o.setBearing(+t.bearing)),"pitch"in t&&o.pitch!==+t.pitch&&(f=!0,o.setPitch(+t.pitch)),"roll"in t&&o.roll!==+t.roll&&(_=!0,o.setRoll(+t.roll)),t.padding==null||o.isPaddingEqual(t.padding)||o.setPadding(t.padding),this._applyUpdatedTransform(o),this.fire(new l.l("movestart",s)).fire(new l.l("move",s)),T&&this.fire(new l.l("zoomstart",s)).fire(new l.l("zoom",s)).fire(new l.l("zoomend",s)),u&&this.fire(new l.l("rotatestart",s)).fire(new l.l("rotate",s)).fire(new l.l("rotateend",s)),f&&this.fire(new l.l("pitchstart",s)).fire(new l.l("pitch",s)).fire(new l.l("pitchend",s)),_&&this.fire(new l.l("rollstart",s)).fire(new l.l("roll",s)).fire(new l.l("rollend",s)),this.fire(new l.l("moveend",s))}calculateCameraOptionsFromTo(t,s,o,u=0){const f=l.a9.fromLngLat(t,s),_=l.a9.fromLngLat(o,u),b=_.x-f.x,T=_.y-f.y,M=_.z-f.z,A=Math.hypot(b,T,M);if(A===0)throw new Error("Can't calculate camera options with same From and To");const R=Math.hypot(b,T),z=l.at(this.transform.cameraToCenterDistance/A/this.transform.tileSize),O=180*Math.atan2(b,-T)/Math.PI;let V=180*Math.acos(R/A)/Math.PI;return V=M<0?90-V:90+V,{center:_.toLngLat(),elevation:u,zoom:z,pitch:V,bearing:O}}calculateCameraOptionsFromCameraLngLatAltRotation(t,s,o,u,f){const _=this.transform.calculateCenterFromCameraLngLatAlt(t,s,o,u);return{center:_.center,elevation:_.elevation,zoom:_.zoom,bearing:o,pitch:u,roll:f}}easeTo(t,s){this._stop(!1,t.easeId),((t=l.e({offset:[0,0],duration:500,easing:l.cy},t)).animate===!1||!t.essential&&ze.prefersReducedMotion)&&(t.duration=0);const o=this._getTransformForUpdate(),u=this.getBearing(),f=o.pitch,_=o.roll,b="bearing"in t?this._normalizeBearing(t.bearing,u):u,T="pitch"in t?+t.pitch:f,M="roll"in t?this._normalizeBearing(t.roll,_):_,A="padding"in t?t.padding:o.padding,R=l.P.convert(t.offset);let z,O;t.around&&(z=l.V.convert(t.around),O=o.locationToScreenPoint(z));const V={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching,rolling:this._rolling},W=this.cameraHelper.handleEaseTo(o,{bearing:b,pitch:T,roll:M,padding:A,around:z,aroundPoint:O,offsetAsPoint:R,offset:t.offset,zoom:t.zoom,center:t.center});return this._rotating=this._rotating||u!==b,this._pitching=this._pitching||T!==f,this._rolling=this._rolling||M!==_,this._padding=!o.isPaddingEqual(A),this._zooming=this._zooming||W.isZooming,this._easeId=t.easeId,this._prepareEase(s,t.noMoveStart,V),this.terrain&&this._prepareElevation(W.elevationCenter),this._ease((Y=>{W.easeFunc(Y),this.terrain&&!t.freezeElevation&&this._updateElevation(Y),this._applyUpdatedTransform(o),this._fireMoveEvents(s)}),(Y=>{this.terrain&&t.freezeElevation&&this._finalizeElevation(),this._afterEase(s,Y)}),t),this}_prepareEase(t,s,o={}){this._moving=!0,s||o.moving||this.fire(new l.l("movestart",t)),this._zooming&&!o.zooming&&this.fire(new l.l("zoomstart",t)),this._rotating&&!o.rotating&&this.fire(new l.l("rotatestart",t)),this._pitching&&!o.pitching&&this.fire(new l.l("pitchstart",t)),this._rolling&&!o.rolling&&this.fire(new l.l("rollstart",t))}_prepareElevation(t){this._elevationCenter=t,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(t,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(t){this._elevationStart!==void 0&&this._elevationCenter!==void 0||this._prepareElevation(this.transform.center),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom));const s=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(t<1&&s!==this._elevationTarget){const o=this._elevationTarget-this._elevationStart;this._elevationStart+=t*(o-(s-(o*t+this._elevationStart))/(1-t)),this._elevationTarget=s}this.transform.setElevation(l.G.number(this._elevationStart,this._elevationTarget,t))}_finalizeElevation(){this._elevationFreeze=!1,this.getCenterClampedToGround()&&this.transform.recalculateZoomAndCenter(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(t){if(!this.terrain&&t.elevation>=0&&t.pitch<=90)return{};const s=t.getCameraLngLat(),o=t.getCameraAltitude(),u=this.terrain?this.terrain.getElevationForLngLatZoom(s,t.zoom):0;if(o<u){const f=this.calculateCameraOptionsFromTo(s,u,t.center,t.elevation);return{pitch:f.pitch,zoom:f.zoom}}return{}}_applyUpdatedTransform(t){const s=[];if(s.push((u=>this._elevateCameraIfInsideTerrain(u))),this.transformCameraUpdate&&s.push((u=>this.transformCameraUpdate(u))),!s.length)return;const o=t.clone();for(const u of s){const f=o.clone(),{center:_,zoom:b,roll:T,pitch:M,bearing:A,elevation:R}=u(f);_&&f.setCenter(_),R!==void 0&&f.setElevation(R),b!==void 0&&f.setZoom(b),T!==void 0&&f.setRoll(T),M!==void 0&&f.setPitch(M),A!==void 0&&f.setBearing(A),o.apply(f)}this.transform.apply(o)}_fireMoveEvents(t){this.fire(new l.l("move",t)),this._zooming&&this.fire(new l.l("zoom",t)),this._rotating&&this.fire(new l.l("rotate",t)),this._pitching&&this.fire(new l.l("pitch",t)),this._rolling&&this.fire(new l.l("roll",t))}_afterEase(t,s){if(this._easeId&&s&&this._easeId===s)return;delete this._easeId;const o=this._zooming,u=this._rotating,f=this._pitching,_=this._rolling;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._rolling=!1,this._padding=!1,o&&this.fire(new l.l("zoomend",t)),u&&this.fire(new l.l("rotateend",t)),f&&this.fire(new l.l("pitchend",t)),_&&this.fire(new l.l("rollend",t)),this.fire(new l.l("moveend",t))}flyTo(t,s){if(!t.essential&&ze.prefersReducedMotion){const Ie=l.U(t,["center","zoom","bearing","pitch","roll","elevation","padding"]);return this.jumpTo(Ie,s)}this.stop(),t=l.e({offset:[0,0],speed:1.2,curve:1.42,easing:l.cy},t);const o=this._getTransformForUpdate(),u=o.bearing,f=o.pitch,_=o.roll,b=o.padding,T="bearing"in t?this._normalizeBearing(t.bearing,u):u,M="pitch"in t?+t.pitch:f,A="roll"in t?this._normalizeBearing(t.roll,_):_,R="padding"in t?t.padding:o.padding,z=l.P.convert(t.offset);let O=o.centerPoint.add(z);const V=o.screenPointToLocation(O),W=this.cameraHelper.handleFlyTo(o,{bearing:T,pitch:M,roll:A,padding:R,locationAtOffset:V,offsetAsPoint:z,center:t.center,minZoom:t.minZoom,zoom:t.zoom});let Y=t.curve;const X=Math.max(o.width,o.height),te=X/W.scaleOfZoom,le=W.pixelPathLength;typeof W.scaleOfMinZoom=="number"&&(Y=Math.sqrt(X/W.scaleOfMinZoom/le*2));const Q=Y*Y;function ne(Ie){const Xe=(te*te-X*X+(Ie?-1:1)*Q*Q*le*le)/(2*(Ie?te:X)*Q*le);return Math.log(Math.sqrt(Xe*Xe+1)-Xe)}function ue(Ie){return(Math.exp(Ie)-Math.exp(-Ie))/2}function ie(Ie){return(Math.exp(Ie)+Math.exp(-Ie))/2}const pe=ne(!1);let Ce=function(Ie){return ie(pe)/ie(pe+Y*Ie)},Pe=function(Ie){return X*((ie(pe)*(ue(Xe=pe+Y*Ie)/ie(Xe))-ue(pe))/Q)/le;var Xe},Me=(ne(!0)-pe)/Y;if(Math.abs(le)<2e-6||!isFinite(Me)){if(Math.abs(X-te)<1e-6)return this.easeTo(t,s);const Ie=te<X?-1:1;Me=Math.abs(Math.log(te/X))/Y,Pe=()=>0,Ce=Xe=>Math.exp(Ie*Y*Xe)}return t.duration="duration"in t?+t.duration:1e3*Me/("screenSpeed"in t?+t.screenSpeed/Y:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0),this._zooming=!0,this._rotating=u!==T,this._pitching=M!==f,this._rolling=A!==_,this._padding=!o.isPaddingEqual(R),this._prepareEase(s,!1),this.terrain&&this._prepareElevation(W.targetCenter),this._ease((Ie=>{const Xe=Ie*Me,Je=1/Ce(Xe),$e=Pe(Xe);this._rotating&&o.setBearing(l.G.number(u,T,Ie)),this._pitching&&o.setPitch(l.G.number(f,M,Ie)),this._rolling&&o.setRoll(l.G.number(_,A,Ie)),this._padding&&(o.interpolatePadding(b,R,Ie),O=o.centerPoint.add(z)),W.easeFunc(Ie,Je,$e,O),this.terrain&&!t.freezeElevation&&this._updateElevation(Ie),this._applyUpdatedTransform(o),this._fireMoveEvents(s)}),(()=>{this.terrain&&t.freezeElevation&&this._finalizeElevation(),this._afterEase(s)}),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(t,s){var o;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const u=this._onEaseEnd;delete this._onEaseEnd,u.call(this,s)}return t||(o=this.handlers)===null||o===void 0||o.stop(!1),this}_ease(t,s,o){o.animate===!1||o.duration===0?(t(1),s()):(this._easeStart=ot(),this._easeOptions=o,this._onEaseFrame=t,this._onEaseEnd=s,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(t,s){t=l.W(t,-180,180);const o=Math.abs(t-s);return Math.abs(t-360-s)<o&&(t-=360),Math.abs(t+360-s)<o&&(t+=360),t}queryTerrainElevation(t){return this.terrain?this.terrain.getElevationForLngLat(l.V.convert(t),this.transform):null}}const fs={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class jc{constructor(t=fs){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=s=>{!s||s.sourceDataType!=="metadata"&&s.sourceDataType!=="visibility"&&s.dataType!=="style"&&s.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=t}getDefaultPosition(){return"bottom-right"}onAdd(t){return this._map=t,this._compact=this.options.compact,this._container=ge.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=ge.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=ge.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){ge.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(t,s){const o=this._map._getUIString(`AttributionControl.${s}`);t.title=o,t.setAttribute("aria-label",o)}_updateAttributions(){if(!this._map.style)return;let t=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=t.concat(this.options.customAttribution.map((u=>typeof u!="string"?"":u))):typeof this.options.customAttribution=="string"&&t.push(this.options.customAttribution)),this._map.style.stylesheet){const u=this._map.style.stylesheet;this.styleOwner=u.owner,this.styleId=u.id}const s=this._map.style.tileManagers;for(const u in s){const f=s[u];if(f.used||f.usedForTerrain){const _=f.getSource();_.attribution&&t.indexOf(_.attribution)<0&&t.push(_.attribution)}}t=t.filter((u=>String(u).trim())),t.sort(((u,f)=>u.length-f.length)),t=t.filter(((u,f)=>{for(let _=f+1;_<t.length;_++)if(t[_].indexOf(u)>=0)return!1;return!0}));const o=t.join(" | ");o!==this._attribHTML&&(this._attribHTML=o,t.length?(this._innerContainer.innerHTML=ge.sanitize(o),this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class Mh{constructor(t={}){this._updateCompact=()=>{const s=this._container.children;if(s.length){const o=s[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&o.classList.add("maplibregl-compact"):o.classList.remove("maplibregl-compact")}},this.options=t}getDefaultPosition(){return"bottom-left"}onAdd(t){this._map=t,this._compact=this.options&&this.options.compact,this._container=ge.create("div","maplibregl-ctrl");const s=ge.create("a","maplibregl-ctrl-logo");return s.target="_blank",s.rel="noopener nofollow",s.href="https://maplibre.org/",s.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),s.setAttribute("rel","noopener nofollow"),this._container.appendChild(s),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){ge.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class Qd{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const s=++this._id;return this._queue.push({callback:t,id:s,cancelled:!1}),s}remove(t){const s=this._currentlyRunning,o=s?this._queue.concat(s):this._queue;for(const u of o)if(u.id===t)return void(u.cancelled=!0)}run(t=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const s=this._currentlyRunning=this._queue;this._queue=[];for(const o of s)if(!o.cancelled&&(o.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var ep=l.aU([{name:"a_pos3d",type:"Int16",components:3}]);class ma extends l.E{constructor(t){super(),this._lastTilesetChange=ot(),this.tileManager=t,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.deltaZoom=1,this.tileSize=t._source.tileSize*2**this.deltaZoom,t.usedForTerrain=!0,t.tileSize=this.tileSize}destruct(){this.tileManager.usedForTerrain=!1,this.tileManager.tileSize=null}getSource(){return this.tileManager._source}update(t,s){this.tileManager.update(t,s),this._renderableTilesKeys=[];const o={};for(const u of mr(t,{tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:s,calculateTileZoom:this.tileManager._source.calculateTileZoom}))o[u.key]=!0,this._renderableTilesKeys.push(u.key),this._tiles[u.key]||(u.terrainRttPosMatrix32f=new Float64Array(16),l.c7(u.terrainRttPosMatrix32f,0,l.a5,l.a5,0,0,1),this._tiles[u.key]=new Ue(u,this.tileSize),this._lastTilesetChange=ot());for(const u in this._tiles)o[u]||delete this._tiles[u]}freeRtt(t){for(const s in this._tiles){const o=this._tiles[s];(!t||o.tileID.equals(t)||o.tileID.isChildOf(t)||t.isChildOf(o.tileID))&&(o.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map((t=>this.getTileByID(t)))}getTileByID(t){return this._tiles[t]}getTerrainCoords(t,s){return s?this._getTerrainCoordsForTileRanges(t,s):this._getTerrainCoordsForRegularTile(t)}_getTerrainCoordsForRegularTile(t){const s={};for(const o of this._renderableTilesKeys){const u=this._tiles[o].tileID,f=t.clone(),_=l.bk();if(u.canonical.equals(t.canonical))l.c7(_,0,l.a5,l.a5,0,0,1);else if(u.canonical.isChildOf(t.canonical)){const b=u.canonical.z-t.canonical.z,T=u.canonical.x-(u.canonical.x>>b<<b),M=u.canonical.y-(u.canonical.y>>b<<b),A=l.a5>>b;l.c7(_,0,A,A,0,0,1),l.O(_,_,[-T*A,-M*A,0])}else{if(!t.canonical.isChildOf(u.canonical))continue;{const b=t.canonical.z-u.canonical.z,T=t.canonical.x-(t.canonical.x>>b<<b),M=t.canonical.y-(t.canonical.y>>b<<b),A=l.a5>>b;l.c7(_,0,l.a5,l.a5,0,0,1),l.O(_,_,[T*A,M*A,0]),l.Q(_,_,[1/2**b,1/2**b,0])}}f.terrainRttPosMatrix32f=new Float32Array(_),s[o]=f}return s}_getTerrainCoordsForTileRanges(t,s){const o={};for(const u of this._renderableTilesKeys){const f=this._tiles[u].tileID;if(!this._isWithinTileRanges(f,s))continue;const _=t.clone(),b=l.bk();if(f.canonical.z===t.canonical.z){const T=t.canonical.x-f.canonical.x,M=t.canonical.y-f.canonical.y;l.c7(b,0,l.a5,l.a5,0,0,1),l.O(b,b,[T*l.a5,M*l.a5,0])}else if(f.canonical.z>t.canonical.z){const T=f.canonical.z-t.canonical.z,M=f.canonical.x-(f.canonical.x>>T<<T),A=f.canonical.y-(f.canonical.y>>T<<T),R=t.canonical.x-(f.canonical.x>>T),z=t.canonical.y-(f.canonical.y>>T),O=l.a5>>T;l.c7(b,0,O,O,0,0,1),l.O(b,b,[-M*O+R*l.a5,-A*O+z*l.a5,0])}else{const T=t.canonical.z-f.canonical.z,M=t.canonical.x-(t.canonical.x>>T<<T),A=t.canonical.y-(t.canonical.y>>T<<T),R=(t.canonical.x>>T)-f.canonical.x,z=(t.canonical.y>>T)-f.canonical.y,O=l.a5<<T;l.c7(b,0,O,O,0,0,1),l.O(b,b,[M*l.a5+R*O,A*l.a5+z*O,0])}_.terrainRttPosMatrix32f=new Float32Array(b),o[u]=_}return o}getSourceTile(t,s){const o=this.tileManager._source;let u=t.overscaledZ-this.deltaZoom;if(u>o.maxzoom&&(u=o.maxzoom),u<o.minzoom)return;this._sourceTileCache[t.key]||(this._sourceTileCache[t.key]=t.scaledTo(u).key);let f=this.findTileInCaches(this._sourceTileCache[t.key]);if(!f?.dem&&s)for(;u>=o.minzoom&&!f?.dem;)f=this.findTileInCaches(t.scaledTo(u--).key);return f}findTileInCaches(t){let s=this.tileManager.getTileByID(t);return s||(s=this.tileManager._outOfViewCache.getByKey(t),s)}anyTilesAfterTime(t=Date.now()){return this._lastTilesetChange>=t}_isWithinTileRanges(t,s){return s[t.canonical.z]&&t.canonical.x>=s[t.canonical.z].minTileX&&t.canonical.x<=s[t.canonical.z].maxTileX&&t.canonical.y>=s[t.canonical.z].minTileY&&t.canonical.y<=s[t.canonical.z].maxTileY}}class Br{constructor(t,s,o){this._meshCache={},this.painter=t,this.tileManager=new ma(s),this.options=o,this.exaggeration=typeof o.exaggeration=="number"?o.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(t,s,o,u=l.a5){var f;if(!(s>=0&&s<u&&o>=0&&o<u))return 0;const _=this.getTerrainData(t),b=(f=_.tile)===null||f===void 0?void 0:f.dem;if(!b)return 0;const T=l.cC([],[s/u*l.a5,o/u*l.a5],_.u_terrain_matrix),M=[T[0]*b.dim,T[1]*b.dim],A=Math.floor(M[0]),R=Math.floor(M[1]),z=M[0]-A,O=M[1]-R;return b.get(A,R)*(1-z)*(1-O)+b.get(A+1,R)*z*(1-O)+b.get(A,R+1)*(1-z)*O+b.get(A+1,R+1)*z*O}getElevationForLngLatZoom(t,s){if(!l.cD(s,t.wrap()))return 0;const{tileID:o,mercatorX:u,mercatorY:f}=this._getOverscaledTileIDFromLngLatZoom(t,s);return this.getElevation(o,u%l.a5,f%l.a5,l.a5)}getElevationForLngLat(t,s){const o=mr(s,{maxzoom:this.tileManager.maxzoom,minzoom:this.tileManager.minzoom,tileSize:512,terrain:this});let u=0;for(const f of o)f.canonical.z>u&&(u=Math.min(f.canonical.z,this.tileManager.maxzoom));return this.getElevationForLngLatZoom(t,u)}getElevation(t,s,o,u=l.a5){return this.getDEMElevation(t,s,o,u)*this.exaggeration}getTerrainData(t){if(!this._emptyDemTexture){const u=this.painter.context,f=new l.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new l.T(u,f,u.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new l.T(u,new l.R({width:1,height:1}),u.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(u.gl.NEAREST,u.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=l.ar([])}const s=this.tileManager.getSourceTile(t,!0);if(s&&s.dem&&(!s.demTexture||s.needsTerrainPrepare)){const u=this.painter.context;s.demTexture=this.painter.getTileTexture(s.dem.stride),s.demTexture?s.demTexture.update(s.dem.getPixels(),{premultiply:!1}):s.demTexture=new l.T(u,s.dem.getPixels(),u.gl.RGBA,{premultiply:!1}),s.demTexture.bind(u.gl.NEAREST,u.gl.CLAMP_TO_EDGE),s.needsTerrainPrepare=!1}const o=s&&s.toString()+s.tileID.key+t.key;if(o&&!this._demMatrixCache[o]){const u=this.tileManager.getSource().maxzoom;let f=t.canonical.z-s.tileID.canonical.z;t.overscaledZ>t.canonical.z&&(t.canonical.z>=u?f=t.canonical.z-u:l.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const _=t.canonical.x-(t.canonical.x>>f<<f),b=t.canonical.y-(t.canonical.y>>f<<f),T=l.cE(new Float64Array(16),[1/(l.a5<<f),1/(l.a5<<f),0]);l.O(T,T,[_*l.a5,b*l.a5,0]),this._demMatrixCache[t.key]={matrix:T,coord:t}}return{u_depth:2,u_terrain:3,u_terrain_dim:s&&s.dem&&s.dem.dim||1,u_terrain_matrix:o?this._demMatrixCache[t.key].matrix:this._emptyDemMatrix,u_terrain_unpack:s&&s.dem&&s.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(s&&s.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:s}}getFramebuffer(t){const s=this.painter,o=s.width/devicePixelRatio,u=s.height/devicePixelRatio;return!this._fbo||this._fbo.width===o&&this._fbo.height===u||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new l.T(s.context,{width:o,height:u,data:null},s.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(s.context.gl.NEAREST,s.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new l.T(s.context,{width:o,height:u,data:null},s.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(s.context.gl.NEAREST,s.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=s.context.createFramebuffer(o,u,!0,!1),this._fbo.depthAttachment.set(s.context.createRenderbuffer(s.context.gl.DEPTH_COMPONENT16,o,u))),this._fbo.colorAttachment.set(t==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const t=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const s=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let f=0,_=0;f<this._coordsTextureSize;f++)for(let b=0;b<this._coordsTextureSize;b++,_+=4)s[_+0]=255&b,s[_+1]=255&f,s[_+2]=b>>8<<4|f>>8,s[_+3]=0;const o=new l.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(s.buffer)),u=new l.T(t,o,t.gl.RGBA,{premultiply:!1});return u.bind(t.gl.NEAREST,t.gl.CLAMP_TO_EDGE),this._coordsTexture=u,u}pointCoordinate(t){this.painter.maybeDrawDepthAndCoords(!0);const s=new Uint8Array(4),o=this.painter.context,u=o.gl,f=Math.round(t.x*this.painter.pixelRatio/devicePixelRatio),_=Math.round(t.y*this.painter.pixelRatio/devicePixelRatio),b=Math.round(this.painter.height/devicePixelRatio);o.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),u.readPixels(f,b-_-1,1,1,u.RGBA,u.UNSIGNED_BYTE,s),o.bindFramebuffer.set(null);const T=s[0]+(s[2]>>4<<8),M=s[1]+((15&s[2])<<8),A=this.coordsIndex[255-s[3]],R=A&&this.tileManager.getTileByID(A);if(!R)return null;const z=this._coordsTextureSize,O=(1<<R.tileID.canonical.z)*z;return new l.a9((R.tileID.canonical.x*z+T)/O+R.tileID.wrap,(R.tileID.canonical.y*z+M)/O,this.getElevation(R.tileID,T,M,z))}depthAtPoint(t){const s=new Uint8Array(4),o=this.painter.context,u=o.gl;return o.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),u.readPixels(t.x,this.painter.height/devicePixelRatio-t.y-1,1,1,u.RGBA,u.UNSIGNED_BYTE,s),o.bindFramebuffer.set(null),(s[0]/16777216+s[1]/65536+s[2]/256+s[3])/256}getTerrainMesh(t){var s;const o=((s=this.painter.style.projection)===null||s===void 0?void 0:s.transitionState)>0,u=o&&t.canonical.y===0,f=o&&t.canonical.y===(1<<t.canonical.z)-1,_=`m_${u?"n":""}_${f?"s":""}`;if(this._meshCache[_])return this._meshCache[_];const b=this.painter.context,T=new l.cF,M=new l.aY,A=this.meshSize,R=l.a5/A,z=A*A;for(let ie=0;ie<=A;ie++)for(let pe=0;pe<=A;pe++)T.emplaceBack(pe*R,ie*R,0);for(let ie=0;ie<z;ie+=A+1)for(let pe=0;pe<A;pe++)M.emplaceBack(pe+ie,A+pe+ie+1,A+pe+ie+2),M.emplaceBack(pe+ie,A+pe+ie+2,pe+ie+1);const O=T.length,V=O+(A+1),W=(A+1)*A,Y=u?l.br:0,X=u?0:1,te=f?l.bs:l.a5,le=f?0:1;for(let ie=0;ie<=A;ie++)T.emplaceBack(ie*R,Y,X);for(let ie=0;ie<=A;ie++)T.emplaceBack(ie*R,te,le);for(let ie=0;ie<A;ie++)M.emplaceBack(W+ie,V+ie,V+ie+1),M.emplaceBack(W+ie,V+ie+1,W+ie+1),M.emplaceBack(0+ie,O+ie+1,O+ie),M.emplaceBack(0+ie,0+ie+1,O+ie+1);const Q=T.length,ne=Q+2*(A+1);for(const ie of[0,1])for(let pe=0;pe<=A;pe++)for(const Ce of[0,1])T.emplaceBack(ie*l.a5,pe*R,Ce);for(let ie=0;ie<2*A;ie+=2)M.emplaceBack(Q+ie,Q+ie+1,Q+ie+3),M.emplaceBack(Q+ie,Q+ie+3,Q+ie+2),M.emplaceBack(ne+ie,ne+ie+3,ne+ie+1),M.emplaceBack(ne+ie,ne+ie+2,ne+ie+3);const ue=new yr(b.createVertexBuffer(T,ep.members),b.createIndexBuffer(M),l.aX.simpleSegment(0,0,T.length,M.length));return this._meshCache[_]=ue,ue}getMeshFrameDelta(t){return 2*Math.PI*l.bE/Math.pow(2,Math.max(t,0))/5}getMinTileElevationForLngLatZoom(t,s){var o;if(!l.cD(s,t.wrap()))return 0;const{tileID:u}=this._getOverscaledTileIDFromLngLatZoom(t,s);return(o=this.getMinMaxElevation(u).minElevation)!==null&&o!==void 0?o:0}getMinMaxElevation(t){const s=this.getTerrainData(t).tile,o={minElevation:null,maxElevation:null};return s&&s.dem&&(o.minElevation=s.dem.min*this.exaggeration,o.maxElevation=s.dem.max*this.exaggeration),o}_getOverscaledTileIDFromLngLatZoom(t,s){const o=l.a9.fromLngLat(t.wrap()),u=(1<<s)*l.a5,f=o.x*u,_=o.y*u,b=Math.floor(f/l.a5),T=Math.floor(_/l.a5);return{tileID:new l.a2(s,0,s,b,T),mercatorX:f,mercatorY:_}}}class Jr{constructor(t,s,o){this._context=t,this._size=s,this._tileSize=o,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const t of this._objects)t.texture.destroy(),t.fbo.destroy()}_createObject(t){const s=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),o=new l.T(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return o.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),this._context.extTextureFilterAnisotropic&&this._context.gl.texParameterf(this._context.gl.TEXTURE_2D,this._context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._context.extTextureFilterAnisotropicMax),s.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),s.colorAttachment.set(o.texture),{id:t,fbo:s,texture:o,stamp:-1,inUse:!1}}getObjectForId(t){return this._objects[t]}useObject(t){t.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter((s=>t.id!==s)),this._recentlyUsed.push(t.id)}stampObject(t){t.stamp=++this._stamp}getOrCreateFreeObject(){for(const s of this._recentlyUsed)if(!this._objects[s].inUse)return this._objects[s];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const t=this._createObject(this._objects.length);return this._objects.push(t),t}freeObject(t){t.inUse=!1}freeAllObjects(){for(const t of this._objects)this.freeObject(t)}isFull(){return!(this._objects.length<this._size)&&this._objects.some((t=>!t.inUse))===!1}}const Un={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0,"color-relief":!0};class ga{constructor(t,s){this.painter=t,this.terrain=s,this.pool=new Jr(t.context,30,s.tileManager.tileSize*s.qualityFactor)}destruct(){this.pool.destruct()}getTexture(t){return this.pool.getObjectForId(t.rtt[this._stacks.length-1].id).texture}prepareForRender(t,s){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.tileManager.getRenderableTiles(),this._renderableLayerIds=t._order.filter((o=>!t._layers[o].isHidden(s))),this._coordsAscending={};for(const o in t.tileManagers){this._coordsAscending[o]={};const u=t.tileManagers[o].getVisibleCoordinates(),f=t.tileManagers[o].getSource(),_=f instanceof Ai?f.terrainTileRanges:null;for(const b of u){const T=this.terrain.tileManager.getTerrainCoords(b,_);for(const M in T)this._coordsAscending[o][M]||(this._coordsAscending[o][M]=[]),this._coordsAscending[o][M].push(T[M])}}this._coordsAscendingStr={};for(const o of t._order){const u=t._layers[o],f=u.source;if(Un[u.type]&&!this._coordsAscendingStr[f]){this._coordsAscendingStr[f]={};for(const _ in this._coordsAscending[f])this._coordsAscendingStr[f][_]=this._coordsAscending[f][_].map((b=>b.key)).sort().join()}}for(const o of this._renderableTiles)for(const u in this._coordsAscendingStr){const f=this._coordsAscendingStr[u][o.tileID.key];f&&f!==o.rttCoords[u]&&(o.rtt=[])}}renderLayer(t,s){if(t.isHidden(this.painter.transform.zoom))return!1;const o=Object.assign(Object.assign({},s),{isRenderingToTexture:!0}),u=t.type,f=this.painter,_=this._renderableLayerIds[this._renderableLayerIds.length-1]===t.id;if(Un[u]&&(this._prevType&&Un[this._prevType]||this._stacks.push([]),this._prevType=u,this._stacks[this._stacks.length-1].push(t.id),!_))return!0;if(Un[this._prevType]||Un[u]&&_){this._prevType=u;const b=this._stacks.length-1,T=this._stacks[b]||[];for(const M of this._renderableTiles){if(this.pool.isFull()&&(Ic(this.painter,this.terrain,this._rttTiles,o),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(M),M.rtt[b]){const R=this.pool.getObjectForId(M.rtt[b].id);if(R.stamp===M.rtt[b].stamp){this.pool.useObject(R);continue}}const A=this.pool.getOrCreateFreeObject();this.pool.useObject(A),this.pool.stampObject(A),M.rtt[b]={id:A.id,stamp:A.stamp},f.context.bindFramebuffer.set(A.fbo.framebuffer),f.context.clear({color:l.bp.transparent,stencil:0}),f.currentStencilSource=void 0;for(let R=0;R<T.length;R++){const z=f.style._layers[T[R]],O=z.source?this._coordsAscending[z.source][M.tileID.key]:[M.tileID];f.context.viewport.set([0,0,A.fbo.width,A.fbo.height]),f._renderTileClippingMasks(z,O,!0),f.renderLayer(f,f.style.tileManagers[z.source],z,O,o),z.source&&(M.rttCoords[z.source]=this._coordsAscendingStr[z.source][M.tileID.key])}}return Ic(this.painter,this.terrain,this._rttTiles,o),this._rttTiles=[],this.pool.freeAllObjects(),Un[u]}return!1}}const pl={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","GlobeControl.Enable":"Enable globe","GlobeControl.Disable":"Disable globe","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use ⌘ + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},Nc=$,fl={hash:!1,interactive:!0,bearingSnap:7,attributionControl:fs,maplibreLogo:!1,refreshExpiredTiles:!0,canvasContextAttributes:{antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,desynchronized:!1,contextType:void 0},scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],elevation:0,zoom:0,bearing:0,pitch:0,roll:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:l.c.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,transformConstrain:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,rollEnabled:!1,reduceMotion:void 0,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0,centerClampedToGround:!0,experimentalZoomLevelsToOverscale:void 0},Vc={showCompass:!0,showZoom:!0,visualizePitch:!1,visualizeRoll:!0};class _a{constructor(t,s,o=!1){this.mousedown=f=>{this.startMove(f,ge.mousePos(this.element,f)),ge.addEventListener(window,"mousemove",this.mousemove),ge.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=f=>{this.move(f,ge.mousePos(this.element,f))},this.mouseup=f=>{this._rotatePitchHandler.dragEnd(f),this.offTemp()},this.touchstart=f=>{f.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=ge.touchPos(this.element,f.targetTouches)[0],this.startMove(f,this._startPos),ge.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),ge.addEventListener(window,"touchend",this.touchend))},this.touchmove=f=>{f.targetTouches.length!==1?this.reset():(this._lastPos=ge.touchPos(this.element,f.targetTouches)[0],this.move(f,this._lastPos))},this.touchend=f=>{f.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this._rotatePitchHandler.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10,this.element=s;const u=new vh;this._rotatePitchHandler=new Po({clickTolerance:3,move:(f,_)=>{const b=s.getBoundingClientRect(),T=new l.P((b.bottom-b.top)/2,(b.right-b.left)/2);return{bearingDelta:l.cx(new l.P(f.x,_.y),_,T),pitchDelta:o?-.5*(_.y-f.y):void 0}},moveStateManager:u,enable:!0,assignEvents:()=>{}}),this.map=t,ge.addEventListener(s,"mousedown",this.mousedown),ge.addEventListener(s,"touchstart",this.touchstart,{passive:!1}),ge.addEventListener(s,"touchcancel",this.reset)}startMove(t,s){this._rotatePitchHandler.dragStart(t,s),ge.disableDrag()}move(t,s){const o=this.map,{bearingDelta:u,pitchDelta:f}=this._rotatePitchHandler.dragMove(t,s)||{};u&&o.setBearing(o.getBearing()+u),f&&o.setPitch(o.getPitch()+f)}off(){const t=this.element;ge.removeEventListener(t,"mousedown",this.mousedown),ge.removeEventListener(t,"touchstart",this.touchstart,{passive:!1}),ge.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),ge.removeEventListener(window,"touchend",this.touchend),ge.removeEventListener(t,"touchcancel",this.reset),this.offTemp()}offTemp(){ge.enableDrag(),ge.removeEventListener(window,"mousemove",this.mousemove),ge.removeEventListener(window,"mouseup",this.mouseup),ge.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),ge.removeEventListener(window,"touchend",this.touchend)}}let Ys;function ml(p,t,s,o=!1){if(o||!s.getCoveringTilesDetailsProvider().allowWorldCopies())return p?.wrap();const u=new l.V(p.lng,p.lat);if(p=new l.V(p.lng,p.lat),t){const f=new l.V(p.lng-360,p.lat),_=new l.V(p.lng+360,p.lat),b=s.locationToScreenPoint(p).distSqr(t);s.locationToScreenPoint(f).distSqr(t)<b?p=f:s.locationToScreenPoint(_).distSqr(t)<b&&(p=_)}for(;Math.abs(p.lng-s.center.lng)>180;){const f=s.locationToScreenPoint(p);if(f.x>=0&&f.y>=0&&f.x<=s.width&&f.y<=s.height)break;p.lng>s.center.lng?p.lng-=360:p.lng+=360}return p.lng!==u.lng&&s.isPointOnMapSurface(s.locationToScreenPoint(p))?p:u}const ya={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function gl(p,t,s){const o=p.classList;for(const u in ya)o.remove(`maplibregl-${s}-anchor-${u}`);o.add(`maplibregl-${s}-anchor-${t}`)}class xa extends l.E{constructor(t){if(super(),this._onKeyPress=s=>{const o=s.code,u=s.charCode||s.keyCode;o!=="Space"&&o!=="Enter"&&u!==32&&u!==13||this.togglePopup()},this._onMapClick=s=>{const o=s.originalEvent.target,u=this._element;this._popup&&(o===u||u.contains(o))&&this.togglePopup()},this._update=s=>{if(!this._map)return;const o=this._map.loaded()&&!this._map.isMoving();(s?.type==="terrain"||s?.type==="render"&&!o)&&this._map.once("render",this._update),this._lngLat=ml(this._lngLat,this._flatPos,this._map.transform),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationToScreenPoint(this._lngLat)._add(this._offset));let u="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?u=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(u=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let f="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?f="rotateX(0deg)":this._pitchAlignment==="map"&&(f=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||s&&s.type!=="moveend"||(this._pos=this._pos.round()),ge.setTransform(this._element,`${ya[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${f} ${u}`),ze.frameAsync(new AbortController).then((()=>{this._updateOpacity(s&&s.type==="moveend")})).catch((()=>{}))},this._onMove=s=>{if(!this._isDragging){const o=this._clickTolerance||this._map._clickTolerance;this._isDragging=s.point.dist(this._pointerdownPos)>=o}this._isDragging&&(this._pos=s.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new l.l("dragstart"))),this.fire(new l.l("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new l.l("dragend")),this._state="inactive"},this._addDragHandler=s=>{this._element.contains(s.originalEvent.target)&&(s.preventDefault(),this._positionDelta=s.point.sub(this._pos).add(this._offset),this._pointerdownPos=s.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._subpixelPositioning=t&&t.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&t.pitchAlignment!=="auto"?t.pitchAlignment:this._rotationAlignment,this.setOpacity(t?.opacity,t?.opacityWhenCovered),t&&t.element)this._element=t.element,this._offset=l.P.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=ge.create("div");const s=ge.createNS("http://www.w3.org/2000/svg","svg"),o=41,u=27;s.setAttributeNS(null,"display","block"),s.setAttributeNS(null,"height",`${o}px`),s.setAttributeNS(null,"width",`${u}px`),s.setAttributeNS(null,"viewBox",`0 0 ${u} ${o}`);const f=ge.createNS("http://www.w3.org/2000/svg","g");f.setAttributeNS(null,"stroke","none"),f.setAttributeNS(null,"stroke-width","1"),f.setAttributeNS(null,"fill","none"),f.setAttributeNS(null,"fill-rule","evenodd");const _=ge.createNS("http://www.w3.org/2000/svg","g");_.setAttributeNS(null,"fill-rule","nonzero");const b=ge.createNS("http://www.w3.org/2000/svg","g");b.setAttributeNS(null,"transform","translate(3.0, 29.0)"),b.setAttributeNS(null,"fill","#000000");const T=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const X of T){const te=ge.createNS("http://www.w3.org/2000/svg","ellipse");te.setAttributeNS(null,"opacity","0.04"),te.setAttributeNS(null,"cx","10.5"),te.setAttributeNS(null,"cy","5.80029008"),te.setAttributeNS(null,"rx",X.rx),te.setAttributeNS(null,"ry",X.ry),b.appendChild(te)}const M=ge.createNS("http://www.w3.org/2000/svg","g");M.setAttributeNS(null,"fill",this._color);const A=ge.createNS("http://www.w3.org/2000/svg","path");A.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),M.appendChild(A);const R=ge.createNS("http://www.w3.org/2000/svg","g");R.setAttributeNS(null,"opacity","0.25"),R.setAttributeNS(null,"fill","#000000");const z=ge.createNS("http://www.w3.org/2000/svg","path");z.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),R.appendChild(z);const O=ge.createNS("http://www.w3.org/2000/svg","g");O.setAttributeNS(null,"transform","translate(6.0, 7.0)"),O.setAttributeNS(null,"fill","#FFFFFF");const V=ge.createNS("http://www.w3.org/2000/svg","g");V.setAttributeNS(null,"transform","translate(8.0, 8.0)");const W=ge.createNS("http://www.w3.org/2000/svg","circle");W.setAttributeNS(null,"fill","#000000"),W.setAttributeNS(null,"opacity","0.25"),W.setAttributeNS(null,"cx","5.5"),W.setAttributeNS(null,"cy","5.5"),W.setAttributeNS(null,"r","5.4999962");const Y=ge.createNS("http://www.w3.org/2000/svg","circle");Y.setAttributeNS(null,"fill","#FFFFFF"),Y.setAttributeNS(null,"cx","5.5"),Y.setAttributeNS(null,"cy","5.5"),Y.setAttributeNS(null,"r","5.4999962"),V.appendChild(W),V.appendChild(Y),_.appendChild(b),_.appendChild(M),_.appendChild(R),_.appendChild(O),_.appendChild(V),s.appendChild(_),s.setAttributeNS(null,"height",o*this._scale+"px"),s.setAttributeNS(null,"width",u*this._scale+"px"),this._element.appendChild(s),this._offset=l.P.convert(t&&t.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",(s=>{s.preventDefault()})),this._element.addEventListener("mousedown",(s=>{s.preventDefault()})),gl(this._element,this._anchor,"marker"),t&&t.className)for(const s of t.className.split(" "))this._element.classList.add(s);this._popup=null}addTo(t){return this.remove(),this._map=t,this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label",t._getUIString("Marker.Title")),this._element.hasAttribute("role")||this._element.setAttribute("role","button"),t.getCanvasContainer().appendChild(this._element),t.on("move",this._update),t.on("moveend",this._update),t.on("terrain",this._update),t.on("projectiontransition",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("projectiontransition",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),ge.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=l.V.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const u=Math.abs(13.5)/Math.SQRT2;t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[u,-1*(38.1-13.5+u)],"bottom-right":[-u,-1*(38.1-13.5+u)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(t){return this._subpixelPositioning=t,this}getPopup(){return this._popup}togglePopup(){const t=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:t?(t.isOpen()?t.remove():(t.setLngLat(this._lngLat),t.addTo(this._map)),this):this}_updateOpacity(t=!1){var s,o;const u=(s=this._map)===null||s===void 0?void 0:s.terrain,f=this._map.transform.isLocationOccluded(this._lngLat);if(!u||f){const O=f?this._opacityWhenCovered:this._opacity;return void(this._element.style.opacity!==O&&(this._element.style.opacity=O))}if(t)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout((()=>{this._opacityTimeout=null}),100)}const _=this._map,b=_.terrain.depthAtPoint(this._pos),T=_.terrain.getElevationForLngLat(this._lngLat,_.transform);if(_.transform.lngLatToCameraDepth(this._lngLat,T)-b<.006)return void(this._element.style.opacity=this._opacity);const M=-this._offset.y/_.transform.pixelsPerMeter,A=Math.sin(_.getPitch()*Math.PI/180)*M,R=_.terrain.depthAtPoint(new l.P(this._pos.x,this._pos.y-this._offset.y)),z=_.transform.lngLatToCameraDepth(this._lngLat,T+A)-R>.006;!((o=this._popup)===null||o===void 0)&&o.isOpen()&&z&&this._popup.remove(),this._element.style.opacity=z?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(t){return this._offset=l.P.convert(t),this._update(),this}addClassName(t){this._element.classList.add(t)}removeClassName(t){this._element.classList.remove(t)}toggleClassName(t){return this._element.classList.toggle(t)}setDraggable(t){return this._draggable=!!t,this._map&&(t?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t&&t!=="auto"?t:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(t,s){return(this._opacity===void 0||t===void 0&&s===void 0)&&(this._opacity="1",this._opacityWhenCovered="0.2"),t!==void 0&&(this._opacity=t),s!==void 0&&(this._opacityWhenCovered=s),this._map&&this._updateOpacity(!0),this}}const $c={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let Mo=0,qn=!1;const Uc={maxWidth:100,unit:"metric"};function va(p,t,s){const o=s&&s.maxWidth||100,u=p._container.clientHeight/2,f=p._container.clientWidth/2,_=p.unproject([f-o/2,u]),b=p.unproject([f+o/2,u]),T=Math.round(p.project(b).x-p.project(_).x),M=Math.min(o,T,p._container.clientWidth),A=_.distanceTo(b);if(s&&s.unit==="imperial"){const R=3.2808*A;R>5280?Gn(t,M,R/5280,p._getUIString("ScaleControl.Miles")):Gn(t,M,R,p._getUIString("ScaleControl.Feet"))}else s&&s.unit==="nautical"?Gn(t,M,A/1852,p._getUIString("ScaleControl.NauticalMiles")):A>=1e3?Gn(t,M,A/1e3,p._getUIString("ScaleControl.Kilometers")):Gn(t,M,A,p._getUIString("ScaleControl.Meters"))}function Gn(p,t,s,o){const u=(function(f){const _=Math.pow(10,`${Math.floor(f)}`.length-1);let b=f/_;return b=b>=10?10:b>=5?5:b>=3?3:b>=2?2:b>=1?1:(function(T){const M=Math.pow(10,Math.ceil(-Math.log(T)/Math.LN10));return Math.round(T*M)/M})(b),_*b})(s);p.style.width=t*(u/s)+"px",p.innerHTML=`${u}&nbsp;${o}`}const qc={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1,locationOccludedOpacity:void 0},_l=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function yl(p){if(p){if(typeof p=="number"){const t=Math.round(Math.abs(p)/Math.SQRT2);return{center:new l.P(0,0),top:new l.P(0,p),"top-left":new l.P(t,t),"top-right":new l.P(-t,t),bottom:new l.P(0,-p),"bottom-left":new l.P(t,-t),"bottom-right":new l.P(-t,-t),left:new l.P(p,0),right:new l.P(-p,0)}}if(p instanceof l.P||Array.isArray(p)){const t=l.P.convert(p);return{center:t,top:t,"top-left":t,"top-right":t,bottom:t,"bottom-left":t,"bottom-right":t,left:t,right:t}}return{center:l.P.convert(p.center||[0,0]),top:l.P.convert(p.top||[0,0]),"top-left":l.P.convert(p["top-left"]||[0,0]),"top-right":l.P.convert(p["top-right"]||[0,0]),bottom:l.P.convert(p.bottom||[0,0]),"bottom-left":l.P.convert(p["bottom-left"]||[0,0]),"bottom-right":l.P.convert(p["bottom-right"]||[0,0]),left:l.P.convert(p.left||[0,0]),right:l.P.convert(p.right||[0,0])}}return yl(new l.P(0,0))}const Gc=$;S.AJAXError=l.cI,S.Event=l.l,S.Evented=l.E,S.LngLat=l.V,S.MercatorCoordinate=l.a9,S.Point=l.P,S.addProtocol=l.cJ,S.config=l.c,S.removeProtocol=l.cK,S.AttributionControl=jc,S.BoxZoomHandler=So,S.CanvasSource=N,S.CooperativeGesturesHandler=bt,S.DoubleClickZoomHandler=Bc,S.DragPanHandler=Eh,S.DragRotateHandler=Ps,S.EdgeInsets=oo,S.FullscreenControl=class extends l.E{constructor(p={}){super(),this._onFullscreenChange=()=>{var t;let s=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((t=s?.shadowRoot)===null||t===void 0)&&t.fullscreenElement;)s=s.shadowRoot.fullscreenElement;s===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,p&&p.container&&(p.container instanceof HTMLElement?this._container=p.container:l.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(p){return this._map=p,this._container||(this._container=this._map.getContainer()),this._controlContainer=ge.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){ge.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const p=this._fullscreenButton=ge.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);ge.create("span","maplibregl-ctrl-icon",p).setAttribute("aria-hidden","true"),p.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const p=this._getTitle();this._fullscreenButton.setAttribute("aria-label",p),this._fullscreenButton.title=p}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new l.l("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new l.l("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},S.GeoJSONSource=Ti,S.GeolocateControl=class extends l.E{constructor(p){super(),this._onSuccess=t=>{if(this._map){if(this._isOutOfMapMaxBounds(t))return this._setErrorState(),this.fire(new l.l("outofmaxbounds",t)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=t,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(t),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(t),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new l.l("geolocate",t)),this._finish()}},this._updateCamera=t=>{const s=new l.V(t.coords.longitude,t.coords.latitude),o=t.coords.accuracy,u=this._map.getBearing(),f=l.e({bearing:u},this.options.fitBoundsOptions),_=Mr.fromLngLat(s,o);this._map.fitBounds(_,f,{geolocateSource:!0})},this._updateMarker=t=>{if(t){const s=new l.V(t.coords.longitude,t.coords.latitude);this._accuracyCircleMarker.setLngLat(s).addTo(this._map),this._userLocationDotMarker.setLngLat(s).addTo(this._map),this._accuracy=t.coords.accuracy,this._updateCircleRadiusIfNeeded()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onUpdate=()=>{this._updateCircleRadiusIfNeeded()},this._onError=t=>{if(this._map){if(t.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const s=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=s,this._geolocateButton.setAttribute("aria-label",s),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(t.code===3&&qn)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new l.l("error",t)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this._geolocateButton=ge.create("button","maplibregl-ctrl-geolocate",this._container),ge.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=t=>{if(this._map){if(t===!1){l.w("Geolocation support is not available so the GeolocateControl will be disabled.");const s=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=s,this._geolocateButton.setAttribute("aria-label",s)}else{const s=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=s,this._geolocateButton.setAttribute("aria-label",s)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=ge.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new xa({element:this._dotElement}),this._circleElement=ge.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new xa({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onUpdate),this._map.on("move",this._onUpdate),this._map.on("rotate",this._onUpdate),this._map.on("pitch",this._onUpdate)),this._geolocateButton.addEventListener("click",(()=>this.trigger())),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(s=>{const o=s?.[0]instanceof ResizeObserverEntry;s.geolocateSource||this._watchState!=="ACTIVE_LOCK"||o||this._map.isZooming()||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new l.l("trackuserlocationend")),this.fire(new l.l("userlocationlostfocus")))}))}},this.options=l.e({},$c,p)}onAdd(p){return this._map=p,this._container=ge.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),(function(){return l._(this,arguments,void 0,(function*(t=!1){if(Ys!==void 0&&!t)return Ys;if(window.navigator.permissions===void 0)return Ys=!!window.navigator.geolocation,Ys;try{Ys=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{Ys=!!window.navigator.geolocation}return Ys}))})().then((t=>this._finishSetupUI(t))),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),ge.remove(this._container),this._map.off("zoom",this._onUpdate),this._map.off("move",this._onUpdate),this._map.off("rotate",this._onUpdate),this._map.off("pitch",this._onUpdate),this._map=void 0,Mo=0,qn=!1}_isOutOfMapMaxBounds(p){const t=this._map.getMaxBounds(),s=p.coords;return t&&(s.longitude<t.getWest()||s.longitude>t.getEast()||s.latitude<t.getSouth()||s.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":case"BACKGROUND_ERROR":case"OFF":case void 0:break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadiusIfNeeded(){const p=this._userLocationDotMarker.getLngLat();if(!(this.options.showUserLocation&&this.options.showAccuracyCircle&&this._accuracy&&p))return;const t=this._map.project(p),s=this._map.unproject([t.x+100,t.y]),o=p.distanceTo(s)/100,u=2*this._accuracy/o;this._circleElement.style.width=`${u.toFixed(2)}px`,this._circleElement.style.height=`${u.toFixed(2)}px`}trigger(){if(!this._setup)return l.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new l.l("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Mo--,qn=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new l.l("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new l.l("trackuserlocationstart")),this.fire(new l.l("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let p;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Mo++,Mo>1?(p={maximumAge:6e5,timeout:0},qn=!0):(p=this.options.positionOptions,qn=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,p)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},S.GlobeControl=class{constructor(){this._toggleProjection=()=>{var p;const t=(p=this._map.getProjection())===null||p===void 0?void 0:p.type;this._map.setProjection(t!=="mercator"&&t?{type:"mercator"}:{type:"globe"}),this._updateGlobeIcon()},this._updateGlobeIcon=()=>{var p;this._globeButton.classList.remove("maplibregl-ctrl-globe"),this._globeButton.classList.remove("maplibregl-ctrl-globe-enabled"),((p=this._map.getProjection())===null||p===void 0?void 0:p.type)==="globe"?(this._globeButton.classList.add("maplibregl-ctrl-globe-enabled"),this._globeButton.title=this._map._getUIString("GlobeControl.Disable")):(this._globeButton.classList.add("maplibregl-ctrl-globe"),this._globeButton.title=this._map._getUIString("GlobeControl.Enable"))}}onAdd(p){return this._map=p,this._container=ge.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._globeButton=ge.create("button","maplibregl-ctrl-globe",this._container),ge.create("span","maplibregl-ctrl-icon",this._globeButton).setAttribute("aria-hidden","true"),this._globeButton.type="button",this._globeButton.addEventListener("click",this._toggleProjection),this._updateGlobeIcon(),this._map.on("styledata",this._updateGlobeIcon),this._container}onRemove(){ge.remove(this._container),this._map.off("styledata",this._updateGlobeIcon),this._globeButton.removeEventListener("click",this._toggleProjection),this._map=void 0}},S.Hash=kc,S.ImageSource=Ai,S.KeyboardHandler=gr,S.LngLatBounds=Mr,S.LogoControl=Mh,S.Map=class extends qi{constructor(p){var t,s;l.cG.mark(l.cH.create);const o=Object.assign(Object.assign(Object.assign({},fl),p),{canvasContextAttributes:Object.assign(Object.assign({},fl.canvasContextAttributes),p.canvasContextAttributes)});if(o.minZoom!=null&&o.maxZoom!=null&&o.minZoom>o.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(o.minPitch!=null&&o.maxPitch!=null&&o.minPitch>o.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(o.minPitch!=null&&o.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(o.maxPitch!=null&&o.maxPitch>180)throw new Error("maxPitch must be less than or equal to 180");const u=new Dn,f=new zn;if(o.minZoom!==void 0&&u.setMinZoom(o.minZoom),o.maxZoom!==void 0&&u.setMaxZoom(o.maxZoom),o.minPitch!==void 0&&u.setMinPitch(o.minPitch),o.maxPitch!==void 0&&u.setMaxPitch(o.maxPitch),o.renderWorldCopies!==void 0&&u.setRenderWorldCopies(o.renderWorldCopies),o.transformConstrain!==null&&u.setConstrainOverride(o.transformConstrain),super(u,f,{bearingSnap:o.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new Qd,this._controls=[],this._mapId=l.af(),this._lostContextStyle={style:null,images:null},this._contextLost=b=>{b.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.painter.destroy();for(const T of Object.values(this.style._layers))if(T.type==="custom"&&console.warn(`Custom layer with id '${T.id}' cannot be restored after WebGL context loss. You will need to re-add it manually after context restoration.`),T._listeners)for(const[M]of Object.entries(T._listeners))console.warn(`Custom layer with id '${T.id}' had event listeners for event '${M}' which cannot be restored after WebGL context loss. You will need to re-add them manually after context restoration.`);this._lostContextStyle=this._getStyleAndImages(),this.style.destroy(),this.style=null,this.fire(new l.l("webglcontextlost",{originalEvent:b}))},this._contextRestored=b=>{this._lostContextStyle.style&&this.setStyle(this._lostContextStyle.style,{diff:!1}),this._lostContextStyle.images&&(this.style.imageManager.images=this._lostContextStyle.images),this._setupPainter(),this.resize(),this._update(),this.fire(new l.l("webglcontextrestored",{originalEvent:b}))},this._onMapScroll=b=>{if(b.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=o.interactive,this._maxTileCacheSize=o.maxTileCacheSize,this._maxTileCacheZoomLevels=o.maxTileCacheZoomLevels,this._canvasContextAttributes=Object.assign({},o.canvasContextAttributes),this._trackResize=o.trackResize===!0,this._bearingSnap=o.bearingSnap,this._centerClampedToGround=o.centerClampedToGround,this._refreshExpiredTiles=o.refreshExpiredTiles===!0,this._fadeDuration=o.fadeDuration,this._crossSourceCollisions=o.crossSourceCollisions===!0,this._collectResourceTiming=o.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},pl),o.locale),this._clickTolerance=o.clickTolerance,this._overridePixelRatio=o.pixelRatio,this._maxCanvasSize=o.maxCanvasSize,this._zoomLevelsToOverscale=o.experimentalZoomLevelsToOverscale,this.transformCameraUpdate=o.transformCameraUpdate,this.transformConstrain=o.transformConstrain,this.cancelPendingTileRequestsWhileZooming=o.cancelPendingTileRequestsWhileZooming===!0,o.reduceMotion!==void 0&&(ze.prefersReducedMotion=o.reduceMotion),this._imageQueueHandle=Ye.addThrottleControl((()=>this.isMoving())),this._requestManager=new He(o.transformRequest),typeof o.container=="string"){if(this._container=document.getElementById(o.container),!this._container)throw new Error(`Container '${o.container}' not found.`)}else{if(!(o.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=o.container}if(o.maxBounds&&this.setMaxBounds(o.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this.on("terrain",(()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)})),this.once("idle",(()=>{this._idleTriggered=!0})),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let b=!1;const T=Cc((M=>{this._trackResize&&!this._removed&&(this.resize(M),this.redraw())}),50);this._resizeObserver=new ResizeObserver((M=>{b?T(M):b=!0})),this._resizeObserver.observe(this._container)}this.handlers=new dl(this,o),this._hash=o.hash&&new kc(typeof o.hash=="string"&&o.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:o.center,elevation:o.elevation,zoom:o.zoom,bearing:o.bearing,pitch:o.pitch,roll:o.roll}),o.bounds&&(this.resize(),this.fitBounds(o.bounds,l.e({},o.fitBoundsOptions,{duration:0}))));const _=typeof o.style=="string"||((s=(t=o.style)===null||t===void 0?void 0:t.projection)===null||s===void 0?void 0:s.type)!=="globe";this.resize(null,_),this._localIdeographFontFamily=o.localIdeographFontFamily,this._validateStyle=o.validateStyle,o.style&&this.setStyle(o.style,{localIdeographFontFamily:o.localIdeographFontFamily}),o.attributionControl&&this.addControl(new jc(typeof o.attributionControl=="boolean"?void 0:o.attributionControl)),o.maplibreLogo&&this.addControl(new Mh,o.logoPosition),this.on("style.load",(()=>{if(_||this._resizeTransform(),this.transform.unmodified){const b=l.U(this.style.stylesheet,["center","zoom","bearing","pitch","roll"]);this.jumpTo(b)}})),this.on("data",(b=>{this._update(b.dataType==="style"),this.fire(new l.l(`${b.dataType}data`,b))})),this.on("dataloading",(b=>{this.fire(new l.l(`${b.dataType}dataloading`,b))})),this.on("dataabort",(b=>{this.fire(new l.l("sourcedataabort",b))}))}_getMapId(){return this._mapId}setGlobalStateProperty(p,t){return this.style.setGlobalStateProperty(p,t),this._update(!0)}getGlobalState(){return this.style.getGlobalState()}addControl(p,t){if(t===void 0&&(t=p.getDefaultPosition?p.getDefaultPosition():"top-right"),!p||!p.onAdd)return this.fire(new l.k(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const s=p.onAdd(this);this._controls.push(p);const o=this._controlPositions[t];return t.indexOf("bottom")!==-1?o.insertBefore(s,o.firstChild):o.appendChild(s),this}removeControl(p){if(!p||!p.onRemove)return this.fire(new l.k(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(p);return t>-1&&this._controls.splice(t,1),p.onRemove(this),this}hasControl(p){return this._controls.indexOf(p)>-1}coveringTiles(p){return mr(this.transform,p)}calculateCameraOptionsFromTo(p,t,s,o){return o==null&&this.terrain&&(o=this.terrain.getElevationForLngLat(s,this.transform)),super.calculateCameraOptionsFromTo(p,t,s,o)}resize(p,t=!0){const[s,o]=this._containerDimensions(),u=this._getClampedPixelRatio(s,o);if(this._resizeCanvas(s,o,u),this.painter.resize(s,o,u),this.painter.overLimit()){const _=this.painter.context.gl;this._maxCanvasSize=[_.drawingBufferWidth,_.drawingBufferHeight];const b=this._getClampedPixelRatio(s,o);this._resizeCanvas(s,o,b),this.painter.resize(s,o,b)}this._resizeTransform(t);const f=!this._moving;return f&&(this.stop(),this.fire(new l.l("movestart",p)).fire(new l.l("move",p))),this.fire(new l.l("resize",p)),f&&this.fire(new l.l("moveend",p)),this}_resizeTransform(p=!0){var t;const[s,o]=this._containerDimensions();this.transform.resize(s,o,p),(t=this._requestedCameraState)===null||t===void 0||t.resize(s,o,p)}_getClampedPixelRatio(p,t){const{0:s,1:o}=this._maxCanvasSize,u=this.getPixelRatio(),f=p*u,_=t*u;return Math.min(f>s?s/f:1,_>o?o/_:1)*u}getPixelRatio(){var p;return(p=this._overridePixelRatio)!==null&&p!==void 0?p:devicePixelRatio}setPixelRatio(p){this._overridePixelRatio=p,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(p){return this.transform.setMaxBounds(Mr.convert(p)),this._update()}setMinZoom(p){if((p=p??-2)>=-2&&p<=this.transform.maxZoom){const t=this._getTransformForUpdate();return t.setMinZoom(p),this._applyUpdatedTransform(t),this._update(),this}throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(p){if((p=p??22)>=this.transform.minZoom){const t=this._getTransformForUpdate();return t.setMaxZoom(p),this._applyUpdatedTransform(t),this._update(),this}throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(p){if((p=p??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(p>=0&&p<=this.transform.maxPitch)return this.transform.setMinPitch(p),this._update(),this.getPitch()<p&&this.setPitch(p),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(p){if((p=p??60)>180)throw new Error("maxPitch must be less than or equal to 180");if(p>=this.transform.minPitch)return this.transform.setMaxPitch(p),this._update(),this.getPitch()>p&&this.setPitch(p),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(p){return this.transform.setRenderWorldCopies(p),this._update()}setTransformConstrain(p){return this.transform.setConstrainOverride(p),this._update()}project(p){return this.transform.locationToScreenPoint(l.V.convert(p),this.style&&this.terrain)}unproject(p){return this.transform.screenPointToLocation(l.P.convert(p),this.terrain)}isMoving(){var p;return this._moving||((p=this.handlers)===null||p===void 0?void 0:p.isMoving())}isZooming(){var p;return this._zooming||((p=this.handlers)===null||p===void 0?void 0:p.isZooming())}isRotating(){var p;return this._rotating||((p=this.handlers)===null||p===void 0?void 0:p.isRotating())}_createDelegatedListener(p,t,s){if(p==="mouseenter"||p==="mouseover"){let o=!1;return{layers:t,listener:s,delegates:{mousemove:f=>{const _=t.filter((T=>this.getLayer(T))),b=_.length!==0?this.queryRenderedFeatures(f.point,{layers:_}):[];b.length?o||(o=!0,s.call(this,new mi(p,this,f.originalEvent,{features:b}))):o=!1},mouseout:()=>{o=!1}}}}if(p==="mouseleave"||p==="mouseout"){let o=!1;return{layers:t,listener:s,delegates:{mousemove:_=>{const b=t.filter((T=>this.getLayer(T)));(b.length!==0?this.queryRenderedFeatures(_.point,{layers:b}):[]).length?o=!0:o&&(o=!1,s.call(this,new mi(p,this,_.originalEvent)))},mouseout:_=>{o&&(o=!1,s.call(this,new mi(p,this,_.originalEvent)))}}}}{const o=u=>{const f=t.filter((b=>this.getLayer(b))),_=f.length!==0?this.queryRenderedFeatures(u.point,{layers:f}):[];_.length&&(u.features=_,s.call(this,u),delete u.features)};return{layers:t,listener:s,delegates:{[p]:o}}}}_saveDelegatedListener(p,t){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[p]=this._delegatedListeners[p]||[],this._delegatedListeners[p].push(t)}_removeDelegatedListener(p,t,s){if(!this._delegatedListeners||!this._delegatedListeners[p])return;const o=this._delegatedListeners[p];for(let u=0;u<o.length;u++){const f=o[u];if(f.listener===s&&f.layers.length===t.length&&f.layers.every((_=>t.includes(_)))){for(const _ in f.delegates)this.off(_,f.delegates[_]);return void o.splice(u,1)}}}on(p,t,s){if(s===void 0)return super.on(p,t);const o=typeof t=="string"?[t]:t,u=this._createDelegatedListener(p,o,s);this._saveDelegatedListener(p,u);for(const f in u.delegates)this.on(f,u.delegates[f]);return{unsubscribe:()=>{this._removeDelegatedListener(p,o,s)}}}once(p,t,s){if(s===void 0)return super.once(p,t);const o=typeof t=="string"?[t]:t,u=this._createDelegatedListener(p,o,s);for(const f in u.delegates){const _=u.delegates[f];u.delegates[f]=(...b)=>{this._removeDelegatedListener(p,o,s),_(...b)}}this._saveDelegatedListener(p,u);for(const f in u.delegates)this.once(f,u.delegates[f]);return this}off(p,t,s){return s===void 0?super.off(p,t):(this._removeDelegatedListener(p,typeof t=="string"?[t]:t,s),this)}queryRenderedFeatures(p,t){if(!this.style)return[];let s;const o=p instanceof l.P||Array.isArray(p),u=o?p:[[0,0],[this.transform.width,this.transform.height]];if(t=t||(o?{}:p)||{},u instanceof l.P||typeof u[0]=="number")s=[l.P.convert(u)];else{const f=l.P.convert(u[0]),_=l.P.convert(u[1]);s=[f,new l.P(_.x,f.y),_,new l.P(f.x,_.y),f]}return this.style.queryRenderedFeatures(s,t,this.transform)}querySourceFeatures(p,t){return this.style.querySourceFeatures(p,t)}setStyle(p,t){return(t=l.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},t)).diff!==!1&&t.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&p?(this._diffStyle(p,t),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._updateStyle(p,t))}setTransformRequest(p){return this._requestManager.setTransformRequest(p),this}_getUIString(p){const t=this._locale[p];if(t==null)throw new Error(`Missing UI string '${p}'`);return t}_updateStyle(p,t){var s,o;if(t.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",(()=>this._updateStyle(p,t)));const u=this.style&&t.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!p)),p?(this.style=new Fn(this,t||{}),this.style.setEventedParent(this,{style:this.style}),typeof p=="string"?this.style.loadURL(p,t,u):this.style.loadJSON(p,t,u),this):((o=(s=this.style)===null||s===void 0?void 0:s.projection)===null||o===void 0||o.destroy(),delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new Fn(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(p,t){if(typeof p=="string"){const s=this._requestManager.transformRequest(p,"Style");l.j(s,new AbortController).then((o=>{this._updateDiff(o.data,t)})).catch((o=>{o&&this.fire(new l.k(o))}))}else typeof p=="object"&&this._updateDiff(p,t)}_updateDiff(p,t){try{this.style.setState(p,t)&&this._update(!0)}catch(s){l.w(`Unable to perform style diff: ${s.message||s.error||s}.  Rebuilding the style from scratch.`),this._updateStyle(p,t)}}getStyle(){if(this.style)return this.style.serialize()}_getStyleAndImages(){return this.style?{style:this.style.serialize(),images:this.style.imageManager.cloneImages()}:{style:null,images:{}}}isStyleLoaded(){return this.style?this.style.loaded():l.w("There is no style added to the map.")}addSource(p,t){return this._lazyInitEmptyStyle(),this.style.addSource(p,t),this._update(!0)}isSourceLoaded(p){const t=this.style&&this.style.tileManagers[p];if(t!==void 0)return t.loaded();this.fire(new l.k(new Error(`There is no tile manager with ID '${p}'`)))}setTerrain(p){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),p){const t=this.style.tileManagers[p.source];if(!t)throw new Error(`cannot load terrain, because there exists no source with ID: ${p.source}`);this.terrain===null&&t.reload();for(const s in this.style._layers){const o=this.style._layers[s];o.type==="hillshade"&&o.source===p.source&&l.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality."),o.type==="color-relief"&&o.source===p.source&&l.w("You are using the same source for a color-relief layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new Br(this.painter,t,p),this.painter.renderToTexture=new ga(this.painter,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._terrainDataCallback=s=>{var o;s.dataType==="style"?this.terrain.tileManager.freeRtt():s.dataType==="source"&&s.tile&&(s.sourceId!==p.source||this._elevationFreeze||(this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))),((o=s.source)===null||o===void 0?void 0:o.type)==="image"?this.terrain.tileManager.freeRtt():this.terrain.tileManager.freeRtt(s.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.tileManager.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0);return this.fire(new l.l("terrain",{terrain:p})),this}getTerrain(){var p,t;return(t=(p=this.terrain)===null||p===void 0?void 0:p.options)!==null&&t!==void 0?t:null}areTilesLoaded(){const p=this.style&&this.style.tileManagers;for(const t of Object.values(p))if(!t.areTilesLoaded())return!1;return!0}removeSource(p){return this.style.removeSource(p),this._update(!0)}getSource(p){return this.style.getSource(p)}setSourceTileLodParams(p,t,s){if(s){const o=this.getSource(s);if(!o)throw new Error(`There is no source with ID "${s}", cannot set LOD parameters`);o.calculateTileZoom=or(Math.max(1,p),Math.max(1,t))}else for(const o in this.style.tileManagers)this.style.tileManagers[o].getSource().calculateTileZoom=or(Math.max(1,p),Math.max(1,t));return this._update(!0),this}refreshTiles(p,t){const s=this.style.tileManagers[p];if(!s)throw new Error(`There is no tile manager with ID "${p}", cannot refresh tile`);t===void 0?s.reload(!0):s.refreshTiles(t.map((o=>new l.ac(o.z,o.x,o.y))))}addImage(p,t,s={}){const{pixelRatio:o=1,sdf:u=!1,stretchX:f,stretchY:_,content:b,textFitWidth:T,textFitHeight:M}=s;if(this._lazyInitEmptyStyle(),!(t instanceof HTMLImageElement||l.b(t))){if(t.width===void 0||t.height===void 0)return this.fire(new l.k(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:A,height:R,data:z}=t,O=t;return this.style.addImage(p,{data:new l.R({width:A,height:R},new Uint8Array(z)),pixelRatio:o,stretchX:f,stretchY:_,content:b,textFitWidth:T,textFitHeight:M,sdf:u,version:0,userImage:O}),O.onAdd&&O.onAdd(this,p),this}}{const{width:A,height:R,data:z}=ze.getImageData(t);this.style.addImage(p,{data:new l.R({width:A,height:R},z),pixelRatio:o,stretchX:f,stretchY:_,content:b,textFitWidth:T,textFitHeight:M,sdf:u,version:0})}}updateImage(p,t){const s=this.style.getImage(p);if(!s)return this.fire(new l.k(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const o=t instanceof HTMLImageElement||l.b(t)?ze.getImageData(t):t,{width:u,height:f,data:_}=o;if(u===void 0||f===void 0)return this.fire(new l.k(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(u!==s.data.width||f!==s.data.height)return this.fire(new l.k(new Error("The width and height of the updated image must be that same as the previous version of the image")));const b=!(t instanceof HTMLImageElement||l.b(t));return s.data.replace(_,b),this.style.updateImage(p,s),this}getImage(p){return this.style.getImage(p)}hasImage(p){return p?!!this.style.getImage(p):(this.fire(new l.k(new Error("Missing required image id"))),!1)}removeImage(p){this.style.removeImage(p)}loadImage(p){return Ye.getImage(this._requestManager.transformRequest(p,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(p,t){return this._lazyInitEmptyStyle(),this.style.addLayer(p,t),this._update(!0)}moveLayer(p,t){return this.style.moveLayer(p,t),this._update(!0)}removeLayer(p){return this.style.removeLayer(p),this._update(!0)}getLayer(p){return this.style.getLayer(p)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(p,t,s){return this.style.setLayerZoomRange(p,t,s),this._update(!0)}setFilter(p,t,s={}){return this.style.setFilter(p,t,s),this._update(!0)}getFilter(p){return this.style.getFilter(p)}setPaintProperty(p,t,s,o={}){return this.style.setPaintProperty(p,t,s,o),this._update(!0)}getPaintProperty(p,t){return this.style.getPaintProperty(p,t)}setLayoutProperty(p,t,s,o={}){return this.style.setLayoutProperty(p,t,s,o),this._update(!0)}getLayoutProperty(p,t){return this.style.getLayoutProperty(p,t)}setGlyphs(p,t={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(p,t),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(p,t,s={}){return this._lazyInitEmptyStyle(),this.style.addSprite(p,t,s,(o=>{o||this._update(!0)})),this}removeSprite(p){return this._lazyInitEmptyStyle(),this.style.removeSprite(p),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(p,t={}){return this._lazyInitEmptyStyle(),this.style.setSprite(p,t,(s=>{s||this._update(!0)})),this}setLight(p,t={}){return this._lazyInitEmptyStyle(),this.style.setLight(p,t),this._update(!0)}getLight(){return this.style.getLight()}setSky(p,t={}){return this._lazyInitEmptyStyle(),this.style.setSky(p,t),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(p,t){return this.style.setFeatureState(p,t),this._update()}removeFeatureState(p,t){return this.style.removeFeatureState(p,t),this._update()}getFeatureState(p){return this.style.getFeatureState(p)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let p=0,t=0;return this._container&&(p=this._container.clientWidth||400,t=this._container.clientHeight||300),[p,t]}_setupContainer(){const p=this._container;p.classList.add("maplibregl-map");const t=this._canvasContainer=ge.create("div","maplibregl-canvas-container",p);this._interactive&&t.classList.add("maplibregl-interactive"),this._canvas=ge.create("canvas","maplibregl-canvas",t),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const s=this._containerDimensions(),o=this._getClampedPixelRatio(s[0],s[1]);this._resizeCanvas(s[0],s[1],o);const u=this._controlContainer=ge.create("div","maplibregl-control-container",p),f=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((_=>{f[_]=ge.create("div",`maplibregl-ctrl-${_} `,u)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(p,t,s){this._canvas.width=Math.floor(s*p),this._canvas.height=Math.floor(s*t),this._canvas.style.width=`${p}px`,this._canvas.style.height=`${t}px`}_setupPainter(){const p=Object.assign(Object.assign({},this._canvasContextAttributes),{alpha:!0,depth:!0,stencil:!0,premultipliedAlpha:!0});let t=null;this._canvas.addEventListener("webglcontextcreationerror",(o=>{t={requestedAttributes:p},o&&(t.statusMessage=o.statusMessage,t.type=o.type)}),{once:!0});let s=null;if(s=this._canvasContextAttributes.contextType?this._canvas.getContext(this._canvasContextAttributes.contextType,p):this._canvas.getContext("webgl2",p)||this._canvas.getContext("webgl",p),!s){const o="Failed to initialize WebGL";throw t?(t.message=o,new Error(JSON.stringify(t))):new Error(o)}this.painter=new gh(s,this.transform),Pt.testSupport(s)}migrateProjection(p,t){super.migrateProjection(p,t),this.painter.transform=p,this.fire(new l.l("projectiontransition",{newProjection:this.style.projection.name}))}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(p){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||p,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(p){return this._update(),this._renderTaskQueue.add(p)}_cancelRenderFrame(p){this._renderTaskQueue.remove(p)}_render(p){var t,s,o,u,f;const _=this._idleTriggered?this._fadeDuration:0,b=((t=this.style.projection)===null||t===void 0?void 0:t.transitionState)>0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(p),this._removed)return;let T=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const R=this.transform.zoom,z=ot();this.style.zoomHistory.update(R,z);const O=new l.H(R,{now:z,fadeDuration:_,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),V=O.crossFadingFactor();V===1&&V===this._crossFadingFactor||(T=!0,this._crossFadingFactor=V),this.style.update(O)}const M=((s=this.style.projection)===null||s===void 0?void 0:s.transitionState)>0!==b;(o=this.style.projection)===null||o===void 0||o.setErrorQueryLatitudeDegrees(this.transform.center.lat),this.transform.setTransitionState((u=this.style.projection)===null||u===void 0?void 0:u.transitionState,(f=this.style.projection)===null||f===void 0?void 0:f.latitudeErrorCorrectionRadians),this.style&&(this._sourcesDirty||M)&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.tileManager.update(this.transform,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),!this._elevationFreeze&&this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0)),this._placementDirty=this.style&&this.style._updatePlacement(this.transform,this.showCollisionBoxes,_,this._crossSourceCollisions,M),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:_,showPadding:this.showPadding}),this.fire(new l.l("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,l.cG.mark(l.cH.load),this.fire(new l.l("load"))),this.style&&(this.style.hasTransitions()||T)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const A=this._sourcesDirty||this._styleDirty||this._placementDirty;return A||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new l.l("idle")),!this._loaded||this._fullyLoaded||A||(this._fullyLoaded=!0,l.cG.mark(l.cH.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var p;this._hash&&this._hash.remove();for(const s of this._controls)s.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),Ye.removeThrottleControl(this._imageQueueHandle),(p=this._resizeObserver)===null||p===void 0||p.disconnect();const t=this.painter.context.gl.getExtension("WEBGL_lose_context");t?.loseContext&&t.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),ge.remove(this._canvasContainer),ge.remove(this._controlContainer),this._container.removeEventListener("scroll",this._onMapScroll,!1),this._container.classList.remove("maplibregl-map"),l.cG.clearMetrics(),this._removed=!0,this.fire(new l.l("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,ze.frame(this._frameRequest,(p=>{l.cG.frame(p),this._frameRequest=null;try{this._render(p)}catch(t){if(!l.Z(t)&&!(function(s){return s.message===Sc})(t))throw t}}),(()=>{})))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(p){this._showTileBoundaries!==p&&(this._showTileBoundaries=p,this._update())}get showPadding(){return!!this._showPadding}set showPadding(p){this._showPadding!==p&&(this._showPadding=p,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(p){this._showCollisionBoxes!==p&&(this._showCollisionBoxes=p,p?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(p){this._showOverdrawInspector!==p&&(this._showOverdrawInspector=p,this._update())}get repaint(){return!!this._repaint}set repaint(p){this._repaint!==p&&(this._repaint=p,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(p){this._vertices=p,this._update()}get version(){return Nc}getCameraTargetElevation(){return this.transform.elevation}getProjection(){return this.style.getProjection()}setProjection(p){return this._lazyInitEmptyStyle(),this.style.setProjection(p),this._update(!0)}},S.MapMouseEvent=mi,S.MapTouchEvent=la,S.MapWheelEvent=xh,S.Marker=xa,S.NavigationControl=class{constructor(p){this._updateZoomButtons=()=>{const t=this._map.getZoom(),s=t===this._map.getMaxZoom(),o=t===this._map.getMinZoom();this._zoomInButton.disabled=s,this._zoomOutButton.disabled=o,this._zoomInButton.setAttribute("aria-disabled",s.toString()),this._zoomOutButton.setAttribute("aria-disabled",o.toString())},this._rotateCompassArrow=()=>{this._compassIcon.style.transform=this.options.visualizePitch&&this.options.visualizeRoll?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateZ(${-this._map.transform.roll}deg) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizeRoll?`rotate(${-this._map.transform.bearing-this._map.transform.roll}deg)`:`rotate(${-this._map.transform.bearing}deg)`},this._setButtonTitle=(t,s)=>{const o=this._map._getUIString(`NavigationControl.${s}`);t.title=o,t.setAttribute("aria-label",o)},this.options=l.e({},Vc,p),this._container=ge.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",(t=>this._map.zoomIn({},{originalEvent:t}))),ge.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",(t=>this._map.zoomOut({},{originalEvent:t}))),ge.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",(t=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:t}):this._map.resetNorth({},{originalEvent:t})})),this._compassIcon=ge.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(p){return this._map=p,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.on("roll",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new _a(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){ge.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.off("roll",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(p,t){const s=ge.create("button",p,this._container);return s.type="button",s.addEventListener("click",t),s}},S.Popup=class extends l.E{constructor(p){super(),this._updateOpacity=()=>{this.options.locationOccludedOpacity!==void 0&&(this._container.style.opacity=this._map.transform.isLocationOccluded(this.getLngLat())?`${this.options.locationOccludedOpacity}`:"")},this.remove=()=>(this._content&&ge.remove(this._content),this._container&&(ge.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new l.l("close"))),this),this._onMouseUp=t=>{this._update(t.point)},this._onMouseMove=t=>{this._update(t.point)},this._onDrag=t=>{this._update(t.point)},this._update=t=>{if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=ge.create("div","maplibregl-popup",this._map.getContainer()),this._tip=ge.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const _ of this.options.className.split(" "))this._container.classList.add(_);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=ml(this._lngLat,this._flatPos,this._map.transform,this._trackPointer),this._trackPointer&&!t)return;const s=this._flatPos=this._pos=this._trackPointer&&t?t:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&t?t:this._map.transform.locationToScreenPoint(this._lngLat));let o=this.options.anchor;const u=yl(this.options.offset);if(!o){const _=this._container.offsetWidth,b=this._container.offsetHeight;let T;T=s.y+u.bottom.y<b?["top"]:s.y>this._map.transform.height-b?["bottom"]:[],s.x<_/2?T.push("left"):s.x>this._map.transform.width-_/2&&T.push("right"),o=T.length===0?"bottom":T.join("-")}let f=s.add(u[o]);this.options.subpixelPositioning||(f=f.round()),ge.setTransform(this._container,`${ya[o]} translate(${f.x}px,${f.y}px)`),gl(this._container,o,"popup"),this._updateOpacity()},this._onClose=()=>{this.remove()},this.options=l.e(Object.create(qc),p)}addTo(p){return this._map&&this.remove(),this._map=p,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new l.l("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(p){return this._lngLat=l.V.convert(p),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(p){return this.setDOMContent(document.createTextNode(p))}setHTML(p){const t=document.createDocumentFragment(),s=document.createElement("body");let o;for(s.innerHTML=p;o=s.firstChild,o;)t.appendChild(o);return this.setDOMContent(t)}getMaxWidth(){var p;return(p=this._container)===null||p===void 0?void 0:p.style.maxWidth}setMaxWidth(p){return this.options.maxWidth=p,this._update(),this}setDOMContent(p){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=ge.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(p),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(p){return this._container&&this._container.classList.add(p),this}removeClassName(p){return this._container&&this._container.classList.remove(p),this}setOffset(p){return this.options.offset=p,this._update(),this}toggleClassName(p){if(this._container)return this._container.classList.toggle(p)}setSubpixelPositioning(p){this.options.subpixelPositioning=p}_createCloseButton(){this.options.closeButton&&(this._closeButton=ge.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const p=this._container.querySelector(_l);p&&p.focus()}},S.RasterDEMTileSource=Hi,S.RasterTileSource=un,S.ScaleControl=class{constructor(p){this._onMove=()=>{va(this._map,this._container,this.options)},this.setUnit=t=>{this.options.unit=t,va(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},Uc),p)}getDefaultPosition(){return"bottom-left"}onAdd(p){return this._map=p,this._container=ge.create("div","maplibregl-ctrl maplibregl-ctrl-scale",p.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){ge.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},S.ScrollZoomHandler=ul,S.Style=Fn,S.TerrainControl=class{constructor(p){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=p}onAdd(p){return this._map=p,this._container=ge.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=ge.create("button","maplibregl-ctrl-terrain",this._container),ge.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){ge.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},S.TwoFingersTouchPitchHandler=Th,S.TwoFingersTouchRotateHandler=Lc,S.TwoFingersTouchZoomHandler=Fc,S.TwoFingersTouchZoomRotateHandler=pa,S.VectorTileSource=Ws,S.VideoSource=ve,S.addSourceType=(p,t)=>l._(void 0,void 0,void 0,(function*(){if(Z(p))throw new Error(`A source type called "${p}" already exists.`);((s,o)=>{j[s]=o})(p,t)})),S.clearPrewarmedResources=function(){const p=ii;p&&(p.isPreloaded()&&p.numActive()===1?(p.release(Os),ii=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},S.createTileMesh=Lu,S.getMaxParallelImageRequests=function(){return l.c.MAX_PARALLEL_IMAGE_REQUESTS},S.getRTLTextPluginStatus=function(){return _e().getRTLTextPluginStatus()},S.getVersion=function(){return Gc},S.getWorkerCount=function(){return ci.workerCount},S.getWorkerUrl=function(){return l.c.WORKER_URL},S.importScriptInWorkers=function(p){return cn().broadcast("IS",p)},S.isTimeFrozen=function(){return Ke.isFrozen()},S.now=ot,S.prewarm=function(){Vt().acquire(Os)},S.restoreNow=function(){Ke.restoreNow()},S.setMaxParallelImageRequests=function(p){l.c.MAX_PARALLEL_IMAGE_REQUESTS=p},S.setNow=function(p){Ke.setNow(p)},S.setRTLTextPlugin=function(p,t){return _e().setRTLTextPlugin(p,t)},S.setWorkerCount=function(p){ci.workerCount=p},S.setWorkerUrl=function(p){l.c.WORKER_URL=p}}));var k=g;return k}))})(dd)),dd.exports}var ld=Tw();const D_="rgb(170, 0, 0)",cf="#aaa";class Sw{width;height;data;map;focused;route;heading;rendered=!1;context;constructor(c,g,x,E){this.map=c,this.focused=g,this.route=x,this.heading=E,g?(this.width=100,this.height=100):(this.width=80,this.height=80),this.data=new Uint8ClampedArray(this.width*this.height*4)}onAdd(){const c=document.createElement("canvas");c.width=this.width,c.height=this.height,this.context=c.getContext("2d")||void 0}render(){if(this.rendered||!this.context)return!1;const c=this.width/2*.6,{context:g}=this;if(g.save(),g.fillStyle="#fff",g.clearRect(0,0,this.width,this.height),g.translate(this.width/2,this.height/2),this.focused){g.rotate(this.heading*Math.PI/180);const x=6;g.beginPath(),g.moveTo(0,-this.height/2+x),g.lineTo(35-x,35-x),g.lineTo(0,25-x),g.lineTo(-35+x,35-x),g.closePath(),g.lineWidth=x,g.strokeStyle=cf,g.stroke(),g.fillStyle=D_,g.fill(),g.rotate(-this.heading*Math.PI/180)}else{if(typeof this.heading<"u"&&this.heading!==null){g.rotate(this.heading*Math.PI/180),g.beginPath(),g.fillStyle=cf;const x=15,E=18;g.moveTo(0,0-c-x),g.lineTo(0-E/2,0-c),g.lineTo(0+E/2,0-c),g.closePath(),g.fill("evenodd"),g.rotate(-this.heading*Math.PI/180)}g.beginPath(),g.arc(0,0,c,0,2*Math.PI),g.lineWidth=4,g.strokeStyle=cf,g.fillStyle=D_,g.fill("evenodd"),g.stroke()}return g.fillStyle="#eee",g.font="20px Arial",g.textAlign="center",g.textBaseline="middle",g.fillText(this.route,0,0),g.restore(),this.data=g.getImageData(0,0,this.width,this.height).data,this.rendered=!0,!0}}const Pw=Hs({__name:"Map",props:{selectedMarker:{default:()=>({})},mapMovedManually:{type:Boolean}},emits:["markerClick","update:mapMovedManually"],setup(v,{emit:c}){const g=v,x=c;let E,k=!0;const S=Tr({get:()=>g.mapMovedManually,set:rt=>x("update:mapMovedManually",rt)}),l=tv(),$=wi(),oe=rv($,500),{stops:me,unsubscribe:we}=Qn.useStops(oe),{vehicles:ye,unsubscribe:ze}=Qn.useVehicles(oe),Ke=Tr(()=>Object.values(ye.value).map(rt=>{let Jt=rt.type,Wt=`${rt.type}-selected`;if(rt.type==="bus"||rt.type==="ferry"){const Xt=rt.type==="bus"?rt.name.split(" ")[0]:rt.name.slice(0,2),Ct={kind:"vehicle",type:rt.type,name:Xt,focused:!1,heading:rt.location.heading};Jt=JSON.stringify(Ct),Wt=JSON.stringify({...Ct,focused:!0})}return{type:"Feature",properties:{kind:"vehicle",type:rt.type,name:rt.name,id:rt.id,number:rt.name.split(" ")[0],to:rt.name.split(" ").slice(1).join(" "),iconName:Jt,iconNameFocused:Wt,iconSize:rt.type==="bus"?1.2:.8},geometry:{type:"Point",coordinates:[rt.location.longitude/36e5,rt.location.latitude/36e5]}}})),ot=Tr(()=>Object.values(me.value).map(rt=>({type:"Feature",properties:{kind:"stop",type:rt.type,name:rt.name,id:rt.id,iconName:rt.type,iconNameFocused:`${rt.type}-selected`},geometry:{type:"Point",coordinates:[rt.location.longitude/36e5,rt.location.latitude/36e5]}}))),ge=Zl(g,"selectedMarker"),{vehicle:Pt,unsubscribe:xt}=Qn.useVehicle(Tr(()=>ge.value.id)),{trip:At,unsubscribe:Qt}=Qn.useTrip(Tr(()=>Pt.value?.tripId)),Fe=Tr(()=>Pt.value?.type==="bus"&&At.value?.path?[{type:"Feature",properties:{type:"trip"},geometry:{type:"LineString",coordinates:At.value.path.map(rt=>[rt.longitude/36e5,rt.latitude/36e5])}}]:[]),st=Tr(()=>({type:"FeatureCollection",features:[...Ke.value,...ot.value,...Fe.value]})),Ye=Tr(()=>({id:"stops",type:"symbol",source:"geojson",filter:["==","kind","stop"],paint:{"icon-opacity":["match",["get","number"],Pt.value?.name.split(" ")[0]??"",1,ge.value.type==="bus"?.3:1]},layout:{"icon-image":["match",["get","id"],ge.value.id||"",["get","iconNameFocused"],["get","iconName"]],"icon-size":.4,"icon-rotation-alignment":"map","icon-allow-overlap":!0,"symbol-sort-key":["match",["get","number"],Pt.value?.name.split(" ")[0]??"",2,1]}})),He=Tr(()=>({id:"vehicles",type:"symbol",source:"geojson",paint:{"icon-opacity":["match",["get","number"],Pt.value?.name.split(" ")[0]??"",1,ge.value.type==="bus"?.3:1]},filter:["==","kind","vehicle"],layout:{"icon-image":["match",["get","id"],ge.value.id||"",["get","iconNameFocused"],["get","iconName"]],"icon-size":["get","iconSize"],"icon-rotation-alignment":"map","icon-allow-overlap":!0,"symbol-sort-key":["match",["get","number"],Pt.value?.name.split(" ")[0]??"",2,1]}})),Ge=Tr(()=>({id:"trips",type:"line",source:"geojson",filter:["==","type","trip"],paint:{"line-width":3,"line-color":"rgb(170, 0, 0)"}})),pt=nv("mapElement"),{width:vt,height:Qe}=iv(pt);function Zt(rt){E&&E.flyTo({center:rt,padding:{left:vt.value>=768?320:0,bottom:vt.value>=768?0:Qe.value*(2/3)}})}sv(async()=>{const{lastLocation:rt}=Cf();E=new ld.Map({container:"map",style:l.value==="dark"?Qg:e_,minZoom:5,maxZoom:18,center:rt.value.center,zoom:rt.value.zoom,pitch:rt.value.pitch,bearing:rt.value.bearing,maxBounds:[5,46,15,57],attributionControl:!1});const Jt=new ld.AttributionControl({compact:!0});E.addControl(Jt,"bottom-left");const Wt=new ld.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});E.addControl(Wt,"bottom-right"),E.addControl(new ld.NavigationControl({}),"bottom-right"),navigator.permissions&&(await navigator.permissions.query({name:"geolocation"})).state==="granted"&&Wt.trigger(),E.on("styleimagemissing",Kt=>{if(Kt.id[0]!=="{")return;const Nt=JSON.parse(Kt.id);Nt.kind==="vehicle"&&(Nt.type==="bus"||Nt.type==="ferry")&&E.addImage(Kt.id,new Sw(E,Nt.focused,Nt.name,Nt.heading),{pixelRatio:2})});async function Xt(Kt,Nt){const hr=await E.loadImage(Nt);E.addImage(Kt,hr.data,{pixelRatio:2})}async function Ct(){await Xt("bus-stop","/icons/stop-bus.png"),await Xt("bus-stop-selected","/icons/stop-bus-selected.png"),await Xt("bike-stop","/icons/stop-bike.png"),await Xt("bike-stop-selected","/icons/stop-bike-selected.png"),await Xt("tram-stop","/icons/stop-tram.png"),await Xt("tram-stop-selected","/icons/stop-tram-selected.png"),await Xt("train-stop","/icons/stop-train.png"),await Xt("train-stop-selected","/icons/stop-train-selected.png"),await Xt("ferry-stop","/icons/stop-ferry.png"),await Xt("ferry-stop-selected","/icons/stop-ferry-selected.png"),await Xt("escooter","/icons/vehicle-escooter.png"),await Xt("escooter-selected","/icons/vehicle-escooter-selected.png")}E.on("load",()=>{Ct(),E.addSource("geojson",{type:"geojson",data:Object.freeze(st.value)}),E.addLayer(Ye.value),E.addLayer(Ge.value),E.addLayer(He.value),$.value={north:E.getBounds().getNorth(),east:E.getBounds().getEast(),south:E.getBounds().getSouth(),west:E.getBounds().getWest()},k=!1}),E.on("mouseenter","vehicles",()=>{E.getCanvas().style.cursor="pointer"}),E.on("mouseleave","vehicles",()=>{E.getCanvas().style.cursor=""}),E.on("mouseenter","stops",()=>{E.getCanvas().style.cursor="pointer"}),E.on("mouseleave","stops",()=>{E.getCanvas().style.cursor=""}),E.on("click",Kt=>{const Nt=E.queryRenderedFeatures(Kt.point,{layers:["stops","vehicles"]});if(Nt.length===0){x("markerClick");return}const hr=Nt[0];hr.properties.id!==ge.value.id&&(S.value=!1,x("markerClick",{type:hr.properties.type,id:hr.properties.id}))}),E.on("drag",()=>{S.value=!0}),E.on("move",()=>{rt.value={center:E.getCenter(),zoom:E.getZoom(),pitch:E.getPitch(),bearing:E.getBearing()},$.value={north:E.getBounds().getNorth(),east:E.getBounds().getEast(),south:E.getBounds().getSouth(),west:E.getBounds().getWest()}}),E.on("idle",()=>{pt.value&&pt.value.setAttribute("data-idle","true")})}),N_(async()=>{await we(),await ze(),await xt(),await Qt()}),Ro(l,()=>{l.value==="dark"?E.setStyle(Qg):E.setStyle(e_),window.location.reload()}),Ro(st,()=>{if(!E)return;const rt=E.getSource("geojson");(Wt=>Wt?.type==="geojson")(rt)&&rt.setData(Object.freeze(st.value))}),Ro(Ye,()=>{!E||k||(Ye.value.layout&&Object.keys(Ye.value.layout).forEach(rt=>{Ye.value.layout&&E.setLayoutProperty("stops",rt,Ye.value.layout[rt])}),Ye.value.paint&&Object.keys(Ye.value.paint).forEach(rt=>{Ye.value.paint&&E.setPaintProperty("stops",rt,Ye.value.paint[rt])}))}),Ro(He,()=>{!E||k||(He.value.layout&&Object.keys(He.value.layout).forEach(rt=>{He.value.layout&&E.setLayoutProperty("vehicles",rt,He.value.layout[rt])}),He.value.paint&&Object.keys(He.value.paint).forEach(rt=>{He.value.paint&&E.setPaintProperty("vehicles",rt,He.value.paint[rt])}))});const Ht=Tr(()=>{const rt=ge.value;if(rt)return st.value.features.find(Jt=>Jt.properties.id===rt.id)});return Ro(Ht,(rt,Jt)=>{!E||!rt||rt.properties.id===Jt?.properties.id||Zt(rt.geometry?.coordinates)}),(rt,Jt)=>(We(),It("div",{id:"map",ref_key:"mapElement",ref:pt,class:"h-full w-full"},null,512))}}),Ew=Pd(Pw,[["__scopeId","data-v-dbd0dbf8"]]),Mw={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function Iw(v,c){return We(),It("svg",Mw,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M18 8H8c-1.1 0-2 .9-2 2v6a2 2 0 0 0 2 2h10c1.11 0 2-.89 2-2v-6a2 2 0 0 0-2-2m-4 8H8v-2h6zm4-4H8v-2h10zm4-6H4v16H2V2h2v2h18z"},null,-1)])])}const jf=ri({name:"mdi-sign-real-estate",render:Iw}),Nf="kiel-live-favorites-v1",gy="favoriteStops",z_=localStorage.getItem(gy);if(z_!==null){const v=JSON.parse(z_);localStorage.setItem(Nf,JSON.stringify(v.map(c=>({id:`kvg-${c.id}`,name:c.name,type:"bus-stop"})))),localStorage.removeItem(gy)}const R_=wi(JSON.parse(localStorage.getItem(Nf)??"[]")),Oo=Tr({get(){return R_.value},set(v){R_.value=v,localStorage.setItem(Nf,JSON.stringify(v))}}),{track:_y}=cv();function Aw({id:v,name:c,type:g}){Oo.value=[...Oo.value,{id:v,name:c,type:g}],_y("favorite:add",{favorites:Oo.value.length})}function Cw(v){Oo.value=Oo.value.filter(c=>c.id!==v.id),_y("favorite:remove",{favorites:Oo.value.length})}function kw(v){return Oo.value.some(c=>c.id===v.id)}function yy(){return{favorites:Oo,addFavorite:Aw,removeFavorite:Cw,isFavorite:kw}}const Dw={class:"flex min-h-0 grow flex-col"},zw={class:"mb-2 flex items-center space-x-2 border-b border-gray-200 pb-2 dark:border-neutral-600"},Rw={class:"text-lg"},Fw={key:0,class:"m-auto max-w-52 text-center text-xl"},Lw={class:"flex flex-col overflow-y-auto"},Ow={class:""},Bw=Hs({__name:"FavoritesPopup",setup(v){const{t:c}=za(),{favorites:g}=yy();return(x,E)=>{const k=V_,S=jf,l=Eu("router-link");return We(),It("div",Dw,[yt("div",zw,[Li(k),yt("h1",Rw,_r(_t(c)("favorites")),1)]),_t(g).length===0?(We(),It("div",Fw,[yt("p",null,_r(_t(c)("add_favorites")),1)])):Nr("",!0),yt("div",Lw,[(We(!0),It(on,null,ka(_t(g),$=>(We(),Ot(l,{key:$.id,to:{name:"map-marker",params:{markerType:$.type,markerId:$.id}},class:"flex border-gray-200 py-2 not-last:border-b dark:border-neutral-700"},{default:Ii(()=>[$.type==="bus-stop"?(We(),Ot(S,{key:0,class:"mr-2"})):Nr("",!0),yt("div",Ow,_r($.name),1)]),_:2},1032,["to"]))),128))])])}}}),jw={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function Nw(v,c){return We(),It("svg",jw,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M232 128a104 104 0 0 1-208 0c0-41 23.81-78.36 60.66-95.27a8 8 0 0 1 6.68 14.54C60.15 61.59 40 93.27 40 128a88 88 0 0 0 176 0c0-34.73-20.15-66.41-51.34-80.73a8 8 0 0 1 6.68-14.54C208.19 49.64 232 87 232 128"},null,-1)])])}const xy=ri({name:"ph-circle-notch",render:Nw}),Vw={viewBox:"0 0 32 32",width:"1.2em",height:"1.2em"};function $w(v,c){return We(),It("svg",Vw,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M26 16c-.088 0-.173.01-.26.013L24.237 9H28V7h-5a1 1 0 0 0-.978 1.21L22.62 11H12.387l-1-3H14V6H7v2h2.28l1.041 3.123l-2.57 5.14A6 6 0 1 0 11.91 23h2.61a2 2 0 0 0 1.562-.75l7.058-8.824l.644 3.004A5.99 5.99 0 1 0 26 16M6 26a4 4 0 1 1 .836-7.91l-1.73 3.463l.009.004A1 1 0 0 0 5 22a.993.993 0 0 0 1.885.443l.01.004L8.618 19A3.984 3.984 0 0 1 6 26m5.91-5a6 6 0 0 0-2.373-3.836l1.678-3.358L13.613 21Zm3.458-1.06L13.054 13h7.865ZM26 26a3.988 3.988 0 0 1-1.786-7.56l.808 3.77l.02-.004A.986.986 0 0 0 26 23a1 1 0 0 0 1-1a1 1 0 0 0-.041-.206l.02-.004l-.81-3.773A3.993 3.993 0 0 1 26 26"},null,-1)])])}const vy=ri({name:"carbon-bicycle",render:$w}),Uw={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function qw(v,c){return We(),It("svg",Uw,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M152 92a36 36 0 1 0-36-36a36 36 0 0 0 36 36m0-48a12 12 0 1 1-12 12a12 12 0 0 1 12-12m76 93.4a12 12 0 0 1-7 10.91a66 66 0 0 1-21.47 3.78c-14 0-34.25-3.82-59.77-19a177 177 0 0 1-10.27 21C153.12 162.83 188 183.8 188 232a12 12 0 0 1-24 0c0-18.69-6.95-33.06-21.26-43.94c-9.16-7-19.55-11-27.43-13.34c-.81 1-1.64 2-2.5 2.95c-20 22.87-44.82 34.76-72.25 34.76a97 97 0 0 1-9.75-.49a12 12 0 1 1 2.39-23.88c52.3 5.22 77.48-45.92 85.79-67.75c-34.19-17.85-55.25-1.53-55.48-1.31a12 12 0 0 1-15-18.72C50.08 99 88 69.44 142.75 106.62c43.1 29.31 68.1 19.92 68.5 19.76a12 12 0 0 1 16.75 11Z"},null,-1)])])}const Gw=ri({name:"ph-person-simple-run-bold",render:qw}),Zw={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function Hw(v,c){return We(),It("svg",Zw,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M216 64v90.93c0 46.2-36.85 84.55-83 85.06a83.7 83.7 0 0 1-60.4-24.59C50.79 192.33 26.15 136 26.15 136a16 16 0 0 1 6.53-22.23c7.66-4 17.1-.84 21.4 6.62l21 36.44a6.09 6.09 0 0 0 6 3.09h.12a8.19 8.19 0 0 0 6.8-8.18V48a16 16 0 0 1 16.77-16c8.61.4 15.23 7.82 15.23 16.43V112a8 8 0 0 0 8.53 8a8.17 8.17 0 0 0 7.47-8.25V32a16 16 0 0 1 16.77-16c8.61.4 15.23 7.82 15.23 16.43V120a8 8 0 0 0 8.53 8a8.17 8.17 0 0 0 7.47-8.25v-55.3c0-8.61 6.62-16 15.23-16.43A16 16 0 0 1 216 64"},null,-1)])])}const Ww=ri({name:"ph-hand-fill",render:Hw}),Xw={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function Yw(v,c){return We(),It("svg",Xw,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M128 24a104 104 0 1 0 104 104A104.11 104.11 0 0 0 128 24m56 112h-56a8 8 0 0 1-8-8V72a8 8 0 0 1 16 0v48h48a8 8 0 0 1 0 16"},null,-1)])])}const Jw=ri({name:"ph-clock-fill",render:Yw}),Kw={viewBox:"0 0 32 32",width:"1.2em",height:"1.2em"};function Qw(v,c){return We(),It("svg",Kw,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M30 25H2v2h2v2h2v-2h5v2h2v-2h5v2h2v-2h5v2h2v-2h3zM8 16H2v-2h6v-2H2v-2h6a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2"},null,-1),yt("path",{fill:"currentColor",d:"m28.55 14.23l-8.58-7.864A8.98 8.98 0 0 0 13.888 4H2v2h10v4a2 2 0 0 0 2 2h9.157l4.041 3.705A2.472 2.472 0 0 1 25.528 20H2v2h23.527a4.473 4.473 0 0 0 3.023-7.77M14 10V6.005a6.98 6.98 0 0 1 4.618 1.835L20.975 10Z"},null,-1)])])}const by=ri({name:"carbon-train-profile",render:Qw}),e2={viewBox:"0 0 32 32",width:"1.2em",height:"1.2em"};function t2(v,c){return We(),It("svg",e2,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M21 6h-4V4h6V2H9v2h6v2h-4a5.006 5.006 0 0 0-5 5v11a4.99 4.99 0 0 0 3.582 4.77L8.198 30h2.176l1.285-3h8.682l1.286 3h2.175l-1.384-3.23A4.99 4.99 0 0 0 26 22V11a5.006 5.006 0 0 0-5-5M11 8h10a2.995 2.995 0 0 1 2.816 2H8.184A2.995 2.995 0 0 1 11 8m13 13h-3v2h2.816A2.995 2.995 0 0 1 21 25H11a2.995 2.995 0 0 1-2.816-2H11v-2H8v-2h16Zm0-4H8v-5h16Z"},null,-1)])])}const r2=ri({name:"carbon-tram",render:t2}),i2={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function s2(v,c){return We(),It("svg",i2,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M18 11H6V6h12m-1.5 11a1.5 1.5 0 0 1-1.5-1.5a1.5 1.5 0 0 1 1.5-1.5a1.5 1.5 0 0 1 1.5 1.5a1.5 1.5 0 0 1-1.5 1.5m-9 0A1.5 1.5 0 0 1 6 15.5A1.5 1.5 0 0 1 7.5 14A1.5 1.5 0 0 1 9 15.5A1.5 1.5 0 0 1 7.5 17M4 16c0 .88.39 1.67 1 2.22V20a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-1h8v1a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4z"},null,-1)])])}const wy=ri({name:"mdi-bus",render:s2}),n2={viewBox:"0 0 32 32",width:"1.2em",height:"1.2em"};function o2(v,c){return We(),It("svg",n2,[...c[0]||(c[0]=[yt("path",{fill:"none",d:"M16 26a1.5 1.5 0 1 1 1.5-1.5A1.5 1.5 0 0 1 16 26m-1.125-5h2.25v-9h-2.25Z"},null,-1),yt("path",{fill:"currentColor",d:"M16.002 6.171h-.004L4.648 27.997l.003.003h22.698l.002-.003ZM14.875 12h2.25v9h-2.25ZM16 26a1.5 1.5 0 1 1 1.5-1.5A1.5 1.5 0 0 1 16 26"},null,-1),yt("path",{fill:"currentColor",d:"M29 30H3a1 1 0 0 1-.887-1.461l13-25a1 1 0 0 1 1.774 0l13 25A1 1 0 0 1 29 30M4.65 28h22.7l.001-.003L16.002 6.17h-.004L4.648 27.997Z"},null,-1)])])}const a2=ri({name:"carbon-warning-alt-filled",render:o2}),l2={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function c2(v,c){return We(),It("svg",l2,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M240 128a15.74 15.74 0 0 1-7.6 13.51L88.32 229.65a16 16 0 0 1-16.2.3A15.86 15.86 0 0 1 64 216.13V39.87a15.86 15.86 0 0 1 8.12-13.82a16 16 0 0 1 16.2.3l144.08 88.14A15.74 15.74 0 0 1 240 128"},null,-1)])])}const u2=ri({name:"ph-play-fill",render:c2}),h2={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function d2(v,c){return We(),It("svg",h2,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M14 14.5V12h-4v3H8v-4a1 1 0 0 1 1-1h5V7.5l3.5 3.5m4.21.29l-9-9h-.01a.996.996 0 0 0-1.41 0l-9 9c-.39.39-.39 1.03 0 1.42l9 9c.39.38 1.02.39 1.42 0l9-9c.39-.39.39-1.03 0-1.42"},null,-1)])])}const p2=ri({name:"mdi-directions",render:d2}),f2={key:0,class:"mt-2 flex overflow-x-auto"},m2={class:"inline-flex w-min gap-2 pb-4"},g2={key:2},Ty=Hs({__name:"Actions",props:{actions:{required:!0},actionsModifiers:{}},emits:["update:actions"],setup(v){const{t:c}=za(),g=$_(v,"actions"),{checkFeatureFlag:x}=uv();return(E,k)=>{const S=p2,l=u2;return g.value.length>0&&_t(x)("vehicle_stop_actions").value?(We(),It("div",f2,[yt("div",m2,[(We(!0),It(on,null,ka(g.value,$=>(We(),Ot(Nl,{key:$.url,href:$.url,rounded:"",class:"shrink-0 gap-2 px-4 py-2"},{default:Ii(()=>[$.type==="navigate-to"?(We(),It(on,{key:0},[Li(S),yt("span",null,_r(_t(c)("navigate_to")),1)],64)):$.type==="rent"?(We(),It(on,{key:1},[Li(l),yt("span",null,_r(_t(c)("rent_vehicle")),1)],64)):(We(),It("span",g2,_r($.name),1))]),_:2},1032,["href"]))),128))])])):Nr("",!0)}}}),_2={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function y2(v,c){return We(),It("svg",_2,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M243 96a20.33 20.33 0 0 0-17.74-14l-56.59-4.57l-21.84-52.81a20.36 20.36 0 0 0-37.66 0L87.35 77.44L30.76 82a20.45 20.45 0 0 0-11.66 35.88l43.18 37.24l-13.2 55.7A20.37 20.37 0 0 0 79.57 233L128 203.19L176.43 233a20.39 20.39 0 0 0 30.49-22.15l-13.2-55.7l43.18-37.24A20.43 20.43 0 0 0 243 96m-70.47 45.7a12 12 0 0 0-3.84 11.86L181.58 208l-47.29-29.08a12 12 0 0 0-12.58 0L74.42 208l12.89-54.4a12 12 0 0 0-3.84-11.86l-42.27-36.5l55.4-4.47a12 12 0 0 0 10.13-7.38L128 41.89l21.27 51.5a12 12 0 0 0 10.13 7.38l55.4 4.47Z"},null,-1)])])}const x2=ri({name:"ph-star-bold",render:y2}),v2={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function b2(v,c){return We(),It("svg",v2,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M6 6h12v3.96L12 8L6 9.96M3.94 19H4c1.6 0 3-.88 4-2c1 1.12 2.4 2 4 2s3-.88 4-2c1 1.12 2.4 2 4 2h.05l1.9-6.69c.08-.25.05-.53-.06-.77c-.13-.24-.34-.42-.6-.5L20 10.62V6a2 2 0 0 0-2-2h-3V1H9v3H6a2 2 0 0 0-2 2v4.62l-1.29.42c-.26.08-.47.26-.6.5c-.11.24-.14.52-.06.77M20 21c-1.39 0-2.78-.47-4-1.33c-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.37 0 2.74-.35 4-1c2.5 1.3 5.5 1.3 8 0c1.26.65 2.62 1 4 1h2v-2z"},null,-1)])])}const Vf=ri({name:"mdi-ferry",render:b2}),w2={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function T2(v,c){return We(),It("svg",w2,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M208.49 191.51a12 12 0 0 1-17 17L128 145l-63.51 63.49a12 12 0 0 1-17-17L111 128L47.51 64.49a12 12 0 0 1 17-17L128 111l63.51-63.52a12 12 0 0 1 17 17L145 128Z"},null,-1)])])}const S2=ri({name:"ph-x-bold",render:T2}),P2={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function E2(v,c){return We(),It("svg",P2,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"m198.24 62.63l15.68-17.25a8 8 0 0 0-11.84-10.76L186.4 51.86A95.95 95.95 0 0 0 57.76 193.37l-15.68 17.25a8 8 0 1 0 11.84 10.76l15.68-17.24A95.95 95.95 0 0 0 198.24 62.63M48 128a80 80 0 0 1 127.6-64.25l-107 117.73A79.63 79.63 0 0 1 48 128m80 80a79.55 79.55 0 0 1-47.6-15.75l107-117.73A79.95 79.95 0 0 1 128 208"},null,-1)])])}const M2=ri({name:"ph-empty",render:E2}),I2={class:"flex grow flex-col items-center"},A2={class:"my-2 flex flex-col items-center text-lg"},Sd=Hs({__name:"NoData",setup(v){const{t:c}=za();return(g,x)=>{const E=M2,k=S2;return We(),It("div",I2,[Li(E,{class:"mt-auto text-3xl"}),yt("div",A2,[_u(g.$slots,"default")]),Li(Nl,{class:"mt-auto mb-4",to:{name:"home"},replace:""},{default:Ii(()=>[Li(k,{class:"mr-2 font-bold"}),yt("span",null,_r(_t(c)("close")),1)]),_:1})])}}}),C2={key:0,class:"flex min-h-0 grow flex-col"},k2={class:"mb-2 flex flex-row items-center border-b border-gray-200 pb-2 dark:border-neutral-600"},D2={class:"ml-2 text-lg"},z2={class:"flex grow flex-col overflow-y-auto"},R2={key:0,class:"bg-opacity-50 dark:bg-opacity-50 mb-2 rounded-md bg-red-300 p-2 dark:bg-red-800"},F2={class:"mb-2 flex items-center border-b border-gray-500 dark:border-gray-300"},L2={class:"font-bold"},O2={class:"flex flex-row items-center"},B2={class:"mr-2"},j2={class:"grow"},N2={class:"ml-2 flex items-center"},V2={class:"flex flex-row gap-1 text-xs text-gray-500 dark:text-gray-400"},$2={class:"ml-auto"},U2={class:"flex flex-row"},q2={class:"mr-2"},G2=Hs({__name:"StopPopup",props:{marker:{}},setup(v){const c=v,{addFavorite:g,removeFavorite:x,isFavorite:E}=yy(),{t:k}=za(),S=Zl(c,"marker"),{stop:l,unsubscribe:$}=Qn.useStop(Tr(()=>c.marker.id)),oe=we=>{if(we.eta===0)return null;const ye=Math.round(we.eta/60);return we.state==="stopping"?k("stopping"):ye<1?k("immediately"):k("minutes",{minutes:ye})},me=Tr(()=>l.value?.arrivals?l.value.arrivals.toSorted((we,ye)=>we.eta===0||ye.eta===0?we.planned.localeCompare(ye.planned):we.eta-ye.eta).map(we=>({...we,nextStopName:void 0,eta:oe(we)})):null);return N_(async()=>{await $()}),(we,ye)=>{const ze=Vf,Ke=jf,ot=V_,ge=x2,Pt=Ty,xt=a2,At=wy,Qt=r2,Fe=by,st=Jw,Ye=Ww,He=Gw,Ge=Eu("router-link"),pt=vy,vt=xy;return _t(l)?(We(),It("div",C2,[yt("div",k2,[_t(l).type==="ferry-stop"?(We(),Ot(ze,{key:0})):(We(),Ot(Ke,{key:1})),yt("h1",D2,_r(_t(l).name),1),_t(E)(_t(l))?(We(),Ot(Nl,{key:2,class:"ml-auto border-0 text-yellow-300",title:_t(k)("remove_favorite"),onClick:ye[0]||(ye[0]=Qe=>_t(x)(_t(l)))},{default:Ii(()=>[Li(ot)]),_:1},8,["title"])):(We(),Ot(Nl,{key:3,class:"ml-auto border-0",title:_t(k)("add_favorite"),onClick:ye[1]||(ye[1]=Qe=>_t(g)(_t(l)))},{default:Ii(()=>[Li(ge)]),_:1},8,["title"]))]),Li(Pt,{actions:_t(l).actions??[]},null,8,["actions"]),yt("div",z2,[_t(l).alerts&&_t(l).alerts.length>=1?(We(),It("div",R2,[yt("div",F2,[Li(xt,{class:"mr-2"}),yt("span",L2,_r(_t(k)("alerts")),1)]),yt("ul",null,[(We(!0),It(on,null,ka(_t(l).alerts,(Qe,Zt)=>(We(),It("li",{key:Zt,class:"ml-5 list-outside list-disc items-center"},_r(Qe),1))),128))])])):Nr("",!0),(We(!0),It(on,null,ka(me.value,Qe=>(We(),Ot(Ge,{key:Qe.tripId,class:"flex w-full flex-col border-gray-200 py-2 not-last:border-b dark:border-neutral-700",to:{name:"map-marker",params:{markerType:_t(l).type.replace("-stop",""),markerId:Qe.vehicleId}}},{default:Ii(()=>[yt("div",O2,[Qe.type==="bus"?(We(),Ot(At,{key:0,class:"mr-2 h-6 w-6"})):Qe.type==="ferry"?(We(),Ot(ze,{key:1,class:"mr-2"})):Qe.type==="tram"?(We(),Ot(Qt,{key:2,class:"mr-2 h-6 w-6"})):Qe.type==="train"?(We(),Ot(Fe,{key:3,class:"mr-2"})):Nr("",!0),yt("span",B2,_r(Qe.routeName),1),yt("span",j2,_r(Qe.direction),1),yt("span",null,_r(Qe.eta??Qe.planned),1),yt("div",N2,[Qe.state==="planned"?(We(),Ot(st,{key:0})):Nr("",!0),Qe.state==="stopping"?(We(),Ot(Ye,{key:1})):Nr("",!0),Qe.state==="predicted"?(We(),Ot(He,{key:2})):Nr("",!0)])]),yt("div",V2,[Qe.nextStopName?(We(),It(on,{key:0},[yt("span",null,_r(_t(k)("next_stop")),1),yt("span",null,_r(Qe.nextStopName),1)],64)):Nr("",!0),yt("span",$2,_r(Qe.platform),1)])]),_:2},1032,["to"]))),128)),(We(!0),It(on,null,ka(_t(l).vehicles,Qe=>(We(),Ot(Ge,{key:Qe.id,class:"flex w-full flex-col border-gray-200 py-2 not-last:border-b dark:border-neutral-700",to:{name:"map-marker",params:{markerType:Qe.type,markerId:Qe.id}}},{default:Ii(()=>[yt("div",U2,[Qe.type==="bike"?(We(),Ot(pt,{key:0,class:"mr-2"})):Qe.type==="ferry"?(We(),Ot(ze,{key:1,class:"mr-2"})):Nr("",!0),yt("span",q2,_r(Qe.name),1)])]),_:2},1032,["to"]))),128)),me.value&&me.value.length===0?(We(),Ot(Sd,{key:1},{default:Ii(()=>[pd(_r(_t(k)("no_bus_wants_to_stop_here_right_now")),1)]),_:1})):Nr("",!0),!me.value&&!_t(l).vehicles?(We(),Ot(vt,{key:2,class:"m-auto animate-spin text-3xl"})):Nr("",!0)])])):(We(),Ot(Sd,{key:1},{default:Ii(()=>[pd(_r(_t(k)("this_stop_probably_does_not_exist"))+" ",1),_t(E)(S.value)?(We(),Ot(Nl,{key:0,class:"mt-2",onClick:ye[2]||(ye[2]=()=>{_t(x)(S.value),we.$router.replace({name:"home"})})},{default:Ii(()=>[Li(ot,{class:"mr-2 text-yellow-300"}),yt("span",null,_r(_t(k)("remove_favorite")),1)]),_:1})):Nr("",!0)]),_:1}))}}}),Z2={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function H2(v,c){return We(),It("svg",Z2,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M19 5c0-1.1-.9-2-2-2h-3v2h3v2.65L13.5 12H10V7H6c-2.21 0-4 1.79-4 4v3h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4.5L19 8.35zM7 15c-.55 0-1-.45-1-1h2c0 .55-.45 1-1 1M5 4h5v2H5zm14 7c-1.66 0-3 1.34-3 3s1.34 3 3 3s3-1.34 3-3s-1.34-3-3-3m0 4c-.55 0-1-.45-1-1s.45-1 1-1s1 .45 1 1s-.45 1-1 1M7 20h4v-2l6 3h-4v2z"},null,-1)])])}const W2=ri({name:"mdi-moped-electric",render:H2}),X2={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function Y2(v,c){return We(),It("svg",X2,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M19 15c.55 0 1 .45 1 1s-.45 1-1 1s-1-.45-1-1s.45-1 1-1m0-2c-1.66 0-3 1.34-3 3s1.34 3 3 3s3-1.34 3-3s-1.34-3-3-3m-9-7H5v2h5zm7-1h-3v2h3v2.65L13.5 14H10V9H6c-2.21 0-4 1.79-4 4v3h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4.5l4.5-5.65V7a2 2 0 0 0-2-2M7 17c-.55 0-1-.45-1-1h2c0 .55-.45 1-1 1"},null,-1)])])}const J2=ri({name:"mdi-moped",render:Y2}),K2={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function Q2(v,c){return We(),It("svg",K2,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M184 48h-48V24h32a8 8 0 0 0 0-16H88a8 8 0 0 0 0 16h32v24H72a32 32 0 0 0-32 32v104a32 32 0 0 0 32 32h8l-14.4 19.2a8 8 0 1 0 12.8 9.6L100 216h56l21.6 28.8a8 8 0 1 0 12.8-9.6L176 216h8a32 32 0 0 0 32-32V80a32 32 0 0 0-32-32M72 64h112a16 16 0 0 1 16 16v40H56V80a16 16 0 0 1 16-16m112 136H72a16 16 0 0 1-16-16v-48h144v48a16 16 0 0 1-16 16m-88-28a12 12 0 1 1-12-12a12 12 0 0 1 12 12m88 0a12 12 0 1 1-12-12a12 12 0 0 1 12 12"},null,-1)])])}const eT=ri({name:"ph-tram",render:Q2}),tT={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function rT(v,c){return We(),It("svg",tT,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M224 96v112a8 8 0 0 1-16 0V96a56.06 56.06 0 0 0-56-56h-48a56.06 56.06 0 0 0-56 56v112a8 8 0 0 1-16 0V96a72.08 72.08 0 0 1 72-72h48a72.08 72.08 0 0 1 72 72m-40 0v72a24 24 0 0 1-19.29 23.53l2.45 4.89a8 8 0 0 1-14.32 7.16L147.06 192h-38.12l-5.78 11.58a8 8 0 0 1-14.32-7.16l2.45-4.89A24 24 0 0 1 72 168V96a24 24 0 0 1 24-24h64a24 24 0 0 1 24 24m-96 0v48h80V96a8 8 0 0 0-8-8H96a8 8 0 0 0-8 8m32 64v16h16v-16Zm-24 16h8v-16H88v8a8 8 0 0 0 8 8m72-8v-8h-16v16h8a8 8 0 0 0 8-8"},null,-1)])])}const iT=ri({name:"ph-subway",render:rT}),sT={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function nT(v,c){return We(),It("svg",sT,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M212 136c-1.18 0-2.35.06-3.51.17l-32.9-98.7A8 8 0 0 0 168 32h-32a8 8 0 0 0 0 16h26.23l17.44 52.31L124.21 168H79.77a36 36 0 1 0-1.83 16H128a8 8 0 0 0 6.19-2.93l51.46-62.81l7.66 23A36 36 0 1 0 212 136M44 192a20 20 0 1 1 20-20a20 20 0 0 1-20 20m168 0a20 20 0 1 1 20-20a20 20 0 0 1-20 20"},null,-1)])])}const oT=ri({name:"ph-scooter",render:nT}),aT={viewBox:"0 0 256 256",width:"1.2em",height:"1.2em"};function lT(v,c){return We(),It("svg",aT,[...c[0]||(c[0]=[yt("path",{fill:"currentColor",d:"M240 104h-10.8l-27.78-62.5A16 16 0 0 0 186.8 32H69.2a16 16 0 0 0-14.62 9.5L26.8 104H16a8 8 0 0 0 0 16h8v80a16 16 0 0 0 16 16h24a16 16 0 0 0 16-16v-16h96v16a16 16 0 0 0 16 16h24a16 16 0 0 0 16-16v-80h8a8 8 0 0 0 0-16M69.2 48h117.6l24.89 56H44.31ZM64 200H40v-16h24Zm128 0v-16h24v16Zm24-32H40v-48h176ZM56 144a8 8 0 0 1 8-8h16a8 8 0 0 1 0 16H64a8 8 0 0 1-8-8m112 0a8 8 0 0 1 8-8h16a8 8 0 0 1 0 16h-16a8 8 0 0 1-8-8"},null,-1)])])}const cT=ri({name:"ph-car",render:lT}),uT={key:0,class:"flex min-h-0 grow flex-col"},hT={class:"mb-2 border-b border-gray-200 dark:border-neutral-600"},dT={class:"flex items-center space-x-2 pb-2"},pT={class:"text-lg"},fT={key:0,class:"overflow-y-auto"},mT={class:"w-14 min-w-12"},gT={key:1,class:"flex h-4 w-4 items-center justify-center rounded-full bg-neutral-800 dark:bg-gray-300"},_T={class:"w-full"},yT=["innerHTML"],xT=Hs({__name:"VehiclePopup",props:{marker:{}},setup(v){const c=v,{t:g}=za(),x=Zl(c,"marker"),{vehicle:E,unsubscribe:k}=Qn.useVehicle(Tr(()=>x.value.id)),{trip:S,unsubscribe:l}=Qn.useTrip(Tr(()=>E.value?.tripId)),$=Tr(()=>E.value?.description?ov(E.value.description.trim()):null);return F_(async()=>{await k(),await l()}),(oe,me)=>{const we=wy,ye=vy,ze=cT,Ke=oT,ot=Vf,ge=by,Pt=iT,xt=eT,At=J2,Qt=W2,Fe=Eu("router-link"),st=xy;return _t(E)?(We(),It("div",uT,[yt("header",hT,[yt("div",dT,[_t(E).type==="bus"?(We(),Ot(we,{key:0})):_t(E).type==="bike"?(We(),Ot(ye,{key:1})):_t(E).type==="car"?(We(),Ot(ze,{key:2})):_t(E).type==="e-scooter"?(We(),Ot(Ke,{key:3})):_t(E).type==="ferry"?(We(),Ot(ot,{key:4})):_t(E).type==="train"?(We(),Ot(ge,{key:5})):_t(E).type==="subway"?(We(),Ot(Pt,{key:6})):_t(E).type==="tram"?(We(),Ot(xt,{key:7})):_t(E).type==="moped"?(We(),Ot(At,{key:8})):_t(E).type==="e-moped"?(We(),Ot(Qt,{key:9})):Nr("",!0),yt("h1",pT,_r(_t(E).name),1)]),Li(Ty,{actions:_t(E).actions??[]},null,8,["actions"])]),_t(S)?(We(),It(on,{key:0},[_t(S).arrivals?.length?(We(),It("div",fT,[(We(!0),It(on,null,ka(_t(S).arrivals,(Ye,He)=>(We(),Ot(Fe,{key:Ye.id,to:{name:"map-marker",params:{markerType:`${_t(E).type}-stop`,markerId:Ye.id}},class:cd(["flex w-full items-center",{"text-gray-500 dark:text-gray-400":Ye.state==="departed","mt-6":He===0&&Ye.state==="predicted"}])},{default:Ii(()=>[yt("span",mT,_r(Ye.planned),1),yt("div",{class:cd(["marker relative mx-4 flex h-12 w-8 min-w-4 items-center justify-center after:absolute after:top-0 after:h-full",{"after:bg-neutral-800 dark:after:bg-gray-300":Ye.state!=="departed","after:bg-gray-500 dark:after:bg-gray-400":Ye.state==="departed"}])},[Ye.state!=="departed"&&(_t(S).arrivals[He-1]===void 0||_t(S).arrivals[He-1].state==="departed")?(We(),It("div",{key:0,class:cd(["vehicle before:h-4 before:w-4 before:rounded-full before:bg-red-700",{driving:Ye.state==="predicted"}])},[...me[0]||(me[0]=[yt("div",{class:"pulsating rounded-full border-3 border-solid border-red-700"},null,-1)])],2)):Nr("",!0),Ye.state!=="departed"&&_t(S).arrivals[He-1]?.state!=="departed"||Ye.state==="predicted"?(We(),It("div",gT)):Nr("",!0)],2),yt("span",_T,_r(Ye.name),1)]),_:2},1032,["to","class"]))),128))])):(We(),Ot(Sd,{key:1},{default:Ii(()=>[pd(_r(_t(g)("trip_expired")),1)]),_:1}))],64)):_t(E).tripId!==""?(We(),Ot(st,{key:1,class:"mx-auto mt-4 animate-spin text-3xl"})):Nr("",!0),$.value?(We(),It("span",{key:2,class:"prose",innerHTML:$.value},null,8,yT)):Nr("",!0)])):(We(),Ot(Sd,{key:1},{default:Ii(()=>[pd(_r(_t(g)("trip_does_not_exist")),1)]),_:1}))}}}),vT=Pd(xT,[["__scopeId","data-v-f264f996"]]),bT=Hs({__name:"MarkerPopup",props:{marker:{}},setup(v){return(c,g)=>v.marker.type.endsWith("-stop")?(We(),Ot(G2,{key:0,marker:v.marker},null,8,["marker"])):(We(),Ot(vT,{key:1,marker:v.marker},null,8,["marker"]))}}),wT={class:"flex min-h-0 grow flex-col"},TT={class:"mb-2 flex items-center space-x-2 border-b border-gray-200 pb-2 dark:border-neutral-600"},ST={class:"text-lg"},PT={key:0,class:"m-auto max-w-52 text-center text-xl"},ET={key:1,class:"m-auto max-w-52 text-center text-xl"},MT={class:"flex flex-col overflow-y-auto"},IT={class:""},AT=Hs({__name:"SearchPopup",props:{searchInput:{default:""},searchInputModifiers:{}},emits:["update:searchInput"],setup(v){const c=$_(v,"searchInput"),{t:g}=za(),x=wi({east:0,west:0,north:0,south:0}),{results:E}=Qn.useSearch(c,x);return(k,S)=>{const l=av,$=jf,oe=Vf,me=Eu("router-link");return We(),It("div",wT,[yt("div",TT,[Li(l),yt("h1",ST,_r(_t(g)("search_result")),1)]),_t(E).length===0&&c.value.length<3?(We(),It("div",PT,[yt("p",null,_r(_t(g)("search_stop_vehicle")),1)])):_t(E).length===0&&c.value.length>=3?(We(),It("div",ET,[yt("p",null,_r(_t(g)("no_entry")),1)])):Nr("",!0),yt("div",MT,[(We(!0),It(on,null,ka(_t(E),we=>(We(),Ot(me,{key:we.id,to:{name:"map-marker",params:{markerType:we.type,markerId:we.id}},class:"flex max-w-full border-gray-200 py-2 not-last:border-b dark:border-neutral-700",onClick:S[0]||(S[0]=ye=>c.value="")},{default:Ii(()=>[we.type==="bus-stop"?(We(),Ot($,{key:0,class:"mr-2"})):we.type==="ferry-stop"?(We(),Ot(oe,{key:1,class:"mr-2"})):Nr("",!0),yt("div",IT,_r(we.name),1)]),_:2},1032,["to"]))),128))])])}}}),CT={class:"relative h-full w-full items-center justify-center overflow-hidden"},FT=Hs({__name:"Home",setup(v){const{liteMode:c}=Cf(),g=B_(),x=j_(),E=Tr({get(){if(g.name==="map-marker")return{type:g.params.markerType,id:g.params.markerId}},set(oe){if(!oe){x.replace({name:"home"});return}x.replace({name:"map-marker",params:{markerType:oe.type,markerId:oe.id}})}}),k=wi(""),S=wi(!1),l=Tr(()=>E.value!==void 0||g.name==="search"||g.name==="favorites"),$=Tr(()=>g.name==="search"||g.name==="favorites"||S.value?"1/2":"3/4");return(oe,me)=>(We(),It("div",CT,[Li(bw,{"search-input":k.value,"onUpdate:searchInput":me[0]||(me[0]=we=>k.value=we)},null,8,["search-input"]),Li(_v,{"is-open":l.value,size:$.value,onClose:me[2]||(me[2]=we=>oe.$router.replace({name:"home"}))},{default:Ii(()=>[E.value?(We(),Ot(bT,{key:0,marker:E.value},null,8,["marker"])):Nr("",!0),_t(g).name==="search"?(We(),Ot(AT,{key:1,"search-input":k.value,"onUpdate:searchInput":me[1]||(me[1]=we=>k.value=we)},null,8,["search-input"])):Nr("",!0),_t(g).name==="favorites"?(We(),Ot(Bw,{key:2})):Nr("",!0)]),_:1},8,["is-open","size"]),_t(c)?Nr("",!0):(We(),Ot(Ew,{key:0,"map-moved-manually":S.value,"onUpdate:mapMovedManually":me[3]||(me[3]=we=>S.value=we),"selected-marker":E.value,onMarkerClick:me[4]||(me[4]=we=>E.value=we)},null,8,["map-moved-manually","selected-marker"]))]))}});export{FT as default};
//# sourceMappingURL=Home-CLGDSlv0.js.map
